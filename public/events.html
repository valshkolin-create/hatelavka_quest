<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ì–æ–Ω–∫–∞ –∑–∞ —Å–∫–∏–Ω–∞–º–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --background-main: #100e19;
      --surface-primary: #1c1a27;
      --surface-secondary: #2a2738;
      --border-color: #3c3852;
      --text-primary: #f0f0f5;
      --text-secondary: #a09cb8;
      --accent-primary: #00f2ea;
      --accent-secondary: #d433ff;
      --danger-color: #ff4d4d;
      --winner-color: #ffd700;
      --card-default-border: #d433ff;
      --card-default-bg: #2a2738;
      --card-default-dots: rgba(240, 240, 245, 0.1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--background-main);
      color: var(--text-primary);
      margin: 0;
      padding: 15px 15px 100px;
      overflow-x: hidden;
    }
    
    body.browser-view {
      padding-bottom: 15px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .timer {
      text-align: center;
      font-size: 1.4em;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 25px;
      letter-spacing: 1px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    .browser-view .timer {
      font-size: 2.5em;
      margin-bottom: 25px;
      color: #ff9000;
    }

    .loader-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .events-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .event-card {
      background-color: var(--surface-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .event-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .card-display-area {
      position: relative;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
      padding: 10px;
      padding-bottom: 0;
    }

    .card-display-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--card-border-color, var(--card-default-border));
      z-index: 4;
    }

    .card-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    .card-display-area::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.8) 100%);
      z-index: 2;
      pointer-events: none;
    }

    .event-image-container {
      width: 100%;
      padding-top: 90%;
      position: relative;
      z-index: 3;
    }

    .event-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.3s ease;
    }

    .card-info-area {
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .card-text-content {
      flex-grow: 1;
    }

    .event-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px;
    }

    .event-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 0 0 10px;
    }

    .event-cost {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      height: 16px;
    }

    .user-tickets {
      font-size: 11px;
      color: var(--accent-primary);
      font-weight: 600;
      margin-bottom: 10px;
      min-height: 15px;
    }

    .event-button-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: auto;
    }

    .event-button,
    .participants-button {
      width: 100%;
      padding: 10px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .event-button {
      background-color: var(--accent-primary);
      color: #000;
    }

    .event-button:hover:not(:disabled) {
      background-color: #00d9d1;
    }

    .event-button:disabled {
      background: var(--surface-secondary);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    .participants-button {
      background-color: var(--surface-secondary);
      color: var(--text-primary);
    }

    .participants-button:hover {
      background-color: var(--border-color);
    }

    .event-card.is-winner .card-display-area::before {
      background: var(--winner-color);
    }

    .winner-display {
      padding: 10px 0;
      color: var(--winner-color);
    }

    .winner-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .winner-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
    }

    .winner-name {
      font-size: 16px;
      font-weight: 700;
      margin-top: 4px;
      word-break: break-all;
    }

    .admin-controls {
      position: fixed;
      bottom: calc(60px + env(safe-area-inset-bottom) + 15px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }
    
    .browser-view .admin-controls {
      bottom: 15px;
    }

    .admin-controls button {
      background: linear-gradient(90deg, var(--accent-secondary), #ff70ab);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .admin-controls button:hover {
      transform: scale(1.05);
    }

    #save-btn {
      display: none;
    }

    .edit-mode-active #edit-btn {
      display: none;
    }

    .edit-mode-active #save-btn {
      display: inline-block;
    }

    .app-footer {
      display: flex;
      justify-content: space-around;
      background-color: rgba(28, 26, 39, 0.8);
      backdrop-filter: blur(15px);
      border-top: 1px solid var(--border-color);
      width: 100%;
      padding-top: 8px;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 100;
    }

    .footer-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      font-size: 11px;
      text-decoration: none;
      flex: 1;
    }

    .footer-item .icon-wrapper {
      font-size: 24px;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .footer-item.active span,
    .footer-item.active .icon-wrapper {
      color: var(--accent-primary);
      font-weight: 600;
    }

    .hidden {
      display: none !important;
    }

    .info-blocks-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .info-block {
      background-color: var(--surface-primary);
      border: 1px solid var(--border-color);
      padding: 20px;
      border-radius: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
    }

    .info-icon {
      font-size: 24px;
      color: var(--accent-primary);
      flex-shrink: 0;
    }

    .info-text-content {
      flex-grow: 1;
    }

    .info-action-content {
      width: 100%;
      text-align: center;
      margin-top: 10px;
    }

    .info-title {
      color: var(--text-primary);
      margin: 0 0 5px;
      font-size: 15px;
      font-weight: 600;
    }

    .info-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin: 0;
    }

    .free-ticket-button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: var(--accent-primary);
      color: #000;
      transition: all 0.2s ease;
    }

    .free-ticket-button:hover {
      background-color: #00d9d1;
    }

    .free-ticket-button:disabled {
      background: var(--surface-secondary);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    .free-ticket-button .timer-text {
      font-size: 12px;
      display: block;
      font-weight: 500;
      margin-top: 4px;
    }

    .edit-mode [data-editable] {
      cursor: pointer;
      border: 1px dashed var(--accent-secondary);
      border-radius: 4px;
      padding: 2px 4px;
    }

    .edit-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      border-radius: 12px;
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      z-index: 5;
    }

    .card-btn {
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-btn:hover {
      transform: scale(1.1);
    }

    .card-edit-btn {
      background-color: #007aff;
    }

    .card-delete-btn {
      background-color: var(--danger-color);
    }

    .card-reset-btn {
      background-color: #ff9500;
    }

    .create-event-card {
      border: 2px dashed var(--border-color);
      justify-content: center;
      cursor: pointer;
      background: transparent;
      color: var(--text-secondary);
    }

    .create-event-card:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background-color: var(--surface-primary);
      border: 1px solid var(--border-color);
      padding: 0;
      border-radius: 14px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      max-height: 85vh;
      position: relative;
    }

    .modal-header {
      padding: 15px 20px;
      margin-top: 0;
      user-select: none;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      flex-grow: 1;
    }

    .modal-close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close-btn:hover {
      color: var(--text-primary);
    }

    .modal-body {
      overflow-y: auto;
      padding: 20px;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .modal-form input,
    .modal-form textarea,
    .modal-form .range-container {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: var(--surface-secondary);
      color: var(--text-primary);
      font-size: 16px;
    }

    .modal-form input[type="color"] {
      padding: 2px;
      height: 44px;
      border: none;
    }

    .modal-form button {
      background: var(--accent-primary);
      border: none;
      padding: 12px;
      border-radius: 10px;
      color: #000;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-form label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: -10px;
    }

    .range-container {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
    }

    .range-container input[type="range"] {
      flex-grow: 1;
      -webkit-appearance: none;
      background: var(--border-color);
      height: 4px;
      border-radius: 2px;
    }

    .range-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      cursor: pointer;
      border-radius: 50%;
    }

    #participants-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }

    .participant-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .participant-item:last-child {
      border-bottom: none;
    }

    .participant-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      flex-grow: 1;
      padding-left: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .participant-tickets {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-primary);
      padding-left: 10px;
    }

    .participant-rank {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      min-width: 25px;
      text-align: right;
    }

    .event-card.is-locked {
      opacity: 0.6;
    }

    .lock-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(28, 26, 39, 0.7);
      backdrop-filter: blur(2px);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 5;
      color: var(--text-primary);
      padding: 10px;
      pointer-events: none;
    }

    .lock-overlay-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .lock-overlay-text {
      font-size: 13px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="countdown-timer" class="timer" data-key="raffleEndTime" data-editable></div>
    <div id="events-list" class="events-container"></div>
    <div class="info-blocks-container">
      <div id="free-ticket-container" class="info-block">
        <i class="fa-solid fa-ticket info-icon"></i>
        <div class="info-text-content">
          <h3 class="info-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</h3>
          <p class="info-description">–ü–æ–ª—É—á–∏—Ç–µ –æ–¥–∏–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–∏–ª–µ—Ç –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö —Ä–∞–∑ –≤ 24 —á–∞—Å–∞.</p>
        </div>
        <div id="free-ticket-button-wrapper" class="info-action-content"></div>
      </div>
      <div class="info-block">
        <i data-key="infoBlock1Icon" class="fa-solid fa-star info-icon" data-editable></i>
        <div class="info-text-content">
          <h3 class="info-title" data-key="infoBlock1Title" data-editable>–ö–∞–∫ –ø–æ–±–µ–¥–∏—Ç—å?</h3>
          <p class="info-description" data-key="infoBlock1Desc" data-editable>–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∏–≤–µ–Ω—Ç–∞—Ö.</p>
        </div>
      </div>
      <div class="info-block">
        <i data-key="infoBlock2Icon" class="fa-solid fa-ticket info-icon" data-editable></i>
        <div class="info-text-content">
          <h3 class="info-title" data-key="infoBlock2Title" data-editable>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h3>
          <p class="info-description" data-key="infoBlock2Desc" data-editable>–ö–∞–∂–¥—ã–π –±–∏–ª–µ—Ç, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–π –Ω–∞ –∏–≤–µ–Ω—Ç, –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞—à–µ –∏–º—è –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
        </div>
      </div>
      <div class="info-block">
        <i data-key="infoBlock3Icon" class="fa-solid fa-truck-fast info-icon" data-editable></i>
        <div class="info-text-content">
          <h3 class="info-title" data-key="infoBlock3Title" data-editable>–ö–∞–∫ –∑–∞–±—Ä–∞—Ç—å?</h3>
          <p class="info-description" data-key="infoBlock3Desc" data-editable>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ —É–∫–∞–∑–∞–Ω–∞ Steam Trade —Å—Å—ã–ª–∫–∞.</p>
        </div>
      </div>
    </div>
  </div>
  
  <div id="admin-controls" class="admin-controls" style="display: none;">
    <button id="edit-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
  
  <div id="event-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="event-modal-title" style="margin: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–≤–µ–Ω—Ç</h3>
        <button type="button" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="event-modal-form" class="modal-form">
          <input type="hidden" id="event-index-input">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="event-title-input" required>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ (–∫–∞—á–µ—Å—Ç–≤–æ)</label><textarea id="event-description-input" rows="2"></textarea>
          <label>URL –∫–∞—Ä—Ç–∏–Ω–∫–∏</label><input type="text" id="event-image-input" required>
          <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –±–∏–ª–µ—Ç–∞—Ö</label><input type="number" id="event-cost-input" required min="1">
          <label>–¶–≤–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π –ª–∏–Ω–∏–∏</label><input type="color" id="event-border-color-input" value="#d433ff">
          <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label><input type="color" id="event-bg-color-input" value="#2a2738">
          <label>–¶–≤–µ—Ç —Ç–æ—á–µ–∫</label><input type="color" id="event-dot-color-input" value="#f0f0f5">
          <label>–ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
          <div class="range-container">
            <span>-</span><input type="range" id="event-image-scale-input" min="0.5" max="2" step="0.05" value="1"><span>+</span>
          </div>
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>

  <div id="text-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="text-modal-title" style="margin: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</h3>
        <button type="button" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="text-modal-form" class="modal-form">
          <input type="hidden" id="text-key-input">
          <textarea id="text-value-input" rows="4"></textarea>
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>

  <div id="timer-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin: 0;">–ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Ä–µ–º—è –∏—Ç–æ–≥–æ–≤</h3>
        <button type="button" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="timer-modal-form" class="modal-form">
          <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</label>
          <input type="datetime-local" id="timer-input" required>
          <button type="submit">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>

  <div id="ticket-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="ticket-modal-title" style="margin: 0;">–£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ</h3>
        <button type="button" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size: 14px; color: var(--text-secondary);">–í–∞—à –±–∞–ª–∞–Ω—Å: <strong id="user-balance-display" style="color: var(--text-primary);">0</strong> üéüÔ∏è</p>
        <form id="ticket-modal-form" class="modal-form">
          <input type="hidden" id="ticket-event-id-input">
          <label>–°–∫–æ–ª—å–∫–æ –±–∏–ª–µ—Ç–æ–≤ –ø–æ—Å—Ç–∞–≤–∏—Ç—å?</label>
          <input type="number" id="ticket-amount-input" required min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5">
          <button type="submit">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>

  <div id="participants-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="participants-modal-title" style="margin: 0;">–¢–æ–ø-—É—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
        <button type="button" class="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <ul id="participants-list"></ul>
      </div>
    </div>
  </div>
  
  <footer class="app-footer">
    <a href="/menu" class="footer-item">
      <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/events" class="footer-item active">
      <div class="icon-wrapper"><i class="fa-solid fa-gift"></i></div>
      <span>–†–æ–∑—ã–≥—Ä—ã—à–∏</span>
    </a>
    <a href="/profile" class="footer-item">
      <div class="icon-wrapper"><i class="fa-solid fa-user"></i></div>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tg = window.Telegram.WebApp;
    let pageContent = {};
    let countdownInterval = null;
    let freeTicketInterval = null;
    let userData = {};
    let activeSubmitHandler = null; // --- –ù–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê

    const dom = {
        adminControls: document.getElementById('admin-controls'),
        editBtn: document.getElementById('edit-btn'),
        saveBtn: document.getElementById('save-btn'),
        eventsContainer: document.getElementById('events-list'),
        eventModal: document.getElementById('event-modal'),
        eventModalTitle: document.getElementById('event-modal-title'),
        eventModalForm: document.getElementById('event-modal-form'),
        eventIndexInput: document.getElementById('event-index-input'),
        eventTitleInput: document.getElementById('event-title-input'),
        eventDescriptionInput: document.getElementById('event-description-input'),
        eventImageInput: document.getElementById('event-image-input'),
        eventCostInput: document.getElementById('event-cost-input'),
        eventBorderColorInput: document.getElementById('event-border-color-input'),
        eventBgColorInput: document.getElementById('event-bg-color-input'),
        eventDotColorInput: document.getElementById('event-dot-color-input'),
        eventImageScaleInput: document.getElementById('event-image-scale-input'),
        textModal: document.getElementById('text-modal'),
        textModalTitle: document.getElementById('text-modal-title'),
        textModalForm: document.getElementById('text-modal-form'),
        textKeyInput: document.getElementById('text-key-input'),
        textValueInput: document.getElementById('text-value-input'),
        timerModal: document.getElementById('timer-modal'),
        timerModalForm: document.getElementById('timer-modal-form'),
        timerInput: document.getElementById('timer-input'),
        ticketModal: document.getElementById('ticket-modal'),
        ticketModalTitle: document.getElementById('ticket-modal-title'),
        ticketModalForm: document.getElementById('ticket-modal-form'),
        userBalanceDisplay: document.getElementById('user-balance-display'),
        ticketEventIdInput: document.getElementById('ticket-event-id-input'),
        ticketAmountInput: document.getElementById('ticket-amount-input'),
        participantsModal: document.getElementById('participants-modal'),
        participantsModalTitle: document.getElementById('participants-modal-title'),
        participantsList: document.getElementById('participants-list'),
        freeTicketButtonWrapper: document.getElementById('free-ticket-button-wrapper'),
        appFooter: document.querySelector('.app-footer'),
        freeTicketContainer: document.getElementById('free-ticket-container')
    };

    const editableKeys = ['raffleEndTime', 'infoBlock1Title', 'infoBlock1Desc', 'infoBlock2Title', 'infoBlock2Desc', 'infoBlock3Title', 'infoBlock3Desc', 'infoBlock1Icon', 'infoBlock2Icon', 'infoBlock3Icon'];

    async function handleApiError(error) {
        let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
        if (error instanceof Response) {
            try {
                const errorData = await error.json();
                errorMessage = `–û—à–∏–±–∫–∞ ${error.status}: ${JSON.stringify(errorData.detail)}`;
            } catch (e) {
                errorMessage = `–û—à–∏–±–∫–∞ ${error.status}: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.`;
            }
        } else if (error instanceof Error) {
            errorMessage = error.message;
        }
        
        try { tg.showAlert(errorMessage); } catch(e) { alert(errorMessage); }
        console.error("–ü–û–õ–ù–´–ô –û–¢–í–ï–¢ –û–ë –û–®–ò–ë–ö–ï:", error);
    }

    function hexToRgba(hex, alpha) {
        if (!hex || hex.length < 4) hex = '#ffffff';
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function startCountdown(endTimeString) {
        if (countdownInterval) clearInterval(countdownInterval);
        const timerElement = document.getElementById('countdown-timer');
        if (!endTimeString || !timerElement) {
            if (timerElement) timerElement.textContent = '–í—Ä–µ–º—è –Ω–µ –∑–∞–¥–∞–Ω–æ';
            return;
        }
        const endTime = new Date(endTimeString).getTime();
        const update = () => {
            const distance = endTime - new Date().getTime();
            if (distance < 0) {
                clearInterval(countdownInterval);
                const isRaffleFinished = pageContent.events && pageContent.events.some(event => event.winner_name);
                if (isRaffleFinished) {
                    timerElement.textContent = '–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω';
                } else {
                    timerElement.innerHTML = '<div class="loader-spinner"></div><span>–ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤...</span>';
                }
                return;
            }
            const d = Math.floor(distance / 86400000);
            const h = Math.floor((distance % 86400000) / 3600000);
            const m = Math.floor((distance % 3600000) / 60000);
            const s = Math.floor((distance % 60000) / 1000);
            
            let timeString = '';
            if (d > 0) timeString += `${d}–¥ `;
            timeString += `${String(h).padStart(2, '0')}—á ${String(m).padStart(2, '0')}–º ${String(s).padStart(2, '0')}—Å`;
            timerElement.textContent = timeString.trim();
        };
        update();
        countdownInterval = setInterval(update, 1000);
    }

    function renderFreeTicketSection() {
        const container = dom.freeTicketButtonWrapper;
        if (!userData || !userData.id) {
            container.parentElement.style.display = 'none';
            return;
        } else {
            container.parentElement.style.display = 'flex';
        }
        if (freeTicketInterval) clearInterval(freeTicketInterval);
        const lastClaimTime = userData.last_free_ticket_claimed_at ? new Date(userData.last_free_ticket_claimed_at) : null;
        const now = new Date();
        let nextClaimTime = null;
        if (lastClaimTime) {
            nextClaimTime = new Date(lastClaimTime.getTime() + 24 * 60 * 60 * 1000);
        }
        const canClaim = !nextClaimTime || now >= nextClaimTime;
        if (canClaim) {
            container.innerHTML = `<button id="claim-free-ticket-btn" class="free-ticket-button">–ü–æ–ª—É—á–∏—Ç—å –±–∏–ª–µ—Ç</button>`;
        } else {
            container.innerHTML = `<button id="claim-free-ticket-btn" class="free-ticket-button" disabled>–ë–∏–ª–µ—Ç –ø–æ–ª—É—á–µ–Ω <span class="timer-text" id="free-ticket-timer"></span></button>`;
            const timerEl = document.getElementById('free-ticket-timer');
            const updateTimer = () => {
                const distance = nextClaimTime - new Date().getTime();
                if (distance < 0) {
                    clearInterval(freeTicketInterval);
                    renderFreeTicketSection();
                    return;
                }
                const h = Math.floor(distance / 3600000);
                const m = Math.floor((distance % 3600000) / 60000);
                const s = Math.floor((distance % 60000) / 1000);
                timerEl.textContent = `(—Å–ª–µ–¥—É—é—â–∏–π —á–µ—Ä–µ–∑ ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')})`;
            };
            updateTimer();
            freeTicketInterval = setInterval(updateTimer, 1000);
        }
    }

    function renderPage() {
        const isBrowserView = document.body.classList.contains('browser-view');

        editableKeys.forEach(key => {
            const element = document.querySelector(`[data-key="${key}"]`);
            if (!element) return;
            if (key.includes('Icon')) {
                element.className = `info-icon ${pageContent[key] || 'fa-solid fa-question-circle'}`;
            } else {
                element.innerHTML = pageContent[key] || '...';
            }
        });

        startCountdown(pageContent.raffleEndTime);
        renderFreeTicketSection();
        dom.eventsContainer.innerHTML = '';
        const isEditMode = document.body.classList.contains('edit-mode');
        
        if (pageContent.events && pageContent.events.length === 1) {
            dom.eventsContainer.style.gridTemplateColumns = 'minmax(0, 392.5px)';
            dom.eventsContainer.style.justifyContent = 'center';
        } else {
            dom.eventsContainer.style.gridTemplateColumns = '';
            dom.eventsContainer.style.justifyContent = '';
        }

        let userActiveParticipationId = null;
        if (userData && userData.event_participations) {
            const userEventIds = Object.keys(userData.event_participations);
            for (const eventId of userEventIds) {
                const event = (pageContent.events || []).find(e => e.id == eventId);
                if (event && !event.winner_name) {
                    userActiveParticipationId = event.id;
                    break;
                }
            }
        }

        (pageContent.events || []).forEach((event, index) => {
            const card = document.createElement('div');
            card.className = 'event-card';
            const isLocked = userActiveParticipationId && userActiveParticipationId !== event.id;
            if (isLocked) {
                card.classList.add('is-locked');
            }
            const borderColor = event.top_border_color || 'var(--card-default-border)';
            const bgColor = event.bg_color || 'var(--card-default-bg)';
            const dotColorHex = event.dot_color || '#f0f0f5';
            const dotColorRgba = hexToRgba(dotColorHex, 0.1);
            const dotPattern = `radial-gradient(circle at 1px 1px, ${dotColorRgba} 1px, transparent 0)`;
            const imageScale = event.image_scale || 1;
            let cardInnerHtml = `
                <div class="card-display-area" style="--card-border-color: ${borderColor};">
                    <div class="card-background" style="background-color: ${bgColor}; background-image: ${dotPattern}; background-size: 8px 8px;"></div>
                    <div class="event-image-container">
                        <img src="${event.image_url}" alt="${event.title}" class="event-image" style="transform: scale(${imageScale});">
                    </div>
                </div>
            `;
            if (event.winner_name) {
                card.classList.add('is-winner');
                cardInnerHtml += `
                    <div class="card-info-area">
                        <div class="card-text-content">
                            <div class="winner-display">
                                <div class="winner-icon"><i class="fa-solid fa-trophy"></i></div>
                                <div class="winner-label">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
                                <div class="winner-name">${event.winner_name}</div>
                            </div>
                        </div>
                    </div>
                    ${isEditMode ? `<div class="edit-overlay"><button class="card-btn card-edit-btn" data-index="${index}"><i class="fa-solid fa-pencil"></i></button><button class="card-btn card-reset-btn" data-index="${index}" title="–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"><i class="fa-solid fa-arrow-rotate-left"></i></button><button class="card-btn card-delete-btn" data-index="${index}"><i class="fa-solid fa-trash"></i></button></div>` : ''}
                `;
            } else {
                const userTickets = (userData.event_participations || {})[event.id] || 0;
                const userTicketsHtml = userTickets > 0 ? `<div class="user-tickets">–í–∞—à–∏ –±–∏–ª–µ—Ç—ã: ${userTickets} üéüÔ∏è</div>` : '<div class="user-tickets" style="visibility: hidden;"></div>';
                const participateButtonDisabled = isLocked ? 'disabled' : '';
                const participateButton = isBrowserView ? '' : `<button class="event-button" data-event-id="${event.id}" data-event-title="${event.title}" ${participateButtonDisabled}>–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</button>`;
                
                cardInnerHtml += `
                    <div class="card-info-area">
                        <div class="card-text-content">
                            <h3 class="event-title">${event.title || ''}</h3>
                            <p class="event-description">${event.description || ''}</p>
                            <div class="event-cost">–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${event.tickets_cost} üéüÔ∏è</div>
                            ${userTicketsHtml}
                        </div>
                        <div class="event-button-container">
                            ${participateButton}
                            <button class="participants-button" data-event-id="${event.id}" data-event-title="${event.title}">–¢–æ–ø-5</button>
                        </div>
                    </div>
                    ${isEditMode ? `<div class="edit-overlay"><button class="card-btn card-edit-btn" data-index="${index}"><i class="fa-solid fa-pencil"></i></button><button class="card-btn card-delete-btn" data-index="${index}"><i class="fa-solid fa-trash"></i></button></div>` : ''}
                `;
            }
            if (isLocked) {
                cardInnerHtml += `
                    <div class="lock-overlay">
                        <div class="lock-overlay-icon"><i class="fa-solid fa-lock"></i></div>
                        <div class="lock-overlay-text">–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –¥—Ä—É–≥–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ</div>
                    </div>
                `;
            }
            card.innerHTML = cardInnerHtml;
            dom.eventsContainer.appendChild(card);
        });
        if (isEditMode) {
            dom.eventsContainer.insertAdjacentHTML('beforeend', `<div class="event-card create-event-card" style="min-height: 200px; align-items: center; justify-content: center;"><i class="fa-solid fa-plus" style="font-size: 24px;"></i></div>`);
        }
    }

    function showModal(modalElement) {
        modalElement.classList.remove('hidden');
        if (dom.adminControls) dom.adminControls.style.display = 'none';
    }

    function hideModal(modalElement) {
        modalElement.classList.add('hidden');
        if (userData.is_admin) dom.adminControls.style.display = 'block';
    }

    function showEventModal(eventData, index) {
        dom.eventModalTitle.textContent = index === null ? '–ù–æ–≤—ã–π –∏–≤–µ–Ω—Ç' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–≤–µ–Ω—Ç';
        dom.eventIndexInput.value = index;
        dom.eventTitleInput.value = eventData ? eventData.title : '';
        dom.eventDescriptionInput.value = eventData ? eventData.description : '';
        dom.eventImageInput.value = eventData ? eventData.image_url : '';
        dom.eventCostInput.value = eventData ? eventData.tickets_cost : '';
        dom.eventBorderColorInput.value = eventData && eventData.top_border_color ? eventData.top_border_color : '#d433ff';
        dom.eventBgColorInput.value = eventData && eventData.bg_color ? eventData.bg_color : '#2a2738';
        dom.eventDotColorInput.value = eventData && eventData.dot_color ? eventData.dot_color : '#f0f0f5';
        dom.eventImageScaleInput.value = eventData && eventData.image_scale ? eventData.image_scale : 1;
        showModal(dom.eventModal);
    }

    function showTextModal(key, isIcon = false) {
        dom.textModalTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ${isIcon ? '–ò–∫–æ–Ω–∫–∞' : key}`;
        dom.textKeyInput.value = key;
        dom.textValueInput.value = pageContent[key] || '';
        if (isIcon) dom.textValueInput.placeholder = "–ù–∞–ø—Ä–∏–º–µ—Ä: fa-solid fa-trophy";
        showModal(dom.textModal);
    }

    function showTimerModal() {
        const now = new Date();
        const moscowTime = new Date(now.getTime() + (3 * 60 * 60 * 1000));
        const currentVal = pageContent.raffleEndTime ? new Date(pageContent.raffleEndTime) : moscowTime;
        
        if (currentVal < now) {
             const tomorrowInMoscow = new Date(moscowTime.getTime() + (24*60*60*1000));
             currentVal.setDate(tomorrowInMoscow.getDate());
        }

        const yyyy = currentVal.getFullYear();
        const mm = String(currentVal.getMonth() + 1).padStart(2, '0');
        const dd = String(currentVal.getDate()).padStart(2, '0');
        const hh = String(currentVal.getHours()).padStart(2, '0');
        const min = String(currentVal.getMinutes()).padStart(2, '0');
        dom.timerInput.value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
        showModal(dom.timerModal);
    }

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–ß–ê–°–¢–ò–ï –í –†–û–ó–´–ì–†–´–®–ï ---
    function showTicketModal(eventId, eventTitle) {
        const parsedEventId = parseInt(eventId);
        if (isNaN(parsedEventId)) {
                handleApiError(new Error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ID –∏–≤–µ–Ω—Ç–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."));
                return;
    }

        const submitHandler = async (e) => {
            e.preventDefault();
            dom.ticketModalForm.removeEventListener('submit', submitHandler);

            const ticketsToSpend = parseInt(dom.ticketAmountInput.value);
            if (!ticketsToSpend || ticketsToSpend <= 0) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤.');
                return;
            }
            if (ticketsToSpend > userData.tickets) {
                tg.showAlert('–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∏–ª–µ—Ç–æ–≤.');
                return;
            }
            hideModal(dom.ticketModal);
            if (typeof tg?.MainButton?.showProgress === 'function') try { tg.MainButton.showProgress(); } catch {}
            
            try {
                const payload = {
                    initData: tg.initData,
                    event_id: parseInt(eventId),
                    tickets_to_spend: ticketsToSpend
                };
                const response = await fetch('/api/v1/events/enter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw response;

                const result = await response.json();
                tg.showAlert('–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
                userData.tickets = result.new_ticket_balance;
                userData.event_participations = userData.event_participations || {};
                userData.event_participations[eventId] = (userData.event_participations[eventId] || 0) + ticketsToSpend;
                renderPage();
            } catch (error) {
                handleApiError(error);
            } finally {
                if (typeof tg?.MainButton?.hideProgress === 'function') try { tg.MainButton.hideProgress(); } catch {}
            }
        };

        if (activeSubmitHandler) {
            dom.ticketModalForm.removeEventListener('submit', activeSubmitHandler);
        }
        activeSubmitHandler = submitHandler;
        dom.ticketModalForm.addEventListener('submit', activeSubmitHandler);

        // --- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
        const eventData = pageContent.events.find(e => e.id == eventId);
        dom.userBalanceDisplay.textContent = userData.tickets || 0;
        dom.ticketModalTitle.textContent = `–†–æ–∑—ã–≥—Ä—ã—à: ${eventTitle}`;
        dom.ticketAmountInput.value = '';
        dom.ticketAmountInput.min = eventData ? eventData.tickets_cost : 1;
        dom.ticketAmountInput.max = userData.tickets || 0;
        showModal(dom.ticketModal);
        dom.ticketAmountInput.focus();
    }
    
    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–†–û–°–ú–û–¢–† –£–ß–ê–°–¢–ù–ò–ö–û–í ---
    async function showParticipantsModal(eventId, eventTitle) {
        const parsedEventId = parseInt(eventId);
        if (isNaN(parsedEventId)) {
                handleApiError(new Error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ID –∏–≤–µ–Ω—Ç–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."));
                return;
    }
        const initData = tg.initData || '';
        if (document.body.classList.contains('browser-view') && !initData) {
            alert('–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ Telegram.');
            return;
        }
        dom.participantsModalTitle.textContent = `–¢–æ–ø-5 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${eventTitle}`;
        dom.participantsList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
        showModal(dom.participantsModal);
        
        try {
            const payload = { initData: tg.initData, event_id: parseInt(eventId) };
            const response = await fetch('/api/v1/events/participants', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw response;

            const result = await response.json();
            dom.participantsList.innerHTML = '';
            if (result.participants.length === 0) {
                dom.participantsList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</li>';
            } else {
                result.participants.forEach((p, index) => {
                    const li = document.createElement('li');
                    li.className = 'participant-item';
                    const fullName = p.full_name || (p.username ? `@${p.username}` : '–ë–µ–∑ –∏–º–µ–Ω–∏');
                    li.innerHTML = `<div class="participant-rank">${index + 1}.</div><div class="participant-name">${fullName}</div><div class="participant-tickets">${p.tickets_spent} üéüÔ∏è</div>`;
                    dom.participantsList.appendChild(li);
                });
            }
        } catch (error) {
            handleApiError(error);
            dom.participantsList.innerHTML = `<li style="text-align: center; color: var(--danger-color);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</li>`;
        }
    }

    async function initialize() {
        try {
            tg.ready();
            tg.expand();
        } catch (e) {
            console.warn("Telegram WebApp script not loaded or running in browser.");
        }
        
        const isTelegram = tg.initData && tg.initData.length > 0;

        if (isTelegram) {
            try {
                const [contentRes, userRes] = await Promise.all([
                    fetch('/api/v1/events/content', { cache: 'no-store' }),
                    fetch('/api/v1/user/me', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData })
                    })
                ]);
                if (!contentRes.ok) throw contentRes;
                if (!userRes.ok) throw userRes;
                
                pageContent = await contentRes.json();
                userData = await userRes.json();
                renderPage();
                if (userData.is_admin) {
                    dom.adminControls.style.display = 'block';
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ Telegram:", error);
                handleApiError(new Error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."));
            }
        } else {
            document.body.classList.add('browser-view');
            dom.appFooter.style.display = 'none';
            dom.freeTicketContainer.style.display = 'none';
            try {
                const contentRes = await fetch('/api/v1/events/content', { cache: 'no-store' });
                if (!contentRes.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞");
                pageContent = await contentRes.json();
                renderPage();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:", error);
                document.body.innerHTML = `<div style="text-align:center; padding:20px;"><h1>–û—à–∏–±–∫–∞</h1><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö.</p></div>`;
            }
        }
    }

    dom.editBtn.onclick = () => {
        document.body.classList.add('edit-mode');
        dom.adminControls.classList.add('edit-mode-active');
        renderPage();
    };
    
    dom.saveBtn.onclick = async () => {
        document.body.classList.remove('edit-mode');
        dom.adminControls.classList.remove('edit-mode-active');
        try {
            const response = await fetch('/api/v1/admin/events/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData, content: pageContent })
            });
            if (!response.ok) throw response;
            tg.showAlert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
        } catch (e) {
            handleApiError(e);
        }
        renderPage();
    };

    document.body.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        const editableText = e.target.closest('[data-editable]');
        const createCard = e.target.closest('.create-event-card');
        
        if (button?.id === 'claim-free-ticket-btn') {
            button.disabled = true;
            try {
                if(!tg.initData) throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram");
                const response = await fetch('/api/v1/user/claim-free-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                if (!response.ok) throw response;
                const result = await response.json();
                tg.showAlert(result.message);
                userData.tickets = result.new_ticket_balance;
                userData.last_free_ticket_claimed_at = new Date().toISOString();
                renderFreeTicketSection();
            } catch (e) {
                handleApiError(e);
                button.disabled = false;
            }
            return;
        }

        if (document.body.classList.contains('edit-mode')) {
            if (button?.matches('.card-edit-btn')) {
                showEventModal(pageContent.events[button.dataset.index], button.dataset.index);
            } else if (button?.matches('.card-delete-btn')) {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∏–≤–µ–Ω—Ç?', (ok) => {
                    if (ok) {
                        pageContent.events.splice(button.dataset.index, 1);
                        renderPage();
                    }
                });
            } else if (button?.matches('.card-reset-btn')) {
                // ...
            } else if (createCard) {
                showEventModal(null, null);
            } else if (editableText) {
                const key = editableText.dataset.key;
                const isIcon = editableText.tagName === 'I';
                if (key === 'raffleEndTime') {
                    showTimerModal();
                } else {
                    showTextModal(key, isIcon);
                }
            }
        } else {
            if (button?.matches('.event-button')) {
                showTicketModal(button.dataset.eventId, button.dataset.eventTitle);
            } else if (button?.matches('.participants-button')) {
                showParticipantsModal(button.dataset.eventId, button.dataset.eventTitle);
            }
        }
    });

    dom.eventModalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const index = dom.eventIndexInput.value;
        const eventData = {
            id: (index && index !== 'null' && pageContent.events[index]) ? pageContent.events[index].id : Date.now(),
            title: dom.eventTitleInput.value,
            description: dom.eventDescriptionInput.value,
            image_url: dom.eventImageInput.value,
            tickets_cost: parseInt(dom.eventCostInput.value),
            top_border_color: dom.eventBorderColorInput.value,
            bg_color: dom.eventBgColorInput.value,
            dot_color: dom.eventDotColorInput.value,
            image_scale: parseFloat(dom.eventImageScaleInput.value)
        };
        
        if (index && index !== 'null' && pageContent.events[index]) {
            pageContent.events[index] = eventData;
        } else {
            if (!pageContent.events) pageContent.events = [];
            pageContent.events.push(eventData);
        }
        
        hideModal(dom.eventModal);
        renderPage();
    });

    dom.textModalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        pageContent[dom.textKeyInput.value] = dom.textValueInput.value;
        hideModal(dom.textModal);
        renderPage();
    });

    dom.timerModalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        pageContent.raffleEndTime = dom.timerInput.value;
        hideModal(dom.timerModal);
        renderPage();
    });

    document.querySelectorAll('.modal-overlay').forEach(modalOverlay => {
        const closeButton = modalOverlay.querySelector('.modal-close-btn');
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                hideModal(modalOverlay);
            });
        }
    });

    initialize();
});
</script>
</body>
</html>
