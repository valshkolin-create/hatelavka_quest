<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê—É–∫—Ü–∏–æ–Ω</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;900&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        /* ‚¨áÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –ù–æ–≤–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –∏ –¥–∏–∑–∞–π–Ω ‚¨áÔ∏è */
        :root {
          --background-main: #111111;
          --surface-primary: #1C1C1C;
          --border-color: #333333;
          --text-primary: #f0f0f5;
          --text-secondary: #AAAAAA;
          --accent-primary: #FFD700;
          --accent-secondary: #FF9500;
          --gold-color: #ffd700;
        }
        
        /* ‚¨áÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ù–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ–±–µ—Ä—Ç–∫–∏ ‚¨áÔ∏è */
        .overlay-wrapper {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 600px;  /* –ë—ã–ª–æ 450px */
            height: 240px; /* –ë—ã–ª–æ 191px */
            overflow: hidden;
        }

        body {
            background-color: transparent;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
            color: var(--text-primary);
        }
        
        /* ‚¨áÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –≠—Ñ—Ñ–µ–∫—Ç "–ñ–∏–¥–∫–æ–≥–æ —Å—Ç–µ–∫–ª–∞" ‚¨áÔ∏è */
        .widget-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(28, 28, 28, 0.75);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0; 
            transform: scale(0.95);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .widget-container.visible { 
            opacity: 1; 
            transform: scale(1);
        }
        
        /* ‚¨áÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 4: –ù–æ–≤—ã–π HTML-–º–∞–∫–µ—Ç (Header + Body) ‚¨áÔ∏è */
        .header { 
            padding: 12px 20px; 
            border-bottom: 1px solid var(--border-color); 
            text-align: center;
        }
        .header-title { 
            font-size: 24px; 
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            color: var(--text-primary); /* –ë–µ–ª—ã–π */
        }
        
        .content-body { 
            display: flex; 
            padding: 20px; 
            gap: 15px; 
            align-items: center;
            justify-content: space-between;
            flex-grow: 1;
        }

        .stat-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-basis: 150px;
            height: 100%;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
        }
        .stat-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary); /* –ñ–µ–ª—Ç—ã–π */
            white-space: nowrap;
        }
        .stat-sub-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
            /* –î–ª—è –∏–∫–æ–Ω–æ–∫ */
            display: flex;
            align-items: center;
        }
        .stat-sub-value i {
            margin-right: 6px;
            font-size: 0.9em;
        }
        .twitch-icon { color: #9146FF; }
        .user-icon { color: var(--text-secondary); }


        .skin-column {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        /* ‚¨áÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 5: –¢–µ–∫—Å—Ç—É—Ä–∞, –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ, —à—É–º ‚¨áÔ∏è */
        .skin-image-container {
            width: 100%;
            max-width: 250px; /* –û–≥—Ä–∞–Ω–∏—á–∏–º —à–∏—Ä–∏–Ω—É —Å–∫–∏–Ω–∞ */
            height: 100%;
            position: relative;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), /* 40% –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
                url('https://i.postimg.cc/sDGrJ8z6/fon-variant2.png'); /* –ñ–µ–ª—Ç–∞—è —Ç–µ–∫—Å—Ç—É—Ä–∞ */
            background-size: cover;
            background-position: center;
            border-radius: 8px; 
            overflow: hidden;
        }

        /* ‚¨áÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 6: –†–∞–±–æ—á–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —à—É–º ‚¨áÔ∏è */
        .skin-image-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('https://i.imgur.com/gYy63vX.png'); /* –†–∞–±–æ—á–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ tile-noise */
            background-size: 100px;
            background-repeat: repeat;
            opacity: 0.05;
            pointer-events: none;
            mix-blend-mode: overlay;
            border-radius: 8px;
        }
        /* --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø 6 --- */

        .skin-image { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            filter: contrast(115%); /* –†–µ–∑–∫–æ—Å—Ç—å */
        }
        /* --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô CSS --- */

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞–≤–∫–µ */
        #new-bid-notification { 
            position: absolute; 
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary)); 
            color: #000; 
            padding: 15px 30px; 
            border-radius: 10px; 
            font-size: 24px; 
            font-weight: 900; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
            white-space: nowrap; 
            opacity: 0; 
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 20; 
        }
        #new-bid-notification.show { opacity: 1; top: 20px; }
        #new-bid-notification.hide { opacity: 0; top: -100px; transition: all 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045); }

    </style>
</head>
<body>

    <div id="new-bid-notification">
        –ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –æ—Ç <span id="bid-notify-name">...</span>!
    </div>

    <div class="overlay-wrapper" id="overlay-wrapper">

        <div id="widget-container" class="widget-container">
            <div class="header">
                <div class="header-title" id="auction-title">–ê—É–∫—Ü–∏–æ–Ω</div>
            </div>
            <div class="content-body">
                <div class="stat-column">
                    <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–≤–∫–∞</div>
                    <div class="stat-value" id="last-bid-amount">0 üéüÔ∏è</div>
                    <div class="stat-sub-value" id="last-bidder-name">
                        <i class="fa-solid fa-user user-icon"></i>–ù–µ—Ç —Å—Ç–∞–≤–æ–∫
                    </div>
                </div>
                
                <div class="skin-column">
                    <div class="skin-image-container">
                        <img class="skin-image" id="skin-image" src="" alt="Skin">
                    </div>
                </div>
                
                <div class="stat-column">
                    <div class="stat-label">–î–æ –∫–æ–Ω—Ü–∞</div>
                    <div class="stat-value" id="auction-timer">00:00:00</div>
                    <div class="stat-sub-value" id="auction-status-text">
                        –û–∂–∏–¥–∞–Ω–∏–µ
                    </div>
                </div>
            </div>
        </div>
        </div> 

    <script>
        /*
        ============================================================
        ‚¨áÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 8: JAVASCRIPT –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù ‚¨áÔ∏è
        ============================================================
        */
        const SUPABASE_URL = 'https://pyeuckjcrsiaseyqrsek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZXVja2pjcnNpYXNleXFyc2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzEyOTgsImV4cCI6MjA3MDA0NzI5OH0.srRwuUygiF7jr3-b2AwyRNAmrChlW3Bzp3I-9Ju2TVg';

        const dom = {
            widget: document.getElementById('widget-container'),
            title: document.getElementById('auction-title'),
            timer: document.getElementById('auction-timer'),
            statusText: document.getElementById('auction-status-text'),
            skinImage: document.getElementById('skin-image'),
            bidAmount: document.getElementById('last-bid-amount'),
            bidderName: document.getElementById('last-bidder-name'),
            notification: document.getElementById('new-bid-notification'),
            notifyName: document.getElementById('bid-notify-name')
        };

        let countdownInterval = null;
        let currentAuctionId = null; 
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–º–µ–Ω–∏ ---
        function getDisplayName(auction) {
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Twitch-–Ω–∏–∫, –∑–∞—Ç–µ–º TG-–∏–º—è, –∑–∞—Ç–µ–º —Ñ–æ–ª–ª–±—ç–∫
            if (auction.bidder && auction.bidder.twitch_login) {
                return auction.bidder.twitch_login;
            }
            if (auction.current_highest_bidder_name) {
                return auction.current_highest_bidder_name;
            }
            return '–ù–µ—Ç —Å—Ç–∞–≤–æ–∫';
        };

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–∫–∏ ---
        function getDisplayIcon(auction) {
            if (auction.bidder && auction.bidder.twitch_login) {
                return '<i class="fa-brands fa-twitch twitch-icon"></i>';
            }
            if (auction.current_highest_bid) { // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞–≤–∫–∞, –Ω–æ –Ω–µ—Ç —Ç–≤–∏—á–∞
                 return '<i class="fa-solid fa-user user-icon"></i>';
            }
            return ''; // –ù–µ—Ç —Å—Ç–∞–≤–∫–∏ - –Ω–µ—Ç –∏–∫–æ–Ω–∫–∏
        }

        function startCountdown(expiresAt) {
            if (countdownInterval) clearInterval(countdownInterval);
            
            if (!expiresAt) {
                dom.timer.textContent = "00:00:00";
                dom.statusText.textContent = "–û–∂–∏–¥–∞–Ω–∏–µ";
                return;
            }

            const endTime = new Date(expiresAt).getTime();
            
            const updateTimer = () => {
                const now = new Date().getTime();
                const distance = endTime - now;
                
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    dom.timer.textContent = "00:00:00";
                    dom.statusText.textContent = "–ó–∞–≤–µ—Ä—à–µ–Ω"; // –ò–ª–∏ "–ó–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è..."
                    return;
                }
                
                dom.statusText.textContent = "–ò–¥–µ—Ç"; // –°—Ç–∞–≤–∫–∞ —Å–¥–µ–ª–∞–Ω–∞
                const h = Math.floor(distance / 3600000);
                const m = Math.floor((distance % 3600000) / 60000);
                const s = Math.floor((distance % 60000) / 1000);
                dom.timer.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            };
            countdownInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        function updateDisplay(auctionData) {
            if (!auctionData) { 
                // –ê—É–∫—Ü–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è -> –ü—Ä—è—á–µ–º –≤–∏–¥–∂–µ—Ç
                dom.widget.classList.remove('visible');
                currentAuctionId = null;
                if (countdownInterval) clearInterval(countdownInterval);
                return; 
            }
            
            currentAuctionId = auctionData.id;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø–æ–ª—è
            dom.title.textContent = auctionData.title || "–ê—É–∫—Ü–∏–æ–Ω";
            const imageUrl = auctionData.image_url || 'https://i.postimg.cc/d0r554hc/1200-600.png?v=2';
            if (dom.skinImage.src !== imageUrl) dom.skinImage.src = imageUrl;
            
            dom.bidAmount.textContent = `${auctionData.current_highest_bid || 0} üéüÔ∏è`;
            dom.bidderName.innerHTML = `${getDisplayIcon(auctionData)} ${getDisplayName(auctionData)}`;
            
            startCountdown(auctionData.bid_cooldown_ends_at);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç
            dom.widget.classList.add('visible');
        }
        
        function triggerAnimation(payload) {
            const { auction_data, last_bidder_name } = payload.new.payload;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –∫ —Ç–µ–∫—É—â–µ–º—É –∞—É–∫—Ü–∏–æ–Ω—É
            if (currentAuctionId === null || currentAuctionId === 0 || currentAuctionId === auction_data.id) {
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏—Å–ø–ª–µ–π (–∞—É–∫—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç—Ä–∏–≥–≥–µ—Ä–∞)
                // –ù–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ 'auction_data' –¥–∞–Ω–Ω—ã–µ –æ 'bidder' (twitch_login)
                // –¢—Ä–∏–≥–≥–µ—Ä –≤ Python –¥–æ–ª–∂–µ–Ω —ç—Ç–æ –ø—Ä–∏—Å—ã–ª–∞—Ç—å!
                // *–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ Python-—Ç—Ä–∏–≥–≥–µ—Ä —Ç–µ–ø–µ—Ä—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç 'auction_data.bidder'*
                updateDisplay(auction_data);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                dom.notifyName.textContent = last_bidder_name;
                dom.notification.classList.add('show');
                setTimeout(() => {
                    dom.notification.classList.remove('show');
                    dom.notification.classList.add('hide');
                }, 4000); 
                setTimeout(() => {
                    dom.notification.classList.remove('hide');
                }, 4500);
            }
        }

        async function loadInitialState() {
            try {
                // 1. –ò—â–µ–º –ê–ö–¢–ò–í–ù–´–ô, –í–ò–î–ò–ú–´–ô, –ù–ï–ó–ê–í–ï–†–®–ï–ù–ù–´–ô –∞—É–∫—Ü–∏–æ–Ω
                const { data: auctionData, error: auctionError } = await supabaseClient
                    .from('auctions')
                    .select('*, bidder:current_highest_bidder_id(full_name, twitch_login)') // <-- –í–ê–ñ–ù–´–ô JOIN
                    .eq('is_active', true)
                    .eq('is_visible', true)
                    .is('ended_at', null)
                    .order('created_at', { ascending: false }) 
                    .limit(1);

                if (auctionError) throw auctionError;
                
                if (!auctionData || auctionData.length === 0) {
                    // ‚ùóÔ∏è –≠—Ç–æ —Ç–≤–æ—è –æ—à–∏–±–∫–∞: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–∫—Ü–∏–æ–Ω–æ–≤"
                    // –ï—Å–ª–∏ RLS –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, —ç—Ç–∞ –æ—à–∏–±–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç.
                    // –ï—Å–ª–∏ RLS –Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, —ç—Ç–∞ –æ—à–∏–±–∫–∞ –û–°–¢–ê–ù–ï–¢–°–Ø.
                    console.log("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–∫—Ü–∏–æ–Ω–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏. –í–∏–¥–∂–µ—Ç –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç.");
                    updateDisplay(null); // –ü—Ä—è—á–µ–º –≤–∏–¥–∂–µ—Ç
                    return; 
                }

                const auction = auctionData[0];
                console.log("–ó–∞–≥—Ä—É–∂–µ–Ω –ª–æ—Ç:", auction.title, "(ID:", auction.id, ")");
                
                // 2. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–∏–¥–∂–µ—Ç
                updateDisplay(auction);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
                updateDisplay(null); // –ü—Ä—è—á–µ–º –≤–∏–¥–∂–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }

        // --- –ó–∞–ø—É—Å–∫ ---
        try {
            // 1. –°–ª—É—à–∞–µ–º –¢–†–ò–ì–ì–ï–†–´ (–ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞)
            supabaseClient.channel('auction-triggers-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'auction_triggers' },
                    payload => triggerAnimation(payload)
                ).subscribe();

            // 2. –°–ª—É—à–∞–µ–º –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ê–£–ö–¶–ò–û–ù–û–í (–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –°–±—Ä–æ—Å, –°–∫—Ä—ã—Ç–∏–µ)
            supabaseClient.channel('auctions-changes-channel')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'auctions' }, 
                    payload => {
                        console.log('–ü–æ–ª—É—á–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ auctions, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞:', payload);
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –õ–Æ–ë–û–ú –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
                        loadInitialState();
                    }
                ).subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Supabase. –ó–∞–≥—Ä—É–∑–∫–∞...');
                        loadInitialState();
                    }
                });

        } catch (error) { console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase:", error); }

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω), –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ Realtime "–æ—Ç–≤–∞–ª–∏—Ç—Å—è"
        setInterval(loadInitialState, 120000); 

        /* ============================================================
        ‚¨ÜÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï 8: –ö–û–ù–ï–¶ –ë–õ–û–ö–ê JAVASCRIPT ‚¨ÜÔ∏è
        ============================================================
        */
    </script>
</body>
</html>
