<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --bg-gradient: radial-gradient(ellipse at 50% 100%, #041a07, #000000);
      --bg-color: #000000;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --primary-color: #34c759;
      --action-color: #007aff;
      --surface-glass-bg: rgba(28, 28, 30, 0.75);
      --divider-glass-color: rgba(58, 58, 60, 0.6);
      --danger-color: #ff3b30;
      --warning-color: #ff9500;
      --status-active-color: #32d74b;
      --status-inactive-color: #98989d;
      --status-approved-color: #5856d6;
    }
    body { margin: 0; min-height: 100vh; background-color: var(--bg-color); background-image: var(--bg-gradient); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .main-content { padding: 25px 20px; }
    .hidden { display: none !important; }
    .quests-container { display: flex; flex-direction: column; gap: 15px; }
    .quest-card { background-color: var(--surface-glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
    .quest-title { font-size: 16px; font-weight: 600; line-height: 1.3; margin: 0 0 8px 0; flex-grow: 1; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-header-title { margin: 0; font-size: 22px; font-weight: 700; text-align: center; flex-grow: 1; }
    .back-button { background: none; border: none; color: var(--action-color); font-size: 16px; cursor: pointer; padding: 5px; font-weight: 500; text-decoration: none; }
    .admin-form { display: flex; flex-direction: column; gap: 15px; text-align: left; }
    .admin-form input, .admin-form textarea, .admin-form select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #555; background-color: #333; color: white; font-size: 16px; box-sizing: border-box; }
    .admin-form label { font-weight: 600; font-size: 14px; margin-top: 5px; display: flex; align-items: center; gap: 6px; }
    .admin-form button { background-color: var(--primary-color); border: none; padding: 12px; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
    .admin-menu-button { background-color: var(--action-color); width: 100%; border: none; padding: 12px; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
    .admin-submission-card { text-align: left; gap: 8px; }
    .submission-user strong { color: var(--primary-color); }
    .submission-data { background-color: rgba(0,0,0,0.4); padding: 10px; border-radius: 6px; word-break: break-all; font-family: monospace; font-size: 14px; flex-grow: 1; }
    .submission-wrapper { display: flex; gap: 10px; align-items: center; margin-top: 8px; }
    .action-link-btn { background-color: #5856d6; padding: 8px 12px; font-size: 12px; border-radius: 6px; color: white; text-decoration: none; font-weight: 600; flex-shrink: 0; text-align: center; }
    .submission-actions { display: flex; gap: 10px; margin-top: 15px; }
    .admin-action-btn { flex-grow: 1; border: none; padding: 10px; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; }
    .admin-action-btn.approve { background-color: var(--primary-color); }
    .admin-action-btn.reject { background-color: var(--danger-color); }
    .admin-action-btn.confirm { background-color: var(--status-approved-color); }
    .admin-delete-quest-btn, .admin-edit-quest-btn, .admin-view-subs-btn, .admin-edit-challenge-btn, .admin-delete-challenge-btn { width: fit-content; font-size: 12px; padding: 8px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; color: white; }
    .admin-delete-quest-btn, .admin-delete-challenge-btn { background-color: var(--danger-color); }
    .admin-edit-quest-btn, .admin-edit-challenge-btn { background-color: var(--action-color); }
    .admin-view-subs-btn { background-color: #5856d6; }
    .manage-quest-card { display: flex; flex-direction: column; align-items: flex-start; text-align: left; padding: 15px; position: relative; }
    .quest-admin-meta { position: static; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;}
    .quest-status-badge { font-size: 10px; font-weight: 600; padding: 3px 7px; border-radius: 7px; }
    .quest-status-badge.status-active { color: var(--status-active-color); background-color: rgba(50, 215, 75, 0.15); }
    .quest-status-badge.status-inactive { color: var(--status-inactive-color); background-color: rgba(152, 152, 157, 0.15); }
    .manage-quest-info { flex-grow: 1; font-weight: 600; margin-bottom: 10px; width: 100%; }
    .admin-buttons-wrapper { display: flex; flex-wrap: wrap; gap: 10px; width: 100%; margin-top: 10px; }
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background-color: var(--surface-glass-bg); border: 1px solid var(--divider-glass-color); padding: 20px; border-radius: 14px; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .modal-title { font-size: 18px; font-weight: 600; margin: 0; }
    .modal-close-btn { background: none; border: none; color: var(--text-color-muted); font-size: 24px; cursor: pointer; }
    .modal-body { overflow-y: auto; }
    .submission-item { border-bottom: 1px solid var(--divider-glass-color); padding: 10px 0; }
    .submission-item:last-child { border-bottom: none; }
    .submission-item p { margin: 4px 0; font-size: 14px; }
    .submission-status-badge { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 8px; color: white; }
    .status-pending { background-color: #ff9500; }
    .status-approved { background-color: var(--status-approved-color); }
    .category-card { flex-direction: row; justify-content: space-between; align-items: center; }
    .category-name { font-weight: 500; flex-grow: 1; margin-right: 10px;}
    .category-actions { display: flex; gap: 10px; align-items: center;}
    .prompt-modal { background-color: var(--surface-glass-bg); border: 1px solid rgba(58, 58, 60, 0.6); padding: 15px; border-radius: 12px; width: 85%; max-width: 300px; text-align: center; }
    .prompt-actions { display:flex; gap: 10px; margin-top: 15px; }
    .prompt-actions > * { flex:1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
    .prompt-actions .confirm-btn { background-color: var(--primary-color); color: white; }
    .prompt-actions .cancel-btn { background-color: #555; color: white; }
    .category-actions .sort-btn, .sort-quest-btn { background-color: #555; padding: 4px 8px; font-size: 14px; }
    .sort-btn:disabled, .sort-quest-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .quest-category-accordion { width: 100%;}
    .quest-category-header { cursor: pointer; font-size: 16px; font-weight: 600; padding: 12px; background-color: rgba(44, 44, 46, 0.85); border-radius: 8px; list-style: none; display: flex; align-items: center; justify-content: space-between; }
    .quest-category-header::-webkit-details-marker { display: none; }
    .quest-category-header::before { content: '‚ñ∂'; display: inline-block; margin-right: 8px; font-size: 12px; transition: transform 0.2s; }
    .quest-category-accordion[open] > .quest-category-header::before { transform: rotate(90deg); }
    .quest-category-body { display: flex; flex-direction: column; gap: 10px; padding: 10px 0 5px; }
    .quest-category-header .category-info { flex-grow: 1; display: flex; align-items: center; }
    .quest-category-header .category-actions-in-header { display: flex; gap: 10px; align-items: center; }
    .sleep-mode-toggle { position: fixed; top: 20px; right: 20px; width: 24px; height: 24px; background-color: var(--action-color); border-radius: 50%; border: none; color: white; font-size: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 1000; }
    .sleep-mode-toggle.is-sleeping { background-color: var(--danger-color); }
    .admin-icon-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 20px; padding: 10px 0; }
    .admin-icon-button { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; text-decoration: none; color: var(--text-color); gap: 8px; }
    .admin-icon-button .icon-wrapper { width: 64px; height: 64px; background-color: var(--surface-glass-bg); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 26px; transition: background-color 0.2s, transform 0.2s; }
    .admin-icon-button:active .icon-wrapper { transform: scale(0.95); }
    .admin-icon-button span { font-size: 12px; font-weight: 500; line-height: 1.2; }
    .admin-icon-button .icon-wrapper .fa-user-check { color: var(--warning-color); }
    .admin-icon-button .icon-wrapper .fa-sliders { color: var(--action-color); }
    .admin-icon-button .icon-wrapper .fa-user-gear { color: var(--status-approved-color); } 
    .pending-action-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
    .pending-action-type-badge { font-size: 11px; font-weight: 600; padding: 4px 9px; border-radius: 8px; color: white; }
    .type-submission { background-color: var(--warning-color); }
    .type-prize { background-color: var(--status-approved-color); }
    .settings-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
    .settings-group h3 { margin-top: 0; margin-bottom: 5px; font-size: 18px; }
    .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--divider-glass-color); }
    .setting-item:last-child { border-bottom: none; }
    .setting-label { font-size: 15px; font-weight: 500; }
    .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
    .toggle-slider:before { position: absolute; content: ""; height: 23px; width: 23px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: var(--primary-color); }
    input:checked + .toggle-slider:before { transform: translateX(20px); }
    .tabs-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--divider-glass-color); padding-bottom: 10px; }
    .tab-button { flex: 1; padding: 10px; font-size: 14px; font-weight: 600; color: var(--text-color-muted); background-color: transparent; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .tab-button.active { color: var(--text-color); background-color: var(--surface-glass-bg); }
    .tab-content { display: flex; flex-direction: column; gap: 15px; }
    .tab-content.hidden { display: none; }
    .user-management-section h3 {
        font-size: 16px;
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--divider-glass-color);
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }
    .stat-card {
        background-color: var(--surface-glass-bg);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        position: relative;
    }
    .stat-card-header {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        margin: 0 0 10px;
    }
    .stat-card-header h4 {
        margin: 0;
        font-size: 14px;
        color: var(--text-color-muted);
        font-weight: 500;
    }
    .stat-card p {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        color: var(--text-color);
    }
    .event-stat-item {
        background-color: var(--surface-glass-bg);
        border-radius: 10px;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .event-stat-item strong {
        font-weight: 500;
    }
    .event-stat-item span {
        font-weight: 600;
        font-size: 16px;
    }
    
    /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –î–õ–Ø –¢–£–õ–¢–ò–ü–û–í --- */
    .tooltip {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: #555;
        color: #fff;
        cursor: help;
        font-size: 11px;
        font-weight: bold;
        flex-shrink: 0;
    }
    .tooltip .tooltip-text {
        visibility: hidden;
        width: 240px;
        background-color: #222;
        color: #fff;
        text-align: left;
        border-radius: 8px;
        padding: 10px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 13px;
        font-weight: 400;
        line-height: 1.5;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        pointer-events: none;
    }
    .tooltip .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #222 transparent transparent transparent;
    }
    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    /* --- –î–û–ë–ê–í–õ–ï–ù–ù–´–ô –§–ò–ö–° –î–õ–Ø –ü–†–ê–í–´–• –¢–£–õ–¢–ò–ü–û–í --- */
    .stats-grid .stat-card:nth-child(even) .tooltip .tooltip-text {
        left: auto;
        right: 0;
        transform: translateX(0);
    }
    .stats-grid .stat-card:nth-child(even) .tooltip .tooltip-text::after {
        left: auto;
        right: 10px; /* –°–¥–≤–∏–≥–∞–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É –Ω–∞–ø—Ä–∞–≤–æ */
        margin-left: 0;
    }
    /* Twitch –Ω–∞–≥—Ä–∞–¥—ã –≤ —Å–µ—Ç–∫—É */
    #twitch-rewards-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* —Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ */
        gap: 15px;
    }

    #twitch-rewards-container .quest-card {
        padding: 10px;       /* –¥–µ–ª–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
        font-size: 14px;     /* —É–º–µ–Ω—å—à–∞–µ–º —Ç–µ–∫—Å—Ç */
    }
  </style>
</head>
<body>

    <button id="sleep-mode-toggle" class="sleep-mode-toggle hidden" title="–†–µ–∂–∏–º —Å–Ω–∞">
        <i class="fa-solid fa-power-off"></i>
    </button>

    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="spinner"></div>
    </div>

    <main id="app-container" class="main-content">
        <div id="view-admin-main" class="view">
            <div class="page-header">
                <a href="/menu" class="back-button"><i class="fa-solid fa-house"></i> –ù–∞ —Å–∞–π—Ç</a>
                <h1 class="page-header-title">–ê–¥–º–∏–Ω–∫–∞</h1>
                <div style="width: 80px;"></div>
            </div>
            <div class="admin-icon-menu">
                <div class="admin-icon-button" data-view="view-admin-quests">
                    <div class="icon-wrapper"><i class="fa-solid fa-list-check"></i></div>
                    <span>–ó–∞–¥–∞–Ω–∏—è</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-categories">
                    <div class="icon-wrapper"><i class="fa-solid fa-folder-tree"></i></div>
                    <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-challenges">
                    <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
                    <span>–ß–µ–ª–ª–µ–Ω–¥–∂–∏</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-promocodes">
                    <div class="icon-wrapper"><i class="fa-solid fa-ticket"></i></div>
                    <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-pending-actions">
                    <div class="icon-wrapper"><i class="fa-solid fa-user-check"></i></div>
                    <span>–í—ã–¥–∞—á–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-user-management">
                    <div class="icon-wrapper"><i class="fa-solid fa-user-gear"></i></div>
                    <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-settings">
                    <div class="icon-wrapper"><i class="fa-solid fa-sliders"></i></div>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-statistics">
                    <div class="icon-wrapper"><i class="fa fa-chart-line"></i></div>
                    <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                </div>
                <div class="admin-icon-button" data-view="view-admin-twitch-rewards">
                    <div class="icon-wrapper"><i class="fa-brands fa-twitch"></i></div>
                    <span>Twitch –Ω–∞–≥—Ä–∞–¥—ã</span>
                </div>
            </div>
        </div>
        
        <div id="view-admin-user-management" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
                <div style="width: 60px;"></div>
            </div>

            <div class="quest-card">
                <div class="user-management-section">
                    <h3><i class="fa-solid fa-star" style="color: var(--warning-color);"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ó–≤–µ–∑–¥–∞–º–∏ (–ß–µ–∫–ø–æ–∏–Ω—Ç)</h3>
                    <form id="grant-checkpoint-stars-form" class="admin-form">
                        <label>–í—ã–¥–∞—Ç—å –∑–≤–µ–∑–¥—ã –ß–µ–∫–ø–æ–∏–Ω—Ç–∞
                             <div class="tooltip">?
                                <span class="tooltip-text">–î–æ–±–∞–≤–ª—è–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ù–µ –æ—Ç–Ω–∏–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ.</span>
                            </div>
                        </label>
                        <input type="number" name="user_id_to_grant_cp" required placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        <input type="number" name="amount_cp" required placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥">
                        <button type="submit">–í—ã–¥–∞—Ç—å</button>
                    </form>
                    <form id="freeze-checkpoint-stars-form" class="admin-form" style="margin-top: 20px;">
                        <label>–ó–∞–º–æ—Ä–æ–∑–∫–∞/—Ä–∞–∑–º–æ—Ä–æ–∑–∫–∞ –∑–≤–µ–∑–¥
                            <div class="tooltip">?
                                <span class="tooltip-text">–í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ç—Ä–∞—Ç–∏—Ç—å –∑–≤—ë–∑–¥—ã –ß–µ–∫–ø–æ–∏–Ω—Ç–∞. –í–≤–µ–¥–∏—Ç–µ 0 –¥–Ω–µ–π –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏.</span>
                            </div>
                        </label>
                        <input type="number" name="user_id_to_freeze_cp" required placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        <input type="number" name="days_cp" required placeholder="–ö–æ–ª-–≤–æ –¥–Ω–µ–π (0 –¥–ª—è —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏)">
                        <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </form>
                </div>
            </div>
            
            <div class="quest-card" style="margin-top: 20px;">
                 <div class="user-management-section">
                    <h3><i class="fa-solid fa-ticket" style="color: var(--primary-color);"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–∏–ª–µ—Ç–∞–º–∏ (–ò–≤–µ–Ω—Ç—ã)</h3>
                    <form id="grant-tickets-form" class="admin-form">
                        <label>–í—ã–¥–∞—Ç—å –±–∏–ª–µ—Ç—ã
                            <div class="tooltip">?
                                <span class="tooltip-text">–î–æ–±–∞–≤–ª—è–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö.</span>
                            </div>
                        </label>
                        <input type="number" name="user_id_to_grant_tickets" required placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        <input type="number" name="amount_tickets" required placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤">
                        <button type="submit">–í—ã–¥–∞—Ç—å</button>
                    </form>
                    <form id="freeze-tickets-form" class="admin-form" style="margin-top: 20px;">
                        <label>–ó–∞–º–æ—Ä–æ–∑–∫–∞/—Ä–∞–∑–º–æ—Ä–æ–∑–∫–∞ –±–∏–ª–µ—Ç–æ–≤
                             <div class="tooltip">?
                                <span class="tooltip-text">–í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö. –í–≤–µ–¥–∏—Ç–µ 0 –¥–Ω–µ–π –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏.</span>
                            </div>
                        </label>
                        <input type="number" name="user_id_to_freeze_tickets" required placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        <input type="number" name="days_tickets" required placeholder="–ö–æ–ª-–≤–æ –¥–Ω–µ–π (0 –¥–ª—è —Ä–∞–∑–º–æ—Ä–æ–∑–∫–∏)">
                        <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </form>
                </div>
            </div>

            <div class="quest-card" style="margin-top: 20px;">
                 <div class="user-management-section">
                    <h3 style="color: var(--danger-color);"><i class="fa-solid fa-broom"></i> –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–ß–µ–∫–ø–æ–∏–Ω—Ç)</h3>
                    <form id="reset-checkpoint-progress-form" class="admin-form">
                        <label>–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –ß–µ–∫–ø–æ–∏–Ω—Ç–∞
                            <div class="tooltip">?
                                <span class="tooltip-text">–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –ß–µ–∫–ø–æ–∏–Ω—Ç–∞, –Ω–æ –ù–ï –¢–†–û–ì–ê–ï–¢ –±–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</span>
                            </div>
                        </label>
                        <input type="number" name="user_id_to_reset" required placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        <button type="submit" class="admin-action-btn reject" style="width: 100%;">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—ã</button>
                    </form>
                    <form id="clear-checkpoint-stars-form" class="admin-form" style="margin-top: 20px;">
                        <label>–û–±–Ω—É–ª–∏—Ç—å –∑–≤—ë–∑–¥—ã –ß–µ–∫–ø–æ–∏–Ω—Ç–∞
                            <div class="tooltip">?
                                <span class="tooltip-text">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥ –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ –Ω–∞ 0, –Ω–æ –ù–ï –¢–†–û–ì–ê–ï–¢ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</span>
                            </div>
                        </label>
                        <input type="number" name="user_id_to_clear" required placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        <button type="submit" class="admin-action-btn reject" style="width: 100%;">–û–±–Ω—É–ª–∏—Ç—å –∑–≤—ë–∑–¥—ã</button>
                    </form>
                </div>
            </div>

        </div>

        <div id="view-admin-pending-actions" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–û–∂–∏–¥–∞—é—Ç –¥–µ–π—Å—Ç–≤–∏—è</h1>
                <div style="width: 60px;"></div>
            </div>
            <div class="tabs-container">
                <button class="tab-button active" data-tab="submissions">
                    <i class="fa-solid fa-user-check"></i> –ü—Ä–æ–≤–µ—Ä–∫–∏
                </button>
                <button class="tab-button" data-tab="event-prizes">
                    <i class="fa-solid fa-trophy"></i> –†–æ–∑—ã–≥—Ä—ã—à–∏
                </button>
                <button class="tab-button" data-tab="checkpoint-prizes">
                    <i class="fa-solid fa-flag-checkered"></i> –ß–µ–∫–ø–æ–∏–Ω—Ç
                </button>
            </div>
            <div id="tab-content-submissions" class="tab-content active quests-container"></div>
            <div id="tab-content-event-prizes" class="tab-content hidden quests-container"></div>
            <div id="tab-content-checkpoint-prizes" class="tab-content hidden quests-container"></div>
        </div>

        <div id="view-admin-settings" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="quest-card">
                <div class="settings-group">
                    <h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                    <div class="admin-form" style="gap: 20px;">
                        <div>
                            <label for="setting-menu-banner-url">URL –±–∞–Ω–Ω–µ—Ä–∞ "–ì–æ–Ω–∫–∞ –∑–∞ —Å–∫–∏–Ω–∞–º–∏"</label>
                            <input type="text" id="setting-menu-banner-url" placeholder="https://example.com/banner.png">
                        </div>
                        <div>
                            <label for="setting-checkpoint-banner-url">URL –±–∞–Ω–Ω–µ—Ä–∞ "–ú–∞—Ä–∞—Ñ–æ–Ω –ß–µ–∫–ø–æ–∏–Ω—Ç"</label>
                            <input type="text" id="setting-checkpoint-banner-url" placeholder="https://example.com/banner2.png">
                        </div>
                    </div>
                </div>
            </div>

            <div class="quest-card" style="margin-top: 20px;">
                <div class="settings-group">
                    <h3>–°–∏—Å—Ç–µ–º—ã</h3>
                    <div class="setting-item">
                        <span class="setting-label">–°–∏—Å—Ç–µ–º–∞ –ó–∞–¥–∞–Ω–∏–π</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-quests-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">–°–∏—Å—Ç–µ–º–∞ –ß–µ–ª–ª–µ–Ω–¥–∂–µ–π</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-challenges-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">–°–∏—Å—Ç–µ–º–∞ –ß–µ–∫–ø–æ–∏–Ω—Ç–∞</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-checkpoint-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="quest-card" style="margin-top: 20px;">
                <div class="settings-group">
                    <h3>–ù–∞–≥—Ä–∞–¥—ã</h3>
                    <div class="setting-item">
                        <span class="setting-label">–ù–∞–≥—Ä–∞–¥—ã –∑–∞ –ó–∞–¥–∞–Ω–∏—è</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-quest-rewards-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">–ù–∞–≥—Ä–∞–¥—ã –∑–∞ –ß–µ–ª–ª–µ–Ω–¥–∂–∏</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-challenge-rewards-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
             <div class="quest-card" style="margin-top: 20px;">
                <div class="settings-group">
                    <button id="save-settings-btn" class="admin-action-btn approve" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>
            </div>

             <div class="quest-card" style="margin-top: 20px;">
                <div class="settings-group">
                    <h3>–û–ø–∞—Å–Ω–æ</h3>
                    <div class="admin-form" style="gap: 10px;">
                        <button id="reset-all-quests-btn" class="admin-action-btn reject" style="width: 100%;">–°–±—Ä–æ—Å–∏—Ç—å –∫–≤–µ—Å—Ç—ã —É –≤—Å–µ—Ö</button>
                        <button id="reset-all-checkpoint-progress-btn" class="admin-action-btn reject" style="width: 100%;">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ —É –≤—Å–µ—Ö</button>
                        <button id="clear-all-checkpoint-stars-btn" class="admin-action-btn reject" style="width: 100%;">–û–±–Ω—É–ª–∏—Ç—å –∑–≤—ë–∑–¥—ã –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ —É –≤—Å–µ—Ö</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="view-admin-categories" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h1>
                <div style="width: 60px;"></div>
            </div>
            <div class="quest-card">
                <form id="create-category-form" class="admin-form">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                    <input type="text" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, '–°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è'">
                    <button type="submit">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                </form>
            </div>
             <div id="categories-list" class="quests-container" style="margin-top: 20px;"></div>
        </div>

        <div id="view-admin-challenges" class="view hidden">
             <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–ß–µ–ª–ª–µ–Ω–¥–∂–∏</h1>
                <button id="go-create-challenge" class="admin-menu-button" style="width: auto; padding: 8px 12px; font-size: 14px;">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <div id="challenges-list" class="quests-container"></div>
        </div>
        
        <div id="view-admin-challenge-form" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-challenges"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 id="challenge-form-title" class="page-header-title">–ù–æ–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂</h1>
                <div style="width: 60px;"></div>
            </div>
            <div class="quest-card">
                <form id="challenge-form" class="admin-form">
                    <input type="hidden" name="challenge_id">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" rows="3" required></textarea>
                    <label>–¢–∏–ø —É—Å–ª–æ–≤–∏—è</label>
                    <select name="condition_type" required>
                        <option value="telegram_messages">–°–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram</option>
                        <option value="twitch_points">–†–∞–Ω–≥/PTS –≤ Twitch</option>
                        <option value="twitch_messages">–°–æ–æ–±—â–µ–Ω–∏—è Twitch</option>
                        <option value="twitch_uptime">Twitch (–≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)</option>
                    </select>
                    <div class="challenge-period-wrapper hidden">
                        <label>–ü–µ—Ä–∏–æ–¥</label>
                        <select name="challenge_period">
                           <option value="session">–°–µ—Å—Å–∏—è</option>
                           <option value="week">–ù–µ–¥–µ–ª—è</option>
                           <option value="month">–ú–µ—Å—è—Ü</option>
                        </select>
                    </div>
                    <label>–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                    <input type="number" name="target_value" required>
                    <label>–ù–∞–≥—Ä–∞–¥–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥)</label>
                    <input type="number" name="reward_amount" required>
                    <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —á–∞—Å–∞—Ö)</label>
                    <input type="number" name="duration_days" value="16" required>
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select name="is_active">
                        <option value="true">–ê–∫—Ç–∏–≤–µ–Ω</option>
                        <option value="false">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                    </select>
                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <div id="view-admin-quests" class="view hidden">
             <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–ó–∞–¥–∞–Ω–∏—è</h1>
                <button id="go-create-quest" class="admin-menu-button" style="width: auto; padding: 8px 12px; font-size: 14px;">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <div id="quests-list" class="quests-container"></div>
        </div>

        <div id="view-admin-promocodes" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h1>
                <div style="width: 60px;"></div>
            </div>
            <div class="quest-card">
                <form id="add-promocodes-form" class="admin-form">
                    <label>–°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
                    <textarea name="codes" rows="6" required></textarea>
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥</label>
                    <input type="number" name="reward_value" required>
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã</label>
                    <input type="text" name="description" required>
                    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <div id="view-admin-create" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-quests"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h1>
                <div style="width: 60px;"></div>
            </div>
            <div class="quest-card">
                <form id="create-quest-form" class="admin-form">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" name="title" required>
                    <label>URL –∏–∫–æ–Ω–∫–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
                    <input type="text" name="icon_url">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" rows="3"></textarea>
                    <label>–ù–∞–≥—Ä–∞–¥–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥)</label>
                    <input type="number" name="reward_amount" required>
                    <label>–¢–∏–ø –∫–≤–µ—Å—Ç–∞</label>
                    <select name="quest_type">
                        <option value="manual_check">–†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</option>
                        <option value="automatic_telegram_messages">Telegram (—Å–æ–æ–±—â–µ–Ω–∏—è)</option>
                        <option value="automatic_twitch_points">Twitch (—Ä–∞–Ω–≥/PTS)</option>
                        <option value="automatic_twitch_messages">Twitch (—Å–æ–æ–±—â–µ–Ω–∏—è)</option>
                        <option value="automatic_twitch_uptime">Twitch (–≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)</option>
                    </select>
                    <div class="manual-options-wrapper">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–¥–ª—è —Ä—É—á–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π)</label>
                        <select name="category_id">
                            <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        </select>
                        <label>–†–µ–∂–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–ª—è —Ä—É—á–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π)</label>
                        <select name="is_repeatable">
                            <option value="false">–û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ</option>
                            <option value="true">–ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–æ–µ</option>
                        </select>
                        <label>URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (–¥–ª—è —Ä—É—á–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π)</label>
                        <input type="text" name="action_url" placeholder="https://tiktok.com/...">
                    </div>
                    <div class="automatic-options-wrapper hidden">
                        <div class="twitch-period-wrapper hidden">
                            <label>–ü–µ—Ä–∏–æ–¥</label>
                            <select name="twitch_period">
                               <option value="session">–°–µ—Å—Å–∏—è</option>
                               <option value="week">–ù–µ–¥–µ–ª—è</option>
                               <option value="month">–ú–µ—Å—è—Ü</option>
                            </select>
                        </div>
                        <label>–¶–µ–ª—å (–¥–ª—è –∞–≤—Ç–æ-–∫–≤–µ—Å—Ç–æ–≤)</label>
                        <input type="number" name="target_value">
                    </div>
                    <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —á–∞—Å–∞—Ö, 0 - –±–µ—Å—Å—Ä–æ—á–Ω–æ)</label>
                    <input type="number" name="duration_days" value="0">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select name="is_active">
                        <option value="true">–ê–∫—Ç–∏–≤–µ–Ω</option>
                        <option value="false">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                    </select>
                    <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
                </form>
            </div>
        </div>

        <div id="view-admin-edit" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-quests"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
                <div style="width: 60px;"></div>
            </div>
            <div class="quest-card">
                <form id="edit-quest-form" class="admin-form">
                    <input type="hidden" name="quest_id">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" name="title" required>
                    <label>URL –∏–∫–æ–Ω–∫–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
                    <input type="text" name="icon_url">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" rows="3"></textarea>
                    <label>–ù–∞–≥—Ä–∞–¥–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥)</label>
                    <input type="number" name="reward_amount" required>
                    <label>–¢–∏–ø –∫–≤–µ—Å—Ç–∞</label>
                    <select name="quest_type">
                        <option value="manual_check">–†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</option>
                        <option value="automatic_telegram_messages">Telegram (—Å–æ–æ–±—â–µ–Ω–∏—è)</option>
                        <option value="automatic_twitch_points">Twitch (—Ä–∞–Ω–≥/PTS)</option>
                        <option value="automatic_twitch_messages">Twitch (—Å–æ–æ–±—â–µ–Ω–∏—è)</option>
                        <option value="automatic_twitch_uptime">Twitch (–≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)</option>
                    </select>
                    <div class="manual-options-wrapper">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–¥–ª—è —Ä—É—á–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π)</label>
                        <select name="category_id">
                            <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        </select>
                        <label>–†–µ–∂–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–ª—è —Ä—É—á–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π)</label>
                        <select name="is_repeatable">
                            <option value="false">–û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ</option>
                            <option value="true">–ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–æ–µ</option>
                        </select>
                        <label>URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (–¥–ª—è —Ä—É—á–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π)</label>
                        <input type="text" name="action_url" placeholder="https://tiktok.com/...">
                    </div>
                     <div class="automatic-options-wrapper hidden">
                        <div class="twitch-period-wrapper hidden">
                            <label>–ü–µ—Ä–∏–æ–¥</label>
                            <select name="twitch_period">
                               <option value="session">–°–µ—Å—Å–∏—è</option>
                               <option value="week">–ù–µ–¥–µ–ª—è</option>
                               <option value="month">–ú–µ—Å—è—Ü</option>
                            </select>
                        </div>
                        <label>–¶–µ–ª—å (–¥–ª—è –∞–≤—Ç–æ-–∫–≤–µ—Å—Ç–æ–≤)</label>
                        <input type="number" name="target_value">
                    </div>
                    <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —á–∞—Å–∞—Ö, 0 - –±–µ—Å—Å—Ä–æ—á–Ω–æ)</label>
                    <input type="number" name="duration_days" value="0">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select name="is_active">
                        <option value="true">–ê–∫—Ç–∏–≤–µ–Ω</option>
                        <option value="false">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                    </select>
                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <div id="view-admin-statistics" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-main"><i class="fa fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                <div style="width: 60px;"></div>
            </div>
            <div id="statistics-content">
                <h2 style="font-size: 20px; margin-bottom: 15px;">–ü—É–ª—å—Å –ø—Ä–æ–µ–∫—Ç–∞ ü©∫</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h4>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è (DAU)</h4>
                            <div class="tooltip">?
                                <span class="tooltip-text">Daily Active Users. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ö–æ–¥–∏–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è (—Å 00:00).</span>
                            </div>
                        </div>
                        <p id="stat-dau">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h4>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é (WAU)</h4>
                            <div class="tooltip">?
                                <span class="tooltip-text">Weekly Active Users. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ö–æ–¥–∏–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.</span>
                            </div>
                        </div>
                        <p id="stat-wau">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h4>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ –º–µ—Å—è—Ü (MAU)</h4>
                            <div class="tooltip">?
                                <span class="tooltip-text">Monthly Active Users. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ö–æ–¥–∏–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.</span>
                            </div>
                        </div>
                        <p id="stat-mau">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                             <h4>"–õ–∏–ø–∫–æ—Å—Ç—å" (DAU/MAU)</h4>
                            <div class="tooltip">?
                                <span class="tooltip-text">–ö–ª—é—á–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–π % –º–µ—Å—è—á–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∑–∞—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. –•–æ—Ä–æ—à–∏–º —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ >20%.</span>
                            </div>
                        </div>
                        <p id="stat-stickiness">0%</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h4>–ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è</h4>
                             <div class="tooltip">?
                                <span class="tooltip-text">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è (—Å 00:00).</span>
                            </div>
                        </div>
                        <p id="stat-new-today">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h4>–ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é</h4>
                            <div class="tooltip">?
                                <span class="tooltip-text">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.</span>
                            </div>
                        </div>
                        <p id="stat-new-week">0</p>
                    </div>
                </div>
                <div id="events-stats-container" style="margin-top: 25px;">
                    <h2 style="font-size: 20px; margin-bottom: 15px;">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ üî•</h2>
                    <div id="events-stats-list"></div>
                </div>
            </div>
        </div>
      
        <div id="view-admin-twitch-rewards" class="view hidden">
            <div class="page-header">
                <button class="back-button" data-view="view-admin-main">
                    <i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥
                </button>
                <h1 class="page-header-title">Twitch –Ω–∞–≥—Ä–∞–¥—ã</h1>
                <div style="width: 60px;"></div>
            </div>

            <div id="twitch-rewards-container">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è –Ω–∞–≥—Ä–∞–¥—ã -->
            </div>
        </div>
    </main>

    <div id="submissions-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">–ó–∞—è–≤–∫–∏</h2>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>
    
    <div id="generic-prompt-overlay" class="modal-overlay hidden">
        <div class="prompt-modal">
            <h3 id="generic-prompt-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>
            <input type="text" id="generic-prompt-input" class="admin-form" style="margin-top: 15px;">
            <div class="prompt-actions">
                <button id="generic-prompt-cancel" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                <button id="generic-prompt-confirm" class="confirm-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="winners-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</h2>
                <button id="winners-modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="winners-modal-body" class="modal-body">
            </div>
        </div>
    </div>

    <div id="sleep-prompt-overlay" class="modal-overlay hidden">
        <div class="prompt-modal">
            <h3>–£–ª–æ–∂–∏—Ç—å –±–æ—Ç–∞ —Å–ø–∞—Ç—å?</h3>
            <p style="font-size: 14px; color: var(--text-color-muted);">0 = —Å–ø–∞—Ç—å –≤–µ—á–Ω–æ (–¥–æ —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è)</p>
            <input type="number" id="sleep-minutes-input" class="admin-form" style="margin-top: 15px;" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç..." value="60">
            <div class="prompt-actions">
                <button id="sleep-prompt-cancel" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                <button id="sleep-prompt-confirm" class="confirm-btn">–£–ª–æ–∂–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
    try {
        const tg = window.Telegram.WebApp;
        
        const dom = {
            loaderOverlay: document.getElementById('loader-overlay'),
            appContainer: document.getElementById('app-container'),
            views: document.querySelectorAll('.view'),
            questsList: document.getElementById('quests-list'),
            createQuestForm: document.getElementById('create-quest-form'),
            editQuestForm: document.getElementById('edit-quest-form'),
            addPromocodesForm: document.getElementById('add-promocodes-form'),
            submissionsModal: document.getElementById('submissions-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            challengesList: document.getElementById('challenges-list'),
            challengeForm: document.getElementById('challenge-form'),
            challengeFormTitle: document.getElementById('challenge-form-title'),
            createCategoryForm: document.getElementById('create-category-form'),
            categoriesList: document.getElementById('categories-list'),
            genericPromptOverlay: document.getElementById('generic-prompt-overlay'),
            genericPromptTitle: document.getElementById('generic-prompt-title'),
            genericPromptInput: document.getElementById('generic-prompt-input'),
            genericPromptCancel: document.getElementById('generic-prompt-cancel'),
            genericPromptConfirm: document.getElementById('generic-prompt-confirm'),
            winnersModal: document.getElementById('winners-modal'),
            winnersModalBody: document.getElementById('winners-modal-body'),
            winnersModalCloseBtn: document.getElementById('winners-modal-close-btn'),
            sleepModeToggle: document.getElementById('sleep-mode-toggle'),
            sleepPromptOverlay: document.getElementById('sleep-prompt-overlay'),
            sleepMinutesInput: document.getElementById('sleep-minutes-input'),
            sleepPromptCancel: document.getElementById('sleep-prompt-cancel'),
            sleepPromptConfirm: document.getElementById('sleep-prompt-confirm'),
            tabsContainer: document.querySelector('.tabs-container'),
            tabContentSubmissions: document.getElementById('tab-content-submissions'),
            tabContentEventPrizes: document.getElementById('tab-content-event-prizes'),
            tabContentCheckpointPrizes: document.getElementById('tab-content-checkpoint-prizes'),
            
            grantCheckpointStarsForm: document.getElementById('grant-checkpoint-stars-form'),
            freezeCheckpointStarsForm: document.getElementById('freeze-checkpoint-stars-form'),
            grantTicketsForm: document.getElementById('grant-tickets-form'),
            freezeTicketsForm: document.getElementById('freeze-tickets-form'),
            resetCheckpointProgressForm: document.getElementById('reset-checkpoint-progress-form'),
            clearCheckpointStarsForm: document.getElementById('clear-checkpoint-stars-form'),

            settingMenuBannerUrl: document.getElementById('setting-menu-banner-url'),
            settingCheckpointBannerUrl: document.getElementById('setting-checkpoint-banner-url'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            
            settingQuestsEnabled: document.getElementById('setting-quests-enabled'),
            settingChallengesEnabled: document.getElementById('setting-challenges-enabled'),
            settingQuestRewardsEnabled: document.getElementById('setting-quest-rewards-enabled'),
            settingChallengeRewardsEnabled: document.getElementById('setting-challenge-rewards-enabled'),
            resetAllQuestsBtn: document.getElementById('reset-all-quests-btn'),
            resetAllCheckpointProgressBtn: document.getElementById('reset-all-checkpoint-progress-btn'),
            clearAllCheckpointStarsBtn: document.getElementById('clear-all-checkpoint-stars-btn'),
            settingCheckpointEnabled: document.getElementById('setting-checkpoint-enabled'),
            statisticsContent: document.getElementById('statistics-content'),
        };

        let categoriesCache = [];
        let currentEditingCategoryId = null;

        async function loadStatistics() {
            showLoader();
            try {
                const stats = await makeApiRequest("/api/v1/admin/stats", {}, 'POST', true);
                
                const pulse = stats.pulse || {};
                const dau = pulse.dau || 0;
                const wau = pulse.wau || 0;
                const mau = pulse.mau || 0;
                const newToday = pulse.new_users_today || 0;
                const newWeek = pulse.new_users_week || 0;

                document.getElementById('stat-dau').textContent = dau;
                document.getElementById('stat-wau').textContent = wau;
                document.getElementById('stat-mau').textContent = mau;
                document.getElementById('stat-new-today').textContent = newToday;
                document.getElementById('stat-new-week').textContent = newWeek;

                const stickiness = mau > 0 ? ((dau / mau) * 100).toFixed(1) : 0;
                document.getElementById('stat-stickiness').textContent = `${stickiness}%`;

                const eventsList = document.getElementById('events-stats-list');
                eventsList.innerHTML = '';
                if (stats.events && stats.events.length > 0) {
                    stats.events.forEach(event => {
                        eventsList.insertAdjacentHTML('beforeend', `
                            <div class="event-stat-item">
                                <strong>${event.title}</strong>
                                <span>${event.participants} —É—á.</span>
                            </div>`);
                    });
                } else {
                    eventsList.innerHTML = '<p style="color: var(--text-color-muted); text-align: center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π.</p>';
                }

            } catch (e) {
                dom.statisticsContent.innerHTML = `<p class="error-message" style="text-align: center;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: ${e.message}</p>`;
            } finally {
                hideLoader();
            }
        }

        const switchView = async (targetViewId) => {
            dom.views.forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(targetViewId);
            if (targetView) targetView.classList.remove('hidden');

            if (dom.sleepModeToggle) {
                const isAdmin = document.body.dataset.isAdmin === 'true';
                dom.sleepModeToggle.classList.toggle('hidden', targetViewId !== 'view-admin-main' || !isAdmin);
            }
            
            showLoader();
            try {
                switch (targetViewId) {
                    case 'view-admin-quests': {
                        const allQuests = await makeApiRequest('/api/v1/admin/quests/all', {}, 'POST', true);
                        await fetchAndCacheCategories(true);
                        renderQuests(allQuests, categoriesCache);
                        break;
                    }
                    case 'view-admin-pending-actions': {
                        const [submissions, winners, checkpointPrizes] = await Promise.all([
                            makeApiRequest('/api/v1/admin/pending_actions', {}, 'POST', true),
                            makeApiRequest('/api/v1/admin/events/winners', {}, 'POST', true),
                            makeApiRequest('/api/v1/admin/checkpoint_rewards', {}, 'POST', true)
                        ]);
                        renderSubmissions(submissions);
                        renderWinners(winners);
                        renderCheckpointPrizes(checkpointPrizes);
                        break;
                    }
                    case 'view-admin-challenges': {
                        renderChallenges(await makeApiRequest('/api/v1/admin/challenges', {}, 'POST', true));
                        break;
                    }
                    case 'view-admin-categories': {
                        await fetchAndCacheCategories(true);
                        renderCategoriesList();
                        break;
                    }
                    case 'view-admin-settings': {
                        await loadAndRenderSettings();
                        break;
                    }
                    case 'view-admin-statistics': {
                        await loadStatistics();
                        break;
                    }
                    case 'view-admin-twitch-rewards': {
                        await loadTwitchRewards();
                        break;
                    }
                    case 'view-admin-create': {
                        await fetchAndCacheCategories(true);
                        populateCategorySelects();
                        dom.createQuestForm.reset();
                        updateQuestFormUI(dom.createQuestForm);
                        break;
                    }
                    // =================================================================
                    // ========= –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ß–ï–õ–õ–ï–ù–î–ñ–ê =========
                    // =================================================================
                    // –ë–õ–û–ö case 'view-admin-challenge-form' –ë–´–õ –£–î–ê–õ–ï–ù –û–¢–°–Æ–î–ê
                    // –ß–¢–û–ë–´ –û–ù –ù–ï –°–ë–†–ê–°–´–í–ê–õ –§–û–†–ú–£ –ö–ê–ñ–î–´–ô –†–ê–ó –ü–†–ò –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ò.
                    // ===============================================================
                    // ========= –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ß–ï–õ–õ–ï–ù–î–ñ–ê =========
                    // ===============================================================
                }
            } finally {
                hideLoader();
            }
        };

        const showLoader = () => dom.loaderOverlay.classList.remove('hidden');
        const hideLoader = () => dom.loaderOverlay.classList.add('hidden');

        async function makeApiRequest(url, body = {}, method = 'POST', isSilent = false) {
            if (!isSilent) showLoader();
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...body, initData: tg.initData })
                });
                if (response.status === 204) return null;
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.detail || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                return result;
            } catch (e) {
                if (!isSilent) tg.showAlert(`–û—à–∏–±–∫–∞: ${e.message}`);
                throw e;
            } finally {
                if (!isSilent) hideLoader();
            }
        }
        
        async function fetchAndCacheCategories(isSilent = false) {
            try {
                categoriesCache = await makeApiRequest('/api/v1/admin/categories', {}, 'POST', isSilent) || [];
            } catch (e) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", e);
                categoriesCache = [];
            }
        }
        
        function populateCategorySelects(selectedId = null) {
            const selects = document.querySelectorAll('select[name="category_id"]');
            selects.forEach(select => {
                select.innerHTML = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
                categoriesCache.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    if (selectedId && parseInt(selectedId) === cat.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }
        
        function renderCategoriesList() {
            dom.categoriesList.innerHTML = '';
            if (categoriesCache.length === 0) {
                 dom.categoriesList.innerHTML = '<p style="text-align: center;">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                 return;
            }
            categoriesCache.forEach((cat, index) => {
                 dom.categoriesList.insertAdjacentHTML('beforeend', `
                     <div class="quest-card category-card" data-category-id="${cat.id}">
                         <span class="category-name">${cat.name}</span>
                         <div class="category-actions">
                             <button class="admin-edit-quest-btn sort-btn" data-index="${index}" data-direction="up" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                             <button class="admin-edit-quest-btn sort-btn" data-index="${index}" data-direction="down" ${index === categoriesCache.length - 1 ? 'disabled' : ''}>‚ñº</button>
                             <button class="admin-edit-quest-btn edit-category-btn" data-id="${cat.id}" data-name="${cat.name}">–†–µ–¥–∞–∫—Ç.</button>
                             <button class="admin-delete-quest-btn delete-category-btn" data-id="${cat.id}">–£–¥–∞–ª–∏—Ç—å</button>
                         </div>
                     </div>
                 `);
            });
        }
        
        function renderChallenges(challenges) {
            dom.challengesList.innerHTML = '';
            if (!challenges || challenges.length === 0) {
                dom.challengesList.innerHTML = `<p style="text-align: center;">–°–æ–∑–¥–∞–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π –Ω–µ—Ç.</p>`;
                return;
            }
            const conditionTypes = {
                'telegram_messages': '–°–æ–æ–±—â–µ–Ω–∏—è TG', 'twitch_points': '–†–∞–Ω–≥/PTS Twitch',
                'twitch_messages_session': '–°–æ–æ–±—â–µ–Ω–∏—è Twitch (—Å–µ—Å—Å–∏—è)', 'twitch_messages_week': '–°–æ–æ–±—â–µ–Ω–∏—è Twitch (–Ω–µ–¥–µ–ª—è)', 'twitch_messages_month': '–°–æ–æ–±—â–µ–Ω–∏—è Twitch (–º–µ—Å—è—Ü)',
                'twitch_uptime_session': '–í—Ä–µ–º—è Twitch (—Å–µ—Å—Å–∏—è)', 'twitch_uptime_week': '–í—Ä–µ–º—è Twitch (–Ω–µ–¥–µ–ª—è)', 'twitch_uptime_month': '–í—Ä–µ–º—è Twitch (–º–µ—Å—è—Ü)'
            };
            challenges.forEach(c => {
                const statusClass = c.is_active ? 'status-active' : 'status-inactive';
                const cardHtml = `
                <div class="quest-card manage-quest-card">
                    <div class="quest-admin-meta"><span class="quest-status-badge ${statusClass}">${c.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span></div>
                    <div class="manage-quest-info">
                        <span>${c.description}</span><br>
                        <small style="color: var(--text-color-muted);">–¢–∏–ø: ${conditionTypes[c.condition_type] || c.condition_type} | –¶–µ–ª—å: ${c.target_value} | –°—Ä–æ–∫: ${c.duration_days} —á. | –ù–∞–≥—Ä–∞–¥–∞: ${c.reward_amount} ‚≠ê</small>
                    </div>
                    <div class="admin-buttons-wrapper">
                        <button class="admin-edit-challenge-btn" data-challenge='${JSON.stringify(c)}'>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="admin-delete-challenge-btn" data-id="${c.id}">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>`;
                dom.challengesList.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
        
        function updateChallengeFormUI(form) {
            const conditionType = form.querySelector('select[name="condition_type"]').value;
            const periodWrapper = form.querySelector('.challenge-period-wrapper');
            if (periodWrapper) {
                const showPeriod = conditionType === 'twitch_messages' || conditionType === 'twitch_uptime';
                periodWrapper.classList.toggle('hidden', !showPeriod);
            }
        }
        
        function updateQuestFormUI(form) {
            const questType = form.querySelector('select[name="quest_type"]').value;
            const isManual = questType === 'manual_check';
            form.querySelector('.manual-options-wrapper').classList.toggle('hidden', !isManual);
            form.querySelector('.automatic-options-wrapper').classList.toggle('hidden', isManual);
            if (!isManual) {
                const twitchPeriodWrapper = form.querySelector('.twitch-period-wrapper');
                const showPeriodSelector = questType === 'automatic_twitch_messages' || questType === 'automatic_twitch_uptime';
                twitchPeriodWrapper.classList.toggle('hidden', !showPeriodSelector);
            }
        }
        
        function showGenericPrompt(title, value, id) {
            currentEditingCategoryId = id;
            dom.genericPromptTitle.textContent = title;
            dom.genericPromptInput.value = value;
            dom.genericPromptOverlay.classList.remove('hidden');
            dom.genericPromptInput.focus();
        }
        
        function hideGenericPrompt() {
            dom.genericPromptOverlay.classList.add('hidden');
            currentEditingCategoryId = null;
        }

        function renderSubmissions(submissions) {
            dom.tabContentSubmissions.innerHTML = '';
            if (!submissions || submissions.length === 0) {
                dom.tabContentSubmissions.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.</p>';
                return;
            }

            submissions.forEach(action => {
                let submissionContent = '';
                const data = action.submitted_data || '';
                const isUrl = data.startsWith('http://') || data.startsWith('https://');
                if (isUrl) {
                    submissionContent = `<a href="${data}" target="_blank" rel="noopener noreferrer" style="color: var(--action-color); text-decoration: underline; word-break: break-all;">${data}</a>`;
                } else {
                    submissionContent = `<span>${data}</span>`;
                }
                const actionLinkHtml = (action.quest_action_url && action.quest_action_url !== "")
                    ? `<a href="${action.quest_action_url}" target="_blank" rel="noopener noreferrer" class="action-link-btn">–ü–µ—Ä–µ–π—Ç–∏</a>`
                    : '';
                const cardHtml = `
                <div class="quest-card admin-submission-card" id="submission-card-${action.id}">
                    <h3 class="quest-title">${action.title || '–†—É—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ'}</h3>
                    <p style="font-size: 14px; color: var(--text-color-muted); line-height: 1.4; margin: 4px 0 12px;">${action.quest_description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}</p>
                    <p style="font-size: 13px; font-weight: 500; margin-bottom: 12px;">–ù–∞–≥—Ä–∞–¥–∞: ${action.reward_amount || '?'} ‚≠ê</p>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>${action.user_full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</strong></p>
                    <p style="margin-top: 10px; margin-bottom: 5px; font-weight: 600; font-size: 13px;">–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</p>
                    <div class="submission-wrapper">
                        <div class="submission-data">${submissionContent}</div>
                        ${actionLinkHtml}
                    </div>
                    <div class="submission-actions">
                        <button class="admin-action-btn approve" data-id="${action.id}" data-action="approved">–û–¥–æ–±—Ä–∏—Ç—å</button>
                        <button class="admin-action-btn reject" data-id="${action.id}" data-action="rejected">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>`;
                dom.tabContentSubmissions.innerHTML += cardHtml;
            });
        }

        function renderCheckpointPrizes(prizes) {
            dom.tabContentCheckpointPrizes.innerHTML = '';
            if (!prizes || prizes.length === 0) {
                dom.tabContentCheckpointPrizes.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">–ù–µ—Ç –Ω–∞–≥—Ä–∞–¥ –∏–∑ –ß–µ–∫–ø–æ–∏–Ω—Ç–∞.</p>';
                return;
            }

            prizes.forEach(action => {
                const cardHtml = `
                <div class="quest-card admin-submission-card" id="prize-card-${action.id}">
                    <h3 class="quest-title">${action.source_description || '–í—ã–¥–∞—á–∞ –Ω–∞–≥—Ä–∞–¥—ã'}</h3>
                    <p><b>–ü—Ä–∏–∑:</b> ${action.reward_details || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>${action.user_full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</strong></p>
                    ${action.user_trade_link ? `<p>–°—Å—ã–ª–∫–∞: <a href="${action.user_trade_link}" target="_blank" style="color: var(--action-color);">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–π–¥-—Å—Å—ã–ª–∫—É</a></p>` : '<p style="color:var(--warning-color);">–¢—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞!</p>'}
                    <div class="submission-actions">
                        <button class="admin-action-btn confirm" data-id="${action.id}" data-action="confirm_prize">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–¥–∞—á—É</button>
                    </div>
                </div>`;
                dom.tabContentCheckpointPrizes.innerHTML += cardHtml;
            });
        }
        
        function renderWinners(winners) {
            dom.tabContentEventPrizes.innerHTML = '';
            if (!winners || winners.length === 0) {
                dom.tabContentEventPrizes.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">–ù–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>';
                return;
            }
            
            winners.forEach(winner => {
                const hasValidTradeLink = winner.trade_link && winner.trade_link !== '–ù–µ —É–∫–∞–∑–∞–Ω–∞' && winner.trade_link.startsWith('http');
                const tradeLinkClass = hasValidTradeLink ? '' : 'disabled';
                const tradeLinkHref = hasValidTradeLink ? winner.trade_link : '#';
                
                const confirmationHtml = winner.prize_sent_confirmed
                    ? '<p style="text-align:center; color: var(--status-active-color); font-weight: 600;">‚úÖ –ü—Ä–∏–∑ –≤—ã–¥–∞–Ω</p>'
                    : `<button class="admin-action-btn confirm confirm-winner-prize-btn" data-event-id="${winner.event_id}">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–¥–∞—á—É</button>`;

                const cardHtml = `
                    <div class="quest-card admin-submission-card" id="winner-card-${winner.event_id}">
                        <h3 class="quest-title">${winner.prize_title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                        <p>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <strong>${winner.winner_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></p>
                        <p>–¢—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞: ${hasValidTradeLink ? `<a href="${tradeLinkHref}" target="_blank" style="color: var(--action-color);">–û—Ç–∫—Ä—ã—Ç—å</a>` : '<span style="color:var(--warning-color);">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>'}</p>
                        <div class="submission-actions">
                            ${confirmationHtml}
                        </div>
                    </div>`;
                dom.tabContentEventPrizes.innerHTML += cardHtml;
            });
        }
        
        async function loadAndRenderSettings() {
            try {
                 const settings = await makeApiRequest('/api/v1/admin/settings', {}, 'POST', true);
                 dom.settingQuestsEnabled.checked = settings.quests_enabled;
                 dom.settingChallengesEnabled.checked = settings.challenges_enabled;
                 dom.settingQuestRewardsEnabled.checked = settings.quest_promocodes_enabled;
                 dom.settingChallengeRewardsEnabled.checked = settings.challenge_promocodes_enabled;
                 dom.settingCheckpointEnabled.checked = settings.checkpoint_enabled;
                 dom.settingMenuBannerUrl.value = settings.menu_banner_url || '';
                 dom.settingCheckpointBannerUrl.value = settings.checkpoint_banner_url || '';
            } catch (e) {
                 console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:", e);
                 tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.");
            }
        }

        // --- Twitch Rewards ---
        async function loadTwitchRewards() {
            const container = document.getElementById('twitch-rewards-container');
            container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

            try {
                // 1) –≥—Ä—É–∑–∏–º —Å–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥ (GET, –±–µ–∑ —Ç–µ–ª–∞)
                const resp = await fetch('/api/v1/admin/twitch_rewards/list', { method: 'GET' });
                if (!resp.ok) {
                    const t = await resp.text().catch(() => '');
                    throw new Error(`HTTP ${resp.status} /list: ${t}`);
                }
                const rewards = await resp.json();

                container.innerHTML = '';

                if (!Array.isArray(rewards) || rewards.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">–ù–∞–≥—Ä–∞–¥ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                    return;
                }

                // 2) –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                rewards.forEach(r => {
                    const cardHtml = `
                        <div class="quest-card manage-quest-card" data-id="${r.id}">
                            <h3 class="quest-title">${r.title}</h3>
                            <div class="setting-item">
                                <span class="setting-label">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" class="reward-toggle-active" data-id="${r.id}" ${r.is_active ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <span class="setting-label">–£–≤–µ–¥–æ–º–ª—è—Ç—å –∞–¥–º–∏–Ω–∞</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" class="reward-toggle-notify" data-id="${r.id}" ${r.notify_admin ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="admin-buttons-wrapper" style="margin-top: 10px;">
                                <button class="admin-view-subs-btn" data-open-purchases="${r.id}">–ü–æ–∫—É–ø–∫–∏</button>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', cardHtml);
                });

                // 3) –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –û–î–ò–ù —Ä–∞–∑ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
                if (!container.dataset.listenersBound) {
                    container.addEventListener('change', async (e) => {
                        const el = e.target;
                        if (!(el instanceof HTMLInputElement)) return;

                        if (el.classList.contains('reward-toggle-active') || el.classList.contains('reward-toggle-notify')) {
                            const rewardId = parseInt(el.dataset.id, 10);
                            const key = el.classList.contains('reward-toggle-active') ? 'is_active' : 'notify_admin';
                            const prevChecked = !el.checked; // —á—Ç–æ–±—ã –æ—Ç–∫–∞—Ç–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

                            try {
                                const upd = await fetch('/api/v1/admin/twitch_rewards/update', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: rewardId, [key]: el.checked })
                                });
                                if (!upd.ok) {
                                    const t = await upd.text().catch(() => '');
                                    throw new Error(`HTTP ${upd.status} /update: ${t}`);
                                }
                            } catch (err) {
                                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã:', err);
                                el.checked = prevChecked; // –æ—Ç–∫–∞—Ç —á–µ–∫–±–æ–∫—Å–∞ –ø—Ä–∏ —Ñ–µ–π–ª–µ
                            }
                        }
                    });

                    container.addEventListener('click', (e) => {
                        const btn = e.target.closest('[data-open-purchases]');
                        if (!btn) return;
                        const rid = btn.getAttribute('data-open-purchases');
                        openTwitchPurchases(rid);
                    });

                    container.dataset.listenersBound = '1';
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Twitch –Ω–∞–≥—Ä–∞–¥:', e);
                container.innerHTML = '<p style="text-align: center; color: var(--danger-color);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≥—Ä–∞–¥.</p>';
            }
        }

        async function openTwitchPurchases(rewardId) {
            const modal = document.getElementById("twitch-purchases-modal");
            const listEl = modal.querySelector(".modal-body");
            listEl.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";

            try {
                const resp = await fetch(`/api/v1/admin/twitch_rewards/${rewardId}/purchases`);
                if (!resp.ok) throw new Error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                const data = await resp.json();

                if (!data.purchases || data.purchases.length === 0) {
                    listEl.innerHTML = "<p>–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫ –¥–ª—è —ç—Ç–æ–π –Ω–∞–≥—Ä–∞–¥—ã.</p>";
                } else {
                    listEl.innerHTML = data.purchases.map(p => `
                        <div class="submission-item">
                            <p><strong>${p.username}</strong> (ID: ${p.user_id})</p>
                            <p>–¢—Ä–µ–π–¥: ${p.trade_link 
                                ? `<a href="${p.trade_link}" target="_blank">${p.trade_link}</a>` 
                                : '<span style="color: var(--warning-color);">–ù–µ —É–∫–∞–∑–∞–Ω</span>'}</p>
                            <p><small>${new Date(p.created_at).toLocaleString()}</small></p>
                        </div>
                    `).join("");
                }

                modal.classList.remove("hidden");
            } catch (e) {
                listEl.innerHTML = "<p style='color: var(--danger-color);'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫</p>";
                console.error(e);
            }
        }
        function closeTwitchPurchasesModal() {
            document.getElementById("twitch-purchases-modal").classList.add("hidden");
        }

        function renderQuests(quests, categories) {
            dom.questsList.innerHTML = '';
            if (!quests || quests.length === 0) {
                 dom.questsList.innerHTML = `<p style="text-align: center;">–°–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç.</p>`;
                 return;
            }
            const questTypeMap = {
                'manual_check': { name: '–†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞', color: '#5856d6' },
                'automatic_telegram_messages': { name: '–ê–≤—Ç–æ: Telegram', color: '#007aff' },
                'automatic_twitch_points': { name: '–ê–≤—Ç–æ: Twitch –†–∞–Ω–≥', color: '#6441a5' },
                'automatic_twitch_messages': { name: '–ê–≤—Ç–æ: Twitch –°–æ–æ–±—â–µ–Ω–∏—è', color: '#6441a5' },
                'automatic_twitch_uptime': { name: '–ê–≤—Ç–æ: Twitch –í—Ä–µ–º—è', color: '#6441a5' },
            };
            const getQuestTypeDetails = (type) => {
                const baseType = Object.keys(questTypeMap).find(key => type.startsWith(key));
                return baseType ? questTypeMap[baseType] : { name: type, color: '#98989d' };
            };

            const groupedQuests = quests.reduce((acc, quest) => {
                const categoryId = quest.category_id || 'no_category';
                if (!acc[categoryId]) acc[categoryId] = [];
                acc[categoryId].push(quest);
                return acc;
            }, {});
            const allCategories = [{ id: 'no_category', name: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' }, ...categories];
            allCategories.forEach(cat => {
                const questsInCategory = (groupedQuests[cat.id] || []).sort((a, b) => (a.sort_order || 999) - (b.sort_order || 999));
                if (questsInCategory.length === 0) return;
                const questsHtml = questsInCategory.map((quest, index) => {
                    const statusClass = quest.is_active ? 'status-active' : 'status-inactive';
                    const typeDetails = getQuestTypeDetails(quest.quest_type);
                    return `
                    <div class="quest-card manage-quest-card" data-quest-id="${quest.id}">
                        <div class="quest-admin-meta">
                            <span class="quest-status-badge ${statusClass}">${quest.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
                            <span class="quest-status-badge" style="background-color: ${typeDetails.color}20; color: ${typeDetails.color};">${typeDetails.name}</span>
                            <button class="admin-edit-quest-btn sort-quest-btn" data-quest-id="${quest.id}" data-category-id="${cat.id === 'no_category' ? '' : cat.id}" data-index="${index}" data-direction="up" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                            <button class="admin-edit-quest-btn sort-quest-btn" data-quest-id="${quest.id}" data-category-id="${cat.id === 'no_category' ? '' : cat.id}" data-index="${index}" data-direction="down" ${index === questsInCategory.length - 1 ? 'disabled' : ''}>‚ñº</button>
                        </div>
                        <div class="manage-quest-info">
                            <span>${quest.title}</span><br>
                            <small style="color: var(--text-color-muted);">ID: ${quest.id} | –ù–∞–≥—Ä–∞–¥–∞: ${quest.reward_amount || '–Ω–µ—Ç'} ‚≠ê</small>
                        </div>
                        <div class="admin-buttons-wrapper">
                            ${quest.quest_type === 'manual_check' ? `<button class="admin-view-subs-btn" data-id="${quest.id}" data-title="${quest.title}">–ó–∞—è–≤–∫–∏</button>` : ''}
                            <button class="admin-edit-quest-btn" data-id="${quest.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="admin-delete-quest-btn" data-id="${quest.id}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>`;
                }).join('');
                const accordionHtml = `
                    <details class="quest-category-accordion" ${cat.id === 'no_category' ? 'open' : ''}>
                        <summary class="quest-category-header">
                            <div class="category-info">${cat.name}</div>
                        </summary>
                        <div class="quest-category-body">${questsHtml}</div>
                    </details>`;
                dom.questsList.insertAdjacentHTML('beforeend', accordionHtml);
            });
        }
        
        function renderSubmissionsInModal(submissions, questTitle) {
            dom.modalTitle.textContent = `–ó–∞—è–≤–∫–∏: ${questTitle}`;
            dom.modalBody.innerHTML = (!submissions || submissions.length === 0) ? '<p style="text-align: center;">–î–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫.</p>' :
                submissions.map(sub => `
                <div class="submission-item">
                    <p><strong>${sub.user_full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong> <span class="submission-status-badge status-${sub.status}">${sub.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : '–û–¥–æ–±—Ä–µ–Ω–∞'}</span></p>
                    <p><small>${new Date(sub.created_at).toLocaleString('ru-RU')}</small></p>
                </div>`).join('');
        }

        function getQuestFormData(form) {
            const data = Object.fromEntries(new FormData(form));
            let questType = data.quest_type;
            if (questType === 'automatic_twitch_messages' || questType === 'automatic_twitch_uptime') {
                questType = `${questType}_${data.twitch_period}`;
            }
            const finalData = {
                title: data.title, icon_url: data.icon_url, description: data.description,
                reward_amount: parseInt(data.reward_amount, 10), quest_type: questType,
                target_value: data.target_value ? parseInt(data.target_value, 10) : null,
                duration_days: data.duration_days ? parseInt(data.duration_days, 10) : 0,
            };
            if (data.quest_type === 'manual_check') {
                finalData.category_id = data.category_id ? parseInt(data.category_id, 10) : null;
                finalData.is_repeatable = data.is_repeatable === 'true';
                finalData.action_url = data.action_url;
            }
            return finalData;
        }

        function updateSleepButton(status) {
            if (status.is_sleeping) {
                dom.sleepModeToggle.classList.add('is-sleeping');
                dom.sleepModeToggle.title = "–†–∞–∑–±—É–¥–∏—Ç—å –±–æ—Ç–∞";
            } else {
                dom.sleepModeToggle.classList.remove('is-sleeping');
                dom.sleepModeToggle.title = "–£–ª–æ–∂–∏—Ç—å –±–æ—Ç–∞ —Å–ø–∞—Ç—å";
            }
        }

        function setupEventListeners() {
            if (dom.tabsContainer) {
                dom.tabsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.tab-button');
                    if (!button) return;

                    const tabId = button.dataset.tab;
                    dom.tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.toggle('hidden', content.id !== `tab-content-${tabId}`);
                        content.classList.toggle('active', content.id === `tab-content-${tabId}`);
                    });
                });
            }

            dom.sleepModeToggle.addEventListener('click', async () => {
                const isSleeping = dom.sleepModeToggle.classList.contains('is-sleeping');
                if (isSleeping) {
                    tg.showConfirm('–†–∞–∑–±—É–¥–∏—Ç—å –±–æ—Ç–∞?', async (ok) => {
                        if (ok) {
                            const result = await makeApiRequest('/api/v1/admin/toggle_sleep_mode');
                            updateSleepButton(result.new_status);
                            tg.showAlert(result.message);
                        }
                    });
                } else {
                    dom.sleepPromptOverlay.classList.remove('hidden');
                }
            });

            dom.sleepPromptCancel.addEventListener('click', () => dom.sleepPromptOverlay.classList.add('hidden'));
            dom.sleepPromptConfirm.addEventListener('click', async () => {
                const minutes = parseInt(dom.sleepMinutesInput.value) || 0;
                dom.sleepPromptOverlay.classList.add('hidden');
                const result = await makeApiRequest('/api/v1/admin/toggle_sleep_mode', { minutes: minutes });
                updateSleepButton(result.new_status);
                tg.showAlert(result.message);
            });

            dom.saveSettingsBtn.addEventListener('click', async () => {
                const payload = {
                    quests_enabled: dom.settingQuestsEnabled.checked,
                    challenges_enabled: dom.settingChallengesEnabled.checked,
                    quest_promocodes_enabled: dom.settingQuestRewardsEnabled.checked,
                    challenge_promocodes_enabled: dom.settingChallengeRewardsEnabled.checked,
                    checkpoint_enabled: dom.settingCheckpointEnabled.checked,
                    menu_banner_url: dom.settingMenuBannerUrl.value.trim(),
                    checkpoint_banner_url: dom.settingCheckpointBannerUrl.value.trim()
                };
                await makeApiRequest('/api/v1/admin/settings/update', { settings: payload });
                tg.showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            });
            
            dom.resetAllQuestsBtn.addEventListener('click', () => {
                 tg.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã —É –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?', async (ok) => {
                    if (ok) {
                        await makeApiRequest('/api/v1/admin/quests/reset-all-active');
                        tg.showAlert('–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã.');
                    }
                 });
            });

            dom.resetAllCheckpointProgressBtn.addEventListener('click', () => {
                 tg.showConfirm('–≠–¢–û –î–ï–ô–°–¢–í–ò–ï –ù–ï–û–ë–†–ê–¢–ò–ú–û! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –¢–û–õ–¨–ö–û –°–ü–ò–°–û–ö –ù–ê–ì–†–ê–î –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ —É –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? –ò—Ö –∑–≤—ë–∑–¥—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.', async (ok) => {
                    if (ok) {
                        await makeApiRequest('/api/v1/admin/users/reset-all-checkpoint-progress');
                        tg.showAlert('–°–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥ –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ —Å–±—Ä–æ—à–µ–Ω —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
                    }
                 });
            });

            dom.clearAllCheckpointStarsBtn.addEventListener('click', () => {
                 tg.showConfirm('–≠–¢–û –î–ï–ô–°–¢–í–ò–ï –ù–ï–û–ë–†–ê–¢–ò–ú–û! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –û–ë–ù–£–õ–ò–¢–¨ –ë–ê–õ–ê–ù–° –ó–í–Å–ó–î –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ —É –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? –ò—Ö –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.', async (ok) => {
                    if (ok) {
                        await makeApiRequest('/api/v1/admin/users/clear-all-checkpoint-stars');
                        tg.showAlert('–ë–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥ –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ –æ–±–Ω—É–ª—ë–Ω —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
                    }
                 });
            });

            dom.appContainer.addEventListener('click', async (event) => {
                const navButton = event.target.closest('.admin-icon-button, .back-button, #go-create-quest, #go-create-challenge');
                if (navButton) {
                    const view = navButton.dataset.view;
                    if (view) {
                        await switchView(view);
                    } else if (navButton.id === 'go-create-quest') {
                        await switchView('view-admin-create');
                    // =================================================================
                    // ========= –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ß–ï–õ–õ–ï–ù–î–ñ–ê =========
                    // =================================================================
                    } else if (navButton.id === 'go-create-challenge') {
                        // –Ø–í–ù–û –°–ë–†–ê–°–´–í–ê–ï–ú –§–û–†–ú–£ –ò –ú–ï–ù–Ø–ï–ú –ó–ê–ì–û–õ–û–í–û–ö –ü–ï–†–ï–î –û–¢–ö–†–´–¢–ò–ï–ú
                        dom.challengeForm.reset();
                        dom.challengeForm.elements['challenge_id'].value = '';
                        updateChallengeFormUI(dom.challengeForm);
                        dom.challengeFormTitle.textContent = '–ù–æ–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂';
                        await switchView('view-admin-challenge-form');
                    }
                    // ===============================================================
                    // ========= –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ß–ï–õ–õ–ï–ù–î–ñ–ê =========
                    // ===============================================================
                    return;
                }

                const target = event.target;

                const confirmWinnerBtn = target.closest('.confirm-winner-prize-btn');
                if (confirmWinnerBtn) {
                    const eventId = confirmWinnerBtn.dataset.eventId;
                    tg.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –≤—ã–¥–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–∏–∑ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é?', async (ok) => {
                        if (ok) {
                            await makeApiRequest('/api/v1/admin/events/confirm_sent', { event_id: parseInt(eventId) });
                            tg.showAlert('–í—ã–¥–∞—á–∞ –ø—Ä–∏–∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.');
                            confirmWinnerBtn.closest('.admin-submission-card')?.remove();
                        }
                    });
                    return;
                }
                
                const actionButton = target.closest('.admin-edit-quest-btn, .admin-delete-quest-btn, .admin-view-subs-btn, .admin-action-btn, .admin-edit-challenge-btn, .admin-delete-challenge-btn, .edit-category-btn, .delete-category-btn, .sort-btn, .sort-quest-btn');
                if (!actionButton) return;
                
                const id = actionButton.dataset.id;

                if (actionButton.matches('.edit-category-btn')) {
                    showGenericPrompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', actionButton.dataset.name, id);

                } else if (actionButton.matches('.delete-category-btn')) {
                    tg.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é?', async (ok) => {
                        if (ok) {
                            await makeApiRequest('/api/v1/admin/categories/delete', { category_id: parseInt(id) });
                            await switchView('view-admin-categories');
                        }
                    });

                } else if (actionButton.matches('.admin-edit-challenge-btn')) {
                    const c = JSON.parse(actionButton.dataset.challenge);
                    const form = dom.challengeForm;
                    let condType = c.condition_type, period = 'session';
                    const parts = c.condition_type.split('_');
                    if (['twitch_messages', 'twitch_uptime'].includes(parts.slice(0, 2).join('_'))) {
                        condType = parts.slice(0, 2).join('_');
                        period = parts[parts.length - 1];
                    }
                    form.elements['challenge_id'].value = c.id;
                    form.elements['description'].value = c.description;
                    form.elements['condition_type'].value = condType;
                    form.elements['challenge_period'].value = period;
                    form.elements['target_value'].value = c.target_value;
                    form.elements['reward_amount'].value = c.reward_amount;
                    form.elements['duration_days'].value = c.duration_days;
                    form.elements['is_active'].value = c.is_active.toString();
                    updateChallengeFormUI(form);
                    dom.challengeFormTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
                    await switchView('view-admin-challenge-form');

                } else if (actionButton.matches('.admin-delete-challenge-btn')) {
                     tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂ ID ${id}?`, async (ok) => {
                        if (ok) {
                            await makeApiRequest('/api/v1/admin/challenges/delete', { challenge_id: parseInt(id) });
                            await switchView('view-admin-challenges');
                        }
                    });

                } else if (actionButton.matches('.admin-edit-quest-btn') && !actionButton.matches('.sort-quest-btn') && !actionButton.matches('.edit-category-btn')) {
                    const quest = await makeApiRequest('/api/v1/admin/quest/details', { quest_id: parseInt(id) });
                    await fetchAndCacheCategories(true);
                    populateCategorySelects(quest.category_id);
                    const form = dom.editQuestForm;
                    let questType = quest.quest_type, twitchPeriod = 'session';
                    if (quest.quest_type.startsWith('automatic_twitch_')) {
                        const parts = quest.quest_type.split('_');
                        if (parts.length > 3) { questType = parts.slice(0, 3).join('_'); twitchPeriod = parts[3]; }
                    }
                    form.elements['quest_id'].value = quest.id;
                    form.elements['title'].value = quest.title;
                    form.elements['icon_url'].value = quest.icon_url || '';
                    form.elements['description'].value = quest.description || '';
                    form.elements['reward_amount'].value = quest.reward_amount;
                    form.elements['category_id'].value = quest.category_id || '';
                    form.elements['quest_type'].value = questType;
                    form.elements['action_url'].value = quest.action_url || '';
                    form.elements['twitch_period'].value = twitchPeriod;
                    form.elements['target_value'].value = quest.target_value || '';
                    form.elements['duration_days'].value = quest.duration_days || 0;
                    form.elements['is_active'].value = quest.is_active.toString();
                    form.elements['is_repeatable'].value = quest.is_repeatable.toString();
                    updateQuestFormUI(form);
                    await switchView('view-admin-edit');

                } else if (actionButton.matches('.admin-delete-quest-btn') && !actionButton.matches('.delete-category-btn')) {
                    tg.showConfirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ ID ${id}?`, async (ok) => {
                        if (ok) {
                            await makeApiRequest('/api/v1/admin/quest/delete', { quest_id: parseInt(id) });
                            await switchView('view-admin-quests'); 
                        }
                    });

                } else if (actionButton.matches('.admin-view-subs-btn')) {
                    const submissions = await makeApiRequest('/api/v1/admin/quest/submissions', { quest_id: parseInt(id) });
                    renderSubmissionsInModal(submissions, actionButton.dataset.title);
                    dom.submissionsModal.classList.remove('hidden');

                } else if (actionButton.matches('.admin-action-btn')) {
                    const action = actionButton.dataset.action;
                    const card = actionButton.closest('.admin-submission-card');
                    if (action === 'approved' || action === 'rejected') {
                         await makeApiRequest('/api/v1/admin/submission/update', { submission_id: parseInt(id), action });
                         tg.showAlert(`–ó–∞—è–≤–∫–∞ ${action === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}.`);
                         card?.remove();
                    } else if (action === 'confirm_prize') {
                        tg.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –≤—ã–¥–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–∏–∑?', async (ok) => {
                             if(ok) {
                                await makeApiRequest('/api/v1/admin/manual_rewards/complete', { reward_id: parseInt(id) });
                                tg.showAlert('–í—ã–¥–∞—á–∞ –ø—Ä–∏–∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.');
                                card?.remove();
                             }
                        });
                    }
                    
                } else if (actionButton.matches('.sort-btn')) {
                    const index = parseInt(actionButton.dataset.index);
                    const direction = actionButton.dataset.direction;
                    const newIndex = direction === 'up' ? index - 1 : index + 1;
                    if (newIndex >= 0 && newIndex < categoriesCache.length) {
                        [categoriesCache[index], categoriesCache[newIndex]] = [categoriesCache[newIndex], categoriesCache[index]];
                        renderCategoriesList();
                        makeApiRequest('/api/v1/admin/categories/reorder', { ordered_ids: categoriesCache.map(c => c.id) }, 'POST', true);
                    }
                    
                } else if (actionButton.matches('.sort-quest-btn')) {
                    const questId = parseInt(actionButton.dataset.questId);
                    const categoryId = actionButton.dataset.categoryId ? parseInt(actionButton.dataset.categoryId) : null;
                    const direction = actionButton.dataset.direction;
                    await makeApiRequest('/api/v1/admin/quests/reorder', { quest_id: questId, category_id: categoryId, direction: direction });
                    await switchView('view-admin-quests');
                }
            });
            
            dom.createQuestForm.querySelector('select[name="quest_type"]').addEventListener('change', () => updateQuestFormUI(dom.createQuestForm));
            dom.editQuestForm.querySelector('select[name="quest_type"]').addEventListener('change', () => updateQuestFormUI(dom.editQuestForm));
            dom.challengeForm.querySelector('select[name="condition_type"]').addEventListener('change', () => updateChallengeFormUI(dom.challengeForm));

            dom.challengeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                let conditionType = form.elements['condition_type'].value;
                if (conditionType === 'twitch_messages' || conditionType === 'twitch_uptime') {
                    conditionType = `${conditionType}_${form.elements['challenge_period'].value}`;
                }
                const data = {
                    description: form.elements['description'].value, condition_type: conditionType,
                    target_value: parseInt(form.elements['target_value'].value), reward_amount: parseInt(form.elements['reward_amount'].value),
                    duration_days: parseInt(form.elements['duration_days'].value), is_active: form.elements['is_active'].value === 'true',
                };
                const challengeId = form.elements['challenge_id'].value;
                if (challengeId) await makeApiRequest('/api/v1/admin/challenges/update', { ...data, challenge_id: parseInt(challengeId) });
                else await makeApiRequest('/api/v1/admin/challenges/create', data);
                await switchView('view-admin-challenges');
            });

            dom.createQuestForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const questData = getQuestFormData(e.target);
                await makeApiRequest('/api/v1/admin/quests', questData);
                await switchView('view-admin-quests');
            });

            dom.editQuestForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const questData = getQuestFormData(form);
                const finalData = { ...questData, quest_id: parseInt(form.elements['quest_id'].value, 10), is_active: form.elements['is_active'].value === 'true' };
                await makeApiRequest('/api/v1/admin/quest/update', finalData);
                await switchView('view-admin-quests');
            });
            
            dom.createCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const categoryName = form.elements['name'].value;
                if (!categoryName) return;
                await makeApiRequest('/api/v1/admin/categories/create', { name: categoryName });
                form.reset();
                tg.showAlert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
                await switchView('view-admin-categories');
            });

            dom.addPromocodesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = Object.fromEntries(new FormData(e.target));
                const body = {
                    codes: formData.codes,
                    reward_value: parseInt(formData.reward_value, 10),
                    description: formData.description
                };
                const result = await makeApiRequest('/api/v1/admin/promocodes', body);
                tg.showAlert(result.message);
                e.target.reset();
            });
            
            dom.grantCheckpointStarsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const userId = parseInt(form.elements['user_id_to_grant_cp'].value);
                const amount = parseInt(form.elements['amount_cp'].value);
                if (!userId || !amount) return;
                
                const result = await makeApiRequest('/api/v1/admin/users/grant-checkpoint-stars', {
                    user_id_to_grant: userId,
                    amount: amount
                });
                tg.showAlert(result.message);
                form.reset();
            });
            
            dom.freezeCheckpointStarsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const userId = parseInt(form.elements['user_id_to_freeze_cp'].value);
                const days = parseInt(form.elements['days_cp'].value);
                if (!userId || isNaN(days)) return;

                const result = await makeApiRequest('/api/v1/admin/users/freeze-checkpoint-stars', {
                    user_id_to_freeze: userId,
                    days: days
                });
                tg.showAlert(result.message);
                form.reset();
            });

            dom.grantTicketsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const userId = parseInt(form.elements['user_id_to_grant_tickets'].value);
                const amount = parseInt(form.elements['amount_tickets'].value);
                if (!userId || !amount) return;
                
                const result = await makeApiRequest('/api/v1/admin/users/grant-stars', {
                    user_id_to_grant: userId,
                    amount: amount
                });
                tg.showAlert(result.message);
                form.reset();
            });
            
            dom.freezeTicketsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const userId = parseInt(form.elements['user_id_to_freeze_tickets'].value);
                const days = parseInt(form.elements['days_tickets'].value);
                if (!userId || isNaN(days)) return;

                const result = await makeApiRequest('/api/v1/admin/users/freeze-stars', {
                    user_id_to_freeze: userId,
                    days: days
                });
                tg.showAlert(result.message);
                form.reset();
            });

            dom.resetCheckpointProgressForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const userId = parseInt(form.elements['user_id_to_reset'].value);
                if (!userId) return;

                tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –¢–û–õ–¨–ö–û –°–ü–ò–°–û–ö –ù–ê–ì–†–ê–î –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}? –ï–≥–æ –∑–≤—ë–∑–¥—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.`, async (ok) => {
                    if (ok) {
                        const result = await makeApiRequest('/api/v1/admin/users/reset-checkpoint-progress', { user_id: userId });
                        tg.showAlert(result.message);
                        form.reset();
                    }
                });
            });

            dom.clearCheckpointStarsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const userId = parseInt(form.elements['user_id_to_clear'].value);
                if (!userId) return;

                tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –û–ë–ù–£–õ–ò–¢–¨ –ë–ê–õ–ê–ù–° –ó–í–Å–ó–î –ß–µ–∫–ø–æ–∏–Ω—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}? –ï–≥–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.`, async (ok) => {
                    if (ok) {
                        const result = await makeApiRequest('/api/v1/admin/users/clear-checkpoint-stars', { user_id: userId });
                        tg.showAlert(result.message);
                        form.reset();
                    }
                });
            });
          
            dom.modalCloseBtn.addEventListener('click', () => dom.submissionsModal.classList.add('hidden'));
            dom.submissionsModal.addEventListener('click', (e) => { if (e.target === dom.submissionsModal) dom.submissionsModal.classList.add('hidden'); });

            dom.genericPromptCancel.addEventListener('click', hideGenericPrompt);
            dom.genericPromptOverlay.addEventListener('click', (e) => { if (e.target === dom.genericPromptOverlay) hideGenericPrompt(); });
            dom.genericPromptConfirm.addEventListener('click', async () => {
                const newName = dom.genericPromptInput.value.trim();
                if (!newName || !currentEditingCategoryId) return;
                await makeApiRequest('/api/v1/admin/categories/update', {
                    category_id: parseInt(currentEditingCategoryId),
                    name: newName
                });
                hideGenericPrompt();
                await switchView('view-admin-categories');
            });
        }

        async function main() {
            try {
                tg.expand();
                if (!tg.initData) throw new Error("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram.");
                
                showLoader();
                const [userData, sleepStatus] = await Promise.all([
                    makeApiRequest("/api/v1/user/me", {}, 'POST', true),
                    makeApiRequest("/api/v1/admin/sleep_mode_status", {}, 'POST', true)
                ]);
                
                if (!userData.is_admin) throw new Error("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.");
                
                document.body.dataset.isAdmin = 'true';
                updateSleepButton(sleepStatus);

                await switchView('view-admin-main');
            } catch (e) {
                document.body.dataset.isAdmin = 'false';
                dom.sleepModeToggle.classList.add('hidden');
                dom.appContainer.innerHTML = `<div style="padding:20px; text-align:center;"><h1>${e.message}</h1><p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p></div>`;
            } finally {
                hideLoader();
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            tg.ready();
            setupEventListeners();
            main();
        });
    } catch (e) {
        console.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ: ${e.message}`);
        alert(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}`);
    }
    </script>
</body>
</html>
