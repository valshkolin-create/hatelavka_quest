<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ì—Ä–∏–Ω–¥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <style>
    /* --- –í–°–¢–ê–í–ö–ê –°–¢–ò–õ–ï–ô –ò–ó AUCTION.CSS --- */
    :root {
      --background-main: #111111;
      --surface-primary: #1C1C1C;
      --surface-secondary: #2C2C2C;
      --border-color: #333333;
      --text-primary: #f0f0f5;
      --text-secondary: #AAAAAA;
      --accent-primary: #FFD700; /* –ó–æ–ª–æ—Ç–æ */
      --accent-secondary: #FF9500; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
      --danger-color: #ff4d4d;
      --success-color: #34c759;
      --card-bg-glass: rgba(28, 28, 28, 0.75);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-main);
      color: var(--text-primary);
      margin: 0;
      padding: 10px 10px 80px;
      overflow-x: hidden;
      background-image: url('https://i.postimg.cc/Dyks29xc/fon-variant1.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* –•–ï–î–ï–† */
    .new-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 20px; 
        padding: 5px 0;
    }

    .header-back-button {
        display: flex; align-items: center; gap: 6px;
        color: var(--text-secondary); text-decoration: none;
        font-size: 12px; font-weight: 600; position: relative; z-index: 2;
        transition: color 0.2s ease;
    }
    .header-back-button:hover { color: var(--text-primary); }

    .page-header {
        position: absolute; left: 0; right: 0; top: 50%;
        transform: translateY(-50%); text-align: center; z-index: 1;
    }
    .page-title {
        font-size: 18px; font-weight: 700; margin: 0;
        color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px;
    }

    /* --- –ö–ê–†–¢–û–ß–ö–ò (–°—Ç–∏–ª—å Auction) --- */
    .glass-card {
        background-color: var(--card-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
    }

    /* –ë–ê–õ–ê–ù–°–´ */
    .balance-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .balance-item {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .balance-label {
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .balance-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .coin-icon { color: var(--accent-primary); text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
    .ticket-icon { color: #00f2ea; text-shadow: 0 0 10px rgba(0, 242, 234, 0.4); }

    /* –ü–†–û–ì–†–ï–°–° –ì–†–ò–ù–î–ê */
    .section-title {
        font-size: 13px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
    }
    .section-title i { color: var(--accent-secondary); }

    .streak-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin: 20px 5px 25px;
    }

    .streak-line-bg {
        position: absolute;
        top: 50%; left: 0; right: 0;
        height: 2px;
        background: var(--border-color);
        transform: translateY(-50%);
        z-index: 0;
    }

    .streak-line-fill {
        position: absolute;
        top: 50%; left: 0;
        height: 2px;
        background: var(--accent-primary);
        transform: translateY(-50%);
        z-index: 1;
        width: 0%;
        transition: width 0.5s ease;
        box-shadow: 0 0 10px var(--accent-primary);
    }

    .streak-step {
        width: 24px; height: 24px;
        background: var(--surface-primary);
        border: 1px solid var(--border-color);
        border-radius: 50%;
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 9px;
        color: var(--text-secondary);
        font-weight: 700;
        transition: all 0.3s ease;
    }

    .streak-step.active {
        border-color: var(--accent-primary);
        background: var(--background-main);
        color: var(--text-primary);
        transform: scale(1.2);
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .streak-step.completed {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: #000;
    }

    .grind-info {
        text-align: center;
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        background: rgba(0,0,0,0.2);
        padding: 8px;
        border-radius: 6px;
    }
    .grind-info span { color: var(--accent-primary); font-weight: 700; }

    /* –ö–ù–û–ü–ö–ê –ì–†–ò–ù–î–ê */
    .main-action-btn {
        width: 100%;
        padding: 12px;
        background-color: var(--accent-primary);
        color: #000;
        font-size: 13px;
        font-weight: 700;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: transform 0.1s;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        position: relative;
        overflow: hidden;
    }
    .main-action-btn:active { transform: scale(0.98); }
    .main-action-btn:disabled {
        background-color: var(--surface-secondary);
        color: var(--text-secondary);
        cursor: not-allowed;
        box-shadow: none;
    }
    
    /* –û–ë–ú–ï–ù–ù–ò–ö */
    .exchange-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .exchange-item {
        background-color: rgba(0,0,0,0.2);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .exchange-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .exchange-title {
        font-size: 12px;
        color: var(--text-primary);
        font-weight: 600;
    }
    .exchange-cost {
        font-size: 10px;
        color: var(--accent-primary);
    }
    
    .mini-btn {
        background: transparent;
        border: 1px solid var(--accent-primary);
        color: var(--accent-primary);
        padding: 6px 12px;
        font-size: 10px;
        font-weight: 600;
        border-radius: 4px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
    }
    .mini-btn:hover {
        background: var(--accent-primary);
        color: #000;
    }
    .mini-btn:disabled {
        border-color: var(--border-color);
        color: var(--text-secondary);
        pointer-events: none;
    }

    /* –ë–ï–°–ü–õ–ê–¢–ù–´–ô –ë–ò–õ–ï–¢ */
    .free-ticket-section {
        border: 1px dashed var(--text-secondary);
        padding: 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        background: rgba(255,255,255,0.02);
    }
    .free-ticket-text { font-size: 11px; color: var(--text-secondary); }
    .free-ticket-title { font-size: 12px; font-weight: 700; color: #fff; display: block; margin-bottom: 2px; }

    /* –§–£–¢–ï–† */
    .app-footer {
        display: flex;
        justify-content: space-around;
        background-color: rgba(17, 17, 17, 0.9);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-top: 1px solid var(--border-color);
        width: 100%;
        padding-top: 6px;
        padding-bottom: calc(6px + env(safe-area-inset-bottom));
        position: fixed;
        bottom: 0;
        left: 0;
        z-index: 100;
    }

    .footer-item {
        display: flex; flex-direction: column; align-items: center; gap: 2px;
        color: var(--text-secondary); font-size: 10px; text-decoration: none; flex: 1;
    }
    .footer-item .icon-wrapper {
        font-size: 22px; width: 28px; height: 28px;
        display: flex; justify-content: center; align-items: center;
    }
    .footer-item.active span, .footer-item.active .icon-wrapper {
        color: var(--accent-primary); font-weight: 600;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –±–ª–µ—Å–∫–∞ –∫–Ω–æ–ø–∫–∏ */
    .shine {
        position: absolute; top: 0; left: -100%;
        width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 3s infinite;
    }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–ª–µ—Ç–∞—é—â–µ–π —Ü–∏—Ñ—Ä—ã */
    .float-anim {
        animation: floatUp 1s ease-out forwards;
        position: absolute; font-weight: 800; font-size: 16px; pointer-events: none; z-index: 100;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

  </style>
</head>
<body>

  <div class="new-header-container">
    <a href="/menu" class="header-back-button">
        <i class="fa-solid fa-chevron-left"></i> –ù–∞–∑–∞–¥
    </a>
    <div class="page-header">
        <h1 class="page-title">–°—Ç–∞–Ω—Ü–∏—è –ì—Ä–∏–Ω–¥–∞</h1>
    </div>
    <div style="width: 40px;"></div> </div>

  <div class="balance-grid">
    <div class="balance-item">
        <span class="balance-label">–ú–æ–Ω–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-coins">0.0</span> <i class="fa-solid fa-coins coin-icon"></i>
        </div>
    </div>
    <div class="balance-item">
        <span class="balance-label">–ë–∏–ª–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-tickets">0</span> <i class="fa-solid fa-ticket ticket-icon"></i>
        </div>
    </div>
  </div>

  <div class="glass-card">
    <div class="section-title"><i class="fa-solid fa-fire"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –°–µ—Ä–∏—è</div>
    
    <div class="streak-wrapper">
        <div class="streak-line-bg"></div>
        <div class="streak-line-fill" id="streak-bar"></div>
        <div id="streak-steps" style="display: flex; justify-content: space-between; width: 100%; position: relative;">
            </div>
    </div>

    <div class="grind-info">
        –î–µ–Ω—å —Å–µ—Ä–∏–∏: <span id="current-streak-day">1</span> / 10 <br>
        –ù–∞–≥—Ä–∞–¥–∞ —Å–µ–≥–æ–¥–Ω—è: <span id="today-reward">+0.1</span> –º–æ–Ω–µ—Ç
    </div>

    <button id="grind-btn" class="main-action-btn">
        <span id="grind-btn-text">–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°</span>
        <div class="shine"></div>
    </button>
  </div>

  <div class="glass-card">
    <div class="section-title"><i class="fa-solid fa-shop"></i> –û–±–º–µ–Ω–Ω–∏–∫</div>
    
    <div class="exchange-grid" id="exchange-grid">
        <div class="exchange-item">
            <div class="exchange-details">
                <div class="exchange-title">–û–±–º–µ–Ω—è—Ç—å –Ω–∞ –ë–∏–ª–µ—Ç</div>
                <div class="exchange-cost">–¶–µ–Ω–∞: 4.0 –ú–æ–Ω–µ—Ç</div>
            </div>
            <button class="mini-btn" onclick="exchangeCoins(4, 1)">–ö—É–ø–∏—Ç—å</button>
        </div>

        <div class="exchange-item">
            <div class="exchange-details">
                <div class="exchange-title">–ü–∞–∫–µ—Ç –ë–∏–ª–µ—Ç–æ–≤ (10 —à—Ç)</div>
                <div class="exchange-cost">–¶–µ–Ω–∞: 40.0 –ú–æ–Ω–µ—Ç</div>
            </div>
            <button class="mini-btn" onclick="exchangeCoins(40, 10)">–ö—É–ø–∏—Ç—å</button>
        </div>
        
        </div>
  </div>

  <div class="free-ticket-section">
    <div>
        <span class="free-ticket-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–∏–ª–µ—Ç</span>
        <span class="free-ticket-text">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ 24—á</span>
    </div>
    <div id="free-ticket-container">
        </div>
  </div>

  <footer class="app-footer">
    <a href="/menu" class="footer-item">
      <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/events" class="footer-item active">
      <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
      <span>–ì—Ä–∏–Ω–¥</span>
    </a>
    <a href="/profile" class="footer-item">
      <div class="icon-wrapper"><i class="fa-solid fa-user"></i></div>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    // tg.setHeaderColor('#111111'); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–∞ —Ö–µ–¥–µ—Ä–∞ –ø–æ–¥ —Ñ–æ–Ω

    let userState = {
        coins: 0.0,
        tickets: 0,
        streakDays: 1,
        lastGrindTime: null, 
        lastFreeTicket: null 
    };

    const MAX_STREAK = 10;
    const GRIND_COOLDOWN = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞

    const dom = {
        coinsDisplay: document.getElementById('user-coins'),
        ticketsDisplay: document.getElementById('user-tickets'),
        streakBar: document.getElementById('streak-bar'),
        streakSteps: document.getElementById('streak-steps'),
        streakDayDisplay: document.getElementById('current-streak-day'),
        todayRewardDisplay: document.getElementById('today-reward'),
        grindBtn: document.getElementById('grind-btn'),
        grindBtnText: document.getElementById('grind-btn-text'),
        freeTicketContainer: document.getElementById('free-ticket-container'),
        exchangeGrid: document.getElementById('exchange-grid')
    };

    async function init() {
        try {
            // –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
            const response = await fetch('/api/v1/user/me', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (response.ok) {
                const data = await response.json();
                userState.tickets = data.tickets || 0;
                userState.coins = parseFloat(data.coins || 0);
                userState.streakDays = data.streak_days || 1;
                userState.lastGrindTime = data.last_grind_at;
                userState.lastFreeTicket = data.last_free_ticket_claimed_at;
                
                updateUI();
                renderStreakVisuals();
                renderShop(); // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
                startTimers();
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
        }
    }

    // --- UI –ò –ì–†–ò–ù–î ---

    function updateUI() {
        dom.coinsDisplay.textContent = userState.coins.toFixed(1);
        dom.ticketsDisplay.textContent = userState.tickets;
        dom.streakDayDisplay.textContent = userState.streakDays;
        
        // –†–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã
        let reward = (userState.streakDays * 0.1).toFixed(1);
        if (parseFloat(reward) > 1.0) reward = "1.0";
        dom.todayRewardDisplay.textContent = `+${reward}`;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≥—Ä–∏–Ω–¥–∞
        const now = new Date().getTime();
        const last = userState.lastGrindTime ? new Date(userState.lastGrindTime).getTime() : 0;
        const diff = now - last;

        if (diff < GRIND_COOLDOWN) {
            dom.grindBtn.disabled = true;
            const remaining = GRIND_COOLDOWN - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.grindBtnText.textContent = `–î–û–°–¢–£–ü–ù–û –ß–ï–†–ï–ó ${h}—á ${m}–º`;
        } else {
            dom.grindBtn.disabled = false;
            dom.grindBtnText.textContent = "–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°";
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
        document.querySelectorAll('.mini-btn').forEach(btn => {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å onclick="buyItem...", –∏—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç renderShop
            if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes('exchangeCoins')) {
                const cost = parseInt(btn.getAttribute('onclick').match(/\d+/)[0]);
                btn.disabled = userState.coins < cost;
                btn.style.opacity = userState.coins < cost ? '0.5' : '1';
            }
        });
    }

    function renderStreakVisuals() {
        dom.streakSteps.innerHTML = '';
        // 5 —Ç–æ—á–µ–∫ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (1, 3, 5, 7, 10)
        let percent = ((userState.streakDays - 1) / (MAX_STREAK - 1)) * 100;
        if (percent > 100) percent = 100;
        dom.streakBar.style.width = `${percent}%`;

        for (let i = 1; i <= 5; i++) {
            const step = document.createElement('div');
            step.className = 'streak-step';
            
            let dayValue = 1;
            if (i === 2) dayValue = 3;
            if (i === 3) dayValue = 5;
            if (i === 4) dayValue = 7;
            if (i === 5) dayValue = 10;

            step.textContent = dayValue;

            if (userState.streakDays >= dayValue) {
                step.classList.add('completed');
                step.innerHTML = '<i class="fa-solid fa-check"></i>';
            } else if (userState.streakDays === dayValue - 1 || (i===1 && userState.streakDays===1)) {
               // –ê–∫—Ç–∏–≤–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª—å active, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            }

            dom.streakSteps.appendChild(step);
        }
    }

    // --- –î–ï–ô–°–¢–í–ò–Ø ---

    // 1. –°–ë–û–† –ú–û–ù–ï–¢
    dom.grindBtn.addEventListener('click', async () => {
        if (dom.grindBtn.disabled) return;
        
        tg.HapticFeedback.impactOccurred('medium');
        dom.grindBtn.disabled = true; // –ê–Ω—Ç–∏-–∫–ª–∏–∫

        try {
            const response = await fetch('/api/v1/user/grind/claim', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || "–û—à–∏–±–∫–∞");
            }

            const res = await response.json();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è
            showFloatText(dom.grindBtn, `+${res.reward_claimed}`, 'var(--accent-primary)');

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            userState.coins = parseFloat(res.new_coins);
            userState.streakDays = res.streak_days;
            userState.lastGrindTime = res.last_grind_at;

            updateUI();
            renderStreakVisuals();

        } catch (e) {
            tg.showAlert(e.message);
            dom.grindBtn.disabled = false;
        }
    });

    // 2. –û–ë–ú–ï–ù –ú–û–ù–ï–¢ –ù–ê –ë–ò–õ–ï–¢–´
    window.exchangeCoins = async (cost, rewardTickets) => {
        if (userState.coins < cost) {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        tg.showConfirm(`–û–±–º–µ–Ω—è—Ç—å ${cost} –º–æ–Ω–µ—Ç –Ω–∞ ${rewardTickets} –±–∏–ª–µ—Ç(–æ–≤)?`, async (ok) => {
            if (ok) {
                try {
                    const response = await fetch('/api/v1/user/grind/exchange', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            initData: tg.initData,
                            cost: cost,
                            tickets_reward: rewardTickets
                        })
                    });

                    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞");
                    const res = await response.json();

                    userState.coins = parseFloat(res.new_coins);
                    userState.tickets = res.new_tickets;
                    
                    updateUI();
                    renderShop(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert('–£—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω!');

                } catch (e) {
                    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–º–µ–Ω.');
                }
            }
        });
    };

    // 3. –ü–û–ö–£–ü–ö–ê –ü–†–û–ú–û–ö–û–î–ê (–î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø)
    window.buyItem = async (rewardValue) => {
        const cost = rewardValue;

        tg.showConfirm(`–ö—É–ø–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${rewardValue} –∑–≤—ë–∑–¥ –∑–∞ ${cost} –º–æ–Ω–µ—Ç?`, async (ok) => {
            if (ok) {
                if(typeof tg.MainButton.showProgress === 'function') tg.MainButton.showProgress();
                try {
                    const response = await fetch('/api/v1/user/grind/buy_item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            initData: tg.initData,
                            reward_value: rewardValue 
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                    }

                    const res = await response.json();
                    userState.coins = parseFloat(res.new_coins);
                    updateUI();
                    renderShop(); // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω (–∫–æ–ª-–≤–æ —Ç–æ–≤–∞—Ä–æ–≤)
                    
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showPopup({
                        title: 'üéâ –£—Å–ø–µ—à–Ω–æ!',
                        message: `–í–∞—à –∫–æ–¥:\n\n${res.promo_code}\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ.`,
                        buttons: [{type: 'ok'}]
                    });

                } catch (e) {
                    tg.showAlert(e.message);
                    tg.HapticFeedback.notificationOccurred('error');
                } finally {
                    if(typeof tg.MainButton.hideProgress === 'function') tg.MainButton.hideProgress();
                }
            }
        });
    };

    // 4. –û–¢–†–ò–°–û–í–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê (–ü–†–û–ú–û–ö–û–î–´)
    async function renderShop() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ–º–æ-–∫–∞—Ä—Ç–æ—á–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 2 —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–º–µ–Ω–∞)
        // –ù–æ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤–µ—Å—å –≥—Ä–∏–¥ –∏–ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–æ–Ω–µ—Ü
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: —É–¥–∞–ª—è–µ–º –≤—Å–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–æ–º dynamic-promo
        document.querySelectorAll('.dynamic-promo').forEach(e => e.remove());

        try {
            const response = await fetch('/api/v1/user/grind/shop');
            const items = await response.json();

            if (items && items.length > 0) {
                items.forEach(item => {
                    const cost = item.reward_value;
                    const div = document.createElement('div');
                    div.className = 'exchange-item dynamic-promo';
                    div.style.borderColor = 'var(--accent-primary)'; // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–æ–ª–æ—Ç–æ–º
                    
                    const isAffordable = userState.coins >= cost;

                    div.innerHTML = `
                        <div class="exchange-details">
                            <div class="exchange-title" style="color:var(--accent-primary)">
                                –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${item.reward_value} –∑–≤—ë–∑–¥
                            </div>
                            <div class="exchange-cost" style="color:#fff">
                                –¶–µ–Ω–∞: ${cost} –ú–æ–Ω–µ—Ç <span style="opacity:0.5; font-size:9px;">(–û—Å—Ç: ${item.quantity})</span>
                            </div>
                        </div>
                        <button class="mini-btn" 
                                onclick="buyItem(${item.reward_value})" 
                                ${isAffordable ? '' : 'disabled'} 
                                style="${isAffordable ? 'background:var(--accent-primary); color:#000;' : ''}">
                            ${isAffordable ? '–ö—É–ø–∏—Ç—å' : '–ú–∞–ª–æ –º–æ–Ω–µ—Ç'}
                        </button>
                    `;
                    dom.exchangeGrid.appendChild(div);
                });
            }
        } catch (e) {
            console.warn("Shop load error", e);
        }
    }

    // 5. –ë–ï–°–ü–õ–ê–¢–ù–´–ô –ë–ò–õ–ï–¢ (LEGACY)
    function renderFreeTicketBtn() {
        const lastClaim = userState.lastFreeTicket ? new Date(userState.lastFreeTicket).getTime() : 0;
        const now = new Date().getTime();
        const diff = now - lastClaim;
        const cooldown = 24 * 60 * 60 * 1000;

        if (diff > cooldown) {
            dom.freeTicketContainer.innerHTML = `<button class="mini-btn" style="border-color:#fff; color:#fff;" onclick="claimFreeTicket()">–ü–û–õ–£–ß–ò–¢–¨</button>`;
        } else {
            const remaining = cooldown - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.freeTicketContainer.innerHTML = `<span style="font-size:11px; color:#555;">${h}—á ${m}–º</span>`;
        }
    }

    window.claimFreeTicket = async () => {
        try {
            const response = await fetch('/api/v1/user/claim-free-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });
            
            if (response.ok) {
                const res = await response.json();
                userState.tickets = res.new_ticket_balance;
                userState.lastFreeTicket = new Date().toISOString();
                tg.showAlert('–ë–∏–ª–µ—Ç –ø–æ–ª—É—á–µ–Ω!');
                updateUI();
                renderFreeTicketBtn();
            } else {
                throw new Error();
            }
        } catch (e) {
            tg.showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–∞');
        }
    };

    // –£–¢–ò–õ–ò–¢–´
    function startTimers() {
        setInterval(() => {
            updateUI(); 
            renderFreeTicketBtn(); 
        }, 60000); 
        renderFreeTicketBtn();
    }

    function showFloatText(element, text, color) {
        const rect = element.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.textContent = text;
        floatEl.className = 'float-anim';
        floatEl.style.color = color;
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–Ω–æ–ø–∫–∏
        floatEl.style.left = (rect.left + rect.width / 2 - 20) + 'px'; 
        floatEl.style.top = (rect.top) + 'px';
        document.body.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 1000);
    }

    init();
});
</script>
</body>
</html>
