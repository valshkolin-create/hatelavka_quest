<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Cauldron Overlay</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ================= ТЕМЫ И ПЕРЕМЕННЫЕ ================= */
        :root {
            /* --- HALLOWEEN (DEFAULT) --- */
            --bg-gradient: linear-gradient(45deg, #1a0229, #3d1902);
            --border-color: #ff9500;
            --accent-color-1: #bf5af2;
            --accent-color-2: #ff9500;
            --text-color: #ffffff;
            --glow-color: rgba(255, 149, 0, 0.7);
            --font-shadow: 0 0 15px var(--glow-color);
        }

        /* --- NEW YEAR THEME --- */
        body[data-theme="new_year"] {
            --bg-gradient: linear-gradient(135deg, rgba(30, 60, 90, 0.9), rgba(20, 40, 60, 0.95));
            --border-color: #b3e5fc;       /* Ледяной голубой */
            --accent-color-1: #ffca28;     /* Золото */
            --accent-color-2: #4fc3f7;     /* Яркий голубой */
            --text-color: #ffffff;
            --glow-color: rgba(179, 229, 252, 0.6);
            --font-shadow: 0 0 15px rgba(179, 229, 252, 0.8);
        }

        body {
            background-color: transparent;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            margin: 0;
            /* Плавный переход цветов при смене темы */
            transition: --bg-gradient 0.5s, --border-color 0.5s; 
        }

        #overlay-container {
            position: absolute;
            bottom: 10px;
            left: 40px;
            width: 450px;
            animation: fadeIn 1s ease-out;
        }

        #widget-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #promo-group {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 4;
            pointer-events: none;
        }

        /* АНИМАЦИЯ ПЕРСОНАЖА (ПРИВИДЕНИЕ) */
        #ghost-animation {
            position: absolute;
            bottom: 75px;
            left: 0;
            width: 40px;
            height: auto;
            z-index: 3;
            animation: ghost-walk 20s linear infinite;
            transition: filter 0.5s ease-out, transform 0.5s ease-out, opacity 0.5s;
        }
        
        /* Скрываем привидение в новогодней теме (или можно заменить картинку в JS) */
        body[data-theme="new_year"] #ghost-animation {
            display: none; 
        }

        #prize-image-container {
            width: 160px; height: 110px;
            background: var(--bg-gradient);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 0 20px var(--glow-color);
            opacity: 0;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 15px;
        }
        #prize-image-container.animate { animation: prize-image-animation 30s forwards; }
        
        #prize-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
        }

        #promo-text {
            padding: 10px 20px;
            background: var(--bg-gradient);
            border: 2px solid var(--border-color);
            color: var(--text-color); 
            border-radius: 12px;
            font-size: 18px; font-weight: 800;
            text-align: center;
            box-shadow: 0 5px 30px rgba(0,0,0,0.7);
            opacity: 0;
        }
        #promo-text.animate { animation: promo-text-animation 30s forwards; }
        
        .subtitle { display: block; font-size: 13px; font-weight: 600; color: #ddd; margin-top: 4px; }
        .prize-name { color: var(--accent-color-1); text-transform: uppercase; }

        #cauldron-image {
            width: 210px;
            height: auto;
            animation: float 4s ease-in-out infinite;
            margin-bottom: -30px;
            z-index: 2;
            transition: filter 0.5s ease-out, transform 0.5s ease-out;
        }
        #cauldron-image.pulse { animation: float 4s ease-in-out infinite, cauldron-pulse 0.7s ease-out; }
        
        #info-widget {
            width: 100%;
            background: var(--bg-gradient);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 40px 20px 15px 20px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.7);
            color: var(--text-color); 
            transition: filter 0.5s ease-out, transform 0.5s ease-out;
            backdrop-filter: blur(5px);
        }

        /* Специфичный стиль для НГ - убираем рамки, добавляем стекло */
        body[data-theme="new_year"] #info-widget,
        body[data-theme="new_year"] #promo-text,
        body[data-theme="new_year"] #prize-image-container {
            border: 1px solid rgba(255,255,255,0.3);
            background: linear-gradient(135deg, rgba(30, 60, 90, 0.8), rgba(20, 40, 60, 0.9));
        }

        .blur-effect {
            filter: blur(4px) brightness(0.7);
            transform: scale(0.98);
        }

        #event-title { 
            margin: 0 0 10px 0; 
            font-size: 18px; 
            text-align: center; 
            font-weight: 700; 
            color: var(--accent-color-2); 
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        #progress-text { 
            font-size: 12px; 
            font-weight: 700; 
            text-align: center; 
            color: white; 
            margin-bottom: 5px; 
        }

        .progress-bar-container { width: 100%; background-color: rgba(0,0,0,0.4); border-radius: 8px; height: 8px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        #progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border-radius: 8px; transition: width 0.5s ease-out; box-shadow: 0 0 10px var(--glow-color); }
        
        #flying-flask { position: fixed; width: 60px; height: auto; z-index: 10; pointer-events: none; opacity: 0; top: 20%; left: -100px; }
        #flying-flask.animate { animation: fly-in 1.2s cubic-bezier(0.5, -0.5, 1, 1); }

        #contributor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            pointer-events: none;
            z-index: 5;
            text-align: center;
            padding-top: 95px;
        }
        #contributor-overlay.show {
            opacity: 1;
        }
        #contributor-name {
            font-size: 48px;
            font-weight: 800;
            color: #fff;
            text-shadow: var(--font-shadow), 0 2px 5px #000;
        }
        #contributor-name span {
            display: block;
            font-size: 24px;
            color: var(--accent-color-1);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes cauldron-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); filter: brightness(1.7) drop-shadow(0 0 25px var(--glow-color)); } }
        
        @keyframes fly-in { 
            0% { 
                opacity: 1; 
                transform: translate(150px, 200px) scale(1.5) rotate(0deg);
            } 
            100% { 
                opacity: 0; 
                transform: translate(250px, 350px) scale(0.2) rotate(720deg);
            } 
        }
        
        @keyframes promo-text-animation {
            0%   { opacity: 0; transform: translateY(20px); }
            3%   { opacity: 1; transform: translateY(0); }
            97%  { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        @keyframes prize-image-animation {
            0%   { opacity: 0; transform: translateY(10px) scale(0.95); }
            3%   { opacity: 1; transform: translateY(0) scale(1); }
            97%  { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-10px) scale(0.95); }
        }
        @keyframes ghost-walk {
            0% { transform: translateX(0px) scaleX(1); }
            45% { transform: translateX(410px) scaleX(1); }
            50% { transform: translateX(410px) scaleX(-1); }
            95% { transform: translateX(0px) scaleX(-1); }
            100% { transform: translateX(0px) scaleX(1); }
        }
    </style>
</head>
<body>

    <div id="promo-group">
        <div id="prize-image-container">
            <img id="prize-image" src="" alt="Prize Image">
        </div>
        <div id="promo-text"></div>
    </div>

    <div id="overlay-container">
        <img id="flying-flask" src="https://i.postimg.cc/XYxLQYTF/giphy-flusk.gif" alt="Animating flask">
        
        <div id="widget-container">
            <div id="contributor-overlay">
                <div id="contributor-name"></div>
            </div>
            
            <img id="ghost-animation" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExdDd2azc1aXVvcmE3eG81a3FxZDlya2M4c3NmNDZweHFnOW8za3d2eiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/GqegZvkq9kgxuk1kTC/giphy.gif" alt="Ghost">
            
            <img id="cauldron-image" src="" alt="Cauldron">
            <div id="info-widget">
                <h1 id="event-title">...</h1>
                <div id="progress-text">0 / 0</div>
                <div class="progress-bar-container">
                    <div id="progress-bar-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pyeuckjcrsiaseyqrsek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZXVja2pjcnNpYXNleXFyc2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzEyOTgsImV4cCI6MjA3MDA0NzI5OH0.srRwuUygiF7jr3-b2AwyRNAmrChlW3Bzp3I-9Ju2TVg';

        const dom = {
            title: document.getElementById('event-title'),
            progressBar: document.getElementById('progress-bar-fill'),
            progressText: document.getElementById('progress-text'),
            cauldronImage: document.getElementById('cauldron-image'),
            infoWidget: document.getElementById('info-widget'),
            ghostAnimation: document.getElementById('ghost-animation'),
            flyingFlask: document.getElementById('flying-flask'),
            promoText: document.getElementById('promo-text'),
            prizeImageContainer: document.getElementById('prize-image-container'),
            prizeImage: document.getElementById('prize-image'),
            contributorOverlay: document.getElementById('contributor-overlay'),
            contributorName: document.getElementById('contributor-name')
        };

        // Ассеты для разных тем
        const THEME_ASSETS = {
            halloween: {
                projectile: 'https://i.postimg.cc/XYxLQYTF/giphy-flusk.gif', // Колба
                fallbackCauldron: 'https://i.postimg.cc/d1G5DRk1/magic-pot.png'
            },
            new_year: {
                projectile: 'https://img.icons8.com/?size=100&id=wuSvVpkmKrXV&format=png', // Подарок/Коробка
                fallbackCauldron: 'https://i.postimg.cc/d1G5DRk1/magic-pot.png' // Сюда можно поставить картинку мешка, если есть URL
            },
            classic: {
                projectile: 'https://i.postimg.cc/XYxLQYTF/giphy-flusk.gif',
                fallbackCauldron: 'https://i.postimg.cc/d1G5DRk1/magic-pot.png'
            }
        };

        let isAnimating = false;
        let currentEventData = {};
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function getCurrentLevel(eventData) {
            const { goals = {}, current_progress = 0 } = eventData;
            if (goals.level_2 && current_progress >= goals.level_2) return 3;
            if (goals.level_1 && current_progress >= goals.level_1) return 2;
            return 1;
        }
        
        function updateDisplay(eventData) {
            if (!eventData) return;
            currentEventData = eventData;
            
            // 1. СИНХРОНИЗАЦИЯ ТЕМЫ
            const activeTheme = eventData.current_theme || 'halloween';
            document.body.dataset.theme = activeTheme;

            // 2. Обновление заголовка и котла
            const currentLevel = getCurrentLevel(eventData);
            dom.title.textContent = eventData.title || (activeTheme === 'new_year' ? "МЕШОК ЧУДЕС" : "Ведьминский Котел");

            const assets = THEME_ASSETS[activeTheme] || THEME_ASSETS.halloween;
            
            // Если в БД задана картинка - используем её, иначе фоллбек
            const cauldronUrl = eventData[`cauldron_image_url_${currentLevel}`] || eventData.cauldron_image_url || assets.fallbackCauldron;
            
            if (dom.cauldronImage.src !== cauldronUrl) dom.cauldronImage.src = cauldronUrl;

            // 3. Обновление прогресса
            const { goals = {}, current_progress = 0 } = eventData;
            let currentGoal = 1;
            if (currentLevel === 1) { currentGoal = goals.level_1 || 1; }
            else if (currentLevel === 2) { currentGoal = goals.level_2 || goals.level_1; }
            else if (currentLevel === 3) { currentGoal = goals.level_3 || goals.level_2; }
            
            const percentage = (currentGoal > 0) ? Math.min((current_progress / currentGoal) * 100, 100) : 0;
            
            dom.progressBar.style.width = `${percentage}%`;
            dom.progressText.textContent = `${current_progress} / ${currentGoal}`;
        }
        
        function triggerAnimation(payload) {
            if (isAnimating) return;
            isAnimating = true;
            const { event_data, last_contributor } = payload.new.payload;
            
            updateDisplay(event_data);
            
            // Определяем тему для выбора летящего предмета
            const activeTheme = event_data.current_theme || 'halloween';
            const assets = THEME_ASSETS[activeTheme] || THEME_ASSETS.halloween;
            
            // Меняем картинку летящего предмета
            dom.flyingFlask.src = assets.projectile;
            
            // Показываем ник донатера
            if (last_contributor && last_contributor.name) {
                dom.contributorName.innerHTML = `${last_contributor.name} <span>+${last_contributor.amount}</span>`;
                dom.contributorOverlay.classList.add('show');
                dom.infoWidget.classList.add('blur-effect');
                dom.ghostAnimation.classList.add('blur-effect');
            }
            
            // Запуск CSS анимаций
            dom.flyingFlask.classList.add('animate');
            dom.cauldronImage.classList.add('pulse');

            setTimeout(() => {
                if (last_contributor && last_contributor.name) {
                    dom.contributorOverlay.classList.remove('show');
                    dom.infoWidget.classList.remove('blur-effect');
                    dom.ghostAnimation.classList.remove('blur-effect');
                }
                
                dom.flyingFlask.classList.remove('animate');
                dom.cauldronImage.classList.remove('pulse');

                isAnimating = false;
            }, 4500);
        }

        async function loadInitialState() {
            const { data, error } = await supabaseClient.from('pages_content').select('content').eq('page_name', 'cauldron_event').single();
            if (error) { console.error('Error loading initial state:', error); return; }
            if (data && data.content) updateDisplay(data.content);
        }
        
        function showPromoAnimation() {
            if (!currentEventData.levels) return;

            const currentLevel = getCurrentLevel(currentEventData);
            const levelConfig = currentEventData.levels[`level_${currentLevel}`] || {};
            const prizes = levelConfig.top_places || [];

            let prizeName = '', prizeImageUrl = '';
            if (prizes.length > 0) {
                const randomPrize = prizes[Math.floor(Math.random() * prizes.length)];
                prizeName = randomPrize.name;
                prizeImageUrl = randomPrize.image_url;
            }

            dom.promoText.innerHTML = `
                Участвуй в ивенте: <span>!lavka</span>
                <div class="subtitle">Попробуй выиграть: <span class="prize-name">${prizeName || 'Главный приз!'}</span></div>
            `;
            
            if (prizeImageUrl) {
                dom.prizeImage.src = prizeImageUrl;
            }
            
            dom.promoText.classList.add('animate');
            dom.prizeImageContainer.classList.add('animate');

            setTimeout(() => {
                dom.promoText.classList.remove('animate');
                dom.prizeImageContainer.classList.remove('animate');
            }, 30000); 
        }

        try {
            supabaseClient.channel('cauldron-triggers-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'cauldron_triggers' },
                    payload => triggerAnimation(payload)
                ).subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        loadInitialState();
                    }
                });
        } catch (error) { console.error("Failed to connect to Supabase:", error); }

        setInterval(showPromoAnimation, 182000);
        
    </script>
</body>
</html>
