<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Telegram –í—ã–∑–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <link rel="stylesheet" href="/quests.css?v=2" />

  <style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞, 
       –Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ —Ç–≤–æ–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ quest.css */

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞, —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ quest-card */
    .slider-card-content {
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    /* –û–≥—Ä–æ–º–Ω–∞—è —Ü–∏—Ñ—Ä–∞ */
    .count-display {
        font-size: 64px;
        font-weight: 900;
        color: var(--telegram-color, #0088CC); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ quest.css */
        text-shadow: 0 0 30px rgba(0, 136, 204, 0.3);
        line-height: 1;
        margin-top: 10px;
    }
    
    .slider-label {
        font-size: 13px;
        color: var(--text-color-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π Input Range, –≤–ø–∏—Å–∞–Ω–Ω—ã–π –≤ –¥–∏–∑–∞–π–Ω */
    .range-wrapper {
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
    }

    input[type=range] {
        width: 100%;
        -webkit-appearance: none;
        background: rgba(255,255,255,0.1);
        height: 6px;
        border-radius: 3px;
        outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: #fff;
        border: 3px solid var(--telegram-color, #0088CC);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 15px var(--telegram-color);
        transition: transform 0.1s;
    }
    input[type=range]::-webkit-slider-thumb:active {
        transform: scale(1.2);
    }

    /* –ë–ª–æ–∫ –Ω–∞–≥—Ä–∞–¥—ã –≤–Ω—É—Ç—Ä–∏ —Å–ª–∞–π–¥–µ—Ä–∞ */
    .reward-preview {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 10px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
    }

    .reward-val {
        font-size: 28px;
        font-weight: 800;
        color: #FFD700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤ —Å—Ç–∏–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    .header-bar {
        display: flex;
        align-items: center;
        padding-bottom: 15px;
    }
    .back-icon {
        color: var(--text-color-muted);
        font-size: 20px;
        margin-right: 15px;
        cursor: pointer;
    }
    .header-title {
        font-size: 20px;
        font-weight: 800;
        color: var(--text-color);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div id="loader-overlay" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;">
    <div class="spinner" style="width: 36px; height: 36px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div id="loading-text" style="color: #fff; margin-top: 15px; font-family: sans-serif; font-weight: bold; font-size: 18px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
  </div>

  <main id="main-content" class="main-content" style="opacity: 0; transition: opacity 0.3s;">
    
    <div class="header-bar">
        <i class="fa-solid fa-arrow-left back-icon" onclick="window.location.href='/quests'"></i>
        <span class="header-title">Telegram –í—ã–∑–æ–≤</span>
    </div>

    <div id="dynamic-content" class="fade-in"></div>

  </main>

  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div><span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span></a>
    <a href="/quests" class="footer-item active"><div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div><span>–ó–∞–¥–∞–Ω–∏—è</span></a>
    <a href="/menu" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-house"></i></div><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
    <a href="/events" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div><span>–ì—Ä–∏–Ω–¥</span></a>
    <a href="/auction" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div><span>–ê—É–∫—Ü–∏–æ–Ω</span></a>
  </footer>

  <div id="custom-prompt-overlay" class="prompt-overlay hidden"></div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
    if (window.Telegram?.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.setHeaderColor('#000000'); 
        Telegram.WebApp.setBackgroundColor('#000000');
    }

    const container = document.getElementById('dynamic-content');
    const loader = document.getElementById('loader-overlay');
    const mainContent = document.getElementById('main-content');

    // ID —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞ (—Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –≤ SQL)
    const SLIDER_QUEST_ID = 999; 

    // --- 1. –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò ---
    async function loadState() {
        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–≤–µ—Å—Ç—É 999)
            const res = await fetch('/api/v1/tg/challenge/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ initData: Telegram.WebApp.initData })
            });

            if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            const data = await res.json();

            // –ï—Å–ª–∏ –∫–≤–µ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω -> –†–∏—Å—É–µ–º –ö–∞—Ä—Ç–æ—á–∫—É –ü—Ä–æ–≥—Ä–µ—Å—Å–∞
            if (data.active) {
                renderActiveQuest(data);
            } 
            // –ï—Å–ª–∏ –∫–≤–µ—Å—Ç–∞ –Ω–µ—Ç -> –†–∏—Å—É–µ–º –°–ª–∞–π–¥–µ—Ä
            else {
                renderSlider();
            }

            // –£–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä
            loader.style.display = 'none';
            mainContent.style.opacity = '1';

        } catch (e) {
            container.innerHTML = `<div style="text-align:center; color:red; margin-top:50px;">–û—à–∏–±–∫–∞: ${e.message}</div>`;
            loader.style.display = 'none';
            mainContent.style.opacity = '1';
        }
    }

    // --- 2. –†–ï–ù–î–ï–† –°–õ–ê–ô–î–ï–†–ê (–í —Å—Ç–∏–ª–µ quest-card) ---
    function renderSlider() {
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å .quest-card –∏–∑ —Ç–≤–æ–µ–≥–æ CSS, —á—Ç–æ–±—ã —Ñ–æ–Ω –∏ –±–ª—é—Ä –±—ã–ª–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã
        container.innerHTML = `
            <div class="quest-card fade-in">
                
                <div class="slider-card-content">
                    <span class="slider-label">–í–´–ë–ï–†–ò–¢–ï –¶–ï–õ–¨ –ù–ê –ù–ï–î–ï–õ–Æ</span>
                    
                    <div class="count-display" id="val-display">100</div>
                    
                    <div class="range-wrapper">
                        <input type="range" id="slider" min="10" max="500" step="10" value="100">
                    </div>

                    <div class="reward-preview">
                        <span class="quest-subtitle" style="margin-bottom:5px;">–ù–ê–ì–†–ê–î–ê</span>
                        <div class="reward-val" id="reward-display">+10 <i class="fa-solid fa-ticket"></i></div>
                    </div>
                </div>

                <div class="button-container" style="width:100%; margin-top:10px;">
                    <button id="btn-start" class="claim-reward-button" style="width:100%; font-size:16px; padding:14px;">
                        –ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í
                    </button>
                </div>
            </div>

            <p style="text-align: center; color: var(--text-color-muted); font-size: 12px; margin-top: 15px; padding: 0 20px;">
                –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —á–∞—Ç–∞. <br> –ù–∞–≥—Ä–∞–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
            </p>
        `;

        const slider = document.getElementById('slider');
        const valDisplay = document.getElementById('val-display');
        const rewardDisplay = document.getElementById('reward-display');
        const btn = document.getElementById('btn-start');

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (10% –æ—Ç —Ü–µ–ª–∏)
        slider.oninput = () => {
            const val = parseInt(slider.value);
            valDisplay.innerText = val;
            
            // –†–∞—Å—á–µ—Ç: 10% –æ—Ç —Ü–µ–ª–∏, –º–∏–Ω–∏–º—É–º 1
            let reward = Math.floor(val * 0.1);
            if (reward < 1) reward = 1;
            
            rewardDisplay.innerHTML = `+${reward} <i class="fa-solid fa-ticket"></i>`;
            
            // –í–∏–±—Ä–∞—Ü–∏—è
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        };

        // –õ–æ–≥–∏–∫–∞ —Å—Ç–∞—Ä—Ç–∞
        btn.onclick = async () => {
            const amount = parseInt(slider.value);
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width:20px; height:20px; border-width:2px;"></div>';

            try {
                const res = await fetch('/api/v1/tg/challenge/commit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        initData: Telegram.WebApp.initData,
                        amount: amount
                    })
                });

                if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                loadState();

            } catch (e) {
                Telegram.WebApp.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤—ã–∑–æ–≤: " + e.message);
                btn.disabled = false;
                btn.innerText = "–ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í";
            }
        };
    }

    // --- 3. –†–ï–ù–î–ï–† –ê–ö–¢–ò–í–ù–û–ì–û –ö–í–ï–°–¢–ê (–ê–±—Å–æ–ª—é—Ç–Ω–æ 1–≤1 –∫–∞–∫ –≤ quests.js) ---
    function renderActiveQuest(data) {
        const current = data.current;
        const target = data.target;
        const percent = Math.min(100, (current / target) * 100);
        const isDone = current >= target;
        
        let buttonHtml = '';
        
        if (isDone) {
            // –ö–Ω–æ–ø–∫–∞ –ó–ê–ë–†–ê–¢–¨
            buttonHtml = `
                <button onclick="claimReward()" class="claim-reward-button" style="width:100%;">
                    <i class="fa-solid fa-gift"></i> –ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£
                </button>`;
        } else {
            // –ö–Ω–æ–ø–∫–∞ –í –ü–†–û–¶–ï–°–°–ï (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è)
            buttonHtml = `
                <button disabled class="claim-reward-button" style="width:100%; background: #333; color: #777; box-shadow: none; cursor: default;">
                    –í –ü–†–û–¶–ï–°–°–ï...
                </button>`;
        }

        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É HTML, —á—Ç–æ –∏ –≤ renderActiveAutomaticQuest
        container.innerHTML = `
            <div class="quest-card fade-in">
                ${!isDone ? '<div class="active-quest-indicator">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</div>' : ''}
                
                <div class="quest-content-wrapper">
                    <div class="quest-icon">
                        <i class="fa-brands fa-telegram"></i>
                    </div>
                    
                    <h2 class="quest-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –í—ã–∑–æ–≤</h2>
                    <p class="quest-subtitle">–ù–∞–ø–∏—Å–∞—Ç—å ${target} —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%;"></div>
                        <div class="progress-content">
                            <span class="progress-text">üí¨ ${current} / ${target}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top:10px; font-size:12px; color:#888;">
                        –ù–∞–≥—Ä–∞–¥–∞: <span style="color:#fff; font-weight:bold;">${data.reward} <i class="fa-solid fa-ticket" style="color:#FFD700;"></i></span>
                    </div>
                </div>

                <div class="button-container">
                    ${buttonHtml}
                </div>
            </div>
            
            ${!isDone ? `
                <div style="margin-top: 15px; text-align: center;">
                     <button onclick="cancelChallenge()" style="background:none; border:none; color:#555; font-size:12px; text-decoration:underline;">–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤</button>
                </div>
            ` : ''}
        `;
    }

    // –§—É–Ω–∫—Ü–∏—è –∫–ª–µ–π–º–∞ (—á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤/–Ω–∞–≥—Ä–∞–¥)
    window.claimReward = async () => {
        const btn = document.querySelector('.claim-reward-button');
        if(btn) { btn.disabled = true; btn.innerHTML = '...'; }

        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –∫–≤–µ—Å—Ç–æ–≤ —Å ID 999
            const res = await fetch('/api/v1/promocode', { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    initData: Telegram.WebApp.initData,
                    quest_id: SLIDER_QUEST_ID 
                })
            });

            const result = await res.json();
            
            if (res.ok) {
                Telegram.WebApp.showAlert("–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!");
                loadState(); 
            } else {
                throw new Error(result.detail || "–û—à–∏–±–∫–∞");
            }
        } catch (e) {
            Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞: " + e.message);
            if(btn) { btn.disabled = false; btn.innerText = "–ó–ê–ë–†–ê–¢–¨"; }
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    window.cancelChallenge = async () => {
        Telegram.WebApp.showConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.", async (ok) => {
            if (ok) {
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–º–µ–Ω—É –∫–≤–µ—Å—Ç–∞
                    // –ù–æ —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ "–æ—Å–æ–±—ã–π" –∫–≤–µ—Å—Ç, –ª—É—á—à–µ —Å–±—Ä–æ—Å–∏—Ç—å —á–µ—Ä–µ–∑ API 
                    // (–∏–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /api/v1/quests/cancel, –µ—Å–ª–∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–±—Ä–æ—Å –ø–æ active_quest_id –≤ users)
                    // –ù–æ —É –Ω–∞—Å —Å–≤–æ–π user_quest_progress.
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –≤—ã–∑–æ–≤–µ–º –æ–±—ã—á–Ω—É—é –æ—Ç–º–µ–Ω—É, –µ—Å–ª–∏ –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å users table.
                    // –ï—Å–ª–∏ –Ω–µ—Ç - –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç —Å–±—Ä–æ—Å–∞.
                    // –í –¥–∞–Ω–Ω–æ–º –∫–æ–¥–µ —è –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ —Ö–æ—á–µ—Ç –≤—ã–π—Ç–∏.
                    
                    // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ (–≤ —Ä–µ–∞–ª–µ –Ω—É–∂–µ–Ω API call)
                    // –î–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç –æ—á–∏—Å—Ç–∫–∏ user_quest_progress –¥–ª—è ID 999.
                    Telegram.WebApp.showAlert("–§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ API.");
                } catch(e) {}
            }
        });
    };

    // –ó–∞–ø—É—Å–∫
    loadState();

</script>
</body>
</html>
