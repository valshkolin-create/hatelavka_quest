<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ì—Ä–∏–Ω–¥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <style>
    :root {
      --background-main: #111111;
      --surface-primary: #1C1C1C;
      --surface-secondary: #2C2C2C;
      --border-color: #333333;
      --text-primary: #f0f0f5;
      --text-secondary: #AAAAAA;
      --accent-primary: #FFD700; /* –ó–æ–ª–æ—Ç–æ */
      --accent-secondary: #FF9500; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
      --danger-color: #ff4d4d;
      --success-color: #34c759;
      --card-bg-glass: rgba(28, 28, 28, 0.75);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-main);
      color: var(--text-primary);
      margin: 0;
      padding: 10px 10px 80px;
      overflow-x: hidden;
      background-image: url('https://i.postimg.cc/Dyks29xc/fon-variant1.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* –•–ï–î–ï–† */
    .new-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 20px; 
        padding: 5px 0;
    }

    .header-back-button {
        display: flex; align-items: center; gap: 6px;
        color: var(--text-secondary); text-decoration: none;
        font-size: 12px; font-weight: 600; position: relative; z-index: 2;
        transition: color 0.2s ease;
    }
    .header-back-button:hover { color: var(--text-primary); }

    .page-header {
        position: absolute; left: 0; right: 0; top: 50%;
        transform: translateY(-50%); text-align: center; z-index: 1;
    }
    .page-title {
        font-size: 18px; font-weight: 700; margin: 0;
        color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px;
    }

    /* –ö–ê–†–¢–û–ß–ö–ò */
    .glass-card {
        background-color: var(--card-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
    }

    /* –ë–ê–õ–ê–ù–°–´ */
    .balance-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .balance-item {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .balance-label {
        font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;
    }

    .balance-value {
        font-size: 16px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 6px;
    }
    
    .coin-icon { color: var(--accent-primary); text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
    .ticket-icon { color: #00f2ea; text-shadow: 0 0 10px rgba(0, 242, 234, 0.4); }

    /* –ì–†–ò–ù–î */
    .section-title {
        font-size: 13px; font-weight: 700; color: var(--text-primary); margin: 0 0 12px;
        display: flex; align-items: center; gap: 6px; text-transform: uppercase;
    }
    .section-title i { color: var(--accent-secondary); }

    .streak-wrapper {
        display: flex; justify-content: space-between; align-items: center;
        position: relative; margin: 20px 5px 25px;
    }

    .streak-line-bg {
        position: absolute; top: 50%; left: 0; right: 0; height: 2px;
        background: var(--border-color); transform: translateY(-50%); z-index: 0;
    }

    .streak-line-fill {
        position: absolute; top: 50%; left: 0; height: 2px;
        background: var(--accent-primary); transform: translateY(-50%); z-index: 1;
        width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px var(--accent-primary);
    }

    .streak-step {
        width: 24px; height: 24px; background: var(--surface-primary);
        border: 1px solid var(--border-color); border-radius: 50%; z-index: 2;
        display: flex; justify-content: center; align-items: center;
        font-size: 9px; color: var(--text-secondary); font-weight: 700; transition: all 0.3s ease;
    }

    .streak-step.active {
        border-color: var(--accent-primary); background: var(--background-main);
        color: var(--text-primary); transform: scale(1.2); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .streak-step.completed {
        background: var(--accent-primary); border-color: var(--accent-primary); color: #000;
    }

    .grind-info {
        text-align: center; font-size: 11px; color: var(--text-secondary); margin-bottom: 12px;
        background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;
    }
    .grind-info span { color: var(--accent-primary); font-weight: 700; }

    .main-action-btn {
        width: 100%; padding: 12px; background-color: var(--accent-primary);
        color: #000; font-size: 13px; font-weight: 700; border: none; border-radius: 6px;
        cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
        transition: transform 0.1s; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        position: relative; overflow: hidden;
    }
    .main-action-btn:active { transform: scale(0.98); }
    .main-action-btn:disabled {
        background-color: var(--surface-secondary); color: var(--text-secondary);
        cursor: not-allowed; box-shadow: none;
    }

    /* –ö–ù–û–ü–ö–ê –û–¢–ö–†–´–¢–ò–Ø –ú–ê–ì–ê–ó–ò–ù–ê */
    .open-shop-card {
        display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        transition: transform 0.2s; border-color: var(--accent-secondary);
    }
    .open-shop-card:active { transform: scale(0.98); }
    .shop-info-left { display: flex; align-items: center; gap: 12px; }
    .shop-icon-large { font-size: 24px; color: var(--accent-secondary); }
    .shop-text h4 { margin: 0; font-size: 13px; color: var(--text-primary); }
    .shop-text p { margin: 2px 0 0; font-size: 10px; color: var(--text-secondary); }
    .shop-arrow { color: var(--text-secondary); font-size: 12px; }

    /* –ú–û–î–ê–õ–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 200; display: flex;
        align-items: center; justify-content: center; backdrop-filter: blur(8px);
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .modal-overlay.visible { opacity: 1; pointer-events: all; }

    .modal-content {
        background-color: var(--surface-primary); border: 1px solid var(--accent-primary);
        border-radius: 12px; width: 90%; max-width: 360px;
        box-shadow: 0 10px 40px rgba(255, 215, 0, 0.15);
        display: flex; flex-direction: column; position: relative;
        max-height: 85vh;
    }

    .modal-header {
        padding: 15px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title { font-size: 14px; font-weight: 700; color: var(--accent-primary); text-transform: uppercase; }
    .modal-close-btn {
        background: none; border: none; color: var(--text-secondary);
        font-size: 24px; cursor: pointer; padding: 0; line-height: 1;
    }

    .modal-body { padding: 15px; overflow-y: auto; }

    .shop-grid { display: flex; flex-direction: column; gap: 10px; min-height: 200px; }

    .exchange-item {
        background-color: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 6px; padding: 10px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .exchange-details { display: flex; flex-direction: column; gap: 2px; }
    .exchange-title { font-size: 12px; color: var(--text-primary); font-weight: 600; }
    .exchange-cost { font-size: 10px; color: var(--accent-primary); }
    
    .mini-btn {
        background: transparent; border: 1px solid var(--accent-primary); color: var(--accent-primary);
        padding: 6px 12px; font-size: 10px; font-weight: 600; border-radius: 4px;
        text-transform: uppercase; cursor: pointer; transition: all 0.2s;
    }
    .mini-btn:hover { background: var(--accent-primary); color: #000; }
    .mini-btn:disabled { border-color: var(--border-color); color: var(--text-secondary); pointer-events: none; opacity: 0.5; }

    /* –ü–ê–ì–ò–ù–ê–¶–ò–Ø */
    .pagination-controls {
        display: flex; justify-content: space-between; align-items: center;
        margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color);
    }
    .page-btn {
        background: var(--surface-secondary); border: none; color: var(--text-primary);
        width: 30px; height: 30px; border-radius: 50%; font-size: 12px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
    }
    .page-btn:disabled { opacity: 0.3; cursor: default; }
    .page-info { font-size: 11px; color: var(--text-secondary); }

    /* –ë–ï–°–ü–õ–ê–¢–ù–´–ô –ë–ò–õ–ï–¢ */
    .free-ticket-section {
        border: 1px dashed var(--text-secondary); padding: 12px; border-radius: 8px;
        display: flex; justify-content: space-between; align-items: center;
        margin-top: 10px; background: rgba(255,255,255,0.02);
    }
    .free-ticket-text { font-size: 11px; color: var(--text-secondary); }
    .free-ticket-title { font-size: 12px; font-weight: 700; color: #fff; display: block; margin-bottom: 2px; }

    /* –§–£–¢–ï–† */
    .app-footer {
        display: flex; justify-content: space-around;
        background-color: rgba(17, 17, 17, 0.9);
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        border-top: 1px solid var(--border-color); width: 100%;
        padding-top: 6px; padding-bottom: calc(6px + env(safe-area-inset-bottom));
        position: fixed; bottom: 0; left: 0; z-index: 100;
    }
    .footer-item {
        display: flex; flex-direction: column; align-items: center; gap: 2px;
        color: var(--text-secondary); font-size: 10px; text-decoration: none; flex: 1;
    }
    .footer-item .icon-wrapper {
        font-size: 22px; width: 28px; height: 28px;
        display: flex; justify-content: center; align-items: center;
    }
    .footer-item.active span, .footer-item.active .icon-wrapper { color: var(--accent-primary); font-weight: 600; }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    .shine {
        position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 3s infinite;
    }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
    .float-anim {
        animation: floatUp 1s ease-out forwards;
        position: absolute; font-weight: 800; font-size: 16px; pointer-events: none; z-index: 100;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

  </style>
</head>
<body>

  <div class="new-header-container">
    <a href="/menu" class="header-back-button">
        <i class="fa-solid fa-chevron-left"></i> –ù–∞–∑–∞–¥
    </a>
    <div class="page-header">
        <h1 class="page-title">–°—Ç–∞–Ω—Ü–∏—è –ì—Ä–∏–Ω–¥–∞</h1>
    </div>
    <div style="width: 40px;"></div>
  </div>

  <div class="balance-grid">
    <div class="balance-item">
        <span class="balance-label">–ú–æ–Ω–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-coins">0.0</span> <i class="fa-solid fa-coins coin-icon"></i>
        </div>
    </div>
    <div class="balance-item">
        <span class="balance-label">–ë–∏–ª–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-tickets">0</span> <i class="fa-solid fa-ticket ticket-icon"></i>
        </div>
    </div>
  </div>

  <div class="glass-card">
    <div class="section-title"><i class="fa-solid fa-fire"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –°–µ—Ä–∏—è</div>
    
    <div class="streak-wrapper">
        <div class="streak-line-bg"></div>
        <div class="streak-line-fill" id="streak-bar"></div>
        <div id="streak-steps" style="display: flex; justify-content: space-between; width: 100%; position: relative;">
            </div>
    </div>

    <div class="grind-info">
        –î–µ–Ω—å —Å–µ—Ä–∏–∏: <span id="current-streak-day">1</span> / 10 <br>
        –ù–∞–≥—Ä–∞–¥–∞ —Å–µ–≥–æ–¥–Ω—è: <span id="today-reward">+0.1</span> –º–æ–Ω–µ—Ç
    </div>

    <button id="grind-btn" class="main-action-btn">
        <span id="grind-btn-text">–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°</span>
        <div class="shine"></div>
    </button>
  </div>

  <div class="glass-card open-shop-card" onclick="openShopModal()">
    <div class="shop-info-left">
        <i class="fa-solid fa-shop shop-icon-large"></i>
        <div class="shop-text">
            <h4>–ú–∞–≥–∞–∑–∏–Ω –ù–∞–≥—Ä–∞–¥</h4>
            <p>–û–±–º–µ–Ω –º–æ–Ω–µ—Ç –Ω–∞ –±–∏–ª–µ—Ç—ã –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã</p>
        </div>
    </div>
    <div class="shop-arrow"><i class="fa-solid fa-chevron-right"></i></div>
  </div>

  <div class="free-ticket-section">
    <div>
        <span class="free-ticket-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–∏–ª–µ—Ç</span>
        <span class="free-ticket-text">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ 24—á</span>
    </div>
    <div id="free-ticket-container">
        </div>
  </div>

  <div id="shop-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">–û–±–º–µ–Ω–Ω–∏–∫</div>
            <button class="modal-close-btn" onclick="closeShopModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="shop-grid" id="shop-container">
                </div>
            
            <div class="pagination-controls" id="pagination-controls">
                <button class="page-btn" id="prev-page-btn" onclick="changePage(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                <span class="page-info" id="page-indicator">1 / 1</span>
                <button class="page-btn" id="next-page-btn" onclick="changePage(1)"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>
    </div>
  </div>

  <footer class="app-footer">
    <a href="/menu" class="footer-item">
      <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/events" class="footer-item active">
      <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
      <span>–ì—Ä–∏–Ω–¥</span>
    </a>
    <a href="/profile" class="footer-item">
      <div class="icon-wrapper"><i class="fa-solid fa-user"></i></div>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let userState = {
        coins: 0.0,
        tickets: 0,
        streakDays: 1,
        lastGrindTime: null, 
        lastFreeTicket: null 
    };

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
    let shopItems = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    const MAX_STREAK = 10;
    const GRIND_COOLDOWN = 24 * 60 * 60 * 1000;

    const dom = {
        coinsDisplay: document.getElementById('user-coins'),
        ticketsDisplay: document.getElementById('user-tickets'),
        streakBar: document.getElementById('streak-bar'),
        streakSteps: document.getElementById('streak-steps'),
        streakDayDisplay: document.getElementById('current-streak-day'),
        todayRewardDisplay: document.getElementById('today-reward'),
        grindBtn: document.getElementById('grind-btn'),
        grindBtnText: document.getElementById('grind-btn-text'),
        freeTicketContainer: document.getElementById('free-ticket-container'),
        shopModal: document.getElementById('shop-modal'),
        shopContainer: document.getElementById('shop-container'),
        pageIndicator: document.getElementById('page-indicator'),
        prevPageBtn: document.getElementById('prev-page-btn'),
        nextPageBtn: document.getElementById('next-page-btn'),
        paginationControls: document.getElementById('pagination-controls')
    };

    async function init() {
        try {
            const response = await fetch('/api/v1/user/me', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (response.ok) {
                const data = await response.json();
                userState.tickets = data.tickets || 0;
                userState.coins = parseFloat(data.coins || 0);
                userState.streakDays = data.streak_days || 1;
                userState.lastGrindTime = data.last_grind_at;
                userState.lastFreeTicket = data.last_free_ticket_claimed_at;
                
                updateUI();
                renderStreakVisuals();
                fetchShopItems(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã, –Ω–æ –ø–æ–∫–∞ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –º–æ–¥–∞–ª–∫—É
                startTimers();
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.");
        }
    }

    function updateUI() {
        dom.coinsDisplay.textContent = userState.coins.toFixed(1);
        dom.ticketsDisplay.textContent = userState.tickets;
        dom.streakDayDisplay.textContent = userState.streakDays;
        
        let reward = (userState.streakDays * 0.1).toFixed(1);
        if (parseFloat(reward) > 1.0) reward = "1.0";
        dom.todayRewardDisplay.textContent = `+${reward}`;

        const now = new Date().getTime();
        const last = userState.lastGrindTime ? new Date(userState.lastGrindTime).getTime() : 0;
        const diff = now - last;

        if (diff < GRIND_COOLDOWN) {
            dom.grindBtn.disabled = true;
            const remaining = GRIND_COOLDOWN - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.grindBtnText.textContent = `–î–û–°–¢–£–ü–ù–û –ß–ï–†–ï–ó ${h}—á ${m}–º`;
        } else {
            dom.grindBtn.disabled = false;
            dom.grindBtnText.textContent = "–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°";
        }
    }

    function renderStreakVisuals() {
        dom.streakSteps.innerHTML = '';
        let percent = ((userState.streakDays - 1) / (MAX_STREAK - 1)) * 100;
        if (percent > 100) percent = 100;
        dom.streakBar.style.width = `${percent}%`;

        for (let i = 1; i <= 5; i++) {
            const step = document.createElement('div');
            step.className = 'streak-step';
            
            let dayValue = 1;
            if (i === 2) dayValue = 3;
            if (i === 3) dayValue = 5;
            if (i === 4) dayValue = 7;
            if (i === 5) dayValue = 10;

            step.textContent = dayValue;

            if (userState.streakDays >= dayValue) {
                step.classList.add('completed');
                step.innerHTML = '<i class="fa-solid fa-check"></i>';
            }
            dom.streakSteps.appendChild(step);
        }
    }

    // --- –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê (–ú–û–î–ê–õ–ö–ê + –ü–ê–ì–ò–ù–ê–¶–ò–Ø) ---

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ø–∞–º—è—Ç—å
    async function fetchShopItems() {
        // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã
        shopItems = [
            { type: 'ticket', cost: 4, reward: 1, title: '1 –ë–∏–ª–µ—Ç' },
            { type: 'ticket', cost: 40, reward: 10, title: '10 –ë–∏–ª–µ—Ç–æ–≤' }
        ];

        try {
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
            const response = await fetch('/api/v1/user/grind/shop');
            const promos = await response.json();
            if (promos && promos.length > 0) {
                promos.forEach(p => {
                    shopItems.push({
                        type: 'promo',
                        cost: p.reward_value,
                        reward: p.reward_value, // —Ç—É—Ç —ç—Ç–æ –Ω–æ–º–∏–Ω–∞–ª
                        title: `–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${p.reward_value} ‚òÖ`,
                        quantity: p.quantity
                    });
                });
            }
        } catch (e) {
            console.warn("Shop fetch error", e);
        }
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –±–∏–ª–µ—Ç—ã, –ø–æ—Ç–æ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã –ø–æ —Ü–µ–Ω–µ
        shopItems.sort((a, b) => a.cost - b.cost);
    }

    // 2. –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    window.openShopModal = async () => {
        await fetchShopItems(); // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        currentPage = 1;
        renderShopPage(currentPage);
        dom.shopModal.classList.add('visible');
    };

    // 3. –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    window.closeShopModal = () => {
        dom.shopModal.classList.remove('visible');
    };

    // 4. –†–µ–Ω–¥–µ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function renderShopPage(page) {
        dom.shopContainer.innerHTML = '';
        
        const totalPages = Math.ceil(shopItems.length / itemsPerPage);
        if (totalPages === 0) {
            dom.shopContainer.innerHTML = '<div style="text-align:center; color:#777; padding:20px;">–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</div>';
            dom.paginationControls.style.display = 'none';
            return;
        }

        dom.paginationControls.style.display = 'flex';
        
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const itemsToShow = shopItems.slice(start, end);

        itemsToShow.forEach(item => {
            const div = document.createElement('div');
            div.className = 'exchange-item';
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞, –µ—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ (–∑–æ–ª–æ—Ç–æ) –∏–ª–∏ –±–∏–ª–µ—Ç (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)
            if(item.type === 'promo') div.style.borderColor = 'var(--accent-primary)';

            const isAffordable = userState.coins >= item.cost;
            const btnClick = item.type === 'ticket' 
                ? `exchangeCoins(${item.cost}, ${item.reward})`
                : `buyItem(${item.reward})`;

            let titleColor = item.type === 'promo' ? 'var(--accent-primary)' : '#fff';
            let extraInfo = item.quantity ? `<span style="opacity:0.5; font-size:9px; margin-left:4px;">(–û—Å—Ç: ${item.quantity})</span>` : '';

            div.innerHTML = `
                <div class="exchange-details">
                    <div class="exchange-title" style="color:${titleColor}">
                        ${item.title}
                    </div>
                    <div class="exchange-cost" style="color:#fff">
                        –¶–µ–Ω–∞: ${item.cost} –ú–æ–Ω–µ—Ç ${extraInfo}
                    </div>
                </div>
                <button class="mini-btn" 
                        onclick="${btnClick}" 
                        ${isAffordable ? '' : 'disabled'} 
                        style="${isAffordable && item.type==='promo' ? 'background:var(--accent-primary); color:#000;' : ''}">
                    ${isAffordable ? '–ö—É–ø–∏—Ç—å' : '–ú–∞–ª–æ –º–æ–Ω–µ—Ç'}
                </button>
            `;
            dom.shopContainer.appendChild(div);
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        dom.pageIndicator.textContent = `${page} / ${totalPages}`;
        dom.prevPageBtn.disabled = page === 1;
        dom.nextPageBtn.disabled = page === totalPages;
    }

    // 5. –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.changePage = (delta) => {
        const totalPages = Math.ceil(shopItems.length / itemsPerPage);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderShopPage(currentPage);
        }
    };

    // --- –î–ï–ô–°–¢–í–ò–Ø –ü–û–ö–£–ü–ö–ò ---

    // –ì—Ä–∏–Ω–¥
    dom.grindBtn.addEventListener('click', async () => {
        if (dom.grindBtn.disabled) return;
        tg.HapticFeedback.impactOccurred('medium');
        dom.grindBtn.disabled = true;

        try {
            const response = await fetch('/api/v1/user/grind/claim', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || "–û—à–∏–±–∫–∞");
            }

            const res = await response.json();
            showFloatText(dom.grindBtn, `+${res.reward_claimed}`, 'var(--accent-primary)');
            
            userState.coins = parseFloat(res.new_coins);
            userState.streakDays = res.streak_days;
            userState.lastGrindTime = res.last_grind_at;

            updateUI();
            renderStreakVisuals();

        } catch (e) {
            tg.showAlert(e.message);
            dom.grindBtn.disabled = false;
        }
    });

    // –û–±–º–µ–Ω –Ω–∞ –±–∏–ª–µ—Ç—ã
    window.exchangeCoins = async (cost, rewardTickets) => {
        tg.showConfirm(`–û–±–º–µ–Ω—è—Ç—å ${cost} –º–æ–Ω–µ—Ç –Ω–∞ ${rewardTickets} –±–∏–ª–µ—Ç(–æ–≤)?`, async (ok) => {
            if (ok) {
                try {
                    const response = await fetch('/api/v1/user/grind/exchange', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, cost: cost, tickets_reward: rewardTickets })
                    });

                    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞");
                    const res = await response.json();

                    userState.coins = parseFloat(res.new_coins);
                    userState.tickets = res.new_tickets;
                    
                    updateUI();
                    renderShopPage(currentPage); // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert('–£—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω!');

                } catch (e) {
                    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–º–µ–Ω.');
                }
            }
        });
    };

    // –ü–æ–∫—É–ø–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    window.buyItem = async (rewardValue) => {
        tg.showConfirm(`–ö—É–ø–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${rewardValue} –∑–≤—ë–∑–¥?`, async (ok) => {
            if (ok) {
                if(typeof tg.MainButton.showProgress === 'function') tg.MainButton.showProgress();
                try {
                    const response = await fetch('/api/v1/user/grind/buy_item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, reward_value: rewardValue })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                    }

                    const res = await response.json();
                    userState.coins = parseFloat(res.new_coins);
                    
                    updateUI();
                    await fetchShopItems(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
                    renderShopPage(currentPage); // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showPopup({
                        title: 'üéâ –£—Å–ø–µ—à–Ω–æ!',
                        message: `–í–∞—à –∫–æ–¥:\n\n${res.promo_code}\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ.`,
                        buttons: [{type: 'ok'}]
                    });

                } catch (e) {
                    tg.showAlert(e.message);
                    tg.HapticFeedback.notificationOccurred('error');
                } finally {
                    if(typeof tg.MainButton.hideProgress === 'function') tg.MainButton.hideProgress();
                }
            }
        });
    };

    // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–∏–ª–µ—Ç (Legacy)
    function renderFreeTicketBtn() {
        const lastClaim = userState.lastFreeTicket ? new Date(userState.lastFreeTicket).getTime() : 0;
        const now = new Date().getTime();
        const diff = now - lastClaim;
        const cooldown = 24 * 60 * 60 * 1000;

        if (diff > cooldown) {
            dom.freeTicketContainer.innerHTML = `<button class="mini-btn" style="border-color:#fff; color:#fff;" onclick="claimFreeTicket()">–ü–û–õ–£–ß–ò–¢–¨</button>`;
        } else {
            const remaining = cooldown - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.freeTicketContainer.innerHTML = `<span style="font-size:11px; color:#555;">${h}—á ${m}–º</span>`;
        }
    }

    window.claimFreeTicket = async () => {
        try {
            const response = await fetch('/api/v1/user/claim-free-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });
            if (response.ok) {
                const res = await response.json();
                userState.tickets = res.new_ticket_balance;
                userState.lastFreeTicket = new Date().toISOString();
                tg.showAlert('–ë–∏–ª–µ—Ç –ø–æ–ª—É—á–µ–Ω!');
                updateUI();
                renderFreeTicketBtn();
            } else { throw new Error(); }
        } catch (e) { tg.showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–∞'); }
    };

    function startTimers() {
        setInterval(() => { updateUI(); renderFreeTicketBtn(); }, 60000);
        renderFreeTicketBtn();
    }

    function showFloatText(element, text, color) {
        const rect = element.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.textContent = text;
        floatEl.className = 'float-anim';
        floatEl.style.color = color;
        floatEl.style.left = (rect.left + rect.width / 2 - 20) + 'px';
        floatEl.style.top = (rect.top) + 'px';
        document.body.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 1000);
    }

    // –ê–Ω—Ç–∏–∫–ª–∏–∫ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–æ–π)
    dom.shopModal.addEventListener('click', (e) => {
        // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –ø–æ –æ–≤–µ—Ä–ª–µ—é (e.target === dom.shopModal), –º—ã –ù–ò–ß–ï–ì–û –Ω–µ –¥–µ–ª–∞–µ–º.
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ .modal-close-btn (onclick="closeShopModal()")
    });

    init();
});
</script>
</body>
</html>
