<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<style>
    :root {
      --bg-color: #000000;
      --surface-color: #1c1c1e;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --tg-color: #0088cc;
      --twitch-color: #9146ff;
      --gold-glow: #ffd700;
      --silver-glow: #c0c0c0;
      --bronze-glow: #cd7f32;
      --surface-glass-bg: rgba(28, 28, 30, 0.75);
    }
    body { margin: 0; min-height: 100vh; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; }
    .main-content { flex-grow: 1; overflow-y: auto; padding: 15px 15px 90px; }

    /* --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è --- */
    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .header-controls h2 { margin: 0; font-size: 16px; color: var(--text-color); }
    .refresh-button { background: none; border: none; color: var(--text-color-muted); cursor: pointer; padding: 0; font-size: 18px; transition: color 0.2s ease-in-out; }
    .refresh-button:hover { color: var(--tg-color); }
    .hidden { display: none !important; }

    /* --- –∏–Ω—Ñ–æ-–±–ª–æ–∫–∏ --- */
    .info-box { background-color: var(--surface-color); border-radius: 12px; padding: 15px; margin-bottom: 20px; font-size: 14px; line-height: 1.5; color: var(--text-color-muted); }
    .info-box h2 { margin: 0 0 10px 0; font-size: 16px; color: var(--text-color); }
    .info-box p { margin: 0; }
    .info-box strong { color: var(--text-color); font-weight: 600; }

    .controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    .source-switcher { display: flex; background-color: #2c2c2e; border-radius: 8px; padding: 4px; }
    .source-switcher button { flex: 1; padding: 8px; border: none; background-color: transparent; color: var(--text-color-muted); font-size: 14px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .source-switcher button.active.telegram { color: white; background-color: var(--tg-color); }
    .source-switcher button.active.twitch { color: white; background-color: var(--twitch-color); }

    .period-buttons { display: flex; gap: 8px; }
    .period-buttons.hidden { display: none; }
    .period-buttons button {
        flex: 1; /* <-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –≠—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ */
        width: 100%;
        background-color: #333;
        border: 1px solid #555;
        color: #ccc;
        font-size: 13px;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
    }
    .period-buttons button.active { background-color: var(--tg-color); color: #fff; border-color: var(--tg-color); }
    .period-buttons.twitch-active button.active { background-color: var(--twitch-color); border-color: var(--twitch-color); }


    table { width: 100%; border-collapse: collapse; background-color: var(--surface-color); border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #333; }
    th { background-color: #2a2a2a; font-size: 14px; }
    td.rank { font-weight: bold; text-align: center; width: 40px; }
    td.username { font-weight: 600; word-break: break-all; }
    td.count { font-weight: 600; text-align: right; }

    .first-place { border-left: 4px solid var(--gold-glow); }
    .second-place { border-left: 4px solid var(--silver-glow); }
    .third-place { border-left: 4px solid var(--bronze-glow); }

    .loader { margin-top: 30px; color: #888; text-align: center; }

    /* –ï–î–ò–ù–´–ô –°–¢–ò–õ–¨ –§–£–¢–ï–†–ê */
.app-footer {
    display: flex;
    justify-content: space-around;
    align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
    background-color: rgba(28, 28, 30, 0.75); /* –¶–≤–µ—Ç –∏–∑ menu.css */
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-top: 1px solid rgba(58, 58, 60, 0.6);
    width: 100%;
    padding-top: 6px;
    padding-bottom: calc(6px + env(safe-area-inset-bottom));
    position: fixed;
    bottom: 0;
    left: 0;
    z-index: 100;
    box-sizing: border-box;
}

.footer-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    color: #b0b0b0; /* var(--text-color-muted) */
    font-size: 10px;
    cursor: pointer;
    text-decoration: none;
    flex: 1;
    position: relative;
    transition: color 0.3s ease;
}

.footer-item .icon-wrapper {
    font-size: 22px;
    width: 28px;
    height: 28px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    transition: color 0.3s ease, transform 0.3s ease;
}

/* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
.footer-item.active span {
    color: #ffffff; /* var(--text-color) */
    font-weight: 600;
}

.footer-item.active .icon-wrapper {
    color: #34c759; /* var(--primary-color) - –∏–ª–∏ gold, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */
    transform: translateY(-2px);
    text-shadow: 0 0 10px #34c759; /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ */
}

/* –ü–æ–ª–æ—Å–∫–∞ –Ω–∞–¥ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–∫–æ–Ω–∫–æ–π (–∫–∞–∫ –≤ menu.css) */
.footer-item.active .icon-wrapper::before {
    content: '';
    position: absolute;
    top: -6px;
    width: 28px;
    height: 3px;
    background-color: #34c759; /* var(--primary-color) */
    border-radius: 2px;
}

    /* --- —Ñ–∏–∫—Å –ø–æ—Ä—è–¥–∫–∞ –∫–Ω–æ–ø–æ–∫ Twitch --- */
    #twitch-period-buttons button[data-period="session"] { order: 1; }
    #twitch-period-buttons button[data-period="week"]    { order: 2; }
    #twitch-period-buttons button[data-period="month"]   { order: 3; }
    #twitch-period-buttons button[data-period="global"]  { order: 4; }
</style>
</head>
<body>
  <main class="main-content">

    <div id="info-box-twitch" class="info-box hidden">
        <div class="header-controls">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Twitch</h2>
            <button class="refresh-button"><i class="fas fa-sync-alt"></i></button>
        </div>
        <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –Ω–∞—à–µ–º Twitch –∫–∞–Ω–∞–ª–µ.</p>
    </div>

    <div id="info-box-telegram" class="info-box">
        <div class="header-controls">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Telegram</h2>
            <button class="refresh-button"><i class="fas fa-sync-alt"></i></button>
        </div>
        <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –Ω–∞—à–µ–º Telegram-—á–∞—Ç–µ. <a href="https://t.me/hatelovettv" target="_blank" style="color: var(--tg-color);">–ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç</a></p>
    </div>

    <div class="controls">
      <div class="source-switcher">
        <button data-source="telegram" class="active telegram"><i class="fa-brands fa-telegram"></i> Telegram</button>
        <button data-source="twitch" class="twitch"><i class="fa-brands fa-twitch"></i> Twitch</button>
      </div>

      <div class="period-buttons" id="telegram-periods">
        <button data-period="day" class="active">–î–µ–Ω—å</button>
        <button data-period="week">–ù–µ–¥–µ–ª—è</button>
        <button data-period="month">–ú–µ—Å—è—Ü</button>
        <button data-period="all">–í—Å—ë –≤—Ä–µ–º—è</button>
      </div>

      <div class="period-buttons hidden twitch-controls" id="twitch-metric-buttons">
        <button data-metric="message" class="active">–°–æ–æ–±—â–µ–Ω–∏—è</button>
        <button data-metric="uptime">–í—Ä–µ–º—è</button>
        <button data-metric="ranks">–†–∞–Ω–≥–∏</button>
      </div>

      <div class="period-buttons hidden twitch-controls twitch-active" id="twitch-period-buttons">
        <button data-period="session" class="active">–°–µ—Å—Å–∏—è</button>
        <button data-period="week">–ù–µ–¥–µ–ª—è</button>
        <button data-period="month">–ú–µ—Å—è—Ü</button>
        <button data-period="global">–í—Å—ë –≤—Ä–µ–º—è</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th id="table-header-activity" style="text-align: right;">–°–æ–æ–±—â–µ–Ω–∏–π</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <div id="loader" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
  </main>
      
  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item active">
        <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
        <span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span>
    </a>
    <a href="/menu" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/menu#quests" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div>
        <span>–ó–∞–¥–∞–Ω–∏—è</span>
    </a>
    <a href="/events" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div>
        <span>–ì—Ä–∏–Ω–¥</span>
    </a>
    <a href="/auction" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
        <span>–ê—É–∫—Ü–∏–æ–Ω</span>
    </a>
</footer>

<script>
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  const dom = {
    sourceButtons: document.querySelectorAll('.source-switcher button'),
    leaderboardBody: document.getElementById('leaderboardBody'),
    loader: document.getElementById('loader'),
    tableHeader: document.getElementById('table-header-activity'),
    infoBoxTwitch: document.getElementById('info-box-twitch'),
    infoBoxTelegram: document.getElementById('info-box-telegram'),
    refreshButtons: document.querySelectorAll('.refresh-button'),
    
    telegramPeriods: document.getElementById('telegram-periods'),
    twitchMetricButtons: document.getElementById('twitch-metric-buttons'),
    twitchPeriodButtons: document.getElementById('twitch-period-buttons'),
    
    telegramPeriodButtons: document.querySelectorAll('#telegram-periods button'),
    twitchMetricButtonList: document.querySelectorAll('#twitch-metric-buttons button'),
    twitchPeriodButtonList: document.querySelectorAll('#twitch-period-buttons button'),
  };
  
  let state = {
      source: 'telegram',
      telegramPeriod: 'day',
      twitchMetric: 'message',
      twitchPeriod: 'session',
  };

  function updateUI() {
      dom.infoBoxTelegram.classList.toggle('hidden', state.source !== 'telegram');
      dom.telegramPeriods.classList.toggle('hidden', state.source !== 'telegram');
      
      dom.infoBoxTwitch.classList.toggle('hidden', state.source !== 'twitch');
      dom.twitchMetricButtons.classList.toggle('hidden', state.source !== 'twitch');
      
      const showTwitchPeriods = state.source === 'twitch' && state.twitchMetric !== 'ranks';
      dom.twitchPeriodButtons.classList.toggle('hidden', !showTwitchPeriods);

      if (state.source === 'telegram') {
          dom.tableHeader.textContent = '–°–æ–æ–±—â–µ–Ω–∏–π';
      } else {
          switch (state.twitchMetric) {
              case 'message': dom.tableHeader.textContent = '–°–æ–æ–±—â–µ–Ω–∏–π'; break;
              case 'uptime': dom.tableHeader.textContent = '–í—Ä–µ–º—è'; break;
              case 'ranks': dom.tableHeader.textContent = '–†–∞–Ω–≥ (PTS)'; break;
          }
      }
  }

  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø
  async function fetchAndRender() {
    dom.leaderboardBody.innerHTML = '';
    dom.loader.style.display = 'block';
    dom.loader.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å–µ–∫—É–Ω–¥
    function formatUptime(totalSeconds) {
        if (totalSeconds < 60) return `~1 –º–∏–Ω`;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        let result = '';
        if (hours > 0) result += `${hours} —á `;
        if (minutes > 0) result += `${minutes} –º–∏–Ω`;
        return result.trim() || '0 –º–∏–Ω';
    }

    let url = '';
    
    if (state.source === 'telegram') {
      url = `/api/v1/leaderboard?period=${state.telegramPeriod}`;
    } else { // Twitch
      if (state.twitchMetric === 'ranks') {
        url = `/api/v1/leaderboard/wizebot?sub_type=ALL&limit=50`;
      } else {
        url = `/api/v1/leaderboard/wizebot/stats?metric=${state.twitchMetric}&period=${state.twitchPeriod}&limit=50`;
      }
    }
    
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.statusText}`);
      const data = await response.json();

      const leaderboardData = Array.isArray(data) ? data : data.leaderboard;

      if (!Array.isArray(leaderboardData) || leaderboardData.length === 0) {
        dom.loader.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
        return;
      }

      leaderboardData.forEach((entry, index) => {
        const row = document.createElement('tr');
        let rankContent = index + 1;
        if (index === 0) { row.classList.add('first-place'); rankContent = 'ü•á'; }  
        else if (index === 1) { row.classList.add('second-place'); rankContent = 'ü•à'; }  
        else if (index === 2) { row.classList.add('third-place'); rankContent = 'ü•â'; }
        
        const name = entry.full_name || entry.username || '...';
        let value = entry.total_activity ?? entry.value ?? entry.messages_count ?? 0;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ—Ç—Ä–∏–∫–∏ 'uptime'
        if (state.source === 'twitch' && state.twitchMetric === 'uptime') {
            value = formatUptime(value);
        }

        row.innerHTML = `
          <td class="rank">${rankContent}</td>
          <td class="username">${name}</td>
          <td class="count">${value}</td>
        `;
        dom.leaderboardBody.appendChild(row);
      });
      dom.loader.style.display = 'none';
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      dom.loader.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.';
    }
  }
  
  // ‚úÖ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö
  dom.sourceButtons.forEach(button => {
    button.addEventListener('click', () => {
      state.source = button.dataset.source;
      dom.sourceButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      updateUI();
      fetchAndRender();
    });
  });

  dom.telegramPeriodButtons.forEach(button => {
    button.addEventListener('click', () => {
      state.telegramPeriod = button.dataset.period;
      dom.telegramPeriodButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      fetchAndRender();
    });
  });

  dom.twitchMetricButtonList.forEach(button => {
    button.addEventListener('click', () => {
      state.twitchMetric = button.dataset.metric;
      dom.twitchMetricButtonList.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      updateUI();
      fetchAndRender();
    });
  });

  dom.twitchPeriodButtonList.forEach(button => {
    button.addEventListener('click', () => {
      state.twitchPeriod = button.dataset.period;
      dom.twitchPeriodButtonList.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      fetchAndRender();
    });
  });
  
  dom.refreshButtons.forEach(button => {
    button.addEventListener('click', () => {
      fetchAndRender();
    });
  });

  // ‚úÖ –í–´–ó–û–í–´ –î–õ–Ø –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–û–ô –ó–ê–ì–†–£–ó–ö–ò
  updateUI();
  fetchAndRender();
</script>
</body>
</html>
