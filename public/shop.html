<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HATElavka Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/fontawesome/css/all.min.css" />
    <style>
        :root {
            --primary-color: #ffcc00;
            --primary-gradient: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-color: #ffffff;
            --text-secondary: #8E8E93;
            --surface-glass-bg: rgba(28, 28, 30, 0.85);
            /* [NEW] –¶–≤–µ—Ç–∞ –¥–ª—è —Ä—É–ª–µ—Ç–∫–∏ */
            --rarity-blue: #4b69ff;
            --rarity-purple: #8847ff;
            --rarity-pink: #d32ce6;
            --rarity-red: #eb4b4b;
            --rarity-gold: #ffd700;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at top center, #1a1a1a 0%, #000000 70%);
            background-attachment: fixed;
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            touch-action: pan-y;
        }

        /* --- –®–ê–ü–ö–ê --- */
        .shop-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding-top: calc(10px + env(safe-area-inset-top));
            padding-bottom: 10px;
            padding-left: 16px;
            padding-right: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            user-select: none;
            -webkit-user-select: none;
            will-change: transform;
        }

        .back-btn {
            background: none;
            border: none;
            color: #007aff; /* –°–∏–Ω–∏–π —Ü–≤–µ—Ç (Action color) */
            font-size: 12px; /* –†–∞–∑–º–µ—Ä 12px, –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª */
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            padding: 5px 0;
            text-decoration: none; /* –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ, —Ç.–∫. —Ç–µ–ø–µ—Ä—å —ç—Ç–æ —Å—Å—ã–ª–∫–∞ */
        }

        .back-btn:active {
            opacity: 0.6;
        }

        /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º —Ä–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ 12px */
        .back-btn i {
            font-size: 12px; 
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –ë–ê–õ–ê–ù–°–û–í (–ö–ê–ü–°–£–õ–´) --- */
        .balances-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .balance-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background-color: #0A0A0A; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ */
            border-radius: 999px; /* –§–æ—Ä–º–∞ –∫–∞–ø—Å—É–ª—ã */
            font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            font-weight: 800; /* –ñ–∏—Ä–Ω—ã–µ —Ü–∏—Ñ—Ä—ã */
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease, background 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .balance-pill:active {
            transform: scale(0.95);
        }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è –º–æ–Ω–µ—Ç (–∂–µ–ª—Ç—ã–µ) */
        .balance-pill.coins {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        .balance-pill.coins:active { background: rgba(255, 204, 0, 0.15); }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è –±–∏–ª–µ—Ç–æ–≤ (–≥–æ–ª—É–±—ã–µ, –≤–∑—è–ª –∏–∑ —Ç–≤–æ–∏—Ö —Å—Ç–∏–ª–µ–π) */
        .balance-pill.tickets {
            border: 1px solid #bdecff;
            color: #bdecff;
        }
        .balance-pill.tickets:active { background: rgba(189, 236, 255, 0.15); }

        /* –ò–∫–æ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –ø–ª–∞—à–∫–∏ */
        .balance-pill .refresh-icon {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 2px;
            transition: transform 0.5s ease;
        }

        /* --- –ò–ù–§–û –ë–ê–ù–ù–ï–† --- */
        .info-banner {
            margin: 16px;
            background: linear-gradient(145deg, #2c2c2e, #1c1c1e);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            box-sizing: border-box;
            width: calc(100% - 32px);
            /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ */
            content-visibility: auto; 
        }

        .info-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 20px;
            flex-shrink: 0;
        }

        .info-text h3 {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 700;
            color: #fff;
        }

        .info-text p {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* –ü–ª–∞—à–∫–∞ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä–æ–ø" –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫–µ–π—Å–∞ */
.case-info-overlay {
    position: absolute;
    top: 80%; /* –ù–∞—á–∞–ª–æ –ª–∏–Ω–∏–∏ (–Ω–∞—Å—Ç—Ä–æ–π –∫–∞–∫ —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è) */
    left: 0;
    right: 0;
    
    /* –ú–∞–≥–∏—è: —Ç—è–Ω–µ–º –ª–∏–Ω–∏—é –¥–∞–ª–µ–∫–æ –≤–Ω–∏–∑, –æ–Ω–∞ –æ–±—Ä–µ–∂–µ—Ç—Å—è –∫—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ */
    bottom: -200px; 
    
    background: rgba(0, 0, 0, 0.6); 
    backdrop-filter: blur(2px);
    color: var(--primary-color);
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    text-align: center;
    padding-top: 8px; /* –û—Ç—Å—Ç—É–ø —Ç–µ–∫—Å—Ç–∞ –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è –ª–∏–Ω–∏–∏ */
    
    /* –°–ª–æ–π —Å—Ç–∞–≤–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –±—ã–ª–∏ –≤—ã—à–µ */
    z-index: 1; 
    
    pointer-events: none; 
    letter-spacing: 0.5px;
}
        
/* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏/–Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∫–µ–π—Å–∞ */
.shop-item:active .case-info-overlay {
    background: rgba(255, 204, 0, 0.8);
    color: #000;
}

        /* --- –ü–ê–†–¢–ù–ï–†–´ (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û –ù–ê CSS) --- */
        .partners-wrapper {
            width: 100%;
            overflow: hidden;
            margin-top: 5px;
            padding-bottom: 15px;
            position: relative;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            touch-action: pan-x;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è CSS –∞–Ω–∏–º–∞—Ü–∏–∏ */
        .partners-track {
            display: flex;
            gap: 10px;
            padding: 0 16px;
            width: max-content; /* –®–∏—Ä–∏–Ω–∞ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É */
            /* GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ */
            will-change: transform;
            /* –ê–Ω–∏–º–∞—Ü–∏—è */
            animation: scroll-partners 30s linear infinite;
        }
        
        /* –ü–∞—É–∑–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∏–ª–∏ —Ç–∞—á–µ */
        .partners-wrapper:active .partners-track,
        .partners-wrapper:hover .partners-track {
            animation-play-state: paused;
        }

        @keyframes scroll-partners {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); } /* –°–¥–≤–∏–≥–∞–µ–º –Ω–∞ 50%, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ç–µ–Ω—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω */
        }

        .partner-card {
            flex: 0 0 auto;
            width: 260px;
            min-width: 260px;
            background: #1c1c1e;
            border-radius: 14px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer;
            /* –£–±—Ä–∞–ª–∏ transform –æ—Ç—Å—é–¥–∞, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Ç—Ä–µ–∫–∞ */
        }

        .partner-card.topskin {
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.15) 0%, rgba(255, 87, 34, 0.05) 100%);
            border-color: rgba(255, 87, 34, 0.3);
        }
        .partner-card.xplay {
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            border-color: #555;
        }

        .partner-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            padding: 2px;
        }

        .partner-logo-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        .partner-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            pointer-events: none;
            align-items: center;
            text-align: center;
            flex-grow: 1;
        }

        .partner-title {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .partner-desc {
            font-size: 10px;
            color: #b0b0b0;
            line-height: 1.3;
            text-align: center;
        }

        .partner-highlight {
            color: #fff;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 10px;
            vertical-align: middle;
        }

        .hot-badge { font-size: 9px; background: #ffcc00; color: #000; padding: 1px 5px; border-radius: 4px; font-weight: 800; text-transform: uppercase; }

        .copy-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 2px 5px;
            font-size: 11px;
            margin-left: 2px;
            pointer-events: auto;
        }

        /* --- –°–ï–¢–ö–ê –¢–û–í–ê–†–û–í --- */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 0 16px;
            margin-top: 5px;
            width: 100%;
            box-sizing: border-box;
            padding-bottom: calc(180px + env(safe-area-inset-bottom));
            /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ */
            content-visibility: auto; 
            contain-intrinsic-size: 1000px; /* –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        }

        .shop-item {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.1s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
            min-width: 0;
            /* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ */
            will-change: transform; 
        }
        .shop-item:active { transform: scale(0.98); }

        .item-image-wrapper {
            width: 100%;
            padding-top: 100%;
            position: relative;
            background: #141416;
            cursor: pointer;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) */
        .item-image {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            object-fit: contain; /* –í–∞–∂–Ω–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∏—Å—å */
            border-radius: 8px;
            opacity: 0;
            /* –£—Å–∫–æ—Ä—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è */
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            
            /* --- –§–ò–ö–° –î–õ–Ø –ü–ö (–£–±–∏—Ä–∞–µ—Ç —Ä–µ–∑–∫–æ—Å—Ç—å/–ª–µ—Å–µ–Ω–∫—É) --- */
            transform: translateZ(0); /* –í–∫–ª—é—á–∞–µ—Ç GPU —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ */
            backface-visibility: hidden;
            image-rendering: -webkit-optimize-contrast; /* –õ—É—á—à–µ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –≤ Chrome */
            will-change: opacity; /* –°–æ–æ–±—â–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É, —á—Ç–æ –±—É–¥–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—è */
        }

        .item-image.loaded { opacity: 1; }

        /* --- –°–¢–ò–õ–¨ –¢–û–õ–¨–ö–û –î–õ–Ø –ö–ï–ô–°–û–í (–ë–û–õ–¨–®–ê–Ø –ö–ê–†–¢–ò–ù–ö–ê) --- */
        /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–µ–π—Å–æ–≤ */
/* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–µ–π—Å–æ–≤ (–ë–ï–ó –°–í–ï–ß–ï–ù–ò–Ø + –ü–û–î–ù–Ø–¢ –í–´–®–ï) */
.item-image.case-zoom {
    width: 100% !important;
    height: 100% !important;
    top: 0 !important;
    left: 0 !important;
    padding: 0 !important;
    border-radius: 12px;
    object-fit: contain;
    
    /* --- –õ–û–ì–ò–ö–ê –†–ê–ó–ú–ï–†–ê –ò –ü–û–ó–ò–¶–ò–ò --- */
    /* scale(1.4) -> –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞ 40%.
       translateY(-15px) -> –°–¥–≤–∏–≥ –í–í–ï–†–• –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –Ω–∞ 15px. 
       üëâ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –µ—â–µ –≤—ã—à–µ ‚Äî —Å—Ç–∞–≤—å -20px –∏–ª–∏ -25px. 
       üëâ –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–æ ‚Äî —Å—Ç–∞–≤—å -5px –∏–ª–∏ -10px.
    */
    transform: scale(1.4) translateY(-15px); 
    
    /* –¢–æ—á–∫–∞, –æ—Ç–∫—É–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–æ—Å—Ç (–æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∞, —Ç–æ –µ—Å—Ç—å –æ—Ç —Ç–µ–∫—Å—Ç–∞) */
    transform-origin: top center; 
    
    margin-top: 0; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ —Å–≤–µ—Ä—Ö—É */

    /* --- –£–ë–†–ê–õ–ò –ñ–ï–õ–¢–£–Æ –ü–û–î–°–í–ï–¢–ö–£ --- */
    /* filter: drop-shadow(0 0 15px rgba(255, 204, 0, 0.2)); <--- –≠–¢–£ –°–¢–†–û–ö–£ –ú–´ –£–î–ê–õ–ò–õ–ò */
    filter: none; /* –Ø–≤–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã */
    box-shadow: none; /* –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –≤—ã–∫–ª—é—á–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Ç–µ–Ω–∏ */

    transition: transform 0.3s ease; /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ */
}
        .item-info {
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            gap: 4px;
            text-align: center;
            z-index: 8; /* –≠—Ç–æ—Ç —Å–ª–æ–π –≤—ã—à–µ, —á–µ–º –ª–∏–Ω–∏—è (1) */
        }

        .item-title {
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            line-height: 1.2;
            min-height: 34px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-transform: capitalize;
            text-align: center;
        }

        .item-subtitle {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 500;
            display: block;
            margin-top: 2px;
        }

        .item-meta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .item-stock { color: var(--text-secondary); }
        .item-stock.out { color: #ff453a; }

        .item-price {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 13px;
        }

        .action-btn {
            margin-top: auto;
            width: 100%;
            height: 34px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            z-index: 500; /* –ö–Ω–æ–ø–∫–∏ –Ω–∞ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É */
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-buy {
            background: var(--primary-gradient);
            color: #000;
            box-shadow: 0 2px 10px rgba(255, 204, 0, 0.2);
        }

        .btn-folder {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-disabled {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        /* --- LIGHTBOX --- */
        .image-modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease; /* –£—Å–∫–æ—Ä–∏–ª–∏ */
            backdrop-filter: blur(10px);
            touch-action: none;
        }
        .image-modal-overlay.open { display: flex; opacity: 1; }

        .modal-image-container {
            position: relative;
            width: 90%;
            max-width: 500px;
        }
        .modal-full-image {
            width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .modal-close-btn {
            position: absolute;
            top: -50px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- SKELETON (–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è) --- */
        .skeleton {
            background: #2c2c2e; /* –°—Ç–∞—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω –ª–µ–≥—á–µ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ */
            border-radius: 12px;
            height: 220px;
            position: relative;
            overflow: hidden;
        }
        /* –ë–ª–∏–∫ —á–µ—Ä–µ–∑ –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å –≤–µ—Å—å –±–ª–æ–∫ */
        .skeleton::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transform: translateX(-100%);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }

        .empty-msg {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
            font-size: 14px;
        }

        /* --- –§–£–¢–ï–† --- */
        .app-footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: rgba(28, 28, 30, 0.95); /* –ú–µ–Ω—å—à–µ –±–ª—é—Ä–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
            padding-top: 8px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            box-sizing: border-box;
            height: auto;
            touch-action: none;
        }

        .footer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #8E8E93;
            text-decoration: none;
            flex: 1;
            cursor: pointer;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 10px;
            line-height: 1;
            font-weight: 500;
            transition: color 0.1s ease; /* –£–±—Ä–∞–ª–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ */
        }

        /* --- –ü–†–ï–í–¨–Æ –í–´–ë–†–ê–ù–ù–û–ì–û –ö–ï–ô–°–ê --- */
        .case-preview-card {
            background: linear-gradient(145deg, #252525, #1a1a1a);
            border: 1px solid rgba(255, 204, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        .case-preview-card.visible {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
            z-index: 2;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
            z-index: 2;
        }

        .preview-price {
            font-size: 14px;
            color: #ffd700;
            font-weight: 600;
            background: rgba(255, 204, 0, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            z-index: 2;
        }

        .footer-item .icon-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            font-size: 22px;
            position: relative;
        }
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ë–ê–õ–ê–ù–°–ê --- */
        .balance-display {
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            user-select: none;
        }
        
        .balance-display:active {
            transform: scale(0.96);
            background: rgba(255, 204, 0, 0.2);
        }

        .refresh-icon {
            font-size: 12px;
            opacity: 0.8;
            transition: transform 0.5s ease;
        }

        /* --- –ù–û–í–´–ï –ö–ù–û–ü–ö–ò –î–õ–Ø –ö–ï–ô–°–û–í --- */
/* --- –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ô –í–ò–ó–£–ê–õ –î–õ–Ø –ö–ï–ô–°–û–í --- */
        .case-top-title {
            padding: 12px 10px 0 10px; /* –û—Ç—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å–≤–µ—Ä—Ö—É */
            font-size: 13px;
            font-weight: 800;
            color: #fff;
            text-align: center;
            text-transform: uppercase;
            min-height: auto; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω—é—é –≤—ã—Å–æ—Ç—É */
            line-height: 1.1;
        }

        .case-top-title .item-subtitle {
            font-size: 11px;
            color: var(--primary-color); /* –°–¥–µ–ª–∞–µ–º –ø—Ä–∏–ø–∏—Å–∫—É —è—Ä—á–µ */
            font-weight: 700;
            margin-top: 4px;
        }

        .case-img-wrap {
            padding-top: 80%; /* –°–∂–∏–º–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫–∏, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–Ω—è–ª–∏—Å—å –≤—ã—à–µ */
            background: radial-gradient(circle at center, rgba(255, 204, 0, 0.05) 0%, transparent 70%); /* –ö—Ä–∞—Å–∏–≤–æ–µ –ª–µ–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å–µ—Ä–æ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞ */
        }

        .case-buttons-wrapper {
            padding: 0 10px 12px 10px; /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ (—Å–Ω–∏–∑—É –±–æ–ª—å—à–µ) */
            display: flex;
            flex-direction: column;
            margin-top: auto;
        }

        .case-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 6px; /* –†–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
            width: 100%;
        }

        .btn-buy-tickets {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            box-shadow: 0 2px 10px rgba(37, 117, 252, 0.2);
            /* margin-top —É–±—Ä–∞–ª–∏, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç gap */
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø WIN SCREEN --- */

/* –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ (—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è/—Å–∏–Ω—è—è) */
.btn-sell-tickets {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
    margin-top: 10px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–∫–∏ –ó–∞–±—Ä–∞—Ç—å */
    border: 1px solid rgba(255,255,255,0.1);
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∏–∂–Ω–µ–≥–æ —Ä—è–¥–∞ –∫–Ω–æ–ø–æ–∫ */
.win-actions-row {
    display: flex;
    gap: 10px;
    width: 100%;
    max-width: 280px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
    margin-top: 15px;
    justify-content: space-between;
}

/* –ú–∞–ª–µ–Ω—å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ (–ü—Ä–æ—Ñ–∏–ª—å / –ó–∞–∫—Ä—ã—Ç—å) */
.btn-secondary-action {
    flex: 1; /* –†–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ */
    background: rgba(255, 255, 255, 0.08);
    color: #8E8E93;
    border: 1px solid rgba(255, 255, 255, 0.05);
    height: 36px; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö */
    font-size: 11px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-secondary-action:active {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
    transform: scale(0.96);
}

/* –ò–∫–æ–Ω–∫–∞ –±–∏–ª–µ—Ç–∞ */
.ticket-icon {
    color: #bdecff; /* –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π –¥–ª—è –±–∏–ª–µ—Ç–∞ */
    margin-left: 4px;
}
        
        .refresh-icon.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .footer-item:active { color: #ffffff; }

        .footer-item.active { color: #FFFFFF; }
        .footer-item.active .icon-wrapper {
            color: #34c759;
            text-shadow: 0 0 10px rgba(52, 199, 89, 0.4);
        }
        /* --- –û–ö–ù–û –ó–ê–ì–†–£–ó–ö–ò –ü–û–ö–£–ü–ö–ò --- */
        .purchase-loader {
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            backdrop-filter: blur(5px);      /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
            z-index: 21000;                 /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: none;                  /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        
        .purchase-loader.active {
            display: flex;
        }

        .loader-spinner {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        .loader-text {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* --- –ö–û–ù–¢–ï–ô–ù–ï–† (–¶–ï–ù–¢–†–ò–†–û–í–ê–ù–ò–ï) --- */
        /* –≠—Ç–æ—Ç –±–ª–æ–∫ –¥–µ—Ä–∂–∏—Ç –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—é –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–Ω–∏–∑—É */
        .admin-wrapper {
            position: fixed;
            /* –ë—ã–ª–æ 30px. –°—Ç–∞–≤–∏–º 90px, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –ù–ê–î —Ñ—É—Ç–µ—Ä–æ–º */
            bottom: calc(90px + env(safe-area-inset-bottom)); 
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 12px;
        }

        /* --- –ê–î–ú–ò–ù –ú–ï–ù–Æ (FAB) --- */
        .admin-fab-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
            background: rgba(28, 28, 30, 0.4); 
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5); /* –ë–ª–µ–¥–Ω—ã–π —Ü–≤–µ—Ç –∏–∫–æ–Ω–∫–∏ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            /* flex-shrink: 0 –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Å–ø–ª—é—â–∏—Ç—Å—è */
            flex-shrink: 0; 
        }

        .admin-fab-btn:active { 
            transform: scale(0.9); 
            background: rgba(255, 204, 0, 0.2); 
            color: #ffcc00; 
        }

        .admin-fab-btn.toggle.active {
            transform: rotate(180deg);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* --- –°–ö–†–´–¢–´–ï –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ --- */
        .admin-menu-items {
            display: flex;
            flex-direction: column; /* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥—Ä—É–≥ –Ω–∞–¥ –¥—Ä—É–≥–æ–º */
            gap: 8px;
            opacity: 0;
            transform: translateY(10px); /* –ù–µ–±–æ–ª—å—à–æ–π —Å–¥–≤–∏–≥ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
            pointer-events: none;
            transition: all 0.3s ease;
            align-items: center;
        }

        .admin-menu-items.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .admin-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 69, 58, 0.2); /* –ö—Ä–∞—Å–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ */
            color: #ff453a;
            border: 1px solid rgba(255, 69, 58, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: transform 0.2s;
        }

        .admin-action-btn:hover {
            transform: scale(1.1);
        }

        /* --- –ö–ê–°–¢–û–ú–ù–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–ê–†–û–õ–Ø --- */
        .custom-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .custom-modal-overlay.active { opacity: 1; pointer-events: auto; }

        .pass-modal {
            background: #1c1c1e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 80%;
            max-width: 300px;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        .custom-modal-overlay.active .pass-modal { transform: scale(1); }

        .pass-input {
            width: 100%;
            background: #2c2c2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            color: #fff;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
            outline: none;
            box-sizing: border-box; 
        }
        .pass-input:focus { border-color: #ffcc00; } /* –î–æ–±–∞–≤–∏–ª —Ü–≤–µ—Ç —Ñ–æ–∫—É—Å–∞, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ—Ç */

        .modal-buttons { display: flex; gap: 10px; justify-content: center; }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-cancel { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .btn-confirm { background: linear-gradient(45deg, #ffcc00, #ff9500); color: #000; } /* –ó–∞–º–µ–Ω–∏–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –Ω–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ */
        /* --- –°–¢–ò–õ–ò –î–õ–Ø P2P –°–ò–°–¢–ï–ú–´ --- */
        /* --- PREMIUM P2P MODAL DESIGN --- */

        /* –§–æ–Ω –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Å —Ä–∞–∑–º—ã—Ç–∏–µ–º */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); /* –ß—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ, —á—Ç–æ–±—ã –≤–∏–¥–Ω–æ –±–ª—é—Ä */
            backdrop-filter: blur(12px);      /* –≠—Ñ—Ñ–µ–∫—Ç –º–∞—Ç–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞ */
            -webkit-backdrop-filter: blur(12px);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –º–æ–¥–∞–ª–∫–∏ */
        .modal-content {
            background: #1c1c1e;
            width: 90%;
            max-width: 360px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            padding: 24px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transform: scale(1);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            /* üëáüëáüëá –î–û–ë–ê–í–õ–ï–ù–û –î–õ–Ø –°–ö–†–û–õ–õ–ê üëáüëáüëá */
            max-height: 85vh;       /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É 85% –æ—Ç —ç–∫—Ä–∞–Ω–∞ */
            overflow-y: auto;       /* –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
            -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ iPhone */
        }

        .modal.hidden .modal-content {
            transform: scale(0.95);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .modal-header h3 {
            margin: 0;
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .close-modal {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .close-modal:active { background: rgba(255,255,255,0.3); }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ (Input & Select) */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            color: #8E8E93;
            font-weight: 500;
            margin-left: 4px;
        }

        .p2p-input, .p2p-select {
            width: 100%;
            background: #2c2c2e;
            border: 1px solid rgba(255,255,255,0.05);
            color: #fff;
            padding: 14px 16px;
            border-radius: 14px;
            font-size: 16px;
            outline: none;
            appearance: none; /* –£–±–∏—Ä–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ */
            -webkit-appearance: none;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .p2p-input:focus, .p2p-select:focus {
            border-color: #ffcc00;
            background: #3a3a3c;
        }

        /* –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –¥–ª—è Select */
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: '\f078'; /* FontAwesome chevron-down */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #8E8E93;
            pointer-events: none;
            font-size: 12px;
        }

        /* –ë–ª–æ–∫ —Å —Ä–∞—Å—á–µ—Ç–æ–º (Summary Card GREEN) */
        .summary-card {
            background: rgba(46, 204, 113, 0.1); /* –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω */
            border: 1px solid rgba(46, 204, 113, 0.2); /* –ó–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        .summary-row.total {
            margin-top: 4px;
            padding-top: 8px;
            border-top: 1px solid rgba(46, 204, 113, 0.2); /* –ó–µ–ª–µ–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
            color: #fff;
            font-weight: 600;
            font-size: 16px;
        }

        /* –í–ê–ñ–ù–û: –ó–µ–ª–µ–Ω—ã–µ —Ü–∏—Ñ—Ä—ã */
        .mono-num {
            font-family: -apple-system, BlinkMacSystemFont, "SF Mono", "Roboto Mono", monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
            color: #2ecc71; /* –Ø—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π —Ç–µ–∫—Å—Ç */
            font-weight: 700;
        }

        /* –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-section {
            margin-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
        }
        .history-title {
            font-size: 14px;
            color: #fff;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .history-list {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        /* --- –ü–†–ï–ú–ò–£–ú –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ë–û–¢–ï --- */
        .bot-connect-banner {
            background: rgba(42, 171, 238, 0.15); /* –ì–æ–ª—É–±–æ–π —Ñ–æ–Ω */
            border: 1px solid rgba(42, 171, 238, 0.3); /* –ì–æ–ª—É–±–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(42, 171, 238, 0.05);
        }
                
        .bot-connect-banner:active {
            transform: scale(0.98);
        }

        .bot-icon-box {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2AABEE, #229ED9); /* –ì—Ä–∞–¥–∏–µ–Ω—Ç Telegram */
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(42, 171, 238, 0.3);
        }

        .bot-text-box h4 {
            margin: 0;
            font-size: 14px;
            color: #ffffff;
            font-weight: 700;
        }

        .bot-text-box p {
            margin: 4px 0 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* --- –ü–£–õ–¨–°–ò–†–£–Æ–©–ê–Ø –ö–ù–û–ü–ö–ê –ê–ö–¢–ò–í–ù–û–ì–û –¢–†–ï–ô–î–ê --- */
        /* –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å .premium-exchange-btn —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é */
        .p2p-history-btn.has-active-trade,
        .premium-exchange-btn.has-active-trade {
            background: linear-gradient(135deg, #ff3b30, #ff9500);
            /* border: none; –£–±–∏—Ä–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å */
            color: white;
            /* font-weight: 800; –£–±–∏—Ä–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å –∂–∏—Ä–Ω–æ—Å—Ç—å —à—Ä–∏—Ñ—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ */
            animation: premiumPulse 2s infinite;
            box-shadow: 0 0 20px rgba(255, 59, 48, 0.4);
        }

        /* –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ç—Ä–µ–π–¥–µ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –Ω–∞ –±–µ–ª—ã–π */
        .premium-exchange-btn.has-active-trade .p2p-subtitle {
            color: rgba(255, 255, 255, 0.9);
        }

        @keyframes premiumPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); transform: scale(1); }
        }

        /* --- –ö–ê–†–¢–û–ß–ö–ê –ê–ö–¢–ò–í–ù–û–ì–û –¢–†–ï–ô–î–ê –í –ò–°–¢–û–†–ò–ò --- */
        .active-trade-card {
            border: 1px solid #ffcc00 !important;
            background: rgba(255, 204, 0, 0.05) !important;
            position: relative;
            overflow: hidden;
        }

        .active-trade-card::before {
            content: "REQUIRE ACTION";
            position: absolute;
            top: 10px;
            right: -30px;
            background: #ffcc00;
            color: #000;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 30px;
            transform: rotate(45deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –ò–°–¢–û–†–ò–ò –ò –í–¢–û–†–û–ì–û –û–ö–ù–ê --- */

        /* –ö–Ω–æ–ø–∫–∞-—Å—Ç–∞—Ç—É—Å (—É–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞) */
        .history-status-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #8E8E93;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ: –ê–ö–¢–ò–í–ù–´–ô –¢–†–ï–ô–î (–ü—É–ª—å—Å–∞—Ü–∏—è) */
        .history-status-btn.active-trade {
            background: linear-gradient(135deg, #ffcc00 0%, #ff9500 100%);
            color: #000;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 204, 0, 0.3);
            animation: statusPulse 2s infinite;
        }

        .history-status-btn.active-trade .btn-icon {
            background: rgba(0,0,0,0.2);
            color: #fff;
        }

        @keyframes statusPulse {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 204, 0, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 4px 25px rgba(255, 204, 0, 0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 204, 0, 0.3); }
        }

        /* –ò–∫–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
        .btn-icon {
            width: 24px; height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* --- –í–¢–û–†–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (Z-INDEX –í–´–®–ï) --- */
        .history-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); /* –¢–µ–º–Ω–µ–µ —Ñ–æ–Ω */
            backdrop-filter: blur(5px);
            z-index: 10005; /* –í–ê–ñ–ù–û: –í—ã—à–µ —á–µ–º –æ–±—ã—á–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ */
            display: flex;
            align-items: flex-end; /* –í—ã–µ–∑–∂–∞–µ—Ç —Å–Ω–∏–∑—É –∏–ª–∏ —Ü–µ–Ω—Ç—Ä */
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .history-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .history-modal-content {
            background: #1c1c1e;
            width: 100%;
            height: 80vh; /* –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –ø–æ—á—Ç–∏ */
            border-radius: 20px 20px 0 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }

        .history-modal.active .history-modal-content {
            transform: translateY(0);
        }

        /* --- PREMIUM P2P BUTTON --- */
        .premium-exchange-btn {
            width: 100%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border: none;
            border-radius: 16px;
            /* –¢–≤–æ–π –ª—é–±–∏–º—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç, –Ω–æ —Å –±–æ–ª—å—à–µ–π –≥–ª—É–±–∏–Ω–æ–π */
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 20px rgba(37, 117, 252, 0.3); /* –¶–≤–µ—Ç–Ω–∞—è —Ç–µ–Ω—å (glow) */
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            text-align: left;
        }

        .premium-exchange-btn:active {
            transform: scale(0.98);
            box-shadow: 0 4px 10px rgba(37, 117, 252, 0.2);
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –±–ª–∏–∫–∞ (Shine) */
        .premium-exchange-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-20deg);
            animation: shine 4s infinite; /* –ë–ª–∏–∫ –ø—Ä–æ–±–µ–≥–∞–µ—Ç –∫–∞–∂–¥—ã–µ 4 —Å–µ–∫—É–Ω–¥—ã */
        }

        @keyframes shine {
            0% { left: -100%; }
            20% { left: 200%; } /* –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–ª–µ—Ç */
            100% { left: 200%; } /* –ü–∞—É–∑–∞ */
        }

        /* –õ–µ–≤–∞—è —á–∞—Å—Ç—å (–ò–∫–æ–Ω–∫–∞) */
        .p2p-icon-box {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #fff;
            margin-right: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* –¶–µ–Ω—Ç—Ä (–¢–µ–∫—Å—Ç) */
        .p2p-text-box {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            z-index: 2; /* –ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –Ω–∞–¥ –±–ª–∏–∫–æ–º */
        }

        .p2p-title {
            font-size: 15px;
            font-weight: 800;
            color: #fff;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .p2p-subtitle {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å (–°—Ç—Ä–µ–ª–∫–∞) */
        .p2p-arrow {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-left: 10px;
        }

        /* –°–ø–∏—Å–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
            padding-bottom: 30px;
        }
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ô –õ–û–ê–î–ï–† --- */
        .global-loader-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-color);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .global-loader-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .spinner-container {
            width: 50px; /* –ó–∞–¥–∞–µ–º —è–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É */
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            filter: drop-shadow(0 0 10px rgba(255, 204, 0, 0.4));
        }

        .spinner-container i {
            font-size: 40px;
            display: block; /* –í–ê–ñ–ù–û: –±–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ –∫—Ä—É—Ç–∏—Ç—Å—è! */
            will-change: transform; /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –±—Ä–∞—É–∑–µ—Ä—É */
            animation: global-spin 1s linear infinite !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ */
        }

        @keyframes global-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- [NEW] –°–¢–ò–õ–ò –î–õ–Ø –†–£–õ–ï–¢–ö–ò (–í–°–¢–ê–í–õ–ï–ù–û –Æ–í–ï–õ–ò–†–ù–û) --- */
        /* --- [NEW] –°–¢–ò–õ–ò –î–õ–Ø –†–£–õ–ï–¢–ö–ò (–¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø DAILY CHALLENGE) --- */
        .r-modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 10006; 
            display: none; justify-content: center; align-items: center; 
            flex-direction: column; backdrop-filter: blur(10px); 
        }
        .r-game-area { 
            width: 100%; height: 200px; position: relative; overflow: hidden; 
            border-top: 1px solid #333; border-bottom: 1px solid #333; 
            background: rgba(20,20,20,0.5); margin: 20px 0;
        }
        .r-track { display: flex; height: 100%; align-items: center; will-change: transform; }
        
        .r-card { 
            width: 140px; height: 140px; margin: 0 4px; background: #1a1b20; 
            border-radius: 8px; flex-shrink: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            border-bottom: 3px solid transparent; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
        }
        .r-card img { width: 100px; height: 70px; object-fit: contain; }
        .r-card-name { 
            font-size: 10px; color: #ccc; text-align: center; 
            max-width: 90%; overflow: hidden; text-overflow: ellipsis; 
            white-space: nowrap; margin-top: 10px;
        }
        
        .r-marker { 
            position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; 
            background: #ffd700; transform: translateX(-50%); z-index: 10; 
            box-shadow: 0 0 10px #ffd700; 
        }

        /* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ 1–≤1 –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ */
        .r-blue { border-color: #4b69ff; background: radial-gradient(circle, rgba(75,105,255,0.1), #1a1b20); }
        .r-purple { border-color: #8847ff; background: radial-gradient(circle, rgba(136,71,255,0.1), #1a1b20); }
        .r-pink { border-color: #d32ce6; background: radial-gradient(circle, rgba(211,44,230,0.1), #1a1b20); }
        .r-red { border-color: #eb4b4b; background: radial-gradient(circle, rgba(235,75,75,0.1), #1a1b20); }
        .r-gold { border-color: #ffd700; background: radial-gradient(circle, rgba(255,215,0,0.1), #1a1b20); }

        .win-screen { 
            display: none; 
            width: 100%;
            text-align: center; 
            animation: fadeIn 0.5s; 
            padding: 20px; 
            box-sizing: border-box;
            /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
            flex-direction: column;
            align-items: center;
        }
        .win-img { width: 180px; filter: drop-shadow(0 0 30px rgba(255,215,0,0.5)); animation: float 3s infinite ease-in-out; }
        
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–†–ê–°–ò–í–û–ì–û –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø (–ò–ó PROFILE) --- */
.custom-confirm-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 20000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
}

.custom-confirm-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.custom-confirm-box {
    background: #1c1c1e;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 24px;
    width: 85%;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    transform: scale(0.9);
    transition: transform 0.2s ease;
}

.custom-confirm-overlay.visible .custom-confirm-box {
    transform: scale(1);
}

.confirm-title {
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 8px 0;
    line-height: 1.3;
}

.confirm-subtitle {
    color: #8E8E93;
    font-size: 13px;
    margin: 0 0 20px 0;
    line-height: 1.4;
}

.confirm-buttons {
    display: flex;
    gap: 12px;
}

.confirm-btn {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: opacity 0.2s;
}
.confirm-btn:active { opacity: 0.8; }

.btn-cancel-modal {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

/* –ñ–µ–ª—Ç–∞—è –∫–Ω–æ–ø–∫–∞ (—Å—Ç–∏–ª—å –º–∞–≥–∞–∑–∏–Ω–∞) */
.btn-yellow-modal {
    background: #ffcc00;
    color: #000;
    box-shadow: 0 2px 10px rgba(255, 204, 0, 0.2);
}

/* –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ (–¥–ª—è –ø—Ä–æ–¥–∞–∂–∏) */
.btn-purple-modal {
    background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
    color: #fff;
    box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* --- –ö–ù–û–ü–ö–ê "–ß–¢–û –í–ù–£–¢–†–ò" (INFO) –ù–ê –ö–ï–ô–°–ï --- */
.info-btn-case {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    z-index: 10; /* –ü–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
    transition: all 0.2s;
}

.info-btn-case:active {
    background: var(--primary-color);
    color: #000;
    transform: scale(0.9);
}

/* --- –ú–û–î–ê–õ–ö–ê –°–û–î–ï–†–ñ–ò–ú–û–ì–û –ö–ï–ô–°–ê --- */
.case-contents-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    padding: 10px 0;
    
    /* –§–ò–ö–°–´ –°–í–ê–ô–ü–ê: */
    overflow-y: auto;      /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
    overflow-x: hidden;    /* –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
    touch-action: pan-y;   /* –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –∂–µ—Å—Ç—ã (–ø–∞–ª–µ—Ü –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑) */
    
    padding-bottom: 20px;
    width: 100%;
    box-sizing: border-box; /* –ß—Ç–æ–±—ã –æ—Ç—Å—Ç—É–ø—ã –Ω–µ —Ä–∞—Å–ø–∏—Ä–∞–ª–∏ —à–∏—Ä–∏–Ω—É */
}

/* –ê–¥–∞–ø—Ç–∏–≤: –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö –ø–æ—à–∏—Ä–µ –¥–µ–ª–∞–µ–º 4 –≤ —Ä—è–¥ */
@media (min-width: 380px) {
    .case-contents-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.content-item {
    background: #252525;
    border-radius: 8px;
    padding: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    border-bottom: 2px solid transparent;
}

.content-item img {
    width: 100%;
    height: 50px;
    object-fit: contain;
    margin-bottom: 4px;
}

.content-name {
    font-size: 9px;
    color: #ddd;
    line-height: 1.1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 20px; /* –§–∏–∫—Å –≤—ã—Å–æ—Ç—ã */
}

.content-quality {
    font-size: 8px;
    color: #888;
    margin-top: 2px;
    background: rgba(255,255,255,0.05);
    padding: 1px 4px;
    border-radius: 4px;
}

/* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ (—Å–Ω–∏–∑—É –∫–∞—Ä—Ç–æ—á–∫–∏) */
.content-item.blue { border-bottom-color: var(--rarity-blue); }
.content-item.purple { border-bottom-color: var(--rarity-purple); }
.content-item.pink { border-bottom-color: var(--rarity-pink); }
.content-item.red { border-bottom-color: var(--rarity-red); }
.content-item.gold { border-bottom-color: var(--rarity-gold); }

/* –¶–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ –≤ –æ–∫–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
#custom-confirm-btn[style*="#34c759"] { color: #000 !important; }
#custom-confirm-btn[style*="#ff3b30"] { color: #fff !important; }
        
    </style>
</head>
<body>

    <div id="global-loader" class="global-loader-overlay">
        <div class="spinner-container">
            <i class="fa-solid fa-circle-notch"></i>
        </div>
    </div>

    <div id="r-modal" class="r-modal-overlay">
        <div id="r-area" class="r-game-area">
            <div class="r-marker"></div>
            <div class="r-track" id="r-track"></div>
        </div>
        <div id="r-win" class="win-screen">
    </div>
    </div>

    <div class="shop-header">
    <a href="#" id="header-back-btn" class="back-btn">
        <i class="fa-solid fa-chevron-left"></i> <span id="nav-title">–ù–∞–∑–∞–¥</span>
    </a>
        
    <div class="balances-wrapper">
        <div class="balance-pill coins" onclick="checkBalance(true)">
            <span id="user-balance">...</span> 
            <i class="fa-solid fa-coins"></i>
            <i class="fa-solid fa-rotate refresh-icon" id="refresh-icon" style="margin-left: 2px;"></i>
        </div>
        <div class="balance-pill tickets" onclick="checkBalance(true)">
            <span id="user-tickets">0</span> 
            <i class="fa-solid fa-ticket"></i>
            <i class="fa-solid fa-rotate refresh-icon" id="refresh-icon-tickets" style="margin-left: 2px;"></i>
        </div>
    </div>
</div>

<div class="info-banner">
    <div class="info-icon">
        <i class="fa-solid fa-gem"></i>
    </div>
    <div class="info-text">
        <h3>–ú–∞–≥–∞–∑–∏–Ω –ù–∞–≥—Ä–∞–¥</h3>
        <p>–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –º–æ–Ω–µ—Ç—ã –≤ —á–µ–ª–ª–µ–Ω–¥–∂–∞—Ö –∏ –æ–±–º–µ–Ω–∏–≤–∞–π –∏—Ö –Ω–∞ –∫—Ä—É—Ç—ã–µ —Ç–æ–≤–∞—Ä—ã.</p>
    </div>
</div>

<div class="partners-wrapper">
    <div class="partners-track" id="partners-track">
        <a href="#" onclick="openPartnerLink('https://topskin.run')" class="partner-card topskin">
            <div class="partner-icon">
                <img src="https://i.postimg.cc/mZJjxLFf/FASTCUP-Top-Skin-Cup-allmode.png" loading="eager" alt="Topskin" class="partner-logo-img">
            </div>
            <div class="partner-info">
                <div class="partner-title">Topskin <span class="hot-badge">Promo</span></div>
                <div class="partner-desc">
                    –ö–æ–¥: <span class="partner-highlight">HATElove</span>
                    <button class="copy-btn" onclick="copyCode(event, 'HATElove')"><i class="fa-regular fa-copy"></i></button>
                    <br>–ü–æ–ª—É—á–∏ –∫—ç—à–±–µ–∫ –≤ —Ä—É—á–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏—è—Ö!
                </div>
            </div>
        </a>
            
            
            <a href="#" onclick="openPartnerLink('https://xplay.gg/ref/hatelove')" class="partner-card xplay">
                <div class="partner-icon">
                    <img src="https://i.postimg.cc/gJXWJccF/0x0.png" loading="eager" alt="Xplay" class="partner-logo-img">
                </div>
                <div class="partner-info">
                    <div class="partner-title">Xplay.gg <span class="hot-badge">Game</span></div>
                    <div class="partner-desc">–ü–æ–ª—É—á–∏ <span class="partner-highlight">10 –º–æ–Ω–µ—Ç</span><br>–≤ –∑–∞–¥–∞–Ω–∏—è—Ö –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é!</div>
                </div>
            </a>
        </div>
    </div>

    <div class="shop-actions" style="padding: 0 16px;">
    <button onclick="openP2PModal()" class="premium-exchange-btn" id="open-p2p-modal-btn">
        <div class="p2p-icon-box">
            <i class="fa-solid fa-arrow-right-arrow-left"></i>
        </div>
        
        <div class="p2p-text-box">
            <span class="p2p-title">Trade-In</span>
            <span class="p2p-subtitle">–û–±–º–µ–Ω –∫–µ–π—Å–æ–≤ –Ω–∞ üü°</span>
        </div>

        <div class="p2p-arrow">
            <i class="fa-solid fa-chevron-right"></i>
        </div>
    </button>
</div>

    <div id="shop-grid" class="shop-grid"></div>

    <div id="image-modal" class="image-modal-overlay" onclick="closeImageModal(event)">
        <div class="modal-image-container">
            <button class="modal-close-btn" onclick="closeImageModalForce()"><i class="fa-solid fa-xmark"></i></button>
            <img id="full-image" src="" alt="Full View" class="modal-full-image">
        </div>
    </div>

    <footer class="app-footer">
        <a href="/leaderboard" class="footer-item">
            <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
            <span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span>
        </a>
        <a href="/quests" id="nav-quests" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div><span>–ó–∞–¥–∞–Ω–∏—è</span></a>
        <a href="/menu" class="footer-item">
            <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </a>
        <a href="/events" class="footer-item">
            <div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div>
            <span>–ì—Ä–∏–Ω–¥</span>
        </a>
        <a href="/auction" class="footer-item">
            <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
            <span>–ê—É–∫—Ü–∏–æ–Ω</span>
        </a>
    </footer>

    <div id="purchase-loader" class="purchase-loader">
        <i class="fa-solid fa-circle-notch loader-spinner"></i>
        <div class="loader-text">–û—Ñ–æ—Ä–º–ª—è–µ–º –ø–æ–∫—É–ø–∫—É...</div>
    </div>
    
    <div id="admin-fab" class="admin-wrapper" style="display: none;">
        <div class="admin-fab-btn toggle" onclick="toggleAdminMenu()">
            <i class="fa-solid fa-chevron-up"></i>
        </div>
        
        <div class="admin-menu-items" id="admin-menu-items">
            <div class="admin-action-btn" onclick="openPassModal()">
                <i class="fa-solid fa-trash-can"></i>
            </div>
        </div>
    </div>

    <div id="password-modal" class="custom-modal-overlay">
        <div class="pass-modal">
            <h3 style="margin: 0 0 5px 0; color: #fff;">Admin Access</h3>
            <p style="margin: 0; color: #8e8e93; font-size: 12px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</p>
            
            <input type="password" id="admin-pass-input" class="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
            
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closePassModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn btn-confirm" onclick="submitResetCache()">OK</button>
            </div>
        </div>
    </div>

    <div id="case-contents-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
        <div class="modal-header">
            <h3>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞</h3>
            <button onclick="closeContentsModal()" class="close-modal">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        
        <div id="contents-loader" style="text-align:center; padding:20px; color:#888;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∏–Ω–æ–≤...
        </div>

        <div id="case-items-list" class="case-contents-grid" style="overflow-y: auto; max-height: 70vh;">
            </div>
    </div>
</div>

<div id="p2p-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–û–±–º–µ–Ω –ö–µ–π—Å–æ–≤</h3>
            <button onclick="closeP2PModal()" class="close-modal">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
            
            <div class="bot-connect-banner" onclick="connectTelegramBot()" style="margin-bottom: 5px;">
                <div class="bot-icon-box"><i class="fa-brands fa-telegram"></i></div>
                <div class="bot-text-box">
                    <h4>–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h4>
                    <p>–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–ª —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏</p>
                </div>
                <div style="margin-left: auto; color: #fff;"><i class="fa-solid fa-chevron-right"></i></div>
            </div>

            <div class="form-group">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å</label>
                <div class="select-wrapper">
                    <select id="p2p-case-select" onchange="calculateP2P()" class="p2p-select">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>
            </div>

            <div id="case-preview" class="case-preview-card">
                <img id="preview-img" src="" class="preview-image">
                <div id="preview-name" class="preview-title">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–µ–π—Å–∞</div>
                <div class="preview-price">–¶–µ–Ω–∞: <span id="preview-price-text">0</span> üü°</div>
            </div>
            <div class="form-group">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input type="number" id="p2p-quantity" value="1" min="1" oninput="calculateP2P()" class="p2p-input" placeholder="0">
            </div>
            
            <div class="summary-card">
                <div class="summary-row">
                    <span>–¶–µ–Ω–∞ –∑–∞ 1 —à—Ç:</span>
                    <span class="mono-num"><span id="p2p-price-per-item">0</span> üü°</span>
                </div>
                <div class="summary-row total">
                    <span>–í—ã –ø–æ–ª—É—á–∏—Ç–µ:</span>
                    <span class="mono-num" style="font-size: 18px;"><span id="p2p-total">0</span> üü°</span>
                </div>
            </div>

            <button onclick="createP2PTrade()" class="action-btn btn-buy" style="height: 48px; font-size: 16px; border-radius: 14px; width: 100%;">
                –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
            </button>
            
            <button id="smart-history-btn" class="history-status-btn" onclick="openHistoryModal()">
                <span id="smart-btn-text">–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</span>
                <div class="btn-icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
            </button>
            
        </div> </div> </div> <div id="history-modal-window" class="history-modal">
    <div class="history-modal-content">
        <div class="modal-header">
            <h3>–ú–æ–∏ —Å–¥–µ–ª–∫–∏</h3>
            <button onclick="closeHistoryModal()" class="close-modal">
                <i class="fa-solid fa-chevron-down"></i>
            </button>
        </div>
        
        <div id="full-history-list" class="history-scroll-area">
            </div>
    </div>
</div>
    
    
    <script>
        // ==========================================
    // üõ°Ô∏è –í–°–¢–ê–í–õ–Ø–ï–ú –°–Æ–î–ê (–°–ê–ú–´–ô –í–ï–†–•)
    // ==========================================
    async function checkMaintenance() {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
            const res = await fetch('/api/v1/bootstrap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ initData
                body: JSON.stringify({ initData: window.Telegram?.WebApp?.initData || '' })
            });

            if (res.ok) {
                const data = await res.json();
                
                // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Å–Ω–∞ (maintenance: true)
                if (data.maintenance) {
                    console.warn("‚õî –¢–µ—Ö. —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é.");
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–Ω—É–ª
                    document.body.innerHTML = ""; 
                    // –í—ã–∫–∏–¥—ã–≤–∞–µ–º –Ω–∞ –∑–∞–≥–ª—É—à–∫—É
                    window.location.href = '/'; 
                }
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:", e);
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    checkMaintenance();
    // ==========================================
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.BackButton.show();
        
        Telegram.WebApp.setHeaderColor('#17212b'); 
        Telegram.WebApp.setBackgroundColor('#17212b');

        // [NEW] Haptic Feedback –¥–ª—è —Ä—É–ª–µ—Ç–∫–∏
        const haptic = Telegram.WebApp.HapticFeedback;

        let categoryStack = []; 
        let currentCategoryId = 0;
        let itemsCache = {}; 
        let hasTradeLink = false;
        let cachedP2PCases = []; // –°–¢–ê–õ–û: cachedP2PCases
        
        Telegram.WebApp.BackButton.onClick(() => {
            goBack();
        });

// --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–†–û–°–û–í ---
async function makeApiRequest(url, method = 'GET', body = null) {
    let fetchUrl = url;
    const options = {
        method: method,
        headers: { 'Content-Type': 'application/json' }
    };

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º initData
    if (method.toUpperCase() !== 'GET') {
        const payload = body || {};
        if (!payload.initData) payload.initData = Telegram.WebApp.initData;
        options.body = JSON.stringify(payload);
    } else {
        const separator = fetchUrl.includes('?') ? '&' : '?';
        fetchUrl += `${separator}initData=${encodeURIComponent(Telegram.WebApp.initData)}`;
    }

    const response = await fetch(fetchUrl, options);
    const data = await response.json();
    
    if (!response.ok) {
        throw new Error(data.detail || data.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
    }
    
    return data;
}
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
// 1. –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–ö–ò (–í—ã–∑—ã–≤–∞–π —ç—Ç–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û–±–º–µ–Ω P2P")
// 1. –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–ö–ò
async function openP2PModal() {
    const modal = document.getElementById('p2p-modal');
    modal.classList.remove('hidden');
    
    // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
    document.getElementById('p2p-quantity').value = 1;
    document.getElementById('p2p-total').innerText = '0';
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    await loadP2PCasesForSelect();
    
    // –í–ê–ñ–ù–û: –¢—É—Ç –±—ã–ª–æ —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –º–µ–Ω—è–µ–º –Ω–∞ –Ω–æ–≤–æ–µ:
    await loadP2PHistoryData(); 
}

function closeP2PModal() {
    document.getElementById('p2p-modal').classList.add('hidden');
}

// 2. –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ö–ï–ô–°–û–í (–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è)
async function loadP2PCasesForSelect() {
    const select = document.getElementById('p2p-case-select');
    select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    
    try {
        const cases = await makeApiRequest('/api/v1/p2p/cases', 'GET');
        cachedP2PCases = cases || []; // –°–¢–ê–õ–û: –±–µ–∑ const (–ø–∏—à–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é)
        
        select.innerHTML = '<option value="">-- –ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–µ–π—Å --</option>';
        
        cachedP2PCases.forEach(item => {
            // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–∏–ª–∏ data-image="${item.image_url}"
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å HTML –∫–∞–≤—ã—á–∫–∞–º–∏
            const safeName = item.case_name.replace(/"/g, '&quot;');
            
            select.insertAdjacentHTML('beforeend', 
                `<option value="${item.id}" 
                         data-price="${item.price_in_coins}" 
                         data-image="${item.image_url}"
                         data-name="${safeName}">
                    ${item.case_name}
                </option>`
            );
        });
    } catch (e) {
        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
}

// 3. –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† + –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è)
function calculateP2P() {
    const select = document.getElementById('p2p-case-select');
    const quantityInput = document.getElementById('p2p-quantity');
    const priceDisplay = document.getElementById('p2p-price-per-item');
    const totalDisplay = document.getElementById('p2p-total');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–µ–≤—å—é
    const previewCard = document.getElementById('case-preview');
    const previewImg = document.getElementById('preview-img');
    const previewName = document.getElementById('preview-name');
    const previewPriceText = document.getElementById('preview-price-text');

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
    const selectedOption = select.options[select.selectedIndex];
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ (–∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ)
    if (!select.value) {
        previewCard.classList.remove('visible'); // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        setTimeout(() => { 
            if(!previewCard.classList.contains('visible')) previewCard.style.display = 'none'; 
        }, 300); // –ñ–¥–µ–º –∫–æ–Ω—Ü–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
        
        priceDisplay.innerText = 0;
        totalDisplay.innerText = 0;
        return;
    }

    // –ï—Å–ª–∏ –∫–µ–π—Å –≤—ã–±—Ä–∞–Ω
    const price = selectedOption.dataset.price ? parseInt(selectedOption.dataset.price) : 0;
    const imageUrl = selectedOption.dataset.image || '';
    const name = selectedOption.dataset.name || '';
    const quantity = parseInt(quantityInput.value) || 0;

    // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –≤–Ω–∏–∑—É
    priceDisplay.innerText = price;
    totalDisplay.innerText = price * quantity;

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ö–ê–†–¢–û–ß–ö–£
    previewCard.style.display = 'flex'; // –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º flex, —á—Ç–æ–±—ã –∞–Ω–∏–º–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –æ—Ç—Ä–∏—Å–æ–≤–∞–ª display:flex –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∫–ª–∞—Å—Å–∞ opacity
    requestAnimationFrame(() => {
        previewCard.classList.add('visible');
    });

    previewImg.src = imageUrl;
    previewName.innerText = name;
    previewPriceText.innerText = price;
}

// 4. –°–û–ó–î–ê–ù–ò–ï –°–î–ï–õ–ö–ò (–≠—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–ª–æ!)
async function createP2PTrade() {
    const select = document.getElementById('p2p-case-select');
    const quantity = parseInt(document.getElementById('p2p-quantity').value);
    const caseId = select.value;

    if (!caseId || quantity <= 0) return Telegram.WebApp.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!");

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ
        await makeApiRequest('/api/v1/p2p/create', 'POST', {
            case_id: parseInt(caseId),
            quantity: quantity
        });
        
        Telegram.WebApp.showAlert("‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –ñ–¥–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞.");
        
        // –°–±—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        select.value = "";
        document.getElementById('p2p-quantity').value = 1;
        calculateP2P(); // –°–±—Ä–æ—Å–∏—Ç –ø—Ä–µ–≤—å—é
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –∫–Ω–æ–ø–∫—É
        await loadP2PHistoryData(); 
        checkActiveTradesBackground();

    } catch (e) {
        Telegram.WebApp.showAlert(e.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏");
    }
}        

// 5. –ò–°–¢–û–†–ò–Ø –í–ù–£–¢–†–ò –ú–û–î–ê–õ–ö–ò (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
// --- –õ–û–ì–ò–ö–ê –ò–°–¢–û–†–ò–ò –ò –°–¢–ê–¢–£–°–û–í ---

        function openHistoryModal() {
            document.getElementById('history-modal-window').classList.add('active');
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            loadP2PHistoryData(); 
        }

        function closeHistoryModal() {
            document.getElementById('history-modal-window').classList.remove('active');
        }

        // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ì—Ä—É–∑–∏—Ç –¥–∞–Ω–Ω—ã–µ, —Å—Ç—Ä–æ–∏—Ç —Å–ø–∏—Å–æ–∫ –ò –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É
        async function loadP2PHistoryData() {
            const listContainer = document.getElementById('full-history-list');
            const smartBtn = document.getElementById('smart-history-btn');
            const smartBtnText = document.getElementById('smart-btn-text');
            const smartBtnIcon = smartBtn.querySelector('.btn-icon');

            // –õ–æ–∞–¥–µ—Ä –≤ —Å–ø–∏—Å–∫–µ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –æ–∫–Ω–æ)
            if (document.getElementById('history-modal-window').classList.contains('active')) {
                listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;"><i class="fa-solid fa-circle-notch fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            }

            try {
                // –ó–∞–ø—Ä–æ—Å –∫ API
                const trades = await makeApiRequest('/api/v1/p2p/my_trades', 'POST');

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–≤–µ—Ä—Ö—É)
                const priority = { 'active': 1, 'review': 2, 'pending': 3, 'completed': 4, 'canceled': 5 };
                trades.sort((a, b) => priority[a.status] - priority[b.status]);

                // --- –õ–û–ì–ò–ö–ê –£–ú–ù–û–ô –ö–ù–û–ü–ö–ò ---
                // –ò—â–µ–º —Å–∞–º—É—é –≤–∞–∂–Ω—É—é –∞–∫—Ç–∏–≤–Ω—É—é —Å–¥–µ–ª–∫—É
                const activeTrade = trades.find(t => ['active', 'review', 'pending'].includes(t.status));

                if (activeTrade) {
                    smartBtn.classList.add('active-trade');
                    
                    if (activeTrade.status === 'active') {
                        smartBtnText.innerText = `üî• –¢–†–ï–ë–£–ï–¢ –î–ï–ô–°–¢–í–ò–Ø`;
                        smartBtnIcon.innerHTML = '<i class="fa-solid fa-fire"></i>';
                    } else if (activeTrade.status === 'review') {
                        smartBtnText.innerText = `üëÄ –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–û–ú`;
                        smartBtnIcon.innerHTML = '<i class="fa-solid fa-hourglass-half"></i>';
                    } else {
                        smartBtnText.innerText = `‚è≥ –û–ñ–ò–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò`;
                        smartBtnIcon.innerHTML = '<i class="fa-regular fa-clock"></i>';
                    }
                } else {
                    // –ï—Å–ª–∏ –≤—Å—ë —Ç–∏—Ö–æ
                    smartBtn.classList.remove('active-trade');
                    smartBtnText.innerText = '–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫';
                    smartBtnIcon.innerHTML = '<i class="fa-solid fa-clock-rotate-left"></i>';
                }

                // --- –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê (–¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞) ---
                if (!trades || trades.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; margin-top:50px; color:#666;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
                    return;
                }

                listContainer.innerHTML = trades.map(t => {
                    // –ò—â–µ–º –∏–º—è –∫–µ–π—Å–∞
                    let caseName = t.case_name;
                    if (!caseName && t.case_id) {
                        const found = cachedP2PCases.find(c => c.id == t.case_id);
                        if (found) caseName = found.case_name;
                    }
                    if (!caseName) caseName = "–ö–µ–π—Å #" + t.case_id;

                    // HTML –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
                    let statusBadge = '';
                    let actionHtml = '';
                    
                    // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
                    switch(t.status) {
                        case 'pending':
                            statusBadge = '<span style="color:#aaa; background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; font-size:10px;">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>';
                            break;
                        case 'active':
                            statusBadge = '<span style="color:#000; background:#ffcc00; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:bold;">üî• –î–µ–π—Å—Ç–≤—É–π</span>';
                            // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
                            actionHtml = `
                                <div style="margin-top:10px; background:rgba(255,204,0,0.1); padding:10px; border-radius:8px; border:1px dashed #ffcc00;">
                                    <div style="font-size:11px; color:#ccc; margin-bottom:8px;">
                                        1. –û—Ç–ø—Ä–∞–≤—å —Ç—Ä–µ–π–¥: <a href="${t.trade_url_given}" target="_blank" style="color:#2AABEE; font-weight:bold;">–û—Ç–∫—Ä—ã—Ç—å Steam</a>
                                    </div>
                                    <button onclick="confirmP2PSent(${t.id})" class="action-btn" style="width:100%; height:36px; font-size:12px; background:#ffcc00; color:#000; border-radius:8px;">
                                        ‚úÖ –Ø –ø–µ—Ä–µ–¥–∞–ª —Å–∫–∏–Ω
                                    </button>
                                </div>
                            `;
                            break;
                        case 'review':
                            statusBadge = '<span style="color:#fff; background:#2AABEE; padding:2px 8px; border-radius:4px; font-size:10px;">üëÄ –ü—Ä–æ–≤–µ—Ä–∫–∞</span>';
                            break;
                        case 'completed':
                            statusBadge = '<span style="color:#fff; background:#34c759; padding:2px 8px; border-radius:4px; font-size:10px;">‚úÖ –ì–æ—Ç–æ–≤–æ</span>';
                            break;
                        case 'canceled':
                            statusBadge = '<span style="color:#fff; background:#ff3b30; padding:2px 8px; border-radius:4px; font-size:10px;">‚ùå –û—Ç–º–µ–Ω–∞</span>';
                            break;
                    }

                    return `
                        <div style="background:#2c2c2e; border-radius:14px; padding:12px; border:1px solid rgba(255,255,255,0.05);">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:5px;">
                                <div>
                                    <div style="font-weight:700; font-size:14px; color:#fff;">${caseName}</div>
                                    <div style="font-size:11px; color:#8E8E93;">–ö–æ–ª-–≤–æ: ${t.quantity} —à—Ç.</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="color:#ffcc00; font-weight:700; font-size:14px;">+${t.total_coins}</div>
                                    <div style="font-size:10px; color:#666;">#${t.id}</div>
                                </div>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                                ${statusBadge}
                                <div style="font-size:10px; color:#666;">${new Date(t.created_at || Date.now()).toLocaleDateString()}</div>
                            </div>
                            ${actionHtml}
                        </div>
                    `;
                }).join('');

            } catch (e) {
                listContainer.innerHTML = `<div style="color:red; text-align:center;">–û—à–∏–±–∫–∞: ${e.message}</div>`;
            }
        }
        
// 6. –û–¢–ö–†–´–¢–¨ –ë–û–¢–ê
function connectTelegramBot() {
    Telegram.WebApp.openTelegramLink("https://t.me/quest_hatelavka_bot?start=start");
}

function confirmP2PSent(tradeId) {
    Telegram.WebApp.showConfirm("–í—ã —Ç–æ—á–Ω–æ –ø–µ—Ä–µ–¥–∞–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –≤ Steam?", async (ok) => {
        if (!ok) return;

        try {
            await makeApiRequest('/api/v1/p2p/confirm_sent', 'POST', {
                trade_id: parseInt(tradeId)
            });
            
            Telegram.WebApp.showAlert("–û—Ç–ª–∏—á–Ω–æ! –ê–¥–º–∏–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞—á–∏—Å–ª–∏—Ç –º–æ–Ω–µ—Ç—ã.");
            
            // –í–ê–ñ–ù–û: –¢—É—Ç —Ç–æ–∂–µ –º–µ–Ω—è–µ–º –Ω–∞ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:
            await loadP2PHistoryData();
            checkActiveTradesBackground();

        } catch (e) {
            Telegram.WebApp.showAlert(e.message || "–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è");
        }
    });
}

// 7. –§–û–ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê (–î–õ–Ø –ì–õ–ê–í–ù–û–ô –ö–ù–û–ü–ö–ò –°–ù–ê–†–£–ñ–ò)
async function checkActiveTradesBackground() {
    try {
        const trades = await makeApiRequest('/api/v1/p2p/my_trades', 'POST');
        
        const activeTrades = trades.filter(t => ['pending', 'active', 'review'].includes(t.status));
        const priority = { 'active': 1, 'review': 2, 'pending': 3 };
        activeTrades.sort((a, b) => priority[a.status] - priority[b.status]);

        const btn = document.getElementById('open-p2p-modal-btn'); 
        if (!btn) return;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–∞–º—è—Ç—å, —á—Ç–æ–±—ã –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
        if (activeTrades.length > 0) {
            localStorage.setItem('p2p_last_state', JSON.stringify(activeTrades[0]));
        } else {
            localStorage.removeItem('p2p_last_state');
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é (–≤—ã–Ω–µ—Å–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥)
        renderP2PButton(activeTrades.length > 0 ? activeTrades[0] : null);

    } catch(e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ–π–¥–æ–≤:", e);
    }
}
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–Ω–æ–ø–∫–∏
function renderP2PButton(tradeData) {
    const btn = document.getElementById('open-p2p-modal-btn'); 
    if (!btn) return;

    const titleEl = btn.querySelector('.p2p-title');
    const subEl = btn.querySelector('.p2p-subtitle');
    const iconBox = btn.querySelector('.p2p-icon-box');

    if (tradeData) {
        btn.classList.add('has-active-trade');
        
        if (tradeData.status === 'active') {
            titleEl.innerText = "–¢–†–ï–ë–£–ï–¢–°–Ø –î–ï–ô–°–¢–í–ò–ï";
            subEl.innerText = "–ü–µ—Ä–µ–¥–∞–π—Ç–µ —Å–∫–∏–Ω –≤ Steam";
            iconBox.innerHTML = '<i class="fa-solid fa-fire"></i>';
        } else if (tradeData.status === 'review') {
            titleEl.innerText = "–ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–û–ú";
            subEl.innerText = "–û–∂–∏–¥–∞–π—Ç–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç";
            iconBox.innerHTML = '<i class="fa-solid fa-hourglass-half"></i>';
        } else {
            titleEl.innerText = "–ó–ê–Ø–í–ö–ê –°–û–ó–î–ê–ù–ê";
            subEl.innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–∏—è...";
            iconBox.innerHTML = '<i class="fa-regular fa-clock"></i>';
        }
    } else {
        btn.classList.remove('has-active-trade');
        titleEl.innerText = "Trade-In";
        subEl.innerText = "–û–±–º–µ–Ω –∫–µ–π—Å–æ–≤ –Ω–∞ üü°";
        iconBox.innerHTML = '<i class="fa-solid fa-arrow-right-arrow-left"></i>';
    }
}

// –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ò–ó –ü–ê–ú–Ø–¢–ò (–£–±–∏—Ä–∞–µ—Ç –º–∏–≥–∞–Ω–∏–µ)
function preloadP2PState() {
    try {
        const cached = localStorage.getItem('p2p_last_state');
        if (cached) {
            const trade = JSON.parse(cached);
            renderP2PButton(trade);
        }
    } catch (e) {
        console.log('Cache error', e);
    }
}

        // --- –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ê–†–¢–ù–ï–†–û–í (CSS ANIMATION) ---
        function initPartnersScroll() {
            const track = document.getElementById('partners-track');
            if (!track || track.children.length === 0) return;

            // –ö–ª–æ–Ω–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –û–î–ò–ù —Ä–∞–∑ –¥–ª—è –±–µ—Å—à–æ–≤–Ω–æ–π CSS –∞–Ω–∏–º–∞—Ü–∏–∏
            const items = Array.from(track.children);
            items.forEach(item => {
                const clone = item.cloneNode(true);
                track.appendChild(clone);
            });
            // –ï—â–µ —Ä–∞–∑ –∫–ª–æ–Ω–∏—Ä—É–µ–º –¥–ª—è —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (window.innerWidth > 500) {
                 items.forEach(item => {
                    const clone = item.cloneNode(true);
                    track.appendChild(clone);
                });
            }
        }
        // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê ---
        // –î–æ–±–∞–≤–∏–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç updateUI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)
        // –ï—Å–ª–∏ false -> –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç, —Å–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –Ω–æ —Ü–∏—Ñ—Ä—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –Ω–µ —Å–∫–∞—á—É—Ç
        // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê ---
        let isBalanceLoading = false;

        function checkBalance(updateUI = true) {
            if (isBalanceLoading) return Promise.resolve();
            
            isBalanceLoading = true;
            
            // –ö—Ä—É—Ç–∏–º –æ–±–µ –∏–∫–æ–Ω–∫–∏
            const iconCoins = document.getElementById('refresh-icon');
            const iconTickets = document.getElementById('refresh-icon-tickets'); // –î–æ–±–∞–≤–∏–ª–∏ –∏–∫–æ–Ω–∫—É –±–∏–ª–µ—Ç–æ–≤
            if (iconCoins) iconCoins.classList.add('spinning');
            if (iconTickets) iconTickets.classList.add('spinning');

            return fetch('/api/v1/shop/smart_balance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ initData: Telegram.WebApp.initData })
            })
            .then(r => r.json())
            .then(data => {
                if (updateUI) {
                    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–Ω–µ—Ç—ã
                    let coins = data.balance || 0; 
                    let displayBalance = (coins / 100).toFixed(0); 
                    
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl) {
                        balanceEl.style.opacity = '0.5';
                        setTimeout(() => {
                            balanceEl.textContent = displayBalance;
                            balanceEl.style.opacity = '1';
                        }, 150);
                    }

                    // 2. –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ò–õ–ï–¢–´ (–≠—Ç–æ–≥–æ –±–ª–æ–∫–∞ —É —Ç–µ–±—è –Ω–µ –±—ã–ª–æ!)
                    let tickets = data.tickets || 0; // –ë–µ—Ä–µ–º –±–∏–ª–µ—Ç—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    const ticketsEl = document.getElementById('user-tickets');
                    if (ticketsEl) {
                        ticketsEl.style.opacity = '0.5';
                        setTimeout(() => {
                            ticketsEl.textContent = tickets;
                            ticketsEl.style.opacity = '1';
                        }, 150);
                    }
                }
            })
            .catch(err => {
                console.warn("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:", err);
            })
            .finally(() => {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                setTimeout(() => {
                    isBalanceLoading = false;
                    if (iconCoins) iconCoins.classList.remove('spinning');
                    if (iconTickets) iconTickets.classList.remove('spinning');
                }, 500);
            });
        }

        async function initShop() {
    // 1. –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ç–∏–∫–∞
    updateNavState();
    initPartnersScroll();
    preloadP2PState(); // [NEW] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∏–∑ –∫—ç—à–∞
    
    // 2. –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –ø—Ä–æ–º–∏—Å–æ–≤ (–∑–∞–¥–∞—á), –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è
    const tasks = [];

    // –ó–∞–¥–∞—á–∞ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    tasks.push(loadCategory(0)); 

    // –ó–∞–¥–∞—á–∞ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    tasks.push(checkBalance(true));

    // –ó–∞–¥–∞—á–∞ 3: –°—Ç–∞—Ç—É—Å P2P —Ç—Ä–µ–π–¥–æ–≤
    tasks.push(checkActiveTradesBackground());

    // –ó–∞–¥–∞—á–∞ 4: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞ –∏ –∞–¥–º–∏–Ω–∫–∞)
    const profileTask = fetch('/api/v1/user/me', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ initData: Telegram.WebApp.initData })
    }).then(r => r.json()).then(userData => {
        if (userData && userData.trade_link) hasTradeLink = true;
        if (userData && userData.is_admin) {
            document.getElementById('admin-fab').style.display = 'flex';
        }
    }).catch(e => console.log("Profile load error", e));
    
    tasks.push(profileTask);

    // 3. –ñ–¥–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –í–°–ï–• –∑–∞–¥–∞—á (Promise.allSettled –∂–¥–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –æ—à–∏–±–∫–∞)
    await Promise.allSettled(tasks);

    // 4. –ö–æ–≥–¥–∞ –≤—Å—ë –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å ‚Äî –ø–ª–∞–≤–Ω–æ —É–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä
    const loader = document.getElementById('global-loader');
    if (loader) {
        loader.classList.add('hidden');
    }
}

        // --- –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù –ú–ï–ù–Æ ---
        
        function toggleAdminMenu() {
            const toggleBtn = document.querySelector('.admin-fab-btn.toggle');
            const menuItems = document.getElementById('admin-menu-items');
            
            toggleBtn.classList.toggle('active');
            menuItems.classList.toggle('show');
            
            // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É
            const icon = toggleBtn.querySelector('i');
            if (toggleBtn.classList.contains('active')) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-xmark');
            } else {
                icon.classList.remove('fa-xmark');
                icon.classList.add('fa-chevron-up');
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
        function openPassModal() {
            document.getElementById('password-modal').classList.add('active');
            document.getElementById('admin-pass-input').value = '';
            document.getElementById('admin-pass-input').focus();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
        function closePassModal() {
            document.getElementById('password-modal').classList.remove('active');
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–±—Ä–æ—Å
        function submitResetCache() {
            const password = document.getElementById('admin-pass-input').value;
            if (!password) return;

            closePassModal(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            toggleAdminMenu(); // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–µ–Ω—é

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            const loader = document.getElementById('purchase-loader');
            if (loader) {
                loader.querySelector('.loader-text').innerText = "–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞...";
                loader.classList.add('active');
            }

            fetch('/api/v1/admin/shop/reset_cache', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    initData: Telegram.WebApp.initData,
                    password: password 
                })
            })
            .then(async r => {
                const data = await r.json();
                if (r.status === 200) {
                    Telegram.WebApp.showAlert("‚úÖ " + data.message);
                    itemsCache = {}; // –ß–∏—Å—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π JS –∫—ç—à
                    loadCategory(currentCategoryId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                } else {
                    Telegram.WebApp.showAlert("‚õî " + (data.detail || "–û—à–∏–±–∫–∞"));
                }
            })
            .catch(err => {
                Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.");
            })
            .finally(() => {
                if (loader) {
                    loader.classList.remove('active');
                    setTimeout(() => { loader.querySelector('.loader-text').innerText = "–û—Ñ–æ—Ä–º–ª—è–µ–º –ø–æ–∫—É–ø–∫—É..."; }, 200);
                }
            });
        }
        
        async function loadCategory(catId) {
            const container = document.getElementById('shop-grid');
            currentCategoryId = catId;
            updateNavState();

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à - —Ä–µ–Ω–¥–µ—Ä–∏–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
            if (itemsCache[catId]) {
                renderItems(itemsCache[catId]);
                return;
            }

            renderSkeleton();

            try {
                const response = await fetch('/api/v1/shop/goods', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        initData: Telegram.WebApp.initData,
                        category_id: catId 
                    })
                });
                const items = await response.json();
                itemsCache[catId] = items;
                renderItems(items);
            } catch (e) {
                container.innerHTML = '<div class="empty-msg">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</div>';
            }
        }

        function renderSkeleton() {
            const container = document.getElementById('shop-grid');
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Å—Ç—Ä–æ–∫—É —Å—Ä–∞–∑—É, –±—ã—Å—Ç—Ä–µ–µ —á–µ–º createElement –≤ —Ü–∏–∫–ª–µ
            container.innerHTML = Array(6).fill('<div class="shop-item skeleton"></div>').join('');
        }

        function formatItemName(name) {
            const splitIndex = name.indexOf('(');
            if (splitIndex !== -1) {
                const mainPart = name.substring(0, splitIndex).trim();
                const subPart = name.substring(splitIndex).trim();
                return `${escapeHtml(mainPart)}<span class="item-subtitle">${escapeHtml(subPart)}</span>`;
            }
            return escapeHtml(name);
        }

        // --- –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ï–ù–î–ï–† (DocumentFragment) ---
        function renderItems(items) {
            const container = document.getElementById('shop-grid');
            container.innerHTML = '';

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="empty-msg">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</div>';
                return;
            }

            const fragment = document.createDocumentFragment();

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'shop-item';
                
                let buttonHtml = '';
                let stockText = '';
                let priceText = '';
                
                // –û–ë–™–Ø–í–õ–Ø–ï–ú –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–î–ò–ù –†–ê–ó
                let clickAction = '';
                let caseOverlayHtml = '';

                // --- –î–ï–¢–ï–ö–¢–û–† –ö–ï–ô–°–ê ---
                const upperName = (item.name || "").toUpperCase();
                const isCase = upperName.includes("–ö–ï–ô–° |") || upperName.includes("CASE |");
                
                const safeName = item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeImg = item.image_url || "";

                // --- –õ–û–ì–ò–ö–ê –ö–õ–ò–ö–ê –ü–û –ö–ê–†–¢–ò–ù–ö–ï ---
                if (item.is_folder) {
                    clickAction = `openFolder(${item.id})`;
                } else if (isCase) {
                    // –ï—Å–ª–∏ –∫–µ–π—Å ‚Äî –∫–ª–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ + –¥–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞—à–∫—É
                    clickAction = `openCaseContents(event)`;
                    caseOverlayHtml = `
                        <div class="case-info-overlay">
                            <span>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä–æ–ø</span>
                        </div>
                    `;
                } else {
                    // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
                    clickAction = `openImageModal('${safeImg}')`;
                }

                // --- –õ–û–ì–ò–ö–ê –¢–ï–ö–°–¢–û–í –ò –ö–ù–û–ü–û–ö ---
                if (item.is_folder) {
                    stockText = ''; 
                    buttonHtml = `<button class="action-btn btn-folder" onclick="openFolder(${item.id})">–û—Ç–∫—Ä—ã—Ç—å <i class="fa-solid fa-chevron-right" style="font-size:10px; margin-left:3px;"></i></button>`;
                } else {
                    let isOutOfStock = false;
                    
                    if (isCase) {
                        stockText = ''; 
                        priceText = ''; // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è –∫–µ–π—Å–æ–≤
                    } else {
                        priceText = `<div class="item-price">${item.price} üü°Ô∏è</div>`;
                        if (item.count === null) {
                            stockText = `<div class="item-stock">‚àû —à—Ç.</div>`;
                        } else if (item.count === 0) {
                            isOutOfStock = true;
                            stockText = `<div class="item-stock out">0 —à—Ç.</div>`;
                        } else {
                            stockText = `<div class="item-stock">${item.count} —à—Ç.</div>`;
                        }
                    }

                    if (isOutOfStock) {
                        buttonHtml = `<button class="action-btn btn-disabled" disabled>–†–∞—Å–∫—É–ø–ª–µ–Ω–æ</button>`;
                    } else if (isCase) {
                        // –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏ (—Ü–µ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–æ–∫, –±–∏–ª–µ—Ç—ã —Ö2)
                        buttonHtml = `
                            <div class="case-buttons-container">
                                <button class="action-btn btn-buy" onclick="openCase(${item.id}, ${item.price}, '${safeName}', '${safeImg}', 'coins')">
                                    –û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${item.price} üü°
                                </button>
                                <button class="action-btn btn-buy-tickets" onclick="openCase(${item.id}, ${item.price * 2}, '${safeName}', '${safeImg}', 'tickets')">
                                    –û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${item.price * 2} üéüÔ∏è
                                </button>
                            </div>
                        `;
                    } else {
                        buttonHtml = `<button class="action-btn btn-buy" onclick="buyItem(${item.id}, ${item.price}, '${safeName}', '${safeImg}')">–ö—É–ø–∏—Ç—å</button>`;
                    }
                }

                const displayNameHtml = formatItemName(item.name);
                const imgUrl = item.image_url || 'https://placehold.co/150?text=No+Image';

                // –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π HTML (–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –∫–µ–π—Å–æ–≤)
                if (isCase) {
                    // –î–∏–∑–∞–π–Ω –ö–µ–π—Å–∞: –ó–∞–≥–æ–ª–æ–≤–æ–∫ -> –ö–∞—Ä—Ç–∏–Ω–∫–∞ -> –ö–Ω–æ–ø–∫–∏
                    el.innerHTML = `
                        <div class="item-title case-top-title">${displayNameHtml}</div>
                        
                        <div class="item-image-wrapper case-img-wrap" onclick="${clickAction}">
                            ${caseOverlayHtml}
                            <img src="${imgUrl}" 
                                 class="item-image case-zoom" decoding="async" 
                                 loading="lazy" 
                                 onload="this.classList.add('loaded')" 
                                 alt="${escapeHtml(item.name)}">
                        </div>
                        
                        <div class="case-buttons-wrapper">
                            ${buttonHtml}
                        </div>
                    `;
                } else {
                    // –î–∏–∑–∞–π–Ω –û–±—ã—á–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞: –ö–∞—Ä—Ç–∏–Ω–∫–∞ -> –ó–∞–≥–æ–ª–æ–≤–æ–∫ -> –¶–µ–Ω–∞ -> –ö–Ω–æ–ø–∫–∞
                    el.innerHTML = `
                        <div class="item-image-wrapper" onclick="${clickAction}">
                            <img src="${imgUrl}" 
                                 class="item-image" decoding="async" 
                                 loading="lazy" 
                                 onload="this.classList.add('loaded')" 
                                 alt="${escapeHtml(item.name)}">
                        </div>
                        <div class="item-info">
                            <div class="item-title">${displayNameHtml}</div>
                            <div class="item-meta">
                                ${stockText}
                                ${priceText}
                            </div>
                            ${buttonHtml}
                        </div>
                    `;
                }
                
                fragment.appendChild(el);
            });
            container.appendChild(fragment);
        }
        
        // --- [NEW] –§–£–ù–ö–¶–ò–Ø –û–¢–ö–†–´–¢–ò–Ø –ö–ï–ô–°–ê (–Æ–í–ï–õ–ò–†–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï) ---
        // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–æ –º–µ–Ω—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        window.openCase = async function(id, price, name, imageUrl, currency = 'coins') {
            const currencyIcon = currency === 'coins' ? 'üü°' : 'üéüÔ∏è';
            Telegram.WebApp.showConfirm(`–û—Ç–∫—Ä—ã—Ç—å "${name}" –∑–∞ ${price} ${currencyIcon}?`, async (ok) => {
                if (!ok) return;

                const loader = document.getElementById('purchase-loader');
                if (loader) loader.classList.add('active');

                try {
                    // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∫—É–ø–∫—É
                    const buyResp = await fetch('/api/v1/shop/buy', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            initData: Telegram.WebApp.initData,
                            item_id: id,
                            price: price,
                            title: name,
                            image_url: imageUrl,
                            currency: currency // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥ –∏–Ω—Ñ—É –æ –≤–∞–ª—é—Ç–µ ('coins' –∏–ª–∏ 'tickets')
                        })
                    });

                    const resData = await buyResp.json();

                    if (buyResp.status !== 200) {
                        Telegram.WebApp.showAlert(resData.detail || "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
                    } else {
                        // 2. –£–°–ü–ï–•! –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ.
                        
                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. 
                        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∏—Ö –Ω–µ –ø—Ä–∏—Å–ª–∞–ª (null), —Å–æ–∑–¥–∞–µ–º "–∞–≤–∞—Ä–∏–π–Ω—ã–π" –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã —Ä—É–ª–µ—Ç–∫–∞ –≤—Å–µ —Ä–∞–≤–Ω–æ –∫—Ä—É—Ç–∏–ª–∞—Å—å.
                        let winner = resData.winner;
                        let strip = resData.roulette_strip;

                        if (!winner) {
                            // –§–û–õ–õ–ë–≠–ö: –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –º–æ–ª—á–∏—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º –∫–µ–π—Å –∫–∞–∫ –≤—ã–∏–≥—Ä—ã—à
                            console.warn("–°–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏—Å–ª–∞–ª winner, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É");
                            winner = { 
                                name: name, // –ò–º—è —Ç–æ–≤–∞—Ä–∞ (–∫–µ–π—Å–∞)
                                image_url: imageUrl, // –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–æ–≤–∞—Ä–∞
                                rarity: 'gold' 
                            };
                        }
                        
                        // –ï—Å–ª–∏ –Ω–µ—Ç –ª–µ–Ω—Ç—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –µ—ë
                        if (!strip || strip.length === 0) {
                            strip = [];
                            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–µ–Ω—Ç—É –∫–æ–ø–∏—è–º–∏ –≤—ã–∏–≥—Ä—ã—à–∞ (–∏–ª–∏ –∑–Ω–∞–∫–∞–º–∏ –≤–æ–ø—Ä–æ—Å–∞), —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ –∫—Ä—É—Ç–∏—Ç—å
                            for(let i=0; i<80; i++) {
                                strip.push({ 
                                    name: "Mystery Drop", 
                                    image_url: "https://placehold.co/100?text=?", // –ò–ª–∏ imageUrl –∫–µ–π—Å–∞
                                    rarity: 'common' 
                                });
                            }
                            // –í–ê–ñ–ù–û: 60-–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî —ç—Ç–æ –≤—Å–µ–≥–¥–∞ —Ç–æ, —á—Ç–æ –≤—ã–ø–∞–ª–æ
                            strip[60] = winner; 
                        }

                        // 3. –ó–ê–ü–£–°–ö–ê–ï–ú –†–£–õ–ï–¢–ö–£ (–ë–û–õ–¨–®–ï –ù–ò–ö–ê–ö–ò–• ALERT!)
                        launchRoulette(strip, winner, resData.messages || []);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                        checkBalance(true);
                        delete itemsCache[currentCategoryId];
                    }

                } catch (err) {
                    console.error(err);
                    Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
                } finally {
                    if (loader) loader.classList.remove('active');
                }
            });
        };
        

        // --- [NEW] –õ–û–ì–ò–ö–ê –†–£–õ–ï–¢–ö–ò (–Æ–í–ï–õ–ò–†–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï) ---
        function launchRoulette(items, winner, extraMessages) {
    const modal = document.getElementById('r-modal');
    const area = document.getElementById('r-area');
    const track = document.getElementById('r-track');
    const winScreen = document.getElementById('r-win');
    
    // –°–±—Ä–æ—Å
    track.style.transition = 'none';
    track.style.transform = 'translateX(0)';
    track.innerHTML = '';
    
    area.style.display = 'block';
    winScreen.style.display = 'none';
    // Flex –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
    winScreen.style.flexDirection = 'column'; 
    winScreen.style.alignItems = 'center';
    
    modal.style.display = 'flex';

    const CARD_W = 148; // 140px + –æ—Ç—Å—Ç—É–ø—ã
    const WINNER_IDX = 80; 
    const ANIMATION_TIME = 11000; 

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–µ–Ω—Ç—É
    let fullList = [...items];
    while(fullList.length <= WINNER_IDX + 10) {
        fullList = fullList.concat(items);
    }
    
    // –ñ–µ—Å—Ç–∫–æ —Å—Ç–∞–≤–∏–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    fullList[WINNER_IDX] = winner; 

    // –†–µ–Ω–¥–µ—Ä HTML –ª–µ–Ω—Ç—ã
    track.innerHTML = fullList.map(item => {
        let rClass = 'r-common'; 
        const r = (item.rarity || 'common').toLowerCase();
        
        if (r.includes('blue') || r.includes('rare')) rClass = 'r-blue';
        else if (r.includes('purple') || r.includes('mythical')) rClass = 'r-purple';
        else if (r.includes('pink') || r.includes('legendary')) rClass = 'r-pink';
        else if (r.includes('red') || r.includes('ancient')) rClass = 'r-red';
        else if (r.includes('gold')) rClass = 'r-gold';

        const img = item.image_url || 'https://placehold.co/100?text=Item';
        return `<div class="r-card ${rClass}"><img src="${img}"><div class="r-card-name">${item.name}</div></div>`;
    }).join('');

    // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
        // –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê –û–°–¢–ê–ù–û–í–ö–ò
        const screenCenter = window.innerWidth / 2;
        const winnerCenter = (WINNER_IDX * CARD_W) + (CARD_W / 2);
        
        // –†–∞–Ω–¥–æ–º–Ω—ã–π —Å–¥–≤–∏–≥ +/- 45px
        const randomOffset = (Math.random() * 90) - 45; 

        const finalPosition = -(winnerCenter - screenCenter + randomOffset);

        // --- –ù–ê–°–¢–†–û–ô–ö–ê –§–ò–ó–ò–ö–ò ---
        track.style.transition = `transform ${ANIMATION_TIME}ms cubic-bezier(0.12, 0, 0.00, 1)`; 
        track.style.transform = `translateX(${finalPosition}px)`;
        
        // –ó–≤—É–∫ —Ç—Ä–µ—â–æ—Ç–∫–∏ (Haptic)
        let tickInterval = 40; 
        let timer = 0;
        
        const ticker = () => {
            if (timer >= ANIMATION_TIME - 500) return; 
            
            haptic.selectionChanged();
            
            timer += tickInterval;
            // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ —Ç–∏–∫–æ–≤
            if (timer < ANIMATION_TIME * 0.7) {
                tickInterval += 2; 
            } else {
                tickInterval += 15; 
            }
            
            setTimeout(ticker, tickInterval);
        };
        ticker();

        // –§–∏–Ω–∞–ª
        setTimeout(() => {
            haptic.impactOccurred('heavy'); 

            setTimeout(() => {
                haptic.notificationOccurred('success');
                
                area.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ª–µ–Ω—Ç—É
                
                // --- [UPDATE] –ì–ï–ù–ï–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê –ü–û–ë–ï–î–´ –° –ù–û–í–´–ú–ò –ö–ù–û–ü–ö–ê–ú–ò ---
                const ticketPrice = winner.price || 0; 
                const itemId = winner.id; 

                // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ Win Screen
                winScreen.innerHTML = `
                    <h2 style="color:#ffcc00; margin-bottom:10px; text-transform:uppercase; text-shadow:0 0 20px rgba(255,215,0,0.5);">–í–´–ü–ê–õ–û –ò–ó –ö–ï–ô–°–ê!</h2>
                    
                    <img src="${winner.image_url}" class="win-img">
                    
                    <h3 style="color:#fff; margin-top:15px; margin-bottom: 20px; font-weight: 700; max-width: 90%; line-height: 1.4; text-align: center;">${winner.name}</h3>
                    
                    <button class="action-btn btn-buy" style="width: 220px; height: 48px; font-size: 14px;" 
                        onclick="claimItem(${itemId})">
                        –ó–ê–ë–†–ê–¢–¨
                    </button>

                    <button class="action-btn btn-sell-tickets" style="width: 220px; height: 44px; font-size: 13px;" 
                        onclick="sellForTickets(${itemId}, ${ticketPrice})">
                        –ü–†–û–î–ê–¢–¨ –ó–ê ${ticketPrice} <i class="fa-solid fa-ticket ticket-icon"></i>
                    </button>

                    <div class="win-actions-row">
                        <button class="action-btn btn-secondary-action" onclick="goToProfile()">
                            <i class="fa-solid fa-user" style="margin-right:4px;"></i> –ü—Ä–æ—Ñ–∏–ª—å
                        </button>
                        <div style="width: 1px; background: rgba(255,255,255,0.1);"></div>
                        <button class="action-btn btn-secondary-action" onclick="closeRoulette()">
                            <i class="fa-solid fa-xmark" style="margin-right:4px;"></i> –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
                
                winScreen.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
            }, 800); // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –ø—Ä–∏–∑–∞

        }, ANIMATION_TIME); 
    }, 100);
}
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä—É–ª–µ—Ç–∫–∏
        function closeRoulette() {
            document.getElementById('r-modal').style.display = 'none';
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ —à–∞–ø–∫–µ
            checkBalance(true);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            // –ù–æ —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å —Ç–µ–ø–µ—Ä—å –∫–µ–π—Å—ã –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ (–±–µ–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞), —ç—Ç–æ —á–∏—Å—Ç–æ –¥–ª—è –ø–æ—Ä—è–¥–∫–∞
            loadCategory(currentCategoryId); 
        }

        function openImageModal(imageUrl) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('full-image');
            img.src = imageUrl;
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal(event) {
            if (event.target.id === 'image-modal') {
                closeImageModalForce();
            }
        }

        function closeImageModalForce() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('open');
            document.body.style.overflow = '';
        }

        function openPartnerLink(url) {
            Telegram.WebApp.openLink(url);
        }

        function copyCode(event, code) {
            event.stopPropagation(); 
            event.preventDefault();  
            
            navigator.clipboard.writeText(code).then(() => {
                Telegram.WebApp.showAlert('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            }).catch(err => {
                const textArea = document.createElement("textarea");
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("Copy");
                textArea.remove();
                Telegram.WebApp.showAlert('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            });
        }

        window.openFolder = function(id) {
            categoryStack.push(currentCategoryId);
            loadCategory(id);
        }

        window.goBack = function() {
            // 1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –ø–∞–ø–∫–∏ - –≤—ã—Ö–æ–¥–∏–º –∏–∑ –ø–∞–ø–∫–∏
            if (categoryStack.length > 0) {
                const prevId = categoryStack.pop();
                loadCategory(prevId);
            } 
            // 2. –ï—Å–ª–∏ –ø–∞–ø–æ–∫ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –±—Ä–∞—É–∑–µ—Ä–∞ (–∫–∞–∫ –≤ –ø—Ä–æ—Ñ–∏–ª–µ)
            else if (window.history.length > 1 && document.referrer) {
                window.history.back();
            } 
            // 3. –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç - –∏–¥–µ–º –≤ –º–µ–Ω—é
            else {
                window.location.href = "/menu"; 
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ HTML –∫–Ω–æ–ø–∫—É (—Å–∏–Ω—é—é)
        document.getElementById('header-back-btn').addEventListener('click', (e) => {
            e.preventDefault(); // –ß—Ç–æ–±—ã –Ω–µ –∫–∏–¥–∞–ª–æ –≤–≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            goBack();
        });

        // –ù–∞—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram —Ç–æ–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
        Telegram.WebApp.BackButton.onClick(() => {
            goBack();
        });

        function updateNavState() {
            const titleEl = document.getElementById('nav-title');
            if (categoryStack.length === 0) {
                titleEl.textContent = "–í –º–µ–Ω—é";
                Telegram.WebApp.BackButton.hide();
            } else {
                titleEl.textContent = "–ù–∞–∑–∞–¥";
                Telegram.WebApp.BackButton.show();
            }
        }

        window.buyItem = function(id, price, name, imageUrl) {
            // 1. –°–Ω–∞—á–∞–ª–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            Telegram.WebApp.showConfirm(`–ö—É–ø–∏—Ç—å "${name}" –∑–∞ ${price} –∑–≤–µ–∑–¥?`, async (ok) => {
                if (!ok) return;

                // 2. –í–ö–õ–Æ–ß–ê–ï–ú –ë–õ–û–ö–ò–†–û–í–ö–£ –≠–ö–†–ê–ù–ê (—Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ —Ç—ã–∫–∞–ª–∏)
                const loader = document.getElementById('purchase-loader');
                if (loader) loader.classList.add('active');

                try {
                    // 3. –ü–†–û–í–ï–†–Ø–ï–ú –°–°–´–õ–ö–£ –°–í–ï–ñ–ò–ú –ó–ê–ü–†–û–°–û–ú (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
                    // –ú—ã –Ω–µ –≤–µ—Ä–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π hasTradeLink, –º—ã –≤–µ—Ä–∏–º –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
                    const userCheckResp = await fetch('/api/v1/user/me', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ initData: Telegram.WebApp.initData })
                    });
                    const userData = await userCheckResp.json();

                    // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
                    if (!userData || !userData.trade_link) {
                        if (loader) loader.classList.remove('active'); // –£–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä
                        Telegram.WebApp.showPopup({
                            title: '–ù–µ—Ç —Ç—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∏',
                            message: '–°–∏—Å—Ç–µ–º–∞ –Ω–µ –≤–∏–¥–∏—Ç –≤–∞—à—É —Ç—Ä–µ–π–¥-—Å—Å—ã–ª–∫—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –µ—ë –≤ –ü—Ä–æ—Ñ–∏–ª–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
                            buttons: [{type: 'ok'}]
                        });
                        return; 
                    }

                    // 4. –ï–°–õ–ò –°–°–´–õ–ö–ê –ï–°–¢–¨ ‚Äî –î–ï–õ–ê–ï–ú –ü–û–ö–£–ü–ö–£
                    const buyResp = await fetch('/api/v1/shop/buy', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            initData: Telegram.WebApp.initData,
                            item_id: id,
                            price: price,
                            title: name,
                            image_url: imageUrl
                        })
                    });

                    const resData = await buyResp.json();

                    if (buyResp.status !== 200) {
                        Telegram.WebApp.showAlert(resData.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ");
                    } else {
                        Telegram.WebApp.showAlert("‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞! –¢–æ–≤–∞—Ä –≤—ã–¥–∞–Ω.");
                        
                        // –ß–∏—Å—Ç–∏–º –∫—ç—à –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å (–≤–∏–∑—É–∞–ª—å–Ω–æ)
                        delete itemsCache[currentCategoryId];
                        let currentBal = parseFloat(document.getElementById('user-balance').textContent);
                        if (!isNaN(currentBal)) {
                            document.getElementById('user-balance').textContent = (currentBal - price).toFixed(0);
                        }
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                        initShop(); 
                    }

                } catch (err) {
                    console.error(err);
                    Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞");
                } finally {
                    // 5. –í–´–ö–õ–Æ–ß–ê–ï–ú –õ–û–ê–î–ï–† (–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ - —É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞)
                    if (loader) loader.classList.remove('active');
                }
            });
        }

        // --- [NEW] –§–£–ù–ö–¶–ò–ò –î–õ–Ø –≠–ö–†–ê–ù–ê –ü–û–ë–ï–î–´ ---

// 1. –ó–ê–ë–†–ê–¢–¨ (–°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ/–∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ)
// --- 1. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ö–ù–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø (–ò–ó PROFILE) ---
// --- 1. –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø (CUSTOM MODAL) ---
function showShopModal({ title, subtitle, confirmText, confirmClass, onConfirm }) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const old = document.querySelector('.custom-confirm-overlay');
    if (old) old.remove();

    const overlay = document.createElement('div'); 
    overlay.className = 'custom-confirm-overlay';
    
    overlay.innerHTML = `
        <div class="custom-confirm-box">
            <h3 class="confirm-title">${title}</h3>
            <p class="confirm-subtitle">${subtitle}</p>
            <div class="confirm-buttons">
                <button class="confirm-btn btn-cancel-modal" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn ${confirmClass}" id="modal-confirm">${confirmText}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    requestAnimationFrame(() => overlay.classList.add('visible'));
    
    const close = () => {
        overlay.classList.remove('visible');
        setTimeout(() => overlay.remove(), 200);
    };
    
    overlay.querySelector('#modal-cancel').onclick = close;
    
    overlay.querySelector('#modal-confirm').onclick = () => { 
        onConfirm(close); 
    };
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    overlay.onclick = (e) => { if(e.target === overlay) close(); };
}

// --- 2. –õ–û–ì–ò–ö–ê "–ó–ê–ë–†–ê–¢–¨" (–ñ–µ–ª—Ç–∞—è –∫–Ω–æ–ø–∫–∞) ---
// --- 2. –õ–û–ì–ò–ö–ê "–ó–ê–ë–†–ê–¢–¨" (–ñ–µ–ª—Ç–∞—è –∫–Ω–æ–ø–∫–∞) ---
async function claimItem(itemId) {
    if (!itemId) return Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞: ID –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.");

    showShopModal({
        title: "–í—ã–≤–µ—Å—Ç–∏ —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç –≤ Steam?",
        subtitle: "–ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ —Ç—Ä–µ–π–¥ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.",
        confirmText: "–ó–ê–ë–†–ê–¢–¨",
        confirmClass: "btn-yellow-modal", 
        onConfirm: async (closeModal) => {
            
            const loader = document.getElementById('purchase-loader');
            if (loader) {
                loader.classList.add('active');
                loader.querySelector('.loader-text').innerText = "–°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É...";
            }

            try {
                // –ó–∞–ø—Ä–æ—Å –∫ API
                const res = await makeApiRequest('/api/v1/user/inventory/withdraw', 'POST', { 
                    history_id: itemId 
                });

                // 1. –°–ù–ê–ß–ê–õ–ê –°–û–û–ë–©–ï–ù–ò–ï (–°–∫—Ä–∏–ø—Ç –≤—Å—Ç–∞–Ω–µ—Ç –Ω–∞ –ø–∞—É–∑—É —Ç—É—Ç, –ø–æ–∫–∞ —Ç—ã –Ω–µ –Ω–∞–∂–º–µ—à—å –û–ö)
                if (res) {
                     Telegram.WebApp.showAlert(`‚úÖ –£—Å–ø–µ—à–Ω–æ!\n\n–û–∂–∏–¥–∞–π—Ç–µ —Ç—Ä–µ–π–¥ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –í–∞–º–∏ —Å—Å—ã–ª–∫–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.`);
                }

                // 2. –ü–û–¢–û–ú –ó–ê–ö–†–´–í–ê–ï–ú –û–ö–ù–ê (–ö–æ–≥–¥–∞ –Ω–∞–∂–∞–ª –û–ö)
                closeModal();      
                closeRoulette();   

            } catch (e) {
                Telegram.WebApp.showAlert(e.message || "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
                closeModal(); 
            } finally {
                // 3. –£–ë–ò–†–ê–ï–ú –õ–û–ê–î–ï–†
                if (loader) loader.classList.remove('active');
            }
        }
    });
}
// --- 3. –õ–û–ì–ò–ö–ê "–ü–†–û–î–ê–¢–¨ –ó–ê –ë–ò–õ–ï–¢–´" (–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞, API –∏—Å–ø—Ä–∞–≤–ª–µ–Ω) ---
function sellForTickets(itemId, price) {
    showShopModal({
        title: `–ü—Ä–æ–¥–∞—Ç—å —Å–∫–∏–Ω –∑–∞ ${price} üéüÔ∏è?`,
        subtitle: "–ü—Ä–µ–¥–º–µ—Ç –±—É–¥–µ—Ç –ø—Ä–æ–¥–∞–Ω —Å–∏—Å—Ç–µ–º–µ, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –±–∏–ª–µ—Ç—ã –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ.",
        confirmText: "–ü–†–û–î–ê–¢–¨",
        confirmClass: "btn-purple-modal", // –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
        onConfirm: async (closeModal) => {
            
            const loader = document.getElementById('purchase-loader');
            if (loader) {
                loader.classList.add('active');
                loader.querySelector('.loader-text').innerText = "–ü—Ä–æ–¥–∞–µ–º...";
            }

            try {
                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–´–ó–û–í API (URL, METHOD, BODY)
                await makeApiRequest('/api/v1/user/inventory/sell', 'POST', { 
                    history_id: itemId 
                });

                Telegram.WebApp.showAlert(`–£—Å–ø–µ—à–Ω–æ! +${price} –±–∏–ª–µ—Ç–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ.`);
                
                closeModal();      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
                closeRoulette();   // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä—É–ª–µ—Ç–∫—É

            } catch (e) {
                Telegram.WebApp.showAlert(e.message || "–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞");
                closeModal();
            } finally {
                if (loader) loader.classList.remove('active');
            }
        }
    });
}

// --- –õ–û–ì–ò–ö–ê –ü–†–û–°–ú–û–¢–†–ê –°–û–î–ï–†–ñ–ò–ú–û–ì–û –ö–ï–ô–°–ê ---

let cachedCaseContents = null; // –ö—ç—à–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑

async function openCaseContents(event) {
    // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ (–∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ –∏–ª–∏ –∫–Ω–æ–ø–∫–µ) - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ
    if (event && event.stopPropagation) {
        event.stopPropagation();
    }
    
    const modal = document.getElementById('case-contents-modal');
    const list = document.getElementById('case-items-list');
    const loader = document.getElementById('contents-loader');
    
    modal.classList.remove('hidden');
    
    // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    if (cachedCaseContents) {
        renderContentsList(cachedCaseContents);
        loader.style.display = 'none';
        return;
    }

    // –ò–Ω–∞—á–µ –≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞
    loader.style.display = 'block';
    list.innerHTML = '';

    try {
        const data = await makeApiRequest('/api/v1/shop/case_contents', 'GET');
        cachedCaseContents = data;
        renderContentsList(data);
    } catch (e) {
        list.innerHTML = `<div style="text-align:center; grid-column:1/-1; color:#ff453a;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
    } finally {
        loader.style.display = 'none';
    }
}

function closeContentsModal() {
    document.getElementById('case-contents-modal').classList.add('hidden');
}

function renderContentsList(items) {
    const list = document.getElementById('case-items-list');
    
    if (!items || items.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#888; grid-column:1/-1;">–ü—É—Å—Ç–æ</div>';
        return;
    }

    // --- –õ–û–ì–ò–ö–ê –°–û–†–¢–ò–†–û–í–ö–ò (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï) ---
    // –ó–∞–¥–∞–µ–º "–≤–µ—Å" –∫–∞–∂–¥–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏. –ß–µ–º –±–æ–ª—å—à–µ —Ü–∏—Ñ—Ä–∞, —Ç–µ–º –≤—ã—à–µ –±—É–¥–µ—Ç –ø—Ä–µ–¥–º–µ—Ç.
    const rarityWeight = {
        'gold': 100,      // –ó–æ–ª–æ—Ç–æ–µ (–ù–æ–∂/–ü–µ—Ä—á–∞—Ç–∫–∏) - –¢–û–ü
        'red': 80,        // –¢–∞–π–Ω–æ–µ (–ö—Ä–∞—Å–Ω–æ–µ)
        'pink': 60,       // –ó–∞—Å–µ–∫—Ä–µ—á–µ–Ω–Ω–æ–µ (–†–æ–∑–æ–≤–æ–µ)
        'purple': 40,     // –ó–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ (–§–∏–æ–ª–µ—Ç–æ–≤–æ–µ)
        'blue': 20,       // –ê—Ä–º–µ–π—Å–∫–æ–µ (–°–∏–Ω–µ–µ)
        'common': 0       // –®–∏—Ä–ø–æ—Ç—Ä–µ–±
    };

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫
    items.sort((a, b) => {
        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å (–∑–∞—â–∏—Ç–∞ –æ—Ç null)
        const rA = (a.rarity || 'common').toLowerCase();
        const rB = (b.rarity || 'common').toLowerCase();

        // 1. –ò—â–µ–º –≤–µ—Å —Ä–µ–¥–∫–æ—Å—Ç–∏ (–µ—Å–ª–∏ —Ä–µ–¥–∫–æ—Å—Ç—å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è, —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ common)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (includes), —Ç.–∫. –º–æ–∂–µ—Ç –±—ã—Ç—å "ancient (red)"
        let weightA = 0;
        let weightB = 0;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Å A
        if (rA.includes('gold')) weightA = 100;
        else if (rA.includes('red') || rA.includes('ancient')) weightA = 80;
        else if (rA.includes('pink') || rA.includes('legendary')) weightA = 60;
        else if (rA.includes('purple') || rA.includes('mythical')) weightA = 40;
        else if (rA.includes('blue') || rA.includes('rare')) weightA = 20;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Å B
        if (rB.includes('gold')) weightB = 100;
        else if (rB.includes('red') || rB.includes('ancient')) weightB = 80;
        else if (rB.includes('pink') || rB.includes('legendary')) weightB = 60;
        else if (rB.includes('purple') || rB.includes('mythical')) weightB = 40;
        else if (rB.includes('blue') || rB.includes('rare')) weightB = 20;

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –ø–æ –≤–µ—Å—É (—É–±—ã–≤–∞–Ω–∏–µ), –ø–æ—Ç–æ–º –ø–æ —Ü–µ–Ω–µ (—É–±—ã–≤–∞–Ω–∏–µ)
        if (weightB !== weightA) {
            return weightB - weightA; // –ö—Ç–æ "—Ç—è–∂–µ–ª–µ–µ" (—Ä–µ–¥—á–µ), —Ç–æ—Ç –≤—ã—à–µ
        }
        // –ï—Å–ª–∏ —Ä–µ–¥–∫–æ—Å—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è ‚Äî —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ (–¥–æ—Ä–æ–≥–∏–µ –≤—ã—à–µ)
        return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
    });
    // ----------------------------------------

    // –†–µ–Ω–¥–µ—Ä (–æ—Å—Ç–∞–ª—Å—è –ø—Ä–µ–∂–Ω–∏–º, –Ω–æ —Ç–µ–ø–µ—Ä—å —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω)
    list.innerHTML = items.map(item => {
        let rClass = 'blue'; 
        const r = (item.rarity || '').toLowerCase();
        
        if (r.includes('purple') || r.includes('mythical')) rClass = 'purple';
        else if (r.includes('pink') || r.includes('legendary')) rClass = 'pink';
        else if (r.includes('red') || r.includes('ancient')) rClass = 'red';
        else if (r.includes('gold')) rClass = 'gold';

        const shortName = item.name.split('|').pop().trim(); 

        return `
            <div class="content-item ${rClass}">
                <img src="${item.image_url}" loading="lazy">
                <div class="content-name">${shortName}</div>
                <div class="content-quality">${item.condition || 'Factory New'}</div>
            </div>
        `;
    }).join('');
}

// --- 4. –ü–ï–†–ï–•–û–î –í –ü–†–û–§–ò–õ–¨ ---
function goToProfile() {
    window.location.href = "/profile"; 
}

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- –ó–ê–ü–£–°–ö ---
        
        // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ. 
        // –í—Å—è –ª–æ–≥–∏–∫–∞ (—Ç–∏—Ö–∏–π –∑–∞–ø—Ä–æ—Å + —Ç–∞–π–º–µ—Ä –Ω–∞ 2.5 —Å–µ–∫) —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –í–ù–£–¢–†–ò —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.
        initShop();        
    </script>
</body>
</html>
