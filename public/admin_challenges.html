<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Настройка ТГ Испытаний</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="admin.css"> 
  <style>
      body { padding: 20px; padding-bottom: 80px; }
      
      .tier-card {
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.1);
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          position: relative;
      }
      
      .tier-header {
          display: flex; justify-content: space-between; align-items: center;
          margin-bottom: 10px;
          border-bottom: 1px solid rgba(255,255,255,0.05);
          padding-bottom: 8px;
      }
      .tier-title { font-weight: 700; color: #ffd700; font-size: 14px; text-transform: uppercase; }
      
      .remove-tier-btn {
          background: rgba(255, 59, 48, 0.2); color: #ff3b30;
          border: none; border-radius: 6px; width: 24px; height: 24px;
          cursor: pointer; display: flex; align-items: center; justify-content: center;
      }

      .input-group { margin-bottom: 10px; }
      .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; }
      .input-group input, .input-group select {
          width: 100%; box-sizing: border-box;
          background: #222; border: 1px solid #444;
          color: #fff; padding: 10px; border-radius: 8px;
          font-size: 14px; outline: none;
      }
      
      /* Специфичные поля для скинов */
      .skin-settings {
          padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 5px;
          border: 1px dashed #444;
      }

      .add-btn {
          width: 100%; padding: 15px;
          background: rgba(255,255,255,0.1); border: 1px dashed #666;
          color: #fff; border-radius: 12px; cursor: pointer; font-weight: 600;
          margin-bottom: 20px; transition: 0.2s;
      }
      .add-btn:active { background: rgba(255,255,255,0.2); }

      .save-bar {
          position: fixed; bottom: 0; left: 0; width: 100%;
          padding: 15px; box-sizing: border-box;
          background: #1c1c1e; border-top: 1px solid #333;
          z-index: 100;
      }
      .save-btn {
          width: 100%; padding: 14px;
          background: #34c759; color: #fff; border: none;
          border-radius: 12px; font-weight: 800; font-size: 16px;
          box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
      }
  </style>
</head>
<body>

    <div class="page-header">
        <a href="/admin" class="back-button"><i class="fa-solid fa-arrow-left"></i> Админка</a>
        <h1 class="page-header-title">ТГ Испытания</h1>
        <div style="width: 60px;"></div>
    </div>

    <div id="tiers-container">
        <p style="text-align: center; color: #666; margin-top: 30px;">Загрузка...</p>
    </div>

    <button class="add-btn" onclick="addTier()">
        <i class="fa-solid fa-plus"></i> Добавить уровень
    </button>

    <div class="save-bar">
        <button class="save-btn" onclick="saveAll()">СОХРАНИТЬ ИЗМЕНЕНИЯ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let tiersData = [];

        // 1. Загрузка данных
        async function loadData() {
            const container = document.getElementById('tiers-container');
            try {
                // Запрашиваем конфиг (предполагаем ID=1 для основного ТГ челленджа)
                // Или используем спец. эндпоинт. Пока возьмем /api/challenges/list и отфильтруем
                // Но лучше сделать прямой запрос к таблице challenge_templates
                
                // ВРЕМЕННО: Используем заглушку, пока ты не добавишь эндпоинт.
                // В идеале нужен: GET /api/v1/admin/tg_challenge/config
                
                // Пока эмулируем пустой список или дефолт
                tiersData = [
                    { target: 5, reward: 2, type: 'tickets' },
                    { target: 15, reward: 5, type: 'tickets' }
                ]; 
                
                // Если у тебя есть эндпоинт, раскомментируй:
                // const res = await fetch('/api/v1/admin/tg_challenge/get_config', { ... });
                // tiersData = (await res.json()).tiers || [];

                render();
            } catch (e) {
                container.innerHTML = `<p style="color:red; text-align:center;">Ошибка: ${e.message}</p>`;
            }
        }

        // 2. Рендер
        function render() {
            const container = document.getElementById('tiers-container');
            container.innerHTML = '';

            if (tiersData.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#555; margin-bottom:20px;">Нет уровней. Добавьте первый!</p>';
                return;
            }

            tiersData.forEach((tier, index) => {
                const div = document.createElement('div');
                div.className = 'tier-card';
                div.innerHTML = `
                    <div class="tier-header">
                        <span class="tier-title">Уровень ${index + 1}</span>
                        <button class="remove-tier-btn" onclick="removeTier(${index})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div class="input-group" style="flex:1;">
                            <label>Цель (Сообщений)</label>
                            <input type="number" class="inp-target" value="${tier.target || ''}" placeholder="10">
                        </div>
                        <div class="input-group" style="flex:1;">
                            <label>Тип награды</label>
                            <select class="inp-type" onchange="updateRowUI(this)">
                                <option value="tickets" ${tier.type === 'tickets' ? 'selected' : ''}>Билеты</option>
                                <option value="coins" ${tier.type === 'coins' ? 'selected' : ''}>Монеты</option>
                                <option value="skin_random" ${tier.type === 'skin_random' ? 'selected' : ''}>Кейс (Скин)</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group val-box">
                        <label>Количество</label>
                        <input type="number" class="inp-amount" value="${tier.reward || ''}" placeholder="5">
                    </div>

                    <div class="skin-box skin-settings ${tier.type === 'skin_random' ? '' : 'hidden'}" style="display: ${tier.type === 'skin_random' ? 'block' : 'none'}">
                        <label style="color:#ffd700; font-size:10px; margin-bottom:5px;">Настройки Рулетки</label>
                        <div style="display:flex; gap:10px;">
                            <div class="input-group" style="flex:1; margin-bottom:0;">
                                <label>Мин. цена</label>
                                <input type="number" class="inp-min" value="${tier.min_price || 0}">
                            </div>
                            <div class="input-group" style="flex:1; margin-bottom:0;">
                                <label>Макс. цена</label>
                                <input type="number" class="inp-max" value="${tier.max_price || 500}">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 3. Логика UI
        window.addTier = () => {
            tiersData.push({ target: '', reward: '', type: 'tickets' });
            render();
        }

        window.removeTier = (index) => {
            if(confirm('Удалить уровень?')) {
                tiersData.splice(index, 1);
                render();
            }
        }

        window.updateRowUI = (select) => {
            const card = select.closest('.tier-card');
            const valBox = card.querySelector('.val-box');
            const skinBox = card.querySelector('.skin-box');
            
            if (select.value === 'skin_random') {
                valBox.style.display = 'none';
                skinBox.style.display = 'block';
            } else {
                valBox.style.display = 'block';
                skinBox.style.display = 'none';
            }
        }

        // 4. Сбор данных и Сохранение
        window.saveAll = async () => {
            const cards = document.querySelectorAll('.tier-card');
            const newTiers = [];
            let isValid = true;

            cards.forEach(card => {
                const target = parseInt(card.querySelector('.inp-target').value);
                const type = card.querySelector('.inp-type').value;
                const tierObj = { target, type };

                if (!target) isValid = false;

                if (type === 'skin_random') {
                    tierObj.min_price = parseInt(card.querySelector('.inp-min').value) || 0;
                    tierObj.max_price = parseInt(card.querySelector('.inp-max').value) || 100000;
                    tierObj.reward = 1; // 1 скин
                } else {
                    tierObj.reward = parseInt(card.querySelector('.inp-amount').value);
                    if (!tierObj.reward) isValid = false;
                }
                newTiers.push(tierObj);
            });

            if (!isValid) return tg.showAlert("Заполните все поля (Цель и Награда)!");

            // Сортируем по возрастанию цели, чтобы логика не ломалась
            newTiers.sort((a,b) => a.target - b.target);

            const payload = {
                mode: "tiered",
                tiers: newTiers
            };
            
            // ОТПРАВКА НА СЕРВЕР (Нужен новый эндпоинт в Python)
            // Мы будем сохранять это в конкретный challenge_template (ID=1, например)
            // Или создадим спец. конфиг.
            try {
                const btn = document.querySelector('.save-btn');
                btn.textContent = "Сохранение...";
                btn.disabled = true;

                await fetch('/api/v1/admin/tg_challenge/save_config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData, config: payload })
                });

                tg.showPopup({message: "Настройки сохранены!"});
            } catch(e) {
                tg.showAlert("Ошибка: " + e.message);
            } finally {
                document.querySelector('.save-btn').textContent = "СОХРАНИТЬ ИЗМЕНЕНИЯ";
                document.querySelector('.save-btn').disabled = false;
            }
        }

        loadData();
    </script>
</body>
</html>
