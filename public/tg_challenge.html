<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Challenge</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap');

        :root {
            --bg-color: #0b0c10;
            --card-bg: #15161b;
            --primary: #4b69ff;
            --gold: #ffd700;
            --text-main: #ffffff;
            --grad-blue: linear-gradient(90deg, #4b69ff 0%, #3d5afe 100%);
        }

        body {
            margin: 0; padding: 16px;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            padding-bottom: 40px;
            overflow-x: hidden;
        }

        .header h1 { 
            font-size: 22px; font-weight: 800; margin: 0 0 20px 0; text-transform: uppercase; 
            background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- КНОПКА "НАЧАТЬ" (Фиксированный размер) --- */
        .btn-main {
            width: 100%;
            height: 60px;
            border-radius: 14px;
            border: none;
            font-weight: 800; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; transition: 0.2s;
            position: relative; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-main:active { transform: scale(0.98); }
        
        .btn-start {
            background: #2d2f36;
            border: 1px dashed rgba(255,255,255,0.3);
            color: #fff;
        }
        .btn-claim {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            animation: pulse-gold 2s infinite;
        }
        
        /* --- ПАНЕЛЬ ПРОГРЕССА (Вместо кнопки, когда активно) --- */
        .progress-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px 16px;
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 12px;
            position: relative;
        }

        .pc-header { display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 14px; font-weight: 700; color:#ccc; }
        .pc-val { color: #fff; }

        /* Сложный прогресс бар с засечками */
        .multi-stage-track {
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            position: relative;
            margin: 0 5px; /* отступ для иконок */
        }
        
        .multi-stage-fill {
            height: 100%;
            background: var(--grad-blue);
            border-radius: 5px;
            transition: width 0.5s ease-out;
            position: relative;
            z-index: 1;
            box-shadow: 0 0 10px rgba(75, 105, 255, 0.5);
        }

        /* Засечки (Награды) */
        .stage-marker {
            position: absolute;
            top: 50%; transform: translate(-50%, -50%);
            width: 24px; height: 24px;
            background: #222;
            border: 2px solid #555;
            border-radius: 50%;
            z-index: 2;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #aaa;
            transition: 0.3s;
        }
        .stage-marker.active {
            border-color: #ffd700;
            background: #ffd700;
            color: #000;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        /* Подписи под засечками */
        .stage-label {
            position: absolute;
            top: 20px; 
            left: 50%; transform: translateX(-50%);
            font-size: 9px; color: #666;
            white-space: nowrap;
            font-weight: 600;
        }
        .stage-marker.active + .stage-label { color: #ffd700; }

        /* --- КНОПКА ПОДРОБНЕЕ --- */
        .btn-details {
            width: 100%; padding: 14px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            color: #888;
            border-radius: 12px;
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            display: flex; justify-content: center; align-items: center; gap: 5px;
            cursor: pointer;
        }
        .btn-details:active { background: rgba(255,255,255,0.05); }

        /* --- МОДАЛКА --- */
        .details-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 5000; display: flex; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .details-modal.visible { opacity: 1; pointer-events: auto; }
        .details-content {
            background: #1a1b20; width: 100%;
            border-radius: 24px 24px 0 0; padding: 24px;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .details-modal.visible .details-content { transform: translateY(0); }
        .dm-title { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 20px; }
        .dm-info { color: #ccc; font-size: 13px; line-height: 1.6; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-bottom: 15px; }

        /* --- ROULETTE (PIXEL PERFECT) --- */
        .r-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(10px); }
        .r-game-area { width: 100%; height: 200px; position: relative; overflow: hidden; background: rgba(20,20,20,0.5); border-top: 1px solid #333; border-bottom: 1px solid #333; }
        
        .r-marker-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #ffd700; transform: translateX(-50%); z-index: 20; box-shadow: 0 0 15px #ffd700; }
        .r-marker-tri { position: absolute; left: 50%; top: -2px; transform: translateX(-50%); border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 12px solid #ffd700; z-index: 21; }

        .r-track { display: flex; height: 100%; align-items: center; will-change: transform; }
        
        /* FIX: 140px width + 4px margin L + 4px margin R = 148px TOTAL */
        .r-card { 
            width: 140px; height: 140px; margin: 0 4px; 
            background: #1a1b20; border-radius: 12px; flex-shrink: 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 20px rgba(0,0,0,0.3); 
        }
        .r-card img { width: 90px; height: 60px; object-fit: contain; }
        .r-card-name { font-size:10px; color:#888; margin-top:10px; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .win-screen { display: none; text-align: center; width: 100%; padding: 20px; animation: fadeIn 0.5s; box-sizing: border-box; }
        .win-img { width: 160px; filter: drop-shadow(0 0 30px rgba(255,215,0,0.4)); margin: 20px 0; animation: float 3s infinite; }
        
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="header">
        <h1>Дневная Активность</h1>
    </div>

    <div id="app">
        <div style="text-align:center; padding-top:40px; color:#555;">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </div>
    </div>

    <div id="details-modal" class="details-modal">
        <div class="details-content">
            <div class="dm-title" id="dm-title">Информация</div>
            <div class="dm-info">
                <strong>Правила:</strong><br>
                1. Общайся в чате <span style="color:#4b69ff">HATElove</span>.<br>
                2. Сообщения короче 2 символов не считаются.<br>
                3. Спам фильтруется.
            </div>
            <div class="dm-info" id="dm-rewards-list">
                </div>
            <button class="btn-main btn-start" onclick="closeDetails()" style="height:50px; font-size:14px;">Закрыть</button>
        </div>
    </div>

    <div id="r-modal" class="r-modal-overlay">
        <div id="r-area" class="r-game-area">
            <div class="r-marker-line"></div>
            <div class="r-marker-tri"></div>
            <div class="r-track" id="r-track"></div>
        </div>
        <div id="r-win" class="win-screen">
            <h2 style="color:#ffd700; margin:0;">ПОБЕДА!</h2>
            <img id="r-win-img" class="win-img" src="">
            <div id="r-win-name" style="font-weight:700; font-size:16px; margin-bottom:15px; color:#fff;"></div>
            <button class="btn-main btn-claim" onclick="closeRoulette()">ЗАБРАТЬ В ИНВЕНТАРЬ</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const haptic = tg.HapticFeedback;

        // --- ЛОГИКА СУТОК ---
        function checkDailyReset() {
            const lastDate = localStorage.getItem('daily_challenge_last_date');
            const today = new Date().toDateString();
            if (lastDate && lastDate !== today) {
                // Если наступил новый день - очищаем локальный статус
                localStorage.removeItem('daily_challenge_status');
                console.log('New day reset');
            }
        }
        checkDailyReset();

        // --- ДАННЫЕ (ЭМУЛЯЦИЯ API) ---
        // Важно: Структура 1 в 1 как у тебя (вложенные next_tier)
        const mockData = {
            template_id: 1,
            title: "Актив в чате",
            status: localStorage.getItem('daily_challenge_status') || "available", // available, active, ready_to_claim, completed
            current_progress: parseInt(localStorage.getItem('daily_progress') || 0),
            
            // ЭТАП 1
            target: 50,
            reward_amount: 100, reward_type: 'coins',
            
            // ВЛОЖЕННЫЕ ЭТАПЫ (ЦЕПОЧКА)
            next_tier: {
                target: 150, // Общее кол-во (не +150, а всего 150)
                reward: 1, type: 'tickets',
                next_tier: {
                    target: 300,
                    reward: 1, type: 'skin_random', // ФИНАЛ
                    next_tier: null
                }
            }
        };

        // --- ГЛАВНАЯ ФУНКЦИЯ РЕНДЕРА ---
        function render(item) {
            const app = document.getElementById('app');
            app.innerHTML = '';

            // 1. Собираем все этапы в плоский массив для отрисовки шкалы
            const tiers = getAllTiers(item);
            const finalTarget = tiers[tiers.length - 1].target;
            const currentVal = item.current_progress;

            // Если статус "Доступно" - показываем только кнопку "НАЧАТЬ"
            if (item.status === 'available') {
                const btn = document.createElement('button');
                btn.className = 'btn-main btn-start';
                btn.innerHTML = `<i class="fa-solid fa-fire"></i> НАЧАТЬ ИСПЫТАНИЕ`;
                btn.onclick = () => startChallenge(item);
                app.appendChild(btn);
                return;
            }

            // Если статус "Активно" или "Готово к сбору" - показываем Шкалу Этапов
            if (item.status === 'active' || item.status === 'ready_to_claim' || item.status === 'completed') {
                
                const card = document.createElement('div');
                card.className = 'progress-card';

                // Заголовок
                let headerStatus = 'В ПРОЦЕССЕ';
                if (item.status === 'ready_to_claim') headerStatus = 'ЗАБЕРИ НАГРАДУ!';
                if (item.status === 'completed') headerStatus = 'ВСЕ ВЫПОЛНЕНО';

                const displayProgress = Math.min(currentVal, finalTarget);
                
                let html = `
                    <div class="pc-header">
                        <span>${item.title}</span>
                        <span class="pc-val">${displayProgress} / ${finalTarget}</span>
                    </div>
                    
                    <div class="multi-stage-track">
                        <div class="multi-stage-fill" style="width: ${(displayProgress / finalTarget) * 100}%"></div>
                `;

                // РЕНДЕР ЗАСЕЧЕК (МАРКЕРОВ)
                tiers.forEach((tier, index) => {
                    const percent = (tier.target / finalTarget) * 100;
                    const isReached = currentVal >= tier.target;
                    const icon = getRewardIcon(tier.type);
                    
                    html += `
                        <div class="stage-marker ${isReached ? 'active' : ''}" style="left: ${percent}%">
                            ${isReached ? '<i class="fa-solid fa-check"></i>' : icon}
                        </div>
                        <div class="stage-label" style="left: ${percent}%">
                            ${formatRewardShort(tier.reward, tier.type)}
                        </div>
                    `;
                });

                html += `</div>`; // Закрываем track
                card.innerHTML = html;
                app.appendChild(card);

                // Если нужно забрать награду
                if (item.status === 'ready_to_claim') {
                    const claimBtn = document.createElement('button');
                    claimBtn.className = 'btn-main btn-claim';
                    claimBtn.style.marginTop = '10px';
                    claimBtn.innerHTML = `ЗАБРАТЬ НАГРАДУ`;
                    claimBtn.onclick = () => claimReward(item);
                    app.appendChild(claimBtn);
                }

                // Кнопка "УЗНАТЬ ПОДРОБНЕЕ" (всегда снизу)
                const infoBtn = document.createElement('div');
                infoBtn.className = 'btn-details';
                infoBtn.innerHTML = `УЗНАТЬ ПОДРОБНЕЕ <i class="fa-solid fa-chevron-right" style="font-size:10px;"></i>`;
                infoBtn.onclick = () => openDetails(tiers);
                app.appendChild(infoBtn);
                
                // Если выполнено (на сегодня)
                if (item.status === 'completed') {
                     const doneMsg = document.createElement('div');
                     doneMsg.style.textAlign='center'; doneMsg.style.color='#666'; doneMsg.style.marginTop='10px'; doneMsg.style.fontSize='12px';
                     doneMsg.innerHTML = "Приходите завтра за новыми заданиями!";
                     app.appendChild(doneMsg);
                }
            }
        }

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

        // Разворачиваем вложенность next_tier в массив
        function getAllTiers(rootItem) {
            let list = [];
            // Первый этап (текущий в корне объекта или базовый)
            // В твоей структуре rootItem обновляется сервером.
            // Но чтобы нарисовать полную шкалу, нам нужно знать "историю".
            // Для простоты примера считаем, что mockData содержит полную структуру.
            
            // Добавляем текущий таргет (или первый, если мы в начале)
            list.push({ target: rootItem.target, reward: rootItem.reward_amount, type: rootItem.reward_type });
            
            let current = rootItem.next_tier;
            while(current) {
                list.push({ target: current.target, reward: current.reward || current.rewards, type: current.type });
                current = current.next_tier;
            }
            return list;
        }

        function getRewardIcon(type) {
            if(type === 'coins') return '<i class="fa-solid fa-coins"></i>';
            if(type === 'tickets') return '<i class="fa-solid fa-ticket"></i>';
            if(type === 'skin_random') return '<i class="fa-solid fa-fire"></i>';
            return '<i class="fa-solid fa-gift"></i>';
        }

        function formatRewardShort(amount, type) {
            if(type === 'skin_random') return 'Skin';
            if(type === 'coins') return amount;
            if(type === 'tickets') return amount + ' tkt';
            return amount;
        }

        // --- ДЕЙСТВИЯ ---

        function startChallenge(item) {
            haptic.impactOccurred('medium');
            // Эмуляция отправки на сервер
            item.status = 'active';
            localStorage.setItem('daily_challenge_status', 'active');
            
            // Для теста сразу ставим прогресс, чтобы показать функционал
            // В реальности тут 0
            item.current_progress = 20; 
            localStorage.setItem('daily_progress', 20);
            
            render(item);
        }

        function claimReward(item) {
            haptic.notificationOccurred('success');
            
            // Проверяем, какой этап мы закрыли.
            // Если это был скин -> Рулетка
            if (item.reward_type === 'skin_random') {
                 // Запуск рулетки
                 const skins = [
                     {name: 'AK-47 | Slate', image_url: 'https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfDhjxszJemkV092lnYmGm_7zN4Tck29Y_cg_3r_C9I_xjVax_kZtZ2_6JoWddVI5ZQrS8gW4xO_qjJ69u5rJz3Jj6CdxsSqPyhC_h0oaO_sv26Is8_1nkw', rarity:'purple'},
                     {name: 'AWP | Atheris', image_url: 'https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0n_L1JaKfzzoGuJJ02e2W8d6m2gztrkRoZmigItDGcgA_YVzSq1K7xL_qjJ65vM7BmnI26nUl5yrZzRzm1xEMH5O9J02d', rarity:'blue'},
                     {name: 'M4A1-S | Printstream', image_url: 'https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpou-6kejhz2v_Nfz5H_uO1gb-Gw_alIITfn2xZ_Mhwd87Ot3v3gLZrNWn6J9CSdgM_YV_V8lfqx-7ug8XovZ_Mz3FmpGB8sr2f8X7L', rarity:'gold'} // WINNER
                 ];
                 launchRoulette(skins, skins[2]); // Допустим выиграл 3-й
            } else {
                // Если просто монеты - переход к след. этапу
                proceedNextTier(item);
            }
        }

        function proceedNextTier(item) {
            // ЛОГИКА ПЕРЕХОДА (1 в 1)
            if (item.next_tier) {
                // Сервер должен вернуть обновленный объект. 
                // Эмулируем обновление объекта:
                // Текущие параметры заменяются параметрами next_tier
                const next = item.next_tier;
                item.target = next.target;
                item.reward_amount = next.reward || next.rewards;
                item.reward_type = next.type;
                item.next_tier = next.next_tier; // Сдвигаем вложенность
                
                item.status = 'active'; // Снова активен (след этап)
                render(item);
            } else {
                item.status = 'completed';
                // Запоминаем дату завершения, чтобы сбросить только завтра
                localStorage.setItem('daily_challenge_last_date', new Date().toDateString());
                localStorage.setItem('daily_challenge_status', 'completed');
                render(item);
            }
        }

        // --- МОДАЛКА И РУЛЕТКА ---

        function openDetails(tiers) {
            const list = document.getElementById('dm-rewards-list');
            list.innerHTML = '<strong>Награды по этапам:</strong><br>';
            tiers.forEach((t, i) => {
                list.innerHTML += `Этап ${i+1}: ${t.target} смс — <span style="color:#ffd700">${formatRewardShort(t.reward, t.type)}</span><br>`;
            });
            document.getElementById('details-modal').classList.add('visible');
        }
        function closeDetails() { document.getElementById('details-modal').classList.remove('visible'); }

        function launchRoulette(items, winner) {
            const modal = document.getElementById('r-modal');
            const track = document.getElementById('r-track');
            const area = document.getElementById('r-area');
            const winScreen = document.getElementById('r-win');

            modal.style.display = 'flex';
            area.style.display = 'block';
            winScreen.style.display = 'none';
            track.style.transition = 'none';
            track.style.transform = 'translateX(0)';

            // Генерация ленты
            let tape = [];
            for(let i=0; i<50; i++) tape = tape.concat(items);
            const WIN_INDEX = 65;
            tape[WIN_INDEX] = winner;
            
            track.innerHTML = tape.map(item => `
                <div class="r-card" style="border-color:${getColor(item.rarity)}">
                    <img src="${item.image_url}">
                    <div class="r-card-name">${item.name}</div>
                </div>
            `).join('');

            // МАТЕМАТИКА (PIXEL PERFECT + CENTER)
            const cardW = 140; 
            const margin = 8; // 4+4
            const fullW = cardW + margin;
            
            const screenCenter = window.innerWidth / 2;
            const winnerCenter = (WIN_INDEX * fullW) + (fullW / 2);
            
            // 1. Сначала перекручиваем (Overshoot)
            // Добавляем рандом 20-50 пикселей, чтобы пролетело мимо центра
            const overshoot = (Math.random() > 0.5 ? 1 : -1) * (20 + Math.random() * 30);
            const targetPos = -(winnerCenter - screenCenter);
            const stopPos = targetPos + overshoot;

            setTimeout(() => {
                // Быстрый спин с замедлением
                track.style.transition = 'transform 6s cubic-bezier(0.1, 0, 0.1, 1)'; 
                track.style.transform = `translateX(${stopPos}px)`;

                let tick = setInterval(() => haptic.selectionChanged(), 100);

                setTimeout(() => {
                    clearInterval(tick);
                    
                    // 2. МЕДЛЕННАЯ ДОВОДКА В ЦЕНТР
                    track.style.transition = 'transform 1s ease-in-out';
                    track.style.transform = `translateX(${targetPos}px)`;
                    haptic.impactOccurred('heavy');

                    setTimeout(() => {
                        haptic.notificationOccurred('success');
                        area.style.display = 'none';
                        document.getElementById('r-win-img').src = winner.image_url;
                        document.getElementById('r-win-name').innerText = winner.name;
                        winScreen.style.display = 'block';
                        
                        // После закрытия рулетки -> след. этап
                        // В реальном коде это вызовется при нажатии "ЗАБРАТЬ"
                    }, 1200);

                }, 6100);
            }, 100);
        }

        function closeRoulette() {
            document.getElementById('r-modal').style.display = 'none';
            // После рулетки переходим к след этапу
            proceedNextTier(mockData);
        }

        function getColor(rarity) {
            if(rarity==='gold') return '#ffd700';
            if(rarity==='purple') return '#8847ff';
            return '#4b69ff';
        }

        // Эмуляция прогресса для демонстрации (Можно удалить)
        // setTimeout(() => {
        //     if(mockData.status === 'active' && mockData.current_progress < 50) {
        //         mockData.current_progress = 50;
        //         mockData.status = 'ready_to_claim';
        //         render(mockData);
        //     }
        // }, 2000);

        render(mockData);

    </script>
</body>
</html>
