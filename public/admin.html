<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админ-панель</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --bg-gradient: radial-gradient(ellipse at 50% 100%, #041a07, #000000);
      --bg-color: #000000;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --primary-color: #34c759;
      --action-color: #007aff;
      --surface-glass-bg: rgba(28, 28, 30, 0.75);
      --divider-glass-color: rgba(58, 58, 60, 0.6);
      --danger-color: #ff3b30;
      --warning-color: #ff9500;
      --status-active-color: #32d74b;
      --status-inactive-color: #98989a;
      --loader-color: #34c759;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      position: relative;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid var(--text-color);
      border-bottom-color: var(--loader-color);
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }

    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    } 

    .app-container {
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top));
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .page-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .page-header h1, .page-header-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: var(--text-color);
    }
    
    .back-button {
      background: transparent;
      border: none;
      color: var(--action-color);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }

    .back-button:active {
      background-color: rgba(0, 122, 255, 0.1);
    }
    
    .admin-menu-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .admin-menu-button {
      background: var(--surface-glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid var(--divider-glass-color);
      color: var(--text-color);
      text-align: left;
      font-size: 18px;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    
    .admin-menu-button .fa {
      font-size: 24px;
      color: var(--primary-color);
    }

    .admin-menu-button:active {
      transform: scale(0.98);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    
    .admin-setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--divider-glass-color);
    }

    .admin-setting-item:last-child {
        border-bottom: none;
    }
    
    .admin-setting-label {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
    }
    
    .toggle-switch input[type="checkbox"] {
        display: none;
    }

    .toggle-switch .slider {
        position: relative;
        cursor: pointer;
        display: inline-block;
        width: 45px;
        height: 25px;
        background-color: var(--text-color-muted);
        border-radius: 25px;
        transition: background-color 0.4s;
    }

    .toggle-switch .slider:before {
        content: '';
        position: absolute;
        height: 21px;
        width: 21px;
        left: 2px;
        bottom: 2px;
        background-color: var(--text-color);
        border-radius: 50%;
        transition: transform 0.4s;
    }
    
    .toggle-switch input[type="checkbox"]:checked + .slider {
        background-color: var(--primary-color);
    }

    .toggle-switch input[type="checkbox"]:checked + .slider:before {
        transform: translateX(20px);
    }
    
    .admin-settings-container {
        padding: 15px;
        background: var(--surface-glass-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 15px;
        border: 1px solid var(--divider-glass-color);
    }

    .hidden {
      display: none !important;
    }
    
    /* Стили для квестов и категорий */
    .quest-list, .category-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .quest-item, .category-item {
        background: var(--surface-glass-bg);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid var(--divider-glass-color);
    }
    
    .quest-item h4, .category-item h4 {
        margin: 0 0 10px 0;
    }
    
    .quest-item p, .category-item p {
        margin: 0;
    }
    
    .add-new-button {
        background-color: var(--action-color);
        color: var(--text-color);
        border: none;
        padding: 15px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
        transition: background-color 0.2s ease;
    }
    
    .add-new-button:active {
        background-color: #006ee6;
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: var(--surface-glass-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        border: 1px solid var(--divider-glass-color);
    }
    
    .modal-content h3 {
        margin-top: 0;
    }
    
    .modal-form label {
        display: block;
        margin-top: 10px;
    }
    
    .modal-form input, .modal-form textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid var(--divider-glass-color);
        background-color: rgba(0, 0, 0, 0.3);
        color: var(--text-color);
    }
    
    .modal-form button {
        margin-top: 20px;
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        background-color: var(--action-color);
        color: var(--text-color);
    }
    
    .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .modal-buttons button {
        flex-grow: 1;
    }
    
    .edit-button, .delete-button {
        background-color: var(--action-color);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .delete-button {
        background-color: var(--danger-color);
    }

    .item-actions {
        display: flex;
        gap: 5px;
        margin-top: 10px;
    }
    
    .error-message {
        color: var(--danger-color);
        text-align: center;
        margin-top: 20px;
    }

    #statistics-content p {
        background: var(--surface-glass-bg);
        border-radius: 10px;
        padding: 10px;
        border: 1px solid var(--divider-glass-color);
        margin-bottom: 10px;
    }
  </style>
</head>
<body>
    <div id="loader-overlay" class="loading-overlay hidden">
        <span class="loader"></span>
    </div>

    <div id="app-container" class="app-container">

        <div id="view-admin-main" class="admin-view">
            <div class="page-header">
                <h1 class="page-header-title">Админ-панель</h1>
            </div>
            <div class="admin-menu-buttons">
                <button class="admin-menu-button" data-view="view-admin-settings">
                    <i class="fa fa-cog"></i> Настройки
                </button>
                <button class="admin-menu-button" data-view="view-admin-quests">
                    <i class="fa fa-clipboard-list"></i> Управление квестами
                </button>
                <button class="admin-menu-button" data-view="view-admin-categories">
                    <i class="fa fa-tags"></i> Управление категориями
                </button>
                 <button class="admin-menu-button" data-view="view-admin-statistics">
                    <i class="fa fa-chart-line"></i> Статистика
                </button>
            </div>
        </div>

        <div id="view-admin-settings" class="admin-view hidden">
            <div class="page-header">
                <button class="back-button" data-back-to="view-admin-main"><i class="fa fa-arrow-left"></i> Назад</button>
                <h1 class="page-header-title">Настройки</h1>
            </div>
            <div class="admin-settings-container">
                <div class="admin-setting-item">
                    <span class="admin-setting-label">Спящий режим</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sleepModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="view-admin-quests" class="admin-view hidden">
            <div class="page-header">
                <button class="back-button" data-back-to="view-admin-main"><i class="fa fa-arrow-left"></i> Назад</button>
                <h1 class="page-header-title">Управление квестами</h1>
            </div>
            <div id="quest-list" class="quest-list"></div>
            <button class="add-new-button" id="add-quest-button">
                <i class="fa fa-plus-circle"></i> Добавить новый квест
            </button>
        </div>
        
        <div id="view-admin-categories" class="admin-view hidden">
            <div class="page-header">
                <button class="back-button" data-back-to="view-admin-main"><i class="fa fa-arrow-left"></i> Назад</button>
                <h1 class="page-header-title">Управление категориями</h1>
            </div>
            <div id="category-list" class="category-list"></div>
            <button class="add-new-button" id="add-category-button">
                <i class="fa fa-plus-circle"></i> Добавить новую категорию
            </button>
        </div>

        <div id="view-admin-statistics" class="hidden">
            <div class="page-header">
                <button class="back-button" data-back-to="view-admin-main"><i class="fa fa-arrow-left"></i> Назад</button>
                <h1 class="page-header-title">Статистика</h1>
            </div>
            <div id="statistics-content">
                </div>
        </div>
        
        <div id="quest-modal" class="modal hidden">
            <div class="modal-content">
                <h3 id="quest-modal-title"></h3>
                <form id="quest-form" class="modal-form">
                    <input type="hidden" id="quest-id">
                    <label for="quest-title">Название</label>
                    <input type="text" id="quest-title" required>
                    
                    <label for="quest-description">Описание</label>
                    <textarea id="quest-description"></textarea>
                    
                    <label for="quest-reward-amount">Награда (билеты)</label>
                    <input type="number" id="quest-reward-amount" required>
                    
                    <label for="quest-target-value">Целевое значение</label>
                    <input type="number" id="quest-target-value" required>
                    
                    <label for="quest-icon-url">URL иконки</label>
                    <input type="url" id="quest-icon-url">
                    
                    <label for="quest-action-url">URL действия</label>
                    <input type="url" id="quest-action-url">

                    <label for="quest-category-id">Категория</label>
                    <select id="quest-category-id"></select>

                    <label for="quest-end-date">Дата окончания</label>
                    <input type="datetime-local" id="quest-end-date">

                    <label>
                      <input type="checkbox" id="quest-is-repeatable"> Повторяемый
                    </label>

                    <button type="submit" id="quest-save-button">Сохранить</button>
                </form>
                <div class="modal-buttons">
                    <button id="quest-delete-button" class="delete-button hidden">Удалить</button>
                    <button id="quest-cancel-button">Отмена</button>
                </div>
            </div>
        </div>
        
        <div id="category-modal" class="modal hidden">
            <div class="modal-content">
                <h3 id="category-modal-title"></h3>
                <form id="category-form" class="modal-form">
                    <input type="hidden" id="category-id">
                    <label for="category-name">Название</label>
                    <input type="text" id="category-name" required>
                    <button type="submit" id="category-save-button">Сохранить</button>
                </form>
                <div class="modal-buttons">
                    <button id="category-delete-button" class="delete-button hidden">Удалить</button>
                    <button id="category-cancel-button">Отмена</button>
                </div>
            </div>
        </div>

    </div>

    <script>
    const tg = window.Telegram.WebApp;

    function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
    function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }
    function showModal(modal) { modal.classList.remove('hidden'); }
    function hideModal(modal) { modal.classList.add('hidden'); }

    try {
        const dom = {
            appContainer: document.getElementById('app-container'),
            loaderOverlay: document.getElementById('loader-overlay'),
            adminMain: document.getElementById('view-admin-main'),
            sleepModeToggle: document.getElementById('sleepModeToggle'),
            viewAdminSettings: document.getElementById('view-admin-settings'),
            viewAdminQuests: document.getElementById('view-admin-quests'),
            viewAdminCategories: document.getElementById('view-admin-categories'),
            questList: document.getElementById('quest-list'),
            categoryList: document.getElementById('category-list'),
            questModal: document.getElementById('quest-modal'),
            categoryModal: document.getElementById('category-modal'),
            statisticsContent: document.getElementById('statistics-content'), // <== НОВАЯ СТРОКА
        };

        let currentView = 'view-admin-main';
        let categoriesData = [];

        async function makeApiRequest(url, data, method = 'POST', showLoading = false) {
            if (showLoading) showLoader();
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...data, initData: tg.initData }),
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.detail || 'Ошибка API');
                }
                return result;
            } finally {
                if (showLoading) hideLoader();
            }
        }
        
        function updateSleepButton(status) {
            dom.sleepModeToggle.checked = status.is_active;
        }

        async function loadStatistics() {
            showLoader();
            try {
                const stats = await makeApiRequest("/api/v1/admin/stats", {}, 'POST', true);
                let visitorsHtml = `
                    <h3>Посетители</h3>
                    <p><strong>За день:</strong> ${stats.visitors.day}</p>
                    <p><strong>За месяц:</strong> ${stats.visitors.month}</p>
                    <p><strong>За год:</strong> ${stats.visitors.year}</p>
                `;

                let eventsHtml = `<h3>Участники в розыгрышах</h3>`;
                stats.events.forEach(event => {
                    eventsHtml += `<p><strong>${event.title}:</strong> ${event.participants} участников</p>`;
                });
                
                dom.statisticsContent.innerHTML = visitorsHtml + eventsHtml;

            } catch (e) {
                dom.statisticsContent.innerHTML = `<p class="error-message">Не удалось загрузить статистику: ${e.message}</p>`;
            } finally {
                hideLoader();
            }
        }

        async function switchView(viewId) {
            const allViews = document.querySelectorAll('.admin-view, #view-admin-statistics');
            allViews.forEach(view => view.classList.add('hidden'));

            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }

            if (viewId === 'view-admin-quests') {
                await loadQuests();
            } else if (viewId === 'view-admin-categories') {
                await loadCategories();
            } else if (viewId === 'view-admin-statistics') {
                await loadStatistics();
            }

            currentView = viewId;
            updateBackButtonVisibility();
        }
        
        function updateBackButtonVisibility() {
            const backButtons = document.querySelectorAll('.back-button');
            backButtons.forEach(btn => {
                btn.style.visibility = (currentView !== 'view-admin-main') ? 'visible' : 'hidden';
            });
        }
        
        async function loadQuests() {
            showLoader();
            try {
                const quests = await makeApiRequest('/api/v1/admin/quests/list', {}, 'POST');
                dom.questList.innerHTML = '';
                quests.forEach(quest => {
                    const questItem = document.createElement('div');
                    questItem.className = 'quest-item';
                    questItem.innerHTML = `
                        <h4>${quest.title}</h4>
                        <p>${quest.description || 'Нет описания'}</p>
                        <p>Награда: ${quest.reward_amount} билетов</p>
                        <p>Цель: ${quest.target_value}</p>
                        <div class="item-actions">
                            <button class="edit-button" data-id="${quest.id}">Редактировать</button>
                        </div>
                    `;
                    dom.questList.appendChild(questItem);
                });
            } catch (e) {
                dom.questList.innerHTML = `<p class="error-message">Не удалось загрузить квесты: ${e.message}</p>`;
            } finally {
                hideLoader();
            }
        }
        
        async function loadCategories() {
            showLoader();
            try {
                categoriesData = await makeApiRequest('/api/v1/admin/categories/list', {}, 'POST');
                dom.categoryList.innerHTML = '';
                categoriesData.forEach(cat => {
                    const catItem = document.createElement('div');
                    catItem.className = 'category-item';
                    catItem.innerHTML = `
                        <h4>${cat.name}</h4>
                        <div class="item-actions">
                            <button class="edit-button" data-id="${cat.id}">Редактировать</button>
                        </div>
                    `;
                    dom.categoryList.appendChild(catItem);
                });
            } catch (e) {
                dom.categoryList.innerHTML = `<p class="error-message">Не удалось загрузить категории: ${e.message}</p>`;
            } finally {
                hideLoader();
            }
        }

        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const targetView = e.target.closest('[data-view]')?.dataset.view;
                const backToView = e.target.closest('[data-back-to]')?.dataset.backTo;
                
                if (targetView) {
                    switchView(targetView);
                } else if (backToView) {
                    switchView(backToView);
                }

                if (e.target.id === 'sleepModeToggle') {
                    toggleSleepMode(e.target.checked);
                }
                
                if (e.target.id === 'add-quest-button') {
                    openQuestModal();
                }
                
                if (e.target.id === 'add-category-button') {
                    openCategoryModal();
                }

                if (e.target.classList.contains('edit-button')) {
                    const id = e.target.dataset.id;
                    if (currentView === 'view-admin-quests') {
                        openQuestModal(id);
                    } else if (currentView === 'view-admin-categories') {
                        openCategoryModal(id);
                    }
                }
            });

            document.getElementById('quest-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveQuest();
            });

            document.getElementById('category-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveCategory();
            });

            document.getElementById('quest-cancel-button').addEventListener('click', () => {
                hideModal(dom.questModal);
            });

            document.getElementById('category-cancel-button').addEventListener('click', () => {
                hideModal(dom.categoryModal);
            });
            
            document.getElementById('quest-delete-button').addEventListener('click', async () => {
                await deleteQuest();
            });
            
            document.getElementById('category-delete-button').addEventListener('click', async () => {
                await deleteCategory();
            });
        }
        
        async function openQuestModal(id = null) {
            const form = document.getElementById('quest-form');
            form.reset();
            document.getElementById('quest-id').value = '';
            document.getElementById('quest-modal-title').textContent = 'Новый квест';
            document.getElementById('quest-delete-button').classList.add('hidden');
            
            // Загрузка категорий для select
            const categorySelect = document.getElementById('quest-category-id');
            categorySelect.innerHTML = '<option value="">Нет категории</option>';
            categoriesData.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });

            if (id) {
                showLoader();
                try {
                    const quest = await makeApiRequest(`/api/v1/admin/quests/get/${id}`, {}, 'POST');
                    document.getElementById('quest-id').value = quest.id;
                    document.getElementById('quest-title').value = quest.title;
                    document.getElementById('quest-description').value = quest.description || '';
                    document.getElementById('quest-reward-amount').value = quest.reward_amount;
                    document.getElementById('quest-target-value').value = quest.target_value;
                    document.getElementById('quest-icon-url').value = quest.icon_url || '';
                    document.getElementById('quest-action-url').value = quest.action_url || '';
                    document.getElementById('quest-category-id').value = quest.category_id || '';
                    document.getElementById('quest-end-date').value = quest.end_date ? new Date(quest.end_date).toISOString().slice(0, 16) : '';
                    document.getElementById('quest-is-repeatable').checked = quest.is_repeatable;
                    
                    document.getElementById('quest-modal-title').textContent = 'Редактировать квест';
                    document.getElementById('quest-delete-button').classList.remove('hidden');
                } catch (e) {
                    alert('Не удалось загрузить данные квеста: ' + e.message);
                    return;
                } finally {
                    hideLoader();
                }
            }
            showModal(dom.questModal);
        }

        async function saveQuest() {
            const id = document.getElementById('quest-id').value;
            const url = id ? `/api/v1/admin/quests/update/${id}` : '/api/v1/admin/quests/create';
            const method = id ? 'PUT' : 'POST';
            
            const data = {
                title: document.getElementById('quest-title').value,
                description: document.getElementById('quest-description').value,
                reward_amount: parseInt(document.getElementById('quest-reward-amount').value),
                target_value: parseInt(document.getElementById('quest-target-value').value),
                icon_url: document.getElementById('quest-icon-url').value || null,
                action_url: document.getElementById('quest-action-url').value || null,
                category_id: document.getElementById('quest-category-id').value || null,
                end_date: document.getElementById('quest-end-date').value || null,
                is_repeatable: document.getElementById('quest-is-repeatable').checked,
            };
            
            try {
                await makeApiRequest(url, data, method, true);
                hideModal(dom.questModal);
                await loadQuests();
                tg.showAlert('Квест успешно сохранен!');
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        
        async function deleteQuest() {
            if (!confirm('Вы уверены, что хотите удалить этот квест?')) return;
            const id = document.getElementById('quest-id').value;
            try {
                await makeApiRequest(`/api/v1/admin/quests/delete/${id}`, {}, 'DELETE', true);
                hideModal(dom.questModal);
                await loadQuests();
                tg.showAlert('Квест успешно удален!');
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }

        async function openCategoryModal(id = null) {
            const form = document.getElementById('category-form');
            form.reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-modal-title').textContent = 'Новая категория';
            document.getElementById('category-delete-button').classList.add('hidden');

            if (id) {
                showLoader();
                try {
                    const category = await makeApiRequest(`/api/v1/admin/categories/get/${id}`, {}, 'POST');
                    document.getElementById('category-id').value = category.id;
                    document.getElementById('category-name').value = category.name;
                    document.getElementById('category-modal-title').textContent = 'Редактировать категорию';
                    document.getElementById('category-delete-button').classList.remove('hidden');
                } catch (e) {
                    alert('Не удалось загрузить данные категории: ' + e.message);
                    return;
                } finally {
                    hideLoader();
                }
            }
            showModal(dom.categoryModal);
        }
        
        async function saveCategory() {
            const id = document.getElementById('category-id').value;
            const url = id ? `/api/v1/admin/categories/update/${id}` : '/api/v1/admin/categories/create';
            const method = id ? 'PUT' : 'POST';
            
            const data = {
                name: document.getElementById('category-name').value,
            };
            
            try {
                await makeApiRequest(url, data, method, true);
                hideModal(dom.categoryModal);
                await loadCategories();
                tg.showAlert('Категория успешно сохранена!');
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        
        async function deleteCategory() {
            if (!confirm('Вы уверены, что хотите удалить эту категорию?')) return;
            const id = document.getElementById('category-id').value;
            try {
                await makeApiRequest(`/api/v1/admin/categories/delete/${id}`, {}, 'DELETE', true);
                hideModal(dom.categoryModal);
                await loadCategories();
                tg.showAlert('Категория успешно удалена!');
            } catch (e) {
                tg.showAlert('Ошибка: ' + e.message);
            }
        }
        
        async function toggleSleepMode(isChecked) {
            try {
                const url = '/api/v1/admin/sleep_mode_status';
                const method = 'POST';
                const data = { is_active: isChecked };
                await makeApiRequest(url, data, method);
                tg.showAlert(`Спящий режим ${isChecked ? 'включен' : 'выключен'}.`);
            } catch (e) {
                tg.showAlert(`Ошибка при изменении статуса спящего режима: ${e.message}`);
                dom.sleepModeToggle.checked = !isChecked; // Откатываем UI в случае ошибки
            }
        }

        async function main() {
            try {
                tg.expand();
                if (!tg.initData) throw new Error("Требуется авторизация в Telegram.");
                
                showLoader();
                const [userData, sleepStatus] = await Promise.all([
                    makeApiRequest("/api/v1/user/me", {}, 'POST', true),
                    makeApiRequest("/api/v1/admin/sleep_mode_status", {}, 'POST', true)
                ]);
                
                if (!userData.is_admin) throw new Error("Доступ запрещен.");
                
                document.body.dataset.isAdmin = 'true';
                updateSleepButton(sleepStatus);

                await switchView('view-admin-main');
            } catch (e) {
                document.body.dataset.isAdmin = 'false';
                dom.sleepModeToggle.classList.add('hidden');
                dom.appContainer.innerHTML = `<div style="padding:20px; text-align:center;"><h1>${e.message}</h1><p>Убедитесь, что вы являетесь администратором.</p></div>`;
            } finally {
                hideLoader();
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            tg.ready();
            setupEventListeners();
            main();
        });
    } catch (e) {
        console.error(`Критическая ошибка на старте: ${e.message}`);
        alert(`Критическая ошибка: ${e.message}`);
    }
    </script>
</body>
</html>
