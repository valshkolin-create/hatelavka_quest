<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Гонка за скинами</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        /* ... (все твои стили остаются без изменений) ... */
        :root {
            --background-main: #100e19;
            --surface-primary: #1c1a27;
            --surface-secondary: #2a2738;
            --border-color: #3c3852;
            --text-primary: #f0f0f5;
            --text-secondary: #a09cb8;
            --accent-primary: #00f2ea;
            --accent-secondary: #d433ff;
            --danger-color: #ff4d4d;
            --winner-color: #ffd700;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-main);
            color: var(--text-primary);
            margin: 0;
            padding: 15px 15px 100px;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto;
            transition: filter 0.3s ease; /* Плавный переход для блюра */
        }
        /* СТИЛИ ДЛЯ БЛЮРА И БЛОКИРОВКИ */
        .access-denied .container {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }
        .access-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            color: var(--text-primary);
        }
        .access-overlay i {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--accent-secondary);
        }
        .access-overlay h2 {
            font-size: 22px;
            margin: 0 0 10px;
        }
        .access-overlay p {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 300px;
        }
        /* ... (остальные твои стили) ... */
        .page-title { text-align: center; font-size: 22px; /* ... */ }
        .timer { text-align: center; font-size: 1.4em; /* ... */ }
        /* ... (и так далее) ... */
    </style>
</head>
<body class="access-denied"> <div id="access-overlay" class="access-overlay">
        <i class="fa-solid fa-lock"></i>
        <h2>Доступ ограничен</h2>
        <p>Этот раздел находится в разработке. Доступ будет открыт позже.</p>
    </div>

    <div class="container">
        <h1 class="page-title" data-key="mainTitle" data-editable>Гонка за скинами</h1>
        <div id="countdown-timer" class="timer" data-key="raffleEndTime" data-editable></div>
        <div id="events-list" class="events-container"></div>
        </div>
    
    <div id="admin-access-controls" class="admin-controls" style="display: none; bottom: calc(120px + env(safe-area-inset-bottom));">
        <button id="grant-access-btn" style="background: #007aff;">Выдать доступ</button>
    </div>
    
    <div id="admin-controls" class="admin-controls" style="display: none;">
        <button id="edit-btn">Редактировать</button>
        <button id="save-btn">Сохранить</button>
    </div>

    <footer class="app-footer">
        </footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tg = window.Telegram.WebApp;
        // ... (весь твой JS до функции initialize) ...
        const dom = {
            // ...
            adminAccessControls: document.getElementById('admin-access-controls'), // <-- Новая кнопка
            grantAccessBtn: document.getElementById('grant-access-btn'), // <-- Новая кнопка
            // ...
        };

        // ... (все твои функции до initialize) ...

        async function initialize() {
            tg.ready();
            tg.expand();

            // Функция для разблокировки страницы
            const unlockPage = () => {
                document.body.classList.remove('access-denied');
                document.getElementById('access-overlay').style.display = 'none';
            };

            if (tg.initData && tg.initData.length > 0) {
                try {
                    // СНАЧАЛА ЗАПРАШИВАЕМ ПОЛЬЗОВАТЕЛЯ, ЧТОБЫ ПРОВЕРИТЬ ДОСТУП
                    const userRes = await fetch('/api/v1/user/me', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ initData: tg.initData }) });
                    if (!userRes.ok) throw new Error("Ошибка сети при проверке пользователя");
                    userData = await userRes.json();

                    // ПРОВЕРКА ДОСТУПА
                    // Доступ есть у админов ИЛИ у тех, кому его выдали (has_events_access)
                    if (userData.is_admin || userData.has_events_access) {
                        unlockPage(); // Разблокируем страницу
                    }

                    // Загружаем остальной контент
                    const contentRes = await fetch('/api/v1/events/content', {cache: 'no-store'});
                    if (!contentRes.ok) throw new Error("Ошибка сети при загрузке контента");
                    pageContent = await contentRes.json(); 
                    
                    renderPage();

                    if (userData.is_admin) {
                        dom.adminControls.style.display = 'block';
                        dom.adminAccessControls.style.display = 'block'; // Показываем админ-кнопку доступа
                        
                        // ... (остальной код для админа: edit, save) ...
                    }
                } catch (error) { 
                    console.error("Ошибка инициализации:", error); 
                    // Если что-то пошло не так, пользователь увидит экран блокировки
                }
            }
            // Для просмотра в браузере страница всегда будет заблокирована
        }

        // ... (остальные твои функции) ...

        // --- НОВЫЙ ОБРАБОТЧИК ДЛЯ КНОПКИ ВЫДАЧИ ДОСТУПА ---
        dom.grantAccessBtn.addEventListener('click', () => {
            const userId = prompt("Введите Telegram ID пользователя, которому нужно выдать доступ:");
            if (userId && !isNaN(parseInt(userId))) {
                tg.MainButton.showProgress();
                // Здесь будет вызов API для выдачи доступа
                console.log(`Выдача доступа пользователю с ID: ${userId} (симуляция)`);
                setTimeout(() => {
                    tg.showAlert(`Доступ для пользователя ${userId} выдан!`);
                    tg.MainButton.hideProgress();
                }, 1000);
            } else if (userId) {
                tg.showAlert("Неверный ID. Введите только цифры.");
            }
        });

        initialize();
    });
</script>
</body>
</html>
