<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Гонка за скинами</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --background-main: #100e19;
            --surface-primary: #1c1a27;
            --surface-secondary: #2a2738;
            --border-color: #3c3852;
            --text-primary: #f0f0f5;
            --text-secondary: #a09cb8;
            --accent-primary: #00f2ea;
            --accent-secondary: #d433ff;
            --danger-color: #ff4d4d;
            --winner-color: #ffd700;
            --card-default-border: #d433ff;
            --card-default-bg: #2a2738;
            --card-default-dots: rgba(240, 240, 245, 0.1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-main);
            color: var(--text-primary);
            margin: 0;
            padding: 15px 15px 100px;
            overflow-x: hidden;
        }
        
        .container { max-width: 800px; margin: 0 auto; }

        .page-title {
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .timer { 
            text-align: center; 
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text-primary); 
            margin-bottom: 25px; 
            letter-spacing: 1px; 
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .browser-view .timer {
            font-size: 4.8em;
            margin-bottom: 25px;
            color: #ff9000;
        }
        
        .loader-spinner {
            width: 20px; height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .events-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        
        .event-card {
            background-color: var(--surface-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }

        .card-display-area {
            position: relative;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            padding: 10px;
            padding-bottom: 0;
        }
        .card-display-area::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--card-border-color, var(--card-default-border));
            z-index: 4;
        }
        .card-background {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }
        
        .card-display-area::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.8) 100%);
            z-index: 2;
            pointer-events: none;
        }

        .event-image-container {
            width: 100%;
            padding-top: 90%;
            position: relative;
            z-index: 3;
        }
        .event-image { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .card-info-area { 
            padding: 10px; 
            text-align: center; 
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .card-text-content {
            flex-grow: 1;
        }

        .event-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px; }
        .event-description { font-size: 12px; color: var(--text-secondary); margin: 0 0 10px; }
        .event-cost { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; height: 16px; }
        .user-tickets { font-size: 11px; color: var(--accent-primary); font-weight: 600; margin-bottom: 10px; min-height: 15px; }

        .event-button-container { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
        .event-button, .participants-button {
            width: 100%; padding: 10px; font-size: 13px; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .event-button {
            background-color: var(--accent-primary);
            color: #000;
        }
        .event-button:hover:not(:disabled) { background-color: #00d9d1; }
        .event-button:disabled {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        .participants-button { background-color: var(--surface-secondary); color: var(--text-primary); }
        .participants-button:hover { background-color: var(--border-color); }
        
        .event-card.is-winner .card-display-area::before { background: var(--winner-color); }
        .winner-display { padding: 10px 0; color: var(--winner-color); }
        .winner-icon { font-size: 24px; margin-bottom: 8px; }
        .winner-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); }
        .winner-name { font-size: 16px; font-weight: 700; margin-top: 4px; word-break: break-all; }

        .admin-controls { position: fixed; bottom: calc(60px + env(safe-area-inset-bottom) + 15px); left: 50%; transform: translateX(-50%); z-index: 1000; }
        .admin-controls button {
            background: linear-gradient(90deg, var(--accent-secondary), #ff70ab);
            color: white; padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); border: none;
            font-size: 14px; font-weight: 600; cursor: pointer;
            transition: transform 0.2s ease;
        }
        .admin-controls button:hover { transform: scale(1.05); }
        #save-btn { display: none; }
        .edit-mode-active #edit-btn { display: none; }
        .edit-mode-active #save-btn { display: inline-block; }

        .app-footer {
            display: flex; justify-content: space-around;
            background-color: rgba(28, 26, 39, 0.8);
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            width: 100%; padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom));
            position: fixed; bottom: 0; left: 0; z-index: 100;
        }
        .footer-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-secondary); font-size: 11px; text-decoration: none; flex: 1; }
        .footer-item .icon-wrapper { font-size: 24px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
        .footer-item.active span, .footer-item.active .icon-wrapper { color: var(--accent-primary); font-weight: 600; }
        
        .hidden { display: none !important; }

        .info-blocks-container { display: flex; flex-direction: column; gap: 15px; }
        .info-block {
            background-color: var(--surface-primary);
            border: 1px solid var(--border-color);
            padding: 20px; border-radius: 12px;
            display: flex;
            flex-wrap: wrap; 
            align-items: center; 
            gap: 15px;
        }
        .info-icon { font-size: 24px; color: var(--accent-primary); flex-shrink: 0; }
        .info-text-content { flex-grow: 1; }
        .info-action-content { width: 100%; text-align: center; margin-top: 10px; }
        .info-title { color: var(--text-primary); margin: 0 0 5px; font-size: 15px; font-weight: 600; }
        .info-description { font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin: 0; }
        
        .free-ticket-button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--accent-primary);
            color: #000;
            transition: all 0.2s ease;
        }
        .free-ticket-button:hover {
             background-color: #00d9d1;
        }
        .free-ticket-button:disabled {
            background: var(--surface-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        .free-ticket-button .timer-text {
            font-size: 12px;
            display: block;
            font-weight: 500;
            margin-top: 4px;
        }

        .edit-mode [data-editable] { cursor: pointer; border: 1px dashed var(--accent-secondary); border-radius: 4px; padding: 2px 4px; }
        .edit-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); border-radius: 12px; display: flex; gap: 8px; justify-content: center; align-items: center; z-index: 5; }
        
        .card-btn { 
            border: none; border-radius: 50%; width: 36px; height: 36px; 
            color: white; font-size: 16px; cursor: pointer; 
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card-btn:hover { transform: scale(1.1); }
        .card-edit-btn { background-color: #007aff; }
        .card-delete-btn { background-color: var(--danger-color); }
        .card-reset-btn { background-color: #ff9500; }
        .create-event-card { border: 2px dashed var(--border-color); justify-content: center; cursor: pointer; background: transparent; color: var(--text-secondary); }
        .create-event-card:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { 
            background-color: var(--surface-primary); border: 1px solid var(--border-color); 
            padding: 0; border-radius: 14px; 
            width: 90%; max-width: 400px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            max-height: 85vh;
            position: relative;
        }
        .modal-header { 
            padding: 15px 20px; 
            margin-top: 0; 
            /* --- ИЗМЕНЕНО: убран курсор для перемещения --- */
            /* cursor: move; */ 
            user-select: none; 
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { margin: 0; flex-grow: 1; }
        .modal-close-btn {
            background: none; border: none; color: var(--text-secondary);
            font-size: 24px; cursor: pointer; padding: 0; line-height: 1;
        }
        .modal-close-btn:hover { color: var(--text-primary); }
        .modal-body { overflow-y: auto; padding: 20px; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form input, .modal-form textarea, .modal-form .range-container { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface-secondary); color: var(--text-primary); font-size: 16px; }
        .modal-form input[type="color"] { padding: 2px; height: 44px; border: none; }
        .modal-form button { background: var(--accent-primary); border: none; padding: 12px; border-radius: 10px; color: #000; font-size: 16px; font-weight: 600; cursor: pointer; }
        .modal-form label { font-size: 14px; color: var(--text-secondary); margin-bottom: -10px; }
        .range-container { display: flex; align-items: center; gap: 10px; padding: 8px 12px; }
        .range-container input[type="range"] { flex-grow: 1; -webkit-appearance: none; background: var(--border-color); height: 4px; border-radius: 2px; }
        .range-container input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--accent-primary); cursor: pointer; border-radius: 50%;}
        
        #participants-list { list-style-type: none; padding: 0; margin: 0; }
        .participant-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .participant-item:last-child { border-bottom: none; }
        .participant-name { font-size: 14px; font-weight: 500; color: var(--text-primary); flex-grow: 1; padding-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .participant-tickets { font-size: 14px; font-weight: 600; color: var(--accent-primary); padding-left: 10px; }
        .participant-rank { font-size: 14px; font-weight: 500; color: var(--text-secondary); min-width: 25px; text-align: right; }
        
        /* --- Стили для блокировки карточки --- */
        .event-card.is-locked {
            opacity: 0.6;
        }
        .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(28, 26, 39, 0.7);
            backdrop-filter: blur(2px);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 5;
            color: var(--text-primary);
            padding: 10px;
            pointer-events: none; /* ИСПРАВЛЕНО: Делаем плашку "прозрачной" для кликов */
        }
        .lock-overlay-icon { font-size: 28px; margin-bottom: 8px; }
        .lock-overlay-text { font-size: 13px; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <div id="countdown-timer" class="timer" data-key="raffleEndTime" data-editable></div>
        <div id="events-list" class="events-container"></div>
        <div class="info-blocks-container">
            <div id="free-ticket-container" class="info-block">
                <i class="fa-solid fa-ticket info-icon"></i>
                <div class="info-text-content">
                    <h3 class="info-title">Ежедневный бонус</h3>
                    <p class="info-description">Получите один бесплатный билет для участия в розыгрышах раз в 24 часа.</p>
                </div>
                <div id="free-ticket-button-wrapper" class="info-action-content">
                </div>
            </div>
            <div class="info-block">
                <i data-key="infoBlock1Icon" class="fa-solid fa-star info-icon" data-editable></i>
                <div class="info-text-content">
                    <h3 class="info-title" data-key="infoBlock1Title" data-editable>Как победить?</h3>
                    <p class="info-description" data-key="infoBlock1Desc" data-editable>Чтобы получить приз, необходимо участвовать в ивентах.</p>
                </div>
            </div>
            <div class="info-block">
                <i data-key="infoBlock2Icon" class="fa-solid fa-ticket info-icon" data-editable></i>
                <div class="info-text-content">
                    <h3 class="info-title" data-key="infoBlock2Title" data-editable>Как это работает?</h3>
                    <p class="info-description" data-key="infoBlock2Desc" data-editable>Каждый билет, потраченный на ивент, добавляет ваше имя в список участников.</p>
                </div>
            </div>
            <div class="info-block">
                <i data-key="infoBlock3Icon" class="fa-solid fa-truck-fast info-icon" data-editable></i>
                <div class="info-text-content">
                    <h3 class="info-title" data-key="infoBlock3Title" data-editable>Как забрать?</h3>
                    <p class="info-description" data-key="infoBlock3Desc" data-editable>Победитель получит уведомление от бота. Для получения приза убедитесь, что у вас в профиле указана Steam Trade ссылка.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-controls" class="admin-controls hidden">
        <button id="edit-btn">Редактировать</button>
        <button id="save-btn">Сохранить</button>
    </div>

    <div class="app-footer">
        <a href="index.html" class="footer-item active">
            <div class="icon-wrapper"><i class="fa-solid fa-gift"></i></div>
            <span>Ивенты</span>
        </a>
        <a href="profile.html" class="footer-item">
            <div class="icon-wrapper"><i class="fa-solid fa-user"></i></div>
            <span>Профиль</span>
        </a>
        <a href="wallet.html" class="footer-item">
            <div class="icon-wrapper"><i class="fa-solid fa-wallet"></i></div>
            <span>Кошелек</span>
        </a>
        <a href="top.html" class="footer-item">
            <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
            <span>Топ</span>
        </a>
    </div>

    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Редактировать ивент</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="event-form" class="modal-form">
                    <label for="event-title-input">Название ивента:</label>
                    <input type="text" id="event-title-input" required>
                    
                    <label for="event-image-input">URL изображения:</label>
                    <input type="text" id="event-image-input" required>
                    
                    <label for="event-bg-image-input">URL фона (необязательно):</label>
                    <input type="text" id="event-bg-image-input">
                    
                    <label for="event-cost-input">Стоимость билета:</label>
                    <input type="number" id="event-cost-input" required min="1" value="1">

                    <label for="event-ticket-limit-input">Лимит билетов на человека (0 = без лимита):</label>
                    <input type="number" id="event-ticket-limit-input" required min="0" value="0">

                    <label for="event-border-color-input">Цвет границы карточки:</label>
                    <input type="color" id="event-border-color-input" value="#d433ff">

                    <label for="event-description-input">Описание:</label>
                    <textarea id="event-description-input" required></textarea>

                    <button type="submit" id="save-event-btn">Сохранить ивент</button>
                    <button type="button" id="delete-event-btn" class="hidden" style="background-color: var(--danger-color);">Удалить ивент</button>
                </form>
            </div>
        </div>
    </div>

    <div id="participants-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="participants-modal-title">Участники</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="participants-list"></ul>
            </div>
        </div>
    </div>
    
    <div id="participants-input-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Купить билеты</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="participants-input-form" class="modal-form">
                    <label for="tickets-input">Количество билетов:</label>
                    <div class="range-container">
                        <input type="range" id="tickets-input" min="1" max="10" value="1">
                        <span id="tickets-count">1</span>
                    </div>
                    <button type="submit" id="submit-bet-btn">Сделать ставку</button>
                </form>
            </div>
        </div>
    </div>

    <div id="winner-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="winner-modal-title">Объявление победителя</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="winner-display" style="text-align: center;">
                    <i class="fa-solid fa-crown winner-icon"></i>
                    <p class="winner-label">Победитель</p>
                    <p id="winner-name" class="winner-name"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let userData = {};
        const isBrowserView = !tg.initData;
        const serverUrl = 'https://s-r.fun/api';

        document.addEventListener('DOMContentLoaded', () => {
            if (isBrowserView) {
                document.body.classList.add('browser-view');
            }

            if (tg.initData) {
                tg.ready();
                tg.expand();
                tg.MainButton.setText('Участвовать').show();
            }

            const eventsList = document.getElementById('events-list');
            const editBtn = document.getElementById('edit-btn');
            const saveBtn = document.getElementById('save-btn');
            const eventModal = document.getElementById('event-modal');
            const participantsModal = document.getElementById('participants-modal');
            const participantsInputModal = document.getElementById('participants-input-modal');
            const winnerModal = document.getElementById('winner-modal');
            const eventForm = document.getElementById('event-form');
            const ticketsInput = document.getElementById('tickets-input');
            const ticketsCountSpan = document.getElementById('tickets-count');

            let editableElements = {};
            let isEditMode = false;
            let currentEventId = null;

            async function fetchUserData() {
                if (isBrowserView) {
                    userData = {
                        "telegram_id": "test_user",
                        "username": "test_user_browser",
                        "tickets": 100,
                        "is_admin": false,
                        "event_participations": {}
                    };
                    return;
                }
                
                try {
                    const response = await fetch(`${serverUrl}/users/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${tg.initData}`
                        }
                    });
                    if (!response.ok) {
                        throw new Error('Failed to fetch user data');
                    }
                    userData = await response.json();
                    if (userData.is_admin) {
                        document.getElementById('admin-controls').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Handle error, e.g., show an alert
                    tg.showAlert('Ошибка: Не удалось загрузить данные пользователя.');
                }
            }

            async function fetchEventsData() {
                try {
                    const response = await fetch(`${serverUrl}/events`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch events');
                    }
                    const events = await response.json();
                    renderEvents(events);
                } catch (error) {
                    console.error('Error fetching events:', error);
                    tg.showAlert('Ошибка: Не удалось загрузить список ивентов.');
                }
            }

            function renderEvents(events) {
                eventsList.innerHTML = '';
                events.forEach(event => {
                    eventsList.appendChild(createEventCard(event));
                });
                if (userData.is_admin) {
                    eventsList.appendChild(createCreateEventCard());
                }
                updatePageContent();
            }

            function createEventCard(event) {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.dataset.id = event.id;
                card.dataset.price = event.ticket_cost;
                card.dataset.tickets_limit = event.ticket_limit;

                if (event.status === 'finished') {
                    card.classList.add('is-finished');
                }
                if (event.winner_name) {
                    card.classList.add('is-winner');
                }

                if (isEditMode) {
                    const overlay = document.createElement('div');
                    overlay.className = 'edit-overlay';
                    const editBtn = document.createElement('button');
                    editBtn.className = 'card-btn card-edit-btn';
                    editBtn.innerHTML = '<i class="fa-solid fa-edit"></i>';
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditModal(event);
                    });
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'card-btn card-delete-btn';
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteEvent(event.id);
                    });
                    const resetBtn = document.createElement('button');
                    resetBtn.className = 'card-btn card-reset-btn';
                    resetBtn.innerHTML = '<i class="fa-solid fa-sync-alt"></i>';
                    resetBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        resetEvent(event.id);
                    });
                    overlay.append(editBtn, deleteBtn, resetBtn);
                    card.appendChild(overlay);
                }

                card.innerHTML += `
                    <div class="card-display-area" style="--card-border-color: ${event.card_border_color}; background-color: ${event.card_background_color || 'var(--card-default-bg)'}">
                        ${event.card_dots ? '<div class="card-background" style="background-image: radial-gradient(var(--card-default-dots) 1px, transparent 1px); background-size: 8px 8px;"></div>' : ''}
                        <div class="event-image-container">
                            <img src="${event.image_url}" alt="${event.title}" class="event-image">
                        </div>
                    </div>
                    <div class="card-info-area">
                        <div class="card-text-content">
                            <h3 class="event-title">${event.title}</h3>
                            <p class="event-description">${event.description}</p>
                            <p class="event-cost">Цена: ${event.ticket_cost} билет.</p>
                            <p class="user-tickets hidden" data-id="${event.id}"></p>
                            ${event.winner_name ? `<div class="winner-display"><i class="fa-solid fa-crown winner-icon"></i><p class="winner-label">Победитель</p><p class="winner-name">${event.winner_name}</p></div>` : ''}
                        </div>
                        <div class="event-button-container">
                            ${event.status === 'active' ? `<button class="event-button" data-action="participate" data-event-id="${event.id}">Участвовать</button>` : ''}
                            <button class="participants-button" data-action="show-participants" data-event-id="${event.id}">Участники (${event.participants_count || 0})</button>
                        </div>
                    </div>
                `;

                if (event.status === 'finished' && !event.winner_name) {
                    card.classList.add('is-locked');
                    const lockOverlay = document.createElement('div');
                    lockOverlay.className = 'lock-overlay';
                    lockOverlay.innerHTML = `<i class="fa-solid fa-lock lock-overlay-icon"></i><span class="lock-overlay-text">Ожидание победителя</span>`;
                    card.appendChild(lockOverlay);
                }

                const participateButton = card.querySelector('[data-action="participate"]');
                if (participateButton) {
                    participateButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openParticipantsInputModal(event.id, event.ticket_limit, event.ticket_cost);
                    });
                }
                const participantsButton = card.querySelector('[data-action="show-participants"]');
                if (participantsButton) {
                    participantsButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showParticipants(event.id);
                    });
                }

                return card;
            }

            function createCreateEventCard() {
                const card = document.createElement('div');
                card.className = 'event-card create-event-card';
                card.innerHTML = `<i class="fa-solid fa-plus" style="font-size: 40px;"></i><p>Создать ивент</p>`;
                card.addEventListener('click', () => openCreateModal());
                return card;
            }

            function updatePageContent() {
                if (userData.is_admin) return;

                const userTicketsDisplay = document.querySelectorAll('.user-tickets');
                userTicketsDisplay.forEach(elem => {
                    const eventId = elem.dataset.id;
                    const participations = userData.event_participations ? (userData.event_participations[eventId] || 0) : 0;
                    if (participations > 0) {
                        elem.textContent = `Ваши билеты: ${participations}`;
                        elem.classList.remove('hidden');
                    } else {
                        elem.classList.add('hidden');
                    }
                });
            }
            
            async function fetchInfoBlocksData() {
                try {
                    const response = await fetch(`${serverUrl}/settings/info-blocks`);
                    if (!response.ok) throw new Error('Failed to fetch info blocks');
                    const infoBlocks = await response.json();
                    renderInfoBlocks(infoBlocks);
                } catch (error) {
                    console.error('Error fetching info blocks:', error);
                }
            }

            function renderInfoBlocks(data) {
                const countdownTimer = document.getElementById('countdown-timer');
                const freeTicketContainer = document.getElementById('free-ticket-container');
                const freeTicketButtonWrapper = document.getElementById('free-ticket-button-wrapper');
                
                // Render Countdown Timer
                countdownTimer.textContent = data.raffle_end_time_text;
                if (data.raffle_end_time) {
                    startCountdown(data.raffle_end_time, countdownTimer);
                }
                
                // Render Free Ticket Button
                if (data.free_ticket_button_enabled && !userData.is_admin) {
                    freeTicketContainer.classList.remove('hidden');
                    let btn = freeTicketButtonWrapper.querySelector('.free-ticket-button');
                    if (!btn) {
                        btn = document.createElement('button');
                        btn.className = 'free-ticket-button';
                        btn.textContent = 'Получить билет';
                        freeTicketButtonWrapper.appendChild(btn);
                    }
                    updateFreeTicketButton(btn, data.free_ticket_cooldown_end_time);
                    btn.onclick = () => getFreeTicket();
                } else {
                    freeTicketContainer.classList.add('hidden');
                }
                
                // Render other info blocks
                document.querySelectorAll('[data-key]').forEach(elem => {
                    const key = elem.dataset.key;
                    if (data[key]) {
                        if (elem.tagName === 'I') {
                            elem.className = data[key];
                        } else {
                            elem.textContent = data[key];
                        }
                    }
                    if (isEditMode) {
                        elem.dataset.originalContent = elem.textContent;
                        editableElements[key] = elem;
                    }
                });
            }

            function updateFreeTicketButton(btn, cooldownEndTime) {
                const now = Math.floor(Date.now() / 1000);
                if (cooldownEndTime > now) {
                    btn.disabled = true;
                    startFreeTicketCountdown(cooldownEndTime, btn);
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Получить билет';
                }
            }

            function startFreeTicketCountdown(endTime, btn) {
                const interval = setInterval(() => {
                    const now = Math.floor(Date.now() / 1000);
                    const remainingSeconds = endTime - now;
                    if (remainingSeconds <= 0) {
                        clearInterval(interval);
                        btn.textContent = 'Получить билет';
                        btn.disabled = false;
                        return;
                    }
                    const hours = String(Math.floor(remainingSeconds / 3600)).padStart(2, '0');
                    const minutes = String(Math.floor((remainingSeconds % 3600) / 60)).padStart(2, '0');
                    const seconds = String(remainingSeconds % 60).padStart(2, '0');
                    btn.innerHTML = `Доступно через:<span class="timer-text">${hours}:${minutes}:${seconds}</span>`;
                }, 1000);
            }

            async function getFreeTicket() {
                try {
                    tg.MainButton.showProgress();
                    const response = await fetch(`${serverUrl}/users/get_free_ticket`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tg.initData}`
                        },
                        body: JSON.stringify({
                            init_data: tg.initData
                        })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                         if (response.status === 409) {
                            throw new Error('Вы уже получили бесплатный билет за последние 24 часа.');
                         } else {
                            throw new Error(result.detail || 'Ошибка при получении билета.');
                         }
                    }
                    userData.tickets = result.new_ticket_balance;
                    // Обновляем состояние кнопки с новым временем
                    const freeTicketBtn = document.querySelector('.free-ticket-button');
                    if (freeTicketBtn) {
                        updateFreeTicketButton(freeTicketBtn, result.cooldown_end_time);
                    }
                    tg.showAlert('Вы получили 1 бесплатный билет!');
                    await fetchUserData();
                    renderPage();
                } catch (error) {
                    tg.showAlert(error.message);
                    console.error(error);
                } finally {
                    tg.MainButton.hideProgress();
                }
            }

            function startCountdown(endTime, element) {
                const interval = setInterval(() => {
                    const now = Math.floor(Date.now() / 1000);
                    const remainingSeconds = endTime - now;
                    if (remainingSeconds <= 0) {
                        clearInterval(interval);
                        element.textContent = 'Гонка завершена';
                        checkWinner();
                        return;
                    }
                    const days = Math.floor(remainingSeconds / (3600 * 24));
                    const hours = Math.floor((remainingSeconds % (3600 * 24)) / 3600);
                    const minutes = Math.floor((remainingSeconds % 3600) / 60);
                    const seconds = remainingSeconds % 60;
                    
                    let parts = [];
                    if (days > 0) parts.push(`${days}д`);
                    parts.push(`${String(hours).padStart(2, '0')}ч`);
                    parts.push(`${String(minutes).padStart(2, '0')}м`);
                    parts.push(`${String(seconds).padStart(2, '0')}с`);
                    element.textContent = parts.join(' : ');
                }, 1000);
            }

            async function checkWinner() {
                try {
                    const response = await fetch(`${serverUrl}/events/check_winner`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tg.initData}`
                        },
                        body: JSON.stringify({ init_data: tg.initData })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to check for winner');
                    }
                    const winnerData = await response.json();
                    if (winnerData.winner_name) {
                        document.getElementById('winner-name').textContent = winnerData.winner_name;
                        showModal(winnerModal);
                        await fetchEventsData();
                    }
                } catch (error) {
                    console.error('Error checking winner:', error);
                }
            }
            
            function openEditModal(event) {
                document.getElementById('event-modal-title').textContent = 'Редактировать ивент';
                document.getElementById('event-title-input').value = event.title;
                document.getElementById('event-image-input').value = event.image_url;
                document.getElementById('event-bg-image-input').value = event.background_image_url || '';
                document.getElementById('event-cost-input').value = event.ticket_cost;
                document.getElementById('event-ticket-limit-input').value = event.ticket_limit;
                document.getElementById('event-border-color-input').value = event.card_border_color || '#d433ff';
                document.getElementById('event-description-input').value = event.description;
                document.getElementById('delete-event-btn').classList.remove('hidden');
                eventForm.dataset.eventId = event.id;
                showModal(eventModal);
            }

            function openCreateModal() {
                document.getElementById('event-modal-title').textContent = 'Создать ивент';
                eventForm.reset();
                document.getElementById('delete-event-btn').classList.add('hidden');
                delete eventForm.dataset.eventId;
                showModal(eventModal);
            }

            async function deleteEvent(eventId) {
                if (!confirm('Вы уверены, что хотите удалить этот ивент?')) {
                    return;
                }
                try {
                    tg.MainButton.showProgress();
                    const response = await fetch(`${serverUrl}/events/${eventId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tg.initData}`
                        },
                        body: JSON.stringify({
                            init_data: tg.initData
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Ошибка при удалении ивента.');
                    }
                    tg.showAlert('Ивент успешно удален.');
                    renderPage();
                } catch (error) {
                    tg.showAlert(error.message);
                    console.error(error);
                } finally {
                    tg.MainButton.hideProgress();
                }
            }

            async function resetEvent(eventId) {
                if (!confirm('Вы уверены, что хотите сбросить этот ивент? Это удалит всех участников и победителя.')) {
                    return;
                }
                try {
                    tg.MainButton.showProgress();
                    const response = await fetch(`${serverUrl}/events/${eventId}/reset`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tg.initData}`
                        },
                        body: JSON.stringify({
                            init_data: tg.initData
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Ошибка при сбросе ивента.');
                    }
                    tg.showAlert('Ивент успешно сброшен.');
                    renderPage();
                } catch (error) {
                    tg.showAlert(error.message);
                    console.error(error);
                } finally {
                    tg.MainButton.hideProgress();
                }
            }

            eventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const eventId = eventForm.dataset.eventId;
                const url = eventId ? `${serverUrl}/events/${eventId}` : `${serverUrl}/events`;
                const method = eventId ? 'PUT' : 'POST';

                const eventData = {
                    title: document.getElementById('event-title-input').value,
                    image_url: document.getElementById('event-image-input').value,
                    background_image_url: document.getElementById('event-bg-image-input').value,
                    ticket_cost: parseInt(document.getElementById('event-cost-input').value),
                    ticket_limit: parseInt(document.getElementById('event-ticket-limit-input').value),
                    card_border_color: document.getElementById('event-border-color-input').value,
                    description: document.getElementById('event-description-input').value
                };

                try {
                    tg.MainButton.showProgress();
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tg.initData}`
                        },
                        body: JSON.stringify({
                            init_data: tg.initData,
                            ...eventData
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Ошибка при сохранении ивента.');
                    }
                    tg.showAlert('Ивент успешно сохранен.');
                    hideModal(eventModal);
                    renderPage();
                } catch (error) {
                    tg.showAlert(error.message);
                    console.error(error);
                } finally {
                    tg.MainButton.hideProgress();
                }
            });

            function showModal(modalOverlay) {
                modalOverlay.classList.remove('hidden');
                setTimeout(() => modalOverlay.style.opacity = '1', 10);
            }

            function hideModal(modalOverlay) {
                modalOverlay.style.opacity = '0';
                setTimeout(() => modalOverlay.classList.add('hidden'), 300);
            }
            
            document.querySelectorAll('.modal-overlay').forEach(modalOverlay => {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        hideModal(modalOverlay);
                    }
                });
            });

            async function showParticipants(eventId) {
                try {
                    tg.MainButton.showProgress();
                    const response = await fetch(`${serverUrl}/events/${eventId}/participants`);
                    if (!response.ok) throw new Error('Failed to fetch participants');
                    const participants = await response.json();
                    
                    const participantsList = document.getElementById('participants-list');
                    participantsList.innerHTML = '';
                    
                    participants.sort((a, b) => b.tickets - a.tickets);

                    participants.forEach((p, index) => {
                        const li = document.createElement('li');
                        li.className = 'participant-item';
                        li.innerHTML = `
                            <span class="participant-rank">${index + 1}.</span>
                            <span class="participant-name">${p.user_name}</span>
                            <span class="participant-tickets">${p.tickets} <i class="fa-solid fa-ticket"></i></span>
                        `;
                        participantsList.appendChild(li);
                    });
                    
                    document.getElementById('participants-modal-title').textContent = 'Участники';
                    showModal(participantsModal);
                } catch (error) {
                    tg.showAlert(error.message);
                    console.error(error);
                } finally {
                    tg.MainButton.hideProgress();
                }
            }
            
            function openParticipantsInputModal(eventId, ticketLimit, ticketCost) {
                currentEventId = eventId;
                const eventParticipations = userData.event_participations[eventId] || 0;
                const maxTickets = Math.min(userData.tickets, ticketLimit === 0 ? userData.tickets : ticketLimit - eventParticipations);

                const ticketsInput = document.getElementById('tickets-input');
                ticketsInput.max = maxTickets;
                ticketsInput.value = 1;
                ticketsCountSpan.textContent = 1;

                if (maxTickets <= 0) {
                    tg.showAlert('У вас недостаточно билетов или достигнут лимит участия в этом ивенте.');
                    return;
                }

                showModal(participantsInputModal);
            }

            ticketsInput.addEventListener('input', () => {
                ticketsCountSpan.textContent = ticketsInput.value;
            });
            
            document.getElementById('participants-input-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const ticketsToSpend = parseInt(ticketsInput.value);
                
                try {
                    tg.MainButton.showProgress();
                    const response = await fetch(`${serverUrl}/events/participate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${tg.initData}`
                        },
                        body: JSON.stringify({
                            init_data: tg.initData,
                            event_id: currentEventId,
                            tickets_to_spend: ticketsToSpend
                        })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        if (response.status === 409) {
                            throw new Error('Вы уже участвуете в этом событии!');
                        } else {
                            throw new Error(result.detail || 'Ошибка при отправке ставки.');
                        }
                    }

                    tg.showAlert('Ваша ставка принята!');
                    userData.tickets = result.new_ticket_balance;
                    userData.event_participations = userData.event_participations || {};
                    userData.event_participations[currentEventId] = (userData.event_participations[currentEventId] || 0) + ticketsToSpend;
                    hideModal(participantsInputModal);
                    renderPage();
                } catch (error) {
                    tg.showAlert(error.message);
                    console.error(error);
                } finally {
                    tg.MainButton.hideProgress();
                }
            });

            async function renderPage() {
                await fetchUserData();
                await fetchEventsData();
                await fetchInfoBlocksData();
            }

            renderPage();
        });
    </script>
</body>
</html>
