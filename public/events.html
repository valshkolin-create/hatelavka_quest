<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ì—Ä–∏–Ω–¥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <style>
    :root {
      --background-main: #111111;
      --surface-primary: #1C1C1C;
      --surface-secondary: #2C2C2C;
      --border-color: #333333;
      --text-primary: #f0f0f5;
      --text-secondary: #AAAAAA;
      --accent-primary: #FFD700; /* –ó–æ–ª–æ—Ç–æ */
      --accent-secondary: #FF9500; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
      --card-bg-glass: rgba(28, 28, 28, 0.75);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-main);
      color: var(--text-primary);
      margin: 0;
      padding: 10px 10px 80px;
      overflow-x: hidden;
      background-image: url('https://i.postimg.cc/Dyks29xc/fon-variant1.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* –•–ï–î–ï–† */
    .new-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 20px; 
        padding: 5px 0;
    }

    .header-back-button {
        display: flex; align-items: center; gap: 6px;
        color: var(--text-secondary); text-decoration: none;
        font-size: 12px; font-weight: 600; position: relative; z-index: 2;
        transition: color 0.2s ease;
    }
    .header-back-button:hover { color: var(--text-primary); }

    .page-header {
        position: absolute; left: 0; right: 0; top: 50%;
        transform: translateY(-50%); text-align: center; z-index: 1;
    }
    .page-title {
        font-size: 18px; font-weight: 700; margin: 0;
        color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px;
    }

    /* –ö–ê–†–¢–û–ß–ö–ò */
    .glass-card {
        background-color: var(--card-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
    }

    /* –ë–ê–õ–ê–ù–°–´ */
    .balance-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .balance-item {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .balance-label {
        font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;
    }

    .balance-value {
        font-size: 16px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 6px;
        min-height: 20px;
    }
    
    .coin-icon { color: var(--accent-primary); text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
    .ticket-icon { color: #00f2ea; text-shadow: 0 0 10px rgba(0, 242, 234, 0.4); }

    /* –ì–†–ò–ù–î */
    .section-title {
        font-size: 13px; font-weight: 700; color: var(--text-primary); margin: 0 0 12px;
        display: flex; align-items: center; gap: 6px; text-transform: uppercase;
    }
    .section-title i { color: var(--accent-secondary); }

    .streak-wrapper {
        display: flex; justify-content: space-between; align-items: center;
        position: relative; margin: 20px 5px 25px;
    }

    .streak-line-bg {
        position: absolute; top: 50%; left: 0; right: 0; height: 2px;
        background: var(--border-color); transform: translateY(-50%); z-index: 0;
    }

    .streak-line-fill {
        position: absolute; top: 50%; left: 0; height: 2px;
        background: var(--accent-primary); transform: translateY(-50%); z-index: 1;
        width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px var(--accent-primary);
    }

    .streak-step {
        width: 24px; height: 24px; background: var(--surface-primary);
        border: 1px solid var(--border-color); border-radius: 50%; z-index: 2;
        display: flex; justify-content: center; align-items: center;
        font-size: 9px; color: var(--text-secondary); font-weight: 700; transition: all 0.3s ease;
    }

    .streak-step.active {
        border-color: var(--accent-primary); background: var(--background-main);
        color: var(--text-primary); transform: scale(1.2); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .streak-step.completed {
        background: var(--accent-primary); border-color: var(--accent-primary); color: #000;
    }

    .grind-info {
        text-align: center; font-size: 11px; color: var(--text-secondary); margin-bottom: 12px;
        background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;
    }
    .grind-info span { color: var(--accent-primary); font-weight: 700; }

    /* –ë—É—Å—Ç –ò–Ω—Ñ–æ */
    .boost-details {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed rgba(255,255,255,0.1);
        font-size: 10px;
        color: #34c759;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .boost-row { display: flex; justify-content: space-between; padding: 0 10px; }

    .main-action-btn {
        width: 100%; padding: 12px; background-color: var(--accent-primary);
        color: #000; font-size: 13px; font-weight: 700; border: none; border-radius: 6px;
        cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
        transition: transform 0.1s; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        position: relative; overflow: hidden;
    }
    .main-action-btn:active { transform: scale(0.98); }
    .main-action-btn:disabled {
        background-color: var(--surface-secondary); color: var(--text-secondary);
        cursor: not-allowed; box-shadow: none;
    }

    /* –ú–ê–ì–ê–ó–ò–ù */
    .open-shop-card {
        display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        transition: transform 0.2s; border-color: var(--accent-secondary);
    }
    .open-shop-card:active { transform: scale(0.98); }
    .shop-info-left { display: flex; align-items: center; gap: 12px; }
    .shop-icon-large { font-size: 24px; color: var(--accent-secondary); }
    .shop-text h4 { margin: 0; font-size: 13px; color: var(--text-primary); }
    .shop-text p { margin: 2px 0 0; font-size: 10px; color: var(--text-secondary); }
    .shop-arrow { color: var(--text-secondary); font-size: 12px; }

    /* –ú–û–î–ê–õ–ö–ê */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 200; display: flex;
        align-items: center; justify-content: center; backdrop-filter: blur(8px);
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .modal-overlay.visible { opacity: 1; pointer-events: all; }

    .modal-content {
        background-color: var(--surface-primary); border: 1px solid var(--accent-primary);
        border-radius: 12px; width: 90%; max-width: 360px;
        box-shadow: 0 10px 40px rgba(255, 215, 0, 0.15);
        display: flex; flex-direction: column; position: relative;
        max-height: 85vh;
    }

    .modal-header {
        padding: 15px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        background: var(--surface-primary); border-radius: 12px 12px 0 0;
    }
    
    .shop-tabs { display: flex; gap: 10px; }
    .tab-btn {
        background: transparent; border: none; color: var(--text-secondary);
        font-size: 13px; font-weight: 600; padding: 5px 10px; cursor: pointer;
        border-radius: 6px; transition: all 0.2s; text-transform: uppercase;
    }
    .tab-btn.active { background: rgba(255, 215, 0, 0.1); color: var(--accent-primary); }

    .modal-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }
    .modal-body { padding: 15px; overflow-y: auto; }
    .shop-grid { display: flex; flex-direction: column; gap: 10px; min-height: 150px; }

    .exchange-item {
        background-color: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color);
        border-radius: 6px; padding: 10px; display: flex; justify-content: space-between; align-items: center;
    }
    .exchange-details { display: flex; flex-direction: column; gap: 2px; }
    .exchange-title { font-size: 12px; color: var(--text-primary); font-weight: 600; }
    .exchange-cost { font-size: 10px; color: var(--accent-primary); }
    
    .mini-btn {
        background: transparent; border: 1px solid var(--accent-primary); color: var(--accent-primary);
        padding: 6px 12px; font-size: 10px; font-weight: 600; border-radius: 4px;
        text-transform: uppercase; cursor: pointer; transition: all 0.2s;
    }
    .mini-btn:hover { background: var(--accent-primary); color: #000; }
    .mini-btn:disabled { border-color: var(--border-color); color: var(--text-secondary); pointer-events: none; opacity: 0.5; }

    /* –ë–ï–°–ü–õ–ê–¢–ù–´–ô –ë–ò–õ–ï–¢ */
    .free-ticket-section {
        border: 1px dashed var(--text-secondary); padding: 12px; border-radius: 8px;
        display: flex; justify-content: space-between; align-items: center;
        margin-top: 10px; background: rgba(255,255,255,0.02);
    }
    .free-ticket-text { font-size: 11px; color: var(--text-secondary); }
    .free-ticket-title { font-size: 12px; font-weight: 700; color: #fff; display: block; margin-bottom: 2px; }

    /* FOOTER */
    .app-footer {
        display: flex; justify-content: space-around; align-items: center;
        background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: fixed; bottom: 0; left: 0; width: 100%; z-index: 9999;
        padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom));
        box-sizing: border-box;
    }
    .footer-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        color: #8E8E93; text-decoration: none; flex: 1; cursor: pointer;
        background: transparent; border: none; padding: 0; margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 10px; line-height: 1; font-weight: 500;
    }
    .footer-item .icon-wrapper {
        display: flex; justify-content: center; align-items: center; width: 24px; height: 24px;
        font-size: 22px; position: relative; transition: transform 0.2s ease, color 0.2s ease;
    }
    .footer-item.active { color: #FFFFFF; }
    .footer-item.active .icon-wrapper {
        color: #34c759; transform: translateY(-2px); text-shadow: 0 0 12px rgba(52, 199, 89, 0.6);
    }
    .footer-item.active .icon-wrapper::before {
        content: ''; position: absolute; top: -8px; width: 20px; height: 2px;
        background-color: #34c759; border-radius: 2px; box-shadow: 0 0 5px rgba(52, 199, 89, 0.8);
    }

    .shine {
        position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 3s infinite;
    }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
    
    .float-anim {
        animation: floatUp 1s ease-out forwards;
        position: absolute; font-weight: 800; font-size: 16px; pointer-events: none; z-index: 100;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

  </style>
</head>
<body>

  <div class="new-header-container">
    <a href="/menu" class="header-back-button">
        <i class="fa-solid fa-chevron-left"></i> –ù–∞–∑–∞–¥
    </a>
    <div class="page-header">
        <h1 class="page-title">–ì—Ä–∏–Ω–¥</h1>
    </div>
    <div style="width: 40px;"></div>
  </div>

  <div class="balance-grid">
    <div class="balance-item">
        <span class="balance-label">–ì—Ä–∏–Ω–¥-–º–æ–Ω–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-coins">...</span> <i class="fa-solid fa-coins coin-icon"></i>
        </div>
    </div>
    <div class="balance-item">
        <span class="balance-label">–ë–∏–ª–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-tickets">...</span> <i class="fa-solid fa-ticket ticket-icon"></i>
        </div>
    </div>
  </div>

  <div class="glass-card">
    <div class="section-title"><i class="fa-solid fa-fire"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –°–µ—Ä–∏—è</div>
    
    <div class="streak-wrapper">
        <div class="streak-line-bg"></div>
        <div class="streak-line-fill" id="streak-bar"></div>
        <div id="streak-steps" style="display: flex; justify-content: space-between; width: 100%; position: relative;"></div>
    </div>

    <div class="grind-info">
        –î–µ–Ω—å —Å–µ—Ä–∏–∏: <span id="current-streak-day">1</span> / 10 <br>
        –ù–∞–≥—Ä–∞–¥–∞ —Å–µ–≥–æ–¥–Ω—è: <span id="today-reward">+0.1</span>
        
        <div id="boost-container" class="boost-details" style="display: none;">
            </div>
    </div>

    <button id="grind-btn" class="main-action-btn" disabled>
        <span id="grind-btn-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <div class="shine"></div>
    </button>
  </div>

  <div class="glass-card open-shop-card" onclick="openShopModal()">
    <div class="shop-info-left">
        <i class="fa-solid fa-shop shop-icon-large"></i>
        <div class="shop-text">
            <h4>–ú–∞–≥–∞–∑–∏–Ω –ù–∞–≥—Ä–∞–¥</h4>
            <p>–û–±–º–µ–Ω –≥—Ä–∏–Ω–¥-–º–æ–Ω–µ—Ç –Ω–∞ –±–∏–ª–µ—Ç—ã –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã</p>
        </div>
    </div>
    <div class="shop-arrow"><i class="fa-solid fa-chevron-right"></i></div>
  </div>

  <div class="free-ticket-section">
    <div>
        <span class="free-ticket-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–∏–ª–µ—Ç</span>
        <span class="free-ticket-text" id="ticket-subtitle">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ 24—á</span>
    </div>
    <div id="free-ticket-container"></div>
  </div>

  <div id="shop-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="shop-tabs">
                <button class="tab-btn active" id="tab-tickets" onclick="switchTab('tickets')">–ë–∏–ª–µ—Ç—ã</button>
                <button class="tab-btn" id="tab-promos" onclick="switchTab('promos')">–ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
            </div>
            <button class="modal-close-btn" onclick="closeShopModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="shop-grid" id="shop-container"></div>
        </div>
    </div>
  </div>

  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
        <span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span>
    </a>
    <a href="/menu#quests" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div>
        <span>–ó–∞–¥–∞–Ω–∏—è</span>
    </a>
        <a href="/menu" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/events" class="footer-item active">
        <div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div>
        <span>–ì—Ä–∏–Ω–¥</span>
    </a>
    <a href="/auction" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
        <span>–ê—É–∫—Ü–∏–æ–Ω</span>
    </a>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let userState = {
        coins: 0.0,
        tickets: 0,
        streakDays: 1,
        lastGrindTime: null, 
        lastFreeTicket: null,
        active_referrals_count: 0,
        referral_activated_at: null
    };

    let shopItems = [];
    let currentTab = 'tickets';
    const MAX_STREAK = 10;
    const GRIND_COOLDOWN = 24 * 60 * 60 * 1000;

    const dom = {
        coinsDisplay: document.getElementById('user-coins'),
        ticketsDisplay: document.getElementById('user-tickets'),
        streakBar: document.getElementById('streak-bar'),
        streakSteps: document.getElementById('streak-steps'),
        streakDayDisplay: document.getElementById('current-streak-day'),
        todayRewardDisplay: document.getElementById('today-reward'),
        boostContainer: document.getElementById('boost-container'),
        grindBtn: document.getElementById('grind-btn'),
        grindBtnText: document.getElementById('grind-btn-text'),
        freeTicketContainer: document.getElementById('free-ticket-container'),
        ticketSubtitle: document.getElementById('ticket-subtitle'),
        shopModal: document.getElementById('shop-modal'),
        shopContainer: document.getElementById('shop-container'),
        tabTickets: document.getElementById('tab-tickets'),
        tabPromos: document.getElementById('tab-promos')
    };

    async function init() {
        try {
            const response = await fetch('/api/v1/user/me', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (response.ok) {
                const data = await response.json();
                userState.tickets = data.tickets || 0;
                userState.coins = parseFloat(data.coins || 0);
                userState.streakDays = data.streak_days || 1;
                userState.lastGrindTime = data.last_grind_at;
                userState.lastFreeTicket = data.last_free_ticket_claimed_at;
                
                // –î–∞–Ω–Ω—ã–µ –¥–ª—è –±—É—Å—Ç–æ–≤
                userState.active_referrals_count = data.active_referrals_count || 0;
                userState.referral_activated_at = data.referral_activated_at;
                
                updateUI();
                renderStreakVisuals();
                startTimers();
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            dom.coinsDisplay.textContent = "0.0";
            tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.");
        }
    }

    function calculateBoosts() {
        // –ë–∞–∑–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ —Å–µ—Ä–∏—é (0.1 ... 1.0)
        let baseReward = (userState.streakDays * 0.1);
        if (baseReward > 1.0) baseReward = 1.0;
        
        let totalBonus = 0;
        let boostsHTML = "";
        
        // 1. –ë—É—Å—Ç –æ—Ç –¥—Ä—É–∑–µ–π (+0.1 –∑–∞ –∫–∞–∂–¥–æ–≥–æ)
        if (userState.active_referrals_count > 0) {
            const refBoost = userState.active_referrals_count * 0.1;
            totalBonus += refBoost;
            boostsHTML += `<div class="boost-row"><span>üöÄ –î—Ä—É–∑—å—è (${userState.active_referrals_count}):</span><span class="boost-active">+${refBoost.toFixed(1)}</span></div>`;
        }
        
        // 2. VIP —Å—Ç–∞—Ç—É—Å –Ω–æ–≤–∏—á–∫–∞ (+0.2)
        if (userState.referral_activated_at) {
            const activatedTime = new Date(userState.referral_activated_at).getTime();
            const now = new Date().getTime();
            const sevenDays = 7 * 24 * 60 * 60 * 1000;
            
            if ((now - activatedTime) < sevenDays) {
                totalBonus += 0.2;
                boostsHTML += `<div class="boost-row"><span class="boost-vip">‚ö° –ù–æ–≤–∏—á–æ–∫:</span><span class="boost-vip">+0.2</span></div>`;
            }
        }
        
        return { totalBonus, boostsHTML, baseReward };
    }

    // üëáüëáüëá –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ, –ï–Å –ù–ï –•–í–ê–¢–ê–õ–û üëáüëáüëá
    function isVipActive() {
        if (!userState.referral_activated_at) return false;
        const activatedTime = new Date(userState.referral_activated_at).getTime();
        const now = new Date().getTime();
        return (now - activatedTime) < (7 * 24 * 60 * 60 * 1000);
    }
    // üëÜüëÜüëÜ ------------------------------------- üëÜüëÜüëÜ

    function updateUI() {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –±–∞–ª–∞–Ω—Å —Å 1 –∑–Ω–∞–∫–æ–º –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
        dom.coinsDisplay.textContent = userState.coins.toFixed(1);
        dom.ticketsDisplay.textContent = userState.tickets;
        dom.streakDayDisplay.textContent = userState.streakDays;
        
        // –†–∞—Å—á–µ—Ç: –ë–∞–∑–∞ + –ë–æ–Ω—É—Å—ã
        const { totalBonus, boostsHTML, baseReward } = calculateBoosts();
        const totalReward = (baseReward + totalBonus).toFixed(1); 
        
        // –ï—Å–ª–∏ –±–æ–Ω—É—Å–æ–≤ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
        if (totalBonus > 0) {
            dom.todayRewardDisplay.textContent = `+${totalReward} (—Å –±–æ–Ω—É—Å–æ–º)`;
            dom.todayRewardDisplay.style.color = "#FFD700"; 
        } else {
            dom.todayRewardDisplay.textContent = `+${totalReward}`;
            dom.todayRewardDisplay.style.color = "#fff";
        }
        
        if (boostsHTML) {
            dom.boostContainer.innerHTML = boostsHTML;
            dom.boostContainer.style.display = 'flex';
        } else {
            dom.boostContainer.style.display = 'none';
        }

        const now = new Date().getTime();
        const last = userState.lastGrindTime ? new Date(userState.lastGrindTime).getTime() : 0;
        const diff = now - last;

        if (diff < GRIND_COOLDOWN) {
            dom.grindBtn.disabled = true;
            const remaining = GRIND_COOLDOWN - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.grindBtnText.textContent = `–ß–ï–†–ï–ó ${h}—á ${m}–º`;
        } else {
            dom.grindBtn.disabled = false;
            dom.grindBtnText.textContent = "–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°";
        }
        
        // –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
        if (isVipActive()) {
            dom.ticketSubtitle.textContent = "VIP: +2 –±–∏–ª–µ—Ç–∞ / 24—á";
            dom.ticketSubtitle.style.color = "#FFD700";
        }
    }
  
    function renderStreakVisuals() {
        dom.streakSteps.innerHTML = '';
        let percent = ((userState.streakDays - 1) / (MAX_STREAK - 1)) * 100;
        if (percent > 100) percent = 100;
        dom.streakBar.style.width = `${percent}%`;

        for (let i = 1; i <= 5; i++) {
            const step = document.createElement('div');
            step.className = 'streak-step';
            let dayValue = [1, 3, 5, 7, 10][i-1];
            step.textContent = dayValue;
            if (userState.streakDays >= dayValue) {
                step.classList.add('completed');
                step.innerHTML = '<i class="fa-solid fa-check"></i>';
            }
            dom.streakSteps.appendChild(step);
        }
    }

    // --- –ú–ê–ì–ê–ó–ò–ù ---
    async function fetchShopItems() {
        shopItems = [
            { type: 'ticket', cost: 3, reward: 1, title: '1 –ë–∏–ª–µ—Ç' },
            { type: 'ticket', cost: 15, reward: 1, title: '5 –ë–∏–ª–µ—Ç–æ–≤' },        
            { type: 'ticket', cost: 30, reward: 10, title: '10 –ë–∏–ª–µ—Ç–æ–≤' }
        ];
        try {
            const response = await fetch('/api/v1/user/grind/shop');
            const promos = await response.json();
            if (promos && promos.length > 0) {
                promos.forEach(p => {
                    shopItems.push({
                        type: 'promo', cost: p.reward_value, reward: p.reward_value,
                        title: `–ö–æ–¥ –Ω–∞ ${p.reward_value} ‚òÖ`, quantity: p.quantity
                    });
                });
                shopItems.sort((a, b) => a.cost - b.cost);
            }
        } catch (e) {}
    }

    window.switchTab = (tab) => {
        currentTab = tab;
        dom.tabTickets.classList.toggle('active', tab === 'tickets');
        dom.tabPromos.classList.toggle('active', tab === 'promos');
        renderShopList();
    };

    window.openShopModal = async () => {
        dom.shopModal.classList.add('visible');
        dom.shopContainer.innerHTML = '<div style="text-align:center; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        await fetchShopItems(); 
        renderShopList();
    };

    window.closeShopModal = () => dom.shopModal.classList.remove('visible');

    function renderShopList() {
        dom.shopContainer.innerHTML = '';
        const items = shopItems.filter(i => i.type === (currentTab === 'tickets' ? 'ticket' : 'promo'));
        
        if (items.length === 0) {
            dom.shopContainer.innerHTML = '<div style="text-align:center; color:#777; padding:20px;">–ü—É—Å—Ç–æ</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'exchange-item';
            const isAffordable = userState.coins >= item.cost;
            const btnClick = item.type === 'ticket' ? `exchangeCoins(${item.cost}, ${item.reward})` : `buyItem(${item.reward})`;
            let extra = item.quantity ? `<span style="opacity:0.5; font-size:9px;">(–û—Å—Ç: ${item.quantity})</span>` : '';

            div.innerHTML = `
                <div class="exchange-details">
                    <div class="exchange-title">${item.title}</div>
                    <div class="exchange-cost">–¶–µ–Ω–∞: ${item.cost} –º–æ–Ω–µ—Ç ${extra}</div>
                </div>
                <button class="mini-btn" onclick="${btnClick}" ${isAffordable?'':'disabled'} style="${isAffordable?'background:var(--accent-primary);color:#000':''}">
                    ${isAffordable ? '–ö—É–ø–∏—Ç—å' : '–ú–∞–ª–æ –º–æ–Ω–µ—Ç'}
                </button>`;
            dom.shopContainer.appendChild(div);
        });
    }

    // --- –î–ï–ô–°–¢–í–ò–Ø ---
    dom.grindBtn.addEventListener('click', async () => {
        if (dom.grindBtn.disabled) return;
        tg.HapticFeedback.impactOccurred('medium');
        dom.grindBtn.disabled = true;

        try {
            const response = await fetch('/api/v1/user/grind/claim', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || "–û—à–∏–±–∫–∞");
            }

            const res = await response.json();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
            const claimed = parseFloat(res.reward_claimed).toFixed(2);
            showFloatText(dom.grindBtn, `+${claimed}`, 'var(--accent-primary)');
            
            userState.coins = parseFloat(res.new_coins);
            userState.streakDays = res.streak_days;
            userState.lastGrindTime = res.last_grind_at;

            updateUI();
            renderStreakVisuals();

        } catch (e) {
            tg.showAlert(e.message);
            dom.grindBtn.disabled = false;
        }
    });

    window.exchangeCoins = async (cost, rewardTickets) => {
        tg.showConfirm(`–ö—É–ø–∏—Ç—å ${rewardTickets} –±–∏–ª–µ—Ç(–æ–≤) –∑–∞ ${cost} –º–æ–Ω–µ—Ç?`, async (ok) => {
            if (ok) {
                try {
                    const response = await fetch('/api/v1/user/grind/exchange', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, cost: cost, tickets_reward: rewardTickets })
                    });
                    if (!response.ok) throw new Error();
                    const res = await response.json();
                    userState.coins = parseFloat(res.new_coins);
                    userState.tickets = res.new_tickets;
                    updateUI();
                    renderShopList();
                    tg.HapticFeedback.notificationOccurred('success');
                } catch (e) { tg.showAlert('–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞'); }
            }
        });
    };

    window.buyItem = async (val) => {
        tg.showConfirm(`–ö—É–ø–∏—Ç—å –∫–æ–¥ –Ω–∞ ${val} –∑–≤–µ–∑–¥?`, async (ok) => {
            if(ok) {
                try {
                    const response = await fetch('/api/v1/user/grind/buy_item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, reward_value: val })
                    });
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞');
                    const res = await response.json();
                    userState.coins = parseFloat(res.new_coins);
                    updateUI();
                    await fetchShopItems(); renderShopList();
                    tg.showPopup({title:'–£—Å–ø–µ—à–Ω–æ!', message: `–í–∞—à –∫–æ–¥:\n${res.promo_code}`, buttons:[{type:'ok'}]});
                } catch(e) { tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å'); }
            }
        });
    };

    function renderFreeTicketBtn() {
        const lastClaim = userState.lastFreeTicket ? new Date(userState.lastFreeTicket).getTime() : 0;
        const now = new Date().getTime();
        const diff = now - lastClaim;

        if (diff > GRIND_COOLDOWN) {
            // –ï—Å–ª–∏ VIP, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –¥–∞–¥—É—Ç 2 –±–∏–ª–µ—Ç–∞
            const btnText = isVipActive() ? "+2 –ë–ò–õ–ï–¢–ê (VIP)" : "–ü–û–õ–£–ß–ò–¢–¨";
            const btnColor = isVipActive() ? "#FFD700" : "#fff";
            
            dom.freeTicketContainer.innerHTML = `<button class="mini-btn" style="border-color:${btnColor}; color:${btnColor}; width:100%;" onclick="claimFreeTicket()">${btnText}</button>`;
        } else {
            const remaining = GRIND_COOLDOWN - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.freeTicketContainer.innerHTML = `<span style="font-size:11px; color:#555;">${h}—á ${m}–º</span>`;
        }
    }

    window.claimFreeTicket = async () => {
        try {
            const response = await fetch('/api/v1/user/claim-free-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });
            if (response.ok) {
                const res = await response.json();
                userState.tickets = res.new_ticket_balance;
                userState.lastFreeTicket = new Date().toISOString();
                tg.HapticFeedback.notificationOccurred('success');
                
                // –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 2 (VIP), —Å–æ–æ–±—â–∏–º –æ–± —ç—Ç–æ–º
                tg.showAlert(res.message); 
                
                updateUI();
                renderFreeTicketBtn();
            } else { throw new Error(); }
        } catch (e) { tg.showAlert('–û—à–∏–±–∫–∞'); }
    };

    function startTimers() {
        setInterval(() => { updateUI(); renderFreeTicketBtn(); }, 60000);
        renderFreeTicketBtn();
    }

    function showFloatText(element, text, color) {
        const rect = element.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.textContent = text;
        floatEl.className = 'float-anim';
        floatEl.style.color = color;
        floatEl.style.left = (rect.left + rect.width / 2 - 20) + 'px';
        floatEl.style.top = (rect.top) + 'px';
        document.body.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 1000);
    }

    init();
});
</script>
</body>
</html>
