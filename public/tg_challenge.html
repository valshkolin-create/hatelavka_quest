<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Challenge</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');

        body {
            margin: 0; padding: 20px;
            background-color: #0f1014;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
        }

        .header { margin-bottom: 25px; }
        .header h1 { font-size: 26px; font-weight: 800; margin: 0; text-transform: uppercase; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        
        .challenge-card {
            background: #1a1b20;
            border-radius: 16px;
            padding: 20px;
            position: relative;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        /* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card-common { border-color: #444; }
        .card-rare   { border-color: #4b69ff; box-shadow: 0 0 15px rgba(75,105,255,0.15); }
        .card-epic   { border-color: #8847ff; box-shadow: 0 0 15px rgba(136,71,255,0.2); }
        .card-legend { border-color: #eb4b4b; box-shadow: 0 0 15px rgba(235,75,75,0.25); }
        .card-gold   { border-color: #ffd700; box-shadow: 0 0 25px rgba(255,215,0,0.3); }

        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 18px; font-weight: 700; }
        .reward-badge {
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #ccc;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .progress-track {
            height: 10px;
            background: rgba(0,0,0,0.4);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4b69ff, #8847ff);
            transition: width 0.5s ease;
        }
        
        .progress-labels { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 20px; }
        .current-val { color: #fff; font-weight: 700; }

        .next-reward-info {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .next-reward-info span { color: #aaa; font-weight: 600; }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 800;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-start { background: #2a2d35; color: #fff; }
        .btn-claim { 
            background: linear-gradient(90deg, #FFD700, #FFA500); 
            color: #000; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            animation: pulse 2s infinite;
        }
        .btn-done { background: #111; color: #444; cursor: default; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="header">
        <h1>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h1>
    </div>

    <div id="app">
        <div style="text-align:center; color:#666; margin-top:50px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        async function init() {
            try {
                const res = await fetch(`/api/challenges/list?initData=${encodeURIComponent(tg.initData)}`);
                const data = await res.json();
                render(data.challenges);
            } catch (e) {
                document.getElementById('app').innerHTML = `<div style="color:red">–û—à–∏–±–∫–∞: ${e.message}</div>`;
            }
        }

        function render(list) {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if(list.length === 0) {
                app.innerHTML = '<div style="text-align:center; color:#666;">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</div>';
                return;
            }

            list.forEach(item => {
                const card = document.createElement('div');
                
                // –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const current = item.current_progress;
                const target = item.target;
                const percent = Math.min(100, (current / target) * 100);
                
                // –°—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É
                let theme = 'card-common';
                if(percent >= 25) theme = 'card-rare';
                if(percent >= 50) theme = 'card-epic';
                if(percent >= 75) theme = 'card-legend';
                if(item.status === 'ready_to_claim') theme = 'card-gold';

                card.className = `challenge-card ${theme}`;

                // –¢–µ–∫—Å—Ç –Ω–∞–≥—Ä–∞–¥—ã
                let rewardTxt = `${item.reward_amount} üéüÔ∏è`;
                if(item.reward_type === 'coins') rewardTxt = `${item.reward_amount} üí∞`;
                if(item.reward_type === 'skin_random') rewardTxt = `üî• –ö–µ–π—Å`;

                // –ù–∏–∂–Ω–∏–π —Ç–µ–∫—Å—Ç (Next Reward)
                let footerHtml = '';
                if(item.next_tier) {
                    let nextRwd = item.next_tier.reward + (item.next_tier.type === 'coins' ? ' –º–æ–Ω–µ—Ç' : ' –±–∏–ª–µ—Ç–æ–≤');
                    footerHtml = `
                        <div class="next-reward-info">
                            –°–ª–µ–¥—É—é—â–∞—è —Ü–µ–ª—å: <span>${item.next_tier.target} —Å–æ–æ–±—â–µ–Ω–∏–π</span> | –ù–∞–≥—Ä–∞–¥–∞: <span>${nextRwd}</span>
                        </div>
                    `;
                } else if (item.status !== 'completed') {
                    footerHtml = `<div class="next-reward-info">–≠—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å! üèÜ</div>`;
                }

                // –ö–Ω–æ–ø–∫–∞
                let btnHtml = '';
                if(item.status === 'available') {
                    btnHtml = `<button class="btn btn-start" onclick="action('start', ${item.template_id})">–ù–ê–ß–ê–¢–¨</button>`;
                } else if(item.status === 'active') {
                    btnHtml = `<div style="text-align:center; font-size:12px; color:#666; margin-top:10px;">–ü–ò–®–ò –°–û–û–ë–©–ï–ù–ò–Ø...</div>`;
                } else if(item.status === 'ready_to_claim') {
                    btnHtml = `<button class="btn btn-claim" onclick="action('claim', ${item.template_id})">–ó–ê–ë–†–ê–¢–¨ ${rewardTxt}</button>`;
                } else {
                    btnHtml = `<button class="btn btn-done">–í–°–Å –í–´–ü–û–õ–ù–ï–ù–û</button>`;
                }

                card.innerHTML = `
                    <div class="top-row">
                        <div class="card-title">${item.title}</div>
                        <div class="reward-badge">${rewardTxt}</div>
                    </div>
                    
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                    <div class="progress-labels">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span class="current-val">${current} / ${target}</span>
                    </div>

                    ${btnHtml}
                    ${footerHtml}
                `;

                app.appendChild(card);
            });
        }

        async function action(type, id) {
            tg.HapticFeedback.impactOccurred('medium');
            try {
                const res = await fetch(`/api/challenges/${type}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData, template_id: id })
                });
                const json = await res.json();
                
                if(json.status === 'ok') {
                    if(type === 'claim') {
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!`);
                    }
                    init(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                } else {
                    tg.showAlert(json.message);
                }
            } catch(e) {
                tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            }
        }

        init();
    </script>
</body>
</html>
