<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Daily Grind</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --bg-main: #09090b;
      --surface-card: #18181b;
      --surface-elevated: #27272a;
      --accent-color: #d433ff; /* Фиолетовый акцент */
      --accent-glow: rgba(212, 51, 255, 0.4);
      --coin-color: #ffd700;
      --ticket-color: #00f2ea;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      margin: 0;
      padding: 20px 20px 100px;
      min-height: 100vh;
    }

    /* --- HEADER & BALANCE --- */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .balance-card {
      background: linear-gradient(135deg, var(--surface-card), var(--surface-elevated));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .balance-card:first-child { margin-right: 15px; }

    .balance-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .balance-value { font-size: 24px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    
    .coin-icon { color: var(--coin-color); filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
    .ticket-icon { color: var(--ticket-color); filter: drop-shadow(0 0 5px rgba(0, 242, 234, 0.5)); }

    /* --- STREAK PROGRESS --- */
    .grind-section {
      background: var(--surface-card);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid rgba(255,255,255,0.05);
      position: relative;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i { color: var(--accent-color); }

    .streak-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      position: relative;
    }

    /* Линия прогресса */
    .streak-track {
      position: absolute;
      top: 50%;
      left: 10px;
      right: 10px;
      height: 4px;
      background: #333;
      transform: translateY(-50%);
      z-index: 0;
      border-radius: 2px;
    }

    .streak-fill {
      position: absolute;
      top: 50%;
      left: 10px;
      height: 4px;
      background: var(--accent-color);
      transform: translateY(-50%);
      z-index: 1;
      border-radius: 2px;
      width: 0%; /* JS update */
      transition: width 0.5s ease;
      box-shadow: 0 0 10px var(--accent-color);
    }

    .streak-step {
      width: 30px;
      height: 30px;
      background: var(--surface-elevated);
      border: 2px solid #444;
      border-radius: 50%;
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      font-weight: bold;
      color: var(--text-muted);
      transition: all 0.3s ease;
    }

    .streak-step.active {
      border-color: var(--accent-color);
      background: var(--bg-main);
      color: white;
      box-shadow: 0 0 10px var(--accent-glow);
      transform: scale(1.1);
    }

    .streak-step.completed {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: black;
    }

    .next-reward-info {
      text-align: center;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 15px;
    }
    .next-reward-info span { color: var(--coin-color); font-weight: bold; }

    /* --- BIG CLAIM BUTTON --- */
    .grind-btn {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      color: black;
      background: var(--accent-color);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.1s, filter 0.2s;
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .grind-btn:active { transform: scale(0.98); }
    
    .grind-btn.disabled {
      background: #333;
      color: #777;
      cursor: not-allowed;
      box-shadow: none;
    }

    .grind-btn .shine {
      position: absolute;
      top: 0; left: -100%;
      width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shine 3s infinite;
    }

    @keyframes shine { 
      0% { left: -100%; } 
      20% { left: 200%; } 
      100% { left: 200%; } 
    }

    .timer-display { font-family: monospace; font-size: 14px; margin-left: 8px; }

    /* --- EXCHANGE MARKET --- */
    .exchange-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .exchange-card {
      background: var(--surface-card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .exchange-info { display: flex; flex-direction: column; gap: 4px; }
    .exchange-rate { font-size: 16px; font-weight: 700; color: white; }
    .exchange-desc { font-size: 12px; color: var(--text-muted); }
    
    .exchange-btn {
      background: rgba(0, 242, 234, 0.1);
      border: 1px solid var(--ticket-color);
      color: var(--ticket-color);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .exchange-btn:active { background: var(--ticket-color); color: black; }
    .exchange-btn:disabled { border-color: #444; color: #666; background: transparent; }

    /* --- BONUS TICKET (Legacy) --- */
    .legacy-ticket-block {
      background: linear-gradient(45deg, #1e1b2e, #2a2638);
      border: 1px solid #3c3852;
      border-radius: 16px;
      padding: 15px;
      margin-top: 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .legacy-info h4 { margin: 0 0 4px; font-size: 14px; color: white; }
    .legacy-info p { margin: 0; font-size: 11px; color: var(--text-muted); }
    
    .legacy-btn {
      background: #00f2ea;
      color: black;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
    }
    .legacy-btn:disabled { background: #333; color: #777; }

    /* --- FOOTER --- */
    .app-footer {
      display: flex;
      justify-content: space-around;
      background-color: rgba(24, 24, 27, 0.9);
      backdrop-filter: blur(15px);
      border-top: 1px solid #333;
      width: 100%;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      position: fixed;
      bottom: 0; left: 0;
      z-index: 100;
    }

    .footer-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      color: var(--text-muted); text-decoration: none; font-size: 11px; flex: 1;
    }
    .footer-item i { font-size: 20px; margin-bottom: 2px; }
    .footer-item.active { color: var(--accent-color); }

    /* Animation for coins */
    .float-anim { animation: floatUp 1s ease-out forwards; position: absolute; font-weight: bold; font-size: 20px; pointer-events: none; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }

  </style>
</head>
<body>

  <div class="dashboard-header">
    <div class="balance-card">
      <span class="balance-label">Монеты</span>
      <div class="balance-value">
        <span id="user-coins">0.0</span> <i class="fa-solid fa-coins coin-icon"></i>
      </div>
    </div>
    <div class="balance-card">
      <span class="balance-label">Билеты</span>
      <div class="balance-value">
        <span id="user-tickets">0</span> <i class="fa-solid fa-ticket ticket-icon"></i>
      </div>
    </div>
  </div>

  <div class="grind-section">
    <h3 class="section-title"><i class="fa-solid fa-fire"></i> Ежедневная Серия</h3>
    
    <div class="streak-container">
      <div class="streak-track"></div>
      <div class="streak-fill" id="streak-bar"></div>
      
      <div id="streak-steps" style="display: flex; justify-content: space-between; width: 100%; position: relative;"></div>
    </div>

    <div class="next-reward-info">
      Текущая серия: <span id="current-streak-day">1</span> дн. <br>
      Награда сегодня: <span id="today-reward">+0.1</span>
    </div>

    <button id="grind-btn" class="grind-btn">
      <span id="grind-btn-text">ЗАБРАТЬ МОНЕТЫ</span>
      <div class="shine"></div>
    </button>
  </div>

  <div class="grind-section">
    <h3 class="section-title"><i class="fa-solid fa-shop"></i> Обмен Монет</h3>
    <div class="exchange-grid">
      
      <div class="exchange-card">
        <div class="exchange-info">
          <div class="exchange-rate">4 Монеты ➜ 1 Билет</div>
          <div class="exchange-desc">Стандартный обмен</div>
        </div>
        <button class="exchange-btn" onclick="exchangeCoins(4, 1)">Обменять</button>
      </div>

      <div class="exchange-card">
        <div class="exchange-info">
          <div class="exchange-rate" style="color: var(--coin-color)">40 Монет ➜ 10 Билетов</div>
          <div class="exchange-desc">Пакетный обмен</div>
        </div>
        <button class="exchange-btn" onclick="exchangeCoins(40, 10)">Обменять</button>
      </div>

    </div>
  </div>

  <div class="legacy-ticket-block">
    <div class="legacy-info">
      <h4>Ежедневный бонус</h4>
      <p>Обычный бесплатный билет раз в 24ч</p>
    </div>
    <div id="free-ticket-container">
        </div>
  </div>

  <footer class="app-footer">
    <a href="/menu" class="footer-item">
      <i class="fa-solid fa-house"></i>
      <span>Главная</span>
    </a>
    <a href="/events" class="footer-item active">
      <i class="fa-solid fa-gavel"></i>
      <span>Гринд</span>
    </a>
    <a href="/profile" class="footer-item">
      <i class="fa-solid fa-user"></i>
      <span>Профиль</span>
    </a>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Эмуляция данных пользователя (Пока нет бэкенда для монет)
    // В реальной версии это придет из API /api/v1/user/me
    let userState = {
        coins: 0.0,
        tickets: 0,
        streakDays: 1,       // Текущий день серии (1-10)
        lastGrindTime: null, // timestamp ISO
        lastFreeTicket: null // timestamp ISO
    };

    const MAX_STREAK = 10;
    const GRIND_COOLDOWN = 24 * 60 * 60 * 1000; // 24 часа

    // DOM Elements
    const dom = {
        coinsDisplay: document.getElementById('user-coins'),
        ticketsDisplay: document.getElementById('user-tickets'),
        streakBar: document.getElementById('streak-bar'),
        streakSteps: document.getElementById('streak-steps'),
        streakDayDisplay: document.getElementById('current-streak-day'),
        todayRewardDisplay: document.getElementById('today-reward'),
        grindBtn: document.getElementById('grind-btn'),
        grindBtnText: document.getElementById('grind-btn-text'),
        freeTicketContainer: document.getElementById('free-ticket-container')
    };

    // --- ИНИЦИАЛИЗАЦИЯ ---
    async function init() {
        try {
            // 1. Загружаем данные пользователя (билеты и даты)
            // ВАЖНО: Вам нужно будет обновить API, чтобы возвращать 'coins', 'streak_days', 'last_grind_date'
            const response = await fetch('/api/v1/user/me', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (response.ok) {
                const data = await response.json();
                userState.tickets = data.tickets || 0;
                // Пока API не обновлено, используем заглушки или localStorage для теста
                // В продакшене данные должны идти с сервера!
                loadLocalState(data.id); 
                userState.lastFreeTicket = data.last_free_ticket_claimed_at;
                
                updateUI();
                renderStreakVisuals();
                startTimers();
            }
        } catch (e) {
            console.error("Ошибка загрузки:", e);
            // Фолбэк для браузера
            updateUI();
            renderStreakVisuals();
        }
    }

    // Временная функция для сохранения состояния гринда (пока вы не добавите колонки в БД)
    function loadLocalState(userId) {
        const key = `grind_state_${userId || 'guest'}`;
        const saved = localStorage.getItem(key);
        if (saved) {
            const parsed = JSON.parse(saved);
            userState.coins = parsed.coins || 0;
            userState.streakDays = parsed.streakDays || 1;
            userState.lastGrindTime = parsed.lastGrindTime;
            
            // Логика сброса серии (если прошло > 48 часов)
            if (userState.lastGrindTime) {
                const now = new Date().getTime();
                const last = new Date(userState.lastGrindTime).getTime();
                if (now - last > (48 * 60 * 60 * 1000)) {
                    userState.streakDays = 1; // Сброс серии
                }
            }
        }
    }

    function saveLocalState() {
        // В продакшене это не нужно, состояние сохраняется на сервере
        const userId = tg.initDataUnsafe?.user?.id || 'guest';
        const key = `grind_state_${userId}`;
        localStorage.setItem(key, JSON.stringify(userState));
    }

    // --- РЕНДЕРИНГ ---

    function updateUI() {
        // Обновляем цифры
        dom.coinsDisplay.textContent = userState.coins.toFixed(1);
        dom.ticketsDisplay.textContent = userState.tickets;
        dom.streakDayDisplay.textContent = userState.streakDays;
        
        // Расчет награды (0.1 * день серии, макс 1.0)
        let reward = (userState.streakDays * 0.1).toFixed(1);
        if (parseFloat(reward) > 1.0) reward = "1.0";
        dom.todayRewardDisplay.textContent = `+${reward}`;
        dom.todayRewardDisplay.style.color = 'var(--coin-color)';

        // Состояние кнопки Гринда
        const now = new Date().getTime();
        const last = userState.lastGrindTime ? new Date(userState.lastGrindTime).getTime() : 0;
        const diff = now - last;

        if (diff < GRIND_COOLDOWN) {
            dom.grindBtn.classList.add('disabled');
            const remaining = GRIND_COOLDOWN - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.grindBtnText.innerHTML = `ЖДИТЕ: <span class="timer-display">${h}ч ${m}м</span>`;
        } else {
            dom.grindBtn.classList.remove('disabled');
            dom.grindBtnText.textContent = "ЗАБРАТЬ МОНЕТЫ";
        }

        // Обновление кнопок обмена
        document.querySelectorAll('.exchange-btn').forEach(btn => {
            // Простая логика проверки баланса в UI (реальная проверка на сервере)
            // Здесь сложно получить параметры onclick, поэтому оставим как есть,
            // валидация будет внутри функции exchangeCoins
        });
    }

    function renderStreakVisuals() {
        dom.streakSteps.innerHTML = '';
        const stepsCount = 5; // Показываем 5 основных точек, хотя дней может быть больше
        
        // Логика визуализации: 
        // 1..2..3..4..10
        
        // Процент заполнения бара
        // Если день 1 -> 0%, День 5 -> 50%, День 10 -> 100%
        let percent = ((userState.streakDays - 1) / (MAX_STREAK - 1)) * 100;
        if (percent > 100) percent = 100;
        dom.streakBar.style.width = `${percent}%`;

        // Генерируем кружки
        for (let i = 1; i <= 5; i++) {
            const step = document.createElement('div');
            step.className = 'streak-step';
            
            // Распределяем значения для 5 кружков: 1, 3, 5, 7, 10
            let dayValue = 1;
            if (i === 2) dayValue = 3;
            if (i === 3) dayValue = 5;
            if (i === 4) dayValue = 7;
            if (i === 5) dayValue = 10;

            step.textContent = dayValue;

            if (userState.streakDays >= dayValue) {
                step.classList.add('completed');
                step.innerHTML = '<i class="fa-solid fa-check"></i>';
            }
            
            // Подсветка следующей цели
            if (userState.streakDays < dayValue && userState.streakDays > (dayValue - 3)) {
                // Ближайшая цель
                // step.style.borderColor = 'white';
            }

            dom.streakSteps.appendChild(step);
        }
    }

    // --- ЛОГИКА ДЕЙСТВИЙ ---

    // 1. ЗАБРАТЬ МОНЕТЫ
    dom.grindBtn.addEventListener('click', async () => {
        if (dom.grindBtn.classList.contains('disabled')) {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        tg.HapticFeedback.impactOccurred('medium');

        // Расчет награды
        let rewardAmount = parseFloat((userState.streakDays * 0.1).toFixed(1));
        if (rewardAmount > 1.0) rewardAmount = 1.0;

        // Анимация вылетающей цифры
        showFloatText(dom.grindBtn, `+${rewardAmount}`, 'var(--coin-color)');

        // Обновление состояния
        userState.coins += rewardAmount;
        userState.lastGrindTime = new Date().toISOString();
        
        // Увеличение серии (до макс 10)
        if (userState.streakDays < MAX_STREAK) {
            userState.streakDays++;
        }

        // Сохранение (здесь нужен fetch к вашему новому API)
        /*
        await fetch('/api/v1/user/grind/claim', {
            method: 'POST', 
            body: JSON.stringify({initData: tg.initData})
        });
        */
        saveLocalState();
        updateUI();
        renderStreakVisuals();
    });

    // 2. ОБМЕН МОНЕТ
    window.exchangeCoins = async (cost, rewardTickets) => {
        if (userState.coins < cost) {
            tg.showAlert(`Недостаточно монет! Нужно ${cost}.`);
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        tg.showConfirm(`Обменять ${cost} монет на ${rewardTickets} билет(ов)?`, async (ok) => {
            if (ok) {
                // Списываем
                userState.coins -= cost;
                
                // Вызываем API начисления билетов (существующее)
                // Но лучше создать отдельный эндпоинт для обмена
                try {
                    // Эмуляция успеха
                    userState.tickets += rewardTickets;
                    
                    // Здесь в идеале вызвать:
                    // /api/v1/user/grind/exchange 
                    
                    // Но пока используем локальный апдейт + сохранение
                    saveLocalState();
                    updateUI();
                    tg.showAlert('Успешный обмен!');
                    tg.HapticFeedback.notificationOccurred('success');
                } catch (e) {
                    tg.showAlert('Ошибка обмена.');
                }
            }
        });
    };

    // 3. БЕСПЛАТНЫЙ БИЛЕТ (LEGACY)
    function renderFreeTicketBtn() {
        const lastClaim = userState.lastFreeTicket ? new Date(userState.lastFreeTicket).getTime() : 0;
        const now = new Date().getTime();
        const diff = now - lastClaim;
        const cooldown = 24 * 60 * 60 * 1000;

        if (diff > cooldown) {
            dom.freeTicketContainer.innerHTML = `<button class="legacy-btn" onclick="claimFreeTicket()">ПОЛУЧИТЬ</button>`;
        } else {
            const remaining = cooldown - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.freeTicketContainer.innerHTML = `<button class="legacy-btn" disabled>${h}ч ${m}м</button>`;
        }
    }

    window.claimFreeTicket = async () => {
        const btn = document.querySelector('.legacy-btn');
        if(btn) btn.disabled = true;
        
        try {
            const response = await fetch('/api/v1/user/claim-free-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });
            
            if (response.ok) {
                const res = await response.json();
                userState.tickets = res.new_ticket_balance;
                userState.lastFreeTicket = new Date().toISOString();
                tg.showAlert('Бесплатный билет получен!');
                updateUI();
                renderFreeTicketBtn();
            } else {
                throw new Error();
            }
        } catch (e) {
            tg.showAlert('Ошибка получения билета');
            if(btn) btn.disabled = false;
        }
    };

    // Утилиты
    function startTimers() {
        setInterval(() => {
            updateUI(); // Обновляет таймер на кнопке гринда
            renderFreeTicketBtn(); // Обновляет таймер на бонусе
        }, 60000); // Раз в минуту
        renderFreeTicketBtn();
    }

    function showFloatText(element, text, color) {
        const rect = element.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.textContent = text;
        floatEl.className = 'float-anim';
        floatEl.style.color = color;
        floatEl.style.left = (rect.left + rect.width / 2 - 10) + 'px';
        floatEl.style.top = (rect.top) + 'px';
        document.body.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 1000);
    }

    init();
});
</script>
</body>
</html>
