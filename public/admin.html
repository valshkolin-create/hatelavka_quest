<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админ-панель</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --bg-gradient: radial-gradient(ellipse at 50% 100%, #041a07, #000000);
      --bg-color: #000000;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --primary-color: #34c759;
      --action-color: #007aff;
      --surface-glass-bg: rgba(28, 28, 30, 0.75);
      --divider-glass-color: rgba(58, 58, 60, 0.6);
      --danger-color: #ff3b30;
      --status-active-color: #32d74b;
      --status-inactive-color: #98989d;
      --status-approved-color: #5ac8fa;
      --status-pending-color: #ff9500;
      --status-rejected-color: #ff3b30;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-image: var(--bg-gradient); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; min-height: 100vh; }
    .container { max-width: 800px; margin: 0 auto; padding-bottom: 90px; }
    .header { text-align: center; margin-bottom: 20px; }
    .view { display: none; }
    .view.active { display: block; }
    .tab-bar { display: flex; justify-content: space-around; background-color: var(--surface-glass-bg); padding: 10px; border-radius: 12px; margin-bottom: 20px; }
    .tab-bar button { background: none; border: none; color: var(--text-color-muted); font-size: 14px; font-weight: 600; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
    .tab-bar button.active { background-color: rgba(255, 255, 255, 0.1); color: var(--primary-color); }
    .section-title { font-size: 18px; font-weight: 600; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid var(--divider-glass-color); padding-bottom: 8px; }
    .glass-card { background-color: var(--surface-glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--divider-glass-color); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 12px; color: var(--text-color-muted); margin-bottom: 5px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--divider-glass-color); background-color: rgba(58, 58, 60, 0.5); border-radius: 8px; color: var(--text-color); box-sizing: border-box; }
    .form-group button { width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .form-group button:hover { opacity: 0.8; }
    .form-group input[type="checkbox"] { width: auto; margin-right: 10px; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--divider-glass-color); }
    .list-item:last-child { border-bottom: none; }
    .item-details { flex-grow: 1; }
    .item-title { font-size: 14px; font-weight: 600; color: var(--text-color); }
    .item-subtitle { font-size: 12px; color: var(--text-color-muted); }
    .item-actions { display: flex; gap: 8px; }
    .item-actions button { background: none; border: none; color: var(--action-color); font-size: 12px; cursor: pointer; padding: 4px 8px; }
    .submission-card { display: flex; flex-direction: column; gap: 10px; }
    .submission-header { display: flex; justify-content: space-between; align-items: center; }
    .submission-body { font-size: 13px; background-color: rgba(58, 58, 60, 0.3); padding: 10px; border-radius: 8px; word-wrap: break-word; }
    .submission-actions button { padding: 8px 12px; font-size: 13px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; }
    .btn-approve { background-color: var(--status-approved-color); color: black; }
    .btn-reject { background-color: var(--status-rejected-color); color: white; }
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .spinner { width: 36px; height: 36px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(52, 199, 89, 0.9); color: white; padding: 10px 20px; border-radius: 8px; z-index: 400; font-weight: 600; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from { top: 0; opacity: 0; } to { top: 20px; opacity: 1; } }
    @keyframes fadeout { from { top: 20px; opacity: 1; } to { top: 0; opacity: 0; } }
    
    /* Добавленные стили для кнопок победителей */
    .winner-card-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .winner-card-actions button {
        flex-grow: 1;
        min-width: 120px;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .winner-card-actions button:active {
        transform: scale(0.95);
    }
    .btn-message {
        background-color: #007aff;
        color: white;
    }
    .btn-trade {
        background-color: #34c759;
        color: white;
    }
    .winner-card-actions a.btn-trade {
        text-decoration: none;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    /* Стиль для списка победителей */
    .winner-list-item {
        padding: 15px;
        border: 1px solid rgba(58, 58, 60, 0.6);
        border-radius: 12px;
        margin-bottom: 15px;
        background-color: var(--surface-glass-bg);
    }
    .winner-info p {
        margin: 0 0 5px 0;
        font-size: 14px;
        color: var(--text-color);
    }
    .winner-info p span {
        color: var(--text-color-muted);
    }
    .winner-info .highlight {
        color: var(--primary-color);
        font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="loader-overlay hidden" id="loader-overlay">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <div class="header">
      <div id="username-display"></div>
      <div class="tab-bar">
        <button data-view="view-submissions" class="active">Заявки</button>
        <button data-view="view-quests">Задания</button>
        <button data-view="view-promocodes">Промокоды</button>
        <button data-view="view-categories">Категории</button>
        <button data-view="view-challenges">Челленджи</button>
        <button data-view="view-winners">Победители розыгрышей</button>
      </div>
    </div>
    
    <!-- View Заявки -->
    <div class="view active" id="view-submissions">
      <h2 class="section-title">Заявки на проверку (<span id="pending-count">0</span>)</h2>
      <div id="submissions-list"></div>
    </div>

    <!-- View Задания -->
    <div class="view" id="view-quests">
      <h2 class="section-title">Создать задание</h2>
      <div class="glass-card">
        <form id="create-quest-form">
          <div class="form-group"><input type="text" id="quest-title-input" placeholder="Название задания" required></div>
          <div class="form-group"><textarea id="quest-description-input" placeholder="Описание задания (необязательно)"></textarea></div>
          <div class="form-group"><input type="number" id="quest-reward-input" placeholder="Количество билетов" required min="1"></div>
          <div class="form-group">
            <label for="quest-type-select">Тип задания:</label>
            <select id="quest-type-select">
              <option value="manual_check">Ручная проверка</option>
              <option value="automatic_twitch_messages">Twitch: Сообщения (сессия)</option>
              <option value="automatic_twitch_uptime">Twitch: Время просмотра (сессия)</option>
              <option value="automatic_telegram_messages">Telegram: Сообщения</option>
            </select>
          </div>
          <div class="form-group" id="target-value-group"><input type="number" id="quest-target-value-input" placeholder="Целевое значение (например, 100)" min="1"></div>
          <div class="form-group" id="icon-url-group"><input type="text" id="quest-icon-url-input" placeholder="URL иконки (необязательно)"></div>
          <div class="form-group" id="action-url-group"><input type="text" id="quest-action-url-input" placeholder="URL для перехода (необязательно)"></div>
          <div class="form-group" id="duration-days-group"><input type="number" id="quest-duration-days-input" placeholder="Длительность (дни, необязательно)"></div>
          <div class="form-group" id="category-select-group">
              <label for="quest-category-select">Категория:</label>
              <select id="quest-category-select"></select>
          </div>
          <div class="form-group">
              <label><input type="checkbox" id="quest-repeatable-input"> Многоразовое задание</label>
          </div>
          <div class="form-group"><button type="submit">Создать задание</button></div>
        </form>
      </div>
      <h2 class="section-title">Существующие задания</h2>
      <div id="quests-list"></div>
      <div id="quest-details-modal" class="loader-overlay hidden">
          <div class="glass-card" style="width: 90%; max-width: 400px;">
              <h3 style="margin-top:0;">Детали задания</h3>
              <div id="quest-details-content"></div>
              <button onclick="hideModal('quest-details-modal')" style="margin-top: 20px;">Закрыть</button>
          </div>
      </div>
    </div>

    <!-- View Промокоды -->
    <div class="view" id="view-promocodes">
      <h2 class="section-title">Добавить промокоды</h2>
      <div class="glass-card">
        <form id="add-promocodes-form">
          <div class="form-group"><textarea id="promocodes-input" rows="5" placeholder="Введите коды, каждый с новой строки"></textarea></div>
          <div class="form-group"><input type="number" id="promocode-value-input" placeholder="Количество билетов" min="1" required></div>
          <div class="form-group"><input type="text" id="promocode-description-input" placeholder="Описание (например, 'За ивент #1')" required></div>
          <div class="form-group"><button type="submit">Добавить промокоды</button></div>
        </form>
      </div>
    </div>

    <!-- View Категории -->
    <div class="view" id="view-categories">
        <h2 class="section-title">Управление категориями</h2>
        <div class="glass-card">
            <form id="create-category-form" class="form-group">
                <input type="text" id="new-category-name" placeholder="Название новой категории" required>
                <button type="submit" style="margin-top:10px;">Создать</button>
            </form>
        </div>
        <div id="categories-list" class="glass-card"></div>
    </div>

    <!-- View Челленджи -->
    <div class="view" id="view-challenges">
      <h2 class="section-title">Челленджи</h2>
      <div class="glass-card">
        <form id="create-challenge-form">
            <div class="form-group"><input type="text" id="challenge-description" placeholder="Описание челленджа" required></div>
            <div class="form-group">
                <label for="condition-type-select">Тип условия:</label>
                <select id="condition-type-select">
                    <option value="twitch_messages_session">Twitch: Сообщения (сессия)</option>
                    <option value="twitch_uptime_session">Twitch: Время просмотра (сессия)</option>
                    <option value="telegram_messages_session">Telegram: Сообщения</option>
                </select>
            </div>
            <div class="form-group"><input type="number" id="challenge-target-value" placeholder="Цель (например, 100)" required min="1"></div>
            <div class="form-group"><input type="number" id="challenge-duration-days" placeholder="Длительность (дни)" min="1" required></div>
            <div class="form-group"><input type="number" id="challenge-reward-amount" placeholder="Награда (билеты)" min="1" required></div>
            <div class="form-group">
                <label><input type="checkbox" id="challenge-is-active" checked> Активен</label>
            </div>
            <div class="form-group"><button type="submit">Создать челлендж</button></div>
        </form>
      </div>
      <h2 class="section-title">Список челленджей</h2>
      <div id="challenges-list"></div>
      
      <h2 class="section-title">Поиск челленджей пользователя</h2>
      <div class="glass-card">
        <div class="form-group"><input type="text" id="user-challenges-search-input" placeholder="ID пользователя Telegram" required></div>
        <div class="form-group"><button id="user-challenges-search-btn">Найти</button></div>
      </div>
      <div id="user-challenges-list"></div>
    </div>

    <!-- View Победители -->
    <div class="view" id="view-winners">
        <h2 class="section-title">Победители Ивентов</h2>
        <div id="winners-list">
            <p style="text-align: center; color: var(--text-color-muted);">
                Нажмите "Обновить" для загрузки списка победителей.
            </p>
        </div>
        <div class="form-group" style="margin-top: 20px;">
            <button id="refresh-winners-btn">Обновить список</button>
        </div>
    </div>

  </div>

  <div id="generic-prompt" class="loader-overlay hidden">
    <div class="glass-card" style="width: 90%; max-width: 350px;">
        <h3 id="prompt-title"></h3>
        <input type="text" id="generic-prompt-input" required>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button id="generic-prompt-cancel" style="background-color: #555;">Отмена</button>
            <button id="generic-prompt-confirm">Сохранить</button>
        </div>
    </div>
  </div>

  <script>
    try {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const dom = {
            loaderOverlay: document.getElementById('loader-overlay'),
            appContainer: document.getElementById('app-container'),
            tabs: document.querySelectorAll('.tab-bar button'),
            views: document.querySelectorAll('.view'),
            
            // Заявки
            submissionsList: document.getElementById('submissions-list'),
            pendingCount: document.getElementById('pending-count'),

            // Задания
            createQuestForm: document.getElementById('create-quest-form'),
            questTypeSelect: document.getElementById('quest-type-select'),
            targetValueGroup: document.getElementById('target-value-group'),
            iconUrlGroup: document.getElementById('icon-url-group'),
            actionUrlGroup: document.getElementById('action-url-group'),
            durationDaysGroup: document.getElementById('duration-days-group'),
            categorySelectGroup: document.getElementById('category-select-group'),
            questCategorySelect: document.getElementById('quest-category-select'),
            questsList: document.getElementById('quests-list'),
            questDetailsModal: document.getElementById('quest-details-modal'),
            questDetailsContent: document.getElementById('quest-details-content'),

            // Промокоды
            addPromocodesForm: document.getElementById('add-promocodes-form'),

            // Категории
            createCategoryForm: document.getElementById('create-category-form'),
            categoriesList: document.getElementById('categories-list'),
            genericPrompt: document.getElementById('generic-prompt'),
            genericPromptTitle: document.getElementById('prompt-title'),
            genericPromptInput: document.getElementById('generic-prompt-input'),
            genericPromptConfirm: document.getElementById('generic-prompt-confirm'),
            genericPromptCancel: document.getElementById('generic-prompt-cancel'),
            
            // Челленджи
            createChallengeForm: document.getElementById('create-challenge-form'),
            challengesList: document.getElementById('challenges-list'),
            userChallengesSearchInput: document.getElementById('user-challenges-search-input'),
            userChallengesSearchBtn: document.getElementById('user-challenges-search-btn'),
            userChallengesList: document.getElementById('user-challenges-list'),
            
            // Победители
            winnersList: document.getElementById('winners-list'),
            refreshWinnersBtn: document.getElementById('refresh-winners-btn'),
        };

        let currentEditingCategoryId = null;

        function showLoader() { dom.loaderOverlay.classList.remove('hidden'); }
        function hideLoader() { dom.loaderOverlay.classList.add('hidden'); }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function hideModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }

        async function makeApiRequest(url, body = {}, method = 'POST') {
            showLoader();
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (method !== 'GET') options.body = JSON.stringify({ ...body, initData: Telegram.WebApp.initData });
                const response = await fetch(url, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка сервера');
                }
                if (response.status === 204) return null;
                return await response.json();
            } catch (e) {
                Telegram.WebApp.showAlert(`Ошибка: ${e.message}`);
                throw e;
            } finally {
                hideLoader();
            }
        }
        
        async function fetchSubmissions() {
            try {
                const submissions = await makeApiRequest('/api/v1/admin/submissions');
                dom.submissionsList.innerHTML = '';
                dom.pendingCount.textContent = (submissions || []).length;
                if (!submissions || submissions.length === 0) {
                    dom.submissionsList.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">Нет новых заявок.</p>';
                    return;
                }

                submissions.forEach(sub => {
                    const card = document.createElement('div');
                    card.className = 'glass-card submission-card';
                    card.innerHTML = `
                        <div class="submission-header">
                            <div>
                                <div class="item-title">${sub.quest_title}</div>
                                <div class="item-subtitle">${sub.user_name || sub.user_id}</div>
                            </div>
                            <div class="item-actions">
                                <span class="item-subtitle" style="color: var(--status-pending-color); font-weight: 600;">На проверке</span>
                            </div>
                        </div>
                        <div class="submission-body">
                            ${sub.submitted_data}
                        </div>
                        <div class="submission-actions">
                            <button class="btn-approve" data-id="${sub.id}">Одобрить</button>
                            <button class="btn-reject" data-id="${sub.id}">Отклонить</button>
                        </div>
                    `;
                    dom.submissionsList.appendChild(card);
                });
            } catch (e) {
                console.error('Ошибка загрузки заявок:', e);
            }
        }
        
        async function fetchQuests() {
            try {
                const quests = await makeApiRequest('/api/v1/admin/quests/all');
                dom.questsList.innerHTML = '';
                if (!quests || quests.length === 0) {
                    dom.questsList.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">Нет созданных заданий.</p>';
                    return;
                }
                quests.forEach(q => {
                    const item = document.createElement('div');
                    item.className = 'glass-card list-item';
                    item.innerHTML = `
                        <div class="item-details">
                            <div class="item-title">
                                ${q.title} 
                                <span style="color: ${q.is_active ? 'var(--status-active-color)' : 'var(--status-inactive-color)'}; font-size: 10px;">• ${q.is_active ? 'Активен' : 'Неактивен'}</span>
                            </div>
                            <div class="item-subtitle">${q.quest_type} | ${q.reward_amount} билетов</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn-details" data-id="${q.id}">Детали</button>
                            <button class="btn-delete" data-id="${q.id}">Удалить</button>
                        </div>
                    `;
                    dom.questsList.appendChild(item);
                });
            } catch (e) {
                console.error('Ошибка загрузки заданий:', e);
            }
        }
        
        async function fetchAndRenderCategories() {
            try {
                const categories = await makeApiRequest('/api/v1/admin/categories');
                dom.categoriesList.innerHTML = '';
                dom.questCategorySelect.innerHTML = '<option value="">(Без категории)</option>';
                if (!categories || categories.length === 0) {
                    dom.categoriesList.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">Нет созданных категорий.</p>';
                    return;
                }
                categories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="item-details"><div class="item-title">${cat.name}</div></div>
                        <div class="item-actions">
                            <button class="btn-edit-category" data-id="${cat.id}" data-name="${cat.name}">Изменить</button>
                            <button class="btn-delete-category" data-id="${cat.id}">Удалить</button>
                        </div>
                    `;
                    dom.categoriesList.appendChild(item);
                    dom.questCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            } catch (e) {
                console.error('Ошибка загрузки категорий:', e);
            }
        }

        async function fetchAndRenderChallenges() {
            try {
                const challenges = await makeApiRequest('/api/v1/admin/challenges');
                dom.challengesList.innerHTML = '';
                if (!challenges || challenges.length === 0) {
                    dom.challengesList.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">Нет созданных челленджей.</p>';
                    return;
                }
                challenges.forEach(c => {
                    const item = document.createElement('div');
                    item.className = 'glass-card list-item';
                    item.innerHTML = `
                        <div class="item-details">
                            <div class="item-title">
                                ${c.description}
                                <span style="color: ${c.is_active ? 'var(--status-active-color)' : 'var(--status-inactive-color)'}; font-size: 10px;">• ${c.is_active ? 'Активен' : 'Неактивен'}</span>
                            </div>
                            <div class="item-subtitle">${c.condition_type} | ${c.reward_amount} билетов | ${c.duration_days} дней</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete-challenge" data-id="${c.id}">Удалить</button>
                        </div>
                    `;
                    dom.challengesList.appendChild(item);
                });
            } catch (e) {
                console.error('Ошибка загрузки челленджей:', e);
            }
        }
        
        // --- НОВАЯ ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ ПОБЕДИТЕЛЕЙ ---
        async function fetchAndRenderWinners() {
            try {
                dom.winnersList.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">Загрузка...</p>';
                const winners = await makeApiRequest('/api/v1/admin/events/winners');
                dom.winnersList.innerHTML = '';
                if (!winners || winners.length === 0) {
                    dom.winnersList.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">Победителей пока нет.</p>';
                    return;
                }

                winners.forEach(winner => {
                    const winnerCard = document.createElement('div');
                    winnerCard.className = 'winner-list-item';
                    winnerCard.innerHTML = `
                        <div class="winner-info">
                            <p>[ИМЯ] <span class="highlight">${winner.winner_name}</span></p>
                            <p>[ПРИЗ] <span class="highlight">${winner.prize_title}</span></p>
                            <p>[ОПИСАНИЕ] <span>${winner.prize_description || 'Описание не указано'}</span></p>
                            <p>[ТРЕЙД-ССЫЛКА] <span class="highlight">${winner.trade_link || 'Не указана'}</span></p>
                        </div>
                        <div class="winner-card-actions">
                            <!-- Предполагается, что в ответе API есть 'telegram_id' или 'username' -->
                            <button class="btn-message" 
                                onclick="openTelegramChat('${winner.telegram_id || winner.telegram_username}')">
                                <i class="fa-brands fa-telegram"></i> Написать пользователю
                            </button>
                            <a class="btn-trade" href="${winner.trade_link}" target="_blank">
                                <i class="fa-solid fa-gift"></i> Выдать скин
                            </a>
                        </div>
                    `;
                    dom.winnersList.appendChild(winnerCard);
                });
            } catch (e) {
                dom.winnersList.innerHTML = `<p style="text-align: center; color: var(--danger-color);">Не удалось загрузить победителей: ${e.message}</p>`;
                console.error('Ошибка загрузки победителей:', e);
            }
        }
        
        function setupEventListeners() {
            dom.tabs.forEach(button => {
                button.addEventListener('click', (e) => {
                    dom.tabs.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    const targetViewId = e.target.dataset.view;
                    dom.views.forEach(view => {
                        view.classList.remove('active');
                        if (view.id === targetViewId) view.classList.add('active');
                    });
                    
                    // Загрузка данных для активного View
                    if (targetViewId === 'view-submissions') fetchSubmissions();
                    else if (targetViewId === 'view-quests') fetchQuests();
                    else if (targetViewId === 'view-categories') fetchAndRenderCategories();
                    else if (targetViewId === 'view-challenges') fetchAndRenderChallenges();
                    else if (targetViewId === 'view-winners') fetchAndRenderWinners();
                });
            });

            dom.createQuestForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const questData = {
                    title: form['quest-title-input'].value,
                    description: form['quest-description-input'].value,
                    reward_amount: parseInt(form['quest-reward-input'].value),
                    quest_type: form['quest-type-select'].value,
                    target_value: parseInt(form['quest-target-value-input'].value) || 0,
                    icon_url: form['quest-icon-url-input'].value,
                    action_url: form['quest-action-url-input'].value,
                    duration_days: parseInt(form['quest-duration-days-input'].value) || null,
                    category_id: form['quest-category-select'].value ? parseInt(form['quest-category-select'].value) : null,
                    is_repeatable: form['quest-repeatable-input'].checked,
                };
                await makeApiRequest('/api/v1/admin/quests', questData);
                form.reset();
                fetchQuests();
            });

            dom.questTypeSelect.addEventListener('change', (e) => {
                const type = e.target.value;
                const isManual = type === 'manual_check';
                dom.targetValueGroup.style.display = isManual ? 'none' : 'block';
                dom.iconUrlGroup.style.display = isManual ? 'block' : 'none';
                dom.actionUrlGroup.style.display = isManual ? 'block' : 'none';
                dom.durationDaysGroup.style.display = isManual ? 'none' : 'block';
                dom.categorySelectGroup.style.display = isManual ? 'block' : 'none';
            });
            dom.questTypeSelect.dispatchEvent(new Event('change'));

            dom.questsList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = parseInt(target.dataset.id);

                if (target.classList.contains('btn-delete')) {
                    if (confirm('Вы уверены, что хотите удалить это задание и все связанные заявки?')) {
                        await makeApiRequest('/api/v1/admin/quest/delete', { quest_id: id });
                        fetchQuests();
                    }
                } else if (target.classList.contains('btn-details')) {
                    const questDetails = await makeApiRequest('/api/v1/admin/quest/details', { quest_id: id });
                    dom.questDetailsContent.innerHTML = `
                        <p><strong>Название:</strong> ${questDetails.title}</p>
                        <p><strong>Описание:</strong> ${questDetails.description || 'Нет'}</p>
                        <p><strong>Награда:</strong> ${questDetails.reward_amount} билетов</p>
                        <p><strong>Тип:</strong> ${questDetails.quest_type}</p>
                        <p><strong>Цель:</strong> ${questDetails.target_value || 'N/A'}</p>
                        <p><strong>Активен:</strong> ${questDetails.is_active ? 'Да' : 'Нет'}</p>
                        <p><strong>Повторяемый:</strong> ${questDetails.is_repeatable ? 'Да' : 'Нет'}</p>
                        <p><strong>Категория ID:</strong> ${questDetails.category_id || 'Нет'}</p>
                    `;
                    showModal('quest-details-modal');
                }
            });

            dom.submissionsList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = parseInt(target.dataset.id);
                const action = target.classList.contains('btn-approve') ? 'approved' : 'rejected';
                
                await makeApiRequest('/api/v1/admin/submission/update', {
                    submission_id: id,
                    action: action
                });
                
                showToast(action === 'approved' ? 'Заявка одобрена!' : 'Заявка отклонена!');
                fetchSubmissions();
            });

            dom.addPromocodesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const codes = form['promocodes-input'].value;
                const reward_value = parseInt(form['promocode-value-input'].value);
                const description = form['promocode-description-input'].value;
                await makeApiRequest('/api/v1/admin/promocodes', { codes, reward_value, description });
                form.reset();
            });
            
            dom.createCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = dom.newCategoryName.value.trim();
                if (name) {
                    await makeApiRequest('/api/v1/admin/categories/create', { name });
                    dom.newCategoryName.value = '';
                    fetchAndRenderCategories();
                }
            });

            dom.categoriesList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = parseInt(target.dataset.id);

                if (target.classList.contains('btn-edit-category')) {
                    currentEditingCategoryId = id;
                    dom.genericPromptTitle.textContent = 'Изменить название категории';
                    dom.genericPromptInput.value = target.dataset.name;
                    dom.genericPrompt.classList.remove('hidden');
                } else if (target.classList.contains('btn-delete-category')) {
                    if (confirm('Вы уверены, что хотите удалить эту категорию? Все задания в ней должны быть перемещены или удалены.')) {
                        await makeApiRequest('/api/v1/admin/categories/delete', { category_id: id });
                        fetchAndRenderCategories();
                    }
                }
            });

            dom.genericPromptConfirm.addEventListener('click', async () => {
                const newName = dom.genericPromptInput.value.trim();
                if (!newName || !currentEditingCategoryId) return;

                await makeApiRequest('/api/v1/admin/categories/update', {
                    category_id: parseInt(currentEditingCategoryId),
                    name: newName
                });
                
                hideModal('generic-prompt');
                await fetchAndRenderCategories();
            });
            dom.genericPromptCancel.addEventListener('click', () => hideModal('generic-prompt'));

            dom.createChallengeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const challengeData = {
                    description: form['challenge-description'].value,
                    condition_type: form['condition-type-select'].value,
                    target_value: parseInt(form['challenge-target-value'].value),
                    duration_days: parseInt(form['challenge-duration-days'].value),
                    reward_amount: parseInt(form['challenge-reward-amount'].value),
                    is_active: form['challenge-is-active'].checked,
                };
                await makeApiRequest('/api/v1/admin/challenges/create', challengeData);
                form.reset();
                fetchAndRenderChallenges();
            });
            
            dom.challengesList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = parseInt(target.dataset.id);
                if (target.classList.contains('btn-delete-challenge')) {
                    if (confirm('Вы уверены, что хотите удалить этот челлендж и все данные по нему?')) {
                        await makeApiRequest('/api/v1/admin/challenges/delete', { challenge_id: id });
                        fetchAndRenderChallenges();
                    }
                }
            });
            
            dom.userChallengesSearchBtn.addEventListener('click', async () => {
                const userId = dom.userChallengesSearchInput.value.trim();
                if (!userId) return;
                try {
                    const userChallenges = await makeApiRequest('/api/v1/admin/user_challenges', { user_id: userId });
                    dom.userChallengesList.innerHTML = '';
                    if (!userChallenges || userChallenges.length === 0) {
                        dom.userChallengesList.innerHTML = '<p style="text-align: center; color: var(--text-color-muted);">Челленджей для этого пользователя не найдено.</p>';
                        return;
                    }
                    userChallenges.forEach(uc => {
                        const card = document.createElement('div');
                        card.className = 'glass-card';
                        card.innerHTML = `
                            <div class="item-details">
                                <div class="item-title">${uc.challenges.description}</div>
                                <div class="item-subtitle">Прогресс: ${uc.progress_value} / ${uc.challenges.target_value}</div>
                                <div class="item-subtitle">Статус: ${uc.status}</div>
                                <div class="item-subtitle">Награда: ${uc.challenges.reward_amount}</div>
                            </div>
                        `;
                        dom.userChallengesList.appendChild(card);
                    });
                } catch (e) {
                    console.error('Ошибка поиска челленджей пользователя:', e);
                }
            });
            
            // --- НОВАЯ КНОПКА ДЛЯ ОБНОВЛЕНИЯ ПОБЕДИТЕЛЕЙ ---
            dom.refreshWinnersBtn.addEventListener('click', fetchAndRenderWinners);
        }

        async function main() {
            try {
                Telegram.WebApp.expand();
                if (!Telegram.WebApp.initData) throw new Error("Требуется авторизация в Telegram.");
                const userData = await makeApiRequest("/api/v1/user/me");
                if (!userData.is_admin) throw new Error("Доступ запрещен.");
                
                // Изначально активируем вкладку "Заявки" и загружаем её содержимое
                dom.views.forEach(view => view.classList.remove('active'));
                document.getElementById('view-submissions').classList.add('active');
                dom.tabs[0].classList.add('active');
                
                fetchSubmissions();

            } catch (e) {
                dom.appContainer.innerHTML = `<div style="padding:20px; text-align:center;"><h1>${e.message}</h1><p>Убедитесь, что вы являетесь администратором.</p></div>`;
            } finally {
                hideLoader();
            }
        }
        
        setupEventListeners();
        main();

        // Функция для открытия чата Telegram
        function openTelegramChat(userIdOrUsername) {
            if (!userIdOrUsername) {
                Telegram.WebApp.showAlert('Нет данных для связи с пользователем.');
                return;
            }
            // Формируем ссылку на основе ID или username
            const link = `https://t.me/user?id=${userIdOrUsername}`;
            Telegram.WebApp.openTelegramLink(link);
        }
    } catch (e) {
        console.error(`Критическая ошибка на старте: ${e.message}`);
        Telegram.WebApp.showAlert(`Критическая ошибка: ${e.message}`);
    }
  </script>
</body>
</html>
