<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Telegram Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="quest.css" />

<style>
    /* --- –ë–ê–ó–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–ò–∑ —Ç–≤–æ–µ–≥–æ –õ–∏–¥–µ—Ä–±–æ—Ä–¥–∞) --- */
    :root {
      --bg-color: #000000;
      --surface-color: #1c1c1e;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --tg-color: #0088cc;
      --twitch-color: #9146ff;
      --gold-glow: #ffd700;
      --accent-green: #34c759;
      --danger-color: #ff4757;
    }

    /* === –ì–õ–ê–í–ù–´–ô –§–ò–ö–° –°–ö–†–û–õ–õ–ê === */
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        position: fixed;
        overflow: hidden; 
        overscroll-behavior-y: none;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        user-select: none;
        -webkit-user-select: none;
    }

    /* === –ö–û–ù–¢–ï–ô–ù–ï–† –ö–û–ù–¢–ï–ù–¢–ê === */
    #main-content {
        height: 100vh; 
        overflow-y: auto !important; 
        -webkit-overflow-scrolling: touch; 
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        /* –û—Ç—Å—Ç—É–ø—ã –∫–∞–∫ –≤ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–µ + –º–µ—Å—Ç–æ –ø–æ–¥ —Ñ—É—Ç–µ—Ä */
        padding: 20px 15px 110px 15px; 
    }

    /* === –ö–†–£–¢–ò–õ–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø === */
    #pull-to-refresh {
        position: fixed; top: -80px; left: 0; width: 100%; height: 80px;
        display: flex; justify-content: center; align-items: center; 
        z-index: 2000; pointer-events: none; will-change: transform;
    }
    #pull-to-refresh i {
        font-size: 24px; color: var(--gold-glow);
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }

    /* --- –•–ï–î–ï–† –° –ö–ù–û–ü–ö–û–ô –ù–ê–ó–ê–î --- */
    .header-controls { 
        display: flex; align-items: center; margin-bottom: 20px; 
    }
    .back-btn {
        background: rgba(255, 255, 255, 0.1); border: none; color: var(--text-color);
        font-size: 14px; font-weight: 500; cursor: pointer; padding: 8px 16px; border-radius: 20px;
        display: flex; align-items: center; gap: 8px;
        transition: background 0.2s;
    }
    .back-btn:active { background: rgba(255, 255, 255, 0.2); }

    /* --- –û–ë–©–ï–ï –°–û–ë–´–¢–ò–ï (–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ quest.css, –Ω–æ –∫—Ä—É–ø–Ω–µ–µ) --- */
    .community-event-card {
        background-color: var(--surface-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        position: relative; overflow: hidden;
    }
    .community-event-card h3 { margin: 10px 0; font-size: 18px; color: #fff; }
    .event-badges { display: flex; justify-content: space-between; font-size: 11px; color: var(--tg-color); font-weight: 700; }
    
    /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É, –ø–æ—Ö–æ–∂—É—é –Ω–∞ quest.js –Ω–æ –¥–ª—è –æ–±—â–µ–≥–æ –∏–≤–µ–Ω—Ç–∞ */
    .comm-progress-track {
        background: rgba(0,0,0,0.4); height: 10px; border-radius: 5px;
        margin: 10px 0; position: relative; overflow: hidden;
    }
    .comm-progress-fill {
        background: linear-gradient(90deg, #0088cc, #00c6ff);
        height: 100%; width: 0%; transition: width 1s; border-radius: 5px;
    }
    .comm-info { font-size: 12px; color: #888; display: flex; justify-content: space-between; }

    /* --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –°–ï–ö–¶–ò–Ø (WRAPPER) --- */
    .personal-challenge-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
    }

    /* --- –°–û–°–¢–û–Ø–ù–ò–ï 1: –°–õ–ê–ô–î–ï–† (–í–´–ë–û–†) --- */
    .slider-display { margin-bottom: 20px; text-align: center; }
    .count-number {
        font-size: 72px; font-weight: 900; color: var(--tg-color);
        line-height: 1; letter-spacing: -2px;
        text-shadow: 0 0 30px rgba(0, 136, 204, 0.25);
    }
    .count-label { font-size: 14px; font-weight: 500; color: var(--text-color-muted); display: block; margin-top: 5px; }

    .range-container { width: 100%; padding: 0 10px; box-sizing: border-box; margin-bottom: 40px; }
    .custom-range {
        -webkit-appearance: none; width: 100%; height: 8px;
        background: #2c2c2e; border-radius: 4px; outline: none;
    }
    .custom-range::-webkit-slider-thumb {
        -webkit-appearance: none; width: 32px; height: 32px;
        background: var(--text-color); border-radius: 50%; cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 4px solid var(--tg-color);
        transition: transform 0.1s;
    }
    .custom-range::-webkit-slider-thumb:active { transform: scale(1.2); }

    .reward-calculation {
        background: rgba(255, 255, 255, 0.05); padding: 15px 25px; border-radius: 16px;
        border: 1px dashed rgba(255, 255, 255, 0.15); min-width: 180px; text-align: center;
    }
    .reward-calculation span { font-size: 11px; color: var(--text-color-muted); text-transform: uppercase; }
    .reward-value { font-size: 28px; font-weight: 800; margin-top: 5px; color: var(--gold-glow); }

    /* --- –°–û–°–¢–û–Ø–ù–ò–ï 2: –ê–ö–¢–ò–í–ù–´–ô –ö–í–ï–°–¢ (–°–¢–ò–õ–¨ QUEST.JS) --- */
    /* –ú—ã –±—É–¥–µ–º –∏–Ω–∂–µ–∫—Ç–∏—Ç—å —Å—é–¥–∞ HTML —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª–∞—Å—Å—ã –∏–∑ quest.css */
    #state-active { width: 100%; }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á—Ç–æ–±—ã –æ—Ç—Ü–µ–Ω—Ç—Ä–æ–≤–∞—Ç—å –∏ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É */
    .active-quest-large-view {
        transform: scale(1.1); /* –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ —á–µ–º –≤ —Å–ø–∏—Å–∫–µ */
        width: 100%;
        margin-top: 20px;
    }

    /* --- –ö–ù–û–ü–ö–ê –î–ï–ô–°–¢–í–ò–Ø --- */
    .action-area { width: 100%; margin-top: auto; padding-top: 30px; }
    .main-action-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--tg-color) 0%, #005f8f 100%);
        color: white; border: none; padding: 18px;
        font-size: 16px; font-weight: 700; border-radius: 16px;
        cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
        display: flex; justify-content: center; align-items: center; gap: 10px;
        box-shadow: 0 8px 25px rgba(0, 136, 204, 0.3);
        transition: transform 0.1s;
    }
    .main-action-btn:active { transform: scale(0.97); }
    .main-action-btn:disabled { background: #333; color: #666; box-shadow: none; }

    /* --- –§–£–¢–ï–† --- */
    .app-footer {
        display: flex; justify-content: space-around; align-items: center;
        background-color: rgba(28, 28, 30, 0.85); 
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: fixed; bottom: 0; left: 0; width: 100%; z-index: 9999;
        padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom));
        box-sizing: border-box; height: auto;
    }
    .footer-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        color: #8E8E93; text-decoration: none; flex: 1; cursor: pointer;
        background: transparent; border: none; padding: 0; margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-size: 10px; line-height: 1; font-weight: 500; transition: all 0.2s ease;
    }
    .footer-item .icon-wrapper {
        display: flex; justify-content: center; align-items: center;
        width: 24px; height: 24px; font-size: 22px; position: relative;
        transition: transform 0.2s ease, color 0.2s ease;
    }
    .footer-item.active { color: #FFFFFF; }
    .footer-item.active span { font-weight: 600; }
    .footer-item.active .icon-wrapper {
        color: var(--accent-green); transform: translateY(-2px);
        text-shadow: 0 0 12px rgba(52, 199, 89, 0.6);
    }
    .footer-item.active .icon-wrapper::before {
        content: ''; position: absolute; top: -8px; width: 20px; height: 2px;
        background-color: var(--accent-green); border-radius: 2px;
        box-shadow: 0 0 5px rgba(52, 199, 89, 0.8);
    }
</style>
</head>
<body>

  <main id="main-content">
    <div id="pull-to-refresh"><i class="fa-solid fa-rotate-right"></i></div>

    <div class="header-controls">
        <button class="back-btn" onclick="window.location.href='/quests'">
            <i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥
        </button>
    </div>

    <div class="community-event-card" id="community-card">
        <div class="event-header">
            <span class="event-badge">üî• –û–ë–©–ê–Ø –¶–ï–õ–¨</span>
            <span class="event-timer" id="event-timer">--:--</span>
        </div>
        <h3 id="event-title">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏—è...</h3>
        <div class="comm-progress-track">
            <div class="comm-progress-fill" id="community-fill"></div>
        </div>
        <div class="comm-info">
            <span id="community-text">0 / 0</span>
            <span id="event-reward-desc">üíé –ù–∞–≥—Ä–∞–¥–∞ –≤—Å–µ–º</span>
        </div>
    </div>

    <div class="personal-challenge-wrapper">
        
        <div id="state-selector" style="width: 100%;">
            <div style="text-align:center; margin-bottom:10px;">
                <h2 style="margin:0; font-size:20px;">–í–∞—à–∞ —Ü–µ–ª—å</h2>
                <p style="color:#888; font-size:12px; margin:5px 0 0;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é</p>
            </div>

            <div class="slider-display">
                <div class="count-number" id="msg-count-display">100</div>
                <span class="count-label">—Å–æ–æ–±—â–µ–Ω–∏–π</span>
            </div>

            <div class="range-container">
                <input type="range" min="10" max="500" value="100" step="10" class="custom-range" id="messageSlider">
            </div>

            <div class="reward-calculation">
                <span>–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
                <div class="reward-value">
                    +<span id="reward-amount-display">10</span> 
                    <i class="fa-solid fa-ticket"></i>
                </div>
            </div>
        </div>

        <div id="state-active" class="active-quest-large-view" style="display: none;">
            </div>

    </div>

    <div class="action-area">
        <button id="commit-btn" class="main-action-btn">
            –ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í
        </button>
    </div>

  </main> 

  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
        <span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span>
    </a>
    <a href="/quests" id="nav-quests" class="footer-item active">
        <div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div>
        <span>–ó–∞–¥–∞–Ω–∏—è</span>
    </a>
    <a href="/menu" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/events" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div>
        <span>–ì—Ä–∏–Ω–¥</span>
    </a>
    <a href="/auction" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
        <span>–ê—É–∫—Ü–∏–æ–Ω</span>
    </a>
  </footer>

<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (window.Telegram && window.Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      Telegram.WebApp.setHeaderColor('#000000'); 
      Telegram.WebApp.setBackgroundColor('#000000');
  }

  // DOM Elements
  const dom = {
    slider: document.getElementById('messageSlider'),
    countDisplay: document.getElementById('msg-count-display'),
    rewardDisplay: document.getElementById('reward-amount-display'),
    commitBtn: document.getElementById('commit-btn'),
    
    stateSelector: document.getElementById('state-selector'),
    stateActive: document.getElementById('state-active'),
    
    // Community
    commTitle: document.getElementById('event-title'),
    commFill: document.getElementById('community-fill'),
    commText: document.getElementById('community-text'),
    commTimer: document.getElementById('event-timer'),
    
    // Refresh
    mainContent: document.getElementById('main-content'),
    ptrContainer: document.getElementById('pull-to-refresh')
  };

  let availableTiers = []; // –ù–æ–º–∏–Ω–∞–ª—ã –∏–∑ –±–∞–∑—ã
  const REWARD_FACTOR = 0.1; 

  // 1. –õ–æ–≥–∏–∫–∞ –°–ª–∞–π–¥–µ—Ä–∞
  function calculateReward(val) {
      const theory = Math.floor(val * REWARD_FACTOR);
      if (theory < 1) return 1;
      if (!availableTiers.length) return theory; // –§–æ–ª–±–µ–∫

      let bestMatch = 0;
      for (let t of availableTiers) {
          if (t <= theory) bestMatch = t;
          else break;
      }
      return bestMatch > 0 ? bestMatch : availableTiers[0]; 
  }

  function updateSlider() {
      const val = parseInt(dom.slider.value);
      dom.countDisplay.textContent = val;
      const reward = calculateReward(val);
      dom.rewardDisplay.textContent = reward;
      
      // Haptic
      if (val % 50 === 0 && window.Telegram && Telegram.WebApp.HapticFeedback) {
           Telegram.WebApp.HapticFeedback.selectionChanged();
      }
  }

  dom.slider.addEventListener('input', updateSlider);

  // 2. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (1–≤1 –∫–∞–∫ –≤ quest.js)
  // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å—ã .quest-card, .progress-bar –∏ —Ç.–¥. –∏–∑ quest.css
  function generateQuestCardHTML(commitment) {
      const current = commitment.current_value;
      const target = commitment.target_value;
      const percent = Math.min(100, (current / target) * 100);
      const isCompleted = current >= target;
      
      const statusText = isCompleted 
        ? `<div style="color:#FFD700; margin-bottom:5px; font-weight:bold;">‚ú® –í—ã–ø–æ–ª–Ω–µ–Ω–æ!</div>` 
        : `<div style="color:#888; margin-bottom:5px;">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>`;

      // –≠—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –≤ quest.js –¥–ª—è –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å—Ç–∏–ª–µ–π
      return `
        <div class="quest-card" style="border: 1px solid var(--tg-color); box-shadow: 0 0 15px rgba(0,136,204,0.2);">
            ${statusText}
            <div class="quest-content-wrapper">
                <div class="quest-icon"><i class="fa-solid fa-person-running"></i></div>
                <h2 class="quest-title" style="font-size:18px;">–ú–æ–π –ß–µ–ª–ª–µ–Ω–¥–∂</h2>
                <p class="quest-subtitle">–ù–∞–ø–∏—Å–∞—Ç—å ${target} —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percent}%;"></div>
                    <div class="progress-content">
                        <span class="progress-text">üí¨ ${current} / ${target}</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:15px; text-align:right;">
                <span style="font-size:12px; color:#888;">–ù–∞–≥—Ä–∞–¥–∞: </span>
                <span style="font-weight:bold; color:#fff;">${commitment.reward_amount} <i class="fa-solid fa-ticket"></i></span>
            </div>
        </div>
      `;
  }

  // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  async function loadData() {
      dom.commitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
      dom.commitBtn.disabled = true;

      try {
          const res = await fetch('/api/v1/tg/challenge/status', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ initData: Telegram.WebApp.initData })
          });
          const data = await res.json();

          if (data.available_tiers) availableTiers = data.available_tiers;

          // –û–±–Ω–æ–≤–ª—è–µ–º Global Event
          if (data.has_active_event && data.event) {
             const ev = data.event;
             dom.commTitle.textContent = ev.title;
             const p = Math.min(100, (ev.current_global_progress / ev.global_goal) * 100);
             dom.commFill.style.width = `${p}%`;
             dom.commText.textContent = `${ev.current_global_progress.toLocaleString()} / ${ev.global_goal.toLocaleString()}`;
             
             // –ü—Ä–æ—Å—Ç–æ–π —Ç–∞–π–º–µ—Ä
             const end = new Date(ev.end_date);
             const now = new Date();
             const diff = end - now;
             const days = Math.floor(diff / (1000 * 60 * 60 * 24));
             const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
             dom.commTimer.textContent = `‚è≥ ${days}–¥ ${hours}—á`;

          } else {
             document.getElementById('community-card').innerHTML = '<p style="padding:10px; color:#666">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π</p>';
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —é–∑–µ—Ä–∞
          if (data.user_commitment) {
             renderActiveMode(data.user_commitment);
          } else {
             renderSelectorMode();
          }

      } catch (e) {
          console.error(e);
          dom.commitBtn.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
      }
  }

  // –†–ï–ñ–ò–ú 1: –í—ã–±–æ—Ä (–°–ª–∞–π–¥–µ—Ä)
  function renderSelectorMode() {
      dom.stateSelector.style.display = 'block';
      dom.stateActive.style.display = 'none';
      dom.commitBtn.disabled = false;
      dom.commitBtn.innerText = '–ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í';
      dom.commitBtn.onclick = commitChallenge;
      updateSlider();
  }

  // –†–ï–ñ–ò–ú 2: –ê–∫—Ç–∏–≤–Ω—ã–π (–ü—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ quest.js)
  function renderActiveMode(commitment) {
      dom.stateSelector.style.display = 'none';
      dom.stateActive.style.display = 'block';
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫—É, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç–∏–ª–∏ quest.css
      dom.stateActive.innerHTML = generateQuestCardHTML(commitment);

      // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏
      if (commitment.current_value >= commitment.target_value) {
          if (commitment.status === 'claimed') {
              dom.commitBtn.innerText = "‚úÖ –ù–ê–ì–†–ê–î–ê –ü–û–õ–£–ß–ï–ù–ê";
              dom.commitBtn.disabled = true;
              dom.commitBtn.style.background = "#2c2c2e";
          } else {
              dom.commitBtn.innerText = "üéÅ –ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£";
              dom.commitBtn.disabled = false;
              // –°—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é claim (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ –Ω–∞ –±—ç–∫–µ)
              dom.commitBtn.onclick = () => { Telegram.WebApp.showAlert("–ù–∞–≥—Ä–∞–¥–∞ –∑–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!"); };
          }
      } else {
          dom.commitBtn.innerText = "–í –ü–†–û–¶–ï–°–°–ï...";
          dom.commitBtn.disabled = true;
          dom.commitBtn.style.background = "#2c2c2e";
          dom.commitBtn.style.color = "#666";
      }
  }

  // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ "–ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤"
  async function commitChallenge() {
      const amount = parseInt(dom.slider.value);
      dom.commitBtn.disabled = true;
      dom.commitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

      try {
          if (window.Telegram && Telegram.WebApp.HapticFeedback) {
              Telegram.WebApp.HapticFeedback.notificationOccurred('success');
          }

          const res = await fetch('/api/v1/tg/challenge/commit', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ 
                  initData: Telegram.WebApp.initData,
                  amount: amount
              })
          });
          
          if (!res.ok) {
              const err = await res.json();
              throw new Error(err.detail || "–û—à–∏–±–∫–∞");
          }
          
          // –£—Å–ø–µ—Ö -> –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è —Å–º–µ–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
          window.location.reload();

      } catch (e) {
          Telegram.WebApp.showAlert(e.message);
          dom.commitBtn.disabled = false;
          dom.commitBtn.innerText = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
      }
  }

  // 5. Pull to Refresh (–¢–≤–æ–π –∫–æ–¥)
  function initPullToRefresh() {
      const content = dom.mainContent;
      const ptr = dom.ptrContainer;
      const icon = ptr.querySelector('i');
      let startY = 0; let pulled = 0; let isPulling = false;

      content.addEventListener('touchstart', (e) => {
          if (content.scrollTop <= 0) {
              startY = e.touches[0].clientY;
              isPulling = true;
              content.style.transition = ptr.style.transition = icon.style.transition = 'none';
          }
      }, {passive: true});

      content.addEventListener('touchmove', (e) => {
          if (!isPulling) return;
          const diff = e.touches[0].clientY - startY;
          if (diff > 0 && content.scrollTop <= 0) {
              if (e.cancelable) e.preventDefault();
              pulled = Math.pow(diff, 0.85);
              if (pulled > 180) pulled = 180;
              content.style.transform = `translateY(${pulled}px)`;
              ptr.style.transform = `translateY(${pulled}px)`;
              icon.style.transform = `rotate(${pulled * 2.5}deg)`;
              icon.style.color = pulled > 80 ? "#34c759" : "#FFD700";
          }
      }, {passive: false});

      content.addEventListener('touchend', () => {
          if (!isPulling) return;
          isPulling = false;
          content.style.transition = ptr.style.transition = 'transform 0.3s ease-out';
          if (pulled > 80) {
              content.style.transform = ptr.style.transform = `translateY(80px)`;
              icon.classList.add('fa-spin');
              setTimeout(() => window.location.reload(), 500);
          } else {
              content.style.transform = ptr.style.transform = 'translateY(0px)';
          }
          pulled = 0;
      });
  }

  // –ó–∞–ø—É—Å–∫
  loadData();
  initPullToRefresh();
</script>
</body>
</html>
