<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Admin Raffles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --bg: #0f0f0f;
            --card-bg: rgba(30, 30, 30, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --primary: #ffd700;
            --accent: #28a745;
            --danger: #ff4d4d;
            --text: #ffffff;
            --text-sec: #aaaaaa;
            --blur: 10px;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 20px;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
        }

        /* --- Header --- */
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { background: none; border: none; color: var(--text-sec); font-size: 16px; cursor: pointer; transition: 0.2s; }
        .back-btn:active { color: var(--text); transform: scale(0.95); }
        .page-title { font-size: 20px; font-weight: 800; margin: 0; background: linear-gradient(45deg, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .icon-btn { width: 36px; height: 36px; border-radius: 12px; background: rgba(255,255,255,0.1); border: 1px solid var(--card-border); color: var(--text); display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 14px; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* --- Tabs --- */
        .tabs { display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 14px; margin-bottom: 20px; gap: 5px; }
        .tab { flex: 1; border: none; background: none; color: var(--text-sec); padding: 10px; font-weight: 600; font-size: 13px; border-radius: 10px; transition: 0.3s; cursor: pointer; white-space: nowrap; text-align: center; }
        .tab.active { background: rgba(255,255,255,0.1); color: var(--text); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* --- Forms --- */
        .admin-form label { display: block; font-size: 12px; color: var(--text-sec); margin: 12px 0 5px; font-weight: 500; }
        .admin-form input, .admin-form select, .admin-form textarea {
            width: 100%; box-sizing: border-box; background: var(--card-bg); border: 1px solid var(--card-border);
            color: var(--text); padding: 12px; border-radius: 12px; font-size: 14px; outline: none; transition: 0.2s;
        }
        .admin-form input:focus, .admin-form textarea:focus { border-color: var(--primary); background: rgba(255,255,255,0.03); }
        
        .section-box { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .sec-title { font-size: 13px; color: var(--primary); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .cond-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Toggles */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; background: var(--card-bg); padding: 12px; border-radius: 12px; margin-top: 10px; border: 1px solid var(--card-border); }
        .toggle-switch { position: relative; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* --- Buttons Grid --- */
        .submit-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .action-submit-btn {
            border: none; padding: 15px; border-radius: 14px; font-weight: 700; font-size: 13px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
            transition: 0.2s; height: 80px; position: relative; overflow: hidden;
        }
        .action-submit-btn i { font-size: 18px; margin-bottom: 2px; }
        .action-submit-btn:active { transform: scale(0.97); opacity: 0.8; }

        .btn-instant { grid-column: 1 / -1; background: var(--primary); color: #000; font-size: 16px; }
        .btn-schedule { background: rgba(100, 181, 239, 0.15); color: #64b5ef; border: 1px solid rgba(100, 181, 239, 0.2); }
        .btn-silent { background: rgba(255, 255, 255, 0.05); color: var(--text-sec); border: 1px solid rgba(255, 255, 255, 0.1); }

        /* --- Preview --- */
        .preview-box { background: #182533; border-radius: 12px; padding: 12px; margin-top: 20px; border-left: 3px solid var(--primary); transition: 0.3s; }
        .prev-img { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; display: none; }
        .prev-img.show { display: block; }
        .prev-text { font-size: 13px; line-height: 1.4; white-space: pre-wrap; }
        .prev-btn { background: rgba(100, 181, 239, 0.15); color: #64b5ef; text-align: center; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-top: 10px; }

        /* --- Cards List --- */
        .raffle-card {
            background: var(--card-bg); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--card-border); border-radius: 16px; padding: 15px; margin-bottom: 15px;
            animation: slideUp 0.4s ease; position: relative;
        }
        .raffle-card.completed { opacity: 0.7; border-color: transparent; }
        .raffle-card.silent { border-left: 3px solid #64b5ef; }
        
        .card-header { display: flex; gap: 12px; margin-bottom: 12px; }
        .card-thumb { width: 50px; height: 50px; border-radius: 10px; background: #222; object-fit: cover; }
        .card-meta { flex: 1; }
        .card-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        
        .status-badge { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
        .st-active { background: rgba(40, 167, 69, 0.2); color: var(--accent); }
        .st-done { background: rgba(255, 255, 255, 0.1); color: var(--text-sec); }
        .st-silent { background: rgba(100, 181, 239, 0.2); color: #64b5ef; border: 1px solid rgba(100, 181, 239, 0.3); }
        
        .card-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .action-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; min-width: 100px; }
        .btn-parts { background: rgba(255,255,255,0.1); color: var(--text); }
        .btn-finish { background: rgba(255, 77, 77, 0.2); color: var(--danger); }
        .btn-copy { background: rgba(255, 215, 0, 0.15); color: var(--primary); }
        .btn-publish { background: rgba(50, 215, 75, 0.2); color: #32d74b; border: 1px solid rgba(50, 215, 75, 0.3); }

        /* --- Winner Box --- */
        .winner-section { border-top: 1px dashed rgba(255,255,255,0.1); margin-top: 10px; padding-top: 10px; }
        .winner-tag { font-size: 9px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .winner-name { font-weight: 700; font-size: 14px; margin: 2px 0 5px; }
        .trade-copy { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; font-size: 11px; color: var(--text-sec); display: flex; align-items: center; justify-content: space-between; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .trade-copy:active { border-color: var(--primary); background: rgba(255, 215, 0, 0.05); }

        /* --- Custom Modals --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.center { align-items: center; }
        .modal-active { display: flex; animation: fadeIn 0.2s; }
        
        .bottom-sheet { background: #1c1c1e; width: 100%; border-radius: 24px 24px 0 0; padding: 20px; max-height: 80vh; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .alert-box { background: #252525; width: 85%; padding: 20px; border-radius: 16px; text-align: center; border: 1px solid var(--card-border); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .part-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .part-ava { width: 36px; height: 36px; background: linear-gradient(135deg, #444, #222); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; font-size: 14px; position: relative; }
        .source-icon { position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #fff; border: 1px solid #222; }
        .src-tg { background: #229ED9; }
        .src-tw { background: #9146FF; }
        
        .alert-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .alert-msg { font-size: 14px; color: var(--text-sec); margin-bottom: 20px; }
        .alert-btn { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; }
        .alert-btn.cancel { background: transparent; color: var(--text-sec); margin-top: 5px; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="page-header">
        <button onclick="goBack()" class="back-btn"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="page-title">–ü–∞–Ω–µ–ª—å –†–æ–∑—ã–≥—Ä—ã—à–µ–π</h1>
        <a href="/raffles" class="icon-btn"><i class="fa-solid fa-eye"></i></a>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('create')">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
        <button class="tab" onclick="switchTab('list')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
        <button class="tab" onclick="switchTab('scheduled')">–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ</button>
    </div>

    <div id="tab-create" class="tab-content">
        <form id="create-form" class="admin-form">
            
            <div class="section-box">
                <h3 class="sec-title"><i class="fa-solid fa-gear"></i> –ú–µ—Ö–∞–Ω–∏–∫–∞</h3>
                <label>–¢–∏–ø –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</label>
                <select name="type" id="type-select">
                    <option value="inline_random">üé≤ –°–ª—É—á–∞–π–Ω–∞—è –∫–Ω–æ–ø–∫–∞</option>
                    <option value="most_active">üî• –¢–æ–ø –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (Twitch)</option>
                </select>

                <label>‚è∞ –ê–≤—Ç–æ-–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (–ú–°–ö)</label>
                <input type="datetime-local" name="end_time" required onchange="updatePreview()">
            </div>

            <div class="section-box">
                <h3 class="sec-title"><i class="fa-solid fa-list-check"></i> –£—Å–ª–æ–≤–∏—è –≤—Ö–æ–¥–∞</h3>
                
                <div class="toggle-row" style="margin-top:0; margin-bottom:15px;">
                    <span style="font-size: 13px;">üì¢ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</span>
                    <label class="toggle-switch">
                        <input type="checkbox" name="sub_req" checked onchange="updatePreview()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="cond-grid">
                    <div>
                        <label>üé´ –¶–µ–Ω–∞ (–ë–∏–ª–µ—Ç—ã)</label>
                        <input type="number" name="ticket_cost" placeholder="0" oninput="updatePreview()">
                    </div>
                    <div>
                        <label>üë• –î—Ä—É–∑–µ–π (–†–µ—Ñ)</label>
                        <input type="number" name="min_referrals" placeholder="0" oninput="updatePreview()">
                    </div>
                    <div>
                        <label>üí∞ –ë–∞–ª–∞–Ω—Å (–ú–æ–Ω–µ—Ç—ã)</label>
                        <input type="number" name="min_coins" placeholder="0" oninput="updatePreview()">
                    </div>
                    <div>
                        <label>üí¨ Twitch (–°–æ–æ–±—â.)</label>
                        <input type="number" name="min_msgs" placeholder="0" oninput="updatePreview()">
                    </div>
                </div>

                <label>üè∑ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ç–µ–≥ –≤ –Ω–∏–∫–µ</label>
                <input type="text" name="name_tag" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: HATE" oninput="updatePreview()">
            </div>
            
            <div class="section-box">
                <h3 class="sec-title"><i class="fa-solid fa-pen-fancy"></i> –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞</label>
                <input type="text" name="prize" id="inp-prize" placeholder="AWP | Asiimov" required oninput="updatePreview()">

                <label>–ö–∞—á–µ—Å—Ç–≤–æ (Wear)</label>
                <select name="quality" id="inp-quality" onchange="updatePreview()">
                    <option value="">–ë–µ–∑ –∫–∞—á–µ—Å—Ç–≤–∞</option>
                    <option value="FN">Factory New (–ü—Ä—è–º–æ —Å –∑–∞–≤–æ–¥–∞)</option>
                    <option value="MW">Minimal Wear (–ù–µ–º–Ω–æ–≥–æ –ø–æ–Ω–æ—à–µ–Ω–Ω–æ–µ)</option>
                    <option value="FT">Field-Tested (–ü–æ—Å–ª–µ –ø–æ–ª–µ–≤—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π)</option>
                    <option value="WW">Well-Worn (–ü–æ–Ω–æ—à–µ–Ω–Ω–æ–µ)</option>
                    <option value="BS">Battle-Scarred (–ó–∞–∫–∞–ª–µ–Ω–Ω–æ–µ –≤ –±–æ—è—Ö)</option>
                </select>

                <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –ø–æ—Å—Ç–∞ (URL)</label>
                <input type="text" name="image" id="inp-img" placeholder="https://..." oninput="updatePreview()">

                <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (PNG –±–µ–∑ —Ñ–æ–Ω–∞)</label>
                <input type="text" name="card_image" id="inp-card-img" placeholder="https://..." oninput="updatePreview()">

                <label>–†–µ–¥–∫–æ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç–∞ (–¶–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏)</label>
                <select name="rarity_color" id="inp-rarity-color" onchange="updatePreview()">
                    <option value="#b0c3d9">–®–∏—Ä–ø–æ—Ç—Ä–µ–± (–°–µ—Ä—ã–π)</option>
                    <option value="#5e98d9">–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ (–°–∏–Ω–∏–π)</option>
                    <option value="#4b69ff">–ê—Ä–º–µ–π—Å–∫–æ–µ (–§–∏–æ–ª–µ—Ç–æ–≤—ã–π)</option>
                    <option value="#8847ff">–ó–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ (–†–æ–∑–æ–≤—ã–π)</option>
                    <option value="#d32ce6">–ó–∞—Å–µ–∫—Ä–µ—á–µ–Ω–Ω–æ–µ (–ú–∞–ª–∏–Ω–æ–≤—ã–π)</option>
                    <option value="#eb4b4b">–¢–∞–π–Ω–æ–µ (–ö—Ä–∞—Å–Ω—ã–π)</option>
                    <option value="#ffd700">‚òÖ –ù–æ–∂ / –ü–µ—Ä—á–∞—Ç–∫–∏ (–ó–æ–ª–æ—Ç–æ–π)</option>
                </select>

                <label>–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
                <textarea name="desc" id="inp-desc" rows="3" placeholder="–î–æ–ø. —É—Å–ª–æ–≤–∏—è –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ..." oninput="updatePreview()"></textarea>
            </div>

            <div class="preview-box" id="preview-box">
                <div style="font-size: 10px; text-transform: uppercase; color: #777; margin-bottom: 5px;">Telegram Preview</div>
                <img src="" id="prev-img" class="prev-img">
                <div class="prev-text" id="prev-txt"></div>
                <div class="prev-btn">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å üé≤</div>
            </div>

            <div class="submit-actions">
                <button type="button" onclick="submitRaffle(false)" class="action-submit-btn btn-instant">
                    <i class="fa-solid fa-rocket"></i>
                    <span>–ó–ê–ü–£–°–¢–ò–¢–¨ –°–ï–ô–ß–ê–°</span>
                </button>

                <button type="button" onclick="submitRaffle(true)" class="action-submit-btn btn-schedule">
                    <i class="fa-regular fa-clock"></i>
                    <span>–í –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ</span>
                </button>

                <button type="button" onclick="submitRaffle(true)" class="action-submit-btn btn-silent">
                    <i class="fa-solid fa-ghost"></i>
                    <span>–¢–∏—Ö–∏–π (App only)</span>
                </button>
            </div>
        </form>
    </div>

    <div id="tab-list" class="tab-content hidden">
        <div id="list-container">
            <div style="text-align:center; padding: 40px; color: var(--text-sec);">
                <i class="fa-solid fa-circle-notch fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <div id="tab-scheduled" class="tab-content hidden">
        <div id="scheduled-container">
            <div style="text-align:center; padding: 40px; color: var(--text-sec);">
                <i class="fa-solid fa-circle-notch fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <div id="modal-parts" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-parts')">
        <div class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ <span id="parts-count" style="font-size:14px; opacity:0.5;"></span></h3>
                <button onclick="closeModal('modal-parts')" style="background:none; border:none; color:var(--text-sec); font-size:20px;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="parts-list" style="overflow-y:auto; flex:1;"></div>
        </div>
    </div>

    <div id="modal-alert" class="modal-overlay center">
        <div class="alert-box">
            <div class="alert-title" id="alert-title">Title</div>
            <div class="alert-msg" id="alert-msg">Message</div>
            <button class="alert-btn" id="alert-ok">OK</button>
            <button class="alert-btn cancel hidden" id="alert-cancel">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            if (document.getElementById('modal-parts').classList.contains('modal-active')) {
                closeModal('modal-parts'); return;
            }
            if (document.getElementById('modal-alert').classList.contains('modal-active')) {
                closeModal('modal-alert'); return;
            }
            window.location.href = '/admin';
        });

        function goBack() { window.location.href = '/admin'; }
        
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + t).classList.remove('hidden');
            
            const tabs = document.querySelectorAll('.tab');
            if(t === 'create') tabs[0].classList.add('active');
            else if(t === 'list') { tabs[1].classList.add('active'); loadRaffles(); }
            else if(t === 'scheduled') { tabs[2].classList.add('active'); loadRaffles(); }
        }

        function updatePreview() {
            const prize = document.getElementById('inp-prize').value || '–ü—Ä–∏–∑';
            const quality = document.getElementById('inp-quality').value;
            const desc = document.getElementById('inp-desc').value || '';
            const imgUrl = document.getElementById('inp-img').value;
            
            const tickets = document.querySelector('input[name="ticket_cost"]').value;
            const refs = document.querySelector('input[name="min_referrals"]').value;
            const coins = document.querySelector('input[name="min_coins"]').value;
            const tag = document.querySelector('input[name="name_tag"]').value;
            const msgs = document.querySelector('input[name="min_msgs"]').value;
            const sub = document.querySelector('input[name="sub_req"]').checked;
            
            const prizeFull = quality ? `${prize} (${quality})` : prize;
            let html = `üöÄ <b>–†–û–ó–´–ì–†–´–® –î–õ–Ø –ú–û–ò–• –ü–ê–¶–ê–ù–û–í</b>\n\n`;
            
            if (desc) html += `<i>{desc}</i>\n\n`;
            html += `üèÜ <b>–ü—Ä–∏–∑:</b> ${prizeFull}\n`;
            html += `\nüìå <b>–£—Å–ª–æ–≤–∏—è:</b>\n`;
            
            if(sub) html += `‚îî –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª\n`;
            if(tickets > 0) html += `‚îî –í—Ö–æ–¥: ${tickets} –±–∏–ª–µ—Ç–æ–≤ üé´\n`;
            if(refs > 0) html += `‚îî –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π: ${refs} üë•\n`;
            if(coins > 0) html += `‚îî –ë–∞–ª–∞–Ω—Å –≤ –±–æ—Ç–µ: ${coins} –º–æ–Ω–µ—Ç üí∞\n`;
            if(tag) html += `‚îî –ù–∏–∫–Ω–µ–π–º —Å–æ–¥–µ—Ä–∂–∏—Ç: ¬´${tag}¬ª üè∑\n`;
            if(msgs > 0) html += `‚îî –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∏–º–µ (${msgs} —Å–æ–æ–±—â.)\n`;

            const dateVal = document.querySelector('input[name="end_time"]').value;
            if (dateVal) {
                const d = new Date(dateVal);
                const dateStr = d.toLocaleDateString('ru-RU');
                const timeStr = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                html += `\n‚è≥ <b>–ò—Ç–æ–≥–∏:</b> ${dateStr} ${timeStr} (–ú–°–ö)\n`;
            }

            html += `\nüëá <b>–ñ–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!</b>`;

            const imgEl = document.getElementById('prev-img');
            if (imgUrl) { 
                imgEl.src = imgUrl; 
                imgEl.classList.add('show'); 
            } else { 
                imgEl.classList.remove('show'); 
            }

            document.getElementById('prev-txt').innerHTML = html.replace(/\n/g, '<br>');
        }

        async function submitRaffle(isSilentMode) {
            const form = document.getElementById('create-form');
            if(!form.reportValidity()) return;

            const fd = new FormData(form);
            
            const payload = {
                initData: tg.initData,
                title: fd.get('prize'),
                type: fd.get('type'),
                end_time: fd.get('end_time'),
                settings: {
                    prize_name: fd.get('prize'),
                    skin_quality: fd.get('quality'),
                    prize_image: fd.get('image'),
                    card_image: fd.get('card_image'),      // üî• –ù–û–í–û–ï
                    rarity_color: fd.get('rarity_color'),  // üî• –ù–û–í–û–ï
                    description: fd.get('desc'),
                    is_silent: isSilentMode,
                    requires_telegram_sub: fd.get('sub_req') === 'on',
                    ticket_cost: parseInt(fd.get('ticket_cost') || 0),
                    min_referrals: parseInt(fd.get('min_referrals') || 0),
                    min_coins: parseFloat(fd.get('min_coins') || 0),
                    required_name_tag: fd.get('name_tag'),
                    min_daily_messages: parseInt(fd.get('min_msgs') || 0)
                }
            };

            tg.MainButton.showProgress();

            try {
                const res = await fetch('/api/v1/admin/raffles/create', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    let msg = '–†–æ–∑—ã–≥—Ä—ã—à –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ –∫–∞–Ω–∞–ª–µ!';
                    if (isSilentMode) msg = '–†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω –≤ "–û—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö".';
                    showCustomAlert('–£—Å–ø–µ—Ö!', msg);
                    form.reset(); 
                    updatePreview(); 
                    switchTab(isSilentMode ? 'scheduled' : 'list'); 
                } else {
                    const err = await res.json();
                    tg.HapticFeedback.notificationOccurred('error');
                    showCustomAlert('–û—à–∏–±–∫–∞', err.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à');
                }
            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
                showCustomAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                tg.MainButton.hideProgress();
            }
        }

        async function loadRaffles() {
            try {
                const res = await fetch('/api/v1/admin/raffles/list', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: tg.initData})
                });
                const data = await res.json();
                renderList(data);
            } catch(e) { 
                console.error(e);
                document.getElementById('list-container').innerHTML = '<p style="text-align:center; color:#ff4d4d;">–û—à–∏–±–∫–∞</p>';
            }
        }

        function renderList(list) {
            const cActive = document.getElementById('list-container');
            const cSched = document.getElementById('scheduled-container');
            cActive.innerHTML = ''; cSched.innerHTML = '';
            
            let activeCount = 0; let schedCount = 0;

            list.forEach(r => {
                const s = r.settings || {};
                const isDone = r.status === 'completed';
                const isSilent = s.is_silent === true;
                const targetContainer = (isSilent && !isDone) ? cSched : cActive;
                
                if(targetContainer === cSched) schedCount++; else activeCount++;

                const img = s.prize_image ? `<img src="${s.prize_image}" class="card-thumb">` : `<div class="card-thumb" style="display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-gift"></i></div>`;
                const safeJson = encodeURIComponent(JSON.stringify(r));

                let statusBadge = '';
                if(isDone) statusBadge = `<span class="status-badge st-done">–ó–∞–≤–µ—Ä—à–µ–Ω</span>`;
                else if(isSilent) statusBadge = `<span class="status-badge st-silent"><i class="fa-solid fa-clock"></i> –û—Ç–ª–æ–∂–µ–Ω</span>`;
                else statusBadge = `<span class="status-badge st-active">–ê–∫—Ç–∏–≤–µ–Ω</span>`;

                let html = `
                <div class="raffle-card ${isDone ? 'completed' : ''} ${isSilent ? 'silent' : ''}">
                    <div class="card-header">
                        ${img}
                        <div class="card-meta">
                            <div class="card-title">${r.title}</div>
                            ${statusBadge}
                            ${!isDone && r.end_time ? `<span style="font-size:10px; color:var(--danger); margin-left:5px;">‚è≥ ${new Date(r.end_time).toLocaleString([], {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'})}</span>` : ''}
                        </div>
                    </div>
                    <div style="font-size:12px; color:var(--text-sec); margin-bottom:10px;">–ü—Ä–∏–∑: <span style="color:#fff;">${s.prize_name}</span></div>
                `;

                if(isDone && r.winner) {
                    html += `
                    <div class="winner-section">
                        <div class="winner-tag">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
                        <div class="winner-name">${r.winner.full_name}</div>
                        ${r.winner.trade_link ? 
                            `<div class="trade-copy" onclick="copyText('${r.winner.trade_link}')">
                                <span><i class="fa-solid fa-link"></i> –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–µ–π–¥</span>
                                <span style="color:var(--primary); font-weight:700;">COPY</span>
                             </div>` : `<div style="font-size:11px; color:#555;">–¢—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>`
                        }
                    </div>
                    <div class="card-actions">
                        <button onclick="cloneRaffle('${safeJson}', true)" class="action-btn btn-copy"><i class="fa-solid fa-copy"></i> –ö–æ–ø–∏—è</button>
                        <button onclick="showParts(${r.id})" class="action-btn btn-parts"><i class="fa-solid fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
                    </div>`;
                } else if(!isDone) {
                    html += `
                    <div class="card-actions">
                        <button onclick="finishRaffle(${r.id})" class="action-btn btn-finish"><i class="fa-solid fa-flag-checkered"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                        ${isSilent 
                            ? `<button onclick="cloneRaffle('${safeJson}', false)" class="action-btn btn-publish"><i class="fa-solid fa-paper-plane"></i> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>` 
                            : `<button onclick="cloneRaffle('${safeJson}', true)" class="action-btn btn-copy"><i class="fa-solid fa-copy"></i> –ö–æ–ø–∏—è</button>`
                        }
                        <button onclick="showParts(${r.id})" class="action-btn btn-parts"><i class="fa-solid fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
                    </div>`;
                }
                
                html += `</div>`;
                targetContainer.innerHTML += html;
            });
            
            if(!activeCount) cActive.innerHTML = '<div style="text-align:center; opacity:0.5; padding:40px;">–ê–∫—Ç–∏–≤–Ω—ã—Ö –Ω–µ—Ç</div>';
            if(!schedCount) cSched.innerHTML = '<div style="text-align:center; opacity:0.5; padding:40px;">–û—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –Ω–µ—Ç</div>';
        }

        window.cloneRaffle = function(jsonStr, makeSilent) {
            const r = JSON.parse(decodeURIComponent(jsonStr));
            const s = r.settings || {};

            switchTab('create');
            
            document.getElementById('type-select').value = r.type;
            document.getElementById('inp-prize').value = s.prize_name || '';
            document.getElementById('inp-quality').value = s.skin_quality || '';
            document.getElementById('inp-img').value = s.prize_image || '';
            document.getElementById('inp-card-img').value = s.card_image || ''; // üî• –ù–û–í–û–ï
            document.getElementById('inp-rarity-color').value = s.rarity_color || '#2481cc'; // üî• –ù–û–í–û–ï
            document.getElementById('inp-desc').value = s.description || '';
            
            document.querySelector('input[name="ticket_cost"]').value = s.ticket_cost || '';
            document.querySelector('input[name="min_referrals"]').value = s.min_referrals || '';
            document.querySelector('input[name="min_coins"]').value = s.min_coins || '';
            document.querySelector('input[name="name_tag"]').value = s.required_name_tag || '';
            document.querySelector('input[name="min_msgs"]').value = s.min_daily_messages || '';
            document.querySelector('input[name="sub_req"]').checked = s.requires_telegram_sub;
            
            tg.HapticFeedback.impactOccurred('medium');
            updatePreview();
        };

        async function finishRaffle(id) {
            showConfirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à?', '–ë–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.', async () => {
                try {
                    const res = await fetch('/api/v1/admin/raffles/draw', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({initData: tg.initData, raffle_id: id})
                    });
                    const d = await res.json();
                    if(res.ok) { showCustomAlert('–£—Å–ø–µ—Ö', d.message); loadRaffles(); }
                    else showCustomAlert('–û—à–∏–±–∫–∞', d.message);
                } catch(e) { showCustomAlert('–û—à–∏–±–∫–∞', '–°–±–æ–π —Å–µ—Ç–∏'); }
            });
        }

        async function showParts(id) {
            document.getElementById('modal-parts').classList.add('modal-active');
            const l = document.getElementById('parts-list');
            const cnt = document.getElementById('parts-count');
            l.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i></div>';
            
            try {
                const res = await fetch('/api/v1/admin/raffles/participants', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: tg.initData, raffle_id: id})
                });
                const users = await res.json();
                cnt.innerText = `(${users.length})`;
                l.innerHTML = '';
                if(!users.length) { l.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>'; return; }

                users.forEach(u => {
                    const usr = u.user || {}; 
                    const name = usr.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                    const username = usr.username ? `@${usr.username}` : '---';
                    const initial = name[0] || '?';
                    const source = u.source || 'telegram';
                    const sourceIcon = source === 'twitch' ? '<i class="fa-brands fa-twitch"></i>' : '<i class="fa-brands fa-telegram"></i>';
                    const sourceClass = source === 'twitch' ? 'src-tw' : 'src-tg';

                    l.innerHTML += `
                    <div class="part-item">
                        <div class="part-ava">
                            ${initial}
                            <div class="source-icon ${sourceClass}">${sourceIcon}</div>
                        </div>
                        <div>
                            <div style="font-weight:600; font-size:14px;">${name}</div>
                            <div style="font-size:12px; color:var(--text-sec);">${username}</div>
                        </div>
                    </div>`;
                });
            } catch(e) { l.innerHTML = '<div style="text-align:center; color:#ff4d4d; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
        }

        function copyText(txt) {
            navigator.clipboard.writeText(txt);
            tg.HapticFeedback.notificationOccurred('success');
            showCustomAlert('–ì–æ—Ç–æ–≤–æ', '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞.');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('modal-active'); }
        
        function showCustomAlert(title, msg) {
            const m = document.getElementById('modal-alert');
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            const okBtn = document.getElementById('alert-ok');
            const cBtn = document.getElementById('alert-cancel');
            cBtn.classList.add('hidden');
            okBtn.onclick = () => m.classList.remove('modal-active');
            m.classList.add('modal-active');
        }

        function showConfirm(title, msg, onYes) {
            const m = document.getElementById('modal-alert');
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            const okBtn = document.getElementById('alert-ok');
            const cBtn = document.getElementById('alert-cancel');
            cBtn.classList.remove('hidden');
            cBtn.onclick = () => m.classList.remove('modal-active');
            okBtn.onclick = () => { onYes(); m.classList.remove('modal-active'); };
            m.classList.add('modal-active');
        }

        updatePreview();
    </script>
</body>
</html>
