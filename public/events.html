<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ì—Ä–∏–Ω–¥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/fontawesome/css/all.min.css" />
  
  <style>
    :root {
      --background-main: #111111;
      --surface-primary: #1C1C1C;
      --surface-secondary: #2C2C2C;
      --border-color: #333333;
      --text-primary: #f0f0f5;
      --text-secondary: #AAAAAA;
      --accent-primary: #FFD700; /* –ó–æ–ª–æ—Ç–æ */
      --accent-secondary: #FF9500; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
      --card-bg-glass: rgba(28, 28, 28, 0.75);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-main);
      color: var(--text-primary);
      margin: 0;
      padding: 10px 10px 80px;
      overflow-x: hidden;
      background-image: url('https://i.postimg.cc/Dyks29xc/fon-variant1.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* –•–ï–î–ï–† */
    .new-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 20px; 
        padding: 5px 0;
    }

    .header-back-button {
        display: flex; align-items: center; gap: 6px;
        color: var(--text-secondary); text-decoration: none;
        font-size: 12px; font-weight: 600; position: relative; z-index: 2;
        transition: color 0.2s ease;
    }
    .header-back-button:hover { color: var(--text-primary); }

    .page-header {
        position: absolute; left: 0; right: 0; top: 50%;
        transform: translateY(-50%); text-align: center; z-index: 1;
    }
    .page-title {
        font-size: 18px; font-weight: 700; margin: 0;
        color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px;
    }

    /* –ö–ê–†–¢–û–ß–ö–ò */
    .glass-card {
        background-color: var(--card-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
    }

    /* –ë–ê–õ–ê–ù–°–´ */
    .balance-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .balance-item {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .balance-label {
        font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;
    }

    .balance-value {
        font-size: 16px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 6px;
        min-height: 20px;
    }
    
    .coin-icon { color: var(--accent-primary); text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
    .ticket-icon { color: #00f2ea; text-shadow: 0 0 10px rgba(0, 242, 234, 0.4); }

    /* –ì–†–ò–ù–î */
    .section-title {
        font-size: 13px; font-weight: 700; color: var(--text-primary); margin: 0 0 12px;
        display: flex; align-items: center; gap: 6px; text-transform: uppercase;
    }
    .section-title i { color: var(--accent-secondary); }

    .streak-wrapper {
        display: flex; justify-content: space-between; align-items: center;
        position: relative; margin: 20px 5px 25px;
    }

    .streak-line-bg {
        position: absolute; top: 50%; left: 0; right: 0; height: 2px;
        background: var(--border-color); transform: translateY(-50%); z-index: 0;
    }

    .streak-line-fill {
        position: absolute; top: 50%; left: 0; height: 2px;
        background: var(--accent-primary); transform: translateY(-50%); z-index: 1;
        width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px var(--accent-primary);
    }

    .streak-step {
        width: 24px; height: 24px; background: var(--surface-primary);
        border: 1px solid var(--border-color); border-radius: 50%; z-index: 2;
        display: flex; justify-content: center; align-items: center;
        font-size: 9px; color: var(--text-secondary); font-weight: 700; transition: all 0.3s ease;
    }

    .streak-step.active {
        border-color: var(--accent-primary); background: var(--background-main);
        color: var(--text-primary); transform: scale(1.2); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .streak-step.completed {
        background: var(--accent-primary); border-color: var(--accent-primary); color: #000;
    }

    .grind-info {
        text-align: center; font-size: 11px; color: var(--text-secondary); margin-bottom: 12px;
        background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;
    }
    .grind-info span { color: var(--accent-primary); font-weight: 700; }

    /* –ë—É—Å—Ç –ò–Ω—Ñ–æ */
    .boost-details {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed rgba(255,255,255,0.1);
        font-size: 10px;
        color: #34c759;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .boost-row { display: flex; justify-content: space-between; padding: 0 10px; }

    .main-action-btn {
        width: 100%; padding: 12px; background-color: var(--accent-primary);
        color: #000; font-size: 13px; font-weight: 700; border: none; border-radius: 6px;
        cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
        transition: transform 0.1s; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        position: relative; overflow: hidden;
    }
    .main-action-btn:active { transform: scale(0.98); }
    .main-action-btn:disabled {
        background-color: var(--surface-secondary); color: var(--text-secondary);
        cursor: not-allowed; box-shadow: none;
    }

    /* –ú–ê–ì–ê–ó–ò–ù */
    .open-shop-card {
        display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        transition: transform 0.2s; border-color: var(--accent-secondary);
    }
    .open-shop-card:active { transform: scale(0.98); }
    .shop-info-left { display: flex; align-items: center; gap: 12px; }
    .shop-icon-large { font-size: 24px; color: var(--accent-secondary); }
    .shop-text h4 { margin: 0; font-size: 13px; color: var(--text-primary); }
    .shop-text p { margin: 2px 0 0; font-size: 10px; color: var(--text-secondary); }
    .shop-arrow { color: var(--text-secondary); font-size: 12px; }

    /* –ú–û–î–ê–õ–ö–ê */
    .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    display: flex; /* –í–∫–ª—é—á–∞–µ–º Flexbox */
    align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    padding: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞–µ–≤ —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–æ */
    box-sizing: border-box; /* –£—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ —Ä–∞–∑–º–µ—Ä–µ */
}

.modal-overlay.visible {
    opacity: 1;
    pointer-events: all;
}

    .modal-content {
        background-color: var(--surface-primary); border: 1px solid var(--accent-primary);
        border-radius: 12px; width: 90%; max-width: 360px;
        box-shadow: 0 10px 40px rgba(255, 215, 0, 0.15);
        display: flex; flex-direction: column; position: relative;
        max-height: 85vh;
    }

    .modal-header {
        padding: 15px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        background: var(--surface-primary); border-radius: 12px 12px 0 0;
    }
    
    .shop-tabs { display: flex; gap: 10px; }
    .tab-btn {
        background: transparent; border: none; color: var(--text-secondary);
        font-size: 13px; font-weight: 600; padding: 5px 10px; cursor: pointer;
        border-radius: 6px; transition: all 0.2s; text-transform: uppercase;
    }
    .tab-btn.active { background: rgba(255, 215, 0, 0.1); color: var(--accent-primary); }

    .modal-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }
    .modal-body { padding: 15px; overflow-y: auto; }
    .shop-grid { display: flex; flex-direction: column; gap: 10px; min-height: 150px; }

    .exchange-item {
        background-color: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-color);
        border-radius: 6px; padding: 10px; display: flex; justify-content: space-between; align-items: center;
    }
    .exchange-details { display: flex; flex-direction: column; gap: 2px; }
    .exchange-title { font-size: 12px; color: var(--text-primary); font-weight: 600; }
    .exchange-cost { font-size: 10px; color: var(--accent-primary); }
    
    .mini-btn {
        background: transparent; border: 1px solid var(--accent-primary); color: var(--accent-primary);
        padding: 6px 12px; font-size: 10px; font-weight: 600; border-radius: 4px;
        text-transform: uppercase; cursor: pointer; transition: all 0.2s;
    }
    .mini-btn:hover { background: var(--accent-primary); color: #000; }
    .mini-btn:disabled { border-color: var(--border-color); color: var(--text-secondary); pointer-events: none; opacity: 0.5; }

    /* –ë–ï–°–ü–õ–ê–¢–ù–´–ô –ë–ò–õ–ï–¢ */
    .free-ticket-section {
        border: 1px dashed var(--text-secondary); padding: 12px; border-radius: 8px;
        display: flex; justify-content: space-between; align-items: center;
        margin-top: 10px; background: rgba(255,255,255,0.02);
    }
    .free-ticket-text { font-size: 11px; color: var(--text-secondary); }
    .free-ticket-title { font-size: 12px; font-weight: 700; color: #fff; display: block; margin-bottom: 2px; }

    /* FOOTER */
    .app-footer {
        display: flex; justify-content: space-around; align-items: center;
        background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: fixed; bottom: 0; left: 0; width: 100%; z-index: 9999;
        padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom));
        box-sizing: border-box;
    }
    .footer-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        color: #8E8E93; text-decoration: none; flex: 1; cursor: pointer;
        background: transparent; border: none; padding: 0; margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 10px; line-height: 1; font-weight: 500;
    }
    .footer-item .icon-wrapper {
        display: flex; justify-content: center; align-items: center; width: 24px; height: 24px;
        font-size: 22px; position: relative; transition: transform 0.2s ease, color 0.2s ease;
    }
    .footer-item.active { color: #FFFFFF; }
    .footer-item.active .icon-wrapper {
        color: #34c759; transform: translateY(-2px); text-shadow: 0 0 12px rgba(52, 199, 89, 0.6);
    }
    .footer-item.active .icon-wrapper::before {
        content: ''; position: absolute; top: -8px; width: 20px; height: 2px;
        background-color: #34c759; border-radius: 2px; box-shadow: 0 0 5px rgba(52, 199, 89, 0.8);
    }

    .shine {
        position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 3s infinite;
    }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
    
    .float-anim {
        animation: floatUp 1s ease-out forwards;
        position: absolute; font-weight: 800; font-size: 16px; pointer-events: none; z-index: 100;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

    /* --- –°–¢–ò–õ–ò –î–õ–Ø SUCCESS –ú–û–î–ê–õ–ö–ò --- */
.success-modal-content {
    background: linear-gradient(160deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid var(--accent-primary);
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
    text-align: center;
    padding: 30px 20px;
    width: 85%;
    max-width: 320px;
    border-radius: 16px;
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.modal-overlay.visible .success-modal-content {
    transform: scale(1);
}

.success-icon-box {
    width: 70px;
    height: 70px;
    margin: 0 auto 20px;
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid var(--accent-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    position: relative;
}

.success-icon-box i {
    font-size: 32px;
    color: var(--accent-primary);
    animation: popIn 0.5s ease;
}

@keyframes popIn {
    0% { transform: scale(0); opacity: 0; }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
}

.success-title-text {
    font-size: 22px;
    font-weight: 800;
    color: #fff;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.success-desc-text {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 20px;
    line-height: 1.5;
}

/* –ë–ª–æ–∫ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) */
.promo-copy-box {
    background: rgba(0, 0, 0, 0.3);
    border: 1px dashed var(--accent-secondary);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 25px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.promo-label {
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text-secondary);
}

.promo-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-primary);
    font-family: monospace;
    user-select: text; /* –ß—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–¥–µ–ª–∏—Ç—å */
    cursor: pointer;
}

.btn-close-success {
    background: var(--accent-primary);
    color: #000;
    border: none;
    font-weight: 700;
    padding: 12px 0;
    width: 100%;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    text-transform: uppercase;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.25);
    transition: transform 0.1s;
}

.btn-close-success:active {
    transform: scale(0.96);
}
    /* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò "–ì–î–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨" –ò –ü–û–ü–ê–ü–ê –ò–ù–°–¢–†–£–ö–¶–ò–ò --- */

/* –ö–Ω–æ–ø–∫–∞ (–∫–æ–ø–∏—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è) */
.reward-how-to-use-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background-color: rgba(255, 255, 255, 0.08);
    color: #007aff; /* Action color */
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    padding: 8px 10px;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.15s ease;
    text-decoration: none;
    margin-top: 5px;
    margin-bottom: 15px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –≤ –º–æ–¥–∞–ª–∫–µ */
    width: 100%; /* –ù–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤ –º–æ–¥–∞–ª–∫–µ */
}
.reward-how-to-use-btn i {
    font-size: 13px;
}
.reward-how-to-use-btn:hover {
    background-color: rgba(255, 255, 255, 0.15);
}
.reward-how-to-use-btn:active {
    transform: scale(0.96);
}

/* –°—Ç–∏–ª–∏ –ø–æ–ø–∞–ø–∞ "–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å" (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ events.html) */
.custom-popup {
    background-color: #1c1c1e;
    border-radius: 14px;
    padding: 20px;
    width: 100%; 
    max-width: 340px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
    border: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
    position: relative;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    transform: scale(0.95);
    transition: transform 0.2s;
    
    /* üî• –ì–õ–ê–í–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø üî• */
    display: flex;
    flex-direction: column;
    max-height: 85vh; /* –í—ã—Å–æ—Ç–∞ –Ω–µ –±–æ–ª—å—à–µ 85% –æ—Ç —ç–∫—Ä–∞–Ω–∞ */
    overflow-y: auto; /* –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
}
.modal-overlay.visible .custom-popup {
    transform: scale(1);
}
.custom-popup h3 { margin: 0 0 10px 0; font-size: 18px; font-weight: 600; color: #fff; }
.custom-popup p { margin: 0 0 15px 0; font-size: 14px; color: #b0b0b0; line-height: 1.4; }

/* –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ø–∞–ø–∞ */
.popup-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
.popup-btn { 
    width: 100%; border: none; padding: 12px; border-radius: 10px; 
    font-size: 16px; font-weight: 600; cursor: pointer; 
    display: flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
}
.popup-btn.primary { background-color: #34c759; color: white; } /* Green */
.popup-btn.secondary { background-color: #3a3a3c; color: white; }

/* –¢–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ" */
.saved-in-profile-text {
    font-size: 11px;
    color: #888;
    margin-bottom: 5px;
    display: block;
}
/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏/–≥–∏—Ñ–∫–∏ */
.custom-popup img {
    max-width: 100%; /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –≤—ã–ª–µ–∑–µ—Ç –∑–∞ —à–∏—Ä–∏–Ω—É */
    height: auto;    /* –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è */
    max-height: 40vh; /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–π–º–µ—Ç –±–æ–ª—å—à–µ 40% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞ */
    object-fit: contain;
    border-radius: 10px;
    margin: 10px 0;
}
.custom-popup h3 { 
    margin: 0 0 10px 0; 
    font-size: 18px; 
    font-weight: 600; 
    color: #fff;
    flex-shrink: 0; /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
}

.custom-popup p { 
    margin: 0 0 10px 0; 
    font-size: 14px; 
    color: #b0b0b0; 
    line-height: 1.4;
    flex-shrink: 0; 
}

/* –ö–Ω–æ–ø–∫–∏ */
.popup-actions { 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    margin-top: 10px; 
    flex-shrink: 0; /* –ö–Ω–æ–ø–∫–∏ –Ω–µ —Å–∂–∏–º–∞—é—Ç—Å—è –∏ –Ω–µ –∏—Å—á–µ–∑–∞—é—Ç */
}

  </style>
</head>
<body>

  <div class="new-header-container">
    <a href="/menu" class="header-back-button">
        <i class="fa-solid fa-chevron-left"></i> –ù–∞–∑–∞–¥
    </a>
    <div class="page-header">
        <h1 class="page-title">–ì—Ä–∏–Ω–¥</h1>
    </div>
    <div style="width: 40px;"></div>
  </div>

  <div class="balance-grid">
    <div class="balance-item">
        <span class="balance-label">–ì—Ä–∏–Ω–¥-–º–æ–Ω–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-coins">...</span> <i class="fa-solid fa-coins coin-icon"></i>
        </div>
    </div>
    <div class="balance-item">
        <span class="balance-label">–ë–∏–ª–µ—Ç—ã</span>
        <div class="balance-value">
            <span id="user-tickets">...</span> <i class="fa-solid fa-ticket ticket-icon"></i>
        </div>
    </div>
  </div>

  <div class="glass-card">
    <div class="section-title"><i class="fa-solid fa-fire"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –°–µ—Ä–∏—è</div>
    
    <div class="streak-wrapper">
        <div class="streak-line-bg"></div>
        <div class="streak-line-fill" id="streak-bar"></div>
        <div id="streak-steps" style="display: flex; justify-content: space-between; width: 100%; position: relative;"></div>
    </div>

    <div class="grind-info">
        –î–µ–Ω—å —Å–µ—Ä–∏–∏: <span id="current-streak-day">1</span> / 10 <br>
        –ù–∞–≥—Ä–∞–¥–∞ —Å–µ–≥–æ–¥–Ω—è: <span id="today-reward">+0.1</span>
        
        <div id="boost-container" class="boost-details" style="display: none;">
            </div>
    </div>

    <button id="grind-btn" class="main-action-btn" disabled>
        <span id="grind-btn-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <div class="shine"></div>
    </button>
  </div>

  <div class="glass-card open-shop-card" onclick="openShopModal()">
    <div class="shop-info-left">
        <i class="fa-solid fa-shop shop-icon-large"></i>
        <div class="shop-text">
            <h4>–û–±–º–µ–Ω–Ω–∏–∫ –≥—Ä–∏–Ω–¥ –º–æ–Ω–µ—Ç (–º–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥)</h4>
            <p>–û–±–º–µ–Ω –≥—Ä–∏–Ω–¥ –º–æ–Ω–µ—Ç –Ω–∞ –±–∏–ª–µ—Ç—ã –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã</p>
        </div>
    </div>
    <div class="shop-arrow"><i class="fa-solid fa-chevron-right"></i></div>
  </div>

  <div class="free-ticket-section">
    <div>
        <span class="free-ticket-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–∏–ª–µ—Ç</span>
        <span class="free-ticket-text" id="ticket-subtitle">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ 24—á</span>
    </div>
    <div id="free-ticket-container"></div>
  </div>

  <div id="shop-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="shop-tabs">
                <button class="tab-btn active" id="tab-tickets" onclick="switchTab('tickets')">–ë–∏–ª–µ—Ç—ã</button>
                <button class="tab-btn" id="tab-promos" onclick="switchTab('promos')">–ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
            </div>
            <button class="modal-close-btn" onclick="closeShopModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="shop-grid" id="shop-container"></div>
        </div>
    </div>
  </div>

  <div id="success-modal" class="modal-overlay">
    <div class="success-modal-content">
        <div class="success-icon-box">
            <i class="fa-solid fa-check"></i>
        </div>
        <div class="success-title-text">–£—Å–ø–µ—à–Ω–æ!</div>
        <div class="success-desc-text" id="success-message">
            –ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–≥—Ä–∞–¥–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å.
        </div>
        
        <div id="success-promo-container" class="promo-copy-box" style="display: none;">
            <span class="promo-label">–í–∞—à –∫–æ–¥ (–Ω–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å):</span>
            <span class="promo-value" id="success-promo-code" onclick="copyPromo(this)">CODE123</span>
        </div>

        <div id="promo-instruction-block" style="display: none;">
            <span class="saved-in-profile-text">
                <i class="fa-solid fa-floppy-disk"></i> –ö–æ–¥ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ
            </span>
            <button class="reward-how-to-use-btn" onclick="openHowToUsePopup()">
                <i class="fa-solid fa-circle-question"></i> –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?
            </button>
        </div>
        <button class="btn-close-success" onclick="closeSuccessModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
        <span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span>
    </a>
    <a href="/menu#quests" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div>
        <span>–ó–∞–¥–∞–Ω–∏—è</span>
    </a>
    <a href="/menu" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/events" class="footer-item active">
        <div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div>
        <span>–ì—Ä–∏–Ω–¥</span>
    </a>
    <a href="/auction" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
        <span>–ê—É–∫—Ü–∏–æ–Ω</span>
    </a>
</footer>

<div id="how-to-use-popup" class="modal-overlay">
    <div class="custom-popup">
        <h3>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥?</h3>
        <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤ –±–æ—Ç–µ.</p>
        
        <img src="https://i.postimg.cc/k4WyP04y/IMG-9212.gif" alt="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è">
        
        <div class="popup-actions">
            <a href="https://t.me/HATElavka_bot" class="popup-btn primary">
                <i class="fa-brands fa-telegram"></i> –û—Ç–∫—Ä—ã—Ç—å HATElavka
            </a>
            <button onclick="closeHowToUsePopup()" class="popup-btn secondary">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
</div>
</footer>

<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –§–£–ù–ö–¶–ò–ò (–î–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–≥–¥–∞) ---
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    window.copyPromo = function(element) {
        // –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ ID, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π 'this'
        const codeElement = document.getElementById('success-promo-code');
        if (!codeElement) return;

        const codeToCopy = codeElement.innerText.trim(); // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(codeToCopy)
                .then(() => {
                    tg.showPopup({ message: '–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!' });
                    // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                    codeElement.style.opacity = '0.5';
                    setTimeout(() => codeElement.style.opacity = '1', 200);
                })
                .catch(err => {
                    // –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π (—Ñ–æ–ª–ª–±—ç–∫)
                    fallbackCopyTextToClipboard(codeToCopy);
                });
        } else {
            fallbackCopyTextToClipboard(codeToCopy);
        }
    };

    // –°—Ç–∞—Ä—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; 
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            tg.showPopup({ message: '–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!' });
        } catch (err) {
            tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
        }
        document.body.removeChild(textArea);
    }

    // 2. –§—É–Ω–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–æ–Ω (–Ø–≤–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ window)
    window.closeSuccessModal = function() {
        document.getElementById('success-modal').classList.remove('visible');
    };

    window.openHowToUsePopup = function() {
        // –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —É—Å–ø–µ—Ö–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        // document.getElementById('success-modal').classList.remove('visible');
        document.getElementById('how-to-use-popup').classList.add('visible');
    };

    window.closeHowToUsePopup = function() {
        document.getElementById('how-to-use-popup').classList.remove('visible');
    };

    window.openShopModal = async function() {
        document.getElementById('shop-modal').classList.add('visible');
        document.getElementById('shop-container').innerHTML = '<div style="text-align:center; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        await fetchShopItems(); 
        renderShopList();
    };

    window.closeShopModal = function() {
        document.getElementById('shop-modal').classList.remove('visible');
    };

    window.switchTab = function(tab) {
        currentTab = tab;
        document.getElementById('tab-tickets').classList.toggle('active', tab === 'tickets');
        document.getElementById('tab-promos').classList.toggle('active', tab === 'promos');
        renderShopList();
    };

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ---
    let userState = {
        coins: 0.0,
        tickets: 0,
        streakDays: 1,
        lastGrindTime: null, 
        lastFreeTicket: null,
        active_referrals_count: 0,
        referral_activated_at: null,
        twitch_status: null
    };

    let grindSettings = { 
        twitch_status_boost_coins: 0.5,
        twitch_status_free_tickets: 5,
        ref_boost_coins_per_user: 0.1
    };

    let shopItems = [];
    let currentTab = 'tickets';
    const MAX_STREAK = 10;
    const GRIND_COOLDOWN = 24 * 60 * 60 * 1000;

    // –°—Å—ã–ª–∫–∏ –Ω–∞ DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const dom = {
        coinsDisplay: document.getElementById('user-coins'),
        ticketsDisplay: document.getElementById('user-tickets'),
        streakBar: document.getElementById('streak-bar'),
        streakSteps: document.getElementById('streak-steps'),
        streakDayDisplay: document.getElementById('current-streak-day'),
        todayRewardDisplay: document.getElementById('today-reward'),
        boostContainer: document.getElementById('boost-container'),
        grindBtn: document.getElementById('grind-btn'),
        grindBtnText: document.getElementById('grind-btn-text'),
        freeTicketContainer: document.getElementById('free-ticket-container'),
        ticketSubtitle: document.getElementById('ticket-subtitle'),
        shopContainer: document.getElementById('shop-container'),
      userStatus: document.querySelector('.user-status') || document.querySelector('.status-badge'),
    };

    // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
    document.addEventListener('DOMContentLoaded', function() {
        init();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ì–†–ò–ù–î
        if(dom.grindBtn) {
            dom.grindBtn.addEventListener('click', async () => {
                if (dom.grindBtn.disabled) return;
                tg.HapticFeedback.impactOccurred('medium');
                dom.grindBtn.disabled = true;

                try {
                    const response = await fetch('/api/v1/user/grind/claim', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || "–û—à–∏–±–∫–∞");
                    }

                    const res = await response.json();
                    
                    const claimed = parseFloat(res.reward_claimed).toFixed(2);
                    showFloatText(dom.grindBtn, `+${claimed}`, 'var(--accent-primary)');
                    
                    userState.coins = parseFloat(res.new_coins);
                    userState.streakDays = res.streak_days;
                    userState.lastGrindTime = res.last_grind_at;

                    updateUI();
                    renderStreakVisuals();

                } catch (e) {
                    tg.showAlert(e.message);
                    dom.grindBtn.disabled = false;
                }
            });
        }
    });

    async function init() {
        try {
            const response = await fetch('/api/v1/user/me', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            if (response.ok) {
                const data = await response.json();
                userState.tickets = data.tickets || 0;
                userState.coins = parseFloat(data.coins || 0);
                userState.streakDays = data.streak_days || 1;
                userState.lastGrindTime = data.last_grind_at;
                userState.lastFreeTicket = data.last_free_ticket_claimed_at;
                userState.active_referrals_count = data.active_referrals_count || 0;
                userState.referral_activated_at = data.referral_activated_at;
                userState.twitch_status = data.twitch_status;
                
                if (data.grind_settings) {
                    grindSettings = data.grind_settings;
                }
                
                updateUI();
                renderStreakVisuals();
                startTimers();
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            if(dom.coinsDisplay) dom.coinsDisplay.textContent = "0.0";
        }
    }

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function isTwitchBoostActive() {
        return userState.twitch_status === 'vip' || userState.twitch_status === 'subscriber';
    }

    function isVipActive() {
        if (!userState.referral_activated_at) return false;
        const activatedTime = new Date(userState.referral_activated_at).getTime();
        const now = new Date().getTime();
        return (now - activatedTime) < (7 * 24 * 60 * 60 * 1000);
    }

    function calculateBoosts() {
        let baseReward = (userState.streakDays * 0.1);
        if (baseReward > 1.0) baseReward = 1.0;
        
        let totalBonus = 0;
        let boostsHTML = "";
        
        if (userState.active_referrals_count > 0) {
            const refBoost = userState.active_referrals_count * 0.1;
            totalBonus += refBoost;
            boostsHTML += `<div class="boost-row"><span>üöÄ –î—Ä—É–∑—å—è (${userState.active_referrals_count}):</span><span class="boost-active">+${refBoost.toFixed(1)}</span></div>`;
        }
        
        if (isVipActive()) {
            totalBonus += 0.2;
            boostsHTML += `<div class="boost-row"><span class="boost-vip">‚ö° VIP:</span><span class="boost-vip">+0.2</span></div>`;
        }
      
        if (isTwitchBoostActive()) {
            const statusCoins = grindSettings.twitch_status_boost_coins;
            totalBonus += statusCoins;
            const statusLabel = userState.twitch_status === 'vip' ? 'üëë VIP Twitch' : '‚≠ê Sub Twitch';
            boostsHTML += `<div class="boost-row"><span class="boost-vip">${statusLabel}:</span><span class="boost-vip">+${statusCoins.toFixed(1)}</span></div>`;
        }
        
        return { totalBonus, boostsHTML, baseReward };
    }

    function updateUI() {
        if(!dom.coinsDisplay) return;
        dom.coinsDisplay.textContent = userState.coins.toFixed(1);
        dom.ticketsDisplay.textContent = userState.tickets;
        dom.streakDayDisplay.textContent = userState.streakDays;
        
        // --- –†–ê–°–ß–ï–¢ –î–ê–¢–´ –ì–†–ò–ù–î–ê (VIP) ---
        if (dom.userStatus) {
            // 1. –í—Å–µ–≥–¥–∞ –ø–∏—à–µ–º VIP
            let statusText = 'VIP';
            let dateHtml = '';

            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
            if (userState.referral_activated_at) {
                // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –∏–∑ –±–∞–∑—ã –≤ –æ–±—ä–µ–∫—Ç JS
                // JS —É–º–Ω—ã–π, –æ–Ω –ø–æ–π–º–µ—Ç —Ñ–æ—Ä–º–∞—Ç "2025-12-12..."
                let activatedDate = new Date(userState.referral_activated_at);
                
                // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞—è
                if (!isNaN(activatedDate.getTime())) {
                    // 3. –ü—Ä–∏–±–∞–≤–ª—è–µ–º 7 –¥–Ω–µ–π (7 * 24 —á–∞—Å–∞ * 60 –º–∏–Ω * 60 —Å–µ–∫ * 1000 –º—Å)
                    let expireDate = new Date(activatedDate.getTime() + (7 * 24 * 60 * 60 * 1000));
                    
                    let now = new Date();

                    // –ï—Å–ª–∏ —Å—Ä–æ–∫ (7 –¥–Ω–µ–π) –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫
                    if (now < expireDate) {
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: "19 –¥–µ–∫–∞–±—Ä—è")
                        let dateStr = expireDate.toLocaleDateString('ru-RU', {
                            day: 'numeric', 
                            month: 'long'
                        });
                        dateHtml = `<div style="font-size: 10px; opacity: 0.7; font-weight: 400; margin-top: 2px;">–¥–æ ${dateStr}</div>`;
                    }
                }
            }
            
            dom.userStatus.innerHTML = `<div style="line-height:1.1;">${statusText}</div>${dateHtml}`;
        }
        // ---------------------------------

        const { totalBonus, boostsHTML, baseReward } = calculateBoosts();
        const totalReward = (baseReward + totalBonus).toFixed(1); 
        
        if (totalBonus > 0) {
            dom.todayRewardDisplay.textContent = `+${totalReward} (—Å –±–æ–Ω—É—Å–æ–º)`;
            dom.todayRewardDisplay.style.color = "#FFD700"; 
        } else {
            dom.todayRewardDisplay.textContent = `+${totalReward}`;
            dom.todayRewardDisplay.style.color = "#fff";
        }
        
        if (boostsHTML) {
            dom.boostContainer.innerHTML = boostsHTML;
            dom.boostContainer.style.display = 'flex';
        } else {
            dom.boostContainer.style.display = 'none';
        }

        // –¢–∞–π–º–µ—Ä –∫–Ω–æ–ø–∫–∏ –≥—Ä–∏–Ω–¥–∞
        const now = new Date().getTime();
        const last = userState.lastGrindTime ? new Date(userState.lastGrindTime).getTime() : 0;
        const diff = now - last;

        if (diff < GRIND_COOLDOWN) {
            dom.grindBtn.disabled = true;
            const remaining = GRIND_COOLDOWN - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.grindBtnText.textContent = `–ß–ï–†–ï–ó ${h}—á ${m}–º`;
        } else {
            dom.grindBtn.disabled = false;
            dom.grindBtnText.textContent = "–ó–ê–ë–†–ê–¢–¨ –ë–û–ù–£–°";
        }
        
        renderFreeTicketBtn();
    }
  
    function renderStreakVisuals() {
        if(!dom.streakSteps) return;
        dom.streakSteps.innerHTML = '';
        let percent = ((userState.streakDays - 1) / (MAX_STREAK - 1)) * 100;
        if (percent > 100) percent = 100;
        dom.streakBar.style.width = `${percent}%`;

        for (let i = 1; i <= 5; i++) {
            const step = document.createElement('div');
            step.className = 'streak-step';
            let dayValue = [1, 3, 5, 7, 10][i-1];
            step.textContent = dayValue;
            if (userState.streakDays >= dayValue) {
                step.classList.add('completed');
                step.innerHTML = '<i class="fa-solid fa-check"></i>';
            }
            dom.streakSteps.appendChild(step);
        }
    }

    function renderFreeTicketBtn() {
        const lastClaim = userState.lastFreeTicket ? new Date(userState.lastFreeTicket).getTime() : 0;
        const now = new Date().getTime();
        const diff = now - lastClaim;
        
        const isBoosted = isVipActive() || isTwitchBoostActive();
        let ticketsReward = 1;
        
        if (isVipActive()) ticketsReward = 2; 
        else if (isTwitchBoostActive()) ticketsReward = grindSettings.twitch_status_free_tickets;

        if (diff > GRIND_COOLDOWN) {
            const btnText = isBoosted ? `+${ticketsReward} –ë–ò–õ–ï–¢–ê (VIP)` : "–ü–û–õ–£–ß–ò–¢–¨";
            const btnColor = isBoosted ? "#FFD700" : "#fff";
            
            dom.freeTicketContainer.innerHTML = `<button class="mini-btn" style="border-color:${btnColor}; color:${btnColor}; width:100%;" onclick="claimFreeTicket()">${btnText}</button>`;
            
            // –¢–µ–∫—Å—Ç –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π
            if(isBoosted) {
                 dom.ticketSubtitle.textContent = `VIP/Sub: –î–æ—Å—Ç—É–ø–Ω–æ ${ticketsReward} –±–∏–ª–µ—Ç–∞!`;
                 dom.ticketSubtitle.style.color = "#FFD700";
            } else {
                 dom.ticketSubtitle.textContent = "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ 24—á";
                 dom.ticketSubtitle.style.color = "#AAAAAA";
            }

        } else {
            const remaining = GRIND_COOLDOWN - diff;
            const h = Math.floor(remaining / 3600000);
            const m = Math.floor((remaining % 3600000) / 60000);
            dom.freeTicketContainer.innerHTML = `<span style="font-size:11px; color:#ffffff; font-weight: 600;">${h}—á ${m}–º</span>`;
            
            // –¢–µ–∫—Å—Ç –Ω–∞–¥ —Ç–∞–π–º–µ—Ä–æ–º
            if(isBoosted) {
                 dom.ticketSubtitle.textContent = `VIP: —Å–ª–µ–¥—É—é—â–∞—è –Ω–∞–≥—Ä–∞–¥–∞ —á–µ—Ä–µ–∑...`;
                 dom.ticketSubtitle.style.color = "#FFD700";
            } else {
                 dom.ticketSubtitle.textContent = "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ 24—á";
                 dom.ticketSubtitle.style.color = "#AAAAAA";
            }
        }
    }

    // --- –ú–ê–ì–ê–ó–ò–ù –ò –§–£–ù–ö–¶–ò–ò –û–ö–ù–ê –£–°–ü–ï–•–ê ---
    function showSuccess(message, promoCode = null) {
        closeShopModal();
        
        const modal = document.getElementById('success-modal');
        const msgEl = document.getElementById('success-message');
        const promoContainer = document.getElementById('success-promo-container');
        const promoValue = document.getElementById('success-promo-code');
        const instructionBlock = document.getElementById('promo-instruction-block');

        msgEl.textContent = message;

        if (promoCode) {
            promoContainer.style.display = 'flex';
            promoValue.textContent = promoCode;
            if(instructionBlock) instructionBlock.style.display = 'block';
        } else {
            promoContainer.style.display = 'none';
            if(instructionBlock) instructionBlock.style.display = 'none';
        }

        modal.classList.add('visible');
        tg.HapticFeedback.notificationOccurred('success');
    }

    // --- API –í–´–ó–û–í–´ –ì–õ–û–ë–ê–õ–¨–ù–´–ï ---
    window.claimFreeTicket = async () => {
        try {
            const response = await fetch('/api/v1/user/claim-free-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });
            
            if (response.ok) {
                const res = await response.json();
                let incoming = res.new_ticket_balance;
                let finalTickets = (typeof incoming === 'object' && incoming !== null) ? Number(incoming.new_ticket_balance) : Number(incoming);
                
                userState.tickets = finalTickets;
                userState.lastFreeTicket = new Date().toISOString();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(res.message); 
                updateUI();
            } else { throw new Error(); }
        } catch (e) { 
            console.error(e);
            tg.showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–∞'); 
        }
    };

    window.exchangeCoins = async (cost, rewardTickets) => {
        tg.showConfirm(`–ö—É–ø–∏—Ç—å ${rewardTickets} –±–∏–ª–µ—Ç(–æ–≤) –∑–∞ ${cost} –º–æ–Ω–µ—Ç?`, async (ok) => {
            if (ok) {
                try {
                    const response = await fetch('/api/v1/user/grind/exchange', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, cost: cost, tickets_reward: rewardTickets })
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || '–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞');
                    }
                    
                    const res = await response.json();
                    userState.coins = parseFloat(res.new_coins);
                    userState.tickets = res.new_tickets;
                    updateUI();
                    showSuccess(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${rewardTickets} –±–∏–ª–µ—Ç(–æ–≤)!`);
                    
                } catch (e) { tg.showAlert(e.message || '–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞'); }
            }
        });
    };

    window.buyItem = async (val) => {
        tg.showConfirm(`–ö—É–ø–∏—Ç—å –∫–æ–¥ –Ω–∞ ${val} –∑–≤–µ–∑–¥?`, async (ok) => {
            if(ok) {
                try {
                    const response = await fetch('/api/v1/user/grind/buy_item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, reward_value: val })
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || '–û—à–∏–±–∫–∞');
                    }
                    
                    const res = await response.json();
                    userState.coins = parseFloat(res.new_coins);
                    updateUI();
                    showSuccess(`–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${val} –∑–≤–µ–∑–¥ —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!`, res.promo_code);
                    
                } catch(e) { tg.showAlert(e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å'); }
            }
        });
    };

    async function fetchShopItems() {
        shopItems = [
            { type: 'ticket', cost: 3, reward: 1, title: '1 –ë–∏–ª–µ—Ç' },
            { type: 'ticket', cost: 15, reward: 1, title: '5 –ë–∏–ª–µ—Ç–æ–≤' },        
            { type: 'ticket', cost: 30, reward: 10, title: '10 –ë–∏–ª–µ—Ç–æ–≤' }
        ];
        try {
            const response = await fetch('/api/v1/user/grind/shop');
            const promos = await response.json();
            if (promos && promos.length > 0) {
                promos.forEach(p => {
                    shopItems.push({
                        type: 'promo', cost: p.reward_value, reward: p.reward_value,
                        title: `–ö–æ–¥ –Ω–∞ ${p.reward_value} üü°`, quantity: p.quantity
                    });
                });
                shopItems.sort((a, b) => a.cost - b.cost);
            }
        } catch (e) {}
    }

    function renderShopList() {
        dom.shopContainer.innerHTML = '';
        const items = shopItems.filter(i => i.type === (currentTab === 'tickets' ? 'ticket' : 'promo'));
        
        if (items.length === 0) {
            dom.shopContainer.innerHTML = '<div style="text-align:center; color:#777; padding:20px;">–ü—É—Å—Ç–æ</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'exchange-item';
            const isAffordable = userState.coins >= item.cost;
            const btnClick = item.type === 'ticket' ? `exchangeCoins(${item.cost}, ${item.reward})` : `buyItem(${item.reward})`;
            let extra = item.quantity ? `<span style="opacity:0.5; font-size:9px;">(–û—Å—Ç: ${item.quantity})</span>` : '';

            div.innerHTML = `
                <div class="exchange-details">
                    <div class="exchange-title">${item.title}</div>
                    <div class="exchange-cost">–¶–µ–Ω–∞: ${item.cost} –º–æ–Ω–µ—Ç ${extra}</div>
                </div>
                <button class="mini-btn" onclick="${btnClick}" ${isAffordable?'':'disabled'} style="${isAffordable?'background:var(--accent-primary);color:#000':''}">
                    ${isAffordable ? '–ö—É–ø–∏—Ç—å' : '–ú–∞–ª–æ –º–æ–Ω–µ—Ç'}
                </button>`;
            dom.shopContainer.appendChild(div);
        });
    }

    function startTimers() {
        setInterval(() => { updateUI(); }, 60000);
    }

    function showFloatText(element, text, color) {
        const rect = element.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.textContent = text;
        floatEl.className = 'float-anim';
        floatEl.style.color = color;
        floatEl.style.left = (rect.left + rect.width / 2 - 20) + 'px';
        floatEl.style.top = (rect.top) + 'px';
        document.body.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 1000);
    }
</script>
</body>
</html>
