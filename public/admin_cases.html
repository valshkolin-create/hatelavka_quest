<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Admin Cases</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --bg: #0f0f0f;
            --card-bg: rgba(30, 30, 30, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --primary: #ffd700;
            --action: #28a745;
            --danger: #ff4d4d;
            --text: #ffffff;
            --text-sec: #aaaaaa;
            
            /* Rarity Colors */
            --r-blue: #4b69ff;
            --r-purple: #8847ff;
            --r-pink: #d32ce6;
            --r-red: #eb4b4b;
            --r-gold: #ffd700;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
            /*user-select: none; /* –ì–ª–æ–±–∞–ª—å–Ω–æ –∑–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –Ω–æ —Ä–∞–∑—Ä–µ—à–∏–º –≤ –∏–Ω–ø—É—Ç–∞—Ö */
        }

        /* HEADER */
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { 
            background: none; border: none; color: var(--text-sec); font-size: 16px; 
            cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 5px; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .back-btn.visible { opacity: 1; pointer-events: auto; }
        .page-title { font-size: 20px; font-weight: 800; margin: 0; color: var(--primary); text-transform: none; }

        /* VIEW CONTAINERS */
        .view-section { display: none; animation: fadeIn 0.2s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CASES GRID (FOLDERS) --- */
        .cases-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); /* 4 –≤ —Ä—è–¥ */
            gap: 12px; 
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤ */
        @media (max-width: 600px) {
            .cases-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .case-folder {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 16px; padding: 15px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; transition: transform 0.1s, background 0.2s;
            text-align: center;
        }
        .case-folder:active { transform: scale(0.96); background: rgba(255,255,255,0.05); }
        
        .folder-icon { font-size: 32px; color: var(--primary); margin-bottom: 10px; }
        .folder-name { font-size: 12px; font-weight: 700; color: #fff; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .folder-count { font-size: 10px; color: var(--text-sec); margin-top: 4px; }

        .case-folder.create-new { border: 1px dashed var(--text-sec); background: rgba(255,255,255,0.02); }
        .case-folder.create-new .folder-icon { color: var(--text-sec); }

        /* --- ITEMS GRID (INSIDE CASE) --- */
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        
        .item-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 10px; position: relative; overflow: hidden;
            cursor: pointer; transition: transform 0.1s; display: flex; flex-direction: column;
        }
        .item-card:active { transform: scale(0.98); }
        
        /* Rarity Strip */
        .item-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: #555; }
        .item-card[data-rarity="blue"]::after { background: var(--r-blue); }
        .item-card[data-rarity="purple"]::after { background: var(--r-purple); }
        .item-card[data-rarity="pink"]::after { background: var(--r-pink); }
        .item-card[data-rarity="red"]::after { background: var(--r-red); }
        .item-card[data-rarity="gold"]::after { background: var(--r-gold); }

        .card-img { width: 100%; height: 90px; object-fit: contain; margin-bottom: 8px; align-self: center; }
        .card-name { font-size: 11px; font-weight: 700; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .card-meta { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-sec); width: 100%; }
        .card-price { color: var(--primary); font-weight: 700; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal-active { display: flex; }
        .bottom-sheet { background: #1c1c1e; width: 100%; border-radius: 24px 24px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        .form-label { font-size: 12px; color: var(--text-sec); margin-bottom: 5px; display: block; }
        
        /* üî• –§–ò–ö–° –ò–ù–ü–£–¢–û–í: –†–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ */
        .form-input, .form-select { 
            width: 100%; background: #252525; border: 1px solid var(--card-border);
            color: #fff; padding: 12px; border-radius: 12px; font-size: 14px; outline: none; box-sizing: border-box;
            user-select: text !important; 
            -webkit-user-select: text !important;
        }
        .form-input:focus { border-color: var(--primary); }
        .form-row { display: flex; gap: 10px; }
        
        /* PREVIEW */
        .preview-box {
            background: #000; border-radius: 12px; padding: 15px; text-align: center;
            border: 1px solid var(--card-border); margin-bottom: 10px;
        }
        .prev-img { width: 100px; height: 80px; object-fit: contain; margin-bottom: 5px; }
        .prev-name { font-size: 12px; font-weight: 700; }
        .prev-price { color: var(--primary); font-size: 13px; font-weight: 700; }

        /* BUTTONS */
        .btn-action-row {
            display: flex; gap: 10px; margin-top: 15px;
        }
        
        .admin-action-btn {
            border: none; padding: 16px; border-radius: 14px; font-weight: 800; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;
            transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .btn-save { 
            background: linear-gradient(135deg, #ffd700, #ffaa00); 
            color: #000; 
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }
        .btn-save:active { transform: scale(0.98); opacity: 0.9; }

        .btn-delete { 
            background: rgba(255, 59, 48, 0.15); 
            color: #ff3b30; 
            border: 1px solid rgba(255, 59, 48, 0.3);
        }
        .btn-delete:active { background: rgba(255, 59, 48, 0.25); }

        .icon-btn { width: 42px; height: 42px; border-radius: 12px; background: rgba(255,255,255,0.1); border: none; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }

        /* FAB (–ö–Ω–æ–ø–∫–∞ +) */
        .fab-container { position: fixed; bottom: 30px; right: 20px; z-index: 90; display: none; flex-direction: column; gap: 10px; align-items: flex-end; }
        .fab-container.show { display: flex; } 

        .fab-main {
            width: 60px; height: 60px; background: var(--primary); color: #000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 26px;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4); cursor: pointer; transition: transform 0.2s;
        }
        .fab-main.rotate { transform: rotate(45deg); background: #fff; }
        
        .fab-option {
            background: #2c2c2e; border: 1px solid var(--card-border); color: #fff;
            padding: 12px 20px; border-radius: 14px; font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            transform: translateY(20px); opacity: 0; pointer-events: none; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .fab-menu-open .fab-option { transform: translateY(0); opacity: 1; pointer-events: auto; }

        /* SEARCH LIST */
        .search-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px;
        }
        .search-img { width: 40px; height: 30px; object-fit: contain; }
        .search-info { flex: 1; min-width: 0; }
        .search-btn { background: var(--action); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; }

    </style>
</head>
<body>

    <div class="page-header">
        <button id="nav-back-btn" class="back-btn" onclick="handleBack()"><i class="fa-solid fa-chevron-left"></i> –ù–∞–∑–∞–¥</button>
        <h1 class="page-title" id="page-title">–ö–µ–π—Å—ã</h1>
        <div style="width: 20px;"></div> 
    </div>

    <div id="view-cases" class="view-section active">
        <div id="cases-grid" class="cases-grid">
            </div>
    </div>

    <div id="view-items" class="view-section">
        <div id="itemsContainer">
            <div style="text-align:center; padding:40px; color:var(--text-sec);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div class="fab-container" id="fabMenu">
        <div class="fab-option" onclick="openLibrarySearch()">
            <span>–ù–∞–π—Ç–∏ –≤ –±–∞–∑–µ</span> <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <div class="fab-option" onclick="openEditor(null)">
            <span>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</span> <i class="fa-solid fa-pen"></i>
        </div>
        <div class="fab-main" onclick="toggleFab()">
            <i class="fa-solid fa-plus"></i>
        </div>
    </div>

    <div id="modal-library" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-library')">
        <div class="bottom-sheet" style="height: 85vh;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –°–∫–∏–Ω–æ–≤</h3>
                <button onclick="closeModal('modal-library')" style="background:none; border:none; color:var(--text-sec); font-size:20px;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="admin-form" style="margin-top: 15px;">
                <input type="text" id="lib-search-inp" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä AK)..." oninput="debounceSearch()">
            </div>

            <div id="lib-results" style="flex:1; overflow-y: auto; margin-top:10px;">
                <div style="text-align:center; color:var(--text-sec); padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</div>
            </div>
        </div>
    </div>

    <div id="modal-editor" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-editor')">
        <div class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0">–†–µ–¥–∞–∫—Ç–æ—Ä –°–∫–∏–Ω–∞</h3>
                <button onclick="closeModal('modal-editor')" style="background:none; border:none; color:var(--text-sec); font-size:20px;"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="preview-box">
                <div style="font-size:10px; color:#555; margin-bottom:5px;">PREVIEW</div>
                <img src="" id="p-img" class="prev-img">
                <div id="p-name" class="prev-name">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                <div id="p-price" class="prev-price">0 üü°</div>
            </div>

            <form id="edit-form" class="admin-form" onsubmit="event.preventDefault(); saveItem();">
                <input type="hidden" name="id">
                <input type="hidden" name="link_id"> 
                
                <label class="form-label">–ö–∞—Ä—Ç–∏–Ω–∫–∞</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <input type="text" name="image_url" id="inp-img" class="form-input" placeholder="https://..." oninput="updatePreview()">
                    </div>
                    <div style="display:flex; align-items:flex-end;">
                        <input type="file" id="file-upload" hidden accept="image/*" onchange="uploadImage(this)">
                        <button type="button" class="icon-btn" onclick="document.getElementById('file-upload').click()">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </button>
                    </div>
                </div>

                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="name" id="inp-name" class="form-input" placeholder="AK-47 | Asiimov" required oninput="updatePreview()">

                <div class="form-row" style="margin-top:10px;">
                    <div style="flex:1">
                        <label class="form-label">–¶–µ–Ω–∞</label>
                        <input type="number" name="price" id="inp-price" class="form-input" value="0" step="any" inputmode="decimal" oninput="updatePreview()">
                    </div>
                    <div style="flex:1">
                        <label class="form-label">–®–∞–Ω—Å (Weight)</label>
                       <input type="number" name="chance_weight" class="form-input" value="10" step="any" inputmode="decimal">
                    </div>
                </div>

                <div class="form-row" style="margin-top:10px;">
                    <div style="flex:1">
                        <label class="form-label">–†–µ–¥–∫–æ—Å—Ç—å</label>
                        <select name="rarity" class="form-select">
                            <option value="common">White (–®–∏—Ä–ø)</option>
                            <option value="blue">Blue (–ê—Ä–º–µ–π—Å–∫–æ–µ)</option>
                            <option value="purple">Purple (–ó–∞–ø—Ä–µ—â.)</option>
                            <option value="pink">Pink (–ó–∞—Å–µ–∫—Ä–µ—á.)</option>
                            <option value="red">Red (–¢–∞–π–Ω–æ–µ)</option>
                            <option value="gold">Gold (–ù–æ–∂)</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                        <select name="condition" class="form-select">
                            <option value="FN">FN</option>
                            <option value="MW">MW</option>
                            <option value="FT">FT</option>
                            <option value="WW">WW</option>
                            <option value="BS">BS</option>
                        </select>
                    </div>
                </div>

                <input type="hidden" name="case_tag">

                <div class="btn-action-row">
                    <button type="button" id="btn-delete" class="admin-action-btn btn-delete" onclick="deleteItem()">–£–î–ê–õ–ò–¢–¨</button>
                    <button type="submit" class="admin-action-btn btn-save">–°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentCase = null; // –ï—Å–ª–∏ null, –º—ã –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
        let searchTimeout = null;

        // --- INIT ---
        loadCases();

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è (–ù–∞–∑–∞–¥)
        function handleBack() {
            if (currentCase) {
                // –í—ã—Ö–æ–¥ –∏–∑ –∫–µ–π—Å–∞ –≤ –º–µ–Ω—é
                currentCase = null;
                document.getElementById('view-items').classList.remove('active');
                document.getElementById('view-cases').classList.add('active');
                document.getElementById('page-title').innerText = '–ö–µ–π—Å—ã';
                document.getElementById('nav-back-btn').classList.remove('visible'); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                document.getElementById('fabMenu').classList.remove('show');
                
                loadCases(); // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            } else {
                window.location.href = '/admin';
            }
        }

        // 1. –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ü–ê–ü–û–ö (–ö–ï–ô–°–û–í)
        async function loadCases() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = '<div style="text-align:center; color:#555; grid-column:1/-1;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            document.getElementById('nav-back-btn').classList.add('visible'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –Ω–æ –ª–æ–≥–∏–∫—É –º–µ–Ω—è–µ–º

            // –ï—Å–ª–∏ –º—ã –≤ –∫–æ—Ä–Ω–µ, –∫–Ω–æ–ø–∫–∞ –≤–µ–¥–µ—Ç –≤ –∞–¥–º–∏–Ω–∫—É
            if (!currentCase) {
                document.getElementById('nav-back-btn').onclick = () => window.location.href = '/admin';
            }

            try {
                const res = await fetch('/api/v1/admin/cases/list_tags', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: tg.initData})
                });
                const data = await res.json();
                
                grid.innerHTML = '';
                
                // 1. –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è
                const addDiv = document.createElement('div');
                addDiv.className = 'case-folder create-new';
                addDiv.onclick = createNewCase;
                addDiv.innerHTML = `
                    <div class="folder-icon"><i class="fa-solid fa-plus"></i></div>
                    <div class="folder-name">–°–æ–∑–¥–∞—Ç—å</div>
                `;
                grid.appendChild(addDiv);

                // 2. –ö–µ–π—Å—ã
                data.forEach(t => {
                    if (!t.name) return;
                    // üî• –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ç –ø—Ä–µ—Ñ–∏–∫—Å–∞
                    let displayName = t.name;
                    while (/^(–ö–ï–ô–°|CASE|–ö–µ–π—Å|Case)\s*\|\s*/i.test(displayName)) {
                        displayName = displayName.replace(/^(–ö–ï–ô–°|CASE|–ö–µ–π—Å|Case)\s*\|\s*/i, '');
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'case-folder';
                    div.onclick = () => openCaseView(t.name);
                    div.innerHTML = `
                        <div class="folder-icon"><i class="fa-solid fa-briefcase"></i></div>
                        <div class="folder-name">${displayName}</div>
                        <div class="folder-count">${t.count} —Å–∫–∏–Ω–æ–≤</div>
                    `;
                    grid.appendChild(div);
                });

            } catch(e) { console.error(e); }
        }

        // 2. –í–•–û–î –í –ö–ï–ô–°
        function openCaseView(tagName) {
            currentCase = tagName;
            
            // –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
            let displayName = tagName;
            while (/^(–ö–ï–ô–°|CASE|–ö–µ–π—Å|Case)\s*\|\s*/i.test(displayName)) {
                displayName = displayName.replace(/^(–ö–ï–ô–°|CASE|–ö–µ–π—Å|Case)\s*\|\s*/i, '');
            }
            
            document.getElementById('page-title').innerText = displayName;
            document.getElementById('view-cases').classList.remove('active');
            document.getElementById('view-items').classList.add('active');
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            const backBtn = document.getElementById('nav-back-btn');
            backBtn.classList.add('visible');
            backBtn.onclick = handleBack;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å FAB
            document.getElementById('fabMenu').classList.add('show');
            document.getElementById('fabMenu').classList.remove('fab-menu-open');
            document.querySelector('.fab-main').classList.remove('rotate');

            loadItems(tagName);
        }

        function createNewCase() {
            let name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–µ–π—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ó–∏–º–Ω–∏–π):");
            if (!name) return;
            
            // –£–±–∏—Ä–∞–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ "–ö–µ–π—Å" –µ—Å–ª–∏ –±—ã–ª
            name = name.replace(/^(–ö–ï–ô–°|CASE|–ö–µ–π—Å|Case)\s*\|\s*/i, '').trim();
            const fullTag = "–ö–µ–π—Å | " + name; // üî• –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å
            
            openCaseView(fullTag);
            document.getElementById('itemsContainer').innerHTML = 
                `<div style="text-align:center; padding:40px; color:var(--text-sec);">
                    –ö–µ–π—Å "${name}" —Å–æ–∑–¥–∞–Ω.<br>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç —á–µ—Ä–µ–∑ –ø–ª—é—Å.
                </div>`;
        }

        // 3. –ó–ê–ì–†–£–ó–ö–ê –ü–†–ï–î–ú–ï–¢–û–í
        async function loadItems(tag) {
            const cont = document.getElementById('itemsContainer');
            cont.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
            
            try {
                const res = await fetch('/api/v1/admin/cases/get_items', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({case_tag: tag})
                });
                const items = await res.json();
                
                if (items.length === 0) {
                    cont.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);">–í –∫–µ–π—Å–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ</div>';
                    return;
                }

                let html = '<div class="items-grid">';
                items.forEach(item => {
                    const safeJson = encodeURIComponent(JSON.stringify(item));
                    html += `
                    <div class="item-card" data-rarity="${item.rarity}" onclick="openEditor('${safeJson}')">
                        <img src="${item.image_url}" class="card-img">
                        <div class="card-name">${item.name}</div>
                        <div class="card-meta">
                            <span>w: ${item.chance_weight}</span>
                            <span class="card-price">${item.price} üü°</span>
                        </div>
                    </div>`;
                });
                html += '</div>';
                cont.innerHTML = html;
            } catch (e) { cont.innerHTML = '–û—à–∏–±–∫–∞'; }
        }

        // --- FAB MENU ---
        function toggleFab() {
            document.getElementById('fabMenu').classList.toggle('fab-menu-open');
            document.querySelector('.fab-main').classList.toggle('rotate');
        }

        // 4. –ë–ò–ë–õ–ò–û–¢–ï–ö–ê
        function openLibrarySearch() {
            toggleFab();
            document.getElementById('modal-library').classList.add('modal-active');
            document.getElementById('lib-search-inp').value = '';
            doSearch(); // –ì—Ä—É–∑–∏–º —Å–ø–∏—Å–æ–∫ —Å—Ä–∞–∑—É
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(doSearch, 500);
        }

        async function doSearch() {
            const q = document.getElementById('lib-search-inp').value;
            const cont = document.getElementById('lib-results');
            cont.innerHTML = '<div style="text-align:center;color:var(--text-sec);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const res = await fetch('/api/v1/admin/cases/search_items', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: q})
                });
                const items = await res.json();
                
                cont.innerHTML = '';
                if (!items || items.length === 0) {
                    cont.innerHTML = '<div style="text-align:center;color:var(--text-sec);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }

                items.forEach(item => {
                    cont.innerHTML += `
                    <div class="search-item">
                        <img src="${item.image_url}" class="search-img">
                        <div class="search-info">
                            <div style="font-weight:700; font-size:13px;">${item.name}</div>
                            <div style="font-size:11px; color:var(--text-sec);">${item.price} üü°</div>
                        </div>
                        <button class="search-btn" onclick="cloneItem(${item.id})">–î–û–ë–ê–í–ò–¢–¨</button>
                    </div>`;
                });
            } catch(e) { console.error(e); }
        }

        function cloneItem(id) {
            tg.showConfirm("–î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–µ–∫—É—â–∏–π –∫–µ–π—Å?", async (ok) => {
                if (!ok) return;

                try {
                    const res = await fetch('/api/v1/admin/cases/clone_item', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({origin_id: id, target_case: currentCase})
                    });
                    if (res.ok) {
                        tg.HapticFeedback.notificationOccurred('success');
                        closeModal('modal-library');
                        loadItems(currentCase);
                        loadCases(); 
                    } else {
                        tg.showAlert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è");
                    }
                } catch(e) { 
                    tg.showAlert("–°–±–æ–π —Å–µ—Ä–≤–µ—Ä–∞"); 
                }
            });
        }
        
        // 5. –†–ï–î–ê–ö–¢–û–†
        function openEditor(jsonStr) {
            toggleFab();
            const modal = document.getElementById('modal-editor');
            const form = document.getElementById('edit-form');
            const delBtn = document.getElementById('btn-delete');

            if (jsonStr) {
                const item = JSON.parse(decodeURIComponent(jsonStr));
                form.id.value = item.id;
                form.link_id.value = item.link_id || ''; // üî• ID —Å–≤—è–∑–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                
                form.name.value = item.name;
                form.image_url.value = item.image_url;
                form.price.value = item.price;
                form.chance_weight.value = item.chance_weight;
                form.rarity.value = item.rarity;
                form.condition.value = item.condition || 'FN';
                
                // üî• –ì–õ–ê–í–ù–´–ô –§–ò–ö–°: –í—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–π –∫–µ–π—Å (currentCase), –∞ –Ω–µ item.case_tag
                form.case_tag.value = currentCase; 
                
                delBtn.style.display = 'flex';
                delBtn.innerText = "–£–ë–†–ê–¢–¨ –ò–ó –ö–ï–ô–°–ê";
            } else {
                form.reset();
                form.id.value = '';
                form.link_id.value = '';
                form.case_tag.value = currentCase;
                form.rarity.value = 'blue';
                form.chance_weight.value = 10;
                delBtn.style.display = 'none';
            }
            updatePreview();
            modal.classList.add('modal-active');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('modal-active'); }

        function updatePreview() {
            const img = document.getElementById('inp-img').value || 'https://placehold.co/100';
            document.getElementById('p-img').src = img;
            document.getElementById('p-name').innerText = document.getElementById('inp-name').value || '–ù–∞–∑–≤–∞–Ω–∏–µ';
            document.getElementById('p-price').innerText = (document.getElementById('inp-price').value || 0) + ' üü°';
        }

        async function saveItem() {
            const form = document.getElementById('edit-form');
            
            // üî• –§–ò–ö–° –ó–ê–ü–Ø–¢–´–•: –ú–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ –Ω–∞ —Ç–æ—á–∫–∏, —á—Ç–æ–±—ã JS –Ω–µ –ª–æ–º–∞–ª—Å—è –ø—Ä–∏ –≤–≤–æ–¥–µ 0,1 —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            const priceVal = form.price.value.toString().replace(',', '.');
            const weightVal = form.chance_weight.value.toString().replace(',', '.');

            const data = {
                id: form.id.value || null,
                name: form.name.value,
                image_url: form.image_url.value,
                price: parseFloat(priceVal) || 0,
                chance_weight: parseFloat(weightVal) || 0,
                rarity: form.rarity.value,
                condition: form.condition.value,
                case_tag: form.case_tag.value
            };

            try {
                const res = await fetch('/api/v1/admin/cases/save_item', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('modal-editor');
                    loadItems(currentCase);
                    loadCases(); 
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
                }
            } catch(e) { 
                tg.showAlert("–°–±–æ–π —Å–µ—Ä–≤–µ—Ä–∞"); 
            }
        }

        function deleteItem() {
            const linkId = document.querySelector('input[name="link_id"]').value;
            const itemId = document.querySelector('input[name="id"]').value;
            
            // üî• –§–ò–ö–° –ö–õ–ê–í–ò–ê–¢–£–†–´: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ Telegram –≤–º–µ—Å—Ç–æ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ confirm()
            tg.showConfirm("–£–±—Ä–∞—Ç—å —Å–∫–∏–Ω?", async (ok) => {
                if (!ok) return; // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ "–û—Ç–º–µ–Ω–∞"
                
                const payload = linkId ? {link_id: linkId} : {id: itemId};

                try {
                    await fetch('/api/v1/admin/cases/delete_item', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    closeModal('modal-editor');
                    loadItems(currentCase);
                    loadCases();
                } catch(e) { 
                    tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"); 
                }
            });
        }

        async function uploadImage(input) {
            const file = input.files[0];
            if(!file) return;
            const btn = input.previousElementSibling;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            const fd = new FormData(); fd.append('file', file);
            try {
                const res = await fetch('/api/v1/upload', {method:'POST', body:fd});
                const d = await res.json();
                if(d.url) {
                    document.getElementById('inp-img').value = d.url;
                    updatePreview();
                }
            } catch(e) { 
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); 
            }
            btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i>';
        }
    </script>
</body>
</html>
