<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Настройка ТГ Испытаний</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="admin.css"> 
  <style>
      body { 
          padding: 15px; 
          padding-bottom: 120px; /* Большой отступ снизу */
          background-color: #0f1014;
          color: #fff;
          font-family: 'Montserrat', sans-serif;
      }
      
      .page-header { margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
      .page-header-title { font-size: 20px; font-weight: 800; margin: 0; }

      /* Компактная карточка уровня */
      .tier-card {
          background: #1a1b20;
          border: 1px solid rgba(255,255,255,0.08);
          border-radius: 12px;
          padding: 12px;
          margin-bottom: 10px;
          position: relative;
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      
      .tier-top-row {
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .tier-index-badge {
          background: rgba(255,255,255,0.1);
          color: #ffd700;
          font-weight: 700;
          font-size: 12px;
          padding: 4px 8px;
          border-radius: 6px;
          min-width: 24px;
          text-align: center;
      }

      .input-wrapper {
          flex: 1;
          display: flex;
          flex-direction: column;
      }
      
      .input-label {
          font-size: 10px;
          color: #888;
          margin-bottom: 2px;
          text-transform: uppercase;
          font-weight: 600;
      }

      .compact-input {
          background: #111;
          border: 1px solid #333;
          color: #fff;
          padding: 8px;
          border-radius: 6px;
          font-size: 13px;
          outline: none;
          width: 100%;
          box-sizing: border-box;
      }
      .compact-input:focus { border-color: #0088cc; }

      .remove-btn {
          background: rgba(255, 59, 48, 0.15);
          color: #ff3b30;
          border: none;
          width: 32px; height: 32px;
          border-radius: 8px;
          cursor: pointer;
          display: flex; align-items: center; justify-content: center;
          transition: 0.2s;
      }
      .remove-btn:active { transform: scale(0.9); background: rgba(255, 59, 48, 0.3); }

      /* Блок выбора наград (Комбинация) */
      .rewards-selector {
          background: rgba(0,0,0,0.3);
          border-radius: 8px;
          padding: 8px;
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
      }

      .reward-option {
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 12px;
          cursor: pointer;
          user-select: none;
          background: rgba(255,255,255,0.05);
          padding: 4px 8px;
          border-radius: 6px;
          border: 1px solid transparent;
          transition: 0.2s;
      }
      
      .reward-option.active {
          background: rgba(0, 136, 204, 0.15);
          border-color: #0088cc;
          color: #fff;
      }

      .reward-inputs {
          display: flex;
          gap: 10px;
          margin-top: 5px;
      }
      
      .hidden { display: none !important; }

      .add-btn {
          width: 100%; padding: 12px;
          background: rgba(255,255,255,0.08); 
          border: 1px dashed #555;
          color: #ccc; border-radius: 10px; 
          cursor: pointer; font-weight: 600; font-size: 13px;
          transition: 0.2s;
      }
      .add-btn:active { background: rgba(255,255,255,0.15); }

      .save-bar {
          position: fixed; bottom: 0; left: 0; width: 100%;
          padding: 15px; box-sizing: border-box;
          background: rgba(20,20,25,0.95); 
          backdrop-filter: blur(10px);
          border-top: 1px solid #333;
          z-index: 100;
      }
      .save-btn {
          width: 100%; padding: 14px;
          background: #0088cc; color: #fff; border: none;
          border-radius: 12px; font-weight: 800; font-size: 15px;
          box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
          text-transform: uppercase;
      }
  </style>
</head>
<body>

    <div class="page-header">
        <a href="/admin" class="back-button"><i class="fa-solid fa-arrow-left"></i> Админка</a>
        <h1 class="page-header-title">Этапы Испытаний</h1>
        <div style="width: 60px;"></div>
    </div>

    <div id="tiers-container">
        <p style="text-align: center; color: #666; margin-top: 30px;">Загрузка...</p>
    </div>

    <button class="add-btn" onclick="addTier()">
        <i class="fa-solid fa-plus"></i> Добавить этап
    </button>

    <div class="save-bar">
        <button class="save-btn" onclick="saveAll()">СОХРАНИТЬ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let tiersData = [];

        async function loadData() {
            const container = document.getElementById('tiers-container');
            try {
                // Запрашиваем конфиг с сервера
                const res = await fetch('/api/v1/admin/tg_challenge/get_config', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData })
                });
                const data = await res.json();
                
                tiersData = (data && data.tiers) ? data.tiers : [];
                
                // Если пусто, добавляем пример
                if (tiersData.length === 0) {
                    tiersData = [{ target: 5, rewards: { tickets: 2 } }];
                }
                
                render();
            } catch (e) {
                container.innerHTML = `<p style="color:red; text-align:center;">Ошибка: ${e.message}</p>`;
            }
        }

        function render() {
            const container = document.getElementById('tiers-container');
            container.innerHTML = '';

            tiersData.forEach((tier, index) => {
                const div = document.createElement('div');
                div.className = 'tier-card';
                
                // Нормализация данных (старый формат -> новый)
                const rewards = tier.rewards || {};
                // Если старый формат (одна награда), конвертируем
                if (tier.reward && tier.type) {
                    if (tier.type === 'tickets') rewards.tickets = tier.reward;
                    if (tier.type === 'coins') rewards.coins = tier.reward;
                    if (tier.type === 'skin_random') rewards.skin = { min: tier.min_price, max: tier.max_price };
                }

                div.innerHTML = `
                    <div class="tier-top-row">
                        <div class="tier-index-badge">#${index + 1}</div>
                        
                        <div class="input-wrapper" style="flex: 2;">
                            <span class="input-label">Цель (Сообщений)</span>
                            <input type="number" class="compact-input inp-target" value="${tier.target}" placeholder="50">
                        </div>

                        <button class="remove-btn" onclick="removeTier(${index})"><i class="fa-solid fa-trash"></i></button>
                    </div>

                    <div class="input-wrapper">
                        <span class="input-label">Награды (Комбинация)</span>
                        <div class="rewards-selector">
                            <div class="reward-option ${rewards.tickets ? 'active' : ''}" onclick="toggleReward(this, 'tickets')">
                                <i class="fa-solid fa-ticket"></i> Билеты
                            </div>
                            <div class="reward-option ${rewards.coins ? 'active' : ''}" onclick="toggleReward(this, 'coins')">
                                <i class="fa-solid fa-coins"></i> Монеты
                            </div>
                            <div class="reward-option ${rewards.skin ? 'active' : ''}" onclick="toggleReward(this, 'skin')">
                                <i class="fa-solid fa-gift"></i> Скин
                            </div>
                        </div>
                    </div>

                    <div class="reward-inputs">
                        <div class="input-wrapper inp-tickets ${rewards.tickets ? '' : 'hidden'}">
                            <span class="input-label">Билетов</span>
                            <input type="number" class="compact-input val-tickets" value="${rewards.tickets || ''}" placeholder="10">
                        </div>
                        <div class="input-wrapper inp-coins ${rewards.coins ? '' : 'hidden'}">
                            <span class="input-label">Монет</span>
                            <input type="number" class="compact-input val-coins" value="${rewards.coins || ''}" placeholder="100">
                        </div>
                    </div>

                    <div class="reward-inputs inp-skin ${rewards.skin ? '' : 'hidden'}">
                         <div class="input-wrapper">
                            <span class="input-label">Мин. Цена</span>
                            <input type="number" class="compact-input val-min" value="${rewards.skin?.min || 0}">
                        </div>
                        <div class="input-wrapper">
                            <span class="input-label">Макс. Цена</span>
                            <input type="number" class="compact-input val-max" value="${rewards.skin?.max || 500}">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.toggleReward = (el, type) => {
            el.classList.toggle('active');
            const card = el.closest('.tier-card');
            const isActive = el.classList.contains('active');
            
            card.querySelector(`.inp-${type}`).classList.toggle('hidden', !isActive);
        }

        window.addTier = () => {
            tiersData.push({ target: '', rewards: { tickets: 5 } });
            render();
        }

        window.removeTier = (index) => {
            if(confirm('Удалить этот этап?')) {
                tiersData.splice(index, 1);
                render();
            }
        }

        window.saveAll = async () => {
            const cards = document.querySelectorAll('.tier-card');
            const newTiers = [];
            let isValid = true;

            cards.forEach(card => {
                const target = parseInt(card.querySelector('.inp-target').value);
                if (!target) isValid = false;

                const rewards = {};
                
                // Билеты
                if (!card.querySelector('.inp-tickets').classList.contains('hidden')) {
                    const val = parseInt(card.querySelector('.val-tickets').value);
                    if (val > 0) rewards.tickets = val;
                }
                // Монеты
                if (!card.querySelector('.inp-coins').classList.contains('hidden')) {
                    const val = parseInt(card.querySelector('.val-coins').value);
                    if (val > 0) rewards.coins = val;
                }
                // Скин
                if (!card.querySelector('.inp-skin').classList.contains('hidden')) {
                    const min = parseInt(card.querySelector('.val-min').value) || 0;
                    const max = parseInt(card.querySelector('.val-max').value) || 500;
                    rewards.skin = { min, max };
                }

                // Проверка: должна быть хоть одна награда
                if (Object.keys(rewards).length === 0) isValid = false;

                newTiers.push({ target, rewards });
            });

            if (!isValid) return tg.showAlert("Ошибка: Заполните цель и выберите хотя бы одну награду для каждого этапа.");

            newTiers.sort((a,b) => a.target - b.target);

            const payload = {
                mode: "tiered",
                tiers: newTiers
            };

            try {
                const btn = document.querySelector('.save-btn');
                btn.textContent = "Сохранение...";
                btn.disabled = true;

                await fetch('/api/v1/admin/tg_challenge/save_config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData, config: payload })
                });

                tg.showPopup({message: "Сохранено!"});
            } catch(e) {
                tg.showAlert("Ошибка: " + e.message);
            } finally {
                document.querySelector('.save-btn').textContent = "СОХРАНИТЬ";
                document.querySelector('.save-btn').disabled = false;
            }
        }

        loadData();
    </script>
</body>
</html>
