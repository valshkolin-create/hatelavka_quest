<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –†–æ–∑—ã–≥—Ä—ã—à–∞–º–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="admin.css"> 
    <style>
        /* --- –°–¢–ò–õ–ò –ü–†–ï–í–¨–Æ --- */
        .preview-container { background: #0e1621; border-radius: 12px; padding: 10px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .tg-message-bubble { background: #182533; padding: 10px; border-radius: 10px 10px 10px 0; max-width: 90%; position: relative; }
        .tg-photo { width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; background-color: #2b2b2b; display: none; }
        .tg-photo.visible { display: block; }
        .tg-text { color: white; font-size: 14px; line-height: 1.4; white-space: pre-wrap; }
        .tg-button { margin-top: 10px; background: rgba(255, 255, 255, 0.1); color: #64b5ef; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: default; }

        /* --- –°–¢–ò–õ–ò –°–ü–ò–°–ö–ê --- */
        .raffle-card-premium { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 15px; margin-bottom: 15px; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .raffle-card-premium::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #ffd700; opacity: 0.7; }
        .raffle-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .raffle-image-thumb { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); background: #222; }
        .raffle-title-row { flex-grow: 1; margin-left: 12px; }
        .raffle-title { font-size: 16px; font-weight: 700; color: #fff; margin: 0 0 4px 0; }
        .raffle-badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .badge-sub { background: rgba(0, 136, 204, 0.2); color: #33aaff; border: 1px solid rgba(0, 136, 204, 0.3); }
        .badge-ref { background: rgba(255, 153, 0, 0.2); color: #ffaa00; border: 1px solid rgba(255, 153, 0, 0.3); }
        .badge-twitch { background: rgba(145, 70, 255, 0.2); color: #bf94ff; border: 1px solid rgba(145, 70, 255, 0.3); }
        .raffle-footer { margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; gap: 10px; flex-wrap: wrap; }
        .timer-info { font-size: 11px; color: #ff2d55; margin-top: 5px; display: flex; align-items: center; gap: 5px; font-weight: bold; }

        /* --- TRADE LINK BOX --- */
        .trade-link-box { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; margin-top: 5px; font-size: 11px; color: #aaa; word-break: break-all; display: flex; align-items: center; gap: 8px; border: 1px dashed rgba(255,255,255,0.1); cursor: pointer; }
        .trade-link-box:active { background: rgba(255,255,255,0.1); }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ß–ê–°–¢–ù–ò–ö–û–í --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #1c1c1e; width: 100%; max-height: 80vh; border-radius: 20px 20px 0 0; padding: 20px; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: bold; color: #fff; }
        .modal-close { background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer; padding: 5px; }
        .participants-list { overflow-y: auto; flex-grow: 1; }
        .participant-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .participant-avatar { width: 32px; height: 32px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-right: 10px; color: #fff; font-weight: bold; }
        .participant-info { flex: 1; }
        .participant-name { font-size: 14px; font-weight: 500; color: #fff; }
        .participant-user { font-size: 12px; color: #777; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="loader-overlay hidden"><div class="spinner"></div></div>

    <main id="app-container" class="main-content">
        <div class="view">
            <div class="page-header">
                <button onclick="goBack()" class="back-button"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                <h1 class="page-header-title">–†–æ–∑—ã–≥—Ä—ã—à–∏</h1>
                <a href="/raffles" class="admin-menu-button" style="width: auto; padding: 8px 12px; margin-left: auto; text-decoration: none;">
                    <i class="fa-solid fa-eye"></i>
                </a>
            </div>

            <div class="tabs-container">
                <button class="tab-button active" onclick="switchTab('create')">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
                <button class="tab-button" onclick="switchTab('list')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
            </div>

            <div id="tab-create" class="tab-content active">
                <div class="quest-card">
                    <form id="create-raffle-form" class="admin-form">
                        <h3 style="margin: 0 0 10px; color: #ffd700;"><i class="fa-solid fa-sliders"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                        
                        <label>–¢–∏–ø —Ä–æ–∑—ã–≥—Ä—ã—à–∞</label>
                        <select name="type" id="raffle-type-select" onchange="toggleSettingsFields()">
                            <option value="inline_random">üé≤ –ö–Ω–æ–ø–∫–∞ (–†–∞–Ω–¥–æ–º)</option>
                            <option value="most_active">üî• –°–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π (–¢–æ–ø)</option>
                            <option value="comments">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</option>
                        </select>
                        
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <div class="setting-item" style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; flex: 1; align-items: center; justify-content: space-between;">
                                <span class="setting-label" style="font-size: 12px;">–ü–æ–¥–ø–∏—Å–∫–∞ TG</span>
                                <label class="toggle-switch"><input type="checkbox" name="requires_telegram_sub" checked onchange="updatePreview()"><span class="toggle-slider"></span></label>
                            </div>
                            <div class="setting-item" style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; flex: 1; align-items: center; justify-content: space-between;">
                                <span class="setting-label" style="font-size: 12px;">–†–µ—Ñ–µ—Ä–∞–ª—ã</span>
                                <label class="toggle-switch"><input type="checkbox" name="requires_referral_status" onchange="updatePreview()"><span class="toggle-slider"></span></label>
                            </div>
                        </div>

                        <div id="field-twitch-boost" class="hidden" style="margin-top: 10px;">
                            <label>–ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è Twitch Sub (x)</label>
                            <input type="number" name="twitch_sub_boost" value="1.0" step="0.1" placeholder="1.5">
                        </div>

                        <label style="margin-top: 15px; color: #ff2d55;">‚è∞ –ê–≤—Ç–æ-–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (–¢–∞–π–º–µ—Ä)</label>
                        <input type="datetime-local" name="end_time" onchange="updatePreview()">
                        <div style="font-size: 10px; color: #777; margin-top: 4px;">–ï—Å–ª–∏ —É–∫–∞–∑–∞—Ç—å, –±–æ—Ç —Å–∞–º –∑–∞–∫—Ä–æ–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à –≤ —ç—Ç–æ –≤—Ä–µ–º—è.</div>

                        <div style="margin: 20px 0 10px; height: 1px; background: rgba(255,255,255,0.1);"></div>
                        <h3 style="margin: 0 0 10px; color: #ffd700;"><i class="fa-solid fa-pen-nib"></i> –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>

                        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ)</label>
                        <input type="text" name="title" id="input-title" placeholder="AWP Asiimov –§–∞—Å—Ç" required oninput="updatePreview()">
                        <label>–ü—Ä–∏–∑</label>
                        <input type="text" name="prize_name" id="input-prize" required placeholder="AWP | Asiimov" oninput="updatePreview()">
                        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)</label>
                        <input type="text" name="prize_image" id="input-image" placeholder="https://..." oninput="updatePreview()">
                        <label>–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
                        <textarea name="description" id="input-desc" rows="4" placeholder="–£—Å–ª–æ–≤–∏—è –ø—Ä–æ—Å—Ç—ã–µ..." oninput="updatePreview()"></textarea>

                        <div class="preview-container">
                            <p style="margin: 0 0 5px; font-size: 10px; color: #777; text-transform: uppercase;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</p>
                            <div class="tg-message-bubble">
                                <img src="" id="preview-img" class="tg-photo">
                                <div class="tg-text" id="preview-text"><b>–†–æ–∑—ã–≥—Ä—ã—à!</b><br>–ü—Ä–∏–∑: ...</div>
                                <div class="tg-button">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å üé≤</div>
                            </div>
                        </div>

                        <button type="submit" class="admin-action-btn approve" style="margin-top: 20px; width: 100%;">üöÄ –°–æ–∑–¥–∞—Ç—å –∏ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    </form>
                </div>
            </div>

            <div id="tab-list" class="tab-content hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 16px;">–°–æ–±—ã—Ç–∏—è</h3>
                    <button onclick="loadRaffles()" class="admin-menu-button" style="width: auto; padding: 6px 12px;"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <div id="raffles-list-container">
                    <p style="text-align: center; color: #777; margin-top: 30px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>
    </main>

    <div id="participants-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ <span id="parts-count" style="font-size:14px; opacity:0.6; font-weight:normal;">(0)</span></div>
                <button class="modal-close" onclick="closeParticipants()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="parts-list" class="participants-list">
                <div style="text-align:center; padding:20px; color:#555;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        function goBack() { window.history.length > 1 ? window.history.back() : window.location.href = '/admin'; }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            const btns = document.querySelectorAll('.tab-button');
            if(tabName === 'create') btns[0].classList.add('active');
            if(tabName === 'list') { btns[1].classList.add('active'); loadRaffles(); }
        }

        function toggleSettingsFields() {
            const type = document.getElementById('raffle-type-select').value;
            const twitchBoostField = document.getElementById('field-twitch-boost');
            if (twitchBoostField) {
                if (type !== 'inline_random') twitchBoostField.classList.remove('hidden');
                else twitchBoostField.classList.add('hidden');
            }
            updatePreview();
        }

        function updatePreview() {
            const title = document.getElementById('input-title').value || '–ó–∞–≥–æ–ª–æ–≤–æ–∫';
            const prize = document.getElementById('input-prize').value || '–ü—Ä–∏–∑';
            const desc = document.getElementById('input-desc').value || '';
            const imgUrl = document.getElementById('input-image').value;
            
            const imgEl = document.getElementById('preview-img');
            if (imgUrl) { imgEl.src = imgUrl; imgEl.classList.add('visible'); } 
            else { imgEl.classList.remove('visible'); }

            let textHTML = `<b>${title}</b>\n\nüéÅ –ü—Ä–∏–∑: <b>${prize}</b>\n\n`;
            if (desc) textHTML += `${desc}\n\n`;

            const endTimeVal = document.querySelector('input[name="end_time"]').value;
            textHTML += `‚è≥ –ò—Ç–æ–≥–∏: ${endTimeVal ? new Date(endTimeVal).toLocaleString() : '–°–∫–æ—Ä–æ'}`;

            const previewTextEl = document.getElementById('preview-text');
            if(previewTextEl) previewTextEl.innerHTML = textHTML.replace(/\n/g, '<br>');
        }

        const createForm = document.getElementById('create-raffle-form');
        if (createForm) {
            createForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –°–æ–∑–¥–∞–µ–º...';

                const formData = new FormData(e.target);
                const settings = {
                    prize_name: formData.get('prize_name'),
                    prize_image: formData.get('prize_image'),
                    description: formData.get('description'), 
                    requires_telegram_sub: formData.get('requires_telegram_sub') === 'on',
                    requires_referral_status: formData.get('requires_referral_status') === 'on',
                    twitch_sub_boost: parseFloat(formData.get('twitch_sub_boost') || 1.0)
                };

                let endTimeIso = null;
                const endTimeVal = formData.get('end_time');
                if (endTimeVal) endTimeIso = new Date(endTimeVal).toISOString();

                const payload = {
                    initData: tg.initData,
                    title: formData.get('title'),
                    type: formData.get('type'),
                    end_time: endTimeIso, 
                    settings: settings
                };

                try {
                    const response = await fetch('/api/v1/admin/raffles/create', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        tg.showPopup({ title: '–£—Å–ø–µ—Ö', message: '–†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω!' });
                        e.target.reset(); updatePreview(); switchTab('list');
                    } else {
                        const err = await response.json(); tg.showAlert("–û—à–∏–±–∫–∞: " + (err.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"));
                    }
                } catch (error) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); } 
                finally { btn.disabled = false; btn.textContent = "üöÄ –°–æ–∑–¥–∞—Ç—å –∏ –ó–∞–ø—É—Å—Ç–∏—Ç—å"; }
            });
        }

        async function loadRaffles() {
            const container = document.getElementById('raffles-list-container');
            container.innerHTML = '<div class="spinner"></div>';
            try {
                const response = await fetch('/api/v1/admin/raffles/list', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                const raffles = await response.json();
                renderRafflesPremium(raffles);
            } catch (e) { container.innerHTML = '<p style="color:red; text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>'; }
        }

        function renderRafflesPremium(raffles) {
            const container = document.getElementById('raffles-list-container');
            container.innerHTML = '';

            if (!raffles || raffles.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding: 40px 20px; opacity: 0.5;"><i class="fa-solid fa-ghost" style="font-size: 40px; margin-bottom: 10px;"></i><p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</p></div>`;
                return;
            }

            raffles.forEach(raffle => {
                const s = raffle.settings || {};
                const isCompleted = raffle.status === 'completed';
                
                let badgesHtml = '';
                if (s.requires_telegram_sub) badgesHtml += `<div class="badge badge-sub">SUB</div>`;
                if (s.requires_referral_status) badgesHtml += `<div class="badge badge-ref">REF</div>`;

                const imgDisplay = s.prize_image 
                    ? `<img src="${s.prize_image}" class="raffle-image-thumb">`
                    : `<div class="raffle-image-thumb" style="display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-gift"></i></div>`;

                const statusText = isCompleted 
                    ? `<span style="color:#aaa; font-size:12px;"><i class="fa-solid fa-check"></i> –ó–∞–≤–µ—Ä—à–µ–Ω</span>`
                    : `<span style="color:#28a745; font-size:12px; font-weight:bold; display:flex; align-items:center; gap:4px;"><span style="display:block;width:6px;height:6px;background:#28a745;border-radius:50%;"></span> –ê–∫—Ç–∏–≤–µ–Ω</span>`;

                let timerHtml = '';
                if (!isCompleted && raffle.end_time) {
                    timerHtml = `<div class="timer-info"><i class="fa-regular fa-clock"></i> –ê–≤—Ç–æ: ${new Date(raffle.end_time).toLocaleString()}</div>`;
                }

                let cardHtml = `
                    <div class="raffle-card-premium">
                        <div class="raffle-header">
                            ${imgDisplay}
                            <div class="raffle-title-row">
                                <h3 class="raffle-title">${raffle.title}</h3>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div class="raffle-badges">${badgesHtml}</div>
                                    ${statusText}
                                </div>
                                ${timerHtml}
                            </div>
                        </div>
                        <div style="font-size:13px; color:rgba(255,255,255,0.7); margin-bottom:5px;">–ü—Ä–∏–∑: <span style="color:#fff;">${s.prize_name}</span></div>
                `;

                // –§–£–¢–ï–† –ö–ê–†–¢–û–ß–ö–ò
                cardHtml += `<div class="raffle-footer">`;

                if (isCompleted && raffle.winner) {
                    // –ï–°–õ–ò –ï–°–¢–¨ –ü–û–ë–ï–î–ò–¢–ï–õ–¨
                    const winner = raffle.winner;
                    const tradeLink = winner.trade_link ? winner.trade_link : null;
                    
                    cardHtml += `
                        <div style="width:100%; margin-bottom:8px;">
                            <div style="font-size:10px; color:#aaa; text-transform:uppercase;">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
                            <div style="font-weight:bold; color:#ffd700;">${winner.full_name} (@${winner.username || '---'})</div>
                            ${tradeLink ? 
                                `<div class="trade-link-box" onclick="copyToClipboard('${tradeLink}')">
                                    <i class="fa-solid fa-link"></i> ${tradeLink.substring(0, 30)}... <span style="margin-left:auto; color:#fff;">COPY</span>
                                 </div>` 
                                : '<div style="font-size:10px; color:#555;">–¢—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>'
                            }
                        </div>
                        <a href="https://t.me/${winner.username}" target="_blank" class="admin-menu-button" style="width:auto; padding:6px 10px; flex:1; text-align:center;">
                            <i class="fa-solid fa-message"></i> –õ–°
                        </a>
                    `;
                } else if (!isCompleted) {
                    // –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
                    cardHtml += `
                        <button onclick="drawRaffle(${raffle.id})" class="admin-action-btn approve" style="flex:1; font-size:13px; padding:10px;">
                            <i class="fa-solid fa-flag-checkered"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                    `;
                }
                
                // –ö–ù–û–ü–ö–ê "–£–ß–ê–°–¢–ù–ò–ö–ò" (–î–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤)
                cardHtml += `
                    <button onclick="showParticipants(${raffle.id})" class="admin-menu-button" style="width:auto; padding:10px 15px; margin-left:10px;">
                        <i class="fa-solid fa-users"></i>
                    </button>
                </div></div>`; // –ó–∞–∫—Ä—ã–≤–∞–µ–º footer –∏ card

                container.innerHTML += cardHtml;
            });
        }

        async function drawRaffle(raffleId) {
            if (!confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à –¥–æ—Å—Ä–æ—á–Ω–æ –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è?")) return;
            try {
                const response = await fetch('/api/v1/admin/raffles/draw', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData, raffle_id: raffleId })
                });
                const result = await response.json();
                if (response.ok) { tg.showPopup({ title: '–ì–æ—Ç–æ–≤–æ', message: result.message }); loadRaffles(); } 
                else { tg.showAlert("–û—à–∏–±–∫–∞: " + result.message); }
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"); }
        }

        // --- –õ–û–ì–ò–ö–ê –£–ß–ê–°–¢–ù–ò–ö–û–í ---
        async function showParticipants(raffleId) {
            const modal = document.getElementById('participants-modal');
            const list = document.getElementById('parts-list');
            const countEl = document.getElementById('parts-count');
            
            modal.classList.add('active');
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            countEl.innerText = '(...)';

            try {
                const response = await fetch('/api/v1/admin/raffles/participants', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData, raffle_id: raffleId })
                });
                const users = await response.json();
                
                countEl.innerText = `(${users.length})`;
                list.innerHTML = '';

                if (users.length === 0) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5;">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
                    return;
                }

                users.forEach(item => {
                    const u = item.user || {};
                    const letter = (u.full_name || 'U')[0].toUpperCase();
                    list.innerHTML += `
                        <div class="participant-item">
                            <div class="participant-avatar">${letter}</div>
                            <div class="participant-info">
                                <div class="participant-name">${u.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                <div class="participant-user">@${u.username || '---'}</div>
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                list.innerHTML = '<div style="color:red; text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        function closeParticipants() {
            document.getElementById('participants-modal').classList.remove('active');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                tg.showPopup({message: '–¢—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'});
            }).catch(err => {
                tg.showAlert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
            });
        }

        updatePreview();
    </script>
</body>
</html>
