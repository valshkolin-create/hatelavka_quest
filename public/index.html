<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–í—Ö–æ–¥</title>
  <style>
    body { margin: 0; height: 100vh; background-color: #121212; display: flex; justify-content: center; align-items: center; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #fff; flex-direction: column; padding: 20px; text-align: center; box-sizing: border-box;}
    .auth-box { background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 30px; width: 100%; max-width: 350px; }
    button { background-color: #0088cc; border: none; padding: 15px; border-radius: 10px; color: #fff; font-size: 1.1rem; cursor: pointer; transition: background-color 0.3s ease; width: 100%; font-weight: 600; }
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 12px 20px; border-radius: 8px; opacity: 0; visibility: hidden; transition: all 0.4s ease; z-index: 100; }
    .notification.show { top: 30px; opacity: 1; visibility: visible; }
  </style>
</head>
<body>
  <div class="auth-box">
    <button onclick="startTelegramAuth()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
  </div>
  <div id="notification" class="notification"></div>
<script>
    Telegram.WebApp?.ready();
    Telegram.WebApp?.expand();

    // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –°–ï–°–°–ò–ò ---
    (async () => {
      try {
        // –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–æ–≤–æ–º—É, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º—É —ç–Ω–¥–ø–æ–∏–Ω—Ç—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ cookie
        const response = await fetch('/api/v1/auth/session_check');
        
        if (response.ok) {
          const sessionData = await response.json();
          // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≥–æ—Å—Ç—å), –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–µ–Ω—é
          if (sessionData && !sessionData.is_guest) {
            console.log('–ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–µ–Ω—é...');
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ä–æ—É—Ç /menu, –∞ –Ω–µ –Ω–∞ —Ñ–∞–π–ª /menu.html
            window.location.href = '/menu';
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Å—Å–∏–∏:', error);
      }
    })();
    // --- –ö–û–ù–ï–¶ –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---


    function showNotification(message, isSuccess = true) {
      const notif = document.getElementById("notification");
      notif.textContent = message;
      notif.style.backgroundColor = isSuccess ? "#28a745" : "#dc3545";
      notif.classList.add("show");
      setTimeout(() => notif.classList.remove("show"), 3000);
    }

    async function startTelegramAuth() {
      try {
        const res = await fetch("/api/v1/auth/generate_token");
        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);

        const data = await res.json();
        const token = data.token;
        if (!token) throw new Error("–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω");

        const botUsername = "quest_hatelavka_bot"; // –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–æ —é–∑–µ—Ä–Ω–µ–π–º —Ç–≤–æ–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞
        const telegramUrl = `https://t.me/${botUsername}?start=${token}`;
        Telegram.WebApp?.openTelegramLink(telegramUrl);

        showNotification("–û–∂–∏–¥–∞–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏! –ë—É–∫–≤–∞–ª—å–Ω–æ —á—É—á—É—á ü•∫");

        let attempts = 0, maxAttempts = 45;
        const interval = setInterval(async () => {
          attempts++;
          if (attempts >= maxAttempts) {
            clearInterval(interval);
            showNotification("–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ", false);
            return;
          }

          const check = await fetch(`/api/v1/auth/check_token?token=${token}`);
          if (check.ok) {
            const result = await check.json();
            if (result.authenticated) {
              clearInterval(interval);
              showNotification("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
              setTimeout(() => {
                window.location.href = `/menu`;
              }, 1000);
            }
          }
        }, 2000);
      } catch (err) {
        showNotification("–û—à–∏–±–∫–∞: " + err.message, false);
      }
    }
</script>
</body>
</html>
