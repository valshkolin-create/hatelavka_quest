<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Лидерборд</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<style>
    :root {
      --bg-color: #000000;
      --surface-color: #1c1c1e;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --tg-color: #0088cc;
      --twitch-color: #9146ff;
      --gold-glow: #ffd700;
      --silver-glow: #c0c0c0;
      --bronze-glow: #cd7f32;
      --surface-glass-bg: rgba(28, 28, 30, 0.75);
    }
    body { margin: 0; min-height: 100vh; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; }
    .main-content { flex-grow: 1; overflow-y: auto; padding: 15px 15px 90px; }

    /* --- Заголовок и кнопка обновления --- */
    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .header-controls h2 { margin: 0; font-size: 16px; color: var(--text-color); }
    .refresh-button { background: none; border: none; color: var(--text-color-muted); cursor: pointer; padding: 0; font-size: 18px; transition: color 0.2s ease-in-out; }
    .refresh-button:hover { color: var(--tg-color); }
    .hidden { display: none !important; }

    /* --- инфо-блоки --- */
    .info-box { background-color: var(--surface-color); border-radius: 12px; padding: 15px; margin-bottom: 20px; font-size: 14px; line-height: 1.5; color: var(--text-color-muted); }
    .info-box h2 { margin: 0 0 10px 0; font-size: 16px; color: var(--text-color); }
    .info-box p { margin: 0; }
    .info-box strong { color: var(--text-color); font-weight: 600; }

    .controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    .source-switcher { display: flex; background-color: #2c2c2e; border-radius: 8px; padding: 4px; }
    .source-switcher button { flex: 1; padding: 8px; border: none; background-color: transparent; color: var(--text-color-muted); font-size: 14px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .source-switcher button.active.telegram { color: white; background-color: var(--tg-color); }
    .source-switcher button.active.twitch { color: white; background-color: var(--twitch-color); }

    .period-buttons { display: flex; gap: 8px; }
    .period-buttons.hidden { display: none; }
    .period-buttons button {
        flex: 1; /* <-- ИСПРАВЛЕНИЕ: Это свойство растягивает кнопки */
        width: 100%;
        background-color: #333;
        border: 1px solid #555;
        color: #ccc;
        font-size: 13px;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
    }
    .period-buttons button.active { background-color: var(--tg-color); color: #fff; border-color: var(--tg-color); }
    .period-buttons.twitch-active button.active { background-color: var(--twitch-color); border-color: var(--twitch-color); }


    table { width: 100%; border-collapse: collapse; background-color: var(--surface-color); border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #333; }
    th { background-color: #2a2a2a; font-size: 14px; }
    td.rank { font-weight: bold; text-align: center; width: 40px; }
    td.username { font-weight: 600; word-break: break-all; }
    td.count { font-weight: 600; text-align: right; }

    .first-place { border-left: 4px solid var(--gold-glow); }
    .second-place { border-left: 4px solid var(--silver-glow); }
    .third-place { border-left: 4px solid var(--bronze-glow); }

    .loader { margin-top: 30px; color: #888; text-align: center; }

    .app-footer { display: flex; justify-content: space-around; background-color: var(--surface-glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid rgba(58, 58, 60, 0.6); width: 100%; padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); position: fixed; bottom: 0; left: 0; z-index: 100; }
    .footer-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-color-muted); font-size: 11px; cursor: pointer; text-decoration: none; flex: 1; }
    .footer-item .icon-wrapper { font-size: 24px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
    .footer-item.active span, .footer-item.active .icon-wrapper { color: var(--tg-color); font-weight: 600; }

    /* --- фикс порядка кнопок Twitch --- */
    #twitch-period-buttons button[data-period="session"] { order: 1; }
    #twitch-period-buttons button[data-period="week"]    { order: 2; }
    #twitch-period-buttons button[data-period="month"]   { order: 3; }
    #twitch-period-buttons button[data-period="global"]  { order: 4; }
</style>
</head>
<body>
  <main class="main-content">

    <div id="info-box-twitch" class="info-box hidden">
        <div class="header-controls">
            <h2>Статистика Twitch</h2>
            <button class="refresh-button"><i class="fas fa-sync-alt"></i></button>
        </div>
        <p>Здесь отображается статистика активности на нашем Twitch канале.</p>
    </div>

    <div id="info-box-telegram" class="info-box">
        <div class="header-controls">
            <h2>Статистика Telegram</h2>
            <button class="refresh-button"><i class="fas fa-sync-alt"></i></button>
        </div>
        <p>Здесь отображается количество сообщений в нашем Telegram-чате. <a href="https://t.me/hatelovettv" target="_blank" style="color: var(--tg-color);">Перейти в чат</a></p>
    </div>

    <div class="controls">
      <div class="source-switcher">
        <button data-source="telegram" class="active telegram"><i class="fa-brands fa-telegram"></i> Telegram</button>
        <button data-source="twitch" class="twitch"><i class="fa-brands fa-twitch"></i> Twitch</button>
      </div>

      <div class="period-buttons" id="telegram-periods">
        <button data-period="day" class="active">День</button>
        <button data-period="week">Неделя</button>
        <button data-period="month">Месяц</button>
        <button data-period="all">Всё время</button>
      </div>

      <div class="period-buttons hidden twitch-controls" id="twitch-metric-buttons">
        <button data-metric="message" class="active">Сообщения</button>
        <button data-metric="uptime">Время</button>
        <button data-metric="ranks">Ранги</button>
      </div>

      <div class="period-buttons hidden twitch-controls twitch-active" id="twitch-period-buttons">
        <button data-period="session" class="active">Сессия</button>
        <button data-period="week">Неделя</button>
        <button data-period="month">Месяц</button>
        <button data-period="global">Всё время</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Пользователь</th>
          <th id="table-header-activity" style="text-align: right;">Сообщений</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <div id="loader" class="loader">Загрузка данных...</div>
  </main>
      
  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item active">
      <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
      <span>Лидерборд</span>
    </a>
    <a href="menu.html" class="footer-item">
      <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
      <span>Главная</span>
    </a>
  </footer>

<script>
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  const dom = {
    sourceButtons: document.querySelectorAll('.source-switcher button'),
    leaderboardBody: document.getElementById('leaderboardBody'),
    loader: document.getElementById('loader'),
    tableHeader: document.getElementById('table-header-activity'),
    infoBoxTwitch: document.getElementById('info-box-twitch'),
    infoBoxTelegram: document.getElementById('info-box-telegram'),
    refreshButtons: document.querySelectorAll('.refresh-button'),
    
    telegramPeriods: document.getElementById('telegram-periods'),
    twitchMetricButtons: document.getElementById('twitch-metric-buttons'),
    twitchPeriodButtons: document.getElementById('twitch-period-buttons'),
    
    telegramPeriodButtons: document.querySelectorAll('#telegram-periods button'),
    twitchMetricButtonList: document.querySelectorAll('#twitch-metric-buttons button'),
    twitchPeriodButtonList: document.querySelectorAll('#twitch-period-buttons button'),
  };
  
  let state = {
      source: 'telegram',
      telegramPeriod: 'day',
      twitchMetric: 'message',
      twitchPeriod: 'session',
  };

  function updateUI() {
      dom.infoBoxTelegram.classList.toggle('hidden', state.source !== 'telegram');
      dom.telegramPeriods.classList.toggle('hidden', state.source !== 'telegram');
      
      dom.infoBoxTwitch.classList.toggle('hidden', state.source !== 'twitch');
      dom.twitchMetricButtons.classList.toggle('hidden', state.source !== 'twitch');
      
      const showTwitchPeriods = state.source === 'twitch' && state.twitchMetric !== 'ranks';
      dom.twitchPeriodButtons.classList.toggle('hidden', !showTwitchPeriods);

      if (state.source === 'telegram') {
          dom.tableHeader.textContent = 'Сообщений';
      } else {
          switch (state.twitchMetric) {
              case 'message': dom.tableHeader.textContent = 'Сообщений'; break;
              case 'uptime': dom.tableHeader.textContent = 'Время'; break;
              case 'ranks': dom.tableHeader.textContent = 'Ранг (PTS)'; break;
          }
      }
  }

  // ✅ ИСПРАВЛЕННАЯ ФУНКЦИЯ ОТОБРАЖЕНИЯ
  async function fetchAndRender() {
    dom.leaderboardBody.innerHTML = '';
    dom.loader.style.display = 'block';
    dom.loader.textContent = 'Загрузка данных...';

    // Вспомогательная функция для конвертации секунд
    function formatUptime(totalSeconds) {
        if (totalSeconds < 60) return `~1 мин`;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        let result = '';
        if (hours > 0) result += `${hours} ч `;
        if (minutes > 0) result += `${minutes} мин`;
        return result.trim() || '0 мин';
    }

    let url = '';
    
    if (state.source === 'telegram') {
      url = `/api/v1/leaderboard?period=${state.telegramPeriod}`;
    } else { // Twitch
      if (state.twitchMetric === 'ranks') {
        url = `/api/v1/leaderboard/wizebot?sub_type=ALL&limit=50`;
      } else {
        url = `/api/v1/leaderboard/wizebot/stats?metric=${state.twitchMetric}&period=${state.twitchPeriod}&limit=50`;
      }
    }
    
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Ошибка сети: ${response.statusText}`);
      const data = await response.json();

      const leaderboardData = Array.isArray(data) ? data : data.leaderboard;

      if (!Array.isArray(leaderboardData) || leaderboardData.length === 0) {
        dom.loader.textContent = 'Нет данных.';
        return;
      }

      leaderboardData.forEach((entry, index) => {
        const row = document.createElement('tr');
        let rankContent = index + 1;
        if (index === 0) { row.classList.add('first-place'); rankContent = '🥇'; }  
        else if (index === 1) { row.classList.add('second-place'); rankContent = '🥈'; }  
        else if (index === 2) { row.classList.add('third-place'); rankContent = '🥉'; }
        
        const name = entry.full_name || entry.username || '...';
        let value = entry.total_activity ?? entry.value ?? entry.messages_count ?? 0;

        // Применяем конвертацию только для метрики 'uptime'
        if (state.source === 'twitch' && state.twitchMetric === 'uptime') {
            value = formatUptime(value);
        }

        row.innerHTML = `
          <td class="rank">${rankContent}</td>
          <td class="username">${name}</td>
          <td class="count">${value}</td>
        `;
        dom.leaderboardBody.appendChild(row);
      });
      dom.loader.style.display = 'none';
    } catch (error) {
      console.error('Ошибка:', error);
      dom.loader.textContent = 'Не удалось загрузить данные.';
    }
  }
  
  // ✅ ВОССТАНОВЛЕННЫЕ ОБРАБОТЧИКИ КНОПОК
  dom.sourceButtons.forEach(button => {
    button.addEventListener('click', () => {
      state.source = button.dataset.source;
      dom.sourceButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      updateUI();
      fetchAndRender();
    });
  });

  dom.telegramPeriodButtons.forEach(button => {
    button.addEventListener('click', () => {
      state.telegramPeriod = button.dataset.period;
      dom.telegramPeriodButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      fetchAndRender();
    });
  });

  dom.twitchMetricButtonList.forEach(button => {
    button.addEventListener('click', () => {
      state.twitchMetric = button.dataset.metric;
      dom.twitchMetricButtonList.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      updateUI();
      fetchAndRender();
    });
  });

  dom.twitchPeriodButtonList.forEach(button => {
    button.addEventListener('click', () => {
      state.twitchPeriod = button.dataset.period;
      dom.twitchPeriodButtonList.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      fetchAndRender();
    });
  });
  
  dom.refreshButtons.forEach(button => {
    button.addEventListener('click', () => {
      fetchAndRender();
    });
  });

  // ✅ ВЫЗОВЫ ДЛЯ ПЕРВОНАЧАЛЬНОЙ ЗАГРУЗКИ
  updateUI();
  fetchAndRender();
</script>
</body>
</html>
