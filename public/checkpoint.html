<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Чекпоинт</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --background-start: #100f1c;
            --background-end: #020204;
            --surface-primary: rgba(36, 34, 58, 0.7);
            --surface-secondary: rgba(48, 45, 78, 0.85);
            --border-color: rgba(138, 119, 255, 0.25);
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --accent-gold: #ffd700;
            --accent-purple: #9a77ff;
            --accent-glow: #00e5ff;
            --locked-color: #505060;
            --claimed-color: #34c759;
            --danger-color: #ff4d4d;
            --backdrop-blur: 12px;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            font-family: 'Montserrat', sans-serif; 
            background: linear-gradient(135deg, var(--background-start), var(--background-end)); 
            color: var(--text-primary); 
            margin: 0; 
            padding: 20px 10px 120px; 
            overflow-x: hidden; 
            position: relative; 
        }

        body::before { 
            content: ''; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 200%; 
            height: 200%; 
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px); 
            background-size: 25px 25px; 
            pointer-events: none; 
            z-index: -1; 
            opacity: 0.5; 
            animation: cosmicDust 40s linear infinite; 
        }

        @keyframes cosmicDust { 
            from { transform: translate(0, 0); } 
            to { transform: translate(-50%, -50%); } 
        }
        
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            opacity: 0; 
            transform: translateY(20px); 
            transition: opacity 0.6s ease-out, transform 0.6s ease-out; 
        }

        .container.visible { 
            opacity: 1; 
            transform: translateY(0); 
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
        }

        .page-title { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 28px; 
            font-weight: 900; 
            margin: 0 0 15px; 
            background: linear-gradient(90deg, var(--text-primary), var(--accent-gold)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3); 
        }

        .user-stars-balance { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--accent-gold); 
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            background: var(--surface-primary); 
            padding: 8px 18px; 
            border-radius: 30px; 
            border: 1px solid var(--border-color); 
            display: inline-flex; 
        }

        .user-stars-balance i { 
            font-size: 22px; 
        }
        
        .reward-track {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .reward-item {
            background: linear-gradient(145deg, var(--surface-secondary), var(--surface-primary));
            border: 1px solid var(--border-color);
            border-radius: 16px;
            display: flex; 
            flex-direction: column;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .reward-level {
            font-family: 'Orbitron', sans-serif; 
            font-size: 14px; 
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-glow));
            color: #000; 
            padding: 5px 15px; 
            border-radius: 20px;
            position: absolute; 
            top: 10px; 
            left: 10px;
            z-index: 2;
            box-shadow: 0 4px 12px rgba(0,0,0, 0.4);
        }

        .reward-image-container {
            width: 100%;
            height: 130px;
            background-color: rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .reward-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .reward-item:hover .reward-image {
            transform: scale(1.05);
        }

        .reward-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            text-align: center;
        }
        
        .reward-details {
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .reward-title { 
            font-size: 16px; 
            font-weight: 700; 
            margin: 0 0 5px; 
            color: var(--text-primary); 
        }

        .reward-description { 
            font-size: 12px; 
            color: var(--text-secondary); 
            margin: 0; 
        }
        
        .action-button { 
            width: 100%; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            font-weight: 700; 
            cursor: pointer; 
            text-align: center; 
            transition: all 0.3s ease; 
            font-family: 'Montserrat', sans-serif; 
            text-transform: uppercase; 
            font-size: 14px; 
            letter-spacing: 0.5px; 
            margin-top: auto; 
            flex-shrink: 0; 
        }
        
        .reward-item.is-claimed { 
            border-color: var(--claimed-color); 
        }

        .reward-item.is-claimed .reward-level { 
            background: var(--claimed-color); 
            color: white; 
            box-shadow: none; 
        }
        
        .reward-item.is-claimable { 
            border-color: var(--accent-gold); 
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); 
            animation: pulseGold 2s infinite alternate; 
        }

        @keyframes pulseGold { 
            from { box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); } 
            to { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); } 
        }

        .reward-item.is-locked { 
            opacity: 0.7; 
        }

        .reward-item.is-locked .reward-image-container { 
            filter: grayscale(80%); 
        }

        .claim-btn { 
            background: linear-gradient(90deg, var(--accent-gold) 0%, #ffc107 100%); 
            color: #000; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); 
        }

        .claimed-btn { 
            background-color: var(--claimed-color); 
            color: #fff; 
            cursor: default; 
        }

        .locked-btn { 
            background-color: var(--locked-color); 
            color: var(--text-secondary); 
            cursor: not-allowed; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
        }

        .locked-btn i { 
            color: var(--accent-gold); 
        }
        
        .admin-controls-wrapper { 
            position: fixed; 
            bottom: calc(env(safe-area-inset-bottom) + 80px); 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px; 
            pointer-events: none; 
        }

        .admin-controls { 
            display: flex; 
            gap: 10px; 
            pointer-events: all; 
        }

        .admin-controls button { 
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-glow)); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); 
            border: none; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        
        .create-reward-card { 
            border: 2px dashed var(--accent-purple); 
            justify-content: center; 
            align-items: center;
            cursor: pointer; 
            background: rgba(154, 119, 255, 0.05); 
            color: var(--accent-purple); 
            min-height: 280px; 
            text-shadow: 0 0 5px var(--accent-purple); 
            box-shadow: 0 0 15px rgba(154, 119, 255, 0.3); 
            transition: all 0.3s ease; 
        }

        .app-footer { 
            display: flex; 
            justify-content: space-around; 
            background-color: rgba(20, 18, 35, 0.8); 
            backdrop-filter: blur(var(--backdrop-blur)); 
            border-top: 1px solid var(--border-color); 
            width: 100%; 
            padding-top: 8px; 
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            z-index: 100; 
        }

        .footer-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            color: var(--text-secondary); 
            font-size: 11px; 
            text-decoration: none; 
            flex: 1; 
        }

        .footer-item .icon-wrapper { 
            font-size: 24px; 
            width: 30px; 
            height: 30px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }

        .footer-item.active span, .footer-item.active .icon-wrapper { 
            color: var(--accent-glow); 
            font-weight: 600; 
            text-shadow: 0 0 5px var(--accent-glow); 
        }

        .hidden { 
            display: none !important; 
        }

        .modal-overlay, .loader-overlay, .access-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(10, 10, 20, 0.8); 
            z-index: 1200; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(var(--backdrop-blur)); 
        }

        .modal-content { 
            background-color: var(--surface-secondary); 
            border: 1px solid var(--accent-purple); 
            padding: 0; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 400px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.7); 
            display: flex; 
            flex-direction: column; 
            max-height: 85vh; 
        }

        .modal-header { 
            padding: 15px 20px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .modal-header h3 { 
            margin: 0; 
            color: var(--accent-glow); 
            font-family: 'Orbitron', sans-serif; 
        }

        .modal-close-btn { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            font-size: 24px; 
            cursor: pointer; 
        }

        .modal-body { 
            overflow-y: auto; 
            padding: 20px; 
        }

        .modal-form { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }

        .modal-form label { 
            font-size: 14px; 
            color: var(--text-secondary); 
            margin-bottom: -10px; 
        }

        .modal-form input, .modal-form select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--accent-purple); 
            background-color: var(--background-start); 
            color: var(--text-primary); 
            font-size: 16px; 
            box-shadow: inset 0 0 5px rgba(154, 119, 255, 0.2); 
        }

        .modal-form input:focus, .modal-form select:focus { 
            outline: none; 
            border-color: var(--accent-glow); 
            box-shadow: inset 0 0 8px rgba(0, 229, 255, 0.4); 
        }

        .modal-form button[type="submit"] { 
            background: linear-gradient(90deg, var(--accent-glow), var(--accent-purple)); 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            color: #fff; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            font-family: 'Orbitron', sans-serif; 
            text-transform: uppercase; 
        }

        .spinner { 
            width: 50px; 
            height: 50px; 
            border: 4px solid rgba(0, 229, 255, 0.2); 
            border-top-color: var(--accent-glow); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }

        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .skin-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .skin-counter { 
            font-weight: 600; 
            color: var(--text-primary); 
        }

        .skin-counter .remaining { 
            color: var(--accent-gold); 
        }

        .last-claimer .username { 
            font-weight: 700; 
            color: var(--accent-purple); 
        }

        .form-group.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="loader-overlay" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <div id="access-overlay" class="access-overlay hidden">
        <i class="fa-solid fa-shield-halved"></i>
        <h2>ДОСТУП ОГРАНИЧЕН</h2>
        <p>Для просмотра этой страницы требуется специальное разрешение. Пожалуйста, свяжитесь с администратором.</p>
        <a href="/menu" class="back-button">ВЕРНУТЬСЯ В МЕНЮ</a>
    </div>

    <div class="container" id="container">
        <div class="header">
            <h1 class="page-title">ЧЕКПОИНТ</h1>
            <div class="user-stars-balance"> 
                <i class="fa-solid fa-star"></i> 
                <span id="user-stars-count">0</span> 
            </div>
        </div>
        <div id="reward-track" class="reward-track"></div>
    </div>
    
    <div class="admin-controls-wrapper">
        <div id="admin-access-controls" class="admin-controls hidden">
            <button id="grant-access-btn">Выдать доступ</button>
        </div>
        <div id="admin-controls" class="admin-controls hidden">
            <button id="edit-btn">Редактировать</button>
            <button id="save-btn" class="hidden">Сохранить</button>
        </div>
    </div>
    
    <div id="reward-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reward-modal-title">Новая награда</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reward-modal-form" class="modal-form">
                    <label>Уровень (стоимость в звездах)</label>
                    <input type="number" id="reward-level-input" required min="1">
                    
                    <label>Название награды</label>
                    <input type="text" id="reward-title-input" required placeholder="Например: 50 Монет">

                    <label>Описание (необязательно)</label>
                    <input type="text" id="reward-desc-input" placeholder="Например: Внутриигровая валюта">
                    
                    <label>Иконка/Скин (URL картинки)</label>
                    <input type="text" id="reward-icon-input" required placeholder="https://example.com/icon.png">
                    
                    <label>Тип награды</label>
                    <select id="reward-type-input">
                        <option value="coins">Монеты</option>
                        <option value="keys">Ключи</option>
                        <option value="cs2_skin">Скин CS2</option>
                        <option value="custom">Другое</option>
                    </select>

                    <label>Значение награды</label>
                    <input type="text" id="reward-value-input" required placeholder="50 или название скина">
                    
                    <div id="cs2-skin-fields" class="form-group hidden">
                        <label>Общее количество (шт)</label>
                        <input type="number" id="reward-total-quantity-input" placeholder="Напр: 10" min="1">
                        
                        <label>Уже забрали (шт)</label>
                        <input type="number" id="reward-claimed-quantity-input" placeholder="Напр: 0" min="0">
                    </div>

                    <button type="submit">Сохранить</button>
                </form>
            </div>
        </div>
    </div>

    <footer class="app-footer">
      <a href="/menu" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-house"></i></div><span>ГЛАВНАЯ</span></a>
      <a href="/events" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-gift"></i></div><span>ИВЕНТЫ</span></a>
      <a href="/checkpoint" class="footer-item active"><div class="icon-wrapper"><i class="fa-solid fa-star"></i></div><span>ЧЕКПОИНТ</span></a>
      <a href="/profile" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-user"></i></div><span>ПРОФИЛЬ</span></a>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let checkpointContent = { rewards: [] };
    let userData = {};
    let originalRewardIndex = null; 

    const dom = {
        loaderOverlay: document.getElementById('loader-overlay'),
        container: document.getElementById('container'),
        rewardTrack: document.getElementById('reward-track'),
        userStarsCount: document.getElementById('user-stars-count'),
        adminControls: document.getElementById('admin-controls'),
        editBtn: document.getElementById('edit-btn'),
        saveBtn: document.getElementById('save-btn'),
        rewardModal: document.getElementById('reward-modal'),
        rewardModalForm: document.getElementById('reward-modal-form'),
        rewardLevelInput: document.getElementById('reward-level-input'),
        rewardTitleInput: document.getElementById('reward-title-input'),
        rewardDescInput: document.getElementById('reward-desc-input'),
        rewardIconInput: document.getElementById('reward-icon-input'),
        rewardTypeInput: document.getElementById('reward-type-input'),
        rewardValueInput: document.getElementById('reward-value-input'),
        accessOverlay: document.getElementById('access-overlay'),
        adminAccessControls: document.getElementById('admin-access-controls'),
        grantAccessBtn: document.getElementById('grant-access-btn'),
        cs2SkinFields: document.getElementById('cs2-skin-fields'),
        totalQuantityInput: document.getElementById('reward-total-quantity-input'),
        claimedQuantityInput: document.getElementById('reward-claimed-quantity-input'),
    };
    
    function renderPage() {
        dom.userStarsCount.textContent = userData.checkpoint_stars || 0;
        dom.rewardTrack.innerHTML = '';
        const isEditMode = document.body.classList.contains('edit-mode');
        
        const sortedRewards = [...(checkpointContent.rewards || [])].sort((a, b) => a.level - b.level);

        sortedRewards.forEach((reward, index) => {
            const userLevel = userData.checkpoint_level || 0;
            const userStars = userData.checkpoint_stars || 0;

            const isClaimed = userLevel >= reward.level;
            const isClaimable = !isClaimed && userStars >= reward.level;
            const isLocked = !isClaimed && !isClaimable;
            
            const item = document.createElement('div');
            item.className = 'reward-item';
            if (isClaimed) item.classList.add('is-claimed');
            if (isClaimable) item.classList.add('is-claimable');
            if (isLocked) item.classList.add('is-locked');
            item.style.animation = `fadeInUp 0.5s ${index * 0.05}s ease-out backwards`;

            let buttonHtml = '';
            let extraInfoHtml = '';

            if (reward.type === 'cs2_skin') {
                const total = reward.total_quantity || 0;
                const claimed = reward.claimed_quantity || 0;
                const remaining = total - claimed;
                
                let claimerInfo = '';
                if (reward.last_claimer && reward.last_claimer.username) {
                    claimerInfo = `<div class="last-claimer">Посл: <span class="username">${reward.last_claimer.username}</span></div>`;
                }

                extraInfoHtml = `
                    <div class="skin-info">
                        <div class="skin-counter">Осталось: <span class="remaining">${remaining}</span>/${total}</div>
                        ${claimerInfo}
                    </div>`;
                
                if (remaining <= 0 && !isClaimed) {
                    buttonHtml = `<button class="action-button locked-btn" disabled>Закончились</button>`;
                }
            }
            
            if (!buttonHtml) {
                if (isClaimed) {
                    buttonHtml = `<button class="action-button claimed-btn" disabled><i class="fa-solid fa-check"></i> Получено</button>`;
                } else if (isClaimable) {
                    buttonHtml = `<button class="action-button claim-btn" data-level="${reward.level}">Забрать за ${reward.level} <i class="fa-solid fa-star"></i></button>`;
                } else {
                    buttonHtml = `<button class="action-button locked-btn" disabled>${reward.level} <i class="fa-solid fa-star"></i></button>`;
                }
            }

            const descriptionHtml = reward.description ? `<div class="reward-description">${reward.description}</div>` : '';
            const originalIndex = checkpointContent.rewards.findIndex(r => r.level === reward.level && r.title === reward.title);

            item.innerHTML = `
                <div class="reward-level">LVL ${reward.level}</div>
                <div class="reward-image-container">
                    <img src="${reward.icon || 'https://i.ibb.co/3s7vXG5/placeholder.png'}" class="reward-image" alt="${reward.title}">
                </div>
                <div class="reward-content">
                    <div class="reward-details">
                        <div class="reward-title">${reward.title || 'Без названия'}</div>
                        ${descriptionHtml}
                    </div>
                    ${extraInfoHtml}
                    ${buttonHtml}
                </div>
            `;
            dom.rewardTrack.appendChild(item);
        });

        if (isEditMode) {
             dom.rewardTrack.insertAdjacentHTML('beforeend', `<div class="reward-item create-reward-card"><i class="fa-solid fa-plus" style="font-size: 32px;"></i></div>`);
        }
    }

    function showRewardModal(rewardData, index) {
        originalRewardIndex = index;
        dom.rewardModal.querySelector('h3').textContent = index === null ? 'НОВАЯ НАГРАДА' : 'РЕДАКТИРОВАТЬ НАГРАДУ';
        
        dom.rewardLevelInput.value = rewardData ? rewardData.level : '';
        dom.rewardTitleInput.value = rewardData ? rewardData.title : '';
        dom.rewardDescInput.value = rewardData ? rewardData.description : '';
        dom.rewardIconInput.value = rewardData ? rewardData.icon : '';
        dom.rewardTypeInput.value = rewardData ? rewardData.type : 'coins';
        dom.rewardValueInput.value = rewardData ? rewardData.value : '';
        
        toggleSkinFields(rewardData ? rewardData.type : 'coins');
        if (rewardData && rewardData.type === 'cs2_skin') {
            dom.totalQuantityInput.value = rewardData.total_quantity || '';
            dom.claimedQuantityInput.value = rewardData.claimed_quantity || '0';
        } else {
            dom.totalQuantityInput.value = '';
            dom.claimedQuantityInput.value = '';
        }

        dom.rewardModal.classList.remove('hidden');
    }

    function toggleSkinFields(type) {
        if (type === 'cs2_skin') {
            dom.cs2SkinFields.classList.remove('hidden');
        } else {
            dom.cs2SkinFields.classList.add('hidden');
        }
    }

    async function initialize() {
        if (!tg.initData) {
            console.error("Telegram WebApp initData not found. Cannot authenticate.");
            dom.loaderOverlay.classList.add('hidden');
            dom.accessOverlay.classList.remove('hidden');
            return;
        }

        try {
            const [userRes, contentRes] = await Promise.all([
                fetch('/api/v1/user/me', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ initData: tg.initData }) }),
                fetch('/api/v1/checkpoint/content')
            ]);

            if (!userRes.ok) throw new Error("Ошибка при загрузке данных пользователя.");
            userData = await userRes.json();
            
            const isGloballyEnabled = userData.is_checkpoint_globally_enabled;
            const hasIndividualAccess = userData.has_checkpoint_access;
            const isAdmin = userData.is_admin;

            if (isAdmin || isGloballyEnabled || (!isGloballyEnabled && hasIndividualAccess)) {
                if (!contentRes.ok) throw new Error("Ошибка при загрузке контента марафона.");
                checkpointContent = await contentRes.json();
                
                renderPage();
                dom.container.classList.add('visible');

                if (userData.is_admin) {
                    dom.adminControls.classList.remove('hidden');
                    dom.adminAccessControls.classList.remove('hidden');
                }
            } else {
                dom.accessOverlay.classList.remove('hidden');
            }

        } catch (e) {
            console.error("Ошибка инициализации Чекпоинта:", e);
            tg.showAlert(e.message);
            dom.accessOverlay.classList.remove('hidden');
        } finally {
            dom.loaderOverlay.classList.add('hidden');
        }
    }

    dom.rewardTypeInput.addEventListener('change', (e) => {
        toggleSkinFields(e.target.value);
    });

    dom.rewardModalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const updatedReward = {
            level: parseInt(dom.rewardLevelInput.value),
            title: dom.rewardTitleInput.value,
            description: dom.rewardDescInput.value,
            icon: dom.rewardIconInput.value,
            type: dom.rewardTypeInput.value,
            value: dom.rewardValueInput.value,
        };
        
        if (updatedReward.type === 'cs2_skin') {
            updatedReward.total_quantity = parseInt(dom.totalQuantityInput.value) || 0;
            updatedReward.claimed_quantity = parseInt(dom.claimedQuantityInput.value) || 0;
        }

        if (originalRewardIndex !== null) {
            checkpointContent.rewards[originalRewardIndex] = updatedReward;
        } else {
            checkpointContent.rewards.push(updatedReward);
        }
        dom.rewardModal.classList.add('hidden');
        renderPage();
    });

    dom.editBtn.addEventListener('click', () => {
        document.body.classList.add('edit-mode');
        dom.saveBtn.classList.remove('hidden');
        dom.editBtn.classList.add('hidden');
        renderPage();
    });

    dom.saveBtn.addEventListener('click', async () => {
        tg.MainButton.showProgress();
        try {
            const response = await fetch('/api/v1/admin/checkpoint/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    initData: tg.initData,
                    content: checkpointContent
                })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || "Ошибка сохранения");
            tg.showAlert('Марафон успешно сохранен!');
            document.body.classList.remove('edit-mode');
            dom.saveBtn.classList.add('hidden');
            dom.editBtn.classList.remove('hidden');
            renderPage(); 
        } catch(e) {
            tg.showAlert(e.message);
        } finally {
            tg.MainButton.hideProgress();
        }
    });
    
    document.body.addEventListener('click', async (e) => {
        const target = e.target;
        const modal = target.closest('.modal-overlay');
        if (target.matches('.modal-close-btn') || (modal && !target.closest('.modal-content'))) {
            modal.classList.add('hidden');
            return;
        }

        if (document.body.classList.contains('edit-mode')) {
            if (target.closest('.create-reward-card')) {
                showRewardModal(null, null);
            }
            const editBtn = target.closest('.card-edit-btn');
            if (editBtn) {
                const index = parseInt(editBtn.dataset.originalIndex);
                showRewardModal(checkpointContent.rewards[index], index);
            }
            const deleteBtn = target.closest('.card-delete-btn');
            if (deleteBtn) {
                tg.showConfirm('Удалить эту награду?', (ok) => {
                    if (ok) {
                        const index = parseInt(deleteBtn.dataset.originalIndex);
                        checkpointContent.rewards.splice(index, 1);
                        renderPage();
                    }
                });
            }
        } else {
            const claimBtn = target.closest('.claim-btn');
            if (claimBtn && !claimBtn.disabled) {
                const levelToClaim = parseInt(claimBtn.dataset.level);
                claimBtn.disabled = true;
                claimBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                try {
                    const response = await fetch('/api/v1/checkpoint/claim', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, level: levelToClaim })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Не удалось забрать награду.');

                    userData.checkpoint_level = result.new_level;
                    tg.showAlert('Награда успешно получена!');
                    
                    const userRes = await fetch('/api/v1/user/me', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ initData: tg.initData }) });
                    userData = await userRes.json();
                    
                    renderPage();
                } catch (error) {
                    tg.showAlert(error.message);
                    claimBtn.disabled = false;
                    claimBtn.innerHTML = `Забрать за ${levelToClaim} <i class="fa-solid fa-star"></i>`;
                }
            }
        }
    });
    
    dom.grantAccessBtn.addEventListener('click', () => {
        tg.showScanQrPopup({ text: "Отсканируйте QR-код пользователя для выдачи доступа" }, async (qrText) => {
            if (qrText && !isNaN(parseInt(qrText))) {
                tg.MainButton.showProgress();
                try {
                    const response = await fetch('/api/v1/admin/checkpoint/grant-access', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, user_id_to_grant: parseInt(qrText) })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Не удалось выдать доступ.');
                    tg.showAlert(result.message);
                    return true;
                } catch (error) {
                    tg.showAlert(error.message);
                    return false;
                } finally {
                    tg.MainButton.hideProgress();
                }
            } else if (qrText) {
                tg.showAlert("Неверный QR-код. Убедитесь, что это QR-код с Telegram ID.");
                return false;
            }
        });
    });

    initialize();
});
</script>
</body>
</html>
