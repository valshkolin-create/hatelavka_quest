<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ß–µ–∫–ø–æ–∏–Ω—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --background-start: #100f1c;
            --background-end: #020204;
            --surface-primary: rgba(36, 34, 58, 0.7);
            --surface-secondary: rgba(48, 45, 78, 0.85);
            --border-color: rgba(138, 119, 255, 0.25);
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --accent-gold: #ffd700;
            --accent-purple: #9a77ff;
            --accent-glow: #00e5ff;
            --locked-color: #505060;
            --claimed-color: #34c759;
            --danger-color: #ff4d4d;
            --backdrop-blur: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, var(--background-start), var(--background-end)); color: var(--text-primary); margin: 0; padding: 20px 10px 120px; overflow-x: hidden; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 25px 25px; pointer-events: none; z-index: -1; opacity: 0.5; animation: cosmicDust 40s linear infinite; }
        @keyframes cosmicDust { from { transform: translate(0, 0); } to { transform: translate(-50%, -50%); } }
        
        .container { max-width: 800px; margin: 0 auto; opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .container.visible { opacity: 1; transform: translateY(0); }
        
        .header { text-align: center; margin-bottom: 30px; }
        .title-container { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .page-title { font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 900; margin: 0; background: linear-gradient(90deg, var(--text-primary), var(--accent-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        
        .how-to-earn-button {
            background: linear-gradient(90deg, var(--accent-glow) 0%, var(--accent-purple) 100%);
            color: #000;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .how-to-earn-button:hover {
            box-shadow: 0 4px 20px rgba(0, 229, 255, 0.4);
            transform: translateY(-2px);
        }

        .user-stars-balance { margin-top: 15px; font-size: 20px; font-weight: 700; color: var(--accent-gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); display: flex; align-items: center; justify-content: center; gap: 10px; background: var(--surface-primary); padding: 8px 18px; border-radius: 30px; border: 1px solid var(--border-color); display: inline-flex; }
        .user-stars-balance i { font-size: 22px; }
        
        .reward-track { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        
        .reward-item { background: linear-gradient(145deg, var(--surface-secondary), var(--surface-primary)); border: 1px solid var(--border-color); border-radius: 16px; display: flex; flex-direction: column; position: relative; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .reward-level { font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 700; background: linear-gradient(45deg, var(--accent-purple), var(--accent-glow)); color: #000; padding: 5px 15px; border-radius: 20px; position: absolute; top: 10px; left: 10px; z-index: 3; box-shadow: 0 4px 12px rgba(0,0,0, 0.4); }
        .reward-image-container { width: 100%; height: 130px; background-color: rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .reward-image { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s ease; }
        .reward-item:hover .reward-image { transform: scale(1.05); }

        .reward-content { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; text-align: center; }
        .reward-details { flex-grow: 1; margin-bottom: 15px; }
        .reward-title { font-size: 16px; font-weight: 700; margin: 0 0 5px; color: var(--text-primary); }
        .reward-description { font-size: 12px; color: var(--text-secondary); margin: 0; }
        
        .action-button { width: 100%; border: none; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; text-align: center; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif; text-transform: uppercase; font-size: 14px; letter-spacing: 0.5px; margin-top: auto; flex-shrink: 0; }
        
        .reward-item.is-claimed { border-color: var(--claimed-color); }
        .reward-item.is-claimed .reward-level { background: var(--claimed-color); color: white; box-shadow: none; }
        .reward-item.is-claimable { border-color: var(--accent-gold); box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); animation: pulseGold 2s infinite alternate; }
        @keyframes pulseGold { from { box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); } to { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); } }
        .reward-item.is-locked { opacity: 0.7; }
        .reward-item.is-locked .reward-image-container { filter: grayscale(80%); }
        .claim-btn { background: linear-gradient(90deg, var(--accent-gold) 0%, #ffc107 100%); color: #000; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .claimed-btn { background-color: var(--claimed-color); color: #fff; cursor: default; }
        .locked-btn { background-color: var(--locked-color); color: var(--text-secondary); cursor: not-allowed; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .locked-btn i { color: var(--accent-gold); }
        
        .admin-controls-wrapper { position: fixed; bottom: calc(env(safe-area-inset-bottom) + 80px); left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
        .admin-controls { display: flex; gap: 10px; pointer-events: all; }
        .admin-controls button { background: linear-gradient(90deg, var(--accent-purple), var(--accent-glow)); color: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        
        .edit-overlay { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.7); 
            border-radius: 16px; 
            display: flex; gap: 10px; 
            justify-content: center; align-items: center;
            z-index: 2;
            opacity: 0; 
            transition: opacity 0.3s; 
            pointer-events: none; 
        }
        .edit-mode .reward-item:hover .edit-overlay { 
            opacity: 1; 
            pointer-events: all; 
        }
        .card-btn { border: none; border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 16px; cursor: pointer; transition: transform 0.2s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
        .card-btn:hover { transform: scale(1.1); }
        .card-edit-btn { background-color: #007aff; }
        .card-delete-btn { background-color: var(--danger-color); }
        
        .create-reward-card { border: 2px dashed var(--accent-purple); justify-content: center; align-items: center; cursor: pointer; background: rgba(154, 119, 255, 0.05); color: var(--accent-purple); min-height: 280px; text-shadow: 0 0 5px var(--accent-purple); box-shadow: 0 0 15px rgba(154, 119, 255, 0.3); transition: all 0.3s ease; }
        .app-footer { display: flex; justify-content: space-around; background-color: rgba(20, 18, 35, 0.8); backdrop-filter: blur(var(--backdrop-blur)); border-top: 1px solid var(--border-color); width: 100%; padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); position: fixed; bottom: 0; left: 0; z-index: 100; }
        .footer-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-secondary); font-size: 11px; text-decoration: none; flex: 1; }
        .footer-item .icon-wrapper { font-size: 24px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
        .footer-item.active span, .footer-item.active .icon-wrapper { color: var(--accent-glow); font-weight: 600; text-shadow: 0 0 5px var(--accent-glow); }
        
        .hidden { display: none !important; }

        .modal-overlay, .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 20, 0.8); z-index: 1200; display: flex; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(var(--backdrop-blur)); }
        
        .access-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; color: var(--text-primary);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
        }
        .access-overlay i { font-size: 56px; margin-bottom: 20px; color: var(--accent-glow); text-shadow: 0 0 15px var(--accent-glow); }
        .access-overlay h2 { font-family: 'Orbitron', sans-serif; font-size: 28px; margin: 0 0 10px; color: var(--accent-glow); text-shadow: 0 0 10px var(--accent-glow); }
        .access-overlay p { font-size: 16px; color: var(--text-secondary); max-width: 350px; margin-bottom: 30px; line-height: 1.5; }
        .back-button {
            padding: 12px 30px; background: linear-gradient(90deg, var(--accent-glow) 0%, var(--accent-purple) 100%);
            color: #000; text-decoration: none; border-radius: 25px; font-weight: 700;
            font-family: 'Orbitron', sans-serif; transition: all 0.3s ease; box-shadow: 0 0 15px var(--accent-glow);
        }
        .back-button:hover { box-shadow: 0 0 25px var(--accent-glow); transform: translateY(-2px); }


        .modal-content { background-color: var(--surface-secondary); border: 1px solid var(--accent-purple); padding: 0; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.7); display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: var(--accent-glow); font-family: 'Orbitron', sans-serif; }
        .modal-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
        .modal-body { overflow-y: auto; padding: 20px; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form label { font-size: 14px; color: var(--text-secondary); margin-bottom: -10px; }
        .modal-form input, .modal-form select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-purple); background-color: var(--background-start); color: var(--text-primary); font-size: 16px; box-shadow: inset 0 0 5px rgba(154, 119, 255, 0.2); }
        .modal-form button[type="submit"] { background: linear-gradient(90deg, var(--accent-glow), var(--accent-purple)); border: none; padding: 12px; border-radius: 10px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-family: 'Orbitron', sans-serif; text-transform: uppercase; }
        
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(0, 229, 255, 0.2); border-top-color: var(--accent-glow); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .skin-info { font-size: 11px; color: var(--text-secondary); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; width: 100%; }
        .skin-counter { font-weight: 600; color: var(--text-primary); }
        .skin-counter .remaining { color: var(--accent-gold); }
        .last-claimer .username { font-weight: 700; color: var(--accent-purple); }
        .form-group.hidden { display: none; }
        
        #info-modal .modal-body { line-height: 1.6; }
        #info-modal-content { padding: 10px; border-radius: 8px; transition: background-color 0.3s; }
        #info-modal-content[contenteditable="true"] { background-color: rgba(0,0,0,0.2); outline: 1px solid var(--accent-purple); }
        #info-modal-content p { margin: 0 0 1em 0; }
        #info-modal-content h4 { color: var(--accent-glow); margin: 1.5em 0 0.5em; font-family: 'Orbitron'; }
        #info-modal-content ul { padding-left: 20px; margin: 0; }
        .modal-footer { padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; }
        .admin-action-btn { background-color: var(--accent-purple); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }

    </style>
</head>
<body>
    <div id="loader-overlay" class="loader-overlay"> <div class="spinner"></div> </div>
    <div id="access-overlay" class="access-overlay hidden">
         <i class="fa-solid fa-shield-halved"></i>
        <h2>–î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù</h2>
        <p>–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
        <a href="/menu" class="back-button">–í–ï–†–ù–£–¢–¨–°–Ø –í –ú–ï–ù–Æ</a>
    </div>

    <div class="container" id="container">
        <div class="header">
            <div class="title-container">
                <h1 class="page-title">–ß–ï–ö–ü–û–ò–ù–¢</h1>
            </div>
            <button id="how-to-earn-btn" class="how-to-earn-button">–ö–ê–ö –ó–ê–†–ê–ë–û–¢–ê–¢–¨?</button>
            <div class="user-stars-balance"> <i class="fa-solid fa-star"></i> <span id="user-stars-count">0</span> </div>
        </div>
        <div id="reward-track" class="reward-track"></div>
    </div>
    
    <div class="admin-controls-wrapper">
        <div id="admin-access-controls" class="admin-controls hidden"> <button id="grant-access-btn">–í—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø</button> </div>
        <div id="admin-controls" class="admin-controls hidden">
            <button id="edit-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="save-btn" class="hidden">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="reward-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reward-modal-title">–ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reward-modal-form" class="modal-form">
                    <label>–£—Ä–æ–≤–µ–Ω—å (—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –∑–≤–µ–∑–¥–∞—Ö)</label>
                    <input type="number" id="reward-level-input" required min="1">
                    
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã</label>
                    <input type="text" id="reward-title-input" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50 –ú–æ–Ω–µ—Ç">

                    <label>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="reward-desc-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞">
                    
                    <label>–ò–∫–æ–Ω–∫–∞/–°–∫–∏–Ω (URL –∫–∞—Ä—Ç–∏–Ω–∫–∏)</label>
                    <input type="text" id="reward-icon-input" required placeholder="https://example.com/icon.png">
                    
                    <label>–¢–∏–ø –Ω–∞–≥—Ä–∞–¥—ã</label>
                    <select id="reward-type-input">
                        <option value="coins">–ú–æ–Ω–µ—Ç—ã</option>
                        <option value="keys">–ö–ª—é—á–∏</option>
                        <option value="cs2_skin">–°–∫–∏–Ω CS2</option>
                        <option value="custom">–î—Ä—É–≥–æ–µ</option>
                    </select>

                    <label>–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã</label>
                    <input type="text" id="reward-value-input" required placeholder="50 –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–Ω–∞">
                    
                    <div id="cs2-skin-fields" class="form-group hidden">
                        <label>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</label>
                        <input type="number" id="reward-total-quantity-input" placeholder="–ù–∞–ø—Ä: 10" min="1">
                        
                        <label>–£–∂–µ –∑–∞–±—Ä–∞–ª–∏ (—à—Ç)</label>
                        <input type="number" id="reward-claimed-quantity-input" placeholder="–ù–∞–ø—Ä: 0" min="0">
                    </div>

                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ß—Ç–æ —Ç–∞–∫–æ–µ "–ß–µ–∫–ø–æ–∏–Ω—Ç"?</h3>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="info-modal-content" contenteditable="false">
                </div>
            </div>
            <div id="info-modal-footer" class="modal-footer hidden">
                 <button id="edit-info-btn" class="admin-action-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                 <button id="save-info-btn" class="admin-action-btn hidden">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
      <a href="/menu" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-house"></i></div><span>–ì–õ–ê–í–ù–ê–Ø</span></a>
      <a href="/events" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-gift"></i></div><span>–ò–í–ï–ù–¢–´</span></a>
      <a href="/checkpoint" class="footer-item active"><div class="icon-wrapper"><i class="fa-solid fa-star"></i></div><span>–ß–ï–ö–ü–û–ò–ù–¢</span></a>
      <a href="/profile" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-user"></i></div><span>–ü–†–û–§–ò–õ–¨</span></a>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let checkpointContent = { rewards: [] };
    let checkpointInfo = "";
    let userData = {};
    let editingRewardIndex = null; 

    const dom = {
        loaderOverlay: document.getElementById('loader-overlay'),
        container: document.getElementById('container'),
        rewardTrack: document.getElementById('reward-track'),
        userStarsCount: document.getElementById('user-stars-count'),
        adminControls: document.getElementById('admin-controls'),
        editBtn: document.getElementById('edit-btn'),
        saveBtn: document.getElementById('save-btn'),
        rewardModal: document.getElementById('reward-modal'),
        rewardModalForm: document.getElementById('reward-modal-form'),
        rewardLevelInput: document.getElementById('reward-level-input'),
        rewardTitleInput: document.getElementById('reward-title-input'),
        rewardDescInput: document.getElementById('reward-desc-input'),
        rewardIconInput: document.getElementById('reward-icon-input'),
        rewardTypeInput: document.getElementById('reward-type-input'),
        rewardValueInput: document.getElementById('reward-value-input'),
        accessOverlay: document.getElementById('access-overlay'),
        adminAccessControls: document.getElementById('admin-access-controls'),
        grantAccessBtn: document.getElementById('grant-access-btn'),
        cs2SkinFields: document.getElementById('cs2-skin-fields'),
        totalQuantityInput: document.getElementById('reward-total-quantity-input'),
        claimedQuantityInput: document.getElementById('reward-claimed-quantity-input'),
        howToEarnBtn: document.getElementById('how-to-earn-btn'),
        infoModal: document.getElementById('info-modal'),
        infoModalContent: document.getElementById('info-modal-content'),
        infoModalFooter: document.getElementById('info-modal-footer'),
        editInfoBtn: document.getElementById('edit-info-btn'),
        saveInfoBtn: document.getElementById('save-info-btn'),
    };
    
    function renderPage() {
        dom.userStarsCount.textContent = userData.checkpoint_stars || 0;
        dom.rewardTrack.innerHTML = '';
        const isEditMode = document.body.classList.contains('edit-mode');
        
        const sortedRewards = [...(checkpointContent.rewards || [])].sort((a, b) => a.level - b.level);
        const claimedLevels = userData.claimed_rewards || [];

        sortedRewards.forEach((reward) => {
            const userStars = userData.checkpoint_stars || 0;

            const isClaimed = claimedLevels.includes(reward.level);
            const isClaimable = !isClaimed && userStars >= reward.level;
            const isLocked = !isClaimed && !isClaimable;
            
            const item = document.createElement('div');
            item.className = 'reward-item';
            if (isClaimed) item.classList.add('is-claimed');
            if (isClaimable) item.classList.add('is-claimable');
            if (isLocked) item.classList.add('is-locked');

            let buttonHtml = '';
            let extraInfoHtml = '';

            if (reward.type === 'cs2_skin') {
                const total = reward.total_quantity || 0;
                const claimed = reward.claimed_quantity || 0;
                const remaining = total - claimed;
                
                let claimerInfo = '';
                if (reward.last_claimer && reward.last_claimer.username) {
                    claimerInfo = `<div class="last-claimer">–ü–æ—Å–ª: <span class="username">${reward.last_claimer.username}</span></div>`;
                }

                extraInfoHtml = `
                    <div class="skin-info">
                        <div class="skin-counter">–û—Å—Ç–∞–ª–æ—Å—å: <span class="remaining">${remaining}</span>/${total}</div>
                        ${claimerInfo}
                    </div>`;
                
                if (remaining <= 0 && !isClaimed) {
                    buttonHtml = `<button class="action-button locked-btn" disabled>–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</button>`;
                }
            }
            
            if (!buttonHtml) {
                if (isClaimed) {
                    buttonHtml = `<button class="action-button claimed-btn" disabled><i class="fa-solid fa-check"></i> –ü–æ–ª—É—á–µ–Ω–æ</button>`;
                } else if (isClaimable) {
                    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º data-reward-type –≤ –∫–Ω–æ–ø–∫—É ---
                    buttonHtml = `<button class="action-button claim-btn" data-level="${reward.level}" data-reward-type="${reward.type}">–ó–∞–±—Ä–∞—Ç—å –∑–∞ ${reward.level} <i class="fa-solid fa-star"></i></button>`;
                } else {
                    buttonHtml = `<button class="action-button locked-btn" disabled>${reward.level} <i class="fa-solid fa-star"></i></button>`;
                }
            }

            const descriptionHtml = reward.description ? `<div class="reward-description">${reward.description}</div>` : '';
            const actualIndex = checkpointContent.rewards.findIndex(r => r === reward);
            const editOverlayHtml = `
                <div class="edit-overlay">
                    <button class="card-btn card-edit-btn" data-actual-index="${actualIndex}"><i class="fa-solid fa-pencil"></i></button>
                    <button class="card-btn card-delete-btn" data-actual-index="${actualIndex}"><i class="fa-solid fa-trash"></i></button>
                </div>`;

            item.innerHTML = `
                <div class="reward-level">LVL ${reward.level}</div>
                ${editOverlayHtml}
                <div class="reward-image-container">
                    <img src="${reward.icon || 'https://i.ibb.co/3s7vXG5/placeholder.png'}" class="reward-image" alt="${reward.title}">
                </div>
                <div class="reward-content">
                    <div class="reward-details">
                        <div class="reward-title">${reward.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                        ${descriptionHtml}
                    </div>
                    ${extraInfoHtml}
                    ${buttonHtml}
                </div>
            `;
            dom.rewardTrack.appendChild(item);
        });

        if (isEditMode) {
             dom.rewardTrack.insertAdjacentHTML('beforeend', `<div class="reward-item create-reward-card"><i class="fa-solid fa-plus" style="font-size: 32px;"></i></div>`);
        }
    }

    function showRewardModal(rewardData, index) {
        editingRewardIndex = index; 
        dom.rewardModal.querySelector('h3').textContent = index === null ? '–ù–û–í–ê–Ø –ù–ê–ì–†–ê–î–ê' : '–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ù–ê–ì–†–ê–î–£';
        
        dom.rewardLevelInput.value = rewardData ? rewardData.level : '';
        dom.rewardTitleInput.value = rewardData ? rewardData.title : '';
        dom.rewardDescInput.value = rewardData ? rewardData.description : '';
        dom.rewardIconInput.value = rewardData ? rewardData.icon : '';
        dom.rewardTypeInput.value = rewardData ? rewardData.type : 'coins';
        dom.rewardValueInput.value = rewardData ? rewardData.value : '';
        
        toggleSkinFields(rewardData ? rewardData.type : 'coins');
        if (rewardData && rewardData.type === 'cs2_skin') {
            dom.totalQuantityInput.value = rewardData.total_quantity || '';
            dom.claimedQuantityInput.value = rewardData.claimed_quantity || '0';
        } else {
            dom.totalQuantityInput.value = '';
            dom.claimedQuantityInput.value = '';
        }

        dom.rewardModal.classList.remove('hidden');
    }

    function toggleSkinFields(type) {
        if (type === 'cs2_skin') {
            dom.cs2SkinFields.classList.remove('hidden');
        } else {
            dom.cs2SkinFields.classList.add('hidden');
        }
    }
    
    function getDefaultInfoText() {
        return `
            <h4>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h4>
            <p>–ß–µ–∫–ø–æ–∏–Ω—Ç ‚Äî —ç—Ç–æ –º–∞—Ä–∞—Ñ–æ–Ω –Ω–∞–≥—Ä–∞–¥. –í—ã–ø–æ–ª–Ω—è–π —á–µ–ª–ª–µ–Ω–¥–∂–∏ –≤–æ –≤—Ä–µ–º—è —Å—Ç—Ä–∏–º–æ–≤, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –∑–≤—ë–∑–¥—ã <i class="fa-solid fa-star" style="color: var(--accent-gold);"></i>.</p>
            <p>–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –∑–≤—ë–∑–¥—ã –º–æ–∂–Ω–æ –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ —Ü–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑—ã. –ß–µ–º –≤—ã—à–µ —É—Ä–æ–≤–µ–Ω—å –Ω–∞–≥—Ä–∞–¥—ã ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –∑–≤—ë–∑–¥ –æ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç.</p>
            <h4>üî• –í–∞–∂–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ!</h4>
            <p>–ü—Ä–æ–≥—Ä–µ—Å—Å –º–∞—Ä–∞—Ñ–æ–Ω–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –¥–æ –Ω—É–ª—è, –µ—Å–ª–∏ —Ç—ã –ø—Ä–æ–ø—É—Å–∫–∞–µ—à—å —á–µ–ª–ª–µ–Ω–¥–∂–∏ –Ω–∞ <b>–¥–≤—É—Ö —Å—Ç—Ä–∏–º–∞—Ö –ø–æ–¥—Ä—è–¥</b>. –û–¥–∏–Ω –ø—Ä–æ–ø—É—Å–∫ ‚Äî –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ –¥–≤–∞ –æ–±–Ω—É–ª—è—é—Ç —Ç–≤–æ–π –ø—É—Ç—å. –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π —Å—Ç—Ä–∏–º—ã, —á—Ç–æ–±—ã –¥–æ–π—Ç–∏ –¥–æ –∫–æ–Ω—Ü–∞!</p>
        `;
    }
    
    async function initialize() {
        dom.loaderOverlay.classList.remove('hidden');
        if (!tg.initData || !tg.initDataUnsafe?.user) {
            console.warn("Local development mode is active.");
            // Mock data for local testing
            userData = { checkpoint_stars: 150, claimed_rewards: [], is_admin: true, is_checkpoint_globally_enabled: true, has_checkpoint_access: true };
            checkpointContent = { rewards: [] };
            checkpointInfo = getDefaultInfoText();
            dom.infoModalContent.innerHTML = checkpointInfo;
            dom.container.classList.add('visible');
            if (userData.is_admin) {
                dom.adminControls.classList.remove('hidden');
                dom.adminAccessControls.classList.remove('hidden');
                dom.infoModalFooter.classList.remove('hidden');
            }
            renderPage();
            dom.loaderOverlay.classList.add('hidden');
            return;
        }

        try {
            const [userRes, contentRes, infoRes] = await Promise.all([
                fetch('/api/v1/user/me', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ initData: tg.initData }) }),
                fetch('/api/v1/checkpoint/content'),
                fetch('/api/v1/checkpoint/info')
            ]);

            if (!userRes.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
            userData = await userRes.json();
            
            const isGloballyEnabled = userData.is_checkpoint_globally_enabled;
            const hasIndividualAccess = userData.has_checkpoint_access;
            const isAdmin = userData.is_admin;

            if (isAdmin || isGloballyEnabled || (!isGloballyEnabled && hasIndividualAccess)) {
                if (!contentRes.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º–∞—Ä–∞—Ñ–æ–Ω–∞.");
                checkpointContent = await contentRes.json();
                
                if (infoRes.ok) {
                    const infoData = await infoRes.json();
                    checkpointInfo = infoData.content || getDefaultInfoText();
                    dom.infoModalContent.innerHTML = checkpointInfo;
                } else {
                    dom.infoModalContent.innerHTML = getDefaultInfoText();
                }

                if (userData.is_admin) dom.infoModalFooter.classList.remove('hidden');
                
                renderPage();
                dom.container.classList.add('visible');

                if (userData.is_admin) {
                    dom.adminControls.classList.remove('hidden');
                    dom.adminAccessControls.classList.remove('hidden');
                }
            } else {
                dom.accessOverlay.classList.remove('hidden');
            }

        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ß–µ–∫–ø–æ–∏–Ω—Ç–∞:", e);
            tg.showAlert(e.message);
            dom.accessOverlay.classList.remove('hidden');
        } finally {
            dom.loaderOverlay.classList.add('hidden');
        }
    }

    dom.howToEarnBtn.addEventListener('click', () => dom.infoModal.classList.remove('hidden'));
    
    dom.editInfoBtn.addEventListener('click', () => {
        dom.infoModalContent.setAttribute('contenteditable', 'true');
        dom.infoModalContent.focus();
        dom.editInfoBtn.classList.add('hidden');
        dom.saveInfoBtn.classList.remove('hidden');
    });

    dom.saveInfoBtn.addEventListener('click', async () => {
        const newContent = dom.infoModalContent.innerHTML;
        dom.saveInfoBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        
        try {
            const response = await fetch('/api/v1/admin/checkpoint/info/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData, content: newContent })
            });
            if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
            
            checkpointInfo = newContent;
            tg.showAlert("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");

        } catch (e) {
            tg.showAlert(e.message);
        } finally {
            dom.infoModalContent.setAttribute('contenteditable', 'false');
            dom.saveInfoBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
            dom.saveInfoBtn.classList.add('hidden');
            dom.editInfoBtn.classList.remove('hidden');
        }
    });

    dom.rewardTypeInput.addEventListener('change', (e) => toggleSkinFields(e.target.value));

    dom.rewardModalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const updatedReward = {
            level: parseInt(dom.rewardLevelInput.value),
            title: dom.rewardTitleInput.value,
            description: dom.rewardDescInput.value,
            icon: dom.rewardIconInput.value,
            type: dom.rewardTypeInput.value,
            value: dom.rewardValueInput.value,
        };
        
        if (updatedReward.type === 'cs2_skin') {
            updatedReward.total_quantity = parseInt(dom.totalQuantityInput.value) || 0;
            updatedReward.claimed_quantity = parseInt(dom.claimedQuantityInput.value) || 0;
        } else {
            updatedReward.total_quantity = null;
            updatedReward.claimed_quantity = null;
        }

        if (editingRewardIndex !== null) {
            checkpointContent.rewards[editingRewardIndex] = updatedReward;
        } else {
            checkpointContent.rewards.push(updatedReward);
        }
        dom.rewardModal.classList.add('hidden');
        renderPage(); 
    });

    dom.editBtn.addEventListener('click', () => {
        document.body.classList.add('edit-mode');
        dom.saveBtn.classList.remove('hidden');
        dom.editBtn.classList.add('hidden');
        renderPage();
    });

    dom.saveBtn.addEventListener('click', async () => {
        tg.MainButton.showProgress();
        try {
            const response = await fetch('/api/v1/admin/checkpoint/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    initData: tg.initData,
                    content: checkpointContent 
                })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
            tg.showAlert('–ú–∞—Ä–∞—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            document.body.classList.remove('edit-mode');
            dom.saveBtn.classList.add('hidden');
            dom.editBtn.classList.remove('hidden');
            renderPage(); 
        } catch(e) {
            tg.showAlert(e.message);
        } finally {
            tg.MainButton.hideProgress();
        }
    });
    
    document.body.addEventListener('click', async (e) => {
        const target = e.target;
        const modal = target.closest('.modal-overlay');
        if (target.matches('.modal-close-btn') || (modal && !target.closest('.modal-content'))) {
            modal.classList.add('hidden');
            return;
        }
        
        if (document.body.classList.contains('edit-mode')) {
            const createCard = target.closest('.create-reward-card');
            if (createCard) {
                showRewardModal(null, null);
                return; 
            }
            
            const editBtn = target.closest('.card-edit-btn');
            if (editBtn) {
                const actualIndex = parseInt(editBtn.dataset.actualIndex);
                if (!isNaN(actualIndex) && checkpointContent.rewards[actualIndex]) {
                    showRewardModal(checkpointContent.rewards[actualIndex], actualIndex);
                }
                return;
            }

            const deleteBtn = target.closest('.card-delete-btn');
            if (deleteBtn) {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–∞–≥—Ä–∞–¥—É?', (ok) => {
                    if (ok) {
                        const actualIndex = parseInt(deleteBtn.dataset.actualIndex);
                         if (!isNaN(actualIndex) && checkpointContent.rewards[actualIndex]) {
                            checkpointContent.rewards.splice(actualIndex, 1);
                            renderPage();
                        }
                    }
                });
                return;
            }
        } 
        
        // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
        // –õ–æ–≤–∏–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–ó–∞–±—Ä–∞—Ç—å"
        const claimBtn = target.closest('.claim-btn');
        if (claimBtn && !claimBtn.disabled) {
            const levelToClaim = parseInt(claimBtn.dataset.level);
            // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –Ω–∞–≥—Ä–∞–¥—ã, –∫–æ—Ç–æ—Ä—ã–π –º—ã –¥–æ–±–∞–≤–∏–ª–∏ —Ä–∞–Ω–µ–µ
            const rewardType = claimBtn.dataset.rewardType;

            // –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–π–¥-—Å—Å—ã–ª–∫—É, –ï–°–õ–ò —ç—Ç–æ —Å–∫–∏–Ω
            if (rewardType === 'cs2_skin' && (!userData.trade_link || userData.trade_link.trim() === '')) {
                tg.showConfirm(
                    "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–∏–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –≤–∞—à—É Steam Trade —Å—Å—ã–ª–∫—É –≤ –ø—Ä–æ—Ñ–∏–ª–µ. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å —Å–µ–π—á–∞—Å?",
                    (ok) => {
                        if (ok) {
                            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ—Ñ–∏–ª—å
                            window.location.href = '/profile';
                        }
                    }
                );
                return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å
            }
            
            // –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ (–∏–ª–∏ —ç—Ç–æ –Ω–µ —Å–∫–∏–Ω), –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            claimBtn.disabled = true;
            claimBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/api/v1/checkpoint/claim', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData, level: levelToClaim })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É.');
                
                // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –Ω–∞–≥—Ä–∞–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (rewardType === 'cs2_skin') {
                    tg.showAlert('–ó–∞—è–≤–∫–∞ –Ω–∞ —Å–∫–∏–Ω –ø—Ä–∏–Ω—è—Ç–∞! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –≤—ã–¥–∞—á–∏.');
                } else {
                    tg.showAlert('–ù–∞–≥—Ä–∞–¥–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞!');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è
                const userRes = await fetch('/api/v1/user/me', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ initData: tg.initData }) });
                userData = await userRes.json();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–∫–∏–Ω–æ–≤
                const contentRes = await fetch('/api/v1/checkpoint/content');
                checkpointContent = await contentRes.json();

                renderPage();
            } catch (error) {
                tg.showAlert(error.message);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                claimBtn.disabled = false;
                claimBtn.innerHTML = `–ó–∞–±—Ä–∞—Ç—å –∑–∞ ${levelToClaim} <i class="fa-solid fa-star"></i>`;
            }
        }
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
    });
    
    dom.grantAccessBtn.addEventListener('click', () => {
        tg.showScanQrPopup({ text: "–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–¥–∞—á–∏ –¥–æ—Å—Ç—É–ø–∞" }, async (qrText) => {
            if (qrText && !isNaN(parseInt(qrText))) {
                tg.MainButton.showProgress();
                try {
                    const response = await fetch('/api/v1/admin/checkpoint/grant-access', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData, user_id_to_grant: parseInt(qrText) })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø.');
                    tg.showAlert(result.message);
                    return true;
                } catch (error) {
                    tg.showAlert(error.message);
                    return false;
                } finally {
                    tg.MainButton.hideProgress();
                }
            } else if (qrText) {
                tg.showAlert("–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ QR-–∫–æ–¥ —Å Telegram ID.");
                return false;
            }
        });
    });

    initialize();
});
</script>
</body>
</html>
