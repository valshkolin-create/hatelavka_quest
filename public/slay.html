<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SLAY AWARDS 2025</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* === –ü–†–ï–ú–ò–£–ú –°–¢–ò–õ–ò === */
        :root {
            --bg: #000000;
            --surface: #121212;
            --surface-light: #222222;
            --gold: #FFD700;
            --gold-dim: #C5A000;
            --gold-gradient: linear-gradient(135deg, #FFD700 0%, #E6AC00 100%);
            --text: #ffffff;
            --text-secondary: #aaaaaa;
            --twitch: #9146FF;
            --danger: #FF3B30;
            --border: rgba(255, 215, 0, 0.15);
            --radius-default: 16px;
            --shadow-gold: 0 4px 20px rgba(255, 215, 0, 0.1);
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 70px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –Ω–∏–∂–Ω–µ–≥–æ –±–∞—Ä–∞ */
            -webkit-font-smoothing: antialiased;
        }

        .container {
            padding: 0 20px;
        }
        
        h1 {
            color: var(--text);
            font-size: 32px;
            font-weight: 700;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* === –ö–ê–†–¢–û–ß–ö–ê –ù–û–ú–ò–ù–ê–¶–ò–ò === */
        .nomination-card {
            background-color: var(--surface);
            border-radius: var(--radius-default);
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-gold);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .nomination-card:active {
            transform: scale(0.98);
        }

        .card-header {
            position: relative;
            height: 200px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤–∏–¥–∞ */
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }
        
        /* === –°–ü–ò–°–û–ö –ö–ê–ù–î–ò–î–ê–¢–û–í === */
        .candidates-list {
            padding: 15px;
            background-color: var(--surface-light);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .candidate-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .candidate-item:last-child {
            border-bottom: none;
        }

        .candidate-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 0;
        }

        .candidate-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .candidate-name {
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .candidate-votes {
            font-size: 14px;
            color: var(--text);
            font-weight: 700;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .vote-button {
            background: var(--gold-gradient);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease, transform 0.2s ease;
            margin-left: 10px;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
        }

        .voted-badge {
            background-color: var(--surface-light);
            color: var(--gold);
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            margin-left: 10px;
        }

        /* === –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ === */
        #admin-panel {
            background-color: var(--surface);
            border-radius: var(--radius-default);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-gold);
        }
        
        /* –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–µ–ª–æ—á–∫–∏: */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .admin-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--gold);
        }

        .admin-toggle-icon {
            transition: transform 0.3s ease;
            color: var(--gold);
            font-size: 18px;
        }

        .admin-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
        }

        .admin-panel.open .admin-toggle-icon {
            transform: rotate(-180deg);
        }

        .admin-panel.open .admin-content {
            max-height: 1000px; /* –ë–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è */
            padding-top: 15px;
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º –≤ –∞–¥–º–∏–Ω–∫–µ */
        .admin-input, .admin-textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: var(--surface-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            box-sizing: border-box;
            resize: vertical;
        }
        
        .admin-textarea {
            min-height: 80px;
        }
        
        .admin-button {
            width: 100%;
            padding: 12px;
            background: var(--gold-gradient);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s ease;
            margin-bottom: 10px;
        }

        .admin-button:active {
            opacity: 0.8;
        }

        .admin-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .admin-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–∏–Ω–∞—Ü–∏–∏ */
        #nomination-edit-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        #nomination-edit-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 15px;
        }
        
        #nomination-edit-list li:last-child {
            border-bottom: none;
        }
        
        .edit-button {
            background-color: var(--gold-dim);
            color: var(--bg);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .edit-button:active {
            background-color: var(--gold);
        }

        /* –°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ */
        .admin-candidate-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .admin-candidate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
        }
        
        .admin-candidate-item:last-child {
            border-bottom: none;
        }

        .admin-candidate-info {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .admin-candidate-info span {
            color: var(--text);
            font-weight: 500;
        }

        .delete-candidate-btn {
            background-color: var(--danger);
            color: var(--text);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s ease;
        }

        .delete-candidate-btn:active {
            opacity: 0.8;
        }

        #search-results div {
            padding: 10px;
            border-bottom: 1px solid var(--surface-light);
        }

        /* === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--surface);
            padding: 25px;
            border-radius: var(--radius-default);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-content h4 {
            margin-top: 0;
            color: var(--gold);
        }
        
        .modal-close-btn {
            float: right;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }

        /* === –ù–ò–ñ–ù–ò–ô –ë–ê–† (1–≤1 –∏–∑ shop) === */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(18, 18, 18, 0.95); /* surface —Å –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 500;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .nav-item i {
            font-size: 22px;
            margin-bottom: 2px;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .nav-item.active {
            color: var(--gold);
        }

        .nav-item.active i {
            color: var(--gold);
            transform: scale(1.05);
        }
        
        /* –õ–æ–∞–¥–µ—Ä */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="page-title">SLAY AWARDS</h1>
        <p class="subtitle" id="page-description">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</p>

        <div id="admin-panel" class="admin-panel">
            <div class="admin-header" onclick="toggleAdminPanel()">
                <h3><i class="fa-solid fa-lock"></i> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <i class="fa-solid fa-chevron-down admin-toggle-icon"></i>
            </div>
            
            <div class="admin-content">
                
                <div class="admin-section">
                    <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h4>
                    <input type="text" id="admin-title" class="admin-input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
                    <textarea id="admin-description" class="admin-textarea" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                    <textarea id="admin-prizes" class="admin-textarea" placeholder='–ü—Ä–∏–∑—ã (JSON: [{"text":"1-–µ –º–µ—Å—Ç–æ", "icon":"ü•á"}, ...])'></textarea>
                    <button class="admin-button" onclick="savePageContent()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>

                <div class="admin-section">
                    <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–∏–Ω–∞—Ü–∏–∏</h4>
                    <ul id="nomination-edit-list">
                        </ul>
                </div>
                
                <div class="admin-section">
                    <h4>–°–æ–∑–¥–∞—Ç—å –Ω–æ–º–∏–Ω–∞—Ü–∏—é</h4>
                    <input type="text" id="new-nomination-title" class="admin-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–º–∏–Ω–∞—Ü–∏–∏">
                    <input type="text" id="new-nomination-image" class="admin-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (URL)">
                    <button class="admin-button" onclick="createNomination()">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="nominations-grid">
            </div>
    </div>
    
    <div id="bottom-nav">
        <a class="nav-item active" href="javascript:void(0)" onclick="switchTab(this, 'slay')">
            <i class="fa-solid fa-trophy"></i>
            <span>Awards</span>
        </a>
        <a class="nav-item" href="javascript:void(0)" onclick="switchTab(this, 'shop')">
            <i class="fa-solid fa-shop"></i>
            <span>–ú–∞–≥–∞–∑–∏–Ω</span>
        </a>
        <a class="nav-item" href="javascript:void(0)" onclick="switchTab(this, 'quests')">
            <i class="fa-solid fa-map"></i>
            <span>–ö–≤–µ—Å—Ç—ã</span>
        </a>
        <a class="nav-item" href="javascript:void(0)" onclick="switchTab(this, 'profile')">
            <i class="fa-solid fa-user"></i>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal()">&times;</button>
            <h4 id="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
            
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="edit-title" class="admin-input">
            
            <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É:</label>
            <input type="text" id="edit-image-url" class="admin-input">
            
            <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="edit-description" class="admin-textarea"></textarea>
            
            <button class="admin-button" onclick="saveNominationInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ</button>

            <hr style="border-color: rgba(255, 255, 255, 0.05); margin: 20px 0;">
            
            <h4>–ö–∞–Ω–¥–∏–¥–∞—Ç—ã:</h4>
            
            <input type="text" id="user-search" class="admin-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Twitch/TG)">
            <div id="search-results" style="margin-bottom: 15px;"></div>
            
            <ul id="current-candidates-list" class="admin-candidate-list">
                </ul>
        </div>
    </div>
    
    <div id="loader" class="loader">
        <div class="spinner"></div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let isAdmin = false;
        let currentEditId = null;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        async function init() {
            try {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.MainButton.hide();
                Telegram.WebApp.setHeaderColor(Telegram.WebApp.themeParams.bg_color);
                Telegram.WebApp.setBackgroundColor(Telegram.WebApp.themeParams.bg_color);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏)
                const user = Telegram.WebApp.initDataUnsafe.user;
                if (user && [/* –¢–£–¢ –î–û–õ–ñ–ù–´ –ë–´–¢–¨ ID –ê–î–ú–ò–ù–û–í */].includes(user.id)) { 
                    isAdmin = true;
                }
                
                document.getElementById('admin-panel').style.display = isAdmin ? 'block' : 'none';

                await loadPageContent();
                await loadNominations();
            } catch (e) {
                console.error("Init Error:", e);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ Telegram WebApp
                document.getElementById('admin-panel').style.display = 'none';
                await loadPageContent();
                await loadNominations();
            }
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–¢–ï–ù–¢–ê ---
        async function loadPageContent() {
            try {
                const response = await fetch('/api/v1/slay/content');
                const data = await response.json();
                
                document.getElementById('page-title').textContent = escapeHTML(data.title || "SLAY AWARDS");
                document.getElementById('page-description').textContent = escapeHTML(data.description || "–ì–ª–∞–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≥–æ–¥–∞.");
                
                if (isAdmin) {
                    document.getElementById('admin-title').value = data.title || "";
                    document.getElementById('admin-description').value = data.description || "";
                    // document.getElementById('admin-badge').value = data.badge || "";
                    document.getElementById('admin-prizes').value = data.prizes || "[]";
                }

            } catch (e) {
                console.error("Error loading page content:", e);
            }
        }

        async function loadNominations() {
            showLoader();
            try {
                const response = await fetch('/api/v1/slay/active', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: Telegram.WebApp.initData || '' })
                });
                const data = await response.json();
                
                renderNominations(data);
                if (isAdmin) renderAdminEditList(data);
                
            } catch (e) {
                console.error("Error loading nominations:", e);
            } finally {
                hideLoader();
            }
        }

        function renderNominations(nominations) {
            const grid = document.getElementById('nominations-grid');
            grid.innerHTML = ''; // –û—á–∏—â–∞–µ–º
            
            nominations.forEach(nom => {
                // –°–æ–∑–¥–∞–µ–º HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ä—Ç–æ—á–∫–∏
                const card = document.createElement('div');
                card.className = 'nomination-card';
                card.innerHTML = `
                    <div class="card-header">
                        <img src="${nom.image_url || 'https://placehold.co/800x400/121212/aaaaaa?text=SLAY+AWARDS'}" class="card-img" onerror="this.src='https://placehold.co/800x400/121212/aaaaaa?text=SLAY+AWARDS'">
                        <div class="card-overlay">
                            <h2 class="card-title">${escapeHTML(nom.title)}</h2>
                        </div>
                    </div>
                    <div class="candidates-list">
                        ${nom.candidates.map(candidate => `
                            <div class="candidate-item">
                                <div class="candidate-info">
                                    <img src="${candidate.photo_url || 'https://placehold.co/40x40/333/666?text=U'}" class="candidate-photo" onerror="this.src='https://placehold.co/40x40/333/666?text=U'">
                                    <span class="candidate-name">${escapeHTML(candidate.name)}</span>
                                </div>
                                <span class="candidate-votes">${candidate.votes}</span>
                                ${nom.has_voted 
                                    ? `<span class="voted-badge"><i class="fa-solid fa-check"></i> –í–∞—à –≥–æ–ª–æ—Å</span>`
                                    : `<button class="vote-button" onclick="vote(${nom.id}, ${candidate.id})">
                                        <i class="fa-solid fa-star"></i> –ì–æ–ª–æ—Å–æ–≤–∞—Ç—å
                                    </button>`
                                }
                            </div>
                        `).join('')}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- –ê–î–ú–ò–ù –õ–û–ì–ò–ö–ê ---
        function toggleAdminPanel() {
            document.getElementById('admin-panel').classList.toggle('open');
        }

        function renderAdminEditList(nominations) {
            const list = document.getElementById('nomination-edit-list');
            list.innerHTML = '';
            nominations.forEach(nom => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${escapeHTML(nom.title)}</span>
                    <button class="edit-button" onclick="openEditModal(${nom.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                `;
                list.appendChild(li);
            });
        }
        
        // --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ---
        async function openEditModal(nominationId) {
            showLoader();
            try {
                const response = await fetch('/api/v1/slay/active', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: Telegram.WebApp.initData || '' })
                });
                const nominations = await response.json();
                const nom = nominations.find(n => n.id === nominationId);
                
                if (!nom) {
                    Telegram.WebApp.showAlert("–ù–æ–º–∏–Ω–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
                    return;
                }
                
                currentEditId = nominationId;
                document.getElementById('modal-title').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${escapeHTML(nom.title)}`;
                document.getElementById('edit-title').value = nom.title;
                document.getElementById('edit-image-url').value = nom.image_url || '';
                document.getElementById('edit-description').value = nom.description || '';
                
                renderAdminCandidates(nom.candidates);

                document.getElementById('edit-modal').classList.add('open');
                Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            } catch (e) {
                console.error("Error opening modal:", e);
                Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.");
            } finally {
                hideLoader();
            }
        }
        
        function closeModal() {
            document.getElementById('edit-modal').classList.remove('open');
            currentEditId = null;
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('user-search').value = '';
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
        
        function renderAdminCandidates(candidates) {
            const list = document.getElementById('current-candidates-list');
            list.innerHTML = '';
            if (candidates.length === 0) {
                list.innerHTML = '<li style="color:var(--text-secondary);">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</li>';
                return;
            }
            
            candidates.forEach(c => {
                const li = document.createElement('li');
                li.className = 'admin-candidate-item';
                li.innerHTML = `
                    <div class="admin-candidate-info">
                        <span>${escapeHTML(c.name)}</span> (@${escapeHTML(c.username)}) - –ì–æ–ª–æ—Å–æ–≤: ${c.votes}
                    </div>
                    <button class="delete-candidate-btn" onclick="deleteCandidate(${c.id})">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                list.appendChild(li);
            });
        }
        
        // --- ADMIN API CALLS ---
        async function savePageContent() {
            showLoader();
            try {
                await fetch('/api/v1/admin/slay/content/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        title: document.getElementById('admin-title').value,
                        description: document.getElementById('admin-description').value,
                        badge: "", // –£–±—Ä–∞–ª–∏ –ø–æ–ª–µ
                        prizes: document.getElementById('admin-prizes').value,
                    })
                });
                Telegram.WebApp.showAlert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
                loadPageContent(); // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            } catch (e) {
                console.error("Save Page Content Error:", e);
                Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            } finally {
                hideLoader();
            }
        }

        async function createNomination() {
            showLoader();
            try {
                await fetch('/api/v1/admin/slay/nomination/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        title: document.getElementById('new-nomination-title').value,
                        image_url: document.getElementById('new-nomination-image').value,
                    })
                });
                Telegram.WebApp.showAlert("‚úÖ –ù–æ–º–∏–Ω–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞!");
                document.getElementById('new-nomination-title').value = '';
                document.getElementById('new-nomination-image').value = '';
                await loadNominations();
            } catch (e) {
                console.error("Create Nomination Error:", e);
                Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è!");
            } finally {
                hideLoader();
            }
        }
        
        async function saveNominationInfo() {
            showLoader();
            if (!currentEditId) return;
            try {
                await fetch('/api/v1/admin/slay/nomination/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        id: currentEditId,
                        title: document.getElementById('edit-title').value,
                        image_url: document.getElementById('edit-image-url').value,
                        description: document.getElementById('edit-description').value,
                    })
                });
                Telegram.WebApp.showAlert("‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
                closeModal();
                await loadNominations(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } catch (e) {
                console.error("Save Nomination Info Error:", e);
                Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            } finally {
                hideLoader();
            }
        }
        
        // –ü–æ–∏—Å–∫ —é–∑–µ—Ä–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        document.getElementById('user-search').addEventListener('input', debounce(async (e) => {
            const query = e.target.value.trim();
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '';
            if (query.length < 3) return;

            try {
                const response = await fetch(`/api/v1/admin/user/search?query=${encodeURIComponent(query)}&initData=${Telegram.WebApp.initData}`);
                const users = await response.json();
                
                if (users.length === 0) {
                    resDiv.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
                    return;
                }

                users.forEach(u => {
                    const div = document.createElement('div');
                    div.style.cssText = "display:flex; justify-content:space-between; align-items:center; color:#fff; border-bottom: 1px solid rgba(255, 255, 255, 0.05);";
                    div.innerHTML = `
                        <div>${escapeHTML(u.full_name)} <span style="color:var(--text-secondary); font-size:10px;">${u.twitch_login || ''}</span></div>
                        <button style="background:var(--gold); color:#000; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="addCandidate(${u.telegram_id})">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    `;
                    resDiv.appendChild(div);
                });
            } catch (e) {
                console.error("User Search Error:", e);
            }
        }, 300)); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300 –º—Å

        async function addCandidate(uid) {
            showLoader();
            if(!currentEditId) return;
            try {
                await fetch('/api/v1/admin/slay/candidate/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        nomination_id: currentEditId,
                        user_id: uid
                    })
                });
                Telegram.WebApp.showAlert("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω!");
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                await openEditModal(currentEditId); 
            } catch (e) {
                console.error("Add Candidate Error:", e);
                Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è!");
            } finally {
                hideLoader();
            }
        }
        
        async function deleteCandidate(candidateId) {
            showLoader();
            if(!currentEditId) return;
            try {
                await fetch('/api/v1/admin/slay/candidate/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        candidate_id: candidateId
                    })
                });
                Telegram.WebApp.showAlert("‚ùå –ö–∞–Ω–¥–∏–¥–∞—Ç —É–¥–∞–ª–µ–Ω!");
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–∞–ª–∫—É
                await openEditModal(currentEditId); 
            } catch (e) {
                console.error("Delete Candidate Error:", e);
                Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è!");
            } finally {
                hideLoader();
            }
        }

        // --- –ì–û–õ–û–°–û–í–ê–ù–ò–ï ---
        async function vote(nominationId, candidateId) {
            Telegram.WebApp.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–¥–∞—Ç—å —Å–≤–æ–π –≥–æ–ª–æ—Å –∑–∞ —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞? –ì–æ–ª–æ—Å –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å.`, async (ok) => {
                if (ok) {
                    showLoader();
                    try {
                        const response = await fetch('/api/v1/slay/vote', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                initData: Telegram.WebApp.initData,
                                nomination_id: nominationId,
                                candidate_id: candidateId
                            })
                        });
                        
                        if (response.ok) {
                            Telegram.WebApp.showAlert("‚úÖ –í–∞—à –≥–æ–ª–æ—Å —É—á—Ç–µ–Ω!");
                            await loadNominations(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                        } else {
                            const errorData = await response.json();
                            Telegram.WebApp.showAlert(`–û—à–∏–±–∫–∞: ${errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å.'}`);
                        }
                    } catch (e) {
                        console.error("Vote Error:", e);
                        Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞!");
                    } finally {
                        hideLoader();
                    }
                }
            });
        }
        
        // --- –£–¢–ò–õ–ò–¢–´ ---
        function switchTab(el, tabName) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç—É—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ SPA-–ª–æ–≥–∏–∫–∞
            // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            el.classList.add('active');
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Ç—É—Ç: window.location.href = `/${tabName}.html`;
            Telegram.WebApp.showAlert(`–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤–∫–ª–∞–¥–∫—É: ${tabName}`);
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function escapeHTML(str) {
            if (str === null || str === undefined) return "";
            return String(str).replace(/[&<>\"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', "'": '&#39;' }[m]));
        }

        function showLoader() {
            document.getElementById('loader').classList.add('active');
        }

        function hideLoader() {
            document.getElementById('loader').classList.remove('active');
        }

        // --- –ó–ê–ü–£–°–ö ---
        init();
    </script>
</body>
</html>
