<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OBS Cauldron Overlay</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Базовые стили */
        body {
            background-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            margin: 0;
        }
        #overlay-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 450px;
        }

        /* Контейнер виджета */
        #widget-container {
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }

        /* Котел */
        #cauldron-image {
            width: 150px;
            height: auto;
            animation: float 4s ease-in-out infinite;
            transition: filter 0.3s ease, transform 0.3s ease;
        }
        /* Анимация пульсации котла при вкладе */
        #cauldron-image.pulse {
            animation: float 4s ease-in-out infinite, cauldron-pulse 0.7s ease-out;
        }

        /* Информационный блок */
        #info-widget {
            flex-grow: 1;
            background-color: rgba(18, 16, 33, 0.85);
            border: 1px solid #bf5af2;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 0 25px rgba(191, 90, 242, 0.5);
            backdrop-filter: blur(10px);
            color: white;
            text-shadow: 1px 1px 3px #000;
        }
        #event-title {
            margin: 0 0 10px 0;
            font-size: 20px;
            text-align: center;
            font-weight: 700;
            color: #ff9500;
            text-shadow: 0 0 8px rgba(255, 149, 0, 0.7);
        }
        .progress-bar-container {
            width: 100%;
            background-color: rgba(0,0,0,0.4);
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
        }
        #progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #bf5af2, #ff9500);
            border-radius: 8px;
            transition: width 0.5s ease-out;
        }
        #progress-text {
            margin-top: 5px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }

        /* Анимация летящей фласки (как на halloween.html) */
        #flying-flask {
            position: fixed;
            width: 60px;
            height: auto;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            /* Начальная позиция за экраном */
            top: 20%;
            left: -100px; 
        }
        #flying-flask.animate {
            /* Анимация полета к котлу */
            animation: fly-in 1.2s cubic-bezier(0.5, -0.5, 1, 1);
        }

        /* Ключевые кадры анимаций */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes cauldron-pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.7) drop-shadow(0 0 25px #ff9500); }
        }
        /* Исправленная анимация полета */
        @keyframes fly-in {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1.2) rotate(0deg);
            }
            100% {
                opacity: 0;
                /* Конечная точка полета - примерные координаты котла */
                transform: translate(180px, 150px) scale(0.2) rotate(720deg);
            }
        }
    </style>
</head>
<body>

    <div id="overlay-container">
        <img id="flying-flask" src="https://i.postimg.cc/XYxLQYTF/giphy-flusk.gif" alt="Animating flask">

        <div id="widget-container">
            <img id="cauldron-image" src="" alt="Cauldron">
            <div id="info-widget">
                <h1 id="event-title">...</h1>
                <div class="progress-bar-container">
                    <div id="progress-bar-fill"></div>
                </div>
                <div id="progress-text">0 / 0</div>
            </div>
        </div>
    </div>

    <script>
        // --- НАСТРОЙКИ SUPABASE (как в вашей рулетке) ---
        const SUPABASE_URL = 'https://pyeuckjcrsiaseyqrsek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZXVja2pjcnNpYXNleXFyc2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzEyOTgsImV4cCI6MjA3MDA0NzI5OH0.srRwuUygiF7jr3-b2AwyRNAmrChlW3Bzp3I-9Ju2TVg';

        const dom = {
            title: document.getElementById('event-title'),
            progressBar: document.getElementById('progress-bar-fill'),
            progressText: document.getElementById('progress-text'),
            cauldronImage: document.getElementById('cauldron-image'),
            flyingFlask: document.getElementById('flying-flask'),
        };

        let isAnimating = false;
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Логика для определения текущего уровня (взята из вашего halloween.js) ---
        function getCurrentLevel(eventData) {
            const { goals = {}, current_progress = 0 } = eventData;
            if (goals.level_2 && current_progress >= goals.level_2) return 3;
            if (goals.level_1 && current_progress >= goals.level_1) return 2;
            return 1;
        }
        
        // --- Главная функция обновления всего UI ---
        function updateDisplay(eventData) {
            if (!eventData || !eventData.is_visible_to_users) {
                // Если ивент неактивен, просто скрываем виджет, но не удаляем его
                document.getElementById('widget-container').style.opacity = '0';
                return;
            }
            document.getElementById('widget-container').style.opacity = '1';

            const currentLevel = getCurrentLevel(eventData);
            dom.title.textContent = eventData.title || "Ведьминский Котел";

            // ИСПРАВЛЕНО: Правильно выбираем URL котла из данных
            const cauldronUrl = eventData[`cauldron_image_url_${currentLevel}`] 
                               || eventData.cauldron_image_url 
                               || 'https://i.postimg.cc/d1G5DRk1/magic-pot.png'; // Резервный URL
            
            if (dom.cauldronImage.src !== cauldronUrl) {
                dom.cauldronImage.src = cauldronUrl;
            }

            const { goals = {}, current_progress = 0 } = eventData;
            let currentGoal = 1, prevGoal = 0;
            if (currentLevel === 1) { currentGoal = goals.level_1 || 1; prevGoal = 0; }
            else if (currentLevel === 2) { currentGoal = goals.level_2 || goals.level_1; prevGoal = goals.level_1; }
            else if (currentLevel === 3) { currentGoal = goals.level_3 || goals.level_2; prevGoal = goals.level_2; }

            const progressInLevel = current_progress - prevGoal;
            const goalForLevel = currentGoal - prevGoal;
            const percentage = (goalForLevel > 0) ? Math.min((progressInLevel / goalForLevel) * 100, 100) : 0;
            
            dom.progressBar.style.width = `${percentage}%`;
            dom.progressText.textContent = `${current_progress} / ${currentGoal}`;
        }
        
        // --- Функция запуска анимации ---
        function triggerAnimation(payload) {
            if (isAnimating) return;
            isAnimating = true;

            const { event_data } = payload.new.payload;
            
            // Сначала обновляем все данные на экране
            updateDisplay(event_data);
            
            // Затем запускаем анимацию фласки и пульсацию котла
            dom.flyingFlask.classList.add('animate');
            dom.cauldronImage.classList.add('pulse');

            // Убираем классы анимации после ее завершения
            setTimeout(() => {
                dom.flyingFlask.classList.remove('animate');
                dom.cauldronImage.classList.remove('pulse');
                isAnimating = false;
            }, 1500); // Длительность анимации
        }

        // --- Функция для загрузки начального состояния ивента ---
        async function loadInitialState() {
            console.log('Loading initial state...');
            const { data, error } = await supabaseClient
                .from('pages_content')
                .select('content')
                .eq('page_name', 'cauldron_event')
                .single();

            if (error) {
                console.error('Error loading initial state:', error);
                return;
            }

            if (data && data.content) {
                console.log('Initial state loaded:', data.content);
                updateDisplay(data.content);
            }
        }

        // --- Подключение к Supabase (как в рулетке) ---
        try {
            console.log('Connecting to Supabase...');
            supabaseClient.channel('cauldron-triggers-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'cauldron_triggers' },
                    payload => {
                        console.log('New cauldron trigger received!', payload);
                        triggerAnimation(payload);
                    }
                ).subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Successfully subscribed to cauldron_triggers!');
                        // Загружаем начальное состояние ПОСЛЕ успешной подписки
                        loadInitialState();
                    }
                });
        } catch (error) { 
            console.error("Failed to connect or subscribe to Supabase:", error); 
        }

    </script>
</body>
</html>
