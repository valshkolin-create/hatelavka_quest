<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Telegram Вызов</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <link rel="stylesheet" href="quest.css" />

<style>
    /* Доп. стили специфичные для этой страницы */
    body {
        background-color: #000; /* Черный фон как в лидерборде */
        color: #fff;
    }

    #main-content {
        padding: 20px 15px 120px 15px; /* Отступы под футер */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        box-sizing: border-box;
    }

    /* Слайдер Контейнер */
    .slider-wrapper {
        background: rgba(28, 28, 30, 0.75); /* surface-glass-bg */
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        margin-top: 20px;
    }

    /* Огромная цифра */
    .count-display {
        font-size: 80px;
        font-weight: 900;
        color: var(--tg-color, #0088cc);
        text-shadow: 0 0 30px rgba(0, 136, 204, 0.2);
        line-height: 1;
        margin: 10px 0;
    }
    
    /* Инпут */
    input[type=range] {
        width: 100%;
        -webkit-appearance: none;
        background: #2c2c2e;
        height: 10px;
        border-radius: 5px;
        outline: none;
        margin: 20px 0;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 32px;
        height: 32px;
        background: #fff;
        border: 4px solid var(--tg-color, #0088cc);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(0, 136, 204, 0.5);
    }

    /* Блок награды */
    .reward-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        padding: 8px 16px;
        border-radius: 20px;
        color: #FFD700;
        font-weight: 700;
        font-size: 18px;
    }

    /* Кнопка внизу */
    .action-btn {
        width: 100%;
        padding: 16px;
        font-size: 16px;
        font-weight: 700;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        text-transform: uppercase;
        margin-top: auto; /* Прижимаем к низу */
        background: linear-gradient(90deg, #0088cc, #00aaff);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
    }
    .action-btn:disabled {
        background: #333;
        color: #666;
        box-shadow: none;
    }

    /* Хедер навигации */
    .nav-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    .back-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: #fff;
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Анимации */
    .fade-in { animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<main id="main-content">
    
    <div class="nav-header">
        <button class="back-btn" onclick="window.location.href='/quests'">
            <i class="fa-solid fa-arrow-left"></i> Назад
        </button>
    </div>

    <div style="text-align: center; margin-bottom: 20px;">
        <h1 style="margin: 0; font-size: 24px;">Telegram Вызов</h1>
        <p style="margin: 5px 0 0; color: #888; font-size: 13px;">Установи цель и забирай награду</p>
    </div>

    <div id="dynamic-content" style="flex-grow: 1; display: flex; flex-direction: column;">
        <div style="margin: auto; color: #666;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px;"></i>
        </div>
    </div>

</main>

<footer class="app-footer">
    <a href="/leaderboard" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div><span>Лидерборд</span></a>
    <a href="/quests" class="footer-item active"><div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div><span>Задания</span></a>
    <a href="/menu" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-house"></i></div><span>Главная</span></a>
    <a href="/events" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div><span>Гринд</span></a>
    <a href="/auction" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div><span>Аукцион</span></a>
</footer>

<script>
    // Инициализация
    if (window.Telegram?.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.setHeaderColor('#000000'); 
        Telegram.WebApp.setBackgroundColor('#000000');
    }

    const container = document.getElementById('dynamic-content');
    
    // Коэффициент награды (100 сообщ = 10 билетов)
    const REWARD_RATIO = 0.1; 

    // --- 1. ГЛАВНАЯ ФУНКЦИЯ ЗАГРУЗКИ ---
    async function loadState() {
        try {
            // Запрашиваем статус у твоего нового эндпоинта
            const res = await fetch('/api/v1/tg/challenge/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ initData: Telegram.WebApp.initData })
            });

            if (!res.ok) throw new Error("Ошибка сети");
            const data = await res.json();

            // Если квест активен -> Рисуем Карточку Прогресса
            if (data.active) {
                renderActiveQuest(data);
            } 
            // Если квеста нет -> Рисуем Слайдер
            else {
                renderSlider();
            }

        } catch (e) {
            container.innerHTML = `<div style="text-align:center; color:red; margin:auto;">Ошибка: ${e.message}</div>`;
        }
    }

    // --- 2. РЕНДЕР СЛАЙДЕРА ---
    function renderSlider() {
        container.innerHTML = `
            <div class="slider-wrapper fade-in">
                <div style="font-size:12px; color:#aaa; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">Цель</div>
                <div class="count-display" id="val-display">100</div>
                <div style="font-size:14px; color:#fff;">сообщений в чате</div>

                <input type="range" id="slider" min="10" max="500" step="10" value="100">

                <div style="margin-top: 30px;">
                    <div class="reward-pill">
                        <span id="reward-display">+10</span> 
                        <i class="fa-solid fa-ticket"></i>
                    </div>
                    <div style="margin-top:8px; font-size:11px; color:#666;">Награда за выполнение</div>
                </div>
            </div>

            <div style="background: rgba(0, 136, 204, 0.1); border: 1px solid rgba(0, 136, 204, 0.3); border-radius: 10px; padding: 12px; margin-top: 20px; font-size: 12px; color: #8ecae6; line-height: 1.4;">
                <i class="fa-solid fa-circle-info" style="margin-right: 5px;"></i>
                Сообщения считаются автоматически. Выбери цель, которую реально сможешь выполнить!
            </div>

            <button id="btn-start" class="action-btn">
                ПРИНЯТЬ ВЫЗОВ
            </button>
        `;

        const slider = document.getElementById('slider');
        const valDisplay = document.getElementById('val-display');
        const rewardDisplay = document.getElementById('reward-display');
        const btn = document.getElementById('btn-start');

        // Логика пересчета
        slider.oninput = () => {
            const val = parseInt(slider.value);
            valDisplay.innerText = val;
            
            // Расчет: минимум 1 билет
            let reward = Math.floor(val * REWARD_RATIO);
            if (reward < 1) reward = 1;
            
            rewardDisplay.innerText = `+${reward}`;
            
            // Вибрация
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        };

        // Логика старта
        btn.onclick = async () => {
            const amount = parseInt(slider.value);
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';

            try {
                const res = await fetch('/api/v1/tg/challenge/commit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        initData: Telegram.WebApp.initData,
                        amount: amount
                    })
                });

                if (!res.ok) throw new Error("Ошибка сервера");
                
                // Успех -> Перезагружаем интерфейс (покажет активный квест)
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
                loadState();

            } catch (e) {
                Telegram.WebApp.showAlert("Не удалось создать вызов: " + e.message);
                btn.disabled = false;
                btn.innerText = "ПРИНЯТЬ ВЫЗОВ";
            }
        };
    }

    // --- 3. РЕНДЕР АКТИВНОГО КВЕСТА (Стиль quest.css) ---
    function renderActiveQuest(data) {
        // Мы используем HTML структуру из quest.js, чтобы классы .quest-card, .progress-bar подхватились из quest.css
        
        const isDone = data.current >= data.target;
        
        let btnHtml = '';
        if (isDone) {
            // Если выполнено - кнопка забрать (используем существующий API квестов или промокодов)
            // Но тут у нас ID 999. Нужно решить, как забирать.
            // Для простоты, покажем "Забрать" и вызовем обычный claim (надо будет адаптировать API под ID 999)
            // В твоем случае лучше использовать /api/v1/promocode с quest_id=999
            
            btnHtml = `
                <button onclick="claimReward()" class="claim-reward-button" style="width:100%; margin-top:15px;">
                    <i class="fa-solid fa-gift"></i> ЗАБРАТЬ НАГРАДУ
                </button>
            `;
        } else {
            btnHtml = `
                <button disabled class="claim-reward-button" style="width:100%; margin-top:15px; background:#333; color:#777; box-shadow:none;">
                    В ПРОЦЕССЕ...
                </button>
            `;
        }

        container.innerHTML = `
            <div style="margin: auto; width: 100%; max-width: 400px;" class="fade-in">
                
                <div class="quest-card" style="padding: 20px; border: 1px solid var(--tg-color);">
                    
                    <div class="quest-content-wrapper">
                        <div class="quest-icon" style="font-size: 32px; margin-bottom: 10px;">
                            <i class="fa-brands fa-telegram"></i>
                        </div>
                        
                        <h2 class="quest-title" style="font-size: 18px;">Персональный Вызов</h2>
                        <p class="quest-subtitle" style="font-size: 13px;">Написать ${data.target} сообщений</p>
                        
                        <div class="progress-bar" style="height: 12px; margin: 15px 0;">
                            <div class="progress-fill" style="width: ${data.percent}%;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 14px; margin-top: 5px;">
                            <span>${data.current} / ${data.target}</span>
                            <span style="color: #FFD700;">+${data.reward} <i class="fa-solid fa-ticket"></i></span>
                        </div>
                    </div>

                    ${btnHtml}
                    
                </div>

                <p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">
                    Прогресс обновляется автоматически при отправке сообщений.
                </p>
            </div>
        `;
    }

    // Функция клейма (использует стандартный механизм квестов)
    window.claimReward = async () => {
        const btn = document.querySelector('.claim-reward-button');
        if(btn) { btn.disabled = true; btn.innerHTML = '...'; }

        try {
            // Используем стандартный эндпоинт квестов, так как мы записали это в user_quest_progress
            // ID квеста = 999 (как мы договорились в SQL)
            const res = await fetch('/api/v1/promocode', { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    initData: Telegram.WebApp.initData,
                    quest_id: 999 
                })
            });

            const result = await res.json();
            
            if (res.ok) {
                Telegram.WebApp.showAlert("Награда получена!");
                loadState(); // Перезагрузка
            } else {
                throw new Error(result.detail || "Ошибка");
            }
        } catch (e) {
            Telegram.WebApp.showAlert("Ошибка: " + e.message);
            if(btn) { btn.disabled = false; btn.innerText = "ЗАБРАТЬ"; }
        }
    };

    // Старт
    loadState();

</script>
</body>
</html>
