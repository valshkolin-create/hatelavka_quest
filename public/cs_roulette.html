<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CS:GO Case Opening</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- GLOBAL & FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap');

        :root {
            --gold-gradient: linear-gradient(180deg, #FFD700 0%, #E6AC00 100%);
            --orange-btn: linear-gradient(180deg, #FFB800 0%, #FF8A00 100%);
            --orange-shadow: 0px 0px 25px rgba(255, 138, 0, 0.4);
            
            /* Цвета редкости */
            --rarity-blue: #4b69ff;
            --rarity-purple: #8847ff;
            --rarity-pink: #d32ce6;
            --rarity-red: #eb4b4b;
            --rarity-gold: #e4ae39;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        /* --- BACKGROUND MANAGER --- */
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center top; 
            background-repeat: no-repeat;
            z-index: -1;
        }
        
        .bg-agent { background-image: url('https://i.postimg.cc/P5KJKbcQ/kartinka-bez-knopki.png'); }
        .bg-street { background-image: url('https://i.postimg.cc/x1sjLfJL/3.png'); }

        /* --- SCREENS CONFIG --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease;
            box-sizing: border-box;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        #screen-input {
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 150px;
            padding-bottom: calc(150px + env(safe-area-inset-bottom));
        }

        @media (max-width: 768px) {
            #screen-input {
                justify-content: flex-start !important; 
                padding-top: 50vh; 
                padding-bottom: 0 !important;
            }
        }

        #screen-action {
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 150px;
            padding-bottom: calc(150px + env(safe-area-inset-bottom));
        }

        #screen-roulette {
            justify-content: center;
            align-items: center;
        }

        /* --- INPUT STYLES --- */
        .input-wrapper { width: 90%; max-width: 380px; text-align: center; margin: 0 auto; }
        
        .custom-input {
            width: 100%;
            background: rgba(10, 10, 10, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px 0;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px; font-weight: 700;
            text-align: center; text-transform: uppercase; letter-spacing: 1px;
            outline: none; backdrop-filter: blur(10px);
            transition: all 0.3s;
            box-sizing: border-box; 
            display: block;
            cursor: pointer;
            user-select: none;
            color: rgba(255, 255, 255, 0.7);
        }

        .custom-input:focus, .custom-input:active {
            background: rgba(0, 0, 0, 0.9);
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        /* --- БЛОК БУСТОВ (Твой дизайн) --- */
        .boost-container {
            width: 100%;
            margin-top: 30px;
            text-align: center;
        }

        .boost-title-main {
            font-size: 10px;
            font-weight: 800;
            color: #ffd700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            opacity: 0.9;
        }

        .boost-minimal-wrapper {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .boost-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            width: 85px;
            position: relative;
        }
        
        .boost-icon {
            font-size: 26px;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.3);
            transition: 0.3s;
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
        }

        .boost-label {
            font-size: 9px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.3;
            transition: 0.3s;
        }
        
        .boost-percent {
            font-size: 9px;
            font-weight: 800;
            color: #444;
            margin-top: 3px;
            transition: 0.3s;
        }

        /* АКТИВНОЕ СОСТОЯНИЕ */
        .boost-item.active .boost-icon {
            color: #ffd700;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
            transform: scale(1.1);
        }
        .boost-item.active .boost-label { color: #fff; }
        .boost-item.active .boost-percent {
            color: #55ff55;
            text-shadow: 0 0 5px rgba(85, 255, 85, 0.3);
        }

        .boost-check-mini {
            position: absolute;
            top: -2px; right: 20px;
            background: #ffd700; color: #000;
            width: 12px; height: 12px; border-radius: 50%;
            font-size: 8px; display: none;
            align-items: center; justify-content: center;
        }
        .boost-item.active .boost-check-mini { display: flex; }

        /* --- КРАСИВОЕ МОДАЛЬНОЕ ОКНО ПРОВЕРКИ (ИЗ QUESTS.JS) --- */
        .check-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 99999;
            display: none; 
            justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
            opacity: 0; transition: opacity 0.3s ease;
        }
        .check-overlay.active { display: flex; opacity: 1; }

        .check-content {
            background: #1c1c1e;
            color: #fff;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            width: 85%; max-width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .check-overlay.active .check-content { transform: scale(1); }

        .check-close {
            position: absolute; top: 10px; right: 10px;
            width: 30px; height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
            cursor: pointer; color: #aaa;
        }

        .check-icon { font-size: 40px; margin-bottom: 15px; color: #ff4757; }
        .check-title { margin-top: 0; color: #fff; font-size: 18px; font-weight: 800; margin-bottom: 10px; text-transform: uppercase; }
        .check-text { font-size: 13px; line-height: 1.5; color: #bbb; margin-bottom: 20px; }

        .check-btn {
            width: 100%;
            background: #0088cc;
            color: white; border: none;
            padding: 14px; border-radius: 12px;
            margin-bottom: 10px;
            font-weight: 700; font-size: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .check-btn:active { transform: scale(0.96); opacity: 0.9; }
        .check-btn.secondary { background: rgba(255,255,255,0.1); color: #ccc; }


        /* --- BUTTON STYLES --- */
        .main-btn {
            background: var(--orange-btn);
            box-shadow: var(--orange-shadow);
            border: none; border-radius: 16px;
            padding: 22px 0;
            width: 90%; max-width: 380px;
            color: #111;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.97); }

        /* --- ROULETTE STYLES --- */
        .roulette-container {
            width: 100%;
            position: relative;
            transform: translateY(20px);
        }

        .roulette-window {
            width: 100%;
            height: 160px;
            background: #0e1621;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            overflow: hidden;
            position: relative;
            display: flex; align-items: center;
        }
        
        .center-marker {
            position: absolute; left: 50%; top: 0; bottom: 0;
            width: 4px; background: #ffd700;
            z-index: 20; transform: translateX(-50%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        .marker-arrow {
            position: absolute; top: -1px; left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #ffd700;
            z-index: 21;
        }

        .track {
            display: flex; height: 100%; align-items: center;
            will-change: transform;
            padding-left: 50vw;
        }

        .card {
            width: 130px; height: 130px;
            margin: 0 5px;
            background-color: #1f2936;
            border-radius: 12px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; flex-shrink: 0;
            border-bottom: 3px solid transparent; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .card img {
            width: 90px; height: auto; 
            max-height: 70px; object-fit: contain;
            margin-bottom: 10px; z-index: 2;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        
        .card-name {
            font-size: 10px; color: #ccc; text-align: center;
            width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-weight: 700; z-index: 2;
        }

        .card.blue { border-bottom-color: var(--rarity-blue); background: radial-gradient(circle at bottom, rgba(75, 105, 255, 0.25) 0%, rgba(31, 41, 54, 1) 70%); }
        .card.purple { border-bottom-color: var(--rarity-purple); background: radial-gradient(circle at bottom, rgba(136, 71, 255, 0.25) 0%, rgba(31, 41, 54, 1) 70%); }
        .card.pink { border-bottom-color: var(--rarity-pink); background: radial-gradient(circle at bottom, rgba(211, 44, 230, 0.25) 0%, rgba(31, 41, 54, 1) 70%); }
        .card.red { border-bottom-color: var(--rarity-red); background: radial-gradient(circle at bottom, rgba(235, 75, 75, 0.25) 0%, rgba(31, 41, 54, 1) 70%); }
        .card.gold { border-bottom-color: var(--rarity-gold); background: radial-gradient(circle at bottom, rgba(228, 174, 57, 0.25) 0%, rgba(31, 41, 54, 1) 70%); }

        /* --- MODAL INPUT ERROR --- */
        #code-error {
            color: #ff5555;
            font-size: 10px;
            margin-top: 5px;
            font-weight: 700;
            height: 12px;
            text-transform: uppercase;
        }
        .valid-code { border-color: #55ff55 !important; box-shadow: 0 0 10px rgba(85,255,85,0.2) !important; }
        .invalid-code { border-color: #ff5555 !important; box-shadow: 0 0 10px rgba(255,85,85,0.2) !important; }

        /* --- UPDATED INPUTS --- */
        .input-inner-wrapper { position: relative; width: 100%; margin: 10px 0; }
        .pass-input { 
            width: 100%; height: 40px; 
            padding: 0 40px 0 10px; 
            background: #2c2c2e; border: 1px solid #444; 
            color: #fff; border-radius: 8px; 
            text-align: center; font-size: 14px; font-weight: 700;
            outline: none; box-sizing: border-box; transition: 0.3s;
        }
        .paste-btn-inside {
            position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
            background: rgba(255, 215, 0, 0.1); color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.3);
            width: 28px; height: 28px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 12px; transition: 0.2s; z-index: 10;
        }
        .paste-btn-inside:active { background: rgba(255, 215, 0, 0.3); transform: translateY(-50%) scale(0.9); }

        /* --- WIN MODAL --- */
        .win-img { width: 100%; height: 160px; object-fit: contain; margin: 0 0 15px 0; filter: drop-shadow(0 0 25px rgba(255,215,0,0.4)); animation: floatItem 3s infinite ease-in-out; }
        @keyframes floatItem { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .win-name-large { 
            font-size: 26px; font-weight: 900; color: #ffd700; 
            text-transform: uppercase; line-height: 1.1; margin-bottom: 5px;
            text-shadow: 0 0 25px rgba(255,215,0,0.4);
        }
        .win-details { font-size: 13px; color: #bbb; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 20px; }
        
        .trade-warning {
            color: #eb4b4b; font-size: 11px; font-weight: 700;
            background: rgba(235, 75, 75, 0.15); padding: 8px;
            border-radius: 6px; margin-bottom: 10px;
            border: 1px solid #eb4b4b; display: none; 
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-box { background: #1c1c1e; padding: 25px; border-radius: 16px; width: 85%; max-width: 350px; text-align: center; border: 1px solid #333; position: relative; box-sizing: border-box;}
        
        .modal-btn { padding: 12px; width: 100%; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-gold { background: var(--orange-btn); color: #000; }
        .btn-grey { background: #333; color: #fff; margin-top: 10px; }
        
        /* ADMIN */
        .admin-wrapper { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column-reverse; align-items: center; gap: 12px; }
        .admin-fab-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(20, 20, 20, 0.8); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .admin-menu-items { opacity: 0; transform: translateY(10px); pointer-events: none; transition: 0.3s; display: flex; flex-direction: column; gap: 10px; }
        .admin-menu-items.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .admin-skins-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 350px; overflow-y: auto; padding: 5px; box-sizing: border-box; width: 100%; }
        .admin-skin-card { background: #252525; border: 2px solid transparent; border-radius: 10px; padding: 8px 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: transform 0.1s; min-width: 0; }
        .admin-skin-card:active { transform: scale(0.95); }
        .admin-skin-img { width: 100%; height: 50px; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .admin-skin-name { font-size: 9px; color: #ddd; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .admin-add-card { border: 2px dashed #555; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; color: #888; font-size: 24px; min-height: 80px; }
        
        .admin-input-group { margin-bottom: 12px; text-align: left; }
        .admin-input-group label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; display: block; }
        .admin-input-group input, .admin-input-group select, .admin-input-group textarea { width: 100%; background: #252525; border: 1px solid #444; padding: 10px; color: #fff; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; }
        .admin-input-group textarea { resize: vertical; min-height: 80px; font-family: monospace; }
        .admin-row { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .admin-list { max-height: 250px; overflow-y: auto; }
        .copy-link-btn { background: #222; color: var(--rarity-gold); border: 1px solid #444; padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; margin-left: 5px; }

    </style>
</head>
<body>

    <div id="bg-layer" class="bg-agent"></div>

    <div id="screen-input" class="screen active">
        <div class="input-wrapper">
            <div class="custom-input" onclick="openCodeEntry()">
                ВВЕДИ СЕКРЕТНЫЙ КОД
            </div>
        </div>
        <div style="margin-top: 15px; color: rgba(255,255,255,0.5); font-size: 11px; text-align: center; text-transform: uppercase; letter-spacing: 1px;">
            Нажми, чтобы ввести код
        </div>

        <div class="boost-container">
            <div class="boost-title-main">УВЕЛИЧЬ СЕБЕ ШАНСЫ НА ДРОП</div>
            
            <div class="boost-minimal-wrapper">
                
                <div id="boost-twitch" class="boost-item" onclick="openTwitch()">
                    <div class="boost-check-mini"><i class="fa-solid fa-check"></i></div>
                    <div class="boost-icon"><i class="fa-brands fa-twitch"></i></div>
                    <div class="boost-label">Twitch<br>Подписка</div>
                    <div class="boost-percent" id="val-twitch">+15%</div>
                </div>

                <div id="boost-tg" class="boost-item" onclick="handleBoostClick('tg')">
                    <div class="boost-check-mini"><i class="fa-solid fa-check"></i></div>
                    <div class="boost-icon"><i class="fa-brands fa-telegram"></i></div>
                    <div class="boost-label">TG<br>Канал</div>
                    <div class="boost-percent" id="val-tg">+15%</div>
                </div>

                <div id="boost-hash" class="boost-item" onclick="handleBoostClick('hashtag')">
                    <div class="boost-check-mini"><i class="fa-solid fa-check"></i></div>
                    <div class="boost-icon"><i class="fa-solid fa-hashtag"></i></div>
                    <div class="boost-label">HATELAVKA<br>BOT</div>
                    <div class="boost-percent" id="val-hash">+15%</div>
                </div>

            </div>
        </div>
    </div>

    <div id="checkModal" class="check-overlay">
        <div class="check-content">
            <div class="check-close" onclick="closeCheckModal()"><i class="fa-solid fa-xmark"></i></div>
            
            <div class="check-icon" id="checkModalIcon"><i class="fa-solid fa-lock"></i></div>
            <h3 class="check-title" id="checkModalTitle">БОНУС</h3>
            <p class="check-text" id="checkModalText">Текст описания.</p>
            
            <button id="checkActionBtn" class="check-btn">
                <i class="fa-brands fa-telegram"></i> <span>Действие</span>
            </button>
            
            <button id="checkRetryBtn" class="check-btn secondary">
                <i class="fa-solid fa-rotate-right"></i> Проверить
            </button>
        </div>
    </div>


    <div id="entry-modal" class="modal">
        <div class="modal-box">
            <h3 style="margin: 0 0 5px 0; color: #fff;">ВВЕДИТЕ КОД</h3>
            
            <div class="input-inner-wrapper">
                <input type="text" id="real-user-code" class="pass-input" placeholder="КОД..." oninput="debouncedCheckCode()" onkeypress="handleEnter(event)">
                <div class="paste-btn-inside" onclick="pasteFromClipboard()">
                    <i class="fa-regular fa-clipboard"></i>
                </div>
            </div>
            <div id="code-error"></div>

            <button class="modal-btn btn-gold" onclick="confirmCode()">ГОТОВО</button>
            <button class="modal-btn btn-grey" onclick="closeModal('entry-modal')">ОТМЕНА</button>
        </div>
    </div>

    <div id="screen-action" class="screen">
        <button class="main-btn" onclick="goToRoulette()">
            ОТКРЫТЬ КЕЙС
        </button>
        <div style="margin-top: 20px; color: #aaa; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 20px;" onclick="resetToInput()">
            <i class="fa-solid fa-arrow-rotate-left"></i> <span>Ввести другой код</span>
        </div>
    </div>

    <div id="screen-roulette" class="screen">
        <div class="roulette-container">
            <div class="roulette-window">
                <div class="marker-arrow"></div>
                <div class="center-marker"></div>
                <div class="track" id="track"></div>
            </div>
            <div style="text-align: center; margin-top: 25px; color: #fff; text-shadow: 0 2px 10px #000;">
                <h2 style="margin: 0; font-size: 24px; letter-spacing: 2px;">ROLLING...</h2>
            </div>
        </div>
    </div>

    <div id="win-modal" class="modal">
        <div class="modal-box" style="border: 2px solid #ffd700; background: radial-gradient(circle, #222 0%, #000 100%); padding-top: 40px;">
            <img id="win-image" src="" class="win-img">
            <div id="win-name" class="win-name-large">NAME</div>
            <div id="win-details" class="win-details">RARITY • CONDITION</div>
            
            <div id="trade-warning" class="trade-warning">
                ⚠️ ВНИМАНИЕ: У тебя не установлена Trade Link! Добавь её в профиле, чтобы получить предмет.
            </div>

            <button class="modal-btn btn-gold" onclick="claimPrize()">ЗАБРАТЬ</button>
        </div>
    </div>

    <div id="final-modal" class="modal">
        <div class="modal-box" style="text-align: center; padding: 40px 20px;">
            <i class="fa-solid fa-check-circle" style="font-size: 50px; color: #ffd700; margin-bottom: 20px;"></i>
            <h3 style="color: #fff; margin: 0 0 10px 0; text-transform: uppercase;">Заявка принята!</h3>
            <p style="color: #aaa; font-size: 13px; line-height: 1.5; margin-bottom: 25px;">
                Администратор скоро отправит вам обмен.<br>Ожидайте предложения в Steam.
            </p>
            <button class="modal-btn btn-gold" onclick="finishFlow()">ОТЛИЧНО</button>
        </div>
    </div>

    <div id="admin-fab" class="admin-wrapper" style="display: none;">
        <div class="admin-fab-btn toggle" onclick="toggleAdminMenu()"><i class="fa-solid fa-chevron-up"></i></div>
        <div class="admin-menu-items" id="admin-menu-items">
            <div class="admin-fab-btn" onclick="openPassModal()"><i class="fa-solid fa-gear"></i></div>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-box">
            <h3>Admin Access</h3>
            <input type="password" id="admin-pass-input" class="pass-input" placeholder="Пароль" inputmode="numeric">
            <button class="modal-btn btn-gold" onclick="checkPass()">ВОЙТИ</button>
            <button class="modal-btn btn-grey" onclick="closeModal('password-modal')">ОТМЕНА</button>
        </div>
    </div>

    <div id="admin-panel" class="modal">
        <div class="modal-box" style="max-width: 400px; text-align: left;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items: center;">
                <h3 style="margin:0; text-transform: uppercase;">Настройки</h3>
                <i class="fa-solid fa-xmark" onclick="closeModal('admin-panel')" style="cursor:pointer; font-size:20px; color:#666;"></i>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="modal-btn btn-gold" style="margin:0;" onclick="openSkinsManager()"><i class="fa-solid fa-gift"></i> Управление скинами</button>
                <button class="modal-btn btn-grey" style="margin:0;" onclick="openSubModal('add-code-modal')"><i class="fa-solid fa-ticket"></i> Код</button>
                <button class="modal-btn btn-grey" style="margin:0; grid-column: span 2;" onclick="loadWinners()"><i class="fa-solid fa-trophy"></i> История побед</button>
            </div>
        </div>
    </div>

    <div id="skins-manage-modal" class="modal">
        <div class="modal-box" style="max-width: 320px;">
            <h3 style="margin-bottom: 10px;">Скины в кейсе</h3>
            <div id="admin-skins-grid" class="admin-skins-grid"></div>
            <button class="modal-btn btn-grey" onclick="closeModal('skins-manage-modal'); document.getElementById('admin-panel').classList.add('active');">Назад</button>
        </div>
    </div>

    <div id="add-item-modal" class="modal">
        <div class="modal-box">
            <h3 id="item-modal-title">Настроить Скин</h3>
            <div class="admin-input-group"><label>Название скина</label><input id="adm-name" placeholder="Например: AWP | Asiimov"></div>
            <div class="admin-input-group"><label>Ссылка на картинку (URL)</label><input id="adm-img" placeholder="https://..."></div>
            <div class="admin-input-group"><label>Редкость (Цвет)</label><select id="adm-rarity"><option value="blue">Blue</option><option value="purple">Purple</option><option value="pink">Pink</option><option value="red">Red</option><option value="gold">Gold</option></select></div>
            <div class="admin-input-group"><label>Качество (FN/MW...)</label><input id="adm-quality" placeholder="FN"></div>
            
            <button class="modal-btn btn-gold" onclick="apiAddItem()">СОХРАНИТЬ</button>
            <button class="modal-btn btn-grey" onclick="closeModal('add-item-modal'); openSkinsManager();">ОТМЕНА</button>
        </div>
    </div>

    <div id="add-code-modal" class="modal">
        <div class="modal-box">
            <h3>Добавить Код</h3>
            <div class="admin-input-group"><label>Коды (каждый с новой строки)</label><textarea id="adm-code-val" placeholder="CODE1&#10;CODE2..."></textarea></div>
            <div class="admin-input-group"><label>Кол-во использований</label><input type="number" id="adm-code-max" value="1"></div>
            <button class="modal-btn btn-gold" onclick="apiAddCode()">СОЗДАТЬ</button>
            <button class="modal-btn btn-grey" onclick="closeModal('add-code-modal'); document.getElementById('admin-panel').classList.add('active');">НАЗАД</button>
        </div>
    </div>

    <div id="winners-modal" class="modal">
        <div class="modal-box">
            <h3>Последние победы</h3>
            <div id="winners-list" class="admin-list">Загрузка...</div>
            <button class="modal-btn btn-grey" onclick="closeModal('winners-modal'); document.getElementById('admin-panel').classList.add('active');">НАЗАД</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const initData = tg.initData;

    // === КОНФИГ БОНУСОВ ===
    const TG_CHANNEL_URL = 'https://t.me/hatelove_ttv'; 
    const BOT_TAG_NAME = '@HATElavka_bot';

    // --- ПЕРЕМЕННЫЕ ---
    let itemsCache = [];
    let savedCode = "";
    let currentUser = null; 
    let debounceTimer;
    // Изначально статусы false
    let boostStatus = { twitch: false, tg: false, hashtag: false };
    // Какая модалка сейчас открыта? (tg или hashtag)
    let currentCheckType = null; 

    const CARD_WIDTH = 140; 
    const TRACK = document.getElementById('track');
    const bgLayer = document.getElementById('bg-layer');

    function notify(msg) {
        tg.showPopup({ title: 'Info', message: msg, buttons: [{type: 'ok'}] });
    }

    // --- ИНИЦИАЛИЗАЦИЯ ---
    async function init() {
        const imgAgent = new Image(); imgAgent.src = "https://i.postimg.cc/P5KJKbcQ/kartinka-bez-knopki.png";
        const imgStreet = new Image(); imgStreet.src = "https://i.postimg.cc/x1sjLfJL/3.png";
        
        try {
            const meRes = await fetch('/api/v1/user/me', { method: 'POST', body: JSON.stringify({initData}), headers: {'Content-Type': 'application/json'}});
            const me = await meRes.json();
            currentUser = me; 

            if (me.is_admin) document.getElementById('admin-fab').style.display = 'flex';
            
            // Проверяем статусы при старте
            await checkBoostsServer();

        } catch(e) {}

        loadItems();
    }

    // --- ЛОГИКА БУСТОВ (ОБНОВЛЕННАЯ) ---
    async function checkBoostsServer() {
        try {
            const res = await fetch('/api/cs/boost_status', { 
                method: 'POST', 
                body: JSON.stringify({initData}), 
                headers: {'Content-Type': 'application/json'}
            });
            const data = await res.json();
            boostStatus = data;
            
            updateBoostUI();
            
            // Если модальное окно открыто, и мы успешно прошли проверку - закрываем его
            if (currentCheckType) {
                if (currentCheckType === 'tg' && boostStatus.tg) closeCheckModal();
                if (currentCheckType === 'hashtag' && boostStatus.hashtag) closeCheckModal();
            }

        } catch (e) { console.error("Boost check failed", e); }
    }

    function updateBoostUI() {
        // Функция хелпер
        const setStatus = (id, isActive) => {
            const el = document.getElementById(id);
            if (isActive) el.classList.add('active');
            else el.classList.remove('active');
        };

        setStatus('boost-twitch', boostStatus.twitch);
        setStatus('boost-hash', boostStatus.hashtag);
        setStatus('boost-tg', boostStatus.tg);
    }

    // КЛИК ПО БУСТУ (ВЫЗЫВАЕТ МОДАЛКУ ИЛИ НИЧЕГО НЕ ДЕЛАЕТ ЕСЛИ АКТИВНО)
    function handleBoostClick(type) {
        // Если уже активно — ничего не делаем (или легкая вибрация успеха)
        if (type === 'tg' && boostStatus.tg) {
            tg.HapticFeedback.notificationOccurred('success');
            return;
        }
        if (type === 'hashtag' && boostStatus.hashtag) {
            tg.HapticFeedback.notificationOccurred('success');
            return;
        }

        // Если не активно — открываем красивое окно
        openBoostModal(type);
    }

    // ЛОГИКА МОДАЛЬНОГО ОКНА БОНУСОВ
    function openBoostModal(type) {
        currentCheckType = type;
        const modal = document.getElementById('checkModal');
        const titleEl = document.getElementById('checkModalTitle');
        const textEl = document.getElementById('checkModalText');
        const actionBtn = document.getElementById('checkActionBtn');
        const iconEl = document.getElementById('checkModalIcon');
        const retryBtn = document.getElementById('checkRetryBtn');

        // Настраиваем содержимое под тип
        if (type === 'tg') {
            iconEl.innerHTML = '<i class="fa-brands fa-telegram" style="color:#0088cc"></i>';
            titleEl.innerText = "ПОДПИСКА НА КАНАЛ";
            textEl.innerHTML = "Подпишись на наш Telegram канал и получи <b>+15%</b> к удаче в рулетке.";
            
            // Кнопка действия - открыть ссылку
            actionBtn.innerHTML = '<i class="fa-brands fa-telegram"></i> <span>ПОДПИСАТЬСЯ</span>';
            actionBtn.onclick = () => { tg.openTelegramLink(TG_CHANNEL_URL); };

        } else if (type === 'hashtag') {
            iconEl.innerHTML = '<i class="fa-solid fa-signature" style="color:#ffd700"></i>';
            titleEl.innerText = "ТЕГ В НИКЕЙМЕ";
            textEl.innerHTML = `Добавь тег <b>${BOT_TAG_NAME}</b> в свое имя или фамилию в Telegram и получи <b>+15%</b> к удаче.`;
            
            // Кнопка действия - копировать тег
            actionBtn.innerHTML = '<i class="fa-regular fa-copy"></i> <span>СКОПИРОВАТЬ ТЕГ</span>';
            actionBtn.onclick = () => { 
                navigator.clipboard.writeText(BOT_TAG_NAME);
                tg.showAlert("Тег скопирован! Теперь вставь его в настройках профиля.");
            };
        }

        // Кнопка повторной проверки
        retryBtn.onclick = async () => {
            const originalHtml = retryBtn.innerHTML;
            retryBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ПРОВЕРЯЮ...';
            await checkBoostsServer(); // Делаем запрос на сервер
            setTimeout(() => { retryBtn.innerHTML = originalHtml; }, 500);
        };

        modal.classList.add('active');
        tg.HapticFeedback.impactOccurred('medium');
    }

    function closeCheckModal() {
        document.getElementById('checkModal').classList.remove('active');
        currentCheckType = null;
    }

    // Для Twitch оставляем просто переход
    function openTwitch() {
        if (boostStatus.twitch) return; // Если уже есть, ничего не делаем
        window.location.href = 'profile.html';
    }

    // --- PROMO CODE VALIDATION ---
    function openCodeEntry() {
        document.getElementById('entry-modal').classList.add('active');
        setTimeout(() => { document.getElementById('real-user-code').focus(); }, 100);
    }
    
    function debouncedCheckCode() {
        clearTimeout(debounceTimer);
        const code = document.getElementById('real-user-code').value.trim();
        const errEl = document.getElementById('code-error');
        const inputEl = document.getElementById('real-user-code');

        if (code.length < 2) {
            errEl.innerText = "";
            inputEl.classList.remove('valid-code', 'invalid-code');
            return;
        }

        debounceTimer = setTimeout(async () => {
            try {
                const res = await fetch('/api/cs/check_code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData, code })
                });
                const data = await res.json();
                
                if (data.valid) {
                    inputEl.classList.remove('invalid-code');
                    inputEl.classList.add('valid-code');
                    errEl.innerText = "";
                } else {
                    inputEl.classList.remove('valid-code');
                    inputEl.classList.add('invalid-code');
                    errEl.innerText = data.message || "Неверный код";
                }
            } catch(e) { console.error(e); }
        }, 500);
    }

    async function pasteFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                const input = document.getElementById('real-user-code');
                input.value = text;
                debouncedCheckCode(); 
                
                const icon = document.querySelector('.paste-btn-inside i');
                icon.className = 'fa-solid fa-check';
                setTimeout(() => { icon.className = 'fa-regular fa-clipboard'; }, 1000);
            }
        } catch (err) { notify("Нет доступа к буферу"); }
    }

    function confirmCode() {
        const inputEl = document.getElementById('real-user-code');
        const val = inputEl.value.trim();
        
        if(inputEl.classList.contains('invalid-code')) {
             tg.HapticFeedback.notificationOccurred('error');
             return;
        }

        if(val.length > 0) {
            savedCode = val;
            inputEl.value = ''; inputEl.blur(); inputEl.classList.remove('valid-code', 'invalid-code');
            document.getElementById('code-error').innerText = '';
            
            closeModal('entry-modal');
            document.getElementById('screen-input').classList.remove('active');
            document.getElementById('screen-action').classList.add('active');
        } else {
            tg.HapticFeedback.notificationOccurred('warning');
        }
    }

    function handleEnter(e) { if(e.key === 'Enter') confirmCode(); }
    
    function resetToInput() {
        document.getElementById('screen-action').classList.remove('active');
        document.getElementById('screen-input').classList.add('active');
        savedCode = "";
    }

    function goToRoulette() {
        bgLayer.classList.remove('bg-agent');
        bgLayer.classList.add('bg-street');
        document.getElementById('screen-action').classList.remove('active');
        document.getElementById('screen-roulette').classList.add('active');
        startSpinAPI();
    }

    function claimPrize() {
        closeModal('win-modal');
        document.getElementById('final-modal').classList.add('active');
    }

    function finishFlow() {
        closeModal('final-modal');
        bgLayer.classList.remove('bg-street');
        bgLayer.classList.add('bg-agent');
        document.getElementById('screen-roulette').classList.remove('active');
        document.getElementById('screen-input').classList.add('active');
        savedCode = "";
        TRACK.style.transition = 'none';
        TRACK.style.transform = 'translateX(0)';
        generateStrip(itemsCache, null);
        checkBoostsServer(); // Обновляем статусы при возврате
    }

    // --- LOGIC ---
    async function loadItems() {
        try {
            const res = await fetch('/api/cs/items');
            itemsCache = await res.json();
            
            // --- ПРОЦЕНТЫ ИЗ БАЗЫ ---
            const boostItem = itemsCache.find(i => i.boost_percent && i.boost_percent > 0);
            if (boostItem) {
                const percentText = `+${Math.round(boostItem.boost_percent * 100)}%`;
                document.getElementById('val-twitch').innerText = percentText;
                document.getElementById('val-tg').innerText = percentText;
                document.getElementById('val-hash').innerText = percentText;
            }

            generateStrip(itemsCache, null);
        } catch(e) { console.error(e); }
    }

    function generateStrip(items, winnerItem) {
        TRACK.innerHTML = '';
        const cardsCount = 80; const winnerIndex = 60; 
        let html = '';
        for (let i = 0; i < cardsCount; i++) {
            let item;
            if (i === winnerIndex && winnerItem) item = winnerItem;
            else item = items.length ? items[Math.floor(Math.random() * items.length)] : null;
            if(!item) item = {name: "Загрузка...", image_url: "https://placehold.co/100", rarity: "blue"};

            html += `<div class="card ${item.rarity}"><img src="${item.image_url}" alt="skin"><div class="card-name">${item.name}</div></div>`;
        }
        TRACK.insertAdjacentHTML('beforeend', html);
    }

    async function startSpinAPI() {
        try {
            const res = await fetch('/api/cs/spin', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ initData, code: savedCode })
            });
            const data = await res.json();

            if (!res.ok) {
                notify(data.detail || "Ошибка");
                finishFlow(); return;
            }

            const winner = data.winner;
            generateStrip(itemsCache, winner);

            setTimeout(() => {
                const cardCenter = CARD_WIDTH / 2;
                const screenCenter = window.innerWidth / 2;
                const baseOffset = (60 * CARD_WIDTH) + cardCenter - screenCenter; 
                const randomOffset = Math.floor(Math.random() * 80) - 40; 
                const finalPosition = baseOffset + randomOffset;
                
                TRACK.style.transition = 'transform 8s cubic-bezier(0.1, 0, 0.05, 1)'; 
                TRACK.style.transform = `translateX(-${finalPosition}px)`;
                
                setTimeout(() => { showWinModal(winner); }, 8500); 
            }, 100);

        } catch (e) {
            notify("Ошибка сети");
            finishFlow();
        }
    }

    function showWinModal(item) {
        document.getElementById('win-image').src = item.image_url;
        document.getElementById('win-name').innerText = item.name;
        
        const ruRarity = { 'blue': 'Армейское', 'purple': 'Запрещенное', 'pink': 'Засекреченное', 'red': 'Тайное', 'gold': 'Особое' };
        const condition = item.condition || 'FN';
        const rarityText = ruRarity[item.rarity] || item.rarity;
        
        const detailsEl = document.getElementById('win-details');
        detailsEl.innerText = `${rarityText} • ${condition}`;
        detailsEl.style.color = getComputedStyle(document.body).getPropertyValue(`--rarity-${item.rarity}`);
        
        const warnEl = document.getElementById('trade-warning');
        if (currentUser && !currentUser.trade_link) warnEl.style.display = 'block';
        else warnEl.style.display = 'none';

        document.getElementById('win-modal').classList.add('active');
        tg.HapticFeedback.notificationOccurred('success');
    }

    // --- ADMIN ---
    function toggleAdminMenu() {
        document.getElementById('admin-menu-items').classList.toggle('show');
        const icon = document.querySelector('.admin-fab-btn.toggle i');
        icon.classList.toggle('fa-chevron-up'); icon.classList.toggle('fa-xmark');
    }

    function openPassModal() { 
        toggleAdminMenu();
        document.getElementById('password-modal').classList.add('active');
        document.getElementById('admin-pass-input').value = '';
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openSubModal(id) { document.getElementById('admin-panel').classList.remove('active'); document.getElementById(id).classList.add('active'); }

    function checkPass() {
        if(document.getElementById('admin-pass-input').value === '6971') {
            closeModal('password-modal'); document.getElementById('admin-panel').classList.add('active');
        } else { tg.HapticFeedback.notificationOccurred('error'); }
    }

    function openSkinsManager() {
        document.getElementById('admin-panel').classList.remove('active');
        document.getElementById('skins-manage-modal').classList.add('active');
        renderAdminSkins();
    }

    function renderAdminSkins() {
        const grid = document.getElementById('admin-skins-grid'); grid.innerHTML = '';
        const addBtn = document.createElement('div');
        addBtn.className = 'admin-skin-card admin-add-card'; addBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
        addBtn.onclick = () => openEditModal(null);
        grid.appendChild(addBtn);

        itemsCache.forEach(item => {
            const card = document.createElement('div'); card.className = 'admin-skin-card';
            const colorVar = getComputedStyle(document.body).getPropertyValue(`--rarity-${item.rarity || 'blue'}`);
            card.style.borderColor = colorVar; card.style.background = `linear-gradient(180deg, rgba(30,30,30,1) 0%, ${colorVar}10 100%)`;
            card.innerHTML = `<img src="${item.image_url}" class="admin-skin-img"><div class="admin-skin-name" style="color:${colorVar}">${item.name}</div>`;
            card.onclick = () => openEditModal(item);
            grid.appendChild(card);
        });
    }

    function openEditModal(item) {
        document.getElementById('skins-manage-modal').classList.remove('active');
        document.getElementById('add-item-modal').classList.add('active');
        if (item) {
            document.getElementById('item-modal-title').innerText = "Настроить Скин";
            document.getElementById('adm-name').value = item.name; document.getElementById('adm-img').value = item.image_url;
            document.getElementById('adm-rarity').value = item.rarity; document.getElementById('adm-quality').value = item.condition || 'FN';
        } else {
            document.getElementById('item-modal-title').innerText = "Добавить Новый";
            document.getElementById('adm-name').value = ''; document.getElementById('adm-img').value = '';
            document.getElementById('adm-rarity').value = 'blue'; document.getElementById('adm-quality').value = 'FN';
        }
    }

    async function apiAddItem() {
        const payload = {
            initData, name: document.getElementById('adm-name').value,
            image_url: document.getElementById('adm-img').value, rarity: document.getElementById('adm-rarity').value, 
            condition: document.getElementById('adm-quality').value, chance_weight: 10, quantity: 1
        };
        if(!payload.name) return notify("Введите название");
        try {
            await fetch('/api/admin/cs/item/add', { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'application/json'} });
            notify("Скин сохранен!"); closeModal('add-item-modal'); await loadItems(); openSkinsManager();
        } catch(e) { notify("Ошибка сохранения"); }
    }

    async function apiAddCode() {
        const rawText = document.getElementById('adm-code-val').value;
        const maxUses = parseInt(document.getElementById('adm-code-max').value);
        const codes = rawText.split('\n').map(c => c.trim()).filter(c => c !== '');
        if(codes.length === 0) return notify("Введите хотя бы один код");
        notify(`Создание ${codes.length} кодов...`);
        for (const code of codes) {
            try { await fetch('/api/admin/cs/code/add', { method: 'POST', body: JSON.stringify({ initData, code, max_uses: maxUses }), headers: {'Content-Type': 'application/json'} }); } catch(e) {}
        }
        notify(`Готово!`); closeModal('add-code-modal'); document.getElementById('adm-code-val').value = '';
    }

    function copyLink(link) { navigator.clipboard.writeText(link).then(() => { notify("Ссылка скопирована!"); }); }

    async function loadWinners() {
        openSubModal('winners-modal'); document.getElementById('winners-list').innerHTML = 'Загрузка...';
        try {
            const res = await fetch('/api/admin/cs/winners', { method: 'POST', body: JSON.stringify({initData}), headers: {'Content-Type': 'application/json'} });
            const list = await res.json();
            if (!Array.isArray(list) || list.length === 0) { document.getElementById('winners-list').innerHTML = "<div style='padding:20px; color:#666; text-align:center'>Список пуст</div>"; return; }
            let html = '';
            list.forEach(w => {
                const tl = w.user?.trade_link;
                const linkBtn = tl ? `<button class="copy-link-btn" onclick="copyLink('${tl}')"><i class="fa-solid fa-link"></i></button>` : '<span style="color:#444; font-size:10px; margin-left:5px;">(Нет ссылки)</span>';
                html += `<div class="admin-row"><div style="font-size:12px;"><b style="color:#fff">${w.user?.full_name || 'User'}</b> ${linkBtn}<br><span style="color:gold">${w.item?.name || 'Item'}</span></div><div style="font-size:10px; color:#666;">Код: ${w.code_used}</div></div>`;
            });
            document.getElementById('winners-list').innerHTML = html;
        } catch(e) { document.getElementById('winners-list').innerHTML = "<div style='padding:20px; color:#red; text-align:center'>Ошибка сети</div>"; }
    }

    init();
</script>
</body>
</html>
