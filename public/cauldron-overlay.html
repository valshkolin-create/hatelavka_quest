<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Cauldron Overlay</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Цвета, взятые из вашего изображения */
            --bar-gradient-start: #BF36E4;
            --bar-gradient-end: #F98C1F;
            --text-color: #FFFFFF;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --glow-color: rgba(249, 140, 31, 0.6);
        }
        body {
            background-color: transparent;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            margin: 0;
            color: var(--text-color);
        }
        .hidden {
            display: none !important;
        }

        /* --- 1. ИЗМЕНЕНИЕ: Позиционирование всего виджета по центру --- */
        #overlay-container {
            position: absolute;
            bottom: 30px; /* Немного подняли */
            left: 50%;
            transform: translateX(-50%); /* Центрирование по горизонтали */
            width: 550px; /* Ширина виджета */
            animation: fadeIn 1s ease-out;
        }

        #widget-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(40, 36, 52, 0.9); /* Фон как на картинке */
            border-radius: 18px; /* Скругленные углы */
            padding: 15px 25px 20px 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #event-title-container {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px var(--shadow-color);
        }
        .title-icon {
            width: 32px;
            height: 32px;
        }
        #event-title {
            color: var(--bar-gradient-end);
            text-shadow: 0 0 10px var(--glow-color);
        }
        
        #progress-text { 
            font-size: 16px; 
            font-weight: 700; 
            text-align: center; 
            margin-bottom: 12px;
            text-shadow: 1px 1px 3px var(--shadow-color);
        }
        
        /* --- 2. ИЗМЕНЕНИЕ: Стилизация прогресс-бара --- */
        .progress-bar-container { 
            width: 100%; 
            background-color: rgba(18, 16, 24, 0.8); 
            border-radius: 12px; 
            height: 28px; /* Сделали бар толще */
            overflow: hidden; 
            position: relative; /* Обязательно для позиционирования дочерних элементов */
            border: 1px solid rgba(0, 0, 0, 0.2);
        }
        #progress-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--bar-gradient-start), var(--bar-gradient-end)); 
            border-radius: 12px; 
            transition: width 0.5s ease-out, opacity 0.3s ease-in-out; /* Добавили transition для opacity */
        }
        
        /* --- 3. ИЗМЕНЕНИЕ: Стили для блока с ведьмой и ником ВНУТРИ бара --- */
        #contributor-info {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; /* Скрыто по умолчанию */
            pointer-events: none; /* Не перехватывает клики */
        }
        #contributor-info.animate {
            animation: reveal-contributor 4.5s forwards;
        }
        #contributor-icon {
            width: 36px; /* Чуть больше */
            height: 36px;
            margin-right: 8px;
            transform: translateY(-2px); /* Небольшая коррекция позиции */
            filter: drop-shadow(0 2px 3px var(--shadow-color));
        }
        #contributor-name {
            font-size: 18px;
            font-weight: 800;
            text-shadow: 0 2px 4px var(--shadow-color);
        }
        #contributor-name span {
            color: var(--bar-gradient-end);
        }
        
        #flying-flask { position: fixed; width: 60px; height: auto; z-index: 10; pointer-events: none; opacity: 0; top: 20%; left: -100px; }
        #flying-flask.animate { animation: fly-in 1.2s cubic-bezier(0.5, -0.5, 1, 1); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        
        /* --- 4. ИЗМЕНЕНИЕ: Анимация для блока с ником --- */
        @keyframes reveal-contributor {
            0% { opacity: 0; }
            15% { opacity: 1; }
            85% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes fly-in { 0% { opacity: 1; transform: translate(0, 0) scale(1.2) rotate(0deg); } 100% { opacity: 0; transform: translate(450px, 450px) scale(0.2) rotate(720deg); } }
    </style>
</head>
<body>

    <div id="overlay-container">
        <img id="flying-flask" src="https://i.postimg.cc/XYxLQYTF/giphy-flusk.gif" alt="Animating flask">
        
        <div id="widget-container">
            <div id="event-title-container">
                <img class="title-icon" src="https://i.postimg.cc/W4jPz9k5/heart-spiderweb.png" alt="icon">
                <h1 id="event-title">КОТЕЛ ПРИЯТНОСТЕЙ</h1>
                <img class="title-icon" src="https://i.postimg.cc/W4jPz9k5/heart-spiderweb.png" alt="icon">
            </div>

            <div id="progress-text">0 / 0</div>

            <div class="progress-bar-container">
                <div id="progress-bar-fill"></div>
                <div id="contributor-info" class="hidden">
                    <img id="contributor-icon" src="https://i.postimg.cc/pXk0SjJ9/witch-icon.png" alt="Witch">
                    <div id="contributor-name"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pyeuckjcrsiaseyqrsek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZXVja2pjcnNpYXNleXFyc2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzEyOTgsImV4cCI6MjA3MDA0NzI5OH0.srRwuUygiF7jr3-b2AwyRNAmrChlW3Bzp3I-9Ju2TVg';

        const dom = {
            title: document.getElementById('event-title'),
            progressBar: document.getElementById('progress-bar-fill'),
            progressText: document.getElementById('progress-text'),
            flyingFlask: document.getElementById('flying-flask'),
            contributorInfo: document.getElementById('contributor-info'),
            contributorName: document.getElementById('contributor-name')
        };

        let isAnimating = false;
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function updateDisplay(eventData) {
            if (!eventData) return;
            
            dom.title.textContent = eventData.title || "КОТЕЛ ПРИЯТНОСТЕЙ";

            const { goals = {}, current_progress = 0 } = eventData;
            // Предполагаем, что в eventData есть поле 'goal_total'
            const totalGoal = goals.level_3 || goals.level_2 || goals.level_1 || 200;
            
            const percentage = (totalGoal > 0) ? Math.min((current_progress / totalGoal) * 100, 100) : 0;
            
            dom.progressBar.style.width = `${percentage}%`;
            dom.progressText.textContent = `${current_progress} / ${totalGoal}`;
        }
        
        // --- 6. ИЗМЕНЕНИЕ: Логика анимации в JavaScript ---
        function triggerAnimation(payload) {
            if (isAnimating) return;
            isAnimating = true;

            const { event_data, last_contributor } = payload.new.payload;
            
            updateDisplay(event_data);
            
            if (last_contributor && last_contributor.name) {
                // Заполняем данными блок с ником
                dom.contributorName.innerHTML = `${last_contributor.name} <span>+${last_contributor.amount}</span>`;
                
                // Скрываем цветную полосу и показываем блок с ником
                dom.progressBar.style.opacity = '0';
                dom.contributorInfo.classList.remove('hidden');
                dom.contributorInfo.classList.add('animate');
            }

            // Анимация колбы остается как есть
            dom.flyingFlask.classList.add('animate');

            setTimeout(() => {
                dom.flyingFlask.classList.remove('animate');
                
                if (last_contributor && last_contributor.name) {
                    // Скрываем блок с ником и возвращаем цветную полосу
                    dom.contributorInfo.classList.remove('animate');
                    dom.contributorInfo.classList.add('hidden');
                    dom.progressBar.style.opacity = '1';
                }
                
                isAnimating = false;
            }, 4500); // 4.5 секунды на всю анимацию
        }

        async function loadInitialState() {
            const { data, error } = await supabaseClient.from('pages_content').select('content').eq('page_name', 'cauldron_event').single();
            if (error) { console.error('Error loading initial state:', error); return; }
            if (data && data.content) updateDisplay(data.content);
        }
        
        try {
            supabaseClient.channel('cauldron-triggers-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'cauldron_triggers' },
                    payload => triggerAnimation(payload)
                ).subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        loadInitialState();
                    }
                });
        } catch (error) { console.error("Failed to connect to Supabase:", error); }
    </script>
</body>
</html>
