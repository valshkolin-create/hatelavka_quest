<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OBS Compact Raffle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* --- –ë–ê–ó–ê --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: transparent; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤ –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª */
            display: flex; flex-direction: column;
            justify-content: flex-end; align-items: flex-end;
            padding: 20px; box-sizing: border-box;
        }

        /* --- –û–ë–©–ò–ô –ö–û–ù–¢–ï–ô–ù–ï–† (–ö–∞—Ä—Ç–æ—á–∫–∞ + CTA) --- */
        .obs-container {
            width: 320px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–µ–±–æ–ª—å—à–∞—è —à–∏—Ä–∏–Ω–∞ */
            display: flex; flex-direction: column; gap: 8px;
            opacity: 0; transform: translateX(20px);
            transition: all 0.5s ease-in-out;
        }
        .obs-container.active { opacity: 1; transform: translateX(0); }

        /* --- –ú–ê–õ–ï–ù–¨–ö–ê–Ø –ö–ê–†–¢–û–ß–ö–ê –°–ö–ò–ù–ê --- */
        .compact-card {
            position: relative;
            width: 100%;
            /* –í—ã—Å–æ—Ç–∞ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ 110px */
            min-height: 110px; 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; box-sizing: border-box;
            border-radius: 16px; overflow: hidden;
            
            background: #0a0a0a;
            background-image: radial-gradient(circle at 70% 50%, rgba(var(--rarity-rgb), 0.2) 0%, rgba(15, 15, 15, 1) 90%);
            border: 1px solid rgba(var(--rarity-rgb), 0.4);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5), inset 0 0 20px rgba(var(--rarity-rgb), 0.05);
        }

        /* –ë–ª–∏–∫ */
        .compact-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.03) 50%, transparent 100%);
            transform: rotate(30deg); pointer-events: none; animation: shine 8s infinite linear;
        }
        @keyframes shine { from { transform: translateX(-100%) rotate(30deg); } to { transform: translateX(100%) rotate(30deg); } }

        /* –ë–ï–ô–î–ñ–ò–ö */
        .mini-badge {
            position: absolute; top: 8px; left: 12px;
            font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
            color: rgba(255,255,255,0.8);
            background: rgba(var(--rarity-rgb), 0.2);
            padding: 2px 6px; border-radius: 4px;
            border: 1px solid rgba(var(--rarity-rgb), 0.3);
        }

        /* –õ–ï–í–ê–Ø –ß–ê–°–¢–¨ (–¢–ï–ö–°–¢) */
        .card-left {
            display: flex; flex-direction: column; justify-content: center;
            z-index: 5; max-width: 55%; margin-top: 14px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –±–µ–π–¥–∂–∏–∫ */
        }

        .mini-quality {
            font-size: 9px; font-weight: 700; color: rgba(255, 255, 255, 0.5);
            margin-bottom: 2px; text-transform: uppercase;
        }

        .mini-name {
            font-size: 14px; /* –ú–∞–ª–µ–Ω—å–∫–∏–π —à—Ä–∏—Ñ—Ç */
            font-weight: 800; color: #fff; line-height: 1.1; margin-bottom: 6px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            text-shadow: 0 1px 5px rgba(0,0,0,0.8);
        }

        /* –ö–û–ú–ü–ê–ö–¢–ù–´–ô –¢–ê–ô–ú–ï–† (–¢–æ–ª—å–∫–æ –ß–ß:–ú–ú) */
        .mini-timer {
            display: inline-flex; align-items: center; gap: 4px;
            background: rgba(0,0,0,0.5); padding: 3px 6px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1); font-size: 10px; color: #ccc; font-weight: 600;
            width: fit-content;
        }
        .timer-val { font-family: 'Courier New', monospace; color: #fff; font-weight: 800; font-size: 12px; }

        /* –ö–ê–†–¢–ò–ù–ö–ê (–ì–õ–ê–í–ù–û–ï - –ù–ï –†–ê–°–¢–Ø–ì–ò–í–ê–¢–¨) */
        .card-img {
            position: absolute; right: -10px; bottom: 5px;
            height: auto; 
            max-height: 90px; /* üî• –ñ–ï–°–¢–ö–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –í–´–°–û–¢–´ üî• */
            width: auto;
            max-width: 50%;
            object-fit: contain;
            z-index: 10;
            image-rendering: -webkit-optimize-contrast;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.8));
            animation: weaponFloat 6s ease-in-out infinite;
        }
        @keyframes weaponFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

        /* --- –ë–õ–û–ö –ü–†–ò–ó–´–í–ê –ö –î–ï–ô–°–¢–í–ò–Æ (CTA) --- */
        .cta-box {
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
            font-size: 11px; color: #aaa; font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .cta-highlight {
            color: #fff; font-weight: 800;
            background: linear-gradient(45deg, rgb(var(--rarity-rgb)), #fff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>

    <div id="obs-overlay" class="obs-container"></div>

    <script>
        const API_URL = '/api/v1/raffles/active';
        const CYCLE_INTERVAL = 10000; 
        const FADE_DURATION = 500;

        let activeRaffles = [];
        let currentIndex = 0;
        let cycleTimer = null;
        let countdownTimer = null;
        let currentRgb = '255, 215, 0'; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è CTA

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '255, 215, 0';
        }

        async function fetchRaffles() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: "" }) 
                });
                if(!res.ok) throw new Error('API Error');
                const data = await res.json();
                activeRaffles = data.filter(r => r.status === 'active');

                if (activeRaffles.length > 0) {
                    startCycle();
                } else {
                    document.getElementById('obs-overlay').innerHTML = '';
                    document.getElementById('obs-overlay').classList.remove('active');
                }
            } catch (e) { console.error("OBS Fetch Error:", e); }
        }

        function renderCard(raffle) {
            const container = document.getElementById('obs-overlay');
            const s = raffle.settings || {};
            const img = s.card_image || s.prize_image || '';
            const rarityColor = s.rarity_color || '#ffd700';
            const rgbColor = hexToRgb(rarityColor);
            currentRgb = rgbColor; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ü–≤–µ—Ç –¥–ª—è CTA
            const quality = s.skin_quality || 'FT';
            const prizeName = s.prize_name || 'Prize';

            // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ HTML
            container.innerHTML = `
                <div class="compact-card" style="--rarity-rgb: ${rgbColor}">
                    <div class="mini-badge">–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à</div>
                    <div class="card-left">
                        <div class="mini-quality" style="color:${rarityColor}">${quality}</div>
                        <div class="mini-name">${prizeName}</div>
                        <div class="mini-timer" id="obs-timer">
                            <i class="fa-regular fa-clock"></i>
                            <span class="timer-val h-v">00</span>—á
                            <span class="timer-val m-v">00</span>–º
                        </div>
                    </div>
                    <img src="${img}" class="card-img" alt="Skin">
                </div>
                
                <div class="cta-box">
                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ <span class="cta-highlight" style="--rarity-rgb: ${rgbColor}">!lavka</span> –≤ —á–∞—Ç, –∑–∞—Ö–æ–¥–∏ –∏ —É—á–∞—Å—Ç–≤—É–π!
                </div>
            `;

            startTimer(raffle.end_time);
        }

        function startCycle() {
            if (activeRaffles.length === 0) return;
            const container = document.getElementById('obs-overlay');

            const showNext = () => {
                container.classList.remove('active');
                setTimeout(() => {
                    renderCard(activeRaffles[currentIndex]);
                    container.classList.add('active');
                    currentIndex = (currentIndex + 1) % activeRaffles.length;
                }, FADE_DURATION);
            };

            renderCard(activeRaffles[0]);
            container.classList.add('active');
            currentIndex = (currentIndex + 1) % activeRaffles.length;

            if (activeRaffles.length > 1) {
                if (cycleTimer) clearInterval(cycleTimer);
                cycleTimer = setInterval(showNext, CYCLE_INTERVAL);
            }
        }

        function startTimer(endTimeStr) {
            if (countdownTimer) clearInterval(countdownTimer);
            const update = () => {
                const el = document.getElementById('obs-timer');
                if (!el) return;
                const end = new Date(endTimeStr);
                const now = new Date();
                const diff = end - now;
                if (diff <= 0) { el.innerHTML = '–ó–ê–í–ï–†–®–ï–ù–û'; return; }
                
                // –¢–æ–ª—å–∫–æ —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff / (1000 * 60)) % 60);
                el.querySelector('.h-v').innerText = String(h).padStart(2, '0');
                el.querySelector('.m-v').innerText = String(m).padStart(2, '0');
            };
            update();
            countdownTimer = setInterval(update, 1000);
        }

        fetchRaffles();
        setInterval(fetchRaffles, 5 * 60 * 1000);
    </script>
</body>
</html>
