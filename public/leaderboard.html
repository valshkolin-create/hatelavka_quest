<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<style>
    /* --- –°–¢–ò–õ–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô --- */
    :root {
      --bg-color: #000000;
      --surface-color: #1c1c1e;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --tg-color: #0088cc;
      --twitch-color: #9146ff;
      --gold-glow: #ffd700;
      --silver-glow: #c0c0c0;
      --bronze-glow: #cd7f32;
      --surface-glass-bg: rgba(28, 28, 30, 0.75);
      --accent-green: #34c759;
    }
    body { margin: 0; min-height: 100vh; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; }
    .main-content { flex-grow: 1; overflow-y: auto; padding: 15px 15px 90px; }

    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .header-controls h2 { margin: 0; font-size: 16px; color: var(--text-color); }
    .refresh-button { background: none; border: none; color: var(--text-color-muted); cursor: pointer; padding: 0; font-size: 18px; transition: color 0.2s ease-in-out; }
    .refresh-button:hover { color: var(--tg-color); }
    .hidden { display: none !important; }

    .info-box { background-color: var(--surface-color); border-radius: 12px; padding: 15px; margin-bottom: 20px; font-size: 14px; line-height: 1.5; color: var(--text-color-muted); }
    .info-box h2 { margin: 0 0 10px 0; font-size: 16px; color: var(--text-color); }
    .info-box p { margin: 0; }
    .info-box a { color: var(--tg-color); text-decoration: none; }

    .personal-stats-container {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .personal-avatar {
        width: 40px; height: 40px; border-radius: 50%; background: #333;
        display: flex; align-items: center; justify-content: center; font-size: 18px;
    }
    .personal-info { flex: 1; }
    .personal-name { font-weight: 600; color: var(--text-color); font-size: 14px; display: block; }
    .personal-value { font-size: 13px; color: var(--accent-green); }
    .personal-value span { font-weight: 700; }

    .controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    .source-switcher { display: flex; background-color: #2c2c2e; border-radius: 8px; padding: 4px; }
    .source-switcher button { flex: 1; padding: 8px; border: none; background-color: transparent; color: var(--text-color-muted); font-size: 14px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .source-switcher button.active.telegram { color: white; background-color: var(--tg-color); }
    .source-switcher button.active.twitch { color: white; background-color: var(--twitch-color); }

    .period-buttons { display: flex; gap: 8px; }
    .period-buttons.hidden { display: none; }
    .period-buttons button {
        flex: 1; width: 100%; background-color: #333; border: 1px solid #555;
        color: #ccc; font-size: 13px; padding: 8px; border-radius: 8px; cursor: pointer;
    }
    .period-buttons button.active { background-color: var(--tg-color); color: #fff; border-color: var(--tg-color); }
    .period-buttons.twitch-active button.active { background-color: var(--twitch-color); border-color: var(--twitch-color); }

    table { width: 100%; border-collapse: collapse; background-color: var(--surface-color); border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #333; }
    th { background-color: #2a2a2a; font-size: 14px; }
    td.rank { font-weight: bold; text-align: center; width: 40px; }
    td.username { font-weight: 600; word-break: break-all; }
    td.count { font-weight: 600; text-align: right; }

    .first-place { border-left: 4px solid var(--gold-glow); }
    .second-place { border-left: 4px solid var(--silver-glow); }
    .third-place { border-left: 4px solid var(--bronze-glow); }

    .loader { margin-top: 30px; color: #888; text-align: center; }

    /* --- –§–£–¢–ï–† --- */
    .app-footer {
        display: flex; justify-content: space-around; align-items: center;
        background-color: rgba(28, 28, 30, 0.85); 
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: fixed; bottom: 0; left: 0; width: 100%; z-index: 9999;
        padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom));
        box-sizing: border-box; height: auto;
    }
    .footer-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        color: #8E8E93; text-decoration: none; flex: 1; cursor: pointer;
        background: transparent; border: none; padding: 0; margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-size: 10px; line-height: 1; font-weight: 500; transition: all 0.2s ease;
    }
    .footer-item .icon-wrapper {
        display: flex; justify-content: center; align-items: center;
        width: 24px; height: 24px; font-size: 22px; position: relative;
        transition: transform 0.2s ease, color 0.2s ease;
    }
    .footer-item.active { color: #FFFFFF; }
    .footer-item.active span { font-weight: 600; }
    .footer-item.active .icon-wrapper {
        color: #34c759; transform: translateY(-2px);
        text-shadow: 0 0 12px rgba(52, 199, 89, 0.6);
    }
    .footer-item.active .icon-wrapper::before {
        content: ''; position: absolute; top: -8px; width: 20px; height: 2px;
        background-color: #34c759; border-radius: 2px;
        box-shadow: 0 0 5px rgba(52, 199, 89, 0.8);
    }

    #twitch-period-buttons button[data-period="session"] { order: 1; }
    #twitch-period-buttons button[data-period="week"]    { order: 2; }
    #twitch-period-buttons button[data-period="month"]   { order: 3; }
    #twitch-period-buttons button[data-period="global"]  { order: 4; }
</style>
</head>
<body>
  <main class="main-content">

    <div id="info-box-twitch" class="info-box hidden">
        <div class="header-controls">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Twitch</h2>
            <button class="refresh-button"><i class="fas fa-sync-alt"></i></button>
        </div>
        <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –Ω–∞—à–µ–º Twitch –∫–∞–Ω–∞–ª–µ.</p>
        
        <div class="personal-stats-container" id="personal-twitch">
            <div class="personal-avatar"><i class="fa-brands fa-twitch"></i></div>
            <div class="personal-info">
                <span class="personal-name" id="twitch-user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <span class="personal-value" id="twitch-user-stat">--</span>
            </div>
        </div>
    </div>

    <div id="info-box-telegram" class="info-box">
        <div class="header-controls">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Telegram</h2>
            <button class="refresh-button"><i class="fas fa-sync-alt"></i></button>
        </div>
        <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –Ω–∞—à–µ–º Telegram-—á–∞—Ç–µ. <a href="https://t.me/hatelovettv" target="_blank">–ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç</a></p>
        
        <div class="personal-stats-container" id="personal-telegram">
            <div class="personal-avatar"><i class="fa-brands fa-telegram"></i></div>
            <div class="personal-info">
                <span class="personal-name" id="tg-user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <span class="personal-value" id="tg-user-stat">--</span>
            </div>
        </div>
    </div>

    <div class="controls">
      <div class="source-switcher">
        <button data-source="telegram" class="active telegram"><i class="fa-brands fa-telegram"></i> Telegram</button>
        <button data-source="twitch" class="twitch"><i class="fa-brands fa-twitch"></i> Twitch</button>
      </div>

      <div class="period-buttons" id="telegram-periods">
        <button data-period="day" class="active">–î–µ–Ω—å</button>
        <button data-period="week">–ù–µ–¥–µ–ª—è</button>
        <button data-period="month">–ú–µ—Å—è—Ü</button>
        <button data-period="all">–í—Å—ë –≤—Ä–µ–º—è</button>
      </div>

      <div class="period-buttons hidden twitch-controls" id="twitch-metric-buttons">
        <button data-metric="message" class="active">–°–æ–æ–±—â–µ–Ω–∏—è</button>
        <button data-metric="uptime">–í—Ä–µ–º—è</button>
        <button data-metric="ranks">–†–∞–Ω–≥–∏</button>
      </div>

      <div class="period-buttons hidden twitch-controls twitch-active" id="twitch-period-buttons">
        <button data-period="session" class="active">–°–µ—Å—Å–∏—è</button>
        <button data-period="week">–ù–µ–¥–µ–ª—è</button>
        <button data-period="month">–ú–µ—Å—è—Ü</button>
        <button data-period="global">–í—Å—ë –≤—Ä–µ–º—è</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th id="table-header-activity" style="text-align: right;">–°–æ–æ–±—â–µ–Ω–∏–π</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <div id="loader" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
  </main>
      
  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item active">
        <div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div>
        <span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span>
    </a>
    <a href="/menu#quests" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div>
        <span>–ó–∞–¥–∞–Ω–∏—è</span>
    </a>
        <a href="/menu" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-house"></i></div>
        <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="/events" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-fire"></i></div>
        <span>–ì—Ä–∏–Ω–¥</span>
    </a>
    <a href="/auction" class="footer-item">
        <div class="icon-wrapper"><i class="fa-solid fa-gavel"></i></div>
        <span>–ê—É–∫—Ü–∏–æ–Ω</span>
    </a>
</footer>

<script>
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  const dom = {
    sourceButtons: document.querySelectorAll('.source-switcher button'),
    leaderboardBody: document.getElementById('leaderboardBody'),
    loader: document.getElementById('loader'),
    tableHeader: document.getElementById('table-header-activity'),
    infoBoxTwitch: document.getElementById('info-box-twitch'),
    infoBoxTelegram: document.getElementById('info-box-telegram'),
    refreshButtons: document.querySelectorAll('.refresh-button'),
    
    telegramPeriods: document.getElementById('telegram-periods'),
    twitchMetricButtons: document.getElementById('twitch-metric-buttons'),
    twitchPeriodButtons: document.getElementById('twitch-period-buttons'),
    
    telegramPeriodButtons: document.querySelectorAll('#telegram-periods button'),
    twitchMetricButtonList: document.querySelectorAll('#twitch-metric-buttons button'),
    twitchPeriodButtonList: document.querySelectorAll('#twitch-period-buttons button'),

    tgUserName: document.getElementById('tg-user-name'),
    tgUserStat: document.getElementById('tg-user-stat'),
    twitchUserName: document.getElementById('twitch-user-name'),
    twitchUserStat: document.getElementById('twitch-user-stat'),
  };
  
  let state = {
      source: 'telegram',
      telegramPeriod: 'day',
      twitchMetric: 'message',
      twitchPeriod: 'session',
  };

  let currentUser = null;

  // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
  async function loadCurrentUser() {
      try {
          const response = await fetch('/api/v1/user/me', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ initData: Telegram.WebApp.initData })
          });
          if (response.ok) {
              currentUser = await response.json();
              console.log("üë§ [DEBUG] –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:", currentUser);
              // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞—à–∫—É –∑–¥–µ—Å—å, –ø–æ–¥–æ–∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
          }
      } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", e);
          dom.tgUserName.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      }
  }

  // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—à–∫–∏
  function updatePersonalStats(realTimeValue = null) {
      if (!currentUser) return;

      // --- TELEGRAM ---
      if (state.source === 'telegram') {
          dom.tgUserName.textContent = `–í—ã: ${currentUser.full_name || currentUser.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`;
          
          let val = 0;
          
          if (realTimeValue !== null) {
              val = realTimeValue;
              console.log("‚úÖ [DEBUG] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã:", val);
          } else {
              // Fallback –Ω–∞ –±–∞–∑—É
              if (state.telegramPeriod === 'day') val = currentUser.telegram_daily_message_count || 0;
              else if (state.telegramPeriod === 'week') val = currentUser.telegram_weekly_message_count || 0;
              else if (state.telegramPeriod === 'month') val = currentUser.telegram_monthly_message_count || 0;
              else if (state.telegramPeriod === 'all') val = currentUser.telegram_total_message_count || 0;
              console.log("‚ö†Ô∏è [DEBUG] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ë–î (Fallback):", val);
          }

          dom.tgUserStat.innerHTML = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span>${val} —Å–æ–æ–±—â–µ–Ω–∏–π</span>`;
      } 
      
      // --- TWITCH ---
      else {
          if (!currentUser.twitch_login) {
              dom.twitchUserName.textContent = "–í—ã: Twitch –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω";
              dom.twitchUserStat.innerHTML = `<a href="/profile" style="color:var(--twitch-color)">–ü—Ä–∏–≤—è–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>`;
              return;
          }

          dom.twitchUserName.textContent = `–í—ã: ${currentUser.twitch_login}`;
          
          let val = 0;
          let isFromTable = false;

          if (realTimeValue !== null) {
              val = realTimeValue;
              isFromTable = true;
          } else {
              if (state.twitchMetric === 'message') {
                  if (state.twitchPeriod === 'session') val = currentUser.daily_message_count || 0;
                  else if (state.twitchPeriod === 'week') val = currentUser.weekly_message_count || 0;
                  else if (state.twitchPeriod === 'month') val = currentUser.monthly_message_count || 0;
                  else val = currentUser.total_message_count || 0;
              } else if (state.twitchMetric === 'uptime') {
                  if (state.twitchPeriod === 'session') val = currentUser.daily_uptime_minutes || 0;
                  else if (state.twitchPeriod === 'week') val = currentUser.weekly_uptime_minutes || 0;
                  else if (state.twitchPeriod === 'month') val = currentUser.monthly_uptime_minutes || 0;
                  else val = currentUser.total_uptime_minutes || 0;
              }
          }

          if (state.twitchMetric === 'message') {
              dom.twitchUserStat.innerHTML = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span>${val} —Å–æ–æ–±—â–µ–Ω–∏–π</span>`;
          } else if (state.twitchMetric === 'uptime') {
              let displayVal = "";
              if (isFromTable) {
                  displayVal = formatUptime(val); 
              } else {
                  displayVal = formatUptime(val * 60);
              }
              dom.twitchUserStat.innerHTML = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span>${displayVal}</span>`;
          } else {
              dom.twitchUserStat.innerHTML = `<span>–†–∞–Ω–≥–∏ –ø–æ–∫–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è</span>`;
          }
      }
  }

  function formatUptime(totalSeconds) {
      if (totalSeconds < 60) return `~1 –º–∏–Ω`;
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      let result = '';
      if (hours > 0) result += `${hours} —á `;
      if (minutes > 0) result += `${minutes} –º–∏–Ω`;
      return result.trim() || '0 –º–∏–Ω';
  }

  function updateUI() {
      dom.infoBoxTelegram.classList.toggle('hidden', state.source !== 'telegram');
      dom.telegramPeriods.classList.toggle('hidden', state.source !== 'telegram');
      
      dom.infoBoxTwitch.classList.toggle('hidden', state.source !== 'twitch');
      dom.twitchMetricButtons.classList.toggle('hidden', state.source !== 'twitch');
      
      const showTwitchPeriods = state.source === 'twitch' && state.twitchMetric !== 'ranks';
      dom.twitchPeriodButtons.classList.toggle('hidden', !showTwitchPeriods);

      if (state.source === 'telegram') {
          dom.tableHeader.textContent = '–°–æ–æ–±—â–µ–Ω–∏–π';
      } else {
          switch (state.twitchMetric) {
              case 'message': dom.tableHeader.textContent = '–°–æ–æ–±—â–µ–Ω–∏–π'; break;
              case 'uptime': dom.tableHeader.textContent = '–í—Ä–µ–º—è'; break;
              case 'ranks': dom.tableHeader.textContent = '–†–∞–Ω–≥ (PTS)'; break;
          }
      }
      updatePersonalStats(null);
  }

  async function fetchAndRender() {
    dom.leaderboardBody.innerHTML = '';
    dom.loader.style.display = 'block';
    dom.loader.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

    let url = '';
    if (state.source === 'telegram') {
      url = `/api/v1/leaderboard?period=${state.telegramPeriod}`;
    } else {
      if (state.twitchMetric === 'ranks') {
        url = `/api/v1/leaderboard/wizebot?sub_type=ALL&limit=50`;
      } else {
        url = `/api/v1/leaderboard/wizebot/stats?metric=${state.twitchMetric}&period=${state.twitchPeriod}&limit=50`;
      }
    }
    
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏`);
      const data = await response.json();
      const leaderboardData = Array.isArray(data) ? data : data.leaderboard;

      // --- –ü–û–ò–°–ö –°–ï–ë–Ø –° –û–¢–õ–ê–î–ö–û–ô ---
      let myRealTimeStat = null;
      
      if (currentUser && Array.isArray(leaderboardData)) {
          // –ü—Ä–∏–≤–æ–¥–∏–º –≤—Å—ë –∫ —Å—Ç—Ä–æ–∫–∞–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
          const myTgId = String(currentUser.telegram_id); 
          const myTwitchLogin = currentUser.twitch_login ? currentUser.twitch_login.toLowerCase() : null;
          const myUsername = currentUser.username ? currentUser.username.toLowerCase().replace('@', '') : null;

          console.log(`üîç [DEBUG] –ò—â—É —Å–µ–±—è. –ú–æ–π ID: ${myTgId}, Login: ${myTwitchLogin}, Username: ${myUsername}`);

          const me = leaderboardData.find(entry => {
              if (state.source === 'telegram') {
                  const entryId = entry.telegram_id || entry.user_id || entry.id;
                  const entryUser = entry.username ? entry.username.toLowerCase().replace('@', '') : null;
                  
                  // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º ID
                  if (entryId && String(entryId) === myTgId) {
                      console.log(`üéØ [DEBUG] –ù–∞—à–µ–ª —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ ID! (Row ID: ${entryId})`);
                      return true;
                  }
                  // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º Username (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
                  if (entryUser && myUsername && entryUser === myUsername) {
                      console.log(`üéØ [DEBUG] –ù–∞—à–µ–ª —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ Username! (Row User: ${entryUser})`);
                      return true;
                  }
              }
              
              if (state.source === 'twitch' && myTwitchLogin) {
                  const entryName = (entry.user_name || entry.username || "").toLowerCase();
                  if (entryName === myTwitchLogin) return true;
              }
              return false;
          });

          if (me) {
              myRealTimeStat = me.total_activity ?? me.value ?? me.messages_count ?? 0;
          } else {
              console.log("‚ùå [DEBUG] –ù–µ –Ω–∞—à–µ–ª —Å–µ–±—è –≤ —Ç–æ–ø-50.");
          }
      }
      
      updatePersonalStats(myRealTimeStat);
      // --------------------------------------

      if (!Array.isArray(leaderboardData) || leaderboardData.length === 0) {
        dom.loader.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
        return;
      }

      leaderboardData.forEach((entry, index) => {
        const row = document.createElement('tr');
        let rankContent = index + 1;
        if (index === 0) { row.classList.add('first-place'); rankContent = 'ü•á'; }  
        else if (index === 1) { row.classList.add('second-place'); rankContent = 'ü•à'; }  
        else if (index === 2) { row.classList.add('third-place'); rankContent = 'ü•â'; }
        
        const name = entry.full_name || entry.username || entry.user_name || '...';
        let value = entry.total_activity ?? entry.value ?? entry.messages_count ?? 0;

        if (state.source === 'twitch' && state.twitchMetric === 'uptime') {
            value = formatUptime(value);
        }

        row.innerHTML = `
          <td class="rank">${rankContent}</td>
          <td class="username">${name}</td>
          <td class="count">${value}</td>
        `;
        dom.leaderboardBody.appendChild(row);
      });
      dom.loader.style.display = 'none';
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      dom.loader.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.';
    }
  }
  
  dom.sourceButtons.forEach(button => {
    button.addEventListener('click', () => {
      state.source = button.dataset.source;
      dom.sourceButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      updateUI();
      fetchAndRender();
    });
  });

  dom.telegramPeriodButtons.forEach(button => {
    button.addEventListener('click', () => {
      state.telegramPeriod = button.dataset.period;
      dom.telegramPeriodButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      fetchAndRender();
    });
  });

  dom.twitchMetricButtonList.forEach(button => {
    button.addEventListener('click', () => {
      state.twitchMetric = button.dataset.metric;
      dom.twitchMetricButtonList.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      updateUI();
      fetchAndRender();
    });
  });

  dom.twitchPeriodButtonList.forEach(button => {
    button.addEventListener('click', () => {
      state.twitchPeriod = button.dataset.period;
      dom.twitchPeriodButtonList.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      fetchAndRender();
    });
  });
  
  dom.refreshButtons.forEach(button => {
    button.addEventListener('click', () => {
      initPage(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–≥–æ
    });
  });

  // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
  // –°–Ω–∞—á–∞–ª–∞ –∂–¥–µ–º –ø—Ä–æ—Ñ–∏–ª—å, –ø–æ—Ç–æ–º –≥—Ä—É–∑–∏–º —Ç–∞–±–ª–∏—Ü—É.
  async function initPage() {
      await loadCurrentUser();
      updateUI();
      fetchAndRender();
  }

  initPage();
</script>
</body>
</html>
