<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Admin Cases</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --bg: #0f0f0f;
            --card-bg: rgba(30, 30, 30, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --primary: #ffd700;
            --action: #28a745;
            --danger: #ff4d4d;
            --text: #ffffff;
            --text-sec: #aaaaaa;
            
            /* Rarity Colors */
            --r-blue: #4b69ff;
            --r-purple: #8847ff;
            --r-pink: #d32ce6;
            --r-red: #eb4b4b;
            --r-gold: #ffd700;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { background: none; border: none; color: var(--text-sec); font-size: 16px; cursor: pointer; }
        .page-title { font-size: 20px; font-weight: 800; margin: 0; color: var(--primary); }

        /* CASE TABS (Horizontal Scroll) */
        .cases-nav {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px;
            scrollbar-width: none;
        }
        .cases-nav::-webkit-scrollbar { display: none; }
        
        .case-chip {
            background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
            padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
            color: var(--text-sec); white-space: nowrap; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .case-chip.active { background: var(--primary); color: #000; border-color: var(--primary); }
        .case-chip.add-new { border-style: dashed; border-color: var(--text-sec); color: var(--text); }

        /* ITEMS GRID */
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        
        .item-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 10px; position: relative; overflow: hidden;
            cursor: pointer; transition: transform 0.1s; display: flex; flex-direction: column;
        }
        .item-card:active { transform: scale(0.98); }
        
        /* Rarity Strip */
        .item-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: #555; }
        .item-card[data-rarity="blue"]::after { background: var(--r-blue); }
        .item-card[data-rarity="purple"]::after { background: var(--r-purple); }
        .item-card[data-rarity="pink"]::after { background: var(--r-pink); }
        .item-card[data-rarity="red"]::after { background: var(--r-red); }
        .item-card[data-rarity="gold"]::after { background: var(--r-gold); }

        .card-img { width: 100%; height: 90px; object-fit: contain; margin-bottom: 8px; align-self: center; }
        .card-name { font-size: 11px; font-weight: 700; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .card-meta { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-sec); width: 100%; }
        .card-price { color: var(--primary); font-weight: 700; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal-active { display: flex; }
        .bottom-sheet { background: #1c1c1e; width: 100%; border-radius: 24px 24px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        .form-label { font-size: 12px; color: var(--text-sec); margin-bottom: 5px; display: block; }
        .form-input, .form-select { 
            width: 100%; background: #252525; border: 1px solid var(--card-border);
            color: #fff; padding: 12px; border-radius: 12px; font-size: 14px; outline: none; box-sizing: border-box;
        }
        .form-row { display: flex; gap: 10px; }
        
        /* PREVIEW */
        .preview-box {
            background: #000; border-radius: 12px; padding: 15px; text-align: center;
            border: 1px solid var(--card-border); margin-bottom: 10px;
        }
        .prev-img { width: 100px; height: 80px; object-fit: contain; margin-bottom: 5px; }
        .prev-name { font-size: 12px; font-weight: 700; }
        .prev-price { color: var(--primary); font-size: 13px; font-weight: 700; }

        /* BUTTONS */
        .btn-main { background: var(--primary); color: #000; border: none; padding: 14px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; }
        .btn-danger { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 14px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; margin-top: 10px; }
        .icon-btn { width: 40px; height: 40px; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* ADD MENU FAB */
        .fab-container { position: fixed; bottom: 30px; right: 20px; z-index: 90; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        .fab-main {
            width: 56px; height: 56px; background: var(--primary); color: #000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4); cursor: pointer; transition: transform 0.2s;
        }
        .fab-main.rotate { transform: rotate(45deg); background: #fff; }
        
        .fab-option {
            background: #2c2c2e; border: 1px solid var(--card-border); color: #fff;
            padding: 10px 15px; border-radius: 12px; font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            transform: translateY(20px); opacity: 0; pointer-events: none; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .fab-menu-open .fab-option { transform: translateY(0); opacity: 1; pointer-events: auto; }

        /* SEARCH LIBRARY LIST */
        .search-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px;
        }
        .search-img { width: 40px; height: 30px; object-fit: contain; }
        .search-info { flex: 1; min-width: 0; }
        .search-btn { background: var(--action); color: #fff; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; }

    </style>
</head>
<body>

    <div class="page-header">
        <button onclick="window.location.href='/admin'" class="back-btn"><i class="fa-solid fa-chevron-left"></i> –ù–∞–∑–∞–¥</button>
        <h1 class="page-title">–ö–µ–π—Å—ã</h1>
        <div style="width: 20px;"></div> 
    </div>

    <div class="cases-nav" id="casesNav">
        </div>

    <div id="itemsContainer">
        <div style="text-align:center; padding:40px; color:#555;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="fab-container" id="fabMenu">
        <div class="fab-option" onclick="openLibrarySearch()">
            <span>–ù–∞–π—Ç–∏ –≤ –±–∞–∑–µ</span> <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <div class="fab-option" onclick="openEditor(null)">
            <span>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</span> <i class="fa-solid fa-pen"></i>
        </div>
        <div class="fab-main" onclick="toggleFab()">
            <i class="fa-solid fa-plus"></i>
        </div>
    </div>

    <div id="modal-library" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-library')">
        <div class="bottom-sheet" style="height: 80vh;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –°–∫–∏–Ω–æ–≤</h3>
                <button onclick="closeModal('modal-library')" style="background:none; border:none; color:#777; font-size:20px;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="form-row">
                <input type="text" id="lib-search-inp" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä Asiimov)..." oninput="debounceSearch()">
            </div>

            <div id="lib-results" style="flex:1; overflow-y: auto; margin-top:10px;">
                <div style="text-align:center; color:#555; padding:20px;">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ...</div>
            </div>
        </div>
    </div>

    <div id="modal-editor" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-editor')">
        <div class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0">–†–µ–¥–∞–∫—Ç–æ—Ä –°–∫–∏–Ω–∞</h3>
                <button onclick="closeModal('modal-editor')" style="background:none; border:none; color:#777; font-size:20px;"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="preview-box">
                <div style="font-size:10px; color:#555; margin-bottom:5px;">PREVIEW</div>
                <img src="" id="p-img" class="prev-img">
                <div id="p-name" class="prev-name">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                <div id="p-price" class="prev-price">0 üü°</div>
            </div>

            <form id="edit-form" onsubmit="event.preventDefault(); saveItem();">
                <input type="hidden" name="id">
                
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <label class="form-label">–ö–∞—Ä—Ç–∏–Ω–∫–∞ URL</label>
                        <input type="text" name="image_url" id="inp-img" class="form-input" placeholder="https://..." oninput="updatePreview()">
                    </div>
                    <div style="display:flex; align-items:flex-end;">
                        <input type="file" id="file-upload" hidden accept="image/*" onchange="uploadImage(this)">
                        <button type="button" class="icon-btn" onclick="document.getElementById('file-upload').click()">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </button>
                    </div>
                </div>

                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="name" id="inp-name" class="form-input" required oninput="updatePreview()">

                <div class="form-row" style="margin-top:10px;">
                    <div style="flex:1">
                        <label class="form-label">–¶–µ–Ω–∞</label>
                        <input type="number" name="price" id="inp-price" class="form-input" value="0" oninput="updatePreview()">
                    </div>
                    <div style="flex:1">
                        <label class="form-label">–®–∞–Ω—Å (Weight)</label>
                        <input type="number" name="chance_weight" class="form-input" value="10">
                    </div>
                </div>

                <div class="form-row" style="margin-top:10px;">
                    <div style="flex:1">
                        <label class="form-label">–†–µ–¥–∫–æ—Å—Ç—å</label>
                        <select name="rarity" class="form-select">
                            <option value="common">White (–®–∏—Ä–ø)</option>
                            <option value="blue">Blue (–ê—Ä–º–µ–π—Å–∫–æ–µ)</option>
                            <option value="purple">Purple (–ó–∞–ø—Ä–µ—â.)</option>
                            <option value="pink">Pink (–ó–∞—Å–µ–∫—Ä–µ—á.)</option>
                            <option value="red">Red (–¢–∞–π–Ω–æ–µ)</option>
                            <option value="gold">Gold (–ù–æ–∂)</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label class="form-label">–ö–∞—á–µ—Å—Ç–≤–æ</label>
                        <select name="condition" class="form-select">
                            <option value="FN">FN</option>
                            <option value="MW">MW</option>
                            <option value="FT">FT</option>
                            <option value="WW">WW</option>
                            <option value="BS">BS</option>
                        </select>
                    </div>
                </div>

                <input type="hidden" name="case_tag">

                <button type="submit" class="btn-main" style="margin-top:15px;">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button type="button" id="btn-delete" class="btn-danger" onclick="deleteItem()">–£–î–ê–õ–ò–¢–¨</button>
            </form>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentCase = '';
        let searchTimeout = null;

        // --- Init ---
        loadTags();

        // 1. FAB MENU
        function toggleFab() {
            document.getElementById('fabMenu').classList.toggle('fab-menu-open');
            document.querySelector('.fab-main').classList.toggle('rotate');
        }

        // 2. Load Cases
        async function loadTags() {
            const nav = document.getElementById('casesNav');
            try {
                const res = await fetch('/api/v1/admin/cases/list_tags', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: tg.initData})
                });
                const data = await res.json();
                
                nav.innerHTML = '';
                
                // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π –∫–µ–π—Å"
                const addBtn = document.createElement('div');
                addBtn.className = 'case-chip add-new';
                addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> –ù–æ–≤—ã–π';
                addBtn.onclick = createNewCase;
                nav.appendChild(addBtn);

                data.forEach(t => {
                    if (!t.name) return;
                    // –û–±—Ä–µ–∑–∞–µ–º "–ö–ï–ô–° | " –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                    const name = t.name.replace(/^(–ö–ï–ô–°|CASE)\s*\|\s*/i, '');
                    const chip = document.createElement('div');
                    chip.className = `case-chip ${currentCase === t.name ? 'active' : ''}`;
                    chip.innerText = `${name} (${t.count})`;
                    chip.onclick = () => { currentCase = t.name; renderTags(data); loadItems(t.name); };
                    nav.appendChild(chip);
                });

                // Auto-select first
                if (!currentCase && data.length > 0) {
                    currentCase = data[0].name;
                    renderTags(data); // Re-render to highlight active
                    loadItems(currentCase);
                }
            } catch(e) { console.error(e); }
        }

        function renderTags(data) {
            // Helper to just refresh classes without reloading
            const chips = document.querySelectorAll('.case-chip');
            // –ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ loadTags –ø—Ä–æ—â–µ, –Ω–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
        }

        function createNewCase() {
            const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–µ–π—Å–∞ (–±–µ–∑ —Å–ª–æ–≤–∞ '–ö–µ–π—Å'):");
            if (!name) return;
            const fullTag = "–ö–ï–ô–° | " + name.trim();
            currentCase = fullTag;
            
            document.getElementById('itemsContainer').innerHTML = 
                `<div style="text-align:center; padding:40px; color:#555;">
                    –ö–µ–π—Å "${name}" —Å–æ–∑–¥–∞–Ω.<br>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç.
                </div>`;
            
            // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫ (–≤–∏–∑—É–∞–ª—å–Ω–æ)
            document.querySelectorAll('.case-chip').forEach(c => c.classList.remove('active'));
        }

        // 3. Load Items
        async function loadItems(tag) {
            const cont = document.getElementById('itemsContainer');
            cont.innerHTML = '<div style="text-align:center; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const res = await fetch('/api/v1/admin/cases/get_items', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({case_tag: tag})
                });
                const items = await res.json();
                
                if (items.length === 0) {
                    cont.innerHTML = '<div style="text-align:center; padding:40px; color:#555;">–ü—É—Å—Ç–æ</div>';
                    return;
                }

                let html = '<div class="items-grid">';
                items.forEach(item => {
                    const safeJson = encodeURIComponent(JSON.stringify(item));
                    html += `
                    <div class="item-card" data-rarity="${item.rarity}" onclick="openEditor('${safeJson}')">
                        <img src="${item.image_url}" class="card-img">
                        <div class="card-name">${item.name}</div>
                        <div class="card-meta">
                            <span>w: ${item.chance_weight}</span>
                            <span class="card-price">${item.price} üü°</span>
                        </div>
                    </div>`;
                });
                html += '</div>';
                cont.innerHTML = html;
            } catch (e) { cont.innerHTML = '–û—à–∏–±–∫–∞'; }
        }

        // 4. Library Search Logic
        function openLibrarySearch() {
            toggleFab(); // Close menu
            if (!currentCase) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å!"); return; }
            document.getElementById('modal-library').classList.add('modal-active');
            document.getElementById('lib-search-inp').value = '';
            document.getElementById('lib-results').innerHTML = '<div style="text-align:center;color:#555;padding:20px">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...</div>';
            document.getElementById('lib-search-inp').focus();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(doSearch, 500);
        }

        async function doSearch() {
            const q = document.getElementById('lib-search-inp').value;
            if (q.length < 2) return;
            
            const cont = document.getElementById('lib-results');
            cont.innerHTML = '<div style="text-align:center;color:#555;">–ü–æ–∏—Å–∫...</div>';

            try {
                const res = await fetch('/api/v1/admin/cases/search_items', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: q})
                });
                const items = await res.json();
                
                cont.innerHTML = '';
                if (items.length === 0) {
                    cont.innerHTML = '<div style="text-align:center;color:#555;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }

                items.forEach(item => {
                    cont.innerHTML += `
                    <div class="search-item">
                        <img src="${item.image_url}" class="search-img">
                        <div class="search-info">
                            <div style="font-weight:700; font-size:13px;">${item.name}</div>
                            <div style="font-size:11px; color:#aaa;">${item.price} üü° | ${item.case_tag || '–ë–µ–∑ –∫–µ–π—Å–∞'}</div>
                        </div>
                        <button class="search-btn" onclick="cloneItem(${item.id})">–î–û–ë–ê–í–ò–¢–¨</button>
                    </div>`;
                });
            } catch(e) { console.error(e); }
        }

        async function cloneItem(id) {
            if (!confirm("–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç —Å–∫–∏–Ω –≤ —Ç–µ–∫—É—â–∏–π –∫–µ–π—Å?")) return;
            
            try {
                const res = await fetch('/api/v1/admin/cases/clone_item', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({origin_id: id, target_case: currentCase})
                });
                if (res.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    closeModal('modal-library');
                    loadItems(currentCase); // Refresh current grid
                    loadTags(); // Refresh counts
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏");
                }
            } catch(e) { alert("–°–±–æ–π —Å–µ—Ç–∏"); }
        }

        // 5. Editor Logic
        function openEditor(jsonStr) {
            toggleFab(); // Close menu if open
            const modal = document.getElementById('modal-editor');
            const form = document.getElementById('edit-form');
            const delBtn = document.getElementById('btn-delete');

            if (jsonStr) {
                const item = JSON.parse(decodeURIComponent(jsonStr));
                form.id.value = item.id;
                form.name.value = item.name;
                form.image_url.value = item.image_url;
                form.price.value = item.price;
                form.chance_weight.value = item.chance_weight;
                form.rarity.value = item.rarity;
                form.condition.value = item.condition || 'FN';
                form.case_tag.value = item.case_tag;
                delBtn.style.display = 'block';
            } else {
                if (!currentCase) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å!"); return; }
                form.reset();
                form.id.value = '';
                form.case_tag.value = currentCase;
                form.rarity.value = 'blue';
                form.chance_weight.value = 10;
                delBtn.style.display = 'none';
            }
            updatePreview();
            modal.classList.add('modal-active');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('modal-active'); }

        function updatePreview() {
            const img = document.getElementById('inp-img').value || 'https://placehold.co/100';
            document.getElementById('p-img').src = img;
            document.getElementById('p-name').innerText = document.getElementById('inp-name').value || '–ù–∞–∑–≤–∞–Ω–∏–µ';
            document.getElementById('p-price').innerText = (document.getElementById('inp-price').value || 0) + ' üü°';
        }

        async function saveItem() {
            const form = document.getElementById('edit-form');
            const data = {
                id: form.id.value || null,
                name: form.name.value,
                image_url: form.image_url.value,
                price: parseFloat(form.price.value),
                chance_weight: parseFloat(form.chance_weight.value),
                rarity: form.rarity.value,
                condition: form.condition.value,
                case_tag: form.case_tag.value
            };

            try {
                const res = await fetch('/api/v1/admin/cases/save_item', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('modal-editor');
                    loadItems(currentCase);
                    loadTags(); 
                    tg.HapticFeedback.notificationOccurred('success');
                } else alert("–û—à–∏–±–∫–∞");
            } catch(e) { alert("–°–±–æ–π"); }
        }

        async function deleteItem() {
            const id = document.querySelector('input[name="id"]').value;
            if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
            try {
                await fetch('/api/v1/admin/cases/delete_item', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id})
                });
                closeModal('modal-editor');
                loadItems(currentCase);
                loadTags();
            } catch(e) { alert("–û—à–∏–±–∫–∞"); }
        }

        async function uploadImage(input) {
            const file = input.files[0];
            if(!file) return;
            const btn = input.previousElementSibling;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            const fd = new FormData(); fd.append('file', file);
            try {
                const res = await fetch('/api/v1/upload', {method:'POST', body:fd});
                const d = await res.json();
                if(d.url) {
                    document.getElementById('inp-img').value = d.url;
                    updatePreview();
                }
            } catch(e) { alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
            btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i>';
        }
    </script>
</body>
</html>
