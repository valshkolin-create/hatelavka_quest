<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–µ–Ω—é</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<style>
    :root {
      --bg-gradient: radial-gradient(ellipse at 50% 100%, #041a07, #000000);
      --bg-color: #000000;
      --text-color: #ffffff;
      --text-color-muted: #b0b0b0;
      --quest-icon-color: #ffcc00;
      --primary-gradient: linear-gradient(90deg, #34c759, #2dbf55);
      --primary-color: #34c759;
      --action-color: #007aff;
      --disabled-color: #666;
      --surface-glass-bg: rgba(28, 28, 30, 0.75);
      --twitch-color: #9146ff;
      --danger-color: #ff3b30;
      --telegram-color: #0088CC;
    }
    body { margin: 0; min-height: 100vh; background-color: var(--bg-color); background-image: var(--bg-gradient); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; }
    .main-content { flex-grow: 1; padding: 20px 15px 120px; overflow-y: auto; opacity: 0; transition: opacity 0.4s ease-in-out; }
    .main-content.visible { opacity: 1; }
    .user-profile { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .user-info { display: flex; flex-direction: column; }
    .user-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .profile-link { font-size: 13px; color: var(--action-color); text-decoration: none; font-weight: 500; }
    .stats-block { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
    .stats-link { text-decoration: none; color: inherit; }
    .stats-item { display: flex; align-items: center; justify-content: flex-end; }
    .stats-icon { width: 20px; height: 20px; background-color: #ffffff; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 6px; }
    .stats-icon i { color: #000000; font-size: 11px; }
    .stats-text { font-size: 12px; font-weight: 500; }
    .dashboard-container { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .quests-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .page-title { font-size: 18px; font-weight: 600; margin: 0 0 15px 0; text-align: center; }
    .quest-card { background-color: var(--surface-glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 10px; padding: 10px; text-align: center; display: flex; flex-direction: column; position: relative; }
    .quest-icon { font-size: 20px; color: var(--quest-icon-color); margin-bottom: 8px; text-shadow: 0 0 12px var(--quest-icon-color); }
    .quest-image-icon { width: 32px; height: 32px; border-radius: 6px; margin: 0 auto 8px; object-fit: cover; }
    .quest-title { font-size: 13px; font-weight: 600; line-height: 1.3; margin: 0 0 5px 0; flex-grow: 1; text-align: center; }
    .quest-subtitle { color: var(--text-color-muted); font-size: 11px; margin-bottom: 8px; text-align: center; }
    .progress-bar { width: 100%; height: 30px; background-color: #3a3a3c; border-radius: 15px; overflow: hidden; position: relative; margin-top: 10px; }
    .progress-fill { height: 100%; background: var(--primary-gradient); border-radius: 15px; transition: width 0.5s ease-in-out; }
    .progress-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 0 8px; box-sizing: border-box; z-index: 1; }
    .progress-text { font-weight: 600; font-size: 11px; color: var(--text-color); }
    .perform-quest-button { width: 100%; background-color: var(--action-color); border: none; padding: 8px; border-radius: 6px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: auto; }
    .claim-reward-button { width: 100%; background: linear-gradient(90deg, #ffdd40, #ffc700); color: #1c1c1e; font-size: 14px; font-weight: 700; border: none; border-radius: 8px; padding: 10px; margin-top: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 0 12px rgba(255, 204, 0, 0.5); }
    .claim-reward-button:disabled { background: var(--disabled-color); color: var(--text-color-muted); box-shadow: none; cursor: not-allowed; }
    .cancel-quest-button { width: 100%; background-color: #555; border: none; padding: 8px; border-radius: 6px; color: white; font-size: 12px; font-weight: 500; cursor: pointer; margin-top: 6px; }
    .cancel-quest-button:disabled { background-color: #333; color: #888; cursor: not-allowed;}
    .challenge-card { background-color: rgba(44, 44, 46, 0.85); padding: 12px; }
    .challenge-card .quest-icon { font-size: 18px; margin-bottom: 5px; }
    .challenge-card .quest-title { font-size: 14px; margin-bottom: 5px; }
    .challenge-card .quest-subtitle { font-size: 12px; margin-bottom: 8px; }
    .challenge-card .claim-reward-button { font-size: 13px; padding: 9px; margin-top: 8px; }
    .challenge-timer { font-size: 11px; font-weight: 500; color: var(--text-color-muted); margin-top: 6px; }
    .app-footer { display: flex; justify-content: space-around; align-items: flex-start; background-color: var(--surface-glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid rgba(58, 58, 60, 0.6); width: 100%; padding-top: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); position: fixed; bottom: 0; left: 0; z-index: 100; box-sizing: border-box; }
    .footer-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-color-muted); font-size: 11px; cursor: pointer; text-decoration: none; flex: 1; position: relative; }
    .footer-item .icon-wrapper { font-size: 24px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
    .footer-item.active span, .footer-item.active .icon-wrapper { color: var(--primary-color); font-weight: 600; }
    .hidden { display: none !important; }
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .spinner { width: 36px; height: 36px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .prompt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .prompt-modal { background-color: var(--surface-glass-bg); border: 1px solid rgba(58, 58, 60, 0.6); padding: 15px; border-radius: 12px; width: 85%; max-width: 300px; text-align: center; }
    .prompt-actions { display:flex; gap: 10px; margin-top: 15px; }
    .prompt-actions > * { flex:1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
    .prompt-actions .confirm-btn { background-color: var(--primary-color); color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; }
    .prompt-actions .cancel-btn { background-color: #555; color: white; }
    .info-notice { background-color: rgba(0, 122, 255, 0.15); border-left: 3px solid var(--action-color); padding: 10px 12px; border-radius: 8px; margin: 20px 0 15px; display: flex; align-items: center; gap: 10px; font-size: 12px; line-height: 1.4; color: var(--text-color-muted); }
    .info-notice i { font-size: 18px; color: var(--action-color); flex-shrink: 0; }
    .info-notice strong { color: var(--text-color); font-weight: 600; }
    .active-quest-indicator { position: absolute; top: 8px; right: 10px; font-size: 10px; font-weight: 600; color: var(--primary-color); background-color: rgba(52, 199, 89, 0.15); padding: 3px 7px; border-radius: 7px; }
    .manual-quest-actions {
    margin-top: auto;
    display: flex;
    gap: 6px;
    align-items: center;
    }
    .manual-quest-actions .action-link-btn {
    background-color: #5856d6;
    padding: 5px 8px;
    font-size: 11px;
    border-radius: 5px;
    color: white;
    text-decoration: none;
    font-weight: 500;
    flex-shrink: 0;
    }
    .manual-quest-actions .perform-quest-button {
    flex-grow: 1;
    margin-top: 0;
    padding: 6px;
    font-size: 12px;
    }
    .quest-category-accordion { width: 100%; grid-column: 1 / -1; }
    .quest-category-header { cursor: pointer; font-size: 16px; font-weight: 600; padding: 12px; background-color: rgba(44, 44, 46, 0.85); border-radius: 8px; list-style: none; margin-bottom: 10px; }
    .quest-category-header::-webkit-details-marker { display: none; }
    .quest-category-header::before { content: '‚ñ∂'; display: inline-block; margin-right: 8px; font-size: 12px; transition: transform 0.2s; }
    .quest-category-accordion[open] > .quest-category-header::before { transform: rotate(90deg); }
    .quest-category-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; padding: 5px; }
    .stats-link { text-decoration: none; color: inherit; }
    .social-stats-wrapper {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    }
    .social-links {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    .social-icon-wrapper { width: 28px; height: 28px; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: transform 0.2s ease-in-out; }
    .social-icon-wrapper i { font-size: 16px; color: white; }
    #twitch-icon { background-color: var(--twitch-color); }
    #telegram-icon { background-color: #0088CC; }
    .tickets-item { background: rgba(52, 199, 89, 0.15); border-radius: 12px; padding: 6px 10px; display: flex; align-items: center; justify-content: flex-end; gap: 6px; position: relative; animation: pulse 2s infinite ease-in-out; }
    .tickets-item:hover { animation-play-state: paused; }
    .tickets-item .stats-text { color: var(--primary-color); font-weight: 700; font-size: 14px; }
    .stats-icon-star { background: var(--primary-color); margin-right: 0; }
    .stats-icon-star i { color: #fff; }
    .info-question-icon { font-size: 16px; color: #ffc700; cursor: pointer; margin-left: 4px; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7); }
      70% { box-shadow: 0 0 0 8px rgba(52, 199, 89, 0); }
      100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); }
    }
    .quest-choose-btn-roulette {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      color: #1c1c1e;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.4s ease;
      box-shadow: 0 0 12px rgba(255, 204, 0, 0.5);
    }
    /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–ö–ò --- */
    .quest-choose-btn-roulette.twitch-theme {
      background: linear-gradient(90deg, #a97cff, var(--twitch-color));
      color: white;
      box-shadow: 0 0 12px rgba(145, 70, 255, 0.6);
    }
    .quest-choose-btn-roulette.telegram-theme {
      background: linear-gradient(90deg, #24a1de, var(--telegram-color));
      color: white;
      box-shadow: 0 0 12px rgba(0, 136, 204, 0.6);
    }
    .quest-choose-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      perspective: 1000px;
    }
    .quest-option-card {
      width: 120px;
      height: 160px;
      background: var(--surface-glass-bg);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transform: rotateY(90deg);
      opacity: 0;
      transition: transform 0.6s ease, opacity 0.6s ease;
      text-align: center;
    }
    .quest-option-card.show {
      transform: rotateY(0);
      opacity: 1;
    }
    .quest-option-card.chosen {
      animation: questChosen 0.6s forwards;
    }
    .quest-option-card.fade-out {
      animation: fadeOut 0.5s forwards;
    }
    @keyframes questChosen {
      to {
        transform: scale(0.1) translateY(-100px);
        opacity: 0;
      }
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: scale(0.9);
      }
    }

    .twitch-update-notice {
        font-size: 10px;
        color: var(--text-color-muted);
        margin-top: 8px;
        padding: 4px;
        background-color: rgba(0,0,0,0.2);
        border-radius: 4px;
    }
    .promo-notification {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight: 600;
        animation: fadeInDown 0.5s ease-out;
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .promo-notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.7;
    }
</style>
</head>
<body>
  <div id="loader-overlay" class="loader-overlay">
    <div class="spinner"></div>
  </div>

  <main id="main-content" class="main-content">

    <div id="new-promo-notification" class="promo-notification hidden">
        <span>üèÜ –ù–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å!</span>
        <button id="close-promo-notification" class="promo-notification-close">&times;</button>
    </div>

    <div class="user-profile">
      <div class="user-info">
        <div id="fullName" class="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <a href="/profile" class="profile-link">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
      </div>
      <div class="stats-block">
        <div class="social-stats-wrapper">
          <div class="social-links">
            <a href="https://t.me/hatelovettv" target="_blank" rel="noopener noreferrer" class="stats-link">
                <div class="social-icon-wrapper" id="telegram-icon"><i class="fa-brands fa-telegram"></i></div>
            </a>
            <a href="https://www.twitch.tv/hatelove_ttv" target="_blank" rel="noopener noreferrer" class="stats-link">
                <div class="social-icon-wrapper" id="twitch-icon"><i class="fa-brands fa-twitch"></i></div>
            </a>
          </div>
          <div class="stats-item tickets-item">
              <span id="ticketStats" class="stats-text">0</span>
              <div class="stats-icon stats-icon-star"><i class="fa-solid fa-ticket"></i></div>
              <i class="fa-solid fa-circle-question info-question-icon" id="info-question-icon"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div id="view-dashboard" class="view">
        <a href="/events" style="text-decoration: none; display: block; margin-bottom: 15px;">
            <img src="https://i.postimg.cc/d0r554hc/1200-600.png?v=2" alt="–ì–æ–Ω–∫–∞ –∑–∞ —Å–∫–∏–Ω–∞–º–∏" style="width: 100%; border-radius: 12px;">
        </a>
        
        <div id="challenge-container"></div>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
      
        <a id="checkpoint-link" href="/checkpoint" style="text-decoration: none; display: block; margin-bottom: 15px;">
            <img src="https://i.postimg.cc/6p39wgzJ/1200-324.png" alt="–ú–∞—Ä–∞—Ñ–æ–Ω –ß–µ–∫–ø–æ–∏–Ω—Ç" style="width: 100%; border-radius: 12px; display: block;">
        </a>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
      
        <div id="quest-choose-wrapper">
            <button id="quest-choose-btn" class="quest-choose-btn-roulette">–ù–ê–ß–ê–¢–¨ –ò–°–ü–´–¢–ê–ù–ò–ï</button>
            <div id="quest-choose-container" class="quest-choose-container hidden"></div>
        </div>
        <div id="active-automatic-quest-container"></div>
        
    </div>
    
    <div id="view-quests" class="view quests-container hidden">
        <h2 class="page-title" style="grid-column: 1 / -1;">–ó–∞–¥–∞–Ω–∏—è —Å —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π</h2>
    </div>
  </main>
  
  <footer class="app-footer">
    <a href="/leaderboard" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-trophy"></i></div><span>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</span></a>
    <a href="#" id="nav-dashboard" class="footer-item active"><div class="icon-wrapper"><i class="fa-solid fa-house"></i></div><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
    <a href="#" id="nav-quests" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-check-double"></i></div><span>–ó–∞–¥–∞–Ω–∏—è</span></a>    
    <a href="/events" class="footer-item"><div class="icon-wrapper"><i class="fa-solid fa-gift"></i></div><span>–ò–≤–µ–Ω—Ç—ã</span></a>    
    <a href="/admin" id="nav-admin" class="footer-item hidden"><div class="icon-wrapper"><i class="fa-solid fa-user-shield"></i></div><span>–ê–¥–º–∏–Ω–∫–∞</span></a>
  </footer>
  
<div id="promocode-overlay" class="promocode-overlay hidden">
    </div>

<div id="reward-claimed-overlay" class="prompt-overlay hidden">
    <div class="prompt-modal">
        <h3>–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!</h3>
        <p style="font-size: 14px; line-height: 1.5; color: var(--text-color-muted);">
            –ü—Ä–æ–º–æ–∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –≤—Å–µ —Å–≤–æ–∏ –Ω–∞–≥—Ä–∞–¥—ã —Ç–∞–º.
        </p>
        <div class="prompt-actions">
            <button id="reward-close-btn" class="cancel-btn">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            <a href="/profile" class="confirm-btn">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
</div>

<div id="info-modal-overlay" class="prompt-overlay hidden">
    <div class="prompt-modal">
        <h3>–ß—Ç–æ —Ç–∞–∫–æ–µ –±–∏–ª–µ—Ç—ã?</h3>
        <p style="font-size: 14px; line-height: 1.5; color: var(--text-color-muted);">
            –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –∏ —á–µ–ª–ª–µ–Ω–¥–∂–∏, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–∏–ª–µ—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö —Ü–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–æ–≤!
        </p>
        <div class="prompt-actions">
            <button class="confirm-btn" id="info-modal-close-btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>
</div>

<div id="custom-prompt-overlay" class="prompt-overlay hidden">
    <div class="prompt-modal">
        <h3 id="prompt-title">Title</h3>
        <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>
        <input type="text" id="prompt-input" placeholder="–í–∞—à –Ω–∏–∫ –∏–ª–∏ —Å—Å—ã–ª–∫–∞...">
        <div class="prompt-actions">
            <button id="prompt-cancel" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
            <button id="prompt-confirm" class="confirm-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    try {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const updatedBalance = localStorage.getItem('userTicketBalance');
        if (updatedBalance !== null) {
            document.getElementById('ticketStats').textContent = updatedBalance;
            localStorage.removeItem('userTicketBalance');
        }

        const dom = {
            loaderOverlay: document.getElementById('loader-overlay'),
            mainContent: document.getElementById('main-content'),
            fullName: document.getElementById('fullName'),
            navAdmin: document.getElementById('nav-admin'),
            footerItems: document.querySelectorAll('.footer-item'),
            viewDashboard: document.getElementById('view-dashboard'),
            viewQuests: document.getElementById('view-quests'),
            challengeContainer: document.getElementById('challenge-container'),
            activeAutomaticQuestContainer: document.getElementById('active-automatic-quest-container'),
            
            promocodeOverlay: document.getElementById('promocode-overlay'),
            rewardClaimedOverlay: document.getElementById('reward-claimed-overlay'),
            rewardCloseBtn: document.getElementById('reward-close-btn'),
            
            promptOverlay: document.getElementById('custom-prompt-overlay'),
            promptTitle: document.getElementById('prompt-title'),
            promptInput: document.getElementById('prompt-input'),
            promptCancel: document.getElementById('prompt-cancel'),
            promptConfirm: document.getElementById('prompt-confirm'),

            infoQuestionIcon: document.getElementById('info-question-icon'),
            infoModalOverlay: document.getElementById('info-modal-overlay'),
            infoModalCloseBtn: document.getElementById('info-modal-close-btn'),

            questChooseBtn: document.getElementById("quest-choose-btn"),
            questChooseContainer: document.getElementById("quest-choose-container"),

            newPromoNotification: document.getElementById('new-promo-notification'),
            closePromoNotification: document.getElementById('close-promo-notification'),
        };

        let currentQuestId = null;
        let countdownIntervals = {};
        let allQuests = [];
        let userData = {};
        let questsForRoulette = [];

        function showNewPromoNotification() {
            sessionStorage.setItem('newPromoReceived', 'true');
            dom.newPromoNotification.classList.remove('hidden');
        }

        function showRewardClaimedModal() {
            showNewPromoNotification();
            dom.rewardClaimedOverlay.classList.remove('hidden');
        }
        function hideRewardClaimedModal() {
            dom.rewardClaimedOverlay.classList.add('hidden');
        }

        function showInfoModal() {
            dom.infoModalOverlay.classList.remove('hidden');
        }
        function hideInfoModal() {
            dom.infoModalOverlay.classList.add('hidden');
        }

        function showCustomPrompt(title, questId) {
            currentQuestId = questId;
            dom.promptTitle.textContent = title;
            dom.promptInput.value = '';
            dom.promptOverlay.classList.remove('hidden');
            dom.promptInput.focus();
        }

        function hideCustomPrompt() {
            dom.promptOverlay.classList.add('hidden');
        }
        
        function switchView(targetViewId) {
            dom.viewDashboard.classList.add('hidden');
            dom.viewQuests.classList.add('hidden');
            document.getElementById(targetViewId)?.classList.remove('hidden');
            
            dom.footerItems.forEach(item => item.classList.remove('active'));
            const navId = `nav-${targetViewId.split('-')[1]}`;
            document.getElementById(navId)?.classList.add('active');
        }
        
        async function makeApiRequest(url, body = {}, method = 'POST', isSilent = false) {
            if (!isSilent) dom.loaderOverlay.classList.remove('hidden');
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (method !== 'GET') {
                    options.body = JSON.stringify({ ...body, initData: Telegram.WebApp.initData });
                }
                const response = await fetch(url, options);
                
                if (response.status === 429) {
                    const errorResult = await response.json();
                    Telegram.WebApp.showAlert(errorResult.detail || '–î–µ–π—Å—Ç–≤–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.');
                    throw new Error('Cooldown active'); 
                }

                if (response.status === 204) return null;
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || result.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                
                return result;

            } catch (e) {
                if (e.message !== 'Cooldown active' && !isSilent) {
                     Telegram.WebApp.showAlert(`–û—à–∏–±–∫–∞: ${e.message}`);
                }
                throw e;
            } finally {
                if (!isSilent) dom.loaderOverlay.classList.add('hidden');
            }
        }

       function startCountdown(timerElement, expiresAt, intervalKey, onEndCallback) {
            if (countdownIntervals[intervalKey]) {
                clearInterval(countdownIntervals[intervalKey]);
            }
            // –°–¢–ê–õ–û: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç —Ç–∞–π–º–µ—Ä–∞ –≤–æ–æ–±—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
            if (!timerElement) { 
                return;
            }

            const endTime = new Date(expiresAt).getTime();
            
            const updateTimer = () => {
                const currentTimerElement = document.getElementById(timerElement.id);
                if (!currentTimerElement) {
                    clearInterval(countdownIntervals[intervalKey]);
                    return;
                }

                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(countdownIntervals[intervalKey]);
                    delete countdownIntervals[intervalKey];
                    
                    if (onEndCallback) {
                        onEndCallback();
                    } 
                    // –°–¢–ê–õ–û: –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞
                    else if (intervalKey === 'challenge') {
                        const cardElement = currentTimerElement.closest('.quest-card');
                        if (cardElement) {
                           currentTimerElement.remove();
                           const completeButton = document.createElement('button');
                           completeButton.id = 'check-challenge-progress-btn';
                           completeButton.className = 'claim-reward-button';
                           completeButton.innerHTML = '<i class="fa-solid fa-flag-checkered"></i> <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>';
                           cardElement.appendChild(completeButton);
                        }
                    } 
                    // –°–¢–ê–õ–û: –£–±–∏—Ä–∞–µ–º "–í—Ä–µ–º—è –≤—ã—à–ª–æ" –¥–ª—è –∑–∞–¥–∞–Ω–∏–π, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –±–∞–≥
                    else if (intervalKey.startsWith('quest_')) {
                        currentTimerElement.style.display = 'none';
                    }

                    if (intervalKey === 'challenge_cooldown') {
                        refreshDataSilently();
                    }
                    return;
                }

                const d = Math.floor(distance / 86400000);
                const h = Math.floor((distance % 86400000) / 3600000);
                const m = Math.floor((distance % 3600000) / 60000);
                const s = Math.floor((distance % 60000) / 1000);
                
                let result = '';
                if (d > 0) result += `${d}–¥ `;
                result += `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                currentTimerElement.textContent = result;
            };
            
            countdownIntervals[intervalKey] = setInterval(updateTimer, 1000);
            updateTimer();
        }
        
        function clearAllCountdowns() {
            Object.keys(countdownIntervals).forEach(key => {
                clearInterval(countdownIntervals[key]);
            });
            countdownIntervals = {};
        }
        
        function createTwitchNoticeHtml() {
            return `<div class="twitch-update-notice">‚ÑπÔ∏è –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (–¥–æ 30 –º–∏–Ω).</div>`;
        }

        function renderChallenge(challengeData, isGuest) {
            dom.challengeContainer.innerHTML = '';
            // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ú—ã —É–±—Ä–∞–ª–∏ –æ—Ç—Å—é–¥–∞ –≤—Å—é –ª–æ–≥–∏–∫—É, —É–ø—Ä–∞–≤–ª—è—é—â—É—é –∫–Ω–æ–ø–∫–æ–π –∑–∞–¥–∞–Ω–∏–π.
            
            if (isGuest) {
                dom.challengeContainer.innerHTML = `
                    <div class="quest-card quest-locked">
                        <div class="quest-icon"><i class="fa-brands fa-twitch"></i></div>
                        <h2 class="quest-title">–°–ª—É—á–∞–π–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂</h2>
                        <p class="quest-subtitle">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —á–µ–ª–ª–µ–Ω–¥–∂–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∫–∞ Twitch-–∞–∫–∫–∞—É–Ω—Ç–∞.</p>
                        <a href="/profile" class="perform-quest-button" style="text-decoration: none;">–ü—Ä–∏–≤—è–∑–∞—Ç—å Twitch</a>
                    </div>`;
                return;
            }

            if (challengeData && challengeData.cooldown_until) {
                dom.challengeContainer.innerHTML = `
                    <div class="quest-card challenge-card">
                        <div class="quest-icon"><i class="fa-solid fa-hourglass-half"></i></div>
                        <h2 class="quest-title">–°–ª–µ–¥—É—é—â–∏–π —á–µ–ª–ª–µ–Ω–¥–∂</h2>
                        <p class="quest-subtitle">–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞.</p>
                        <div id="challenge-cooldown-timer" class="challenge-timer" style="font-size: 14px; font-weight: 600; color: var(--primary-color); margin-top: 10px;">...</div>
                    </div>`;
                if (!countdownIntervals['challenge_cooldown']) {
                    startCountdown(document.getElementById('challenge-cooldown-timer'), challengeData.cooldown_until, 'challenge_cooldown');
                }
                return;
            }

            if (!challengeData || !challengeData.description) {
                dom.challengeContainer.innerHTML = `
                    <div class="quest-card challenge-card">
                        <div class="quest-icon"><i class="fa-solid fa-dice"></i></div>
                        <h2 class="quest-title">–°–ª—É—á–∞–π–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂</h2>
                        <p class="quest-subtitle">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É! –ü–æ–ª—É—á–∏ —Å–ª—É—á–∞–π–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–∏ –µ–≥–æ.</p>
                        <button id="get-challenge-btn" class="claim-reward-button">
                            <i class="fa-solid fa-play"></i> <span>–ü–æ–ª—É—á–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂</span>
                        </button>
                    </div>`;
                return;
            }
            
            const challenge = challengeData; 
            const currentProgress = challenge.progress_value || 0;
            const target = challenge.target_value || 1;
            const percent = target > 0 ? Math.min(100, (currentProgress / target) * 100) : 0;
            const canClaim = currentProgress >= target && !challenge.claimed_at;
            const isCompleted = currentProgress >= target;
            let statusText = '';
            if (challenge.claimed_at) {
                statusText = '<div style="color: #34C759; font-size: 12px; margin: 5px 0;">‚úÖ –ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞</div>';
            } else if (isCompleted) {
                statusText = '<div style="color: #FFCC00; font-size: 12px; margin: 5px 0;">üéÅ –ù–∞–≥—Ä–∞–¥–∞ –≥–æ—Ç–æ–≤–∞!</div>';
            }
            const isTwitchChallenge = challenge.condition_type && challenge.condition_type.includes('twitch');
            const twitchNotice = isTwitchChallenge ? createTwitchNoticeHtml() : '';
            const claimButton = `<button id="claim-challenge-btn" data-challenge-id="${challenge.challenge_id}" class="claim-reward-button" ${!canClaim ? 'disabled' : ''}><i class="fa-solid fa-gift"></i> <span>–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É</span></button>`;
            let progressTextContent = `${currentProgress} / ${target}`;
            const conditionType = challenge.condition_type || '';
            if (conditionType.includes('twitch_uptime')) {
                progressTextContent = `${currentProgress} / ${target} –º–∏–Ω.`;
            } else if (conditionType.includes('twitch_messages')) {
                progressTextContent = `üí¨ ${currentProgress} / ${target}`;
            } else if (conditionType.includes('telegram_messages')) {
                progressTextContent = `‚úâÔ∏è ${currentProgress} / ${target}`;
            }
            dom.challengeContainer.innerHTML = `
                <div class="quest-card challenge-card">
                    <div class="quest-icon"><i class="fa-solid fa-star"></i></div>
                    <h2 class="quest-title">${challenge.description || ''}</h2>
                    ${statusText}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%;"></div>
                        <div class="progress-content">
                            <span class="progress-text">${progressTextContent}</span>
                        </div>
                    </div>
                    <div id="challenge-timer" class="challenge-timer">...</div>
                    ${twitchNotice}
                    ${claimButton}
                </div>`;
            if (challenge.expires_at) {
                startCountdown(document.getElementById('challenge-timer'), challenge.expires_at, 'challenge');
            }
        }
        
        function renderActiveAutomaticQuest(quest, userData) {
            dom.activeAutomaticQuestContainer.innerHTML = '';
            if (!quest || !userData || !userData.active_quest_id) {
                return;
            }
            
            const activeQuest = allQuests.find(q => q.id === userData.active_quest_id);
            if (!activeQuest) return;

            const iconHtml = (activeQuest.icon_url && activeQuest.icon_url !== "") ? `<img src="${activeQuest.icon_url}" class="quest-image-icon" alt="–ò–∫–æ–Ω–∫–∞ –∫–≤–µ—Å—Ç–∞">` : `<div class="quest-icon"><i class="fa-solid fa-bolt"></i></div>`;
            const progress = userData.active_quest_progress || 0;
            const target = activeQuest.target_value || 1;
            const percent = target > 0 ? Math.min(100, (progress / target) * 100) : 0;
            const isCompleted = progress >= target;

            const isTwitchQuest = activeQuest.quest_type && activeQuest.quest_type.includes('twitch');
            const twitchNotice = isTwitchQuest ? createTwitchNoticeHtml() : '';

            let buttonHtml = '';
            if (isCompleted) {
                buttonHtml = `<button class="claim-reward-button" data-quest-id="${activeQuest.id}"><i class="fa-solid fa-gift"></i> <span>–ó–∞–±—Ä–∞—Ç—å</span></button>`;
            } else {
                const lastCancel = userData.last_quest_cancel_at;
                let cancelBtnDisabled = false;
                let cooldownEndTime = null;

                if (lastCancel) {
                    const lastCancelDate = new Date(lastCancel);
                    const now = new Date();
                    const diffHours = (now - lastCancelDate) / 3600000;
                    if (diffHours < 24) {
                        cancelBtnDisabled = true;
                        cooldownEndTime = new Date(lastCancelDate.getTime() + 24 * 60 * 60 * 1000);
                    }
                }
                
                buttonHtml = `<button id="cancel-quest-btn" class="cancel-quest-button" ${cancelBtnDisabled ? 'disabled' : ''}>–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
                
                if (cancelBtnDisabled) {
                    setTimeout(() => {
                        const btn = document.getElementById('cancel-quest-btn');
                        if (btn) {
                             startCountdown(btn, cooldownEndTime, 'quest_cancel', () => {
                                btn.disabled = false;
                                btn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å';
                            });
                        }
                    }, 0);
                }
            }
            
            const currentProgress = Math.min(progress, target);
            let progressTextContent = `${currentProgress} / ${target}`;
            const questType = activeQuest.quest_type || '';

            if (questType.includes('twitch_uptime')) {
                progressTextContent = `${currentProgress} / ${target} –º–∏–Ω.`;
            } else if (questType.includes('twitch_messages')) {
                progressTextContent = `üí¨ ${currentProgress} / ${target}`;
            } else if (questType.includes('telegram_messages')) {
                progressTextContent = `‚úâÔ∏è ${currentProgress} / ${target}`;
            }

            const timerHtml = activeQuest.end_date ? `<div id="quest-timer-${activeQuest.id}" class="challenge-timer"></div>` : '';

            dom.activeAutomaticQuestContainer.innerHTML = `
                <div class="quest-card">
                    ${!isCompleted ? '<div class="active-quest-indicator">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</div>' : ''}
                    <div class="quest-content-wrapper">
                        ${iconHtml}
                        <h2 class="quest-title">${activeQuest.title || ''}</h2>
                        <p class="quest-subtitle">${activeQuest.description || ''}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%;"></div>
                            <div class="progress-content"><span class="progress-text">${progressTextContent}</span></div>
                        </div>
                        ${timerHtml}
                        ${twitchNotice}
                    </div>
                    ${buttonHtml}
                </div>`;
            
            if (activeQuest.end_date) {
                startCountdown(document.getElementById(`quest-timer-${activeQuest.id}`), activeQuest.end_date, `quest_${activeQuest.id}`);
            }
            
            dom.questChooseBtn.classList.add('hidden');
            dom.questChooseContainer.classList.add('hidden');
        }

        function renderManualQuests(quests, categories) {
            const container = dom.viewQuests;
            const title = container.querySelector('.page-title'); 
            container.innerHTML = ''; 
            if (title) container.appendChild(title); 

            if (!quests || quests.length === 0) {
                container.insertAdjacentHTML('beforeend', `<p style="text-align: center; font-size: 12px; color: var(--text-color-muted); grid-column: 1 / -1;">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>`);
                return;
            }

            const groupedQuests = quests.reduce((acc, quest) => {
                const category = quest.quest_categories ? quest.quest_categories.name : '–†–∞–∑–Ω–æ–µ';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(quest);
                return acc;
            }, {});

            for (const categoryName in groupedQuests) {
                const questsInCategory = groupedQuests[categoryName];
                
                const questsHtml = questsInCategory.map(quest => {
                    const iconHtml = (quest.icon_url && quest.icon_url !== "") ? `<img src="${quest.icon_url}" class="quest-image-icon" alt="–ò–∫–æ–Ω–∫–∞ –∫–≤–µ—Å—Ç–∞">` : `<div class="quest-icon"><i class="fa-solid fa-user-check"></i></div>`;
                    const actionLinkHtml = (quest.action_url && quest.action_url !== "")
                        ? `<a href="${quest.action_url}" target="_blank" rel="noopener noreferrer" class="action-link-btn">–ü–µ—Ä–µ–π—Ç–∏</a>`
                        : '';
                    const submitButtonText = (quest.action_url && quest.action_url !== "") ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' : '–í—ã–ø–æ–ª–Ω–∏—Ç—å';
                    
                    return `
                        <div class="quest-card" style="display: flex; flex-direction: column;">
                            <div style="flex-grow: 1;">
                                ${iconHtml}
                                <h2 class="quest-title">${quest.title || ''}</h2>
                                <p class="quest-subtitle">${quest.description || ''}</p>
                                <p class="quest-subtitle">–ù–∞–≥—Ä–∞–¥–∞: ${quest.reward_amount || ''} ‚≠ê</p>
                            </div>
                            <div class="manual-quest-actions">
                                ${actionLinkHtml}
                                <button class="perform-quest-button" data-id="${quest.id}" data-title="${quest.title}">${submitButtonText}</button>
                            </div>
                        </div>
                    `;
                }).join('');

                const accordionHtml = `
                    <details class="quest-category-accordion">
                        <summary class="quest-category-header">${categoryName}</summary>
                        <div class="quest-category-body">
                            ${questsHtml}
                        </div>
                    </details>
                `;
                container.insertAdjacentHTML('beforeend', accordionHtml);
            }
        }
        
        async function refreshDataSilently() {
            try {
                const dashboardData = await makeApiRequest("/api/v1/user/me", {}, 'POST', true);

                if (dashboardData) {
                    userData = dashboardData || {};
                    const challengeData = dashboardData.challenge;
                    
                    const activeQuest = allQuests.find(q => q.id === userData.active_quest_id);
                    if (activeQuest) {
                        renderActiveAutomaticQuest(activeQuest, userData);
                    }
                    
                    if (challengeData) {
                        renderChallenge(challengeData, !userData.twitch_id);
                    } else {
                        renderChallenge({ cooldown_until: userData.challenge_cooldown_until }, !userData.twitch_id);
                    }
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", e);
            }
        }

        async function startChallengeRoulette() {
            const getChallengeBtn = document.getElementById('get-challenge-btn');
            if(getChallengeBtn) getChallengeBtn.disabled = true;
            dom.loaderOverlay.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
            
            try {
                // –®–ê–ì 1: –°–ù–ê–ß–ê–õ–ê –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
                const available = await makeApiRequest('/api/v1/user/challenge/available');

                // –®–ê–ì 2: –¢–û–õ–¨–ö–û –ü–û–¢–û–ú –ø—Ä–æ—Å–∏–º –Ω–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞–º –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö
                const assignedChallenge = await makeApiRequest('/api/v1/user/challenge');
                
                dom.loaderOverlay.classList.add('hidden'); // –ü—Ä—è—á–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
                
                if (assignedChallenge && assignedChallenge.cooldown_until) {
                    renderChallenge(assignedChallenge, false);
                    return;
                }

                if (!available || available.length === 0 || !assignedChallenge || !assignedChallenge.challenges) {
                    Telegram.WebApp.showAlert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.');
                    if(getChallengeBtn) getChallengeBtn.disabled = false;
                    return;
                }

                // –≠—Ç–∞ —á–∞—Å—Ç—å –∫–æ–¥–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ä—É–ª–µ—Ç–∫–∏ –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                const overlay = document.createElement('div');
                overlay.className = 'prompt-overlay';
                overlay.innerHTML = `<div style="width: 90%; max-width: 400px; height: 150px; background: var(--surface-glass-bg); border-radius: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;"><div id="roulette-inner" style="position: absolute; width: 100%; top: 0;"></div><div style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 100%; height: 50px; border-top: 2px solid var(--primary-color); border-bottom: 2px solid var(--primary-color); box-sizing: border-box; z-index: 1;"></div></div>`;
                document.body.appendChild(overlay);
                const inner = overlay.querySelector('#roulette-inner');
                const itemHeight = 50;
                let rouletteItems = [];
                for (let i = 0; i < 30; i++) rouletteItems.push(...available.sort(() => Math.random() - 0.5));
                rouletteItems.push(assignedChallenge.challenges);
                inner.innerHTML = rouletteItems.map(item => `<div data-id="${item.id}" style="height: ${itemHeight}px; display: flex; flex-direction: column; align-items: center; justify-content: center;"><div style="font-size: 14px; font-weight: 600;">${item.description}</div><div style="font-size: 11px; color: var(--quest-icon-color);">–ù–∞–≥—Ä–∞–¥–∞: ${item.reward_amount} ‚≠ê</div></div>`).join('');
                
                await new Promise(resolve => setTimeout(resolve, 100));

                const winnerElement = Array.from(inner.querySelectorAll(`[data-id="${assignedChallenge.challenge_id}"]`)).pop();
                if (winnerElement) {
                    const centeredPosition = winnerElement.offsetTop - (inner.parentElement.clientHeight / 2) + (itemHeight / 2);
                    inner.style.transition = 'transform 6s cubic-bezier(0.2, 0.8, 0.2, 1)';
                    inner.style.transform = `translateY(-${centeredPosition}px)`;
                    setTimeout(() => {
                        overlay.remove();
                        // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–º–µ—Å—Ç–æ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
                        main();
                    }, 7000);
                }
            } catch (e) {
                // makeApiRequest —É–∂–µ –ø–æ–∫–∞–∂–µ—Ç –æ—à–∏–±–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 409)
                dom.loaderOverlay.classList.add('hidden');
                if(getChallengeBtn) getChallengeBtn.disabled = false;
            }
        }
        
        async function startQuestRoulette() {
            dom.questChooseBtn.disabled = true;
            
            if (questsForRoulette.length === 0) {
                Telegram.WebApp.showAlert("–°–µ–π—á–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π.");
                dom.questChooseBtn.disabled = false;
                return;
            }

            const container = dom.questChooseContainer;
            container.innerHTML = "";
            dom.questChooseContainer.classList.remove('hidden');

            const shuffled = [...questsForRoulette].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 3);

            selected.forEach((quest, index) => {
                const card = document.createElement("div");
                card.className = "quest-option-card";
                card.innerHTML = `
                    <div class="quest-icon"><i class="fa-solid fa-bolt"></i></div>
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-subtitle">–ù–∞–≥—Ä–∞–¥–∞: ${quest.reward_amount} ‚≠ê</div>
                `;

                setTimeout(() => card.classList.add("show"), index * 200);

                card.addEventListener("click", async () => {
                    card.classList.add("chosen");
                    Array.from(container.children).forEach(otherCard => {
                        if (otherCard !== card) {
                            otherCard.classList.add("fade-out");
                        }
                    });
                    
                    setTimeout(async () => {
                        try {
                            await makeApiRequest("/api/v1/quests/start", { quest_id: quest.id });
                            Telegram.WebApp.showAlert(`‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏ –∑–∞–¥–∞–Ω–∏–µ: ${quest.title}`);
                            await main();
                        } catch(e) {
                            // handle error
                        } finally {
                            container.innerHTML = "";
                            dom.questChooseBtn.disabled = false;
                        }
                    }, 600);
                });
                container.appendChild(card);
            });
        }
        
        function hideQuestRoulette() {
            const container = dom.questChooseContainer;
            Array.from(container.children).forEach(card => card.classList.add('fade-out'));
            
            setTimeout(() => {
                container.innerHTML = '';
                container.classList.add('hidden');
                dom.questChooseBtn.disabled = false;
            }, 500);
        }

        function setupEventListeners() {
            document.getElementById('nav-dashboard').addEventListener('click', async (e) => { 
                e.preventDefault(); 
                switchView('view-dashboard');
                await main();
            });

            document.getElementById('nav-quests').addEventListener('click', async (e) => { 
                e.preventDefault(); 
                switchView('view-quests');
                
                const manualQuests = await makeApiRequest("/api/v1/quests/manual");
                const categories = await makeApiRequest("/api/v1/quests/categories");
                renderManualQuests(manualQuests, categories);
            });

            dom.promptCancel.addEventListener('click', hideCustomPrompt);
            dom.promptConfirm.addEventListener('click', async () => {
                const text = dom.promptInput.value.trim();
                if (!text) return;
                const questIdForSubmission = currentQuestId;
                hideCustomPrompt();
                await makeApiRequest(`/api/v1/quests/${questIdForSubmission}/submit`, { submittedData: text });
                Telegram.WebApp.showAlert('–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!');
            });
            
            dom.rewardCloseBtn.addEventListener('click', () => {
                hideRewardClaimedModal();
                main();
            });

            dom.infoQuestionIcon.addEventListener('click', showInfoModal);
            dom.infoModalCloseBtn.addEventListener('click', hideInfoModal);
            
            dom.questChooseBtn.addEventListener("click", () => {
                if(dom.questChooseContainer.classList.contains('hidden')) {
                    startQuestRoulette();
                } else {
                    hideQuestRoulette();
                }
            });

            dom.closePromoNotification.addEventListener('click', () => {
                dom.newPromoNotification.classList.add('hidden');
                sessionStorage.removeItem('newPromoReceived');
            });
            
            document.body.addEventListener('click', async (event) => {
                const target = event.target.closest('button');
                if (!target) return;

                if (target.id === 'get-challenge-btn') {
                    await startChallengeRoulette();
                
                } else if (target.id === 'claim-challenge-btn') {
                    target.disabled = true;
                    target.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                    try {
                        const challengeId = target.dataset.challengeId; 
                        if (!challengeId) throw new Error("ID —á–µ–ª–ª–µ–Ω–¥–∂–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");

                        const result = await makeApiRequest(`/api/v1/challenges/${challengeId}/claim`, {}, 'POST');
                        
                        if (result.success) {
                            showRewardClaimedModal(); 
                            dom.rewardCloseBtn.onclick = async () => {
                                hideRewardClaimedModal();
                                await main();
                            };
                        } else {
                            Telegram.WebApp.showAlert(result.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É");
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ claim:", e);
                        target.disabled = false;
                        target.innerHTML = '<i class="fa-solid fa-gift"></i> <span>–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É</span>';
                    }
                
                } else if (target.classList.contains('claim-reward-button') && target.dataset.questId) {
                    const questId = target.dataset.questId;
                    if (!questId) return;

                    target.disabled = true;
                    try {
                        const result = await makeApiRequest('/api/v1/promocode', { quest_id: parseInt(questId) });
                        if (result && result.promocode) {
                            showRewardClaimedModal();
                        }
                    } catch (e) {
                        target.disabled = false;
                    }
                } else if (target.classList.contains('perform-quest-button') && target.dataset.id) {
                    const questId = target.dataset.id;
                    const questTitle = target.dataset.title;
                    if (!questId) return;
                    
                    showCustomPrompt(questTitle, questId);

                } else if (target.id === 'check-challenge-progress-btn') {
                    target.disabled = true;
                    target.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                    try {
                        // –í—ã–∑—ã–≤–∞–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                        await makeApiRequest("/api/v1/user/challenge/check");
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–æ—Ç–æ–≤—É—é –∫ —Å–±–æ—Ä—É –Ω–∞–≥—Ä–∞–¥—É)
                        await main();
                    } catch (e) {
                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        target.disabled = false;
                        target.innerHTML = '<i class="fa-solid fa-flag-checkered"></i> <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>';
                    }
                    
                } else if (target.id === 'cancel-quest-btn') {
                    Telegram.WebApp.showConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ? –í—ã —Å–º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤–æ–µ, –Ω–æ –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏—è –º–æ–∂–Ω–æ –ª–∏—à—å —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.", async (ok) => {
                        if (ok) {
                            try {
                                await makeApiRequest('/api/v1/quests/cancel');
                                Telegram.WebApp.showAlert('–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤–æ–µ.');
                                await main();
                            } catch (e) {
                            }
                        }
                    });
                }
            });
        } // <--- –í–û–¢ –ü–†–ê–í–ò–õ–¨–ù–û–ï –ú–ï–°–¢–û –î–õ–Ø –ó–ê–ö–†–´–í–ê–Æ–©–ï–ô –°–ö–û–ë–ö–ò

        async function main() {
            console.log("--- –ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ main() ---");
            if (!Telegram.WebApp.initData) {
                document.body.innerHTML = `<div style="text-align:center; padding:20px;"><h1>–û—à–∏–±–∫–∞</h1><p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram.</p></div>`;
                return;
            }
            
            try {
                const day = new Date().getDay();
                const questButton = dom.questChooseBtn;
                if (day === 0 || day === 1) { 
                    questButton.classList.remove('twitch-theme');
                    questButton.classList.add('telegram-theme');
                    questButton.innerHTML = '<i class="fa-brands fa-telegram"></i> –í–´–•–û–î–ù–´–ï –ò–°–ü–´–¢–ê–ù–ò–Ø';
                } else {
                    questButton.classList.remove('telegram-theme');
                    questButton.classList.add('twitch-theme');
                    questButton.innerHTML = '<i class="fa-brands fa-twitch"></i> –ù–ê–ß–ê–¢–¨ –ò–°–ü–´–¢–ê–ù–ò–ï';
                }

                if (sessionStorage.getItem('newPromoReceived') === 'true') {
                    dom.newPromoNotification.classList.remove('hidden');
                }

                console.log("1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/v1/user/me...");
                const dashboardData = await makeApiRequest("/api/v1/user/me");
                console.log("2. –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", dashboardData);
                
                userData = dashboardData || {}; 
                const challengeData = dashboardData.challenge;
                console.log("3. –†–∞–∑–æ–±—Ä–∞–ª–∏ –¥–∞–Ω–Ω—ã–µ. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è challengeData:", challengeData);
                
                const isGuest = !userData || !userData.full_name;

                if (isGuest) {
                    dom.fullName.textContent = "–ì–æ—Å—Ç—å";
                } else {
                    dom.fullName.textContent = userData.full_name;
                    if (userData.is_admin) dom.navAdmin.classList.remove('hidden');
                }

                document.getElementById('ticketStats').textContent = userData.tickets || 0;
  
                const questsDataResp = await makeApiRequest("/api/v1/quests/list");

                allQuests = questsDataResp || [];
                questsForRoulette = allQuests.filter(q => q.quest_type && q.quest_type.startsWith('automatic') && !q.is_completed);
                
                const activeQuest = allQuests.find(q => q.id === userData.active_quest_id);
                
                const questChooseWrapper = document.getElementById('quest-choose-wrapper');
                if (questChooseWrapper) {
                    questChooseWrapper.classList.toggle('hidden', !!activeQuest);
                }

                if (activeQuest) {
                    renderActiveAutomaticQuest(activeQuest, userData);
                } else {
                    dom.activeAutomaticQuestContainer.innerHTML = '';
                }

                console.log("4. –°–æ–±–∏—Ä–∞–µ–º—Å—è –≤—ã–∑—ã–≤–∞—Ç—å renderChallenge. –ü–µ—Ä–µ–¥–∞—ë–º –≤ –Ω–µ—ë:", challengeData);
                // ‚úÖ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞—ë–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É–ª–¥–∞—É–Ω–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —á–µ–ª–ª–µ–Ω–¥–∂ null
                if (challengeData) {
                    renderChallenge(challengeData, !userData.twitch_id);
                } else {
                    renderChallenge({ cooldown_until: userData.challenge_cooldown_until }, !userData.twitch_id);
                }
                console.log("5. –§—É–Ω–∫—Ü–∏—è renderChallenge –≤—ã–∑–≤–∞–Ω–∞.");

            } catch (e) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ:", e);
                dom.challengeContainer.innerHTML = `<p style="text-align:center; color: #ff453a;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂.</p>`;
            } finally {
                dom.mainContent.classList.add('visible');
                dom.loaderOverlay.classList.add('hidden');
            }
        }

        setupEventListeners();
        main();
        
        setInterval(refreshDataSilently, 30000);

    } catch (e) {
        document.getElementById('loader-overlay')?.classList.add('hidden');
        document.body.innerHTML = `<div style="text-align:center; padding:20px;"><h1>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</h1><p>${e.message}</p></div>`;
    }
</script>
</body>
</html>
