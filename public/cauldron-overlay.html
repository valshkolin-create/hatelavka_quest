<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Cauldron Overlay</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: rgba(255, 149, 0, 0.7);
            --accent-color-1: #bf5af2;
            --accent-color-2: #ff9500;
        }
        body {
            background-color: transparent;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            margin: 0;
        }

        #overlay-container {
            position: absolute;
            bottom: 10px;
            left: 40px;
            width: 450px;
            animation: fadeIn 1s ease-out;
        }

        #widget-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #promo-group {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 4;
            pointer-events: none;
        }

        #ghost-animation {
            position: absolute;
            bottom: 75px;
            left: 0;
            width: 40px;
            height: auto;
            z-index: 3;
            animation: ghost-walk 20s linear infinite;
            transition: filter 0.5s ease-out, transform 0.5s ease-out;
        }

        #prize-image-container {
            width: 160px; height: 110px;
            background: linear-gradient(45deg, #1a0229, #3d1902);
            border: 2px solid var(--accent-color-2);
            border-radius: 12px;
            box-shadow: 0 0 20px var(--glow-color);
            opacity: 0;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 15px;
        }
        /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ 30 —Å–µ–∫—É–Ω–¥ */
        #prize-image-container.animate { animation: prize-image-animation 30s forwards; }
        #prize-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            filter: brightness(1.5) contrast(1.2);
        }

        #promo-text {
            padding: 10px 20px;
            background: linear-gradient(45deg, #1a0229, #3d1902);
            border: 2px solid var(--accent-color-2);
            color: white; border-radius: 12px;
            font-size: 18px; font-weight: 800;
            text-align: center;
            box-shadow: 0 5px 30px rgba(0,0,0,0.7);
            opacity: 0;
        }
        /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ 30 —Å–µ–∫—É–Ω–¥ */
        #promo-text.animate { animation: promo-text-animation 30s forwards; }
        .subtitle { display: block; font-size: 13px; font-weight: 600; color: #ddd; margin-top: 4px; }
        .prize-name { color: var(--accent-color-2); }

        #cauldron-image {
            width: 210px;
            height: auto;
            animation: float 4s ease-in-out infinite;
            margin-bottom: -30px;
            z-index: 2;
            transition: filter 0.5s ease-out, transform 0.5s ease-out;
        }
        #cauldron-image.pulse { animation: float 4s ease-in-out infinite, cauldron-pulse 0.7s ease-out; }
        
        #info-widget {
            width: 100%;
            background: linear-gradient(45deg, #1a0229, #3d1902);
            border: 2px solid var(--accent-color-2);
            border-radius: 16px;
            padding: 40px 20px 15px 20px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.7);
            color: white; 
            transition: filter 0.5s ease-out, transform 0.5s ease-out;
        }

        .blur-effect {
            filter: blur(4px) brightness(0.7);
            transform: scale(0.98);
        }

        #event-title { 
            margin: 0 0 10px 0; 
            font-size: 18px; 
            text-align: center; 
            font-weight: 700; 
            color: var(--accent-color-2); 
        }
        #progress-text { 
            font-size: 12px; 
            font-weight: 700; 
            text-align: center; 
            color: white; 
            margin-bottom: 5px; 
        }

        .progress-bar-container { width: 100%; background-color: rgba(0,0,0,0.4); border-radius: 8px; height: 8px; overflow: hidden; position: relative; }
        #progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2)); border-radius: 8px; transition: width 0.5s ease-out; }
        
        #flying-flask { position: fixed; width: 60px; height: auto; z-index: 10; pointer-events: none; opacity: 0; top: 20%; left: -100px; }
        #flying-flask.animate { animation: fly-in 1.2s cubic-bezier(0.5, -0.5, 1, 1); }

        #contributor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            pointer-events: none;
            z-index: 5;
            text-align: center;
            padding-top: 95px;
        }
        #contributor-overlay.show {
            opacity: 1;
        }
        #contributor-name {
            font-size: 48px;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 15px var(--glow-color), 0 0 25px var(--glow-color), 0 2px 5px #000;
        }
        #contributor-name span {
            display: block;
            font-size: 24px;
            color: var(--accent-color-2);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes cauldron-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); filter: brightness(1.7) drop-shadow(0 0 25px var(--accent-color-2)); } }
        
        @keyframes fly-in { 
            0% { 
                opacity: 1; 
                transform: translate(150px, 200px) scale(1.5) rotate(0deg);
            } 
            100% { 
                opacity: 0; 
                transform: translate(250px, 350px) scale(0.2) rotate(720deg);
            } 
        }
        
        /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ö–ª—é—á–µ–≤—ã–µ –∫–∞–¥—Ä—ã –¥–ª—è 30-—Å–µ–∫—É–Ω–¥–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes promo-text-animation {
            0%   { opacity: 0; transform: translateY(20px); }
            3%   { opacity: 1; transform: translateY(0); }   /* –ü–æ—è–≤–ª–µ–Ω–∏–µ –∑–∞ ~1 —Å–µ–∫ */
            97%  { opacity: 1; transform: translateY(0); }   /* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ~28 —Å–µ–∫ */
            100% { opacity: 0; transform: translateY(-20px); }/* –ò—Å—á–µ–∑–∞–Ω–∏–µ –∑–∞ ~1 —Å–µ–∫ */
        }
        @keyframes prize-image-animation {
            0%   { opacity: 0; transform: translateY(10px) scale(0.95); }
            3%   { opacity: 1; transform: translateY(0) scale(1); }
            97%  { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-10px) scale(0.95); }
        }
        @keyframes ghost-walk {
            0% { transform: translateX(0px) scaleX(1); }
            45% { transform: translateX(410px) scaleX(1); }
            50% { transform: translateX(410px) scaleX(-1); }
            95% { transform: translateX(0px) scaleX(-1); }
            100% { transform: translateX(0px) scaleX(1); }
        }
    </style>
</head>
<body>

    <div id="promo-group">
        <div id="prize-image-container">
            <img id="prize-image" src="" alt="Prize Image">
        </div>
        <div id="promo-text"></div>
    </div>

    <div id="overlay-container">
        <img id="flying-flask" src="https://i.postimg.cc/XYxLQYTF/giphy-flusk.gif" alt="Animating flask">
        
        <div id="widget-container">
            <div id="contributor-overlay">
                <div id="contributor-name"></div>
            </div>
            
            <img id="ghost-animation" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExdDd2azc1aXVvcmE3eG81a3FxZDlya2M4c3NmNDZweHFnOW8za3d2eiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/GqegZvkq9kgxuk1kTC/giphy.gif" alt="Ghost">
            
            <img id="cauldron-image" src="" alt="Cauldron">
            <div id="info-widget">
                <h1 id="event-title">...</h1>
                <div id="progress-text">0 / 0</div>
                <div class="progress-bar-container">
                    <div id="progress-bar-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pyeuckjcrsiaseyqrsek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZXVja2pjcnNpYXNleXFyc2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzEyOTgsImV4cCI6MjA3MDA0NzI5OH0.srRwuUygiF7jr3-b2AwyRNAmrChlW3Bzp3I-9Ju2TVg';

        const dom = {
            widget: document.getElementById('widget-container'),
            promoOverlay: document.getElementById('promo-overlay'),
            title: document.getElementById('auction-title'),
            timer: document.getElementById('auction-timer'),
            skinImage: document.getElementById('skin-image'),
            biddersList: document.getElementById('top-bidders-list'),
            notification: document.getElementById('new-bid-notification'),
            notifyName: document.getElementById('bid-notify-name')
        };

        let countdownInterval = null;
        let currentAuctionId = null;
        let promoInterval = null; // <-- –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function startCountdown(expiresAt) {
            if (countdownInterval) clearInterval(countdownInterval);
            if (!expiresAt) {
                dom.timer.textContent = "00:00:00";
                return;
            }

            const endTime = new Date(expiresAt).getTime();
            
            const updateTimer = () => {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    dom.timer.textContent = "00:00:00";
                    return;
                }

                const h = Math.floor(distance / 3600000);
                const m = Math.floor((distance % 3600000) / 60000);
                const s = Math.floor((distance % 60000) / 1000);
                
                dom.timer.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            };
            
            countdownInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        function updateDisplay(auctionData, topBidders = []) {
            if (!auctionData || !auctionData.id) {
                dom.widget.classList.remove('visible');
                currentAuctionId = null;
                return;
            }

            // –ï—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –±—ã–ª —Ä–∞–∑–º—ã—Ç, —É–±–∏—Ä–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
            if (dom.widget.classList.contains('blur')) {
                dom.widget.classList.remove('blur');
                dom.promoOverlay.classList.remove('show');
                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–æ–º–æ, —Ç.–∫. —Å—Ç–∞–≤–∫–∞ —Å–±–∏–ª–∞ –∞–Ω–∏–º–∞—Ü–∏—é
                if (promoInterval) clearInterval(promoInterval);
                promoInterval = setInterval(showPromoAnimation, 70000);
            }


            currentAuctionId = auctionData.id;
            dom.title.textContent = auctionData.title || "–ê—É–∫—Ü–∏–æ–Ω";
            dom.skinImage.src = auctionData.image_url || '';
            startCountdown(auctionData.bid_cooldown_ends_at);
            
            dom.biddersList.innerHTML = '';
            if (topBidders.length === 0) {
                dom.biddersList.innerHTML = '<div style="color: var(--text-secondary);">–°—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç...</div>';
            } else {
                topBidders.slice(0, 3).forEach((bidder, i) => {
                    const rank = i + 1;
                    dom.biddersList.innerHTML += `
                        <div class="bidder-item rank-${rank}">
                            <div class="bidder-rank">${rank}.</div>
                            <div class="bidder-name">${bidder.name}</div>
                            <div class="bidder-amount">${bidder.amount} üéüÔ∏è</div>
                        </div>
                    `;
                });
            }
            
            dom.widget.classList.add('visible');
        }
        
        function triggerAnimation(payload) {
            const { auction_data, last_bidder_name, top_bidders } = payload.new.payload;
            
            if (currentAuctionId === null || currentAuctionId === auction_data.id) {
                updateDisplay(auction_data, top_bidders);

                dom.notifyName.textContent = last_bidder_name;
                dom.notification.classList.add('show');
                
                setTimeout(() => {
                    dom.notification.classList.remove('show');
                    dom.notification.classList.add('hide');
                }, 4000); 
                
                setTimeout(() => {
                    dom.notification.classList.remove('hide');
                }, 4500);
            }
        }

        function showPromoAnimation() {
            if (!dom.widget.classList.contains('visible') || currentAuctionId === null) {
                return;
            }

            console.log('–ó–∞–ø—É—Å–∫ –ø—Ä–æ–º–æ-–∞–Ω–∏–º–∞—Ü–∏–∏...');
            dom.widget.classList.add('blur');
            dom.promoOverlay.classList.add('show');

            setTimeout(() => {
                dom.widget.classList.remove('blur');
                dom.promoOverlay.classList.remove('show');
            }, 10000); 
        }

        async function loadInitialState() {
            try {
                // (–≠—Ç–æ—Ç –∫–æ–¥ –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑)
                const { data: auctionData, error: auctionError } = await supabaseClient
                    .from('auctions')
                    .select('*')
                    .eq('is_visible', true) 
                    .order('created_at', { ascending: false }) 
                    .limit(1);

                if (auctionError) throw auctionError;
                if (!auctionData || auctionData.length === 0) {
                    console.log("–ù–µ—Ç –≤–∏–¥–∏–º—ã—Ö –∞—É–∫—Ü–∏–æ–Ω–æ–≤.");
                    dom.widget.classList.remove('visible');
                    currentAuctionId = null; 
                    return;
                }

                const auction = auctionData[0];

                const { data: historyData, error: historyError } = await supabaseClient
                    .from('auction_bids')
                    .select('bid_amount, user:users(full_name)')
                    .eq('auction_id', auction.id)
                    .order('created_at', { ascending: false })
                    .limit(3);
                
                if (historyError) throw historyError;
                
                const topBidders = [];
                if (historyData.length > 0) {
                    const leaderName = auction.current_highest_bidder_name;
                    if (leaderName) {
                        topBidders.push({
                            name: leaderName,
                            amount: auction.current_highest_bid || 0
                        });
                    }
                    let count = topBidders.length; 
                    for (const b of historyData) {
                        if (count >= 3) break;
                        const bidderName = b.user ? b.user.full_name : '–ê–Ω–æ–Ω–∏–º';
                        if (bidderName !== leaderName) {
                            topBidders.push({
                                name: bidderName,
                                amount: b.bid_amount
                            });
                            count++;
                        }
                    }
                }
                updateDisplay(auction, topBidders);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
            }
        }

        try {
            // 1. –°–ª—É—à–∞–µ–º –¢–†–ò–ì–ì–ï–†–´ (–ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞)
            supabaseClient.channel('auction-triggers-channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'auction_triggers' },
                    payload => triggerAnimation(payload)
                ).subscribe();

            // 2. –°–ª—É—à–∞–µ–º –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ê–£–ö–¶–ò–û–ù–û–í (–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –°–±—Ä–æ—Å, –°–∫—Ä—ã—Ç–∏–µ)
            supabaseClient.channel('auctions-changes-channel')
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'auctions' },
                    payload => {
                        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—É–∫—Ü–∏–æ–Ω–∞ –ø–æ–ª—É—á–µ–Ω–æ:', payload.new);
                        // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–∏–ª—Å—è –Ω–∞—à —Ç–µ–∫—É—â–∏–π –∞—É–∫—Ü–∏–æ–Ω –ò–õ–ò –µ—Å–ª–∏ –æ–Ω —Å—Ç–∞–ª –Ω–µ–≤–∏–¥–∏–º—ã–º/–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º
                        if (payload.new.id === currentAuctionId || !payload.new.is_visible || payload.new.ended_at) {
                             loadInitialState();
                        }
                    }
                ).subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Supabase (Auction Triggers & Changes). –ó–∞–≥—Ä—É–∑–∫–∞...');
                        loadInitialState();
                    }
                });

        } catch (error) { console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase:", error); }

        // --- –ò–ù–¢–ï–†–í–ê–õ–´ ---
        // 1. (–†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ 1)
        //    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ (—Ä–∞–∑ –≤ 2 –º–∏–Ω—É—Ç—ã)
        //    –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–≤–µ—Ä–ª–µ–π "–ø—Ä–æ—Å–Ω–µ—Ç—Å—è" –∏ –ø–æ–ª—É—á–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ
        //    –¥–∞–Ω–Ω—ã–µ, –¥–∞–∂–µ –µ—Å–ª–∏ WebSocket –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –æ—Ç–≤–∞–ª–∏–ª—Å—è.
        setInterval(loadInitialState, 120000); // 120,000 –º—Å = 2 –º–∏–Ω—É—Ç—ã

        // 2. (–†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ 2)
        //    –ü–æ–∫–∞–∑ –ø—Ä–æ–º–æ-–∞–Ω–∏–º–∞—Ü–∏–∏ (—Ä–∞–∑ –≤ 70 —Å–µ–∫—É–Ω–¥)
        if (promoInterval) clearInterval(promoInterval); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        promoInterval = setInterval(showPromoAnimation, 70000); // 70,000 –º—Å = 1 –º–∏–Ω 10 —Å–µ–∫
    </script>
</body>
</html>

