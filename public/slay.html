<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SLAY AWARDS 2025</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ß—É—Ç—å –±–æ–ª–µ–µ —è—Ä–∫–∏–µ) --- */
        :root {
            --bg: #000000;
            --surface: #111111;
            --surface-light: #1c1c1c;
            --gold: #FFD700;
            --gold-dim: #E6B800;
            --gold-gradient: linear-gradient(135deg, #FFD700 0%, #FFAA00 100%);
            --text: #ffffff;
            --text-secondary: #888888;
            --twitch: #9146FF;
            --danger: #FF3B30;
            --border: rgba(255, 215, 0, 0.15);
            --safe-area-bottom: constant(safe-area-inset-bottom);
            --safe-area-bottom-ios: env(safe-area-inset-bottom);
        }
        
        /* --- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏ —Å–±—Ä–æ—Å --- */
        html, body {
            height: 100%;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            padding-bottom: calc(60px + var(--safe-area-bottom-ios)); /* –ú–µ—Å—Ç–æ –¥–ª—è —Ñ—É—Ç–µ—Ä–∞ */
            line-height: 1.5;
            transition: background-color 0.3s;
        }
        
        /* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –æ—Ç—Å—Ç—É–ø—ã --- */
        .container {
            padding: 20px;
            padding-bottom: 80px; /* –î–æ–ø. –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        }
        
        /* --- –®–∞–ø–∫–∞ --- */
        .header {
            text-align: center;
            padding: 20px 0 10px;
            border-bottom: 1px solid var(--surface);
            margin-bottom: 20px;
            background: var(--surface);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 5px 0 0;
        }
        
        /* --- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å (–°–∫—Ä—ã–≤–∞–µ–º–∞—è) --- */
        #admin-panel {
            background-color: var(--surface-light);
            border-radius: 12px;
            margin: 0 20px 20px 20px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, opacity 0.3s;
            max-height: 1000px; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ */
        }
        
        #admin-panel.closed {
            max-height: 50px; /* –í—ã—Å–æ—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Å—Ç—Ä–µ–ª–∫–∏ */
            padding-top: 5px;
            padding-bottom: 5px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
        }
        
        .admin-header h3 {
            margin: 0;
            color: var(--gold);
            font-size: 16px;
        }
        
        .admin-toggle-icon {
            transition: transform 0.3s ease;
            color: var(--gold);
        }
        
        .admin-panel-content {
            padding-top: 15px;
            opacity: 1;
            transition: opacity 0.3s ease 0.1s;
        }
        
        #admin-panel.closed .admin-panel-content {
            opacity: 0;
            pointer-events: none;
        }

        #admin-panel.closed .admin-toggle-icon {
            transform: rotate(180deg);
        }

        /* --- –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã --- */
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--surface);
            color: var(--text);
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: var(--gold);
            outline: none;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s, transform 0.1s;
        }

        .btn-gold {
            background: var(--gold-gradient);
            color: var(--bg);
        }
        .btn-gold:active {
            transform: scale(0.99);
            background: var(--gold-dim);
        }
        
        /* --- –ë–ª–æ–∫–∏ –Ω–æ–º–∏–Ω–∞—Ü–∏–π --- */
        .nomination-card {
            background-color: var(--surface-light);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: transform 0.3s;
            position: relative;
        }
        .nomination-card:active {
            transform: scale(0.99);
        }

        .card-img-container {
            width: 100%;
            height: 150px;
            overflow: hidden;
            background-color: var(--surface);
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
        }
        
        .nomination-content {
            padding: 15px;
        }

        .nomination-content h4 {
            font-size: 18px;
            margin: 0 0 5px 0;
            color: var(--gold);
        }

        .nomination-content p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0 0 15px 0;
        }
        
        /* --- –°–µ–∫—Ü–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ --- */
        .candidates-list {
            margin-top: 15px;
            border-top: 1px solid var(--surface);
            padding-top: 15px;
        }
        
        .candidate-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--surface);
            transition: background-color 0.2s;
        }
        
        .candidate-item:last-child {
            border-bottom: none;
        }

        .candidate-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            overflow: hidden;
        }
        
        .candidate-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid var(--gold-dim);
        }
        
        .candidate-name-block {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .candidate-name {
            font-weight: 600;
            font-size: 15px;
            display: block;
        }
        
        .candidate-handle {
            font-size: 12px;
            color: var(--text-secondary);
            display: block;
        }
        
        .vote-btn {
            background: var(--gold);
            color: var(--bg);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            font-size: 14px;
            margin-left: 10px;
        }
        .vote-btn:active {
            transform: scale(0.95);
        }

        .voted-btn {
            background: var(--surface);
            color: var(--text-secondary);
            cursor: default;
            font-style: italic;
            border: 1px solid var(--border);
        }
        .voted-btn:active {
            transform: none;
        }
        
        .votes-count {
            font-size: 14px;
            font-weight: 700;
            color: var(--gold);
            margin-right: 10px;
        }
        
        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–¥–ª—è –∞–¥–º–∏–Ω-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--surface-light);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--gold);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }
        
        /* --- –§—É—Ç–µ—Ä (–ù–∏–∂–Ω–∏–π –±–∞—Ä 1:1) --- */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--surface-light);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.4);
            z-index: 900;
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-area-bottom-ios);
            padding-top: 10px;
            transition: background-color 0.3s;
        }

        .footer-item {
            text-align: center;
            padding: 5px 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .footer-item i {
            display: block;
            margin-bottom: 3px;
            font-size: 20px;
        }

        .footer-item.active {
            color: var(--gold);
        }

        .footer-item:not(.active):hover {
            color: var(--text);
        }
        
        /* --- –°—Ç–∏–ª–∏ –ø–æ–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∞ --- */
        #user-search {
            margin-top: 10px;
        }

        #search-results {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--surface);
            margin-top: 10px;
            padding-top: 10px;
        }

        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--surface);
        }
        .search-result-item button {
            background: var(--gold-dim); 
            color: var(--bg); 
            border: none; 
            padding: 5px 10px; 
            border-radius: 5px; 
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result-item button:active {
            background: var(--gold);
        }

    </style>
</head>
<body>

    <div class="header">
        <h1 id="page-title">SLAY AWARDS</h1>
        <p id="page-description">Loading...</p>
    </div>

    <div id="admin-panel" class="closed">
        <div class="admin-header" onclick="toggleAdminPanel()">
            <h3><i class="fa-solid fa-screwdriver-wrench"></i> Admin Panel</h3>
            <i class="fa-solid fa-chevron-up admin-toggle-icon"></i>
        </div>

        <div class="admin-panel-content">
            <div id="admin-home-content">
                <label style="font-size:12px; color:var(--text-secondary);">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                <input type="text" id="admin-title" placeholder="SLAY AWARDS 2025">

                <label style="font-size:12px; color:var(--text-secondary);">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="admin-description" placeholder="–ì–ª–∞–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≥–æ–¥–∞..."></textarea>
                
                <label style="font-size:12px; color:var(--text-secondary);">–ü—Ä–∏–∑—ã (JSON):</label>
                <textarea id="admin-prizes" placeholder='[{"name":"–ü—Ä–∏–∑ 1", "icon":"fa-trophy"}]' rows="3"></textarea>
                
                <button class="btn btn-gold" onclick="updateSlayContent()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>

            <hr style="border-color:var(--surface); margin: 20px 0;">

            <div id="admin-create-nomination">
                <h3 style="margin-top:0; color:var(--text);">–°–æ–∑–¥–∞—Ç—å –Ω–æ–º–∏–Ω–∞—Ü–∏—é</h3>
                <input type="text" id="new-nom-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–º–∏–Ω–∞—Ü–∏–∏">
                <input type="text" id="new-nom-desc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ">
                <input type="text" id="new-nom-img" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                <button class="btn btn-gold" onclick="createNomination()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div id="nominations-container" class="container">
        <p id="loading-message" style="text-align:center; color:var(--text-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–º–∏–Ω–∞—Ü–∏–π...</p>
    </div>

    <div id="edit-modal" class="modal" onclick="if(event.target.id === 'edit-modal') closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–∏–Ω–∞—Ü–∏—é</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <input type="text" id="edit-nom-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–º–∏–Ω–∞—Ü–∏–∏">
            <textarea id="edit-nom-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–º–∏–Ω–∞—Ü–∏–∏"></textarea>
            <input type="text" id="edit-nom-img" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏">
            <button class="btn btn-gold" onclick="updateNominationInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ</button>

            <h4 style="margin-top:20px; border-top:1px solid var(--surface); padding-top:15px; color:var(--gold);">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h4>
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/–ª–æ–≥–∏–Ω—É..." oninput="searchUsers(this.value)">
            <div id="search-results">
                </div>
            
            <h4 style="margin-top:20px; border-top:1px solid var(--surface); padding-top:15px; color:var(--gold);">–°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</h4>
            <div id="candidate-list-admin">
                </div>
            
        </div>
    </div>

    <div class="footer">
        <div class="footer-item active">
            <i class="fa-solid fa-star"></i>
            <span>Awards</span>
        </div>
        <div class="footer-item" onclick="Telegram.WebApp.close()">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>–ó–∞–∫—Ä—ã—Ç—å</span>
        </div>
        </div>


    <script>
        const API_URL = '/api/v1/slay';
        const isAdmin = Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && [/* –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤ ADMIN_IDS */].includes(Telegram.WebApp.initDataUnsafe.user.id);
        let currentEditId = null;
        let nominationsData = []; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –Ω–æ–º–∏–Ω–∞—Ü–∏–π

        function init() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            // –ï—Å–ª–∏ –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            if (isAdmin) {
                document.getElementById('admin-panel').style.display = 'block';
                // –ß—Ç–æ–±—ã –ø–∞–Ω–µ–ª—å –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('admin-panel').classList.add('closed');
            } else {
                document.getElementById('admin-panel').style.display = 'none';
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –Ω–æ–º–∏–Ω–∞—Ü–∏–π
            loadContent();
            loadNominations();
        }

        // --- –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–ò (–°–∫—Ä—ã–≤–∞–µ–º–∞—è) ---
        function toggleAdminPanel() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('closed');
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ CSS transition
        }


        // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò ---

        async function loadContent() {
            try {
                const response = await fetch(`${API_URL}/content`);
                const data = await response.json();
                
                document.getElementById('page-title').textContent = data.title || 'SLAY AWARDS';
                document.getElementById('page-description').textContent = data.description || 'Loading...';
                
                // –î–ª—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
                if (isAdmin) {
                    document.getElementById('admin-title').value = data.title || '';
                    document.getElementById('admin-description').value = data.description || '';
                    document.getElementById('admin-prizes').value = data.prizes || '[]';
                }

            } catch (error) {
                console.error('Error loading content:', error);
            }
        }

        async function loadNominations() {
            document.getElementById('loading-message').style.display = 'block';
            try {
                const response = await fetch(`${API_URL}/active`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: Telegram.WebApp.initData})
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch nominations');
                }

                nominationsData = await response.json();
                renderNominations(nominationsData);

            } catch (error) {
                console.error('Error loading nominations:', error);
                document.getElementById('loading-message').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.';
            } finally {
                document.getElementById('loading-message').style.display = 'none';
            }
        }

        // --- –†–ï–ù–î–ï–†–ò–ù–ì ---

        function renderNominations(nominations) {
            const container = document.getElementById('nominations-container');
            container.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
            
            if (nominations.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:50px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–º–∏–Ω–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>';
                return;
            }

            nominations.forEach(nom => {
                const card = document.createElement('div');
                card.className = 'nomination-card';
                
                // –ï—Å–ª–∏ –∞–¥–º–∏–Ω, —Ç–æ –∫–ª–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É
                if (isAdmin) {
                    card.onclick = () => openEditModal(nom.id);
                }

                // –ö–∞–Ω–¥–∏–¥–∞—Ç—ã
                const candidatesHTML = nom.candidates.map(candidate => {
                    const twitchLogin = candidate.username ? `@${candidate.username}` : '';
                    const buttonHTML = nom.has_voted 
                        ? `<span class="vote-btn voted-btn">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–æ</span>`
                        : `<button class="vote-btn" onclick="vote(event, ${nom.id}, ${candidate.id})">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>`;
                    
                    return `
                        <div class="candidate-item">
                            <div class="candidate-info">
                                <img src="${escapeHTML(candidate.photo_url) || 'https://placehold.co/40x40/222/555?text=?'}" class="candidate-photo">
                                <div class="candidate-name-block">
                                    <span class="candidate-name">${escapeHTML(candidate.name)}</span>
                                    <span class="candidate-handle">${escapeHTML(twitchLogin)}</span>
                                </div>
                            </div>
                            <div>
                                <span class="votes-count">${candidate.votes}</span>
                                ${buttonHTML}
                            </div>
                        </div>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="card-img-container">
                        <img src="${escapeHTML(nom.image_url) || 'https://placehold.co/600x150/111/444?text=SLAY+AWARDS'}" class="card-img" onerror="this.src='https://placehold.co/600x150/111/444?text=SLAY+AWARDS'">
                    </div>
                    <div class="nomination-content">
                        <h4>${escapeHTML(nom.title)}</h4>
                        <p>${escapeHTML(nom.description)}</p>
                        <div class="candidates-list">
                            ${candidatesHTML}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // --- –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–û–í–ê–ù–ò–Ø ---
        
        async function vote(event, nominationId, candidateId) {
            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –∞–¥–º–∏–Ω–∞
            
            if (nominationsData.find(n => n.id === nominationId && n.has_voted)) {
                Telegram.WebApp.showAlert('–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –≤ —ç—Ç–æ–π –Ω–æ–º–∏–Ω–∞—Ü–∏–∏.');
                return;
            }

            Telegram.WebApp.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ —ç—Ç–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞? –ì–æ–ª–æ—Å –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å.`, async (ok) => {
                if (ok) {
                    Telegram.WebApp.showProgress();
                    try {
                        const response = await fetch(`${API_URL}/vote`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                initData: Telegram.WebApp.initData,
                                nomination_id: nominationId,
                                candidate_id: candidateId
                            })
                        });

                        if (!response.ok) {
                             const errorData = await response.json();
                             throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.');
                        }

                        Telegram.WebApp.showAlert('‚úÖ –ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç!');
                        loadNominations(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                        
                    } catch (error) {
                        console.error('Vote error:', error);
                        Telegram.WebApp.showAlert(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.'}`);
                    } finally {
                        Telegram.WebApp.hideProgress();
                    }
                }
            });
        }
        
        // --- –ê–î–ú–ò–ù: –ì–õ–ê–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ---

        async function updateSlayContent() {
            if (!isAdmin) return;
            Telegram.WebApp.showProgress();
            
            const title = document.getElementById('admin-title').value;
            const description = document.getElementById('admin-description').value;
            const prizes = document.getElementById('admin-prizes').value;
            
            try {
                const response = await fetch('/api/v1/admin/slay/content/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        title: title,
                        description: description,
                        badge: "", // –û—Å—Ç–∞–≤–∏–ª–∏ –ø—É—Å—Ç—ã–º –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
                        prizes: prizes
                    })
                });

                if (!response.ok) throw new Error('Failed to update content');

                Telegram.WebApp.showAlert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                loadContent(); 
            } catch (error) {
                console.error('Content update error:', error);
                Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫.');
            } finally {
                Telegram.WebApp.hideProgress();
            }
        }
        
        // --- –ê–î–ú–ò–ù: –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ò –ù–û–ú–ò–ù–ê–¶–ò–ò ---
        
        function openEditModal(nominationId) {
            if (!isAdmin) return;
            currentEditId = nominationId;
            const nom = nominationsData.find(n => n.id === nominationId);
            if (!nom) return;
            
            document.getElementById('modal-title-text').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${nom.title}`;
            document.getElementById('edit-nom-title').value = nom.title;
            document.getElementById('edit-nom-desc').value = nom.description || '';
            document.getElementById('edit-nom-img').value = nom.image_url || '';

            renderAdminCandidateList(nom.candidates);
            
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('user-search').value = '';
            currentEditId = null;
        }

        async function updateNominationInfo() {
            if (!currentEditId) return;
            Telegram.WebApp.showProgress();

            const title = document.getElementById('edit-nom-title').value;
            const description = document.getElementById('edit-nom-desc').value;
            const image_url = document.getElementById('edit-nom-img').value;

            try {
                const response = await fetch('/api/v1/admin/slay/nomination/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        id: currentEditId,
                        title: title,
                        description: description,
                        image_url: image_url
                    })
                });

                if (!response.ok) throw new Error('Failed to update nomination');

                Telegram.WebApp.showAlert('‚úÖ –ù–æ–º–∏–Ω–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                loadNominations();
            } catch (error) {
                console.error('Update nomination error:', error);
                Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–∏–Ω–∞—Ü–∏–∏.');
            } finally {
                Telegram.WebApp.hideProgress();
            }
        }

        async function createNomination() {
            if (!isAdmin) return;
            Telegram.WebApp.showProgress();

            const title = document.getElementById('new-nom-title').value;
            const description = document.getElementById('new-nom-desc').value;
            const image_url = document.getElementById('new-nom-img').value;
            
            if (!title) {
                Telegram.WebApp.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
                Telegram.WebApp.hideProgress();
                return;
            }

            try {
                const response = await fetch('/api/v1/admin/slay/nomination/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        title: title,
                        description: description,
                        image_url: image_url
                    })
                });

                if (!response.ok) throw new Error('Failed to create nomination');

                Telegram.WebApp.showAlert('‚úÖ –ù–æ–º–∏–Ω–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
                document.getElementById('new-nom-title').value = '';
                document.getElementById('new-nom-desc').value = '';
                document.getElementById('new-nom-img').value = '';
                loadNominations();
            } catch (error) {
                console.error('Create nomination error:', error);
                Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–º–∏–Ω–∞—Ü–∏–∏.');
            } finally {
                Telegram.WebApp.hideProgress();
            }
        }
        
        // --- –ê–î–ú–ò–ù: –ö–ê–ù–î–ò–î–ê–¢–´ (–ü–û–ò–°–ö/–î–û–ë–ê–í–õ–ï–ù–ò–ï/–£–î–ê–õ–ï–ù–ò–ï) ---

        let searchTimeout;
        function searchUsers(query) {
            clearTimeout(searchTimeout);
            if (query.length < 3) {
                document.getElementById('search-results').innerHTML = '<p style="color:var(--text-secondary); font-size:12px;">–í–≤–µ–¥–∏—Ç–µ –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤</p>';
                return;
            }
            searchTimeout = setTimeout(() => fetchUsers(query), 500);
        }

        async function fetchUsers(query) {
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å API –¥–ª—è –ø–æ–∏—Å–∫–∞ —é–∑–µ—Ä–æ–≤
            try {
                const response = await fetch(`/api/v1/admin/users/search?q=${encodeURIComponent(query)}`);
                const users = await response.json();
                renderSearchResults(users);
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = '<p style="color:var(--danger); font-size:12px;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</p>';
            }
        }

        function renderSearchResults(users) {
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '';
            
            if (users.length === 0) {
                resDiv.innerHTML = '<p style="color:var(--text-secondary); font-size:12px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
                return;
            }

            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <div>
                        ${escapeHTML(u.full_name)} 
                        <span style="color:var(--text-secondary); font-size:10px;">${escapeHTML(u.twitch_login) || escapeHTML(u.username) || ''}</span>
                    </div>
                    <button onclick="addCandidate(${u.telegram_id})">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                `;
                resDiv.appendChild(div);
            });
        }

        async function addCandidate(uid) {
            if(!currentEditId) return;
            Telegram.WebApp.showProgress();

            try {
                const response = await fetch('/api/v1/admin/slay/candidate/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        initData: Telegram.WebApp.initData,
                        nomination_id: currentEditId,
                        user_id: uid
                    })
                });

                if (!response.ok) throw new Error('Failed to add candidate');

                Telegram.WebApp.showAlert("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω!");
                // –û—á–∏—Å—Ç–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('user-search').value = '';
                await loadNominations();
                // –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                openEditModal(currentEditId); 

            } catch (error) {
                console.error('Add candidate error:', error);
                Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.');
            } finally {
                Telegram.WebApp.hideProgress();
            }
        }

        function renderAdminCandidateList(candidates) {
            const listDiv = document.getElementById('candidate-list-admin');
            listDiv.innerHTML = '';

            if (candidates.length === 0) {
                listDiv.innerHTML = '<p style="color:var(--text-secondary); font-size:12px;">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>';
                return;
            }

            candidates.forEach(c => {
                const display_name = c.name;
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <div>
                        ${escapeHTML(display_name)} 
                        <span style="color:var(--text-secondary); font-size:10px;">(ID: ${c.id})</span>
                    </div>
                    <button style="background:var(--danger);" onclick="deleteCandidate(${c.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                listDiv.appendChild(div);
            });
        }
        
        async function deleteCandidate(candidateId) {
            Telegram.WebApp.showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.', async (ok) => {
                if (ok) {
                    Telegram.WebApp.showProgress();
                    try {
                        const response = await fetch('/api/v1/admin/slay/candidate/delete', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                initData: Telegram.WebApp.initData,
                                candidate_id: candidateId
                            })
                        });

                        if (!response.ok) throw new Error('Failed to delete candidate');

                        Telegram.WebApp.showAlert("üóëÔ∏è –ö–∞–Ω–¥–∏–¥–∞—Ç —É–¥–∞–ª–µ–Ω!");
                        await loadNominations();
                        openEditModal(currentEditId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–∞–ª–∫—É

                    } catch (error) {
                        console.error('Delete candidate error:', error);
                        Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.');
                    } finally {
                        Telegram.WebApp.hideProgress();
                    }
                }
            });
        }


        // --- –£–¢–ò–õ–ò–¢–´ ---
        
        function escapeHTML(str) {
            if (!str) return "";
            // –£–¥–∞–ª–µ–Ω–∞ –∑–∞–º–µ–Ω–∞ –∫–∞–≤—ã—á–µ–∫, –∫–æ—Ç–æ—Ä–∞—è –º–æ–≥–ª–∞ –ª–æ–º–∞—Ç—å JSON –≤ –∞–¥–º–∏–Ω–∫–µ
            return str.replace(/[&<>]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m]));
        }

        // --- –ó–ê–ü–£–°–ö ---
        init();
    </script>
</body>
</html>
