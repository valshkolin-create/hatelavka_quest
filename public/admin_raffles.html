<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Admin Raffles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --bg: #0f0f0f;
            --card-bg: rgba(30, 30, 30, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --primary: #ffd700;
            --accent: #28a745;
            --danger: #ff4d4d;
            --text: #ffffff;
            --text-sec: #aaaaaa;
            --blur: 10px;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Header --- */
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { background: none; border: none; color: var(--text-sec); font-size: 16px; cursor: pointer; transition: 0.2s; }
        .back-btn:active { color: var(--text); transform: scale(0.95); }
        .page-title { font-size: 20px; font-weight: 800; margin: 0; background: linear-gradient(45deg, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .icon-btn { width: 36px; height: 36px; border-radius: 12px; background: rgba(255,255,255,0.1); border: 1px solid var(--card-border); color: var(--text); display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 14px; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* --- Tabs --- */
        .tabs { display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .tab { flex: 1; border: none; background: none; color: var(--text-sec); padding: 10px; font-weight: 600; font-size: 13px; border-radius: 10px; transition: 0.3s; cursor: pointer; }
        .tab.active { background: rgba(255,255,255,0.1); color: var(--text); shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* --- Forms --- */
        .admin-form label { display: block; font-size: 12px; color: var(--text-sec); margin: 15px 0 5px; font-weight: 500; }
        .admin-form input, .admin-form select, .admin-form textarea {
            width: 100%; box-sizing: border-box; background: var(--card-bg); border: 1px solid var(--card-border);
            color: var(--text); padding: 12px; border-radius: 12px; font-size: 14px; outline: none; transition: 0.2s;
        }
        .admin-form input:focus, .admin-form textarea:focus { border-color: var(--primary); background: rgba(255,255,255,0.03); }
        
        /* Toggles */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; background: var(--card-bg); padding: 12px; border-radius: 12px; margin-top: 10px; border: 1px solid var(--card-border); }
        .toggle-switch { position: relative; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* --- Buttons --- */
        .main-btn {
            width: 100%; background: var(--primary); color: #000; border: none; padding: 14px;
            border-radius: 14px; font-weight: 800; font-size: 15px; margin-top: 25px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .main-btn:active { transform: scale(0.98); opacity: 0.9; }
        .main-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }

        /* --- Preview --- */
        .preview-box { background: #182533; border-radius: 12px; padding: 12px; margin-top: 20px; border-left: 3px solid var(--primary); }
        .prev-img { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; display: none; }
        .prev-img.show { display: block; }
        .prev-text { font-size: 13px; line-height: 1.4; white-space: pre-wrap; }
        .prev-btn { background: rgba(100, 181, 239, 0.15); color: #64b5ef; text-align: center; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-top: 10px; }

        /* --- Cards List --- */
        .raffle-card {
            background: var(--card-bg); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--card-border); border-radius: 16px; padding: 15px; margin-bottom: 15px;
            animation: slideUp 0.4s ease;
        }
        .raffle-card.completed { opacity: 0.7; border-color: transparent; }
        .card-header { display: flex; gap: 12px; margin-bottom: 12px; }
        .card-thumb { width: 50px; height: 50px; border-radius: 10px; background: #222; object-fit: cover; }
        .card-meta { flex: 1; }
        .card-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .status-badge { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
        .st-active { background: rgba(40, 167, 69, 0.2); color: var(--accent); }
        .st-done { background: rgba(255, 255, 255, 0.1); color: var(--text-sec); }
        
        .card-actions { display: flex; gap: 8px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-parts { background: rgba(255,255,255,0.1); color: var(--text); }
        .btn-finish { background: rgba(255, 77, 77, 0.2); color: var(--danger); }

        /* --- Winner Box --- */
        .winner-section { border-top: 1px dashed rgba(255,255,255,0.1); margin-top: 10px; padding-top: 10px; }
        .winner-tag { font-size: 9px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .winner-name { font-weight: 700; font-size: 14px; margin: 2px 0 5px; }
        .trade-copy { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; font-size: 11px; color: var(--text-sec); display: flex; align-items: center; justify-content: space-between; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .trade-copy:active { border-color: var(--primary); background: rgba(255, 215, 0, 0.05); }

        /* --- Custom Modals --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.center { align-items: center; }
        .modal-active { display: flex; animation: fadeIn 0.2s; }
        
        .bottom-sheet { background: #1c1c1e; width: 100%; border-radius: 24px 24px 0 0; padding: 20px; max-height: 80vh; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .alert-box { background: #252525; width: 85%; padding: 20px; border-radius: 16px; text-align: center; border: 1px solid var(--card-border); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .part-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .part-ava { width: 36px; height: 36px; background: linear-gradient(135deg, #444, #222); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; font-size: 14px; }
        
        .alert-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .alert-msg { font-size: 14px; color: var(--text-sec); margin-bottom: 20px; }
        .alert-btn { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; }
        .alert-btn.cancel { background: transparent; color: var(--text-sec); margin-top: 5px; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="page-header">
        <button onclick="goBack()" class="back-btn"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="page-title">–ü–∞–Ω–µ–ª—å –†–æ–∑—ã–≥—Ä—ã—à–µ–π</h1>
        <a href="/raffles" class="icon-btn"><i class="fa-solid fa-eye"></i></a>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('create')">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
        <button class="tab" onclick="switchTab('list')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
    </div>

    <div id="tab-create" class="tab-content">
        <form id="create-form" class="admin-form">
            <h3 style="margin: 0 0 10px; color: var(--primary);"><i class="fa-solid fa-wand-magic-sparkles"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            
            <label>–¢–∏–ø –º–µ—Ö–∞–Ω–∏–∫–∏</label>
            <select name="type" id="type-select" onchange="toggleFields()">
                <option value="inline_random">üé≤ –°–ª—É—á–∞–π–Ω–∞—è –∫–Ω–æ–ø–∫–∞</option>
                <option value="most_active">üî• –¢–æ–ø –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
            </select>

            <div class="toggle-row">
                <span style="font-size: 13px;">–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</span>
                <label class="toggle-switch">
                    <input type="checkbox" name="sub_req" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="toggle-row">
                <span style="font-size: 13px;">–¢–æ–ª—å–∫–æ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</span>
                <label class="toggle-switch">
                    <input type="checkbox" name="ref_req">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="field-twitch" class="hidden">
                <label>–ú–Ω–æ–∂–∏—Ç–µ–ª—å Twitch (x)</label>
                <input type="number" name="twitch_boost" placeholder="1.5" step="0.1">
            </div>

            <label style="color: var(--danger);">‚è∞ –ê–≤—Ç–æ-–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (–ú–°–ö)</label>
            <input type="datetime-local" name="end_time" onchange="updatePreview()">

            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0;"></div>
            
            <h3 style="margin: 0 0 10px; color: var(--primary);"><i class="fa-solid fa-pen-fancy"></i> –ö–æ–Ω—Ç–µ–Ω—Ç</h3>

            <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" name="title" id="inp-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AWP Asiimov" required oninput="updatePreview()">

            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞</label>
            <input type="text" name="prize" id="inp-prize" placeholder="AWP | Asiimov (FT)" required oninput="updatePreview()">

            <label>–ö–∞—á–µ—Å—Ç–≤–æ (Wear)</label>
            <select name="quality" id="inp-quality" onchange="updatePreview()">
            <option value="">–ë–µ–∑ –∫–∞—á–µ—Å—Ç–≤–∞</option>
            <option value="FN">Factory New (–ü—Ä—è–º–æ —Å –∑–∞–≤–æ–¥–∞)</option>
            <option value="MW">Minimal Wear (–ù–µ–º–Ω–æ–≥–æ –ø–æ–Ω–æ—à–µ–Ω–Ω–æ–µ)</option>
            <option value="FT">Field-Tested (–ü–æ—Å–ª–µ –ø–æ–ª–µ–≤—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π)</option>
            <option value="WW">Well-Worn (–ü–æ–Ω–æ—à–µ–Ω–Ω–æ–µ)</option>
            <option value="BS">Battle-Scarred (–ó–∞–∫–∞–ª–µ–Ω–Ω–æ–µ –≤ –±–æ—è—Ö)</option>
            </select>

            <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)</label>
            <input type="text" name="image" id="inp-img" placeholder="https://..." oninput="updatePreview()">

            <label>–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
            <textarea name="desc" id="inp-desc" rows="3" placeholder="–î–æ–ø. —É—Å–ª–æ–≤–∏—è –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ..." oninput="updatePreview()"></textarea>
            
            <label>–ú–∏–Ω. —Å–æ–æ–±—â–µ–Ω–∏–π Twitch (–∑–∞ —Å–µ–≥–æ–¥–Ω—è)</label>
            <input type="number" name="min_msgs" placeholder="0 - –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å">

            <div class="preview-box">
                <div style="font-size: 10px; text-transform: uppercase; color: #777; margin-bottom: 5px;">Telegram Preview</div>
                <img src="" id="prev-img" class="prev-img">
                <div class="prev-text" id="prev-txt"></div>
                <div class="prev-btn">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å üé≤</div>
            </div>

            <button type="submit" class="main-btn">
                <span>üöÄ –°–æ–∑–¥–∞—Ç—å –∏ –ó–∞–ø—É—Å—Ç–∏—Ç—å</span>
            </button>
        </form>
    </div>

    <div id="tab-list" class="tab-content hidden">
        <div id="list-container">
            <div style="text-align:center; padding: 40px; color: var(--text-sec);">
                <i class="fa-solid fa-circle-notch fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>

    <div id="modal-parts" class="modal-overlay" onclick="if(event.target===this) closeModal('modal-parts')">
        <div class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ <span id="parts-count" style="font-size:14px; opacity:0.5;"></span></h3>
                <button onclick="closeModal('modal-parts')" style="background:none; border:none; color:var(--text-sec); font-size:20px;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="parts-list" style="overflow-y:auto; flex:1;"></div>
        </div>
    </div>

    <div id="modal-alert" class="modal-overlay center">
        <div class="alert-box">
            <div class="alert-title" id="alert-title">Title</div>
            <div class="alert-msg" id="alert-msg">Message</div>
            <button class="alert-btn" id="alert-ok">OK</button>
            <button class="alert-btn cancel hidden" id="alert-cancel">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- Navigation ---
        // –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–ª–∏ –∞–ª–µ—Ä—Ç - –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏—Ö
            if (document.getElementById('modal-parts').classList.contains('modal-active')) {
                closeModal('modal-parts');
                return;
            }
            if (document.getElementById('modal-alert').classList.contains('modal-active')) {
                closeModal('modal-alert');
                return;
            }
            // –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é
            window.location.href = '/admin';
        });

        function goBack() { window.location.href = '/admin'; }
        
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + t).classList.remove('hidden');
            if(t === 'create') document.querySelectorAll('.tab')[0].classList.add('active');
            else { document.querySelectorAll('.tab')[1].classList.add('active'); loadRaffles(); }
        }

        // --- Logic: Preview & Form ---
        function toggleFields() {
            const type = document.getElementById('type-select').value;
            const tb = document.getElementById('field-twitch');
            if(type === 'most_active') tb.classList.remove('hidden');
            else tb.classList.add('hidden');
        }

        // --- –õ–æ–≥–∏–∫–∞: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é (Telegram Style) ---
        // --- –õ–æ–≥–∏–∫–∞: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é (Telegram Style) ---
        function updatePreview() {
            // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            const prize = document.getElementById('inp-prize').value || '–ü—Ä–∏–∑';
            const quality = document.getElementById('inp-quality').value; // –ü–æ–ª–µ –∫–∞—á–µ—Å—Ç–≤–∞
            const desc = document.getElementById('inp-desc').value || '';
            const imgUrl = document.getElementById('inp-img').value;
            
            // –°–∫–ª–µ–∏–≤–∞–µ–º –ù–∞–∑–≤–∞–Ω–∏–µ + –ö–∞—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: AK-47 (FT))
            const prizeFull = quality ? `${prize} (${quality})` : prize;

            // 2. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ (—Ç–≤–æ–π –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω)
            let html = `üöÄ <b>–†–û–ó–´–ì–†–´–® –î–õ–Ø –ú–û–ò–• –ü–ê–¶–ê–ù–û–í</b>\n\n`;
            
            // –û–ø–∏—Å–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
            if (desc) {
                html += `<i>${desc}</i>\n\n`;
            }
            
            html += `üèÜ <b>–ü—Ä–∏–∑:</b> ${prizeFull}\n`;
            
            // –ë–ª–æ–∫ —É—Å–ª–æ–≤–∏–π
            html += `\nüìå <b>–£—Å–ª–æ–≤–∏—è:</b>\n`;
            html += `‚îî –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª\n`;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π Twitch
            const minMsgsInput = document.querySelector('input[name="min_msgs"]');
            const minMsgs = minMsgsInput ? parseInt(minMsgsInput.value || 0) : 0;
            if (minMsgs > 0) {
                html += `‚îî –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∏–º–µ (${minMsgs} —Å–æ–æ–±—â.)\n`;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (–ú–°–ö)
            const dateVal = document.querySelector('input[name="end_time"]').value;
            if (dateVal) {
                const d = new Date(dateVal);
                const dateStr = d.toLocaleDateString('ru-RU');
                const timeStr = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                html += `\n‚è≥ <b>–ò—Ç–æ–≥–∏:</b> ${dateStr} ${timeStr} (–ú–°–ö)\n`;
            }

            // –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
            html += `\nüëá <b>–ñ–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!</b>`;

            // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –ø—Ä–µ–≤—å—é
            const imgEl = document.getElementById('prev-img');
            if (imgUrl) { 
                imgEl.src = imgUrl; 
                imgEl.classList.add('show'); 
            } else { 
                imgEl.classList.remove('show'); 
            }

            // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–ª–æ–∫ –ø—Ä–µ–≤—å—é
            document.getElementById('prev-txt').innerHTML = html.replace(/\n/g, '<br>');
        }

        // --- –õ–æ–≥–∏–∫–∞: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ ---
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            
            btn.disabled = true; 
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –°–æ–∑–¥–∞–µ–º...';

            const fd = new FormData(e.target);
            const endTimeRaw = fd.get('end_time'); 

            const payload = {
                initData: tg.initData,
                title: fd.get('prize'), // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –ø—Ä–∏–∑–∞ –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –±–∞–∑—ã
                type: fd.get('type'),
                end_time: endTimeRaw, 
                settings: {
                    prize_name: fd.get('prize'),
                    skin_quality: fd.get('quality'), 
                    prize_image: fd.get('image'),
                    description: fd.get('desc'),
                    min_daily_messages: parseInt(fd.get('min_msgs') || 0),
                    requires_telegram_sub: fd.get('sub_req') === 'on',
                    requires_referral_status: fd.get('ref_req') === 'on',
                    twitch_sub_boost: parseFloat(fd.get('twitch_boost') || 1.0)
                }
            };

            try {
                const res = await fetch('/api/v1/admin/raffles/create', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    showCustomAlert('–£—Å–ø–µ—Ö!', '–†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω –≤ –∫–∞–Ω–∞–ª–µ.');
                    e.target.reset(); 
                    updatePreview(); 
                    switchTab('list'); 
                } else {
                    const err = await res.json();
                    tg.HapticFeedback.notificationOccurred('error');
                    showCustomAlert('–û—à–∏–±–∫–∞', err.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à');
                }
            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
                showCustomAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                btn.disabled = false; 
                btn.innerHTML = originalText;
            }
        });

        // --- Logic: List ---
        async function loadRaffles() {
            const c = document.getElementById('list-container');
            try {
                const res = await fetch('/api/v1/admin/raffles/list', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: tg.initData})
                });
                const data = await res.json();
                renderList(data);
            } catch(e) { c.innerHTML = '<p style="text-align:center; color:#ff4d4d;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>'; }
        }

        function renderList(list) {
            const c = document.getElementById('list-container');
            c.innerHTML = '';
            if(!list.length) { c.innerHTML = '<div style="text-align:center; opacity:0.5; padding:40px;">–ü—É—Å—Ç–æ</div>'; return; }

            list.forEach(r => {
                const s = r.settings || {};
                const isDone = r.status === 'completed';
                const img = s.prize_image ? `<img src="${s.prize_image}" class="card-thumb">` : `<div class="card-thumb" style="display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-gift"></i></div>`;
                
                let html = `
                <div class="raffle-card ${isDone ? 'completed' : ''}">
                    <div class="card-header">
                        ${img}
                        <div class="card-meta">
                            <div class="card-title">${r.title}</div>
                            <span class="status-badge ${isDone ? 'st-done' : 'st-active'}">${isDone ? '–ó–∞–≤–µ—Ä—à–µ–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω'}</span>
                            ${!isDone && r.end_time ? `<span style="font-size:10px; color:var(--danger); margin-left:5px;">‚è≥ ${new Date(r.end_time).toLocaleString([], {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'})}</span>` : ''}
                        </div>
                    </div>
                    <div style="font-size:12px; color:var(--text-sec); margin-bottom:10px;">–ü—Ä–∏–∑: <span style="color:#fff;">${s.prize_name}</span></div>
                `;

                if(isDone && r.winner) {
                    html += `
                    <div class="winner-section">
                        <div class="winner-tag">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
                        <div class="winner-name">${r.winner.full_name}</div>
                        ${r.winner.trade_link ? 
                            `<div class="trade-copy" onclick="copyText('${r.winner.trade_link}')">
                                <span><i class="fa-solid fa-link"></i> –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–µ–π–¥</span>
                                <span style="color:var(--primary); font-weight:700;">COPY</span>
                             </div>` : 
                            `<div style="font-size:11px; color:#555;">–¢—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>`
                        }
                    </div>`;
                } else if(!isDone) {
                    html += `
                    <div class="card-actions">
                        <button onclick="finishRaffle(${r.id})" class="action-btn btn-finish"><i class="fa-solid fa-flag-checkered"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                        <button onclick="showParts(${r.id})" class="action-btn btn-parts"><i class="fa-solid fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
                    </div>`;
                } else {
                    html += `<div class="card-actions"><button onclick="showParts(${r.id})" class="action-btn btn-parts" style="width:100%"><i class="fa-solid fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</button></div>`;
                }
                
                html += `</div>`;
                c.innerHTML += html;
            });
        }

        // --- Actions ---
        function finishRaffle(id) {
            showConfirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à?', '–ë–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.', async () => {
                try {
                    const res = await fetch('/api/v1/admin/raffles/draw', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({initData: tg.initData, raffle_id: id})
                    });
                    const d = await res.json();
                    if(res.ok) { showCustomAlert('–£—Å–ø–µ—Ö', d.message); loadRaffles(); }
                    else showCustomAlert('–û—à–∏–±–∫–∞', d.message);
                } catch(e) { showCustomAlert('–û—à–∏–±–∫–∞', '–°–±–æ–π —Å–µ—Ç–∏'); }
            });
        }

        async function showParts(id) {
            document.getElementById('modal-parts').classList.add('modal-active');
            const l = document.getElementById('parts-list');
            const cnt = document.getElementById('parts-count');
            l.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i></div>';
            cnt.innerText = '';

            try {
                const res = await fetch('/api/v1/admin/raffles/participants', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({initData: tg.initData, raffle_id: id})
                });
                const users = await res.json();
                cnt.innerText = `(${users.length})`;
                l.innerHTML = '';
                
                if(!users.length) { l.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>'; return; }

                users.forEach(u => {
                    const usr = u.user || {};
                    const initial = (usr.full_name || '?')[0];
                    l.innerHTML += `
                    <div class="part-item">
                        <div class="part-ava">${initial}</div>
                        <div>
                            <div style="font-weight:600; font-size:14px;">${usr.full_name}</div>
                            <div style="font-size:12px; color:var(--text-sec);">@${usr.username || '---'}</div>
                        </div>
                    </div>`;
                });
            } catch(e) { l.innerHTML = 'Error'; }
        }

        function copyText(txt) {
            navigator.clipboard.writeText(txt);
            tg.HapticFeedback.notificationOccurred('success');
            showCustomAlert('–ì–æ—Ç–æ–≤–æ', '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä.');
        }

        // --- Custom Modals Utils ---
        function closeModal(id) { document.getElementById(id).classList.remove('modal-active'); }
        
        function showCustomAlert(title, msg) {
            const m = document.getElementById('modal-alert');
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            const okBtn = document.getElementById('alert-ok');
            const cBtn = document.getElementById('alert-cancel');
            
            cBtn.classList.add('hidden');
            okBtn.onclick = () => m.classList.remove('modal-active');
            m.classList.add('modal-active');
        }

        function showConfirm(title, msg, onYes) {
            const m = document.getElementById('modal-alert');
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            const okBtn = document.getElementById('alert-ok');
            const cBtn = document.getElementById('alert-cancel');
            
            cBtn.classList.remove('hidden');
            cBtn.onclick = () => m.classList.remove('modal-active');
            okBtn.onclick = () => { onYes(); m.classList.remove('modal-active'); };
            m.classList.add('modal-active');
        }

        updatePreview();
    </script>
</body>
</html>
